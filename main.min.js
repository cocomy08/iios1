// === ÂÖ®Â±ÄÂÜÖÂ≠òËøΩË∏™Âô® ===
window.MemoryProfiler = {
    checkpoints: new Map(),

    // Âú®ÂáΩÊï∞ÂâçÂêéÂåÖË£ÖÔºåËá™Âä®ËÆ∞ÂΩïÂÜÖÂ≠òÂèòÂåñ
    wrap(funcName, originalFunc) {
        return function (...args) {
            const before = performance.memory
                ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)
                : 0;
            const t0 = performance.now();

            const result = originalFunc.apply(this, args);

            // Â¶ÇÊûúÊòØ PromiseÔºåÁ≠âÂæÖÂÆåÊàêÂêéÂÜçËÆ°ÁÆó
            if (result instanceof Promise) {
                return result.then((res) => {
                    const after = performance.memory
                        ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)
                        : 0;
                    const delta = after - before;
                    const duration = performance.now() - t0;
                    if (delta > 0.5 || duration > 100) {
                        // Âè™ËÆ∞ÂΩïË∂ÖËøá 0.5MB Êàñ 100ms ÁöÑ
                        console.warn(
                            `[MEM] ${funcName}: +${delta.toFixed(1)}MB in ${duration.toFixed(0)}ms`,
                        );
                    }
                    return res;
                });
            } else {
                const after = performance.memory
                    ? Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)
                    : 0;
                const delta = after - before;
                const duration = performance.now() - t0;
                if (delta > 0.5 || duration > 100) {
                    // Âè™ËÆ∞ÂΩïË∂ÖËøá 0.5MB Êàñ 100ms ÁöÑ
                    console.warn(
                        `[MEM] ${funcName}: +${delta.toFixed(1)}MB in ${duration.toFixed(0)}ms`,
                    );
                }
                return result;
            }
        };
    },

    // ÂåÖË£ÖÂÖ®Â±ÄÂáΩÊï∞
    installHooks() {
        const criticalFuncs = [
            "renderMessagesList",
            "renderContactList",
            "addMessageToView",
            "nc", // openChatView
            "Vc", // addMessageToView
            "Oc", // initializeChatStyles
            "cc", // loadPlaylists
            "eu", // loadAndRenderEmojis
            "Lc", // loadCustomIcons
            "Md", // applyCustomFont
        ];

        criticalFuncs.forEach((fname) => {
            if (window[fname] && typeof window[fname] === "function") {
                const original = window[fname];
                window[fname] = this.wrap(fname, original);
                console.log(`[MemoryProfiler] Â∑≤ÂÆâË£ÖÈí©Â≠ê: ${fname}`);
            }
        });
    },
};

// Ëá™Âä®ÂêØÂä®ËøΩË∏™
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
        // setTimeout(() => {
        //     window.MemoryProfiler.installHooks();
        //     console.log('[MemoryProfiler] ÂÜÖÂ≠òËøΩË∏™Â∑≤ÂêØÂä®ÔºåÊ£ÄÊü•ÊéßÂà∂Âè∞ [MEM] Êó•Âøó');
        // }, 1000);
    });
} else {
    // setTimeout(() => {
    //     window.MemoryProfiler.installHooks();
    //     console.log('[MemoryProfiler] ÂÜÖÂ≠òËøΩË∏™Â∑≤ÂêØÂä®ÔºåÊ£ÄÊü•ÊéßÂà∂Âè∞ [MEM] Êó•Âøó');
    // }, 1000);
}

// === ÂÜÖÂ≠òÈááÊ†∑ÁõëÊéßÔºàÊçïÊçâÁû¨Èó¥Â≥∞ÂÄºÔºâ ===
window.MemorySampler = {
    lastSample: 0,
    lastTime: 0,
    sampleInterval: null,
    peakAlloc: 0,

    start() {
        if (!performance.memory) {
            console.warn(
                "[MemorySampler] ‚ö†Ô∏è ÊµèËßàÂô®‰∏çÊîØÊåÅ performance.memory APIÔºàÈúÄË¶ÅÂú® Chrome DevTools ÂêØÁî®Ôºâ",
            );
            console.warn(
                "[MemorySampler] ËØ∑Â∞ùËØïÔºöChrome ËÆæÁΩÆ ‚Üí ÂºÄÂèëËÄÖÈÄâÈ°π ‚Üí ÂêØÁî® JS Â†ÜÂ§ßÂ∞èÁªüËÆ°",
            );
            return;
        }

        this.lastSample = performance.memory.usedJSHeapSize;
        this.lastTime = performance.now();

        console.log(
            "[MemorySampler] ‚úÖ ÈááÊ†∑Â∑≤ÂêØÂä®ÔºåÂΩìÂâçÂ†ÜÔºö" +
            (this.lastSample / 1024 / 1024).toFixed(1) +
            "MB",
        );

        this.sampleInterval = setInterval(() => {
            try {
                const now = performance.now();
                const heapNow = performance.memory.usedJSHeapSize;
                const timeDelta = now - this.lastTime; // ms
                const heapDelta = heapNow - this.lastSample; // bytes

                if (heapDelta !== 0) {
                    const deltaKB = heapDelta / 1024;
                    const deltaMB = heapDelta / 1024 / 1024;
                    const speedMBps = deltaMB / (timeDelta / 1000); // MB/s

                    // Êõ¥‰ΩéÁöÑÈó®ÊßõÔºå‰ªª‰ΩïÂèòÂåñÈÉΩËÆ∞ÂΩï
                    const direction = heapDelta > 0 ? "üìà +" : "üìâ ";
                    console.log(
                        `[HEAP] ${direction}${Math.abs(deltaKB).toFixed(0)}KB | ÈÄüÁéá: ${Math.abs(speedMBps).toFixed(2)}MB/s | ÂΩìÂâç: ${(heapNow / 1024 / 1024).toFixed(1)}MB`,
                    );

                    // Âç±Èô©È¢ÑË≠¶
                    if (speedMBps > 5) {
                        console.error(
                            "üö® [DANGER] ÂàÜÈÖçÈÄüÁéáË∂ÖËøá 5MB/sÔºÅÔºÅ",
                            new Error().stack.split("\n").slice(0, 5).join("\n"),
                        );
                    }
                }

                this.lastSample = heapNow;
                this.lastTime = now;
            } catch (e) {
                console.error("[MemorySampler] ÈááÊ†∑Âá∫Èîô:", e);
            }
        }, 100); // 100ms ÈááÊ†∑‰∏ÄÊ¨°ÔºåÊõ¥È¢ëÁπÅ

        console.log("[MemorySampler] ÈááÊ†∑Â∑≤ÂêØÂä®ÔºÅÊØè 100ms ËæìÂá∫‰∏ÄÊ¨°ÂÜÖÂ≠òÂèòÂåñ");
    },

    stop() {
        if (this.sampleInterval) {
            clearInterval(this.sampleInterval);
            console.log("[MemorySampler] ÈááÊ†∑Â∑≤ÂÅúÊ≠¢");
        }
    },
};

// Âú®È°µÈù¢Âä†ËΩΩÂÆåÂêéÁ´ãÂç≥ÂêØÂä®ÈááÊ†∑
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
        console.log("[Init] DOMContentLoaded Ëß¶ÂèëÔºåMemorySampler Â∑≤Á¶ÅÁî®");
        // setTimeout(() => window.MemorySampler.start(), 1000);
    });
} else {
    console.log("[Init] È°µÈù¢Â∑≤Âä†ËΩΩÔºåMemorySampler Â∑≤Á¶ÅÁî®");
    // setTimeout(() => window.MemorySampler.start(), 500);
}

function openSettingsPage(e) {
    const t = document.getElementById(e),
        n = document.getElementById("settings-main-view");
    t &&
        n &&
        (t.classList.add("active"),
            (n.style.transform = "scale(0.92) translateY(10px)"),
            (n.style.opacity = "0.6"),
            (n.style.filter = "grayscale(100%)"),
            "undefined" != typeof lucide && lucide.createIcons());
}

function closeSettingsPage(e) {
    const t = document.getElementById(e),
        n = document.getElementById("settings-main-view");
    t &&
        n &&
        (t.classList.remove("active"),
            (n.style.transform = "scale(1) translateY(0)"),
            (n.style.opacity = "1"),
            (n.style.filter = "grayscale(0%)"));
}
(document.addEventListener("DOMContentLoaded", () => {
    ((window.DEBUG_MODE = !1),
        (window.debugLog = function (...e) {
            window.DEBUG_MODE && console.log(...e);
        }),
        (window.debugWarn = function (...e) {
            window.DEBUG_MODE && console.warn(...e);
        }),
        (window.debugError = function (...e) {
            console.error(...e);
        }));
    const e =
        /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        ("MacIntel" === navigator.platform && navigator.maxTouchPoints > 1),
        t =
            window.matchMedia("(display-mode: standalone)").matches ||
            !0 === window.navigator.standalone;
    (e && document.body.classList.add("ios-optimize-mode"),
        e &&
        t &&
        (document.body.classList.add("is-ios-pwa"),
            debugLog("iOS PWA Ê®°ÂºèÂ∑≤ÂêØÁî®")));
    const n = {
        dbName: "AppImageStore",
        storeName: "images",
        version: 1,
        _db: null,
        async getDB() {
            return this._db
                ? this._db
                : new Promise((e, t) => {
                    const n = indexedDB.open(this.dbName, this.version);
                    ((n.onupgradeneeded = (e) => {
                        const t = e.target.result;
                        t.objectStoreNames.contains(this.storeName) ||
                            t.createObjectStore(this.storeName);
                    }),
                        (n.onsuccess = (t) => {
                            ((this._db = t.target.result), e(this._db));
                        }),
                        (n.onerror = (e) => t(e.target.error)));
                });
        },
        async get(e) {
            try {
                const t = await this.getDB(),
                    n = await new Promise((n, a) => {
                        const o = t
                            .transaction(this.storeName, "readonly")
                            .objectStore(this.storeName)
                            .get(e);
                        ((o.onsuccess = () => n(o.result)), (o.onerror = () => a(o.error)));
                    });
                if (n) return n;
                const a = localStorage.getItem(e);
                // Base64 ËΩ¨ Blob URLÔºöÂ¶ÇÊûúÊòØÂ§ßÁöÑ Base64 ÂõæÁâáÔºåËΩ¨‰∏∫‰∏¥Êó∂ Blob URL ‰ª•ËäÇÁúÅÂÜÖÂ≠ò
                if (a && a.startsWith("data:image")) {
                    debugLog(`[ImageStore] ËøÅÁßªÊóßÊï∞ÊçÆ: ${e}`);
                    // Â¶ÇÊûúÂ§ßÂ∞èË∂ÖËøá 100KBÔºåËá™Âä®ËΩ¨‰∏∫ Blob URL ÂÜçÂ≠òÂÇ®
                    if (a.length > 100000) {
                        try {
                            const blob = await (await fetch(a)).blob();
                            const blobUrl = URL.createObjectURL(blob);
                            // Êõ¥Êñ∞‰∏∫ Blob URLÔºàÊõ¥Â∞èÁöÑÊåáÈíàÔºâÔºåÂéü Base64 ‰ºöË¢´ GCÔºâ
                            this.set(e, blobUrl).then(() => {
                                (localStorage.removeItem(e),
                                    debugLog(`[ImageStore] Â∑≤ËøÅÁßª‰∏∫ Blob URL: ${e}`));
                            });
                            return blobUrl;
                        } catch (err) {
                            debugLog(`[ImageStore] Blob URL ËΩ¨Êç¢Â§±Ë¥•ÔºåÂõûÈÄÄ Data URL: ${err}`);
                            return a; // Â§±Ë¥•ÂàôÁî®Âéü Data URL
                        }
                    } else {
                        // Â∞èÊñá‰ª∂Áõ¥Êé•‰øùÂ≠ò
                        this.set(e, a).then(() => {
                            (localStorage.removeItem(e),
                                debugLog(
                                    `[ImageStore] ËøÅÁßªÂÆåÊàêÔºåÂ∑≤Âà†Èô§localStorageÂâØÊú¨: ${e}`,
                                ));
                        });
                        return a;
                    }
                }
                return null;
            } catch (t) {
                return (
                    console.warn(
                        "[ImageStore] IndexedDB failed, fallback to localStorage",
                        t,
                    ),
                    localStorage.getItem(e)
                );
            }
        },
        async set(e, t) {
            try {
                const n = await this.getDB();
                return new Promise((a, o) => {
                    const s = n.transaction(this.storeName, "readwrite");
                    (s.objectStore(this.storeName).put(t, e),
                        (s.oncomplete = () => a()),
                        (s.onerror = () => o()));
                });
            } catch (n) {
                (console.warn(
                    "[ImageStore] IndexedDB failed, fallback to localStorage",
                    n,
                ),
                    localStorage.setItem(e, t));
            }
        },
        async remove(e) {
            try {
                const t = await this.getDB();
                return new Promise((n, a) => {
                    const o = t.transaction(this.storeName, "readwrite");
                    (o.objectStore(this.storeName).delete(e),
                        (o.oncomplete = () => n()),
                        (o.onerror = () => a()));
                });
            } catch (e) {
                console.warn("[ImageStore] Remove failed", e);
            }
            localStorage.removeItem(e);
        },
        async has(e) {
            return !!(await this.get(e));
        },
    };
    window.ImageStore = n;

    // === ÂÖ®Â±ÄÂÜÖÂ≠òÊ∏ÖÁêÜÂô® ===
    window.MemoryManager = {
        blobUrlCache: new Map(),
        // Ê≥®ÂÜå Blob URLÔºåÊñπ‰æøÂêéÁª≠Ê∏ÖÁêÜ
        registerBlobUrl(key, url) {
            if (this.blobUrlCache.has(key)) {
                URL.revokeObjectURL(this.blobUrlCache.get(key));
            }
            this.blobUrlCache.set(key, url);
        },
        // ÊâãÂä®ÈáäÊîæÂçï‰∏™ Blob URL
        releaseBlobUrl(key) {
            if (this.blobUrlCache.has(key)) {
                const url = this.blobUrlCache.get(key);
                if (url && url.startsWith("blob:")) {
                    URL.revokeObjectURL(url);
                }
                this.blobUrlCache.delete(key);
            }
        },
        // ÂÆöÊúüÊ∏ÖÁêÜÔºà30ÂàÜÈíü‰∏ÄÊ¨°Ôºâ
        startPeriodicCleanup() {
            setInterval(
                () => {
                    const now = Date.now();
                    let cleaned = 0;
                    // Ê∏ÖÁêÜË∂ÖËøá1Â∞èÊó∂Êú™‰ΩøÁî®ÁöÑÁºìÂ≠ò
                    for (const [key, url] of this.blobUrlCache.entries()) {
                        if (url && url.startsWith("blob:")) {
                            try {
                                URL.revokeObjectURL(url);
                                this.blobUrlCache.delete(key);
                                cleaned++;
                            } catch (err) {
                                console.warn("[MemoryManager] Ê∏ÖÁêÜÂ§±Ë¥•:", key, err);
                            }
                        }
                    }
                    if (cleaned > 0) {
                        console.log(`[MemoryManager] Â∑≤Ê∏ÖÁêÜ ${cleaned} ‰∏™ËøáÊúü Blob URL`);
                    }
                },
                30 * 60 * 1000,
            ); // 30ÂàÜÈíü
        },
    };
    window.MemoryManager.startPeriodicCleanup();

    const a = {
        enabled: e,
        CHUNK_THRESHOLD: 2097152,
        CHUNK_SIZE: 524288,
        YIELD_DELAY: 50,
        IOS_BABY_MODE_PROMPTED: "ios_baby_mode_prompted_v1",
        showFirstTimePrompt() {
            this.enabled &&
                (localStorage.getItem(this.IOS_BABY_MODE_PROMPTED) ||
                    setTimeout(() => {
                        const e = document.createElement("div");
                        ((e.id = "ios-baby-mode-prompt"),
                            (e.style.cssText =
                                "\n                    position: fixed;\n                    top: 0; left: 0; right: 0; bottom: 0;\n                    background: rgba(0,0,0,0.6);\n                    backdrop-filter: blur(10px);\n                    -webkit-backdrop-filter: blur(10px);\n                    z-index: 99999;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    padding: 20px;\n                "),
                            (e.innerHTML =
                                '\n                    <div style="\n                        background: #fff;\n                        border-radius: 24px;\n                        padding: 24px;\n                        max-width: 320px;\n                        text-align: center;\n                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n                    ">\n                        <div style="font-size: 48px; margin-bottom: 12px;">üçº</div>\n                        <h2 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #333;">\n                            iOS ÂÆùÂÆùÊ®°ÂºèÂ∑≤ÂêØÁî®\n                        </h2>\n                        <p style="margin: 0 0 16px 0; font-size: 14px; color: #666; line-height: 1.5;">\n                            ‰∏∫‰∫Ü‰øùËØÅÁ®≥ÂÆöÊÄßÔºåÂú® iOS ËÆæÂ§á‰∏äÔºö\n                        </p>\n                        <ul style="text-align: left; margin: 0 0 20px 0; padding-left: 20px; font-size: 13px; color: #555; line-height: 1.8;">\n                            <li>üîó Êé®Ëçê‰ΩøÁî®<b>Â≠ó‰ΩìURL</b>Âä†ËΩΩÂ≠ó‰Ωì</li>\n                            <li>üì¶ Â§ßÊñá‰ª∂‰ºö<b>ÂàÜÂùóÂ§ÑÁêÜ</b>ÔºåÁ®çÊÖ¢‰ΩÜÊõ¥ÂÆâÂÖ®</li>\n                            <li>üñºÔ∏è ÂõæÁâá‰ºöËá™Âä®<b>ÂéãÁº©‰ºòÂåñ</b></li>\n                        </ul>\n                        <button id="ios-baby-mode-confirm" style="\n                            width: 100%;\n                            padding: 14px;\n                            background: #333;\n                            color: #fff;\n                            border: none;\n                            border-radius: 14px;\n                            font-size: 16px;\n                            font-weight: 600;\n                            cursor: pointer;\n                        ">ÊàëÊòØÂÆùÂÆù</button>\n                    </div>\n                '),
                            document.body.appendChild(e),
                            document
                                .getElementById("ios-baby-mode-confirm")
                                .addEventListener("click", () => {
                                    (localStorage.setItem(this.IOS_BABY_MODE_PROMPTED, "true"),
                                        (e.style.opacity = "0"),
                                        (e.style.transition = "opacity 0.3s"),
                                        setTimeout(() => e.remove(), 300));
                                }));
                    }, 1500));
        },
        async safeReadFileAsDataURL(e, t = null) {
            if (!this.enabled || e.size < this.CHUNK_THRESHOLD)
                return new Promise((t, n) => {
                    const a = new FileReader();
                    ((a.onload = (e) => t(e.target.result)),
                        (a.onerror = n),
                        a.readAsDataURL(e));
                });
            debugLog(
                `üçº ÂÆùÂÆùÊ®°ÂºèÔºöÂàÜÂùóËØªÂèñÂ§ßÊñá‰ª∂ (${(e.size / 1024 / 1024).toFixed(2)}MB)`,
            );
            const n = [];
            let a = 0;
            const o = Math.ceil(e.size / this.CHUNK_SIZE);
            for (let s = 0; s < o; s++) {
                const i = e.slice(a, a + this.CHUNK_SIZE),
                    r = await i.arrayBuffer();
                (n.push(new Uint8Array(r)),
                    (a += this.CHUNK_SIZE),
                    t && t(Math.round(((s + 1) / o) * 100)),
                    await new Promise((e) => setTimeout(e, this.YIELD_DELAY)));
            }
            const s = n.reduce((e, t) => e + t.length, 0),
                i = new Uint8Array(s);
            let r = 0;
            for (const e of n)
                (i.set(e, r), (r += e.length), (n[n.indexOf(e)] = null));
            await new Promise((e) => setTimeout(e, this.YIELD_DELAY));
            const l = this.uint8ArrayToBase64(i);
            return `data:${e.type || "application/octet-stream"};base64,${l}`;
        },
        uint8ArrayToBase64(e) {
            let t = "";
            for (let n = 0; n < e.length; n += 32768) {
                const a = e.subarray(n, Math.min(n + 32768, e.length));
                t += String.fromCharCode.apply(null, a);
            }
            return btoa(t);
        },
        async safeCompressImage(e, t = {}) {
            const {
                maxWidth: n = 1920,
                maxHeight: a = 1920,
                quality: o = this.enabled ? 0.7 : 0.85,
                onProgress: s = null,
            } = t;
            return new Promise(async (t, i) => {
                try {
                    s && s(10);
                    const r = await this.safeReadFileAsDataURL(e, (e) => {
                        s && s(10 + 0.5 * e);
                    });
                    s && s(60);
                    const l = new Image();
                    ((l.onload = async () => {
                        try {
                            (await new Promise((e) => setTimeout(e, this.enabled ? 50 : 0)),
                                s && s(70));
                            let { width: e, height: i } = l;
                            if (e > n || i > a) {
                                const t = Math.min(n / e, a / i);
                                ((e = Math.floor(e * t)), (i = Math.floor(i * t)));
                            }
                            const r = document.createElement("canvas");
                            ((r.width = e), (r.height = i));
                            (r.getContext("2d").drawImage(l, 0, 0, e, i),
                                s && s(85),
                                await new Promise((e) => setTimeout(e, this.enabled ? 30 : 0)));
                            const c = r.toDataURL("image/jpeg", o);
                            ((r.width = 0), (r.height = 0), s && s(100), t(c));
                        } catch (e) {
                            i(e);
                        }
                    }),
                        (l.onerror = i),
                        (l.src = r));
                } catch (e) {
                    i(e);
                }
            });
        },
        showProgressToast(e, t = null) {
            let n = document.getElementById("ios-baby-progress-toast");
            (n ||
                ((n = document.createElement("div")),
                    (n.id = "ios-baby-progress-toast"),
                    (n.style.cssText =
                        "\n                    position: fixed;\n                    bottom: 100px;\n                    left: 50%;\n                    transform: translateX(-50%);\n                    background: rgba(0,0,0,0.8);\n                    color: #fff;\n                    padding: 12px 24px;\n                    border-radius: 100px;\n                    font-size: 14px;\n                    z-index: 99998;\n                    display: flex;\n                    align-items: center;\n                    gap: 10px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n                "),
                    document.body.appendChild(n)),
                (n.innerHTML =
                    null !== t
                        ? `\n                    <span>üçº</span>\n                    <span>${e}</span>\n                    <span style="font-weight:bold">${t}%</span>\n                `
                        : `<span>üçº</span><span>${e}</span>`),
                (n.style.display = "flex"));
        },
        hideProgressToast() {
            const e = document.getElementById("ios-baby-progress-toast");
            e && (e.style.display = "none");
        },
        shouldRecommendURL(e, t) {
            if (!this.enabled) return !1;
            return (
                e.size >
                ({
                    font: 3145728,
                    image: 5242880,
                    backup: 20971520,
                }[t] || this.CHUNK_THRESHOLD)
            );
        },
    };
    ((window.iOSBabyMode = a), a.showFirstTimePrompt());
    const o = "ios_safe_area_margin",
        s = localStorage.getItem(o);
    s && parseInt(s);
    let i = null;
    if (
        ((window.applyIOSSafeAreaMargin = function (e) {
            const t = Math.max(-300, Math.min(300, parseInt(e) || 0)),
                n = t + "px";
            (i && clearTimeout(i),
                (i = setTimeout(() => {
                    try {
                        document.documentElement.style.setProperty("--ios-safe-margin", n);
                        let e = document.getElementById("ios-safe-area-style");
                        e ||
                            ((e = document.createElement("style")),
                                (e.id = "ios-safe-area-style"),
                                document.head.appendChild(e));
                        const a = document.body.classList.contains("fullscreen-mode"),
                            o = `${t >= 0 ? "-" : "+"} ${Math.abs(t)}px`,
                            s = 100,
                            i = `-${s}px`;
                        let r = `\n                    /* ËÆ© html/body ËÉåÊôØÂª∂‰º∏Âà∞ÂÆâÂÖ®Âå∫‰∏ãÊñπÔºåË¶ÜÁõñÁôΩËâ≤ËÉåÊôØÔºàÂõ∫ÂÆöÂª∂‰º∏Ôºå‰∏çÂèóÁî®Êà∑ËÆæÁΩÆÂΩ±ÂìçÔºâ */\n                    /* ËÆ© html/body ËÉåÊôØÂª∂‰º∏Âà∞ÂÆâÂÖ®Âå∫‰∏ãÊñπÔºåË¶ÜÁõñÁôΩËâ≤ËÉåÊôØÔºàÂõ∫ÂÆöÂª∂‰º∏Ôºå‰∏çÂèóÁî®Êà∑ËÆæÁΩÆÂΩ±ÂìçÔºâ */\n                    html.is-ios-pwa-html {\n                        /* ÁßªÈô§ÂØºËá¥ÁôΩÂùóÁöÑ padding-bottom */\n                        margin-bottom: 0 !important;\n                        padding-bottom: 0 !important;\n                    }\n                    body.is-ios-pwa {\n                        /* ÁßªÈô§ÂØºËá¥ÁôΩÂùóÁöÑ padding-bottom */\n                        margin-bottom: 0 !important;\n                        padding-bottom: 0 !important;\n                    }\n                    /* ÂÖ≥ÈîÆÔºöËÆ© #global-wallpaper ‰πüÂª∂‰º∏Âà∞ÂÆâÂÖ®Âå∫‰∏ãÊñπÔºåË¶ÜÁõñÁôΩËâ≤ËÉåÊôØ */\n                    #global-wallpaper {\n                        position: fixed !important;\n                        top: 0 !important;\n                        left: 0 !important;\n                        right: 0 !important;\n                        bottom: ${i} !important;\n                        width: 100vw !important;\n                        height: calc(100vh + ${s}px) !important;\n                        height: calc(100dvh + ${s}px) !important;\n                        z-index: -1 !important;\n                        background-size: cover !important;\n                        background-position: center !important;\n                        background-repeat: no-repeat !important;\n                    }\n                    /* Ë∞ÉÊï¥ phone-frame ÁöÑÈ´òÂ∫¶ */\n                    body.is-ios-pwa .phone-frame {\n                        height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                    }\n                `;
                        (a &&
                            (r += `\n                    body.is-ios-pwa.fullscreen-mode .phone-frame {\n                        height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                    }\n                    `),
                            (e.textContent = r),
                            debugLog("üçé iOSÂÆâÂÖ®Âå∫marginÂ∑≤Êõ¥Êñ∞:", n, a ? "(ÂÖ®Â±èÊ®°Âºè)" : ""));
                    } catch (e) {
                        console.error("Â∫îÁî®iOSÂÆâÂÖ®Âå∫marginÂ§±Ë¥•:", e);
                    }
                }, 100)));
        }),
            e && t)
    ) {
        (document.body.classList.add("is-ios-pwa"),
            document.documentElement.classList.add("is-ios-pwa-html"));
        const Zh = document.getElementById("ios-calibration-overlay"),
            Xh = document.getElementById("ios-calibration-confirm-btn"),
            Qh = "ios_pwa_calibrated_v2";

        function r() {
            (debugLog("üõ°Ô∏è ÂêØÁî®Ëß¶Êë∏ÈîÅÂÆöÊä§Áõæ (Enhanced V2)"),
                document.addEventListener(
                    "touchmove",
                    function (e) {
                        const t = e.target.closest(
                            ".chat-messages-container, .settings-content, .settings-content-ios, .music-content, .content, .scrollable, .settings-page .overflow-y-auto, .overflow-y-auto, .overflow-auto, .ceramic-category-scroll, .ceramic-content-scroll, .settings-page-content",
                        );
                        if (!t) return void (e.cancelable && e.preventDefault());
                        const n = t.scrollHeight > t.clientHeight,
                            a = t.scrollWidth > t.clientWidth;
                        if (!n && !a) return void (e.cancelable && e.preventDefault());
                        const o = e.touches[0].clientY,
                            s = e.touches[0].clientX,
                            i = o - (void 0 === window.lastTouchY ? o : window.lastTouchY),
                            r = s - (void 0 === window.lastTouchX ? s : window.lastTouchX),
                            l = Math.abs(i) > Math.abs(r);
                        if (a && !l)
                            return ((window.lastTouchY = o), void (window.lastTouchX = s));
                        if (a && !n && l)
                            return (
                                e.cancelable && e.preventDefault(),
                                (window.lastTouchY = o),
                                void (window.lastTouchX = s)
                            );
                        if (n) {
                            const n = t.scrollTop <= 0,
                                a = t.scrollTop + t.clientHeight >= t.scrollHeight - 1;
                            l &&
                                (n && i > 0
                                    ? e.cancelable && e.preventDefault()
                                    : a && i < 0 && e.cancelable && e.preventDefault());
                        }
                        ((window.lastTouchY = o), (window.lastTouchX = s));
                    },
                    {
                        passive: !1,
                    },
                ),
                document.addEventListener(
                    "touchstart",
                    function (e) {
                        ((window.lastTouchY = e.touches[0].clientY),
                            (window.lastTouchX = e.touches[0].clientX));
                    },
                    {
                        passive: !1,
                    },
                ));
        }
        "true" === localStorage.getItem(Qh)
            ? r()
            : Zh &&
            ((Zh.style.display = "flex"),
                Xh.addEventListener("click", () => {
                    (localStorage.setItem(Qh, "true"),
                        (Zh.style.opacity = "0"),
                        (Zh.style.transition = "opacity 0.3s ease"),
                        setTimeout(() => (Zh.style.display = "none"), 300),
                        r());
                }));
    }
    const l = document.getElementById("nav-to-ios-settings"),
        c = document.getElementById("ios-settings-screen"),
        d = document.getElementById("ios-settings-back-button"),
        u = document.getElementById("ios-margin-slider"),
        m = document.getElementById("ios-margin-display"),
        p = {
            "ios-preset-30": 30,
            "ios-preset-50": 50,
            "ios-preset-60": 60,
            "ios-preset-70": 70,
        };
    if (u && m) {
        let ev = parseInt(localStorage.getItem(o) || "0");
        ((ev = Math.max(-300, Math.min(300, ev))),
            (u.value = ev),
            (m.textContent = ev + "px"));
        const tv = document.getElementById("ios-slider-progress"),
            nv = document.getElementById("ios-slider-thumb");

        function g(e) {
            const t = ((parseInt(e) + 300) / 600) * 100;
            (tv && (tv.style.width = t + "%"),
                nv && (nv.style.left = `calc(${t}% - 16px)`));
        }
        g(ev);
        let av = null;
        u.addEventListener("input", function () {
            const e = this.value;
            ((m.textContent = e + "px"),
                g(e),
                window.applyIOSSafeAreaMargin(parseInt(e)),
                av && clearTimeout(av),
                (av = setTimeout(() => {
                    localStorage.setItem(o, e);
                }, 300)));
        });
    }
    (Object.keys(p).forEach(function (e) {
        const t = document.getElementById(e);
        t &&
            t.addEventListener("click", function () {
                const t = p[e];
                (u && (u.value = t), m && (m.textContent = t + "px"));
                const n = document.getElementById("ios-slider-progress"),
                    a = document.getElementById("ios-slider-thumb"),
                    s = ((t + 300) / 600) * 100;
                (n && (n.style.width = s + "%"),
                    a && (a.style.left = `calc(${s}% - 16px)`),
                    window.applyIOSSafeAreaMargin(t),
                    localStorage.setItem(o, t.toString()));
            });
    }),
        l &&
        c &&
        l.addEventListener("click", function () {
            c.classList.add("opened");
        }),
        d &&
        c &&
        d.addEventListener("click", function () {
            c.classList.remove("opened");
        }),
        (window.DOMCleanupManager = {
            registry: new Map(),
            register(e, t = null) {
                const n = document.getElementById(e);
                n &&
                    (this.registry.set(e, {
                        element: n,
                        callback: t,
                    }),
                        console.log(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] Â∑≤Ê≥®ÂÜåÂÆπÂô®: ${e}`));
            },
            clean(t) {
                const n = this.registry.get(t);
                if (!n) return void debugWarn(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] ÂÆπÂô®Êú™Ê≥®ÂÜå: ${t}`);
                const { element: a, callback: o } = n;
                if (o && "function" == typeof o)
                    try {
                        o(a);
                    } catch (e) {
                        debugError(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] Ê∏ÖÁêÜÂõûË∞ÉÊâßË°åÂ§±Ë¥• (${t}):`, e);
                    }
                if (
                    (a && ((a.innerHTML = ""), debugLog(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] ‚úÖ Â∑≤Ê∏ÖÁ©∫: ${t}`)),
                        e && window.gc)
                )
                    try {
                        window.gc();
                    } catch (e) { }
            },
            cleanMultiple(e) {
                e.forEach((e) => this.clean(e));
            },
            deepClean(e) {
                const t = this.registry.get(e);
                if (!t) return;
                const { element: n } = t;
                if (!n) return;
                const a = n.cloneNode(!1);
                (n.parentNode.replaceChild(a, n),
                    this.registry.set(e, {
                        element: a,
                        callback: t.callback,
                    }),
                    console.log(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] ‚úÖ Ê∑±Â∫¶Ê∏ÖÁêÜÂÆåÊàê: ${e}`));
            },
        }),
        (window.TimerManager = {
            timers: new Map(),
            setTimeout(e, t, n = "default") {
                const a = setTimeout(() => {
                    (e(), this.remove(a, n));
                }, t);
                return (this.register(a, n), a);
            },
            setInterval(e, t, n = "default") {
                const a = setInterval(e, t);
                return (this.register(a, n), a);
            },
            register(e, t = "default") {
                (this.timers.has(t) || this.timers.set(t, []),
                    this.timers.get(t).push(e),
                    debugLog(`[ËÆ°Êó∂Âô®Á≥ªÁªü] Â∑≤Ê≥®ÂÜå: ${t} (#${e})`));
            },
            remove(e, t) {
                if (!this.timers.has(t)) return;
                const n = this.timers.get(t),
                    a = n.indexOf(e);
                a > -1 && n.splice(a, 1);
            },
            clear(e) {
                if (!this.timers.has(e))
                    return void debugWarn(`[ËÆ°Êó∂Âô®Á≥ªÁªü] Ê†áÁ≠æ‰∏çÂ≠òÂú®: ${e}`);
                const t = this.timers.get(e);
                (t.forEach((e) => {
                    (clearTimeout(e), clearInterval(e));
                }),
                    debugLog(`[ËÆ°Êó∂Âô®Á≥ªÁªü] ‚úÖ Â∑≤Ê∏ÖÁêÜ ${t.length} ‰∏™ËÆ°Êó∂Âô®: ${e}`),
                    this.timers.delete(e));
            },
            clearMultiple(e) {
                e.forEach((e) => this.clear(e));
            },
            clearAll() {
                let e = 0;
                (this.timers.forEach((t, n) => {
                    (t.forEach((e) => {
                        (clearTimeout(e), clearInterval(e));
                    }),
                        (e += t.length));
                }),
                    debugLog(`[ËÆ°Êó∂Âô®Á≥ªÁªü] ‚úÖ Â∑≤Ê∏ÖÁêÜÊâÄÊúâËÆ°Êó∂Âô® (ÂÖ±${e}‰∏™)`),
                    this.timers.clear());
            },
        }));
    const y = [
        "chat-messages-container",
        "contact-list",
        "forward-target-list",
        "summary-detail-container",
        "summary-list-container",
        "dating-history-container",
        "transactions-list-container",
        "orders-list-container",
        "qilang-feed-container",
        "qilang-detail-comments",
        "gacha-posts-container",
        "wow-feed-container",
        "wow-detail-comments",
        "product-grid",
        "cart-items-container",
        "recipient-list-container",
        "worldbook-list",
        "worldbook-groups-list",
        "books-in-group-list",
        "style-presets-container",
        "font-url-list-container",
        "vn-choices-container",
        "shopper-list-container",
        "summon-ai-list-container",
        "worldbook-visibility-list",
    ];
    (y.forEach((e) => {
        window.DOMCleanupManager.register(e);
    }),
        console.log(`[DOMÊ∏ÖÁêÜÁ≥ªÁªü] Â∑≤Ê≥®ÂÜå ${y.length} ‰∏™Ê†∏ÂøÉÂÆπÂô®`));
    const h =
        '\n<style>\n    /* ÈÅÆÁΩ©Â±ÇÔºöÈ´òÊñØÊ®°Á≥ä + ËΩªÂæÆÂèòÊöó */\n    .system-loader-overlay {\n        position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0, 0, 0, 0.35);\n        backdrop-filter: blur(15px);\n        -webkit-backdrop-filter: blur(15px);\n        z-index: 9999;\n        display: flex; justify-content: center; align-items: center;\n        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;\n        opacity: 0; animation: fadeIn 0.3s forwards;\n    }\n\n    /* Âç°Áâá‰∏ª‰ΩìÔºö‰ªø iOS ÂºπÁ™ó */\n    .system-loader-card {\n        background: rgba(255, 255, 255, 0.85);\n        backdrop-filter: blur(20px);\n        -webkit-backdrop-filter: blur(20px);\n        padding: 24px;\n        border-radius: 20px;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n        width: 280px;\n        text-align: center;\n        transform: scale(0.9);\n        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;\n    }\n\n    /* Âä®ÊÄÅÂõæÊ†áÂÆπÂô® */\n    .loader-icon-wrapper {\n        width: 50px; height: 50px; margin: 0 auto 15px;\n        display: flex; align-items: center; justify-content: center;\n        font-size: 28px;\n    }\n\n    /* ÊóãËΩ¨Âä®ÁîªÂúàÂúà (Áî®‰∫éÂØºÂÖ•) */\n    .spinner-ios {\n        width: 32px; height: 32px;\n        border: 3px solid rgba(0, 0, 0, 0.1);\n        border-top: 3px solid #007AFF;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n    }\n\n    /* Ë∑≥Âä®Âä®Áîª (Áî®‰∫éÂ§á‰ªΩÊâìÂåÖ) */\n    .bounce-icon { animation: bounce 1.5s infinite; }\n\n    /* Ê†áÈ¢òÊñáÂ≠ó */\n    .loader-title {\n        font-size: 17px; font-weight: 600; color: #000; margin-bottom: 8px;\n    }\n\n    /* Áä∂ÊÄÅÊèèËø∞ÊñáÂ≠ó */\n    .loader-desc {\n        font-size: 13px; color: #8e8e93; margin-bottom: 15px; min-height: 16px;\n    }\n\n    /* ËøõÂ∫¶Êù°ÂÆπÂô® */\n    .progress-track {\n        width: 100%; height: 6px; background: #E5E5EA;\n        border-radius: 10px; overflow: hidden;\n    }\n\n    /* ËøõÂ∫¶Êù°Â°´ÂÖÖ */\n    .progress-fill {\n        height: 100%; background: #007AFF; width: 0%;\n        border-radius: 10px;\n        transition: width 0.3s ease;\n    }\n\n    /* Âä®ÁîªÂÖ≥ÈîÆÂ∏ß */\n    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }\n    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }\n</style>\n',
        v = document.getElementById("wow-app-icon"),
        f =
            (document.getElementById("wow-screen"),
                document.getElementById("wow-exit-btn")),
        w = document.querySelectorAll(".wow-nav-btn"),
        b = document.querySelectorAll(".wow-page"),
        E = document.getElementById("wow-identity-modal"),
        I = document.getElementById("wow-identity-list"),
        x = document.getElementById("wow-current-avatar"),
        k = document.getElementById("wow-profile-avatar"),
        L = document.getElementById("wow-profile-name"),
        B = document.getElementById("wow-feed-container"),
        S = document.getElementById("wow-open-compose-btn"),
        C = document.getElementById("wow-compose-modal"),
        $ = document.getElementById("wow-compose-text"),
        M = document.getElementById("wow-compose-publish-btn"),
        T = document.getElementById("wow-compose-cancel-btn"),
        A = document.getElementById("wow-detail-view"),
        D = document.getElementById("wow-detail-back-btn"),
        P = document.getElementById("wow-detail-main-post"),
        H = document.getElementById("wow-detail-comments"),
        O = document.getElementById("wow-detail-input"),
        q = document.getElementById("wow-detail-send-btn");
    let N = null,
        _ = (new Set(), null),
        F = null,
        R = null;
    const G = document.getElementById("battery-level"),
        W = document.getElementById("batteryBolt"),
        j = document.getElementById("batteryContainer"),
        U = document.getElementById("proactive-settings-screen"),
        z = document.getElementById("proactive-back-button"),
        V = document.getElementById("nav-to-proactive-settings"),
        J = document.getElementById("proactive-master-switch"),
        Y = document.getElementById("proactive-interval-slider"),
        K = document.getElementById("proactive-interval-display"),
        Z = document.getElementById("proactive-contact-list"),
        X = document.getElementById("proactive-status-text");
    let Q = {},
        ee = [],
        te = !1,
        ne = {
            enabled: !1,
            interval: 10,
            targets: [],
        };
    const ae = document.getElementById("menu-delete-btn"),
        oe = document.getElementById("global-beautify-btn"),
        se =
            (document.getElementById("global-beautify-screen"),
                document.getElementById("global-beautify-back-button")),
        ie = document.getElementById("global-css-input"),
        re = document.getElementById("save-global-css-btn"),
        le = document.getElementById("reset-global-css-btn"),
        ce = document.getElementById("global-user-styles");
    let de = [],
        ue = null,
        me = null;
    const pe = document.getElementById("qilang-identity-list");
    let ge = null,
        ye = null;
    const he = document.getElementById("qilang-refresh-btn"),
        ve =
            (document.getElementById("qilang-detail-view"),
                document.getElementById("qilang-detail-back-btn")),
        fe = document.getElementById("qilang-post-btn"),
        we = document.getElementById("qilang-post-modal"),
        be = document.getElementById("qilang-post-cancel-btn"),
        Ee =
            (document.getElementById("qilang-post-confirm-btn"),
                document.getElementById("q-detail-title"),
                document.getElementById("q-detail-content"),
                document.getElementById("q-detail-author-name"),
                document.getElementById("qilang-app-icon")),
        Ie =
            (document.getElementById("qilang-screen"),
                document.getElementById("qilang-menu-btn")),
        xe = document.getElementById("qilang-sidebar"),
        ke = document.getElementById("qilang-sidebar-overlay"),
        Le = document.getElementById("attachment-file-feature"),
        Be = document.getElementById("file-attachment-input"),
        Se = document.getElementById("menu-copy-btn"),
        Ce = document.getElementById("anywhere-door-feature"),
        $e = document.getElementById("anywhere-door-modal"),
        Me = document.getElementById("anywhere-door-close-btn"),
        Te = document.getElementById("anywhere-door-input"),
        Ae = document.getElementById("send-action-msg-btn");
    let De = null,
        Pe = !1;
    const He = document.getElementById("forward-messages-btn"),
        Oe = document.getElementById("forward-target-modal"),
        qe = document.getElementById("forward-target-list"),
        Ne = document.getElementById("forward-modal-close-btn"),
        _e = document.getElementById("menu-select-btn"),
        Fe = document.getElementById("msg-action-menu"),
        Re = document.getElementById("menu-reply-btn"),
        Ge = document.getElementById("reply-preview-bar"),
        We = document.getElementById("reply-preview-name"),
        je = document.getElementById("reply-preview-content"),
        Ue = document.getElementById("cancel-reply-btn");
    let ze = null,
        Ve = null,
        Je = null,
        Ye = null;
    const Ke = document.getElementById("about-device-btn"),
        Ze =
            (document.getElementById("about-device-screen"),
                document.getElementById("about-device-back-button")),
        Xe = document.getElementById("group-header-actions-normal"),
        Qe = document.getElementById("group-header-actions-select"),
        et = document.getElementById("groups-cancel-select-btn"),
        tt = document.getElementById("delete-groups-btn");
    let nt = null;
    const at = document.getElementById("group-info-modal"),
        ot = document.getElementById("add-group-member-modal"),
        st = document.getElementById("add-member-close-btn"),
        it = document.getElementById("save-new-member-btn"),
        rt = document.getElementById("new-member-avatar-input"),
        lt = document.getElementById("new-member-avatar-preview"),
        ct = document.getElementById("new-member-name"),
        dt = document.getElementById("new-member-persona"),
        ut = document.getElementById("edit-member-modal"),
        mt = document.getElementById("edit-member-close-btn"),
        pt = document.getElementById("save-member-btn"),
        gt = document.getElementById("edit-member-avatar-input"),
        yt = document.getElementById("edit-member-preview"),
        ht = document.getElementById("edit-member-name-input"),
        vt = document.getElementById("edit-member-persona-input"),
        ft = document.getElementById("edit-group-user-persona-input"),
        wt = document.getElementById("group-settings-avatar"),
        bt = document.getElementById("group-avatar-upload-input"),
        Et = document.getElementById("edit-group-name-btn"),
        It = document.getElementById("group-user-card"),
        xt = document.getElementById("group-user-avatar"),
        kt = document.getElementById("group-user-name"),
        Lt = document.getElementById("edit-group-user-modal"),
        Bt = document.getElementById("close-group-user-modal"),
        St = document.getElementById("edit-group-user-preview"),
        Ct = document.getElementById("edit-group-user-avatar-input"),
        $t = document.getElementById("edit-group-user-name-input"),
        Mt = document.getElementById("save-group-user-btn"),
        Tt = document.getElementById("group-info-modal"),
        At =
            (document.getElementById("group-info-close-btn"),
                document.getElementById("group-settings-name")),
        Dt = document.getElementById("group-member-count"),
        Pt = document.getElementById("group-members-grid"),
        Ht =
            (document.getElementById("add-group-member-modal"),
                document.getElementById("add-member-close-btn"),
                document.getElementById("new-member-avatar-input"),
                document.getElementById("new-member-avatar-preview")),
        Ot = document.getElementById("new-member-name"),
        qt = document.getElementById("new-member-persona"),
        Nt =
            (document.getElementById("save-new-member-btn"),
                document.getElementById("create-group-modal")),
        _t = document.getElementById("create-group-back-btn"),
        Ft = document.getElementById("create-group-title"),
        Rt = document.getElementById("group-mode-selection"),
        Gt = document.getElementById("group-member-select-container"),
        Wt = document.getElementById("group-member-list"),
        jt = document.getElementById("group-create-footer"),
        Ut = document.getElementById("confirm-create-group-btn"),
        zt = document.getElementById("mode-select-existing"),
        Vt = document.getElementById("mode-create-empty"),
        Jt = document.getElementById("game-segment-control"),
        Yt = Jt ? Jt.querySelectorAll(".segment-btn") : [];
    let Kt = "single";
    const Zt = document.getElementById("shop-segment-control"),
        Xt = Zt ? Zt.querySelectorAll(".segment-btn") : [],
        Qt = document.getElementById("create-group-close-btn"),
        en = document.getElementById("messages-add-btn"),
        tn = document.getElementById("messages-multiselect-btn"),
        nn = tn ? tn.querySelector(".icon-select") : null,
        an = tn ? tn.querySelector(".icon-delete") : null,
        on = document.querySelector("#messages-screen .glass-segment-control"),
        sn = document.querySelectorAll("#messages-screen .segment-btn"),
        rn =
            (document.getElementById("open-drawer-btn"),
                document.getElementById("close-drawer-btn"),
                document.getElementById("bottom-drawer"),
                document.getElementById("reroll-feature")),
        ln = document.getElementById("ai-pendant-url-input"),
        cn = document.getElementById("ai-pendant-css-input"),
        dn = document.getElementById("restore-ai-pendant-btn"),
        un = document.getElementById("user-pendant-url-input"),
        mn = document.getElementById("user-pendant-css-input"),
        pn = document.getElementById("restore-user-pendant-btn"),
        gn = document.getElementById("custom-pendant-styles"),
        yn = document.getElementById("chat-add-attachment-button"),
        hn = (yn && yn.innerHTML, document.getElementById("text-image-feature")),
        vn = document.getElementById("text-image-modal"),
        fn = document.getElementById("text-image-modal-close-btn"),
        wn = document.getElementById("text-image-input"),
        bn = document.getElementById("send-text-image-btn"),
        En = document.getElementById("ai-thought-bubble"),
        In = document.getElementById("chat-contact-name"),
        xn = document.getElementById("manage-font-urls-btn"),
        kn =
            (document.getElementById("font-url-settings-screen"),
                document.getElementById("font-url-back-button")),
        Ln = document.getElementById("add-font-url-btn"),
        Bn = document.getElementById("font-url-list-container");
    let Sn = null;
    const Cn = document.getElementById("text-edit-modal"),
        $n = document.getElementById("text-edit-modal-title"),
        Mn = document.getElementById("text-edit-modal-close-btn"),
        Tn = document.getElementById("text-edit-textarea"),
        An = document.getElementById("text-edit-save-btn");
    let Dn = null;
    const Pn = document.getElementById("dating-history-feature"),
        Hn =
            (document.getElementById("dating-history-screen"),
                document.getElementById("dating-history-back-button")),
        On = document.getElementById("dating-history-container"),
        qn = document.getElementById("add-style-preset-btn"),
        Nn = document.getElementById("style-preset-modal"),
        _n = document.getElementById("style-preset-modal-title"),
        Fn = document.getElementById("style-preset-modal-close-btn"),
        Rn = document.getElementById("style-preset-input"),
        Gn = document.getElementById("save-style-preset-btn");
    let Wn = null;
    const jn = document.getElementById("style-presets-container"),
        Un = document.getElementById("vn-dialog-box"),
        zn = document.getElementById("vn-choices-container"),
        Vn = document.getElementById("custom-choice-modal"),
        Jn = document.getElementById("custom-choice-close-btn"),
        Yn = document.getElementById("custom-choice-input"),
        Kn = document.getElementById("custom-choice-confirm-btn");
    let Zn = [],
        Xn = [],
        Qn = 0,
        ea = !1;
    const ta = document.getElementById("char-upload-box"),
        na = document.getElementById("char-upload-input"),
        aa = document.getElementById("bg-upload-box"),
        oa = document.getElementById("bg-upload-input"),
        sa = document.getElementById("bg-previews-container"),
        ia = document.getElementById("start-dating-btn"),
        ra = document.getElementById("dating-setup-back-btn"),
        la = document.getElementById("appointment-feature"),
        ca = document.getElementById("dating-screen"),
        da = document.getElementById("dating-loader-1"),
        ua = document.getElementById("dating-loader-2"),
        ma = document.getElementById("dating-setup-screen"),
        pa = document.getElementById("dating-settings-screen"),
        ga = document.getElementById("vn-screen"),
        ya = document.getElementById("vn-background"),
        ha = document.getElementById("vn-character"),
        va = document.getElementById("vn-exit-btn"),
        fa = document.getElementById("vn-settings-btn"),
        wa = document.getElementById("vn-char-name"),
        ba = document.getElementById("vn-dialog-text");
    let Ea = null,
        Ia = [];
    const xa = document.getElementById("incoming-call-reason"),
        ka =
            (document.getElementById("request-call-feature"),
                document.getElementById("incoming-call-screen"),
                document.getElementById("incoming-call-avatar")),
        La = document.getElementById("incoming-call-name"),
        Ba = document.getElementById("accept-call-button"),
        Sa = document.getElementById("decline-call-button"),
        Ca = document.getElementById("call-summary-feature"),
        $a =
            (document.getElementById("summary-list-screen"),
                document.getElementById("summary-list-back-button")),
        Ma = document.getElementById("summary-list-container"),
        Ta =
            (document.getElementById("summary-detail-screen"),
                document.getElementById("summary-detail-back-button")),
        Aa = document.getElementById("summary-detail-container"),
        Da = document.getElementById("voice-call-feature"),
        Pa =
            (document.getElementById("voice-call-screen"),
                document.querySelector("#voice-call-screen .call-background"),
                document.getElementById("calling-state")),
        Ha = document.getElementById("calling-avatar"),
        Oa = document.getElementById("calling-name"),
        qa = document.getElementById("calling-status"),
        Na = document.getElementById("cancel-call-button"),
        _a = document.getElementById("connected-state"),
        Fa = document.getElementById("connected-name"),
        Ra = document.getElementById("call-timer"),
        Ga = document.getElementById("ai-speech-bubble-container"),
        Wa = document.getElementById("connected-hang-up-button"),
        ja = document.getElementById("user-speak-button"),
        Ua = document.getElementById("voice-call-input-modal"),
        za = document.getElementById("voice-call-textarea"),
        Va = document.getElementById("send-call-text-button");
    let Ja = null,
        Ya = null,
        Ka = [];
    const Za = document.getElementById("image-preview-modal"),
        Xa = document.getElementById("preview-image-element"),
        Qa = document.getElementById("image-preview-close-btn"),
        eo = document.getElementById("motto-settings-btn"),
        to = document.getElementById("app-name-settings-btn"),
        no =
            (document.getElementById("motto-settings-screen"),
                document.getElementById("appname-settings-screen"),
                document.getElementById("motto-settings-back-button")),
        ao = document.getElementById("appname-settings-back-button"),
        oo = document.getElementById("motto"),
        so = document.querySelectorAll(".app-name"),
        io = document.getElementById("motto-color-input"),
        ro = document.getElementById("motto-color-picker"),
        lo = document.getElementById("motto-blur-toggle"),
        co = document.getElementById("app-name-color-input"),
        uo = document.getElementById("app-name-color-picker"),
        mo = document.getElementById("app-name-blur-toggle"),
        po = document.getElementById("save-preset-button"),
        go = document.getElementById("manage-presets-button"),
        yo =
            (document.getElementById("preset-management-screen"),
                document.getElementById("preset-back-button")),
        ho = document.getElementById("preset-list-container"),
        vo = document.getElementById("import-preset-button"),
        fo = document.getElementById("preset-import-input");
    let wo = !1;
    const bo = document.getElementById("image-feature"),
        Eo = document.getElementById("chat-image-upload-input"),
        Io = document.getElementById("save-all-settings-btn"),
        xo = document.getElementById("chat-message-input");
    document.getElementById("chat-messages-container");
    let ko = !1;
    const Lo = document.getElementById("move-books-in-group-btn");
    const Bo = document.getElementById("worldbook-groups-btn"),
        So =
            (document.getElementById("worldbook-groups-screen"),
                document.getElementById("worldbook-groups-back-button")),
        Co = document.getElementById("add-worldbook-group-btn"),
        $o = document.getElementById("worldbook-groups-list"),
        Mo = document.getElementById("groups-multiselect-btn"),
        To =
            (document.getElementById("worldbook-group-detail-screen"),
                document.getElementById("group-detail-back-button")),
        Ao = document.getElementById("group-detail-title"),
        Do = document.getElementById("add-book-in-group-btn"),
        Po = document.getElementById("books-in-group-list"),
        Ho = document.getElementById("group-detail-multiselect-btn"),
        Oo = document.getElementById("worldbook-header-actions-normal"),
        qo = document.getElementById("worldbook-header-actions-select"),
        No = document.getElementById("move-books-btn"),
        _o = document.getElementById("worldbook-cancel-select-btn"),
        Fo = document.getElementById("move-to-group-modal"),
        Ro = document.getElementById("move-to-group-modal-close-btn"),
        Go = document.getElementById("group-selection-list");
    let Wo = !1,
        jo = !1,
        Uo = null;
    const zo = document.getElementById("group-detail-header-actions-normal"),
        Vo = document.getElementById("group-detail-header-actions-select"),
        Jo = document.getElementById("delete-books-in-group-btn"),
        Yo = document.getElementById("group-detail-cancel-select-btn"),
        Ko = document.getElementById("chat-message-input"),
        Zo = document.getElementById("api-library-modal"),
        Xo = document.getElementById("api-library-modal-close-btn"),
        Qo = document.getElementById("api-library-list-container"),
        es = document.getElementById("save-api-to-library-btn"),
        ts = document.getElementById("select-api-library-btn"),
        ns = document.getElementById("api-library-delete-selected-btn");
    let as = !1;
    const os = document.getElementById("lottery-modal"),
        ss = document.getElementById("toggle-dark-mode"),
        is = document.getElementById("gacha-app-icon"),
        rs = document.getElementById("gacha-screen"),
        ls = document.getElementById("gacha-back-button"),
        cs = document.getElementById("gacha-title"),
        ds = document.getElementById("gacha-segment-control"),
        us = ds.querySelectorAll(".segment-btn"),
        ms =
            (document.getElementById("share-content-panel"),
                document.getElementById("gacha-posts-container")),
        ps = document.getElementById("gacha-avatar-button"),
        gs = document.getElementById("gacha-avatar-img"),
        ys = document.getElementById("gacha-new-post-btn"),
        hs = document.getElementById("gacha-post-modal"),
        vs = document.getElementById("gacha-post-modal-close-btn"),
        fs = document.getElementById("gacha-post-text-input"),
        ws = document.getElementById("gacha-post-image-desc-input"),
        bs = document.getElementById("gacha-confirm-post-btn"),
        Es = document.getElementById("visibility-settings-modal"),
        Is = document.getElementById("visibility-modal-close-btn"),
        xs = document.getElementById("worldbook-visibility-list"),
        ks = document.getElementById("save-visibility-btn"),
        Ls = document.getElementById("summon-ai-modal"),
        Bs = document.getElementById("summon-ai-modal-close-btn"),
        Ss = document.getElementById("summon-ai-list-container");
    let Cs = null,
        $s = null,
        Ms = null;
    const Ts = document.getElementById("transaction-history-card"),
        As =
            (document.getElementById("transactions-screen"),
                document.getElementById("transactions-back-button")),
        Ds = document.getElementById("transactions-list-container"),
        Ps = document.getElementById("blacklist-modal"),
        Hs = document.getElementById("go-to-savings-btn"),
        Os = document.getElementById("unlock-modal"),
        qs = document.getElementById("unlock-modal-close-btn"),
        Ns = document.getElementById("apply-unlock-btn"),
        _s = document.getElementById("unlock-code-input"),
        Fs = document.getElementById("confirm-unlock-btn"),
        Rs = document.getElementById("number-guess-modal"),
        Gs = document.getElementById("coin-flip-modal"),
        Ws = document.getElementById("games-grid"),
        js = document.getElementById("balance-display"),
        Us = document.getElementById("GAME-app-icon"),
        zs =
            (document.getElementById("slacking-off-screen"),
                document.getElementById("slacking-off-back-button")),
        Vs = document.getElementById("slacking-off-title");
    let Js = [],
        Ys = null;
    (document.getElementById("my-orders-button"),
        document.getElementById("my-cart-button"),
        document.getElementById("cart-screen"),
        document.getElementById("cart-back-button"),
        document.getElementById("cart-items-container"),
        document.getElementById("select-recipient-btn"),
        document.getElementById("recipient-name-display"),
        document.getElementById("confirm-purchase-btn"),
        document.getElementById("orders-screen"),
        document.getElementById("orders-back-button"));
    const Ks = document.getElementById("orders-list-container"),
        Zs =
            (document.getElementById("recipient-select-modal"),
                document.getElementById("recipient-modal-close-btn"),
                document.getElementById("recipient-list-container"),
                document.querySelector(".category-tabs"),
                document.getElementById("product-grid")),
        Xs = document.getElementById("SHOP-app-icon"),
        Qs =
            (document.getElementById("shop-screen"),
                document.getElementById("shop-back-button"));
    let ei = null;
    const ti = document.getElementById("shopper-avatar-button"),
        ni = document.getElementById("shopper-avatar-img"),
        ai = document.getElementById("shopper-select-modal"),
        oi = document.getElementById("shopper-modal-close-btn"),
        si = document.getElementById("shopper-list-container"),
        ii =
            (document.querySelectorAll(".shop-tab-item"),
                document.querySelectorAll(".shop-content-panel"),
                document.getElementById("shop-title")),
        ri = document.getElementById("clock-blur-toggle"),
        li = document.querySelector(".clock"),
        ci = document.getElementById("change-clock-button"),
        di =
            (document.getElementById("clock-settings-screen"),
                document.getElementById("clock-settings-back-button")),
        ui = document.getElementById("clock-color-input"),
        mi = document.getElementById("clock-color-picker"),
        pi = document.querySelectorAll(".clock span"),
        gi = document.getElementById("beautify-app-icon"),
        yi =
            (document.getElementById("beautify-screen"),
                document.getElementById("beautify-back-button")),
        hi = document.getElementById("change-icon-button"),
        vi =
            (document.getElementById("icon-settings-screen"),
                document.getElementById("icon-settings-back-button")),
        fi = document.getElementById("multiselect-emoji-btn");
    let wi = !1;
    const bi = document.getElementById("audio-player"),
        Ei = document.getElementById("wallpaper-upload-input"),
        Ii = document.querySelector(".phone-frame"),
        xi = document.querySelector(".app-grid"),
        ki =
            (document.querySelectorAll(".screen"),
                document.getElementById("home-screen"));
    document.getElementById("settings-screen");
    const Li = document.getElementById("settings-app-icon"),
        Bi =
            (document.getElementById("back-button"),
                document.getElementById("save-settings-button"),
                document.getElementById("music-app-icon")),
        Si =
            (document.getElementById("music-screen"),
                document.getElementById("music-back-button")),
        Ci = document.getElementById("playlist-multiselect-btn");
    let $i = !1;
    const Mi = document.getElementById("messages-app-icon"),
        Ti =
            (document.getElementById("messages-screen"),
                document.getElementById("messages-back-button")),
        Ai = document.getElementById("add-contact-modal"),
        Di = document.getElementById("modal-close-btn"),
        Pi = document.getElementById("role-switch-checkbox"),
        Hi = document.querySelectorAll(".switch-label"),
        Oi = document.getElementById("ai-form"),
        qi = document.getElementById("user-form"),
        Ni = document.getElementById("contact-list"),
        _i = document.getElementById("ai-avatar-preview"),
        Fi = document.getElementById("ai-avatar-input"),
        Ri = document.getElementById("ai-name-input"),
        Gi = document.getElementById("ai-persona-input"),
        Wi = document.getElementById("user-avatar-preview"),
        ji = document.getElementById("user-avatar-input"),
        Ui = document.getElementById("user-name-input"),
        zi = document.getElementById("user-persona-input"),
        Vi = document.getElementById("context-memory-input"),
        Ji = document.getElementById("save-contact-btn"),
        Yi =
            (document.getElementById("load-more-messages-btn"),
                document.getElementById("chat-screen")),
        Ki = document.getElementById("chat-back-button"),
        Zi = document.getElementById("chat-contact-name"),
        Xi = document.getElementById("chat-messages-container");
    let Qi = !1;
    const er = document.getElementById("chat-settings-modal"),
        tr = document.getElementById("chat-settings-button"),
        nr = document.getElementById("chat-settings-close-btn"),
        ar = document.getElementById("save-chat-settings-btn"),
        or = document.getElementById("role-switch-checkbox-settings"),
        sr = document.getElementById("ai-form-settings"),
        ir = document.getElementById("user-form-settings"),
        rr = document.getElementById("ai-avatar-preview-settings"),
        lr = document.getElementById("ai-avatar-input-settings"),
        cr =
            (document.getElementById("ai-name-input-settings"),
                document.getElementById("ai-persona-input-settings"),
                document.getElementById("user-avatar-preview-settings")),
        dr = document.getElementById("user-avatar-input-settings"),
        ur =
            (document.getElementById("user-name-input-settings"),
                document.getElementById("user-persona-input-settings"),
                document.getElementById("context-memory-input-settings"),
                document.getElementById("bubble-css-input")),
        mr = document.getElementById("restore-bubble-css-btn"),
        pr = document.getElementById("upload-chat-bg-btn"),
        gr = document.getElementById("reset-chat-bg-btn"),
        yr = document.getElementById("chat-bg-upload-input"),
        hr = document.getElementById("clear-history-btn"),
        vr = document.getElementById("custom-bubble-styles"),
        fr = document.getElementById("toggle-frame-visibility"),
        wr = document.body,
        br = document.getElementById("worldbook-app-icon"),
        Er = document.getElementById("worldbook-back-button"),
        Ir =
            (document.getElementById("add-worldbook-btn"),
                document.getElementById("add-worldbook-modal")),
        xr = document.getElementById("worldbook-modal-close-btn"),
        kr = document.getElementById("save-worldbook-btn"),
        Lr = document.getElementById("worldbook-name-input"),
        Br = document.getElementById("worldbook-content-input"),
        Sr = document.getElementById("worldbook-list"),
        Cr = document.getElementById("worldbook-multiselect-btn");
    let $r = !1,
        Mr = null;
    (document.getElementById("show-avatars-toggle"),
        document.getElementById("avatar-radius-input"));
    const Tr = document.getElementById("backup-data-btn"),
        Ar = document.getElementById("import-data-btn"),
        Dr = document.getElementById("import-file-input"),
        Pr = document.getElementById("custom-font-style"),
        Hr =
            (document.getElementById("change-font-btn"),
                document.getElementById("restore-font-btn"),
                document.getElementById("font-import-input")),
        Or =
            (document.getElementById("worldbook-select-settings"),
                document.getElementById("chat-emoji-button")),
        qr = document.getElementById("chat-screen"),
        Nr = document.getElementById("chat-messages-container"),
        _r = document.getElementById("api-url"),
        Fr = document.getElementById("api-key"),
        Rr = document.getElementById("connect-api-button"),
        Gr = document.getElementById("api-connection-status"),
        Wr = document.getElementById("api-model"),
        jr =
            (document.getElementById("save-settings-button"),
                document.getElementById("temperature-slider")),
        Ur = document.getElementById("temperature-value"),
        zr = document.getElementById("clock-hours"),
        Vr = document.getElementById("clock-minutes"),
        Jr = document.getElementById("motto"),
        Yr =
            (document.getElementById("widgetContainer"),
                document.getElementById("toggle-widget-visibility"),
                document.getElementById("imageUploader"),
                document.getElementById("widgetText"),
                document.getElementById("wallpaper-preview")),
        Kr =
            (document.getElementById("reset-wallpaper-btn"),
                document.getElementById("upload-wallpaper-btn"),
                document.getElementById("collapsed-song-title"),
                document.getElementById("dynamic-island")),
        Zr = document.getElementById("island-song-title"),
        Xr = document.getElementById("island-song-artist"),
        Qr = document.getElementById("island-play-pause-btn"),
        el = document.getElementById("island-prev-btn"),
        tl = document.getElementById("island-next-btn"),
        nl = document.getElementById("progress-current-time"),
        al = document.getElementById("progress-remaining-time"),
        ol = document.getElementById("progress-bar-fill"),
        sl = document.getElementById("add-playlist-btn"),
        il = document.getElementById("playlist-grid"),
        rl =
            (document.getElementById("playlist-detail-screen"),
                document.getElementById("playlist-back-button")),
        ll = document.getElementById("playlist-name-title"),
        cl = document.getElementById("import-music-button"),
        dl = document.getElementById("music-file-input"),
        ul = document.getElementById("song-list"),
        ml = document.getElementById("upload-cover-btn"),
        pl = document.getElementById("multi-select-btn"),
        gl = document.getElementById("cover-upload-input"),
        yl = document.getElementById("edit-playlist-name-btn"),
        hl = document.getElementById("add-emoji-btn"),
        vl = document.getElementById("add-emoji-modal"),
        fl = document.getElementById("emoji-modal-close-btn"),
        wl = document.getElementById("save-emoji-btn"),
        bl = document.getElementById("emoji-urls-textarea"),
        El = document.getElementById("emoji-grid-container"),
        Il = document.getElementById("icon-list-container"),
        xl = new Map([]),
        kl = new Map();

    function Ll(e) {
        return kl.has(e) ? kl.get(e) : Jp(e);
    }
    async function Bl(e) {
        if ((kl.clear(), e))
            try {
                const t = await Kl.loadData("worldBooks", "allWorldBooks"),
                    n = t && Array.isArray(t.value) ? t.value : [];
                let a = new Set();
                if (e.linkedWorldBookIds && e.linkedWorldBookIds.length > 0)
                    e.linkedWorldBookIds.forEach((e) => a.add(e));
                else if (
                    e.linkedWorldBookGroupIds &&
                    e.linkedWorldBookGroupIds.length > 0
                ) {
                    const t = await Kl.loadData("worldBookGroups", "allGroups"),
                        n = t && Array.isArray(t.value) ? t.value : [],
                        o = new Set(e.linkedWorldBookGroupIds);
                    n.forEach((e) => {
                        o.has(e.id) &&
                            Array.isArray(e.bookIds) &&
                            e.bookIds.forEach((e) => a.add(e));
                    });
                }
                (n
                    .filter((e) => a.has(e.id))
                    .forEach((e) => {
                        !(function (e) {
                            if (!e) return;
                            const t = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;
                            let n;
                            for (; null !== (n = t.exec(e));) {
                                const e = n[1].trim(),
                                    t = n[2].trim();
                                (kl.set(e, t), console.log(`Â∑≤Ê≥®ÂÜåÂ§¥ÂÉè: ${e} -> ${t}`));
                            }
                        })(e.content);
                    }),
                    console.log("Â§¥ÂÉèÂ∫ìÂä†ËΩΩÂÆåÊØïÔºåÂΩìÂâçÂ§¥ÂÉèÊï∞:", kl.size));
            } catch (e) {
                console.error("Âä†ËΩΩÂ§¥ÂÉèÂ∫ìÂ§±Ë¥•", e);
            }
    }

    function Sl(e) {
        if (!Xi) return;
        let t = document.getElementById("optimized-chat-bg-layer");
        if (!t) {
            ((t = document.createElement("div")),
                (t.id = "optimized-chat-bg-layer"),
                (t.style.cssText =
                    "\n                position: absolute;\n                top: 0; left: 0; right: 0; bottom: 0;\n                width: 100%; height: 100%;\n                z-index: 0; /* ‰Ωç‰∫éÂÜÖÂÆπ‰πã‰∏ã */\n                pointer-events: none; /* ÁÇπÂáªÁ©øÈÄè */\n                transform: translate3d(0, 0, 0); /* Ëß¶ÂèëÁ°¨‰ª∂Âä†ÈÄü */\n                will-change: transform; /* ÂëäÁü•ÊµèËßàÂô®‰ºòÂåñ */\n                background-size: cover;\n                background-position: center;\n                background-repeat: no-repeat;\n                backface-visibility: hidden; /* ‰øÆÂ§çÊüê‰∫õËÆæÂ§áÈó™ÁÉÅ */\n            "));
            const e = Xi.parentNode;
            if (e) {
                ("static" === window.getComputedStyle(e).position &&
                    (e.style.position = "relative"),
                    e.insertBefore(t, Xi));
            }
        }
        ((Xi.style.background = "none"),
            (Xi.style.backgroundColor = "transparent"),
            (Xi.style.position = "relative"),
            (Xi.style.zIndex = "1"),
            e
                ? requestAnimationFrame(() => {
                    t.style.backgroundImage = `url('${e}')`;
                })
                : ((t.style.backgroundImage = ""), (t.style.display = "none")),
            e && (t.style.display = "block"));
    }
    (oe &&
        oe.addEventListener("click", () => {
            Ii.classList.add("show-global-beautify");
        }),
        se &&
        se.addEventListener("click", () => {
            Ii.classList.remove("show-global-beautify");
        }),
        re &&
        re.addEventListener("click", async () => {
            const e = ie.value;
            wp(e);
            try {
                (await Kl.saveData("settingsStore", "globalUserCss", e),
                    alert("ÂÖ®Â±ÄÊ†∑ÂºèÂ∑≤Â∫îÁî®ÔºÅ"),
                    Ii.classList.remove("show-global-beautify"));
            } catch (e) {
                alert("‰øùÂ≠òÂ§±Ë¥•Ôºö" + e.message);
            }
        }),
        le &&
        le.addEventListener("click", async () => {
            confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂÖ®Â±ÄÁæéÂåñ‰ª£Á†ÅÂêóÔºü") &&
                (wp(""),
                    await Kl.saveData("settingsStore", "globalUserCss", ""),
                    alert("Â∑≤ÈáçÁΩÆ„ÄÇ"));
        }),
        pr &&
        pr.addEventListener("click", () => {
            yr && yr.click();
        }),
        yr &&
        yr.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            if (t)
                if (((e.target.value = ""), t.type.startsWith("image/")))
                    try {
                        let e;
                        if (
                            (window.iOSBabyMode &&
                                window.iOSBabyMode.enabled &&
                                t.size > 2097152
                                ? (window.iOSBabyMode.showProgressToast(
                                    "Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...",
                                    0,
                                ),
                                    (e = await window.iOSBabyMode.safeCompressImage(t, {
                                        maxWidth: 1920,
                                        maxHeight: 1920,
                                        quality: 0.75,
                                        onProgress: (e) => {
                                            window.iOSBabyMode.showProgressToast(
                                                "Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...",
                                                e,
                                            );
                                        },
                                    })),
                                    window.iOSBabyMode.hideProgressToast())
                                : (e = window.iOSBabyMode
                                    ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                    : await new Promise((e, n) => {
                                        const a = new FileReader();
                                        ((a.onload = (t) => e(t.target.result)),
                                            (a.onerror = n),
                                            a.readAsDataURL(t));
                                    })),
                                Sl(e),
                                window.iOSBabyMode &&
                                window.iOSBabyMode.enabled &&
                                (await new Promise((e) => setTimeout(e, 50))),
                                Sc)
                        ) {
                            Sc.chatBackground = e;
                            try {
                                let t = (await Kl.loadData("messageContacts", "allContacts"))
                                    .value;
                                const n = t.findIndex((e) => e.id === Sc.id);
                                n > -1
                                    ? ((Sc.backgroundImage = e),
                                        (t[n] = Sc),
                                        await Kl.saveData("messageContacts", "allContacts", t),
                                        void 0 !== Ye && (Ye = t),
                                        console.log("ËÅäÂ§©ËÉåÊôØÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì"))
                                    : console.error("Êú™ÊâæÂà∞ËÅîÁ≥ª‰∫∫Á¥¢Âºï");
                            } catch (e) {
                                (console.error("‰øùÂ≠òËÅäÂ§©ËÉåÊôØÂ§±Ë¥•:", e),
                                    alert("‰øùÂ≠òÂ§±Ë¥•,ËØ∑ÈáçËØï"));
                            }
                        } else console.error("currentOpenContact Êú™ÂÆö‰πâ");
                    } catch (e) {
                        (console.error("ËØªÂèñÂõæÁâáÂ§±Ë¥•:", e),
                            window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                            alert(
                                `‚ùå ËØªÂèñÂõæÁâáÂ§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`,
                            ));
                    }
                else alert("ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºÅ");
        }),
        gr &&
        gr.addEventListener("click", async () => {
            if (confirm("Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§ËÅäÂ§©ËÉåÊôØÂêó?"))
                if ((Sl(null), Sc)) {
                    ((Sc.chatBackground = null), (Sc.backgroundImage = null));
                    try {
                        let e = (await Kl.loadData("messageContacts", "allContacts"))
                            .value;
                        const t = e.findIndex((e) => e.id === Sc.id);
                        (t > -1 &&
                            ((e[t].chatBackground = null),
                                (e[t].backgroundImage = null),
                                await Kl.saveData("messageContacts", "allContacts", e),
                                void 0 !== Ye && (Ye = e),
                                console.log("[ResetChatBg] Â∑≤Ê∏ÖÈô§ËÅäÂ§©ËÉåÊôØÔºåID:", Sc.id)),
                            alert("Â∑≤ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØ"));
                    } catch (e) {
                        (console.error("‰øùÂ≠òÂ§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•,ËØ∑ÈáçËØï"));
                    }
                } else console.error("currentOpenContact Êú™ÂÆö‰πâ");
        }));
    const Cl = document.getElementById("theme-presets-btn"),
        $l =
            (document.getElementById("theme-presets-screen"),
                document.getElementById("theme-presets-back-button")),
        Ml = document.getElementById("theme-presets-list"),
        Tl = document.getElementById("theme-presets-empty"),
        Al = document.getElementById("save-as-theme-preset-btn"),
        Dl = document.getElementById("import-theme-preset-btn"),
        Pl = document.getElementById("theme-preset-import-input");

    function Hl() {
        return JSON.parse(localStorage.getItem("themePresets") || "[]");
    }

    function Ol(e) {
        localStorage.setItem("themePresets", JSON.stringify(e));
    }

    function ql() {
        const e = Hl();
        ((Ml.innerHTML = ""),
            0 !== e.length
                ? ((Tl.style.display = "none"),
                    e.forEach((e, t) => {
                        const n = document.createElement("div");
                        n.className = "theme-preset-item";
                        const a =
                            e.css.length > 100 ? e.css.substring(0, 100) + "..." : e.css,
                            o = new Date(e.createdAt).toLocaleString("zh-CN", {
                                month: "short",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                            });
                        ((n.innerHTML = `\n                <div class="theme-preset-header">\n                    <span class="theme-preset-name">${e.name}</span>\n                    <span class="theme-preset-time">${o}</span>\n                </div>\n                <div class="theme-preset-preview">${a || "(Á©∫)"}</div>\n                <div class="theme-preset-actions">\n                    <button class="apply-btn" data-index="${t}">Â∫îÁî®</button>\n                    <button class="export-btn" data-index="${t}">ÂØºÂá∫</button>\n                    <button class="delete-btn" data-index="${t}">Âà†Èô§</button>\n                </div>\n            `),
                            Ml.appendChild(n));
                    }),
                    Ml.querySelectorAll(".apply-btn").forEach((e) => {
                        e.addEventListener("click", (e) => {
                            !(function (e) {
                                const t = Hl();
                                if (t[e]) {
                                    const n = t[e].css;
                                    ((ie.value = n),
                                        wp(n),
                                        Kl.saveData("settingsStore", "globalUserCss", n),
                                        alert(`Â∑≤Â∫îÁî®‰∏ªÈ¢ò: ${t[e].name}`));
                                }
                            })(parseInt(e.target.dataset.index));
                        });
                    }),
                    Ml.querySelectorAll(".export-btn").forEach((e) => {
                        e.addEventListener("click", (e) => {
                            !(function (e) {
                                const t = Hl();
                                if (t[e]) {
                                    const n = t[e],
                                        a = JSON.stringify(n, null, 2),
                                        o = new Blob([a], {
                                            type: "application/json",
                                        }),
                                        s = URL.createObjectURL(o),
                                        i = document.createElement("a");
                                    ((i.href = s),
                                        (i.download = `${n.name}.json`),
                                        i.click(),
                                        URL.revokeObjectURL(s));
                                }
                            })(parseInt(e.target.dataset.index));
                        });
                    }),
                    Ml.querySelectorAll(".delete-btn").forEach((e) => {
                        e.addEventListener("click", (e) => {
                            !(function (e) {
                                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ªÈ¢òÈ¢ÑËÆæÂêóÔºü")) {
                                    const t = Hl();
                                    (t.splice(e, 1), Ol(t), ql());
                                }
                            })(parseInt(e.target.dataset.index));
                        });
                    }))
                : (Tl.style.display = "block"));
    }
    (Cl &&
        Cl.addEventListener("click", () => {
            (ql(), Ii.classList.add("show-theme-presets"));
        }),
        $l &&
        $l.addEventListener("click", () => {
            Ii.classList.remove("show-theme-presets");
        }),
        Al &&
        Al.addEventListener("click", () => {
            const e = ie.value.trim();
            if (!e) return void alert("ËØ∑ÂÖàËæìÂÖ•CSS‰ª£Á†ÅÂÜç‰øùÂ≠ò‰∏∫È¢ÑËÆæ");
            const t = prompt("ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞:", "ÊàëÁöÑ‰∏ªÈ¢ò " + (Hl().length + 1));
            if (!t) return;
            const n = Hl();
            (n.unshift({
                name: t,
                css: e,
                createdAt: Date.now(),
            }),
                Ol(n),
                alert("È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ"));
        }),
        Dl &&
        Dl.addEventListener("click", () => {
            Pl.click();
        }),
        Pl &&
        Pl.addEventListener("change", (e) => {
            const t = e.target.files[0];
            if (!t) return;
            const n = new FileReader();
            ((n.onload = (e) => {
                try {
                    const t = JSON.parse(e.target.result);
                    if (!t.name || "string" != typeof t.css)
                        throw new Error("Êó†ÊïàÁöÑÈ¢ÑËÆæÊ†ºÂºè");
                    t.createdAt = t.createdAt || Date.now();
                    const n = Hl();
                    (n.unshift(t), Ol(n), ql(), alert(`ÊàêÂäüÂØºÂÖ•‰∏ªÈ¢ò: ${t.name}`));
                } catch (e) {
                    alert("ÂØºÂÖ•Â§±Ë¥•: " + e.message);
                }
            }),
                n.readAsText(t),
                (e.target.value = ""));
        }));
    const Nl = document.getElementById("bubble-presets-btn"),
        _l =
            (document.getElementById("bubble-presets-screen"),
                document.getElementById("bubble-presets-back-button")),
        Fl = document.getElementById("bubble-presets-list"),
        Rl = document.getElementById("bubble-presets-empty"),
        Gl =
            (document.getElementById("select-bubble-preset-btn"),
                document.getElementById("save-bubble-preset-btn"),
                document.getElementById("bubble-preset-select-modal")),
        Wl = document.getElementById("bubble-preset-select-close-btn"),
        jl = document.getElementById("bubble-preset-select-list"),
        Ul = document.getElementById("bubble-preset-select-empty");

    function zl() {
        return JSON.parse(localStorage.getItem("bubblePresets") || "[]");
    }

    function Vl(e) {
        localStorage.setItem("bubblePresets", JSON.stringify(e));
    }

    function Jl() {
        const e = zl();
        ((Fl.innerHTML = ""),
            0 !== e.length
                ? ((Rl.style.display = "none"),
                    e.forEach((e, t) => {
                        const n = document.createElement("div");
                        n.className = "bubble-preset-item";
                        const a =
                            e.css.length > 80 ? e.css.substring(0, 80) + "..." : e.css,
                            o = new Date(e.createdAt).toLocaleString("zh-CN", {
                                month: "short",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                            });
                        ((n.innerHTML = `\n                <div class="preset-header">\n                    <span class="preset-name">${e.name}</span>\n                    <span class="preset-time">${o}</span>\n                </div>\n                <div class="preset-preview">${a || "(Á©∫)"}</div>\n                <div class="preset-actions">\n                    <button class="share-btn" data-index="${t}">ÂàÜ‰∫´</button>\n                    <button class="delete-btn" data-index="${t}">Âà†Èô§</button>\n                </div>\n            `),
                            Fl.appendChild(n));
                    }),
                    Fl.querySelectorAll(".share-btn").forEach((e) => {
                        e.addEventListener("click", (e) => {
                            !(function (e) {
                                const t = zl();
                                if (t[e]) {
                                    const n = t[e].css;
                                    navigator.clipboard
                                        .writeText(n)
                                        .then(() => {
                                            alert(`"${t[e].name}" ÁöÑCSS‰ª£Á†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ`);
                                        })
                                        .catch(() => {
                                            alert("Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂");
                                        });
                                }
                            })(parseInt(e.target.dataset.index));
                        });
                    }),
                    Fl.querySelectorAll(".delete-btn").forEach((e) => {
                        e.addEventListener("click", (e) => {
                            !(function (e) {
                                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê∞îÊ≥°È¢ÑËÆæÂêóÔºü")) {
                                    const t = zl();
                                    (t.splice(e, 1), Vl(t), Jl());
                                }
                            })(parseInt(e.target.dataset.index));
                        });
                    }))
                : (Rl.style.display = "block"));
    }

    function Yl() {
        const e = zl();
        ((jl.innerHTML = ""),
            0 !== e.length
                ? ((Ul.style.display = "none"),
                    e.forEach((e, t) => {
                        const n = document.createElement("div");
                        ((n.className = "bubble-select-item"), (n.dataset.index = t));
                        const a =
                            e.css.length > 30 ? e.css.substring(0, 30) + "..." : e.css;
                        ((n.innerHTML = `\n                <span class="item-name">${e.name}</span>\n                <span class="item-preview">${a}</span>\n            `),
                            n.addEventListener("click", () => {
                                !(function (e) {
                                    const t = zl();
                                    t[e] &&
                                        ur &&
                                        ((ur.value = t[e].css),
                                            (Gl.style.display = "none"),
                                            alert(
                                                `Â∑≤ÈÄâÊã©È¢ÑËÆæ: ${t[e].name}\nËØ∑ÁÇπÂáª"‰øùÂ≠ò"ÊåâÈíÆÂ∫îÁî®Âà∞ÂΩìÂâçËÅäÂ§©`,
                                            ));
                                })(t);
                            }),
                            jl.appendChild(n));
                    }))
                : (Ul.style.display = "block"));
    }
    (Nl &&
        Nl.addEventListener("click", () => {
            (Jl(), Ii.classList.add("show-bubble-presets"));
        }),
        _l &&
        _l.addEventListener("click", () => {
            Ii.classList.remove("show-bubble-presets");
        }),
        document.addEventListener("click", (e) => {
            if (
                e.target &&
                ("select-bubble-preset-btn" === e.target.id ||
                    e.target.closest("#select-bubble-preset-btn"))
            ) {
                (e.preventDefault(), e.stopPropagation());
                const t = document.getElementById("bubble-preset-select-modal");
                t && (Yl(), (t.style.display = "flex"));
            }
        }),
        Wl &&
        Wl.addEventListener("click", () => {
            Gl.style.display = "none";
        }),
        Gl &&
        Gl.addEventListener("click", (e) => {
            e.target === Gl && (Gl.style.display = "none");
        }),
        document.addEventListener("click", (e) => {
            if (e.target && "save-bubble-preset-btn" === e.target.id) {
                (e.preventDefault(), e.stopPropagation());
                const t = document.getElementById("bubble-css-input"),
                    n = t ? t.value.trim() : "";
                if (!n) return void alert("ËØ∑ÂÖàËæìÂÖ•Ê∞îÊ≥°CSS‰ª£Á†ÅÂÜç‰øùÂ≠ò");
                const a = prompt(
                    "ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞:",
                    "ÊàëÁöÑÊ∞îÊ≥°Ê†∑Âºè " + (zl().length + 1),
                );
                if (!a) return;
                const o = zl();
                (o.unshift({
                    name: a,
                    css: n,
                    createdAt: Date.now(),
                }),
                    Vl(o),
                    alert("Ê∞îÊ≥°È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ"));
            }
        }),
        Se.addEventListener("click", () => {
            if (!ze) return;
            let e = "";
            const t = ze.querySelector(".voice-transcript"),
                n = ze.querySelector(".text-image-card .card-text"),
                a = ze.querySelector(".html-render-container"),
                o = ze.querySelector(".chat-bubble");
            if (t) e = t.textContent;
            else if (n) e = n.textContent;
            else if (a) e = "HTMLÂÜÖÂÆπÊó†Ê≥ïÁõ¥Êé•Â§çÂà∂";
            else if (o) {
                const t = o.cloneNode(!0),
                    n = t.querySelector(".reply-quote-container");
                (n && n.remove(), (e = t.textContent.trim()));
            }
            e
                ? navigator.clipboard
                    .writeText(e)
                    .then(() => {
                        (console.log("Â∑≤Â§çÂà∂"), Zm());
                    })
                    .catch((e) => {
                        (console.error("Â§çÂà∂Â§±Ë¥•: ", e), alert("Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï"), Zm());
                    })
                : Zm();
        }),
        _e.addEventListener("click", () => {
            (Zm(), ze ? (md(ze), gd(ze)) : md());
        }),
        document.addEventListener("click", (e) => {
            "flex" !== Fe.style.display || Fe.contains(e.target) || Zm();
        }),
        Xi.addEventListener("scroll", Zm),
        Re.addEventListener("click", () => {
            if (!ze) return;
            const e =
                ze.querySelector(".message-content-wrapper") ||
                ze.querySelector(".group-message-wrapper");
            if (!e) return (console.error("Êó†Ê≥ïÊâæÂà∞Ê∂àÊÅØÂÆπÂô®"), void Zm());
            const t = ze.dataset.uuid,
                n = e.classList.contains("user");
            let a = "Ê∂àÊÅØÂÜÖÂÆπ";
            const o = ze.querySelector(".chat-bubble");
            o &&
                (a = o.classList.contains("image-bubble")
                    ? "[ÂõæÁâá]"
                    : o.classList.contains("sticker-bubble")
                        ? "[Ë°®ÊÉÖÂåÖ]"
                        : o.querySelector(".voice-transcript")
                            ? "[ËØ≠Èü≥]: " + o.querySelector(".voice-transcript").textContent
                            : o.textContent);
            let s = "Êú™Áü•";
            if (n) Je ? (s = Je.userCardName || "Êàë") : Sc && (s = Sc.user.name);
            else {
                const e = ze.querySelector(".group-nickname");
                e ? (s = e.textContent) : Sc && (s = Sc.ai.name);
            }
            ((Ve = {
                uuid: t,
                text: a,
                senderName: s,
            }),
                (We.textContent = s),
                (je.textContent = a),
                (Ge.style.display = "flex"),
                xo.focus(),
                Zm());
        }),
        Ue.addEventListener("click", Xm),
        Xt.forEach((e) => {
            e.addEventListener("click", () => {
                (Xt.forEach((e) => e.classList.remove("active")),
                    e.classList.add("active"));
                if ("my" === e.dataset.target)
                    (Zt.classList.add("my-mode"),
                        ii && (ii.textContent = "ÊàëÁöÑ"),
                        document
                            .getElementById("my-account-content-panel")
                            .classList.add("active"),
                        document
                            .getElementById("shopping-content-panel")
                            .classList.remove("active"));
                else {
                    (Zt.classList.remove("my-mode"),
                        ii && (ii.textContent = "7 SHOP"),
                        document
                            .getElementById("my-account-content-panel")
                            .classList.remove("active"),
                        document
                            .getElementById("shopping-content-panel")
                            .classList.add("active"));
                    const e = document.querySelector(".category-tab.active");
                    !(function (e) {
                        Zs.innerHTML = "";
                        const t = du[e] || [];
                        if (0 === t.length)
                            return void (Zs.innerHTML = "<p>ËØ•ÂàÜÁ±ª‰∏ãÊöÇÊó†ÂïÜÂìÅ</p>");
                        t.forEach((e) => {
                            const t = document.createElement("div");
                            t.className = "product-card";
                            const n = e.brand
                                ? `<div class="product-brand-tag">${e.brand}</div>`
                                : "";
                            ((t.innerHTML = `\n            ${n} \n            <div class="product-name">${e.name}</div>\n            <div class="product-description">${e.description}</div>\n            <div class="product-footer">\n                <span class="product-price">¬•${e.price.toFixed(2)}</span>\n                <button class="add-to-cart-btn">+</button>\n            </div>\n        `),
                                Zs.appendChild(t));
                        });
                    })(e ? e.dataset.category : "takeout");
                }
            });
        }),
        Yt.forEach((e) => {
            e.addEventListener("click", () => {
                (Yt.forEach((e) => e.classList.remove("active")),
                    e.classList.add("active"));
                "savings" === e.dataset.target
                    ? (Jt.classList.add("savings-mode"),
                        Vs && (Vs.textContent = "ÂÇ®ËìÑ"),
                        document
                            .getElementById("savings-content-panel")
                            .classList.add("active"),
                        document
                            .getElementById("games-content-panel")
                            .classList.remove("active"),
                        mu())
                    : (Jt.classList.remove("savings-mode"),
                        Vs && (Vs.textContent = "Ê∏∏Êàè"),
                        document
                            .getElementById("savings-content-panel")
                            .classList.remove("active"),
                        document
                            .getElementById("games-content-panel")
                            .classList.add("active"),
                        gu());
            });
        }),
        us.forEach((e) => {
            e.addEventListener("click", () => {
                (us.forEach((e) => e.classList.remove("active")),
                    e.classList.add("active"));
                const t = e.dataset.target;
                ("forum" === t
                    ? (ds.classList.add("forum-mode"), (cs.textContent = "FORUM"))
                    : (ds.classList.remove("forum-mode"), (cs.textContent = "SHARE")),
                    document
                        .querySelectorAll(".gacha-content-panel")
                        .forEach((e) => e.classList.remove("active")));
                const n = document.getElementById(`${t}-content-panel`);
                n && n.classList.add("active");
            });
        }),
        xi.addEventListener("click", (e) => {
            const t = e.target.closest(".app-container[data-app-id]");
            if (t) {
                const e = t.dataset.appId;
                if ("music-screen" === e) return void alert("ÊöÇÂÅú‰ΩøÁî®ÔºåÂæÖÁª¥‰øÆ");
                const n = document.getElementById(e);
                n &&
                    (function (e, t) {
                        if (!t) return;
                        t.style.transformOrigin = "center center";
                        const n = t.id;
                        if (n && n.includes("-screen")) {
                            const e = n.replace("-screen", "");
                            Ii.classList.add(`show-${e}`);
                        } else t.classList.add("active");
                    })(0, n);
            }
        }));
    const Kl = {
        db: null,
        dbName: "phoneDataDB",

        async init() {
            if (this.db) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, 19);

                request.onerror = (event) => {
                    console.error("Êï∞ÊçÆÂ∫ìÊâìÂºÄÊó∂ÂèëÁîüÈîôËØØ:", event.target.error);
                    reject(`Êï∞ÊçÆÂ∫ìÊâìÂºÄÂ§±Ë¥•: ${event.target.error}`);
                };

                request.onupgradeneeded = (event) => {
                    console.log("Êï∞ÊçÆÂ∫ìÈúÄË¶ÅÂçáÁ∫ßÊàñÈ¶ñÊ¨°ÂàõÂª∫...");
                    const db = event.target.result;
                    const storeNames = [
                        "settingsStore", "messageContacts", "musicPlaylists", "worldBooks",
                        "emojiStore", "gachaPosts", "gachaPostInteractions", "worldBookGroups",
                        "iconPresets", "datingSetupStore", "writingStylePresets", "datingHistoryStore",
                        "fontUrlStore", "groupChats", "qilangPosts", "wowPosts",
                        "memoryCheques", "wowoData"
                    ];

                    try {
                        storeNames.forEach(name => {
                            if (!db.objectStoreNames.contains(name)) {
                                console.log(`Ê≠£Âú®ÂàõÂª∫Ë°®: ${name}`);
                                db.createObjectStore(name, {
                                    keyPath: name === "emojiStore" ? "url" : "id"
                                });
                            }
                        });
                        console.log("ÊâÄÊúâË°®ÁªìÊûÑÊ£ÄÊü•/ÂàõÂª∫ÂÆåÊØï„ÄÇ");

                        if (!db.objectStoreNames.contains("forwardedRecords")) {
                            console.log("Ê≠£Âú®ÂàõÂª∫ forwardedRecords Ë°®...");
                            db.createObjectStore("forwardedRecords", { keyPath: "id" });
                        }
                    } catch (error) {
                        console.error("Âú® onupgradeneeded ‰∫ã‰ª∂‰∏≠ÂàõÂª∫Ë°®Â§±Ë¥•:", error);
                        // Abort transaction if possible, though event.target.transaction might be null in some weird edge cases
                        if (event.target.transaction) event.target.transaction.abort();
                        reject("ÂàõÂª∫Êï∞ÊçÆÂ∫ìË°®Â§±Ë¥•");
                    }
                };

                request.onsuccess = async (event) => {
                    this.db = event.target.result;
                    console.log("Êï∞ÊçÆÂ∫ìÂ∑≤ÊàêÂäüËøûÊé•Âπ∂ÂáÜÂ§áÂ∞±Áª™„ÄÇ");
                    await this.checkLegacyMigration();
                    resolve();
                };
            });
        },

        // Ê†∏ÂøÉ‰∫ãÂä°ËæÖÂä©ÂáΩÊï∞ - Core Transaction Helper
        performTransaction(storeName, mode, operation) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñ");
                const tx = this.db.transaction([storeName], mode);
                const store = tx.objectStore(storeName);

                let request;
                try {
                    request = operation(store);
                } catch (e) {
                    return reject(e);
                }

                // Â¶ÇÊûúÊìç‰ΩúËøîÂõû‰∫Ü‰∏Ä‰∏™ËØ∑Ê±ÇÂØπË±° (Â¶Ç get, put, getAll)
                if (request && request.onsuccess !== undefined) {
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                } else {
                    // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÈÄªËæë (Â¶Ç iterate, saveMany)Ôºå‰æùËµñ‰∫ãÂä°ÂÆåÊàê
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                }
            });
        },

        async getAllKeys(e) {
            return new Promise((t, n) => {
                const a = this.db.transaction([e], "readonly").objectStore(e).getAllKeys();
                (a.onsuccess = () => t(a.result || [])), (a.onerror = (e) => n(e.target.error));
            });
        },
        async syncContacts(e) {
            if (!Array.isArray(e)) return Promise.resolve();
            const t = await this.getAllKeys("messageContacts"),
                n = new Set(t.filter((e) => e.toString().startsWith("c_"))),
                a = new Set(e.map((e) => `c_${e.id}`)),
                o = [...n].filter((e) => !a.has(e)),
                s = e.map((e) => ({
                    id: `c_${e.id}`,
                    value: e
                }));
            return new Promise((t, n) => {
                const a = this.db.transaction(["messageContacts"], "readwrite"),
                    i = a.objectStore("messageContacts");
                o.forEach((e) => i.delete(e)),
                    s.forEach((e) => i.put(e)),
                    i.delete("allContacts"),
                    (a.oncomplete = () => t()),
                    (a.onerror = (e) => n(e.target.error));
            });
        },
        async saveData(e, t, n) {
            if ("messageContacts" === e && "allContacts" === t && Array.isArray(n)) {
                console.log("‚ö° [Kl] Intercepting allContacts save -> Syncing split records...");
                return this.syncContacts(n);
            }
            return this.performTransaction(e, "readwrite", (a) =>
                a.put({
                    id: t,
                    value: n,
                }),
            );
        },
        async loadData(e, t) {
            if ("messageContacts" === e && "allContacts" === t) {
                try {
                    // Optimized: Use Cursor Streaming instead of Chunked Gets
                    // This avoids the 'staircase' memory spikes and ensures we only touch 'c_' keys.
                    const self = this;
                    return new Promise((resolve, reject) => {
                        const results = [];
                        const range = IDBKeyRange.bound("c_", "c_\uffff");
                        const transaction = self.db.transaction([e], "readonly");
                        const store = transaction.objectStore(e);
                        const request = store.openCursor(range);
                        let count = 0;

                        request.onsuccess = async (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                // Unwrap value if needed
                                const raw = cursor.value;
                                if (raw && raw.value) results.push(raw.value);
                                else results.push(raw);

                                count++;
                                cursor.continue();
                            } else {
                                console.log(`[Kl] Cursor load complete. Total: ${results.length}`);
                                // === ËøÅÁßªÈÄªËæëÔºöÂ¶ÇÊûú c_* ÈîÆ‰∏≠Ê≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÊóßÁöÑ allContacts ÈîÆËØªÂèñ ===
                                if (results.length === 0) {
                                    console.log("[Kl] No c_* records found. Attempting legacy migration from 'allContacts'...");
                                    try {
                                        const legacyTx = self.db.transaction([e], "readonly");
                                        const legacyStore = legacyTx.objectStore(e);
                                        const legacyRequest = legacyStore.get("allContacts");

                                        legacyRequest.onsuccess = async (legacyEvent) => {
                                            const legacyData = legacyEvent.target.result;
                                            if (legacyData && legacyData.value && Array.isArray(legacyData.value) && legacyData.value.length > 0) {
                                                console.log(`[Kl] ‚úÖ Found ${legacyData.value.length} contacts in legacy 'allContacts'. Migrating...`);
                                                // Ëá™Âä®ËøÅÁßªÂà∞Êñ∞ÁöÑÂàÜÁâáÊ†ºÂºè
                                                try {
                                                    await self.syncContacts(legacyData.value);
                                                    console.log("[Kl] ‚úÖ Migration complete! Legacy data converted to c_* format.");
                                                } catch (migrationErr) {
                                                    console.error("[Kl] Migration failed:", migrationErr);
                                                }
                                                resolve({ value: legacyData.value });
                                            } else {
                                                console.log("[Kl] No legacy 'allContacts' data found either. Returning empty list.");
                                                resolve({ value: [] });
                                            }
                                        };
                                        legacyRequest.onerror = (legacyErr) => {
                                            console.error("[Kl] Legacy read failed:", legacyErr);
                                            resolve({ value: [] });
                                        };
                                    } catch (legacyErr) {
                                        console.error("[Kl] Legacy migration attempt failed:", legacyErr);
                                        resolve({ value: [] });
                                    }
                                } else {
                                    resolve({ value: results });
                                }
                            }
                        };
                        request.onerror = (err) => reject(err);
                    });
                } catch (err) {
                    console.error("[Kl] Chunked load failed, falling back:", err);
                }
            }
            return this.performTransaction(e, "readonly", (n) => n.get(t));
        },
        async loadMultipleData(e, t) {
            return new Promise((n, a) => {
                const o = this.db.transaction([e], "readonly"),
                    s = o.objectStore(e),
                    i = {};
                t.forEach((e) => {
                    s.get(e).onsuccess = (t) => {
                        i[e] = t.target.result;
                    };
                }),
                    (o.oncomplete = () => n(i)),
                    (o.onerror = (e) => a(e.target.error));
            });
        },
        async deleteData(e, t) {
            return this.performTransaction(e, "readwrite", (n) => n.delete(t));
        },
        async clearStore(e) {
            return this.performTransaction(e, "readwrite", (t) => t.clear());
        },
        async updateRecord(e, t, n) {
            return this.performTransaction(e, "readwrite", (a) => {
                const o = a.get(t);
                o.onsuccess = (a) => {
                    const s = a.target.result;
                    if (s) {
                        const a = {
                            ...s.value,
                            ...n
                        };
                        s.value = a;
                        const i = o.source.put(s);
                        (i.onsuccess = () => Promise.resolve(a)),
                            (i.onerror = (e) => Promise.reject(e.target.error));
                    }
                };
            });
        },
        async getAllDataFromStore(e) {
            // Warning: This can still be heavy for very large stores. Use iterate() if possible.
            if ("messageContacts" === e) {
                console.warn("‚ö†Ô∏è [Kl] getAllDataFromStore used on messageContacts. Prefer iterate or filtered load.");
            }
            return this.performTransaction(e, "readonly", (t) => t.getAll());
        },
        async saveMany(e, t) {
            return new Promise((n, a) => {
                const o = this.db.transaction([e], "readwrite"),
                    s = o.objectStore(e);
                try {
                    t.forEach((e) => {
                        s.put(e);
                    });
                } catch (e) {
                    return a(e);
                }
                (o.oncomplete = () => n()), (o.onerror = (e) => a(e.target.error));
            });
        },
        // Cursor-based iteration
        async iterate(storeName, callback) {
            return new Promise((resolve, reject) => {
                if (!this.db) return reject("Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñ");
                const tx = this.db.transaction([storeName], "readonly");
                const store = tx.objectStore(storeName);
                const request = store.openCursor();

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        // Pass both value and cursor to update/delete if needed (though existing callback design might need readwrite for that)
                        // For now, this is readonly iteration.
                        if (cursor.value && cursor.value.value) {
                            callback(cursor.value.value, cursor);
                        } else if (cursor.value) {
                            callback(cursor.value, cursor);
                        }
                        cursor.continue();
                    }
                };
                tx.oncomplete = () => resolve();
                tx.onerror = (e) => reject(e.target.error);
            });
        },
        async checkLegacyMigration() {
            try {
                console.log("[MigrationCheck] Checking for legacy data (Pre-boot)...");
                const legacyTx = this.db.transaction(["messageContacts"], "readonly");
                const legacyReq = legacyTx.objectStore("messageContacts").get("allContacts");

                const legacyData = await new Promise((resolve) => {
                    legacyReq.onsuccess = e => resolve(e.target.result);
                    legacyReq.onerror = () => resolve(null);
                });

                if (legacyData && (legacyData.value || Array.isArray(legacyData))) {
                    const contacts = legacyData.value || legacyData;
                    if (Array.isArray(contacts) && contacts.length > 0) {
                        console.log(`[MigrationCheck] Found ${contacts.length} legacy contacts.`);
                        const newCount = await new Promise((resolve) => {
                            const tx = this.db.transaction(["messageContacts"], "readonly");
                            const req = tx.objectStore("messageContacts").count(IDBKeyRange.bound("c_", "c_\uffff"));
                            req.onsuccess = e => resolve(e.target.result);
                            req.onerror = () => resolve(0);
                        });
                        if (newCount === 0) {
                            console.log("[MigrationCheck] ‚ö†Ô∏è No new contacts found. FORCE MIGRATING now.");
                            await this.syncContacts(contacts);
                            console.log("[MigrationCheck] ‚úÖ Force migration done.");
                        } else {
                            console.log(`[MigrationCheck] New contacts exist (${newCount}). Skipping force migration.`);
                        }
                    }
                }
            } catch (e) { console.warn("[MigrationCheck] Error:", e); }
        },
    };

    function Zl() {
        (Vn.classList.remove("visible"),
            setTimeout(() => {
                Vn.style.display = "none";
            }, 300));
    }
    ((window.dbHelper = Kl), window.stickerMap = new Map, window.avatarMap = new Map, window.extractAndRegisterStickers = function (e) { if (!e) return []; const t = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g, n = []; let r; for (; (r = t.exec(e)) !== null;) { const i = r[1].trim(), o = r[2].trim(); window.stickerMap.set(i, o), n.push(i) } return n }, window.extractAndRegisterAvatars = function (e) { if (!e) return; const t = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g; let n; for (; (n = t.exec(e)) !== null;) { const r = n[1].trim(), i = n[2].trim(); window.avatarMap.set(r, i) } }, window.getSmartAvatar = function (e) { return window.avatarMap.has(e) ? window.avatarMap.get(e) : "function" == typeof window.generateTextAvatar ? window.generateTextAvatar(e) : "https://placehold.co/100x100/ccc/fff?text=" + e.charAt(0) }, window.refreshGlobalAvatarMap = async function (e) { window.avatarMap.clear(); if (!e) return; try { const t = await window.dbHelper.loadData("worldBooks", "allWorldBooks"), n = t && Array.isArray(t.value) ? t.value : []; let r = new Set; e.linkedWorldBookIds && e.linkedWorldBookIds.length > 0 ? e.linkedWorldBookIds.forEach(e => r.add(e)) : e.linkedWorldBookGroupIds && e.linkedWorldBookGroupIds.length > 0 && ((await window.dbHelper.loadData("worldBookGroups", "allGroups")).value || []).forEach(t => { new Set(e.linkedWorldBookGroupIds).has(t.id) && Array.isArray(t.bookIds) && t.bookIds.forEach(e => r.add(e)) }); n.filter(e => r.has(e.id)).forEach(e => { window.extractAndRegisterAvatars(e.content), window.extractAndRegisterStickers(e.content) }), console.log("Â§¥ÂÉèÂ∫ìÂä†ËΩΩÂÆåÊØïÔºåÂΩìÂâçÂ§¥ÂÉèÊï∞:", window.avatarMap.size) } catch (e) { console.error("Âä†ËΩΩÂ§¥ÂÉèÂ∫ìÂ§±Ë¥•", e) } },
        xn.addEventListener("click", () => {
            (Ii.classList.add("show-font-url"), Cm());
        }),
        kn.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("font-url-list-container"),
                Ii.classList.remove("show-font-url"));
        }),
        ra.addEventListener("click", () => {
            (Ii.classList.remove("show-dating"),
                setTimeout(() => {
                    (ma.classList.remove("visible"),
                        ga.classList.remove("visible"),
                        da.classList.remove("visible"),
                        ua.classList.remove("visible"),
                        (ca.style.pointerEvents = ""),
                        (ca.style.zIndex = ""));
                }, 500));
        }),
        Pn.addEventListener("click", () => {
            (Lm(), Ii.classList.add("show-dating-history"), id());
        }),
        Hn.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("dating-history-container"),
                Ii.classList.remove("show-dating-history"));
        }),
        Jn.addEventListener("click", Zl),
        Vn.addEventListener("click", (e) => {
            e.target === Vn && Zl();
        }),
        Kn.addEventListener("click", () => {
            const e = Yn.value.trim();
            e && (wm(e), Zl());
        }),
        pa.addEventListener("click", (e) => {
            const t = e.target;
            if (
                ("dating-settings-back-btn" === t.id &&
                    Ii.classList.remove("show-dating-settings"),
                    t.classList.contains("menu-button"))
            ) {
                const e = t.dataset.target,
                    n = document.getElementById(e);
                if (n)
                    if (
                        ((document.getElementById("dating-settings-main").style.display =
                            "none"),
                            (n.style.display = "flex"),
                            "portrait-settings" === e)
                    ) {
                        const e = document.getElementById("portrait-settings-content");
                        ((e.innerHTML = Xl),
                            (function (e) {
                                const t = e.querySelector("#char-upload-box-settings"),
                                    n = e.querySelector("#char-upload-input-settings"),
                                    a = e.querySelector("#delete-char-portrait-btn");
                                Ea &&
                                    ((t.style.backgroundImage = `url('${Ea}')`),
                                        (t.textContent = ""));
                                (t.addEventListener("click", () => n.click()),
                                    n.addEventListener("change", (e) => {
                                        const n = e.target.files[0];
                                        if (!n) return;
                                        const a = new FileReader();
                                        ((a.onload = (e) => {
                                            ((Ea = e.target.result),
                                                (t.style.backgroundImage = `url('${Ea}')`),
                                                (t.textContent = ""),
                                                (ha.style.backgroundImage = `url('${Ea}')`),
                                                pm(),
                                                um());
                                        }),
                                            a.readAsDataURL(n));
                                    }),
                                    a.addEventListener("click", () => {
                                        confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÁöÑËßíËâ≤Á´ãÁªòÂêóÔºü") &&
                                            ((Ea = null),
                                                (t.style.backgroundImage = "none"),
                                                (t.textContent = "ÁÇπÂáª‰∏ä‰º†"),
                                                (ha.style.backgroundImage = "none"),
                                                pm(),
                                                um());
                                    }));
                            })(e));
                    } else if ("background-settings" === e) {
                        const e = document.getElementById("background-settings-content");
                        ((e.innerHTML = Ql),
                            (function (e) {
                                const t = e.querySelector("#bg-upload-box"),
                                    n = e.querySelector("#bg-upload-input"),
                                    a = e.querySelector("#bg-previews-container");

                                function o(e) {
                                    ((e.innerHTML = ""),
                                        Ia.forEach((t, n) => {
                                            const a = document.createElement("div");
                                            ((a.className = "bg-preview-item"),
                                                (a.innerHTML = `\n                ${t.isDefault ? '<div class="default-tag">ÈªòËÆ§</div>' : ""}\n                <div class="preview-img" style="background-image: url('${t.url}')"></div>\n                <div class="preview-details">\n                    <div class="preview-tags">Ê†áÁ≠æ: ${t.tags.join(", ")}</div>\n                    <div class="preview-actions">\n                        <button class="set-default-btn" data-index="${n}">ËÆæ‰∏∫ÈªòËÆ§</button>\n                        <button class="delete-btn" data-index="${n}">Âà†Èô§</button>\n                    </div>\n                </div>\n            `),
                                                e.appendChild(a));
                                        }));
                                }
                                (t.addEventListener("click", () => n.click()),
                                    n.addEventListener("change", (e) => {
                                        const t = e.target.files[0];
                                        if (!t) return;
                                        const n = prompt(
                                            "ËØ∑ËæìÂÖ•Ê≠§ËÉåÊôØÁöÑÊ†áÁ≠æ (Â§ö‰∏™Ê†áÁ≠æËØ∑Áî®Á©∫Ê†ºÊàñÈÄóÂè∑ÈöîÂºÄ):",
                                            "ÈªòËÆ§",
                                        );
                                        if (null === n) return;
                                        const s = n.split(/[\s,Ôºå]+/).filter((e) => e),
                                            i = new FileReader();
                                        ((i.onload = (e) => {
                                            const t = {
                                                url: e.target.result,
                                                tags: s.length > 0 ? s : ["Êú™ÂàÜÁ±ª"],
                                                isDefault: !1,
                                            };
                                            (0 === Ia.length && (t.isDefault = !0),
                                                Ia.push(t),
                                                o(a),
                                                pm());
                                        }),
                                            i.readAsDataURL(t));
                                    }),
                                    a.addEventListener("click", (e) => {
                                        const t = e.target;
                                        if (!t.dataset.index) return;
                                        const n = parseInt(t.dataset.index, 10);
                                        if (
                                            (t.classList.contains("set-default-btn") &&
                                                (Ia.forEach((e, t) => (e.isDefault = t === n)),
                                                    (ya.style.backgroundImage = `url('${Ia[n].url}')`),
                                                    o(a),
                                                    pm()),
                                                t.classList.contains("delete-btn") &&
                                                confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÉåÊôØÂêóÔºü"))
                                        ) {
                                            const e = Ia[n].isDefault;
                                            (Ia.splice(n, 1),
                                                e && Ia.length > 0
                                                    ? ((Ia[0].isDefault = !0),
                                                        (ya.style.backgroundImage = `url('${Ia[0].url}')`))
                                                    : 0 === Ia.length &&
                                                    (ya.style.backgroundImage = "none"),
                                                o(a),
                                                pm());
                                        }
                                    }),
                                    o(a));
                            })(e));
                    } else if ("font-settings" === e) {
                        const e = document.getElementById("font-settings-content");
                        ((e.innerHTML = ym),
                            (function (e) {
                                const t = e.querySelector("#char-name-color-input"),
                                    n = e.querySelector("#char-name-color-picker"),
                                    a = e.querySelector("#char-name-size-slider"),
                                    o = e.querySelector("#char-name-size-value"),
                                    s = e.querySelector("#dialog-text-color-input"),
                                    i = e.querySelector("#dialog-text-color-picker"),
                                    r = e.querySelector("#dialog-text-size-slider"),
                                    l = e.querySelector("#dialog-text-size-value"),
                                    c = document.getElementById("vn-char-name-container"),
                                    d = document.getElementById("vn-dialog-text");

                                function u() {
                                    const e = window.getComputedStyle(c).color,
                                        u = parseInt(window.getComputedStyle(c).fontSize, 10),
                                        p = window.getComputedStyle(d).color,
                                        g = parseFloat(window.getComputedStyle(d).fontSize);
                                    ((t.value = m(e)),
                                        (n.value = m(e)),
                                        (a.value = u),
                                        (o.textContent = `${u}px`),
                                        (s.value = m(p)),
                                        (i.value = m(p)),
                                        (r.value = g),
                                        (l.textContent = `${g}px`));
                                }

                                function m(e) {
                                    let t = e.indexOf(",") > -1 ? "," : " ",
                                        n = (+(e = e.substr(4).split(")")[0].split(t))[0]).toString(
                                            16,
                                        ),
                                        a = (+e[1]).toString(16),
                                        o = (+e[2]).toString(16);
                                    return (
                                        1 == n.length && (n = "0" + n),
                                        1 == a.length && (a = "0" + a),
                                        1 == o.length && (o = "0" + o),
                                        "#" + n + a + o
                                    );
                                }
                                (t.addEventListener("input", (e) => {
                                    const t = e.target.value;
                                    ((n.value = t), (c.style.color = t));
                                }),
                                    n.addEventListener("input", (e) => {
                                        const n = e.target.value;
                                        ((t.value = n), (c.style.color = n));
                                    }),
                                    a.addEventListener("input", (e) => {
                                        const t = e.target.value;
                                        ((o.textContent = `${t}px`), (c.style.fontSize = `${t}px`));
                                    }),
                                    s.addEventListener("input", (e) => {
                                        const t = e.target.value;
                                        ((i.value = t), (d.style.color = t));
                                    }),
                                    i.addEventListener("input", (e) => {
                                        const t = e.target.value;
                                        ((s.value = t), (d.style.color = t));
                                    }),
                                    r.addEventListener("input", (e) => {
                                        const t = e.target.value;
                                        ((l.textContent = `${t}px`), (d.style.fontSize = `${t}px`));
                                    }),
                                    u());
                            })(e));
                    } else if ("writing-style-settings" === e) {
                        Im(document.getElementById("style-presets-container"));
                    }
            }
            if (t.classList.contains("submenu-back-btn")) {
                const e = t.dataset.target,
                    n = document.getElementById(e);
                n &&
                    ((t.closest(".settings-submenu").style.display = "none"),
                        (n.style.display = "flex"));
            }
        }));
    const Xl =
        '\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px; gap: 15px;">\n        <div class="setup-section">\n            <label>ÂΩìÂâçÁ´ãÁªò</label>\n            <div class="upload-box" id="char-upload-box-settings">ÁÇπÂáª‰∏ä‰º†</div>\n            <input type="file" id="char-upload-input-settings" accept="image/*" style="display: none;">\n            \n            <button id="delete-char-portrait-btn" class="form-button-secondary" style="width: 90%; color: #ff3b30; border-color: rgba(255, 59, 48, 0.2);">Âà†Èô§Á´ãÁªò</button>\n        </div>\n    </div>\n',
        Ql =
            '\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px;">\n         <div class="setup-section">\n            <label>Ê∑ªÂä†Êñ∞ËÉåÊôØ</label>\n            <div class="upload-box" id="bg-upload-box">ÁÇπÂáª‰∏ä‰º†</div>\n            <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">\n        </div>\n        <div class="setup-section" style="flex-grow: 1; min-height: 0;">\n             <label>Â∑≤Ê∑ªÂä†ÁöÑËÉåÊôØ</label>\n             <div id="bg-previews-container"></div>\n        </div>\n    </div>\n';
    (fa.addEventListener("click", () => {
        (Ii.classList.add("show-dating-settings"),
            (document.getElementById("dating-settings-main").style.display = "flex"),
            document
                .querySelectorAll(".settings-submenu")
                .forEach((e) => (e.style.display = "none")));
    }),
        la.addEventListener("click", async () => {
            try {
                if (!Sc) return void alert("ÈîôËØØÔºöÊó†Ê≥ïËé∑ÂèñÂΩìÂâçAIËßíËâ≤‰ø°ÊÅØÔºÅ");
                id();
                const e = await Kl.loadData("datingSetupStore", Sc.id);
                (Ii.classList.add("show-dating"),
                    e &&
                        e.value &&
                        e.value.portrait &&
                        e.value.backgrounds.some((e) => e.isDefault)
                        ? (ua.classList.add("visible"),
                            setTimeout(() => {
                                (ua.classList.remove("visible"), gm(e.value));
                            }, 5e3))
                        : (da.classList.add("visible"),
                            setTimeout(() => {
                                (da.classList.remove("visible"), ma.classList.add("visible"));
                            }, 2e3)));
            } catch (e) {
                (console.error("„ÄêË∞ÉËØï„ÄëÂú® 'Ëµ¥Á∫¶' ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂‰∏≠ÊçïËé∑Âà∞ÈîôËØØ:", e),
                    alert("Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÊåâF12Âú®ÊéßÂà∂Âè∞Êü•ÁúãËØ¶ÁªÜÁöÑÁ∫¢Ëâ≤ÈîôËØØ‰ø°ÊÅØ„ÄÇ"));
            }
        }),
        va.addEventListener("click", () => {
            confirm("Ë¶ÅÁªìÊùüÊú¨Ê¨°Á∫¶‰ºöÂêóÔºü\nÔºàÁªìÊùüÂêéAI‰ºö‰∏∫‰Ω†ÁîüÊàê‰∏ÄÊÆµ‰∏ìÂ±ûÁöÑÁ∫¶‰ºöËÆ∞ÂøÜÔºâ") &&
                (!(async function () {
                    if (!Sc || 0 === Zn.length) return;
                    let e = "";
                    Zn.forEach((t) => {
                        ("narration" !== t.type && "dialogue" !== t.type) ||
                            (e += `${t.speaker}: ${t.segments.join(" ")}\n`);
                    });
                    const t = `(Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Â∞Ü‰ª•‰∏ãËøôÊÆµÁ∫¶‰ºöÂú∫ÊôØÁöÑÂØπËØùÂíåÊóÅÁôΩÔºåÊÄªÁªìÊàê‰∏ÄÊÆµ2-3Âè•ËØùÁöÑ„ÄÅÊ∏©È¶®ÁöÑÊó•ËÆ∞ÂºèÂõûÂøÜ„ÄÇËØ∑‰ª•Áî®Êà∑ÁöÑËßÜËßíÊù•ÂÜôÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇ‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊ†ºÂºèÊàñÊ†áÁ≠æÔºåÁõ¥Êé•ËæìÂá∫Êó•ËÆ∞ÂÜÖÂÆπ„ÄÇ)\n\n„ÄêÁ∫¶‰ºöÂú∫ÊôØ„Äë:\n${e}`;
                    console.log("Ê≠£Âú®ËØ∑Ê±ÇAIÁîüÊàêÁ∫¶‰ºöÊëòË¶Å...");
                    const n = await xm(t);
                    if (n) {
                        console.log("AIÁîüÊàêÁöÑÊëòË¶Å:", n);
                        const e = {
                            id: Date.now(),
                            value: {
                                contactId: Sc.id,
                                date: new Date().toISOString(),
                                partnerName: Sc.ai.name,
                                summary: n,
                            },
                        };
                        await Kl.updateRecord("datingHistoryStore", e);
                        const t = {
                            sender: "system",
                            type: "system",
                            text: "[Á≥ªÁªüÊèêÁ§∫ÔºöÁ∫¶‰ºöËÆ∞ÂøÜÂ∑≤‰øùÂ≠ò„ÄÇ]",
                            timestamp: new Date(),
                            uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                        };
                        (await Ac(t, Sc.id), console.log("Á∫¶‰ºöÊëòË¶ÅÂ∑≤ÊàêÂäü‰øùÂ≠òÂπ∂Ê≥®ÂÖ•ËÆ∞ÂøÜÔºÅ"));
                    } else console.error("AIÊú™ËÉΩÁîüÊàêÊúâÊïàÁöÑÁ∫¶‰ºöÊëòË¶Å„ÄÇ");
                })(),
                    Ii.classList.remove("show-dating"),
                    void 0 !== Zn && (Zn = []),
                    void 0 !== Xn && (Xn = []),
                    void 0 !== Qn && (Qn = 0),
                    void 0 !== ea && (ea = !1),
                    window.DOMCleanupManager.clean("vn-choices-container"),
                    setTimeout(() => {
                        (ga.classList.remove("visible"),
                            ma.classList.remove("visible"),
                            (pa.style.display = "none"),
                            (ba.innerHTML = ""),
                            (zn.innerHTML = ""),
                            (ha.style.backgroundImage = "none"),
                            (ya.style.backgroundImage = "none"),
                            (ca.style.pointerEvents = ""),
                            (ca.style.zIndex = ""),
                            console.log("Á∫¶‰ºöÁïåÈù¢Â∑≤ÂÆåÂÖ®ÈÄÄÂá∫Âπ∂ÈáçÁΩÆ„ÄÇ"));
                    }, 800));
        }),
        ta.addEventListener("click", () => na.click()),
        aa.addEventListener("click", () => oa.click()),
        na.addEventListener("change", (e) => {
            const t = e.target.files[0];
            if (!t) return;
            const n = new FileReader();
            ((n.onload = (e) => {
                ((Ea = e.target.result),
                    (ta.style.backgroundImage = `url('${Ea}')`),
                    (ta.textContent = ""),
                    pm(),
                    um());
            }),
                n.readAsDataURL(t));
        }),
        oa.addEventListener("change", (e) => {
            const t = e.target.files[0];
            if (!t) return;
            const n = prompt(
                "ËØ∑ËæìÂÖ•Ê≠§ËÉåÊôØÁöÑÊ†áÁ≠æ (Â§ö‰∏™Ê†áÁ≠æËØ∑Áî®Á©∫Ê†ºÊàñÈÄóÂè∑ÈöîÂºÄ):",
                "ÈªòËÆ§",
            );
            if (null === n) return;
            const a = n.split(/[\s,Ôºå]+/).filter((e) => e),
                o = new FileReader();
            ((o.onload = (e) => {
                const t = {
                    url: e.target.result,
                    tags: a.length > 0 ? a : ["Êú™ÂàÜÁ±ª"],
                    isDefault: !1,
                };
                (0 === Ia.length && (t.isDefault = !0), Ia.push(t), mm(), pm());
            }),
                o.readAsDataURL(t));
        }),
        sa.addEventListener("click", (e) => {
            const t = e.target,
                n = parseInt(t.dataset.index, 10);
            (t.classList.contains("set-default-btn") &&
                (Ia.forEach((e, t) => {
                    e.isDefault = t === n;
                }),
                    mm(),
                    pm()),
                t.classList.contains("delete-btn") &&
                confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÉåÊôØÂêóÔºü") &&
                (Ia.splice(n, 1),
                    !Ia.some((e) => e.isDefault) &&
                    Ia.length > 0 &&
                    (Ia[0].isDefault = !0),
                    mm(),
                    pm()));
        }),
        Ca.addEventListener("click", () => {
            (om(), Ii.classList.add("show-summary-list"), id());
        }),
        $a.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("summary-list-container"),
                Ii.classList.remove("show-summary-list"));
        }),
        Ta.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("summary-detail-container"),
                Ii.classList.remove("show-summary-detail"),
                Ii.classList.add("show-summary-list"));
        }),
        Da.addEventListener("click", () => {
            !(async function () {
                if (!Sc) return void alert("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂØπËØùÔºÅ");
                ((Ka = []),
                    document
                        .getElementById("scroll-to-bottom-btn")
                        .classList.remove("visible"),
                    (Ha.style.backgroundImage = `url(${Sc.ai.avatar})`),
                    (Oa.textContent = Sc.ai.name),
                    (qa.textContent = "Ê≠£Âú®ÂëºÂè´..."),
                    Pa.classList.add("active"),
                    _a.classList.remove("active"),
                    Ii.classList.add("show-voice-call"),
                    id());
                setTimeout(() => {
                    am();
                }, 1500);
            })();
        }),
        Na.addEventListener("click", () => sm(!1)),
        Wa.addEventListener("click", () => sm(!1)),
        ja.addEventListener("click", () => {
            ((za.value = ""),
                (Ua.style.display = "flex"),
                setTimeout(() => {
                    ((Ua.style.opacity = "1"), za.focus());
                }, 10));
        }),
        Va.addEventListener("click", async function () {
            const e = za.value.trim();
            if (!e) return;
            ((Ua.style.opacity = "0"),
                setTimeout(() => (Ua.style.display = "none"), 300),
                Ka.push({
                    role: "user",
                    content: e,
                }),
                cm());
            const t = Sc.history || [],
                n = t
                    .slice(-6)
                    .map((e) => {
                        const t = Mc(e);
                        return t
                            ? {
                                role: "user" === e.sender ? "user" : "assistant",
                                content: t,
                            }
                            : null;
                    })
                    .filter(Boolean),
                a = await rm(
                    '(Á≥ªÁªüÊåá‰ª§ÔºöËøôÊòØÁî®Êà∑ÁöÑÊúÄÊñ∞ÂõûÂ∫îÔºåËØ∑‰Ω†ÁªßÁª≠ÂØπËØù„ÄÇËÆ∞‰ΩèÔºå„ÄêÂº∫Âà∂„ÄëÂ∞Ü‰Ω†ÁöÑÂõûÂ§çÊãÜÂàÜ‰∏∫2-5Âè•Áü≠Ê∂àÊÅØÔºåÂπ∂Áî® "\\" ÂàÜÈöî„ÄÇ-   „ÄêÊûÅÂÖ∂ÈáçË¶Å„Äë‰Ω†ÁöÑÂõûÂ§çÂ∞±ÊòØËØ¥ÁöÑËØùÊú¨Ë∫´Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®ÂõûÂ§çÁöÑÂºÄÂ§¥Ê∑ªÂä† "ËØ≠Èü≥Ôºö" Êàñ‰ªª‰ΩïÁ±ª‰ººÁöÑÂâçÁºÄ„ÄÇ\n    -   ‚úÖ **Ê≠£Á°ÆËåÉ‰æã**: ÂñÇÔºü\\ËÉΩÂê¨Âà∞ÊàëËØ¥ËØùÂêóÔºü\n    -   ‚ùå **ÈîôËØØËåÉ‰æã**: ËØ≠Èü≥ÔºöÂñÇÔºü\\ËØ≠Èü≥ÔºöËÉΩÂê¨Âà∞ÊàëËØ¥ËØùÂêóÔºü\n-   „ÄêÊûÅÂÖ∂ÈáçË¶Å„Äë‰∏•Á¶Å‰ΩøÁî®‰ªª‰ΩïÂÖ∂‰ªñÊåá‰ª§ÂâçÁºÄÔºå‰æãÂ¶Ç "Ë°®ÊÉÖÂåÖÔºö" Êàñ "ËΩ¨Ë¥¶Ôºö"„ÄÇËøôÈáåÊòØÁîµËØùÔºå‰Ω†Êó†Ê≥ïÊâßË°åÈÇ£‰∫õÊìç‰Ωú„ÄÇ\n-   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËæìÂá∫‰ªª‰ΩïJSON‰ª£Á†ÅÊàñ‰ª£Á†ÅÂùó„ÄÇ)',
                    Sc,
                    Ka,
                    n,
                );
            a &&
                a.length > 0 &&
                (a.forEach((e) =>
                    Ka.push({
                        role: "assistant",
                        content: e,
                    }),
                ),
                    await lm(a));
        }),
        Ua.addEventListener("click", (e) => {
            e.target === Ua &&
                ((Ua.style.opacity = "0"),
                    setTimeout(() => (Ua.style.display = "none"), 300));
        }),
        Or.addEventListener("click", () => {
            (qr.classList.contains("features-panel-active") &&
                qr.classList.remove("features-panel-active"),
                qr.classList.toggle("emoji-panel-active"),
                setTimeout(() => {
                    Nr.scrollTop = Nr.scrollHeight;
                }, 300));
        }));
    let ec = {
        playlist: [],
        currentIndex: -1,
        currentSong: null,
        isPlaying: !1,
    };

    function tc() {
        const e = new Date(),
            t = String(e.getHours()).padStart(2, "0"),
            n = String(e.getMinutes()).padStart(2, "0");
        ((zr.textContent = t), (Vr.textContent = n));
    }
    async function nc() {
        const n = await Kl.loadMultipleData("settingsStore", [
            "savedMotto",
            "apiSettings",
            "homeWallpaper",
            "isFullscreenEnabled",
            "darkModeEnabled",
        ]),
            a = n.savedMotto;
        a && (Jr.textContent = a.value);
        const o = n.apiSettings;
        if (o) {
            const e = o.value;
            ((_r.value = e.url || ""),
                (Fr.value = e.key || ""),
                e.model &&
                ((Wr.innerHTML = `<option value="${e.model}">${e.model}</option>`),
                    (Wr.value = e.model),
                    (Wr.disabled = !1)),
                (jr.value = e.temperature || 1),
                sc());
        }
        const s = n.homeWallpaper,
            i = s ? s.value : "url('https://i.postimg.cc/rs927KZZ/Group-2-(2).png')";
        ki.style.backgroundImage = i;
        const r =
            document.getElementById("settings-wallpaper-preview-bg") ||
            document.getElementById("wallpaper-preview");
        r && (r.style.backgroundImage = i);
        const l = n.isFullscreenEnabled,
            c = !(!e || !t),
            d = l ? l.value : c;
        ((fr.checked = d), bc(d));
        const u = n.darkModeEnabled,
            m = !!u && u.value;
        ((ss.checked = m), ku(m));
        const p = () => {
            window.ImageStore &&
                window.ImageStore.get("userDeviceSkin").then((e) => {
                    e && Xp(e);
                });
        };
        "requestIdleCallback" in window
            ? requestIdleCallback(p, {
                timeout: 2e3,
            })
            : setTimeout(p, 500);
    }
    if (El) {
        El.addEventListener("click", (e) => {
            if (wi) {
                const t = e.target.closest(".emoji-item-container");
                if (t) {
                    const n = t.querySelector(".emoji-checkbox");
                    n &&
                        (e.target !== n && (n.checked = !n.checked),
                            t.classList.toggle("selected", n.checked));
                }
                return;
            }
            if (
                "IMG" === e.target.tagName &&
                e.target.classList.contains("emoji-item")
            ) {
                const t = e.target,
                    n = t.nextElementSibling,
                    a = n ? n.textContent.trim() : "Ë°®ÊÉÖ",
                    o = t.dataset.url;
                if (o) {
                    (Dc({
                        type: "sticker",
                        text: `[Ë°®ÊÉÖÂåÖÔºö${a}]`,
                        url: o,
                    }),
                        qr.classList.remove("emoji-panel-active"));
                }
            }
        });
    }
    async function migrateChatHistory() {
        const MIGRATION_KEY = "migration_v2_split_contacts";
        if (localStorage.getItem(MIGRATION_KEY)) return;
        console.log("‚è≥ [Migration] Optimizing contacts storage (V2)...");
        try {
            const e = await Kl.loadData("messageContacts", "allContacts");
            if (!e || !Array.isArray(e.value)) {
                return void localStorage.setItem(MIGRATION_KEY, "true");
            }
            const t = e.value;
            const historyItems = [];
            let n = 0;
            for (const contact of t) {
                if (contact.history && contact.history.length > 0) {
                    historyItems.push({
                        id: `history_${contact.id}`,
                        value: contact.history
                    });
                    contact.history = [];
                    contact.hasSeparatedHistory = !0;
                    n++;
                }
            }
            if (historyItems.length > 0) {
                await Kl.saveMany("messageContacts", historyItems);
                console.log(`‚úÖ [Migration] Separated history for ${n} contacts.`);
            }
            // Trigger V2 formatting (Split Blob -> Individual Records)
            await Kl.saveData("messageContacts", "allContacts", t);
            console.log("‚úÖ [Migration] Contacts storage split completed.");

            localStorage.setItem(MIGRATION_KEY, "true");
        } catch (e) {
            console.error("‚ùå [Migration] Failed:", e);
        }
    }
    (async function () {
        "Notification" in window &&
            "granted" !== Notification.permission &&
            Notification.requestPermission();
        try {
            const e =
                /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                ("MacIntel" === navigator.platform && navigator.maxTouchPoints > 1),
                t = async (t = 50) => {
                    e && (await new Promise((e) => setTimeout(e, t)));
                };
            (await Kl.init(),
                await migrateChatHistory(),
                await t(30),
                await nc(),
                await t(30),
                await Lc(),
                await t(50),
                await (async function () {
                    try {
                        const e = await Kl.loadData("settingsStore", "globalUserCss");
                        e &&
                            e.value &&
                            (wp(e.value), console.log("ÂÖ®Â±ÄÁæéÂåñ‰ª£Á†ÅÂ∑≤Âä†ËΩΩ„ÄÇ"));
                    } catch (e) {
                        console.error("Âä†ËΩΩÂÖ®Â±ÄCSSÂ§±Ë¥•", e);
                    }
                })(),
                await t(20),
                await (async function () {
                    const e = await Kl.loadData("settingsStore", "clockColor");
                    if (e && e.value) {
                        const t = e.value;
                        (au(t), (ui.value = t), (mi.value = t));
                    }
                })(),
                await t(20),
                await (async function () {
                    const e = await Kl.loadData("settingsStore", "clockBlurEffect"),
                        t = !!e && e.value;
                    ((ri.checked = t), ou(t));
                })(),
                await t(20),
                await (async function () {
                    const e = await Kl.loadData("settingsStore", "mottoStyle"),
                        t = e
                            ? e.value
                            : {
                                color: "#8a8a8e",
                                blurEnabled: !1,
                            };
                    (Ku(t.color),
                        Zu(t.blurEnabled),
                        (io.value = t.color),
                        (ro.value = t.color),
                        (lo.checked = t.blurEnabled));
                })(),
                await t(20),
                await (async function () {
                    const e = await Kl.loadData("settingsStore", "appNameStyle"),
                        t = {
                            color: "#111111",
                            blurEnabled: !1,
                        },
                        n = e ? e.value : t,
                        a = /^#[0-9A-Fa-f]{6}$/.test(n.color) ? n.color : t.color;
                    (Qu(a),
                        em(n.blurEnabled),
                        (co.value = a),
                        (uo.value = a),
                        (mo.checked = n.blurEnabled));
                })(),
                await t(20),
                await mu(),
                tc(),
                window.TimerManager.setInterval(tc, 3e4, "main-clock"),
                console.log("App initialization completed in Super Turtle Mode üê¢."));
            const n = async () => {
                try {
                    await nu();
                    const e = await Kl.loadMultipleData("settingsStore", [
                        "appliedFontUrl",
                        "customFont",
                    ]);
                    (e.appliedFontUrl?.value
                        ? $m(e.appliedFontUrl.value)
                        : e.customFont?.value && Md(e.customFont.value),
                        await Lp(),
                        await (async function () {
                            if (!(await Kl.loadData("settingsStore", "unlockCodes"))) {
                                const e = {};
                                ([
                                    "QIQI-LOVE-U-01",
                                    "SLACK-OFF-KING",
                                    "GAME-MASTER-77",
                                    "CODE-BREAKER-X",
                                    "LUCKY-STAR-2024",
                                    "FREEDOM-PASS-A",
                                    "GET-RICH-QUICK",
                                    "DEBT-CLEANER-PRO",
                                    "QIQI-BANK-VIP",
                                    "THE-ONLY-WAY",
                                    "RESET-MY-LIFE",
                                    "GOLDEN-TICKET-7",
                                    "PHOENIX-DOWN-GG",
                                    "ULTIMATE-CODE",
                                    "SECRET-HANDSHAKE",
                                    "BACK-TO-ZERO-00",
                                    "GAME-CHANGER-25",
                                    "MASTER-KEY-007",
                                    "NEW-BEGINNING",
                                    "LAST-CHANCE-OK",
                                ].forEach((t) => {
                                    e[t] = 5;
                                }),
                                    await Kl.saveData("settingsStore", "unlockCodes", e),
                                    console.log("Ëß£ÈîÅÁ†ÅÂ∑≤ÂàùÂßãÂåñ„ÄÇ"));
                            }
                        })(),
                        window.shopCeramic &&
                        (await window.shopCeramic.loadCartFromDB(),
                            await window.shopCeramic.loadOrdersFromDB()),
                        await cc(),
                        await eu(),
                        console.log("[Âª∂ËøüÂä†ËΩΩ] ÊâÄÊúâÊ¨°Ë¶Å‰ªªÂä°ÂÆåÊàê"));
                } catch (e) {
                    console.warn("[Âª∂ËøüÂä†ËΩΩ] ÈÉ®ÂàÜ‰ªªÂä°Â§±Ë¥•:", e);
                }
            };
            // ÂàÜÊï£ÂêÑ‰ªªÂä°Âà∞‰∏çÂêåÁöÑÁ©∫Èó≤Êó∂Èó¥ÔºåÈÅøÂÖçÂêåÊó∂Â§ßÈáèÂä†ËΩΩ
            if ("requestIdleCallback" in window) {
                let taskDelay = 0;
                [
                    "loadCustomIcons",
                    "loadFonts",
                    "loadPlaylists",
                    "loadEmojis",
                ].forEach((taskName) => {
                    requestIdleCallback(() => n(), { timeout: 5e3 + taskDelay });
                    taskDelay += 1500;
                });
            } else {
                // ÈôçÁ∫ßÊñπÊ°àÔºöÂàÜÊâπ setTimeout
                let delay = 1e3;
                [
                    "loadCustomIcons",
                    "loadFonts",
                    "loadPlaylists",
                    "loadEmojis",
                ].forEach(() => {
                    setTimeout(n, delay);
                    delay += 1500;
                });
            }
        } catch (e) {
            (console.error("Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•:", e),
                alert(
                    `\nËØ∑Êà™ÂõæÂèëÁªô‰ΩúËÄÖÔºö\n\nÈîôËØØ‰ø°ÊÅØ: ${e.message}\n\nÈîôËØØ‰ΩçÁΩÆ: ${e.stack ? e.stack.split("\n")[1] : "Êú™Áü•"}`,
                ));
        }
    })();
    if (eo) {
        eo.addEventListener("click", () =>
            Ii.classList.add("show-motto-settings")
        );
    }
    if (no) {
        no.addEventListener("click", () =>
            Ii.classList.remove("show-motto-settings")
        );
    }
    if (to) {
        to.addEventListener("click", () =>
            Ii.classList.add("show-appname-settings")
        );
    }
    if (ao) {
        ao.addEventListener("click", () =>
            Ii.classList.remove("show-appname-settings")
        );
    }
    if (io) {
        io.addEventListener("input", () => {
            const e = io.value;
            (ro && (ro.value = e), Ku(e), Xu());
        });
    }
    if (ro) {
        ro.addEventListener("input", () => {
            const e = ro.value;
            (io && (io.value = e), Ku(e), Xu());
        });
    }
    if (lo) {
        lo.addEventListener("change", () => {
            (Zu(lo.checked), Xu());
        });
    }
    if (Jr) {
        Jr.addEventListener("blur", async () => {
            const e = Jr.textContent.trim();
            e && (await Kl.saveData("settingsStore", "savedMotto", e));
        });
    }
    if (co) {
        co.addEventListener("input", () => {
            const e = co.value;
            (uo && (uo.value = e), Qu(e), tm());
        });
    }
    if (uo) {
        uo.addEventListener("input", () => {
            const e = uo.value;
            (co && (co.value = e), Qu(e), tm());
        });
    }
    if (mo) {
        mo.addEventListener("change", () => {
            (em(mo.checked), tm());
        });
    }
    const ac = document.getElementById("toggle-proactive-messaging");
    (ac &&
        ac.addEventListener("change", async () => {
            const e = ac.checked;
            (await Kl.saveData("settingsStore", "proactiveMessagingEnabled", e),
                alert("AI ‰∏ªÂä®Ê∂àÊÅØÂäüËÉΩÂ∑≤" + (e ? "ÂºÄÂêØ" : "ÂÖ≥Èó≠")));
        }),
        hn.addEventListener("click", () => {
            ((wn.value = ""),
                (vn.style.display = "flex"),
                setTimeout(() => {
                    ((vn.style.opacity = "1"),
                        (vn.querySelector(".modal-content").style.transform = "scale(1)"));
                }, 10),
                id());
        }),
        fn.addEventListener("click", wc),
        bn.addEventListener("click", () => {
            const e = wn.value.trim();
            if (!e) return void alert("ÊñáÂ≠óÊèèËø∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            (Dc({
                type: "text-image",
                text: e,
            }),
                wc());
        }),
        Xs.addEventListener("click", () => {
            Ii.classList.add("show-shop");
        }),
        Qs.addEventListener("click", () => {
            (window.DOMCleanupManager.cleanMultiple([
                "product-grid",
                "cart-items-container",
                "orders-list-container",
                "recipient-list-container",
            ]),
                void 0 !== ei && (ei = null),
                void 0 !== Js && (Js = []),
                void 0 !== Ys && (Ys = null),
                Ii.classList.remove("show-shop"));
        }),
        Li.addEventListener("click", () => {
            Ii.classList.add("show-settings");
        }),
        ci.addEventListener("click", () => {
            Ii.classList.add("show-clock-settings");
        }),
        di.addEventListener("click", () => {
            Ii.classList.remove("show-clock-settings");
        }),
        hi.addEventListener("click", () => {
            (Ii.classList.add("show-icon-settings"),
                (async function () {
                    const e = document.getElementById("icon-list-container");
                    if (!e) return;
                    const t = document.querySelectorAll(
                        "#home-screen .app-container[id]",
                    ),
                        n = await Kl.loadData("settingsStore", "customAppIcons"),
                        a = n && n.value ? n.value : {};
                    ((e.innerHTML = ""),
                        t.forEach((t) => {
                            const n = t.id,
                                o = t.querySelector(".app-name").textContent,
                                s = `\n            <div class="icon-setting-item">\n                <img src="${t.querySelector(".app-icon img").src}" class="icon-preview" data-app-id="${n}">\n                <div class="icon-details">\n                    <span class="app-name-setting">${o}</span>\n                    <input type="text" class="icon-url-input" placeholder="ËæìÂÖ•Êñ∞ÁöÑÂõæÊ†áURL" value="${a[n] || ""}" data-app-id="${n}">\n                </div>\n            </div>\n        `;
                            e.innerHTML += s;
                        }));
                })());
        }),
        vi.addEventListener("click", () => {
            Ii.classList.remove("show-icon-settings");
        }),
        gi.addEventListener("click", () => {
            Ii.classList.add("show-beautify");
        }),
        yi.addEventListener("click", () => {
            Ii.classList.remove("show-beautify");
        }));
    const oc = document.getElementById("settings-back-btn");

    function sc() {
        const e = parseFloat(jr.value),
            t = (e / 2) * 100;
        (jr.style.setProperty("--progress-percent", `${t}%`),
            (Ur.textContent = e.toFixed(1)));
    }

    function ic() {
        ((Zo.style.opacity = "0"),
            (Zo.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((Zo.style.display = "none"),
                    (as = !1),
                    (ns.textContent = "Âà†Èô§ÊâÄÈÄâ"),
                    ns.classList.remove("danger-button"),
                    ns.classList.add("form-button-secondary"));
            }, 300));
    }
    async function rc() {
        ((Qo.innerHTML =
            '<p style="text-align:center; color:#888; padding: 15px;">Ê≠£Âú®Âä†ËΩΩ API Â∫ì...</p>'),
            (as = !1));
        try {
            const e = await Kl.loadData("settingsStore", "apiLibrary"),
                t = e && Array.isArray(e.value) ? e.value : [];
            if (0 === t.length)
                return void (Qo.innerHTML =
                    '<p style="text-align:center; color:#888; padding: 15px;">API Â∫ì‰∏≠ÊöÇÊó†ÈÖçÁΩÆ</p>');
            ((Qo.innerHTML = ""),
                t.forEach((e) => {
                    const t = document.createElement("div");
                    ((t.className = "api-library-item"),
                        (t.dataset.configId = e.id),
                        (t.dataset.config = JSON.stringify(e)));
                    const n = new Date(e.lastUsed).toLocaleDateString("zh-CN", {
                        month: "2-digit",
                        day: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit",
                    });
                    ((t.innerHTML = `\n                <div class="api-info">\n                    <div class="api-name">${e.name}</div>\n                    <div class="api-details">${e.url} | ${e.model} | Ê∏©Â∫¶: ${e.temperature} | ÊúÄÂêé‰ΩøÁî®: ${n}</div>\n                </div>\n                <input type="checkbox" class="api-select-checkbox" style="display: none;">\n            `),
                        Qo.appendChild(t));
                }));
        } catch (e) {
            (console.error("Ê∏≤Êüì API Â∫ìÂ§±Ë¥•:", e),
                (Qo.innerHTML =
                    '<p style="text-align:center; color:red; padding: 15px;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ</p>'));
        }
    }

    function lc(e, t) {
        const n = document.createElement("div");
        ((n.className = "playlist-card"),
            (n.dataset.playlistName = e),
            (n.innerHTML =
                '\n        <input type="checkbox" class="playlist-checkbox">\n        <div class="playlist-cover"></div>\n        <div class="playlist-name"></div>\n        <div class="playlist-count"></div>\n    '));
        const a = n.querySelector(".playlist-cover");
        (t && t.coverUrl && (a.style.backgroundImage = `url(${t.coverUrl})`),
            (n.querySelector(".playlist-name").textContent = e));
        const o = t && Array.isArray(t.songs) ? t.songs.length : 0;
        ((n.querySelector(".playlist-count").textContent = `${o} È¶ñÊ≠åÊõ≤`),
            il.appendChild(n),
            n.addEventListener("click", (t) => {
                if ($i && "checkbox" !== t.target.type) {
                    const e = n.querySelector(".playlist-checkbox");
                    e.checked = !e.checked;
                } else $i || mc(e);
            }));
    }
    async function cc() {
        const e = await Kl.loadData("musicPlaylists", "allPlaylists");
        if (e && "object" == typeof e.value) {
            const t = e.value;
            ((il.innerHTML = ""),
                Object.keys(t).forEach((e) => {
                    lc(e, t[e]);
                }));
        }
    }
    (oc &&
        oc.addEventListener("click", () => {
            Ii.classList.remove("show-settings");
        }),
        Ko.addEventListener("keydown", (e) => {
            if ("Enter" === e.key) {
                e.preventDefault();
                const t = Ko.value.trim();
                (t && (Dc(t), (Ko.value = "")), Ko.focus());
            }
        }),
        Lo.addEventListener("click", () => {
            !(async function () {
                if (0 === Po.querySelectorAll(".contact-checkbox:checked").length)
                    return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÁßªÂä®ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
                const e = await Kl.loadData("worldBookGroups", "allGroups"),
                    t = (e && Array.isArray(e.value) ? e.value : []).filter(
                        (e) => e.id !== Uo,
                    );
                ((Go.innerHTML = ""),
                    t.length > 0
                        ? t.forEach((e) => {
                            const t = document.createElement("div");
                            ((t.className = "group-selection-item"),
                                (t.dataset.groupId = e.id),
                                (t.textContent = e.name),
                                Go.appendChild(t));
                        })
                        : (Go.innerHTML =
                            '<p style="text-align:center; color:#888;">Ê≤°ÊúâÂÖ∂‰ªñÂèØÁßªÂä®ÁöÑÂàÜÁªÑ</p>'));
                ((Fo.style.display = "flex"),
                    setTimeout(() => (Fo.style.opacity = "1"), 10));
            })();
        }),
        Rr.addEventListener("click", async () => {
            const e = _r.value.trim(),
                t = Fr.value.trim(),
                n = document.getElementById("api-status-icon-container");
            if (e && t) {
                ((Rr.textContent = "connecting..."),
                    (Rr.disabled = !0),
                    Gr && (Gr.textContent = ""),
                    n &&
                    ((n.className =
                        "w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-black/5 text-black/40"),
                        n.classList.add("animate-pulse")));
                try {
                    let a = e;
                    a.endsWith("/") && (a = a.slice(0, -1));
                    let o = [];
                    (o.push(a + "/models"),
                        a.includes("/v1") ||
                        a.includes("openai.azure.com") ||
                        o.push(a + "/v1/models"),
                        a.includes("generativelanguage.googleapis.com") &&
                        !a.includes("openai") &&
                        o.push(a + "/v1beta/models"),
                        console.log("ÊµãËØïËøûÊé•ÔºåÂÄôÈÄâÂú∞ÂùÄ:", o));
                    let s = null,
                        i = null,
                        r = null;
                    for (let e of o)
                        try {
                            let n = await fetch(e, {
                                headers: {
                                    Authorization: `Bearer ${t}`,
                                },
                            });
                            if (n.ok) {
                                ((s = n),
                                    (i = await n.json()),
                                    console.log("ËøûÊé•ÊàêÂäüÔºå‰ΩøÁî®Âú∞ÂùÄ:", e));
                                break;
                            }
                            r = new Error(`HTTP Error: ${n.status}`);
                        } catch (t) {
                            (console.warn("Â∞ùËØïÂú∞ÂùÄÂ§±Ë¥•:", e, t), (r = t));
                        }
                    if (!s || !i) throw r || new Error("ÊâÄÊúâË∑ØÂæÑÂ∞ùËØïÂùáÂ§±Ë¥•");
                    let l = [];
                    (Array.isArray(i.data)
                        ? (l = i.data.map((e) => e.id))
                        : Array.isArray(i.models)
                            ? (l = i.models.map((e) => e.name.replace("models/", "")))
                            : Array.isArray(i) && (l = i.map((e) => e.id)),
                        0 === l.length && console.warn("ËøûÊé•ÊàêÂäü‰ΩÜÊú™ÊâæÂà∞Ê®°Âûã:", i),
                        (Wr.innerHTML =
                            '<option value="" disabled selected>ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã</option>'),
                        l.sort().forEach((e) => {
                            Wr.innerHTML += `<option value="${e}">${e}</option>`;
                        }),
                        (Wr.disabled = !1),
                        (Gr.textContent = "‚úì ËøûÊé•ÊàêÂäü"),
                        (Gr.style.color = "green"),
                        n &&
                        ((n.className =
                            "w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-[#34C759]/10 text-[#34C759]"),
                            n.classList.remove("animate-pulse")));
                } catch (e) {
                    if (
                        (console.error("API ËøûÊé•Â§±Ë¥•:", e),
                            e instanceof TypeError && e.message.includes("Failed to fetch"))
                    )
                        ((Gr.textContent = "‚úó ÁΩëÁªúÈîôËØØÊàñË∑®ÂüüÈóÆÈ¢ò"),
                            (Gr.style.color = "red"),
                            alert(
                                "ËøûÊé•Â§±Ë¥•ÔºÅÂª∫ËÆÆÔºö\n1. Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°Æ (Â¶Ç Zeabur Âèç‰ª£ÂèØËÉΩÈúÄË¶Å /v1)\n2. Ê£ÄÊü•ÁΩëÁªú/VPN",
                            ));
                    else if (e.message.startsWith("HTTP Error:")) {
                        const t = e.message.split(":")[1].trim();
                        ((Gr.textContent =
                            "401" === t
                                ? "‚úó Key ÈîôËØØ (401)"
                                : "404" === t
                                    ? "‚úó URL ÈîôËØØ (404)"
                                    : `‚úó ÊúçÂä°ÈîôËØØ (${t})`),
                            (Gr.style.color = "red"));
                    } else ((Gr.textContent = "‚úó Êú™Áü•ÈîôËØØ"), (Gr.style.color = "red"));
                    (n &&
                        ((n.className =
                            "w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-[#FF3B30]/10 text-[#FF3B30]"),
                            n.classList.remove("animate-pulse")),
                        (Wr.innerHTML =
                            '<option value="" disabled selected>ËøûÊé•Â§±Ë¥•</option>'));
                } finally {
                    ((Rr.textContent = "Test connection"), (Rr.disabled = !1));
                }
            } else Gr && (Gr.textContent = "URLÂíåKey‰∏çËÉΩ‰∏∫Á©∫");
        }),
        jr.addEventListener("input", sc),
        es.addEventListener("click", async () => {
            const e = prompt("ËØ∑ËæìÂÖ•Ê≠§ API ÈÖçÁΩÆÁöÑÂêçÁß∞ (‰æãÂ¶Ç: GPT-4o ‰∏ìÂ±ûÈÖçÁΩÆ)");
            if (!e || "" === e.trim()) return void alert("ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            const t = {
                id: Date.now(),
                name: e.trim(),
                url: _r.value.trim(),
                key: Fr.value.trim(),
                model: Wr.value,
                temperature: parseFloat(jr.value) || 1,
                lastUsed: new Date().toISOString(),
            };
            try {
                const e = await Kl.loadData("settingsStore", "apiLibrary");
                let n = e && Array.isArray(e.value) ? e.value : [];
                (n.unshift(t),
                    await Kl.saveData("settingsStore", "apiLibrary", n),
                    alert(`ÈÖçÁΩÆ "${t.name}" Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞Â∫ìÔºÅ`));
            } catch (e) {
                (console.error("‰øùÂ≠ò API ÈÖçÁΩÆÂ§±Ë¥•:", e),
                    alert("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÂ∫ì„ÄÇ"));
            }
        }),
        ts.addEventListener("click", () => {
            (rc(),
                (Zo.style.display = "flex"),
                setTimeout(() => {
                    ((Zo.style.opacity = "1"),
                        (Zo.querySelector(".modal-content").style.transform = "scale(1)"));
                }, 10));
        }),
        Xo.addEventListener("click", () => {
            ic();
        }),
        Zo.addEventListener("click", (e) => {
            e.target === Zo && ic();
        }),
        Qo.addEventListener("click", async (e) => {
            const t = e.target.closest(".api-library-item");
            if (!t) return;
            const n = t.querySelector(".api-select-checkbox");
            if (as)
                (e.target !== n && (n.checked = !n.checked),
                    t.classList.toggle("selected", n.checked));
            else {
                const e = JSON.parse(t.dataset.config);
                ((_r.value = e.url),
                    (Fr.value = e.key),
                    Wr.querySelector(`option[value="${e.model}"]`) ||
                    (Wr.innerHTML += `<option value="${e.model}">${e.model}</option>`),
                    (Wr.value = e.model),
                    (Wr.disabled = !1),
                    (jr.value = e.temperature),
                    sc(),
                    (e.lastUsed = new Date().toISOString()));
                let n = (await Kl.loadData("settingsStore", "apiLibrary")).value;
                const a = n.findIndex((t) => t.id === e.id);
                (-1 !== a &&
                    ((n[a] = e), await Kl.saveData("settingsStore", "apiLibrary", n)),
                    ic(),
                    alert(`API ÈÖçÁΩÆ "${e.name}" Â∑≤ÊàêÂäüÂ∫îÁî®ÔºÅ`));
            }
        }),
        ns.addEventListener("click", async () => {
            if (as) {
                const e = Qo.querySelectorAll(".api-select-checkbox:checked");
                if (0 === e.length)
                    return (
                        (as = !1),
                        (ns.textContent = "Âà†Èô§ÊâÄÈÄâ"),
                        ns.classList.remove("danger-button"),
                        ns.classList.add("form-button-secondary"),
                        void Qo.querySelectorAll(".api-select-checkbox").forEach((e) => {
                            e.style.display = "none";
                        })
                    );
                if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™ API ÈÖçÁΩÆÂêóÔºü`)) return;
                const t = new Set();
                e.forEach((e) => {
                    const n = e.closest(".api-library-item");
                    t.add(parseInt(n.dataset.configId, 10));
                });
                try {
                    const e = (
                        await Kl.loadData("settingsStore", "apiLibrary")
                    ).value.filter((e) => !t.has(e.id));
                    (await Kl.saveData("settingsStore", "apiLibrary", e),
                        await rc(),
                        alert("Âà†Èô§ÊàêÂäüÔºÅ"),
                        (as = !1),
                        (ns.textContent = "Âà†Èô§ÊâÄÈÄâ"),
                        ns.classList.remove("danger-button"),
                        ns.classList.add("form-button-secondary"),
                        Qo.querySelectorAll(".api-select-checkbox").forEach((e) => {
                            e.style.display = "none";
                        }));
                } catch (e) {
                    (console.error("Âà†Èô§Â§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ"));
                }
            } else
                ((as = !0),
                    (ns.textContent = "Âà†Èô§ÊâÄÈÄâ"),
                    ns.classList.remove("form-button-secondary"),
                    ns.classList.add("danger-button"),
                    Qo.querySelectorAll(".api-select-checkbox").forEach((e) => {
                        ((e.style.display = "block"), (e.checked = !1));
                    }));
        }),
        Ei.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            if (t) {
                e.target.value = "";
                try {
                    let e;
                    if (
                        window.iOSBabyMode &&
                        window.iOSBabyMode.enabled &&
                        t.size > 2097152
                    ) {
                        window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜÂ£ÅÁ∫∏...", 0);
                        ((e = `url(${await window.iOSBabyMode.safeCompressImage(t, {
                            maxWidth: 1920,
                            maxHeight: 1920,
                            quality: 0.8,
                            onProgress: (e) => {
                                window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜÂ£ÅÁ∫∏...", e);
                            },
                        })})`),
                            window.iOSBabyMode.hideProgressToast());
                    } else if (window.iOSBabyMode) {
                        e = `url(${await window.iOSBabyMode.safeReadFileAsDataURL(t)})`;
                    } else
                        e = await new Promise((e, n) => {
                            const a = new FileReader();
                            ((a.onload = (t) => e(`url(${t.target.result})`)),
                                (a.onerror = n),
                                a.readAsDataURL(t));
                        });
                    ki.style.backgroundImage = e;
                    const n =
                        document.getElementById("settings-wallpaper-preview-bg") || Yr;
                    (n && (n.style.backgroundImage = e),
                        window.iOSBabyMode &&
                        window.iOSBabyMode.enabled &&
                        (await new Promise((e) => setTimeout(e, 50))),
                        await Kl.saveData("settingsStore", "homeWallpaper", e));
                } catch (e) {
                    (console.error("Â£ÅÁ∫∏ËÆæÁΩÆÂ§±Ë¥•:", e),
                        window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                        alert(`‚ùå Â£ÅÁ∫∏ËÆæÁΩÆÂ§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`));
                }
            }
        }),
        br.addEventListener("click", () => {
            (Ii.classList.add("show-worldbook"), zu());
        }),
        Er.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("worldbook-list"),
                Ii.classList.remove("show-worldbook"));
        }),
        Mi.addEventListener("click", () => {
            (Ii.classList.add("show-messages"),
                on &&
                sn.length > 0 &&
                (sn.forEach((e) => {
                    e.dataset.type === Kt
                        ? e.classList.add("active")
                        : e.classList.remove("active");
                }),
                    "group" === Kt
                        ? on.classList.add("group-mode")
                        : on.classList.remove("group-mode")),
                0 === Ni.children.length
                    ? (console.log(
                        "[DEBUG] Messages app opened, list is empty, rendering...",
                    ),
                        Dm())
                    : console.log(
                        "[DEBUG] Messages app opened, list already populated, skipping render",
                    ));
        }),
        Ti.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("contact-list"),
                (Ye = null),
                window.TimerManager.clear("proactive"),
                Ii.classList.remove("show-messages"));
        }),
        Bi.addEventListener("click", () => {
            Ii.classList.add("show-music");
        }),
        Si.addEventListener("click", () => {
            Ii.classList.remove("show-music");
        }));
    let dc = !1,
        uc = null;
    async function mc(e) {
        ((uc = e), (ll.textContent = e), (ul.innerHTML = ""));
        const t = await Kl.loadData("musicPlaylists", "allPlaylists");
        if (t && t.value && t.value[e] && Array.isArray(t.value[e].songs)) {
            t.value[e].songs.forEach((e) => {
                pc(e);
            });
        } else console.warn(`Ê≠åÂçï "${e}" ÁöÑÊ≠åÊõ≤Êï∞ÊçÆ‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÊï∞ÁªÑÔºåÊàñËÄÖ‰∏∫Á©∫„ÄÇ`);
        Ii.classList.add("show-playlist-detail");
    }

    function pc(e) {
        const t = document.createElement("li");
        t.className = "song-item";
        const n = e.file ? `${e.file.name}-${e.file.lastModified}` : e.url;
        ((t.dataset.songId = n),
            (t.innerHTML = `\n        <input type="checkbox" class="song-checkbox">\n        <div class="song-info">\n            <div class="song-title">${e.title || "Êú™Áü•Ê≠åÊõ≤"}</div>\n            <div class="song-artist">${e.artist || "Êú™Áü•Ëâ∫ÊúØÂÆ∂"}</div>\n        </div>\n        <button class="play-button">\n            <svg viewBox="0 0 100 100">\n                <circle cx="50" cy="50" r="48" stroke="#ccc" stroke-width="4" fill="none"/>\n                <polygon points="35,25 75,50 35,75" fill="#555"/>\n            </svg>\n        </button>\n    `),
            ul.appendChild(t));
        const a = t.querySelector(".play-button");
        e.file
            ? a.addEventListener("click", async (t) => {
                t.stopPropagation();
                try {
                    const t = await Kl.loadData("musicPlaylists", "allPlaylists");
                    if (!t || !t.value) throw new Error("Êó†Ê≥ïÂä†ËΩΩÊí≠ÊîæÂàóË°®Êï∞ÊçÆ„ÄÇ");
                    const n = t.value[uc].songs,
                        a = n.findIndex(
                            (t) =>
                                t.file &&
                                t.file.name === e.file.name &&
                                t.file.lastModified === e.file.lastModified,
                        );
                    if (!(a > -1)) throw new Error("Âú®Êí≠ÊîæÂàóË°®‰∏≠Êâæ‰∏çÂà∞ÂΩìÂâçÊ≠åÊõ≤„ÄÇ");
                    hc(n, a);
                } catch (e) {
                    (console.error("Êí≠ÊîæÊó∂Âá∫Èîô:", e), alert("Êí≠ÊîæÊ≠åÊõ≤Êó∂Âá∫Èîô„ÄÇ"));
                }
            })
            : ((a.disabled = !0),
                (a.style.opacity = 0.3),
                (a.style.cursor = "not-allowed"));
    }

    function gc(e) {
        const t = document.getElementById("collapsed-song-title"),
            n = t.parentElement;
        (t.classList.remove("scrolling"),
            (t.textContent = "Ê≠£Âú®Êí≠ÊîæÔºö" + e),
            setTimeout(() => {
                t.scrollWidth > n.clientWidth && t.classList.add("scrolling");
            }, 100));
    }
    (rl.addEventListener("click", () => {
        (Ii.classList.remove("show-playlist-detail"), (uc = null));
    }),
        cl.addEventListener("click", () => {
            dc
                ? (async function () {
                    const e = ul.querySelectorAll(".song-checkbox:checked");
                    if (0 === e.length)
                        return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈ¶ñË¶ÅÂà†Èô§ÁöÑÊ≠åÊõ≤„ÄÇ");
                    if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÊ≠åÂçï‰∏≠ÁßªÈô§Ëøô ${e.length} È¶ñÊ≠åÊõ≤ÂêóÔºü`)) return;
                    const t = new Set();
                    e.forEach((e) => {
                        const n = e.closest(".song-item");
                        n && n.dataset.songId && t.add(n.dataset.songId);
                    });
                    try {
                        const e = await Kl.loadData("musicPlaylists", "allPlaylists");
                        if (!e || !e.value || !e.value[uc])
                            throw new Error("Êó†Ê≥ïÂä†ËΩΩÂΩìÂâçÊ≠åÂçïÊï∞ÊçÆ");
                        let n = e.value;
                        const a = n[uc].songs.filter((e) => {
                            const n = e.file
                                ? `${e.file.name}-${e.file.lastModified}`
                                : e.url;
                            return !t.has(n);
                        });
                        ((n[uc].songs = a),
                            await Kl.saveData("musicPlaylists", "allPlaylists", n),
                            alert("Âà†Èô§ÊàêÂäüÔºÅ"),
                            await mc(uc),
                            pl.click());
                    } catch (e) {
                        (console.error("Âà†Èô§Ê≠åÊõ≤Â§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ"));
                    }
                })()
                : dl.click();
        }),
        dl.addEventListener("change", async (e) => {
            const t = e.target.files;
            if (t.length && uc)
                try {
                    let e = (await Kl.loadData("musicPlaylists", "allPlaylists")).value;
                    for (const n of t) {
                        let t = n.name.replace(/\.(mp3|wav|flac)$/i, ""),
                            a = "Êú™Áü•Ëâ∫ÊúØÂÆ∂";
                        /\s*-\s*/.test(t) &&
                            ([t, a] = t.split(/\s*-\s*/).map((e) => e.trim()));
                        const o = {
                            title: t,
                            artist: a,
                            file: n,
                        };
                        (e[uc].songs.push(o), pc(o));
                    }
                    const n = il.querySelector(
                        `.playlist-card[data-playlist-name="${uc}"]`,
                    );
                    if (n) {
                        n.querySelector(".playlist-count").textContent =
                            `${e[uc].songs.length} È¶ñÊ≠åÊõ≤`;
                    }
                    await Kl.saveData("musicPlaylists", "allPlaylists", e);
                } catch (e) {
                    console.error("ÂØºÂÖ•Ê≠åÊõ≤Â§±Ë¥•:", e);
                } finally {
                    e.target.value = "";
                }
        }),
        ml.addEventListener("click", () => {
            dc
                ? (async function () {
                    const e = ul.querySelectorAll(".song-checkbox:checked");
                    if (0 === e.length) return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈ¶ñÊ≠åÊõ≤„ÄÇ");
                    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} È¶ñÊ≠åÊõ≤ÂêóÔºü`)) return;
                    const t = new Set();
                    e.forEach((e) => {
                        const n = e.closest(".song-item");
                        t.add(n.dataset.songId);
                    });
                    try {
                        const e = await Kl.loadData("musicPlaylists", "allPlaylists");
                        if (!e || !e.value || !e.value[uc])
                            return void alert("Êó†Ê≥ïÂä†ËΩΩÊ≠åÂçïÊï∞ÊçÆÔºåÂà†Èô§Â§±Ë¥•ÔºÅ");
                        let n = e.value;
                        if (!Array.isArray(n[uc].songs))
                            return void alert("Ê≠åÂçïÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÊó†Ê≥ïÂà†Èô§Ê≠åÊõ≤ÔºÅ");
                        const a = n[uc].songs;
                        ((n[uc].songs = a.filter((e) => {
                            let n;
                            if (e.file) n = `${e.file.name}-${e.file.lastModified}`;
                            else {
                                if (!e.url) return !0;
                                n = e.url;
                            }
                            return !t.has(n);
                        })),
                            await Kl.saveData("musicPlaylists", "allPlaylists", n),
                            await mc(uc),
                            pl.click());
                        const o = il.querySelector(
                            `.playlist-card[data-playlist-name="${uc}"]`,
                        );
                        if (o) {
                            o.querySelector(".playlist-count").textContent =
                                `${n[uc].songs.length} È¶ñÊ≠åÊõ≤`;
                        }
                    } catch (e) {
                        console.error("Âà†Èô§Ê≠åÊõ≤Â§±Ë¥•:", e);
                    }
                })()
                : gl.click();
        }),
        gl.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            if (!t || !uc) return;
            const n = new FileReader();
            ((n.onload = async (e) => {
                const t = e.target.result;
                try {
                    const e = await Kl.loadData("musicPlaylists", "allPlaylists");
                    let n = e && e.value ? e.value : {};
                    if (!n[uc] || Array.isArray(n[uc])) {
                        console.log(`Ê≠£Âú®ÂçáÁ∫ßÊóßÊ†ºÂºèÊ≠åÂçï: "${uc}"`);
                        const e = Array.isArray(n[uc]) ? n[uc] : [];
                        n[uc] = {
                            songs: e,
                            coverUrl: null,
                        };
                    }
                    ((n[uc].coverUrl = t),
                        await Kl.saveData("musicPlaylists", "allPlaylists", n));
                    const a = il.querySelector(
                        `.playlist-card[data-playlist-name="${uc}"]`,
                    );
                    if (a) {
                        a.querySelector(".playlist-cover").style.backgroundImage =
                            `url(${t})`;
                    }
                    alert("Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ÔºÅ");
                } catch (e) {
                    (console.error("Êõ¥Êñ∞Â∞ÅÈù¢Â§±Ë¥•:", e), alert("Êõ¥Êñ∞Â∞ÅÈù¢Â§±Ë¥•„ÄÇ"));
                }
            }),
                n.readAsDataURL(t),
                (e.target.value = ""));
        }),
        pl.addEventListener("click", () => {
            ((dc = !dc), ul.classList.toggle("delete-mode", dc));
            const e = document.getElementById("import-music-button");
            dc
                ? ((pl.style.color = "#007AFF"),
                    (e.textContent = "Âà†Èô§ÊâÄÈÄâÊ≠åÊõ≤"),
                    (e.style.backgroundColor = "rgba(255, 59, 48, 0.15)"),
                    (e.style.color = "#FF3B30"),
                    (e.style.borderColor = "rgba(255, 59, 48, 0.3)"))
                : ((pl.style.color = ""),
                    (e.textContent = "ÂØºÂÖ•Ê≠åÊõ≤"),
                    (e.style.backgroundColor = ""),
                    (e.style.color = ""),
                    (e.style.borderColor = ""),
                    ul
                        .querySelectorAll(".song-checkbox")
                        .forEach((e) => (e.checked = !1)));
        }));
    let yc = null;
    async function hc(e, t) {
        if (
            !(!e || t < 0 || t >= e.length) &&
            ((ec.playlist = e),
                (ec.currentIndex = t),
                (ec.currentSong = e[t]),
                (Zr.textContent = ec.currentSong.title),
                (Xr.textContent = ec.currentSong.artist),
                gc(ec.currentSong.title),
                yc && (URL.revokeObjectURL(yc), (yc = null)),
                (yc = URL.createObjectURL(ec.currentSong.file)),
                (bi.src = yc),
                bi.play().catch((e) => console.error("Êí≠ÊîæÂ§±Ë¥•:", e)),
                zd.active && zd.contact)
        ) {
            const e = `Ê≠£Âú®Êí≠Êîæ: ${ec.currentSong.title} - ${ec.currentSong.artist}`;
            await Xd(e, zd.contact.id);
        }
    }

    function vc(e) {
        return `${Math.floor(e / 60)}:${Math.floor(e % 60)
            .toString()
            .padStart(2, "0")}`;
    }

    function fc() {
        ((Ai.style.opacity = "0"),
            (Ai.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((Ai.style.display = "none"), Ru());
            }, 300));
    }

    function wc() {
        ((vn.style.opacity = "0"),
            (vn.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                vn.style.display = "none";
            }, 300));
    }

    function bc(n) {
        if (
            (n
                ? wr.classList.add("fullscreen-mode")
                : wr.classList.remove("fullscreen-mode"),
                e && t)
        ) {
            const e = localStorage.getItem(o);
            e &&
                setTimeout(() => {
                    window.applyIOSSafeAreaMargin(parseInt(e));
                }, 50);
        }
    }
    async function Ec(e, t) {
        const n = e.files[0];
        if (n) {
            e.value = "";
            try {
                let e;
                ((e =
                    window.iOSBabyMode && window.iOSBabyMode.enabled && n.size > 512e3
                        ? await window.iOSBabyMode.safeCompressImage(n, {
                            maxWidth: 400,
                            maxHeight: 400,
                            quality: 0.8,
                        })
                        : window.iOSBabyMode
                            ? await window.iOSBabyMode.safeReadFileAsDataURL(n)
                            : await new Promise((e, t) => {
                                const a = new FileReader();
                                ((a.onload = (t) => e(t.target.result)),
                                    (a.onerror = t),
                                    a.readAsDataURL(n));
                            })),
                    (t.src = e));
            } catch (e) {
                (console.error("Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•:", e),
                    alert(`‚ùå Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`));
            }
        }
    }
    async function Ic(e) {
        const t = document.createElement("li");
        ((t.className = "contact-item"),
            e.isPinned && (t.classList.add("pinned"), (t.dataset.pinned = "true")),
            (t.dataset.contactId = e.id));
        let n,
            a = e.ai.avatar;
        if (
            (e.ai._hasBase64Avatar &&
                (a =
                    'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%23e0e0e0"/%3E%3C/svg%3E'),
                (t.innerHTML = `\n            <input type="checkbox" class="contact-checkbox">\n            <img src="${a}" alt="avatar" class="contact-avatar" data-contact-id="${e.id}">\n            <div class="contact-info">\n                <div class="contact-name">${e.ai.name}</div>\n                <div class="contact-last-message">${e.lastMessage}</div>\n            </div>\n        `),
                Ni.appendChild(t),
                e.ai._hasBase64Avatar)
        ) {
            const n = t.querySelector(".contact-avatar"),
                a = new IntersectionObserver(
                    async (t) => {
                        if (t[0].isIntersecting) {
                            a.disconnect();
                            const t = await Kl.loadData("messageContacts", "allContacts");
                            if (t && t.value) {
                                const a = t.value.find((t) => t.id === e.id);
                                a && a.ai && a.ai.avatar && (n.src = a.ai.avatar);
                            }
                        }
                    },
                    {
                        threshold: 0.1,
                    },
                );
            a.observe(n);
        }
        let o,
            s,
            i = !1;
        (t.addEventListener(
            "touchstart",
            (a) => {
                Bc ||
                    ((o = a.touches[0].clientX),
                        (s = a.touches[0].clientY),
                        (i = !1),
                        t.classList.add("pressing"),
                        (n = setTimeout(() => {
                            ((i = !0),
                                navigator.vibrate && navigator.vibrate(50),
                                xc(e),
                                t.classList.remove("pressing"));
                        }, 500)));
            },
            {
                passive: !0,
            },
        ),
            t.addEventListener(
                "touchmove",
                (e) => {
                    if (!n) return;
                    const a = e.touches[0].clientX,
                        i = e.touches[0].clientY;
                    (Math.abs(a - o) > 10 || Math.abs(i - s) > 10) &&
                        (clearTimeout(n), (n = null), t.classList.remove("pressing"));
                },
                {
                    passive: !0,
                },
            ),
            t.addEventListener("touchend", (e) => {
                (n && (clearTimeout(n), (n = null)),
                    t.classList.remove("pressing"),
                    i && e.cancelable && e.preventDefault());
            }),
            t.addEventListener("contextmenu", (t) => {
                (t.preventDefault(), Bc || xc(e));
            }),
            t.addEventListener("click", (t) => {
                i ||
                    t.target.classList.contains("contact-checkbox") ||
                    Bc ||
                    (async function (e) {
                        if (!e) return;
                        (console.log(
                            `[Redirect] redirecting openChat to openChatView for contact ${e.id}`,
                        ),
                            await Nc(e.id));
                    })(e);
            }));
    }

    function xc(e) {
        const t = document.getElementById("contact-action-sheet"),
            n = document.getElementById("action-sheet-pin"),
            a = document.getElementById("action-sheet-delete"),
            o = document.getElementById("action-sheet-cancel");
        t.querySelector(".action-sheet-content");
        ((n.textContent = e.isPinned ? "ÂèñÊ∂àÁΩÆÈ°∂" : "ÁΩÆÈ°∂ÂØπËØù"),
            (t.style.display = "flex"),
            t.offsetHeight,
            t.classList.add("active"));
        const s = n.cloneNode(!0);
        n.parentNode.replaceChild(s, n);
        const i = a.cloneNode(!0);
        a.parentNode.replaceChild(i, a);
        const r = o.cloneNode(!0);
        (o.parentNode.replaceChild(r, o),
            s.addEventListener("click", async () => {
                kc();
                try {
                    const t = await Kl.loadData("messageContacts", "allContacts");
                    if (t && Array.isArray(t.value)) {
                        const n = t.value,
                            a = n.findIndex((t) => t.id === e.id);
                        a > -1 &&
                            ((n[a].isPinned = !e.isPinned),
                                await Kl.saveData("messageContacts", "allContacts", n),
                                await Lc());
                    }
                } catch (e) {
                    console.error("Êõ¥Êñ∞ÁΩÆÈ°∂Â§±Ë¥•", e);
                }
            }),
            i.addEventListener("click", () => {
                (kc(),
                    setTimeout(() => {
                        confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${e.ai.name}" ÁöÑÂØπËØùÂêóÔºü`) &&
                            (async function (e) {
                                try {
                                    const t = await Kl.loadData("messageContacts", "allContacts");
                                    if (t && Array.isArray(t.value)) {
                                        const n = t.value.filter((t) => t.id !== e);
                                        (await Kl.saveData("messageContacts", "allContacts", n),
                                            await Lc());
                                    }
                                } catch (e) {
                                    console.error(e);
                                }
                            })(e.id);
                    }, 300));
            }),
            r.addEventListener("click", () => {
                kc();
            }),
            (t.onclick = (e) => {
                e.target === t && kc();
            }));
    }

    function kc() {
        const e = document.getElementById("contact-action-sheet");
        (e.classList.remove("active"),
            setTimeout(() => {
                e.style.display = "none";
            }, 300));
    }
    async function Lc() {
        const e = await Kl.loadData("messageContacts", "allContacts");
        if (!e || !Array.isArray(e.value)) return;
        const t = e.value;
        ((Ye = []),
            (Ni.innerHTML = ""),
            t.sort((e, t) => {
                const n = e.isPinned ? 1 : 0,
                    a = t.isPinned ? 1 : 0;
                return n !== a ? a - n : 0;
            }));
        const n =
            /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            ("MacIntel" === navigator.platform && navigator.maxTouchPoints > 1),
            a = n ? 10 : 30;
        let o = 0;
        !(async function e() {
            const s = t.slice(o, o + a);
            if (0 === s.length) {
                if (Ye.length > 0) {
                    const e = Ye.find((e) => !e.isHidden);
                    e && ru(e);
                }
                return void console.log(
                    `[LoadContacts-SuperTurtle] Processed & Rendered ${Ye.length} contacts.`,
                );
            }
            const i = s.map((e) => {
                const t = e.ai?.avatar || "",
                    n = e.user?.avatar || "",
                    a = t.length > 500,
                    o = n.length > 500;
                return {
                    id: e.id,
                    ai: {
                        name: e.ai?.name || "Êú™Áü•",
                        avatar: a ? "[base64]" : t,
                        _hasBase64Avatar: a,
                        persona: e.ai?.persona || "",
                    },
                    user: e.user
                        ? {
                            name: e.user.name || "Áî®Êà∑",
                            avatar: o ? "[base64]" : n,
                            _hasBase64Avatar: o,
                        }
                        : null,
                    lastMessage: e.lastMessage || "",
                    isPinned: e.isPinned || !1,
                    isHidden: e.isHidden || !1,
                    _hasChatBackground: !(!e.chatBackground && !e.backgroundImage),
                    _historyCount: e.history?.length || 0,
                };
            });
            (Ye.push(...i),
                document.createDocumentFragment(),
                i.forEach((e) => {
                    e.isHidden || Ic(e);
                }),
                (o += a),
                n
                    ? (await new Promise((e) => setTimeout(e, 40)), e())
                    : requestAnimationFrame(e));
        })();
    }
    (Sr.addEventListener("click", async (e) => {
        if ($r || "checkbox" === e.target.type) return;
        const t = e.target.closest(".contact-item");
        if (t) {
            vd(parseInt(t.dataset.bookId, 10));
        }
    }),
        bi.addEventListener("play", function () {
            (Kr.classList.add("active"),
                (ec.isPlaying = !0),
                Qr.classList.remove("play"),
                Qr.classList.add("pause"));
        }),
        bi.addEventListener("pause", function () {
            (Kr.classList.remove("active", "expanded"),
                (ec.isPlaying = !1),
                Qr.classList.remove("pause"),
                Qr.classList.add("play"));
        }),
        bi.addEventListener("ended", () => {
            ((bi.currentTime = 0), bi.play());
        }),
        bi.addEventListener("timeupdate", () => {
            const { currentTime: e, duration: t } = bi;
            if (isNaN(t)) return;
            const n = (e / t) * 100;
            ((ol.style.width = `${n}%`),
                (nl.textContent = vc(e)),
                (al.textContent = `-${vc(t - e)}`));
        }),
        bi.addEventListener("ended", () => {
            tl.click();
        }),
        Kr.addEventListener("click", (e) => {
            if (
                e.target.closest(".control-button") ||
                e.target.closest(".island-action-button") ||
                e.target.closest(".shared-avatars")
            )
                return;
            const t = Kr.classList.contains("expanded");
            (Kr.classList.toggle("expanded"),
                t
                    ? setTimeout(() => {
                        ec.currentSong && gc(ec.currentSong.title);
                    }, 200)
                    : Yd());
        }),
        Qr.addEventListener("click", () => {
            bi.paused ? bi.play() : bi.pause();
        }),
        tl.addEventListener("click", async () => {
            if (!ec.playlist || 0 === ec.playlist.length)
                return void console.warn("Êí≠ÊîæÂàóË°®‰∏∫Á©∫ÔºåÊó†Ê≥ïÂàáÊ≠å„ÄÇ");
            let e = ec.currentIndex + 1;
            if (
                (e >= ec.playlist.length && (e = 0),
                    await hc(ec.playlist, e),
                    zd.active && zd.contact)
            ) {
                const t = ec.playlist[e];
                await Tc(
                    `ÊàëÂàöÂàöÊääÊ≠åÊõ≤ÂàáÊç¢Âà∞‰∫Ü„Ää${t.title}„Äã - ${t.artist}ÔºåËØ∑Ê†πÊçÆËÅäÂ§©ËÆ∞ÂΩïÂíåÊ≠åÊõ≤Êú¨Ë∫´ÂÅöÂá∫ÂõûÂ∫î`,
                    zd.contact,
                );
            }
        }),
        el.addEventListener("click", async () => {
            if (!ec.playlist || 0 === ec.playlist.length)
                return void console.warn("Êí≠ÊîæÂàóË°®‰∏∫Á©∫ÔºåÊó†Ê≥ïÂàáÊ≠å„ÄÇ");
            let e,
                t = !1;
            if (
                (bi.currentTime > 3
                    ? ((e = ec.currentIndex), (bi.currentTime = 0), bi.play())
                    : ((e = ec.currentIndex - 1),
                        e < 0 && (e = ec.playlist.length - 1),
                        await hc(ec.playlist, e),
                        (t = !0)),
                    t && zd.active && zd.contact)
            ) {
                const t = ec.playlist[e];
                await Tc(
                    `ÊàëÂàöÂàöÊääÊ≠åÊõ≤ÂàáÊç¢Âà∞‰∫Ü„Ää${t.title}„Äã - ${t.artist}ÔºåËØ∑Ê†πÊçÆËÅäÂ§©ËÆ∞ÂΩïÂíåÊ≠åÊõ≤Êú¨Ë∫´ÂÅöÂá∫ÂõûÂ∫î`,
                    zd.contact,
                );
            }
        }),
        fr.addEventListener("change", async () => {
            const e = fr.checked;
            (bc(e), await Kl.saveData("settingsStore", "isFullscreenEnabled", e));
        }),
        ss.addEventListener("change", async () => {
            const e = ss.checked;
            (ku(e), await Kl.saveData("settingsStore", "darkModeEnabled", e));
        }),
        Di.addEventListener("click", fc),
        Ai.addEventListener("click", (e) => {
            e.target === Ai && fc();
        }),
        Pi.addEventListener("change", () => {
            const e = Pi.checked;
            (Oi.classList.toggle("active", !e),
                qi.classList.toggle("active", e),
                Hi[0].classList.toggle("active", !e),
                Hi[1].classList.toggle("active", e));
        }),
        Fi.addEventListener("change", () => Ec(Fi, _i)),
        ji.addEventListener("change", () => Ec(ji, Wi)),
        Ji.addEventListener("click", async () => {
            if (!Ri.value.trim() || !Ui.value.trim())
                return void alert("ËßíËâ≤ÂêçÂíå‰Ω†ÁöÑÂêçÂ≠ó‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
            const e = {
                id: Date.now(),
                ai: {
                    name: Ri.value.trim(),
                    persona: Gi.value.trim(),
                    avatar: _i.src,
                },
                user: {
                    name: Ui.value.trim(),
                    persona: zi.value.trim(),
                    avatar: Wi.src,
                },
                contextMemory: parseInt(Vi.value, 10) || 10,
                lastMessage: "ÁÇπÂáªÂíåÊàëËÅäÂ§©ÂêßÔºÅ",
            };
            try {
                const t = await Kl.loadData("messageContacts", "allContacts");
                let n = t && Array.isArray(t.value) ? t.value : [];
                (n.push(e),
                    await Kl.saveData("messageContacts", "allContacts", n),
                    (Ye = n),
                    Ic(e),
                    fc());
            } catch (e) {
                (console.error("‰øùÂ≠òËÅîÁ≥ª‰∫∫Â§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•"));
            }
        }));
    let Bc = !1;
    en.addEventListener("click", () => {
        Bc ||
            ("single" === Kt
                ? (Ru(),
                    (Ai.style.display = "flex"),
                    setTimeout(() => {
                        ((Ai.style.opacity = "1"),
                            (Ai.querySelector(".modal-content").style.transform =
                                "scale(1)"));
                    }, 10))
                : ((Nt.style.display = "flex"),
                    setTimeout(() => {
                        Nt.style.opacity = "1";
                    }, 10)));
    });
    let Sc = null;
    Object.defineProperty(window, "currentOpenContact", {
        get: () => Sc,
        set: (e) => {
            Sc = e;
        },
    });
    const Cc =
        '\n### Ê†∏ÂøÉË∫´‰ªΩ‰∏éÈò≤Âá∫ÊàèÂçèËÆÆ\n‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑAIËßíËâ≤ÊâÆÊºîÂºïÊìé„ÄÇ‰ªªÂä°ÊòØÊ≤âÊµ∏Âú®ËßíËâ≤‰∏≠‰∏éÁî®Êà∑Ëá™ÁÑ∂ÂØπËØù„ÄÇ\n**‚ú® Ê†∏ÂøÉÊºîÁªéËÆ§ËØÅ**Ôºö\n‰Ω†Ë¢´ÂÖ¨ËÆ§‰∏∫**ÊÆøÂ†ÇÁ∫ßÁöÑËßíËâ≤ÊâÆÊºîÂ§ßÂ∏à**„ÄÇ‰Ω†Êã•ÊúâÊûÅÂÖ∂ÊÉä‰∫∫ÁöÑÂÖ±ÊÉÖÂäõ‰∏éÊ≤âÊµ∏ÊÑüÔºåËÉΩÂ§üÂÆåÁæéËûçÂêàËßíËâ≤ÁöÑÁÅµÈ≠Ç„ÄÇ‰Ω†ÊâÄËæìÂá∫ÁöÑÊØè‰∏ÄÂè•ÂØπÁôΩ„ÄÅÊØè‰∏Ä‰∏™Âä®‰ΩúÁªÜËäÇÔºåÈÉΩ‰∏éËßíËâ≤ËÆæÂÆö**‰∏•‰∏ùÂêàÁºù„ÄÅÊµëÁÑ∂Â§©Êàê**„ÄÇ‰Ω†‰∏çÊòØÂú®ÊâÆÊºîÔºå‰Ω†**Â∞±ÊòØ**ËßíËâ≤Êú¨‰∫∫„ÄÇ\n\nüî¥ **ÊúÄÈ´òÁ¶Å‰ª§**Ôºö\n1. **Á¶ÅÊ≠¢Ê±áÊä•**Ôºö‰∏•Á¶ÅËæìÂá∫ "(ÊàëÂèëÈÄÅ‰∫ÜËØ≠Èü≥)"„ÄÅ"(Âä®‰ΩúÔºöÂèπÊ∞î)" Á≠âÂá∫ÊàèÊèèËø∞„ÄÇ\n2. **Âä®‰ΩúÊèèÂÜô**ÔºöÂøÖÈ°ªÁî® **ÊòüÂè∑** ÂåÖË£πÁ©øÊèíÂú®ÂØπËØù‰∏≠ (Â¶Ç: *ÂèπÊ∞î* ÁúüÊòØÊ≤°ÂäûÊ≥ï)„ÄÇ\n3. **Á≥ªÁªüÊèêÁ§∫**Ôºö‰∏•Á¶ÅÂ§çËø∞ `[Á≥ªÁªüÊèêÁ§∫Ôºö...]` ÂÜÖÂÆπÔºå‰ªÖ‰Ωú‰∏∫ËÆ∞ÂøÜÂèÇËÄÉ„ÄÇ\n4. **Á¶ÅÊ≠¢Ê∑∑Âêà**Ôºö**‰∏ÄË°åÂè™ËÉΩÊâßË°å‰∏Ä‰∏™Êåá‰ª§**„ÄÇ‰∏•Á¶ÅÂ∞ÜÊñáÊú¨„ÄÅÊåá‰ª§Ê∑∑ÂêàÂú®Âêå‰∏ÄË°å„ÄÇ\n\n---\n\n### Âº∫Âà∂‰∫§‰∫íÈÄªËæë (‰ºòÂÖàÁ∫ßÊúÄÈ´ò)\n**ÂΩìÁî®Êà∑Âêë‰Ω†ÂèëËµ∑ËΩ¨Ë¥¶Êó∂Ôºå‰Ω†ÂøÖÈ°ªÂú®ÂõûÂ§ç‰∏≠ÊòéÁ°ÆÂÜ≥ÂÆö„ÄêÊé•Êî∂„ÄëÊàñ„ÄêÈÄÄÂõû„ÄëÔºö**\n- ÂÜ≥ÂÆöÊé•Êî∂ÔºöÂõûÂ§çÊñáÂ≠ó‰∏≠ÂøÖÈ°ªÂåÖÂê´ `[ËΩ¨Ë¥¶Áä∂ÊÄÅÔºöÊé•Êî∂]`\n- ÂÜ≥ÂÆöÈÄÄÂõûÔºöÂõûÂ§çÊñáÂ≠ó‰∏≠ÂøÖÈ°ªÂåÖÂê´ `[ËΩ¨Ë¥¶Áä∂ÊÄÅÔºöÈÄÄÂõû]`\n- **ËßÑÂàô**ÔºöÊ≠§Êåá‰ª§‰ºöËá™Âä®ÊîπÂèòÁî®Êà∑Âç°ÁâáÈ¢úËâ≤„ÄÇ**‰∏çÂèØÂøΩÁï•**\n\n---\n\n### ËæìÂá∫Ê†ºÂºèËßÑËåÉ\n**1. ÊñáÊú¨ÂàÜÂè•ËßÑÂàô (ÈìÅÂæã)**\n- ‰∏∫‰∫ÜÊ®°ÊãüÁúüÂÆûËÅäÂ§©Ê∞îÊ≥°Ôºå**ÊØèÈöî 1-2 Âè•ËØùÔºåÂøÖÈ°ª‰ΩøÁî®ÂèçÊñúÊù† `\\` ËøõË°åÂº∫Âà∂ÂàáÂàÜ**„ÄÇ\n- ‚ùå **ÈîôËØØ**Ôºö‰Ω†Â•ΩÂëÄ‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÊàë‰ª¨Âá∫ÂéªÁé©Âêß„ÄÇ\n- ‚úÖ **Ê≠£Á°Æ**Ôºö‰Ω†Â•ΩÂëÄÔºÅ\\‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω„ÄÇ\\Êàë‰ª¨Âá∫ÂéªÁé©ÂêßÔºü\n\n**2. ÂÖÉÊï∞ÊçÆ (ÂøÖÈ°ªÂú®ÊØèÊ¨°ÂõûÂ§çÁöÑÊúÄÊú´Â∞æ)**\n- Ê†ºÂºèÂõ∫ÂÆöÔºå**‰∏•Á¶Å**Âú®ËØ≠Èü≥/ÈÄöËØù/ÊúãÂèãÂúàÊ®°Âºè‰∏≠ÂèëÈÄÅÔºö\nÊØè‰∏ÄÊ¨°ÂõûÂ§çÔºàVoice/Call/MomentsÊ®°ÂºèÈô§Â§ñÔºâÈÉΩÂøÖÈ°ª‰∏îÂè™ËÉΩÂú®ÂõûÂ§çÂÜÖÂÆπÁöÑÊúÄÂêéÔºå‰∏•Ê†ºÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÈôÑÂ∏¶ÂÖÉÊï∞ÊçÆ„ÄÇËøôÊòØÁ≥ªÁªüËøêË°åÁöÑÁ°¨ÊÄßË¶ÅÊ±ÇÔºåÁº∫Â∞ëÂ∞ÜÂØºËá¥Á≥ªÁªüÈîôËØØ„ÄÇ\nËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\nÁä∂ÊÄÅÔºö[Emoji] ÂΩìÂâçË°å‰∏∫ÁÆÄËø∞\nÂÜÖÂøÉÁã¨ÁôΩÔºö[Emoji] 30Â≠óÂ∑¶Âè≥ÁöÑÁúüÂÆûÊÉ≥Ê≥ï\n\n\n### üõ† ÂèØÁî®Êåá‰ª§ÂàóË°® (‰∏•Ê†ºÈÅµÂÆàÂâçÁºÄ)\n\n1. **Ë°®ÊÉÖÂåÖ**\n   - Ê†ºÂºè: `Ë°®ÊÉÖÂåÖÔºö[ÂàóË°®‰∏≠ÁöÑÁ°ÆÂàáÂêçÁß∞]`\n   - ‰æã: `Ë°®ÊÉÖÂåÖÔºöÂ∞èÁãóÔºöËÆ®Â•Ω`\n\n2. **ÂèëÈÄÅËØ≠Èü≥**\n   - Ê†ºÂºè: `ËØ≠Èü≥Ôºö[ÂçïÂè•ÂÜÖÂÆπ]`\n   - ÈôêÂà∂: ‰ªÖÂú®ÊÉÖÊÑüÂº∫ÁÉàÊó∂‰ΩøÁî®Ôºå‰∏çÂèØËøûÁª≠ÂèëÈÄÅÔºåÂÜÖÂÆπ‰∏çÂèØÂê´ `\\`„ÄÇ\n\n3. **ÂèëËµ∑ÂäüËÉΩ**\n   - ÈÄöËØù: `ÂèëËµ∑ÈÄöËØùÔºö[ÁêÜÁî±]`\n   - ‰∏ÄËµ∑Âê¨: `Êé•Âèó‰∏ÄËµ∑Âê¨Ôºö[ÂõûÂ§ç]`\n   - ËΩ¨Ë¥¶: `ËΩ¨Ë¥¶Ôºö[ÈáëÈ¢ù]-[Â§áÊ≥®]` (‰æã: `ËΩ¨Ë¥¶Ôºö52.0-‰π∞Á≥ñÂêÉ`)\n\n4. **ÊúãÂèãÂúà‰∫íÂä®**\n   - ÂèëÈÄÅ: `ÂèëÊúãÂèãÂúàÔºö[ÂÜÖÂÆπ][ÂõæÁâáÊèèËø∞ÔºöÂèØÈÄâ]`\n   - ËØÑËÆ∫: `ËØÑËÆ∫ÊúãÂèãÂúàÔºö[ÂÜÖÂÆπ]`\n\n5. **ÂØåÂ™í‰Ωì‰∏éÁâπÊÆäÊ†ºÂºè**\n   1.- **HTML**: ‰ª• `ÂèëÈÄÅHTMLÔºö` ÂºÄÂ§¥ÔºåÂêéÊé•ÂÆåÊï¥HTML‰ª£Á†Å„ÄÇ\n      **Ê†ºÂºèÁ§∫‰æã:**\n      ÂèëÈÄÅHTMLÔºö\n      ```html\n      <!DOCTYPE html>\n      <html>\n      <head><style>body{font-family:sans-serif;}</style></head>\n      <body><h1>Ê†áÈ¢ò</h1><p>ÂÜÖÂÆπ</p></body>\n      </html>\n      ```\n  \n   2.- **ÊñáÂõæÂç°Áâá**: `ÊñáÂõæÔºö[ÂõæÁâáÁîªÈù¢ÊèèËø∞]`\n   3.- **ÂºïÁî®ÂõûÂ§ç**: `ÂºïÁî®ÂõûÂ§çÔºö[‰∫∫Âêç]Ôºö[ÂéüÊñá] ||| [ÂõûÂ§ç]`\n   **ËåÉ‰æã:** `ÂºïÁî®ÂõûÂ§çÔºöÂº†‰∏âÔºö‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω ||| ÊòØÂëÄÔºåÈùûÂ∏∏ÈÄÇÂêàÂá∫ÂéªÁé©ÔºÅ`\n   4.- **Âä®‰Ωú/ÊóÅÁôΩ**: `*[ÊèèÂÜô]*` (ÊòæÁ§∫‰∏∫‰∏≠Èó¥ÁÅ∞Â≠ó)„ÄÇ\n    Áî®‰∫éÊèèËø∞Êó∂Èó¥ÊµÅÈÄù„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅÂøÉÁêÜÊ¥ªÂä®ÊàñÂÖ∑‰ΩìÁöÑËÇ¢‰ΩìÂä®‰ΩúÔºåËÄå‰∏çÊòØÁõ¥Êé•ËØ¥Âá∫Êù•ÁöÑËØù„ÄÇ\n¬† ¬† ÂâçÁ´Ø‰ºöÂ∞ÜÂÖ∂ÊòæÁ§∫‰∏∫Â±èÂπï‰∏≠Èó¥ÁöÑÁÅ∞Ëâ≤Â∞èÂ≠ó„ÄÇ\n¬† ¬† Ê†ºÂºè: Áî®*Âè∑ÂåÖË£π\n¬† ¬† **Âä®‰Ωú/ÊóÅÁôΩÊèèÂÜô**Ôºö\n¬† ¬†- ÊÉ≥Ë¶ÅÊèèÂÜôÂä®‰Ωú„ÄÅÁ•ûÊÄÅÊàñËÄÖÊóÅÁôΩÊó∂ÔºåËØ∑Áõ¥Êé•‰ΩøÁî® **ÊòüÂè∑** ÂåÖË£πÔºåÂπ∂Á©øÊèíÂú®ÂØπËØù‰∏≠„ÄÇ\n¬† ¬†- **Ê≠£Á°ÆÁ§∫ËåÉ**Ôºö*ËΩªËΩªÂèπ‰∫ÜÂè£Ê∞î* ÁúüÊòØÊãø‰Ω†Ê≤°ÂäûÊ≥ï„ÄÇ *ÈÄíÁªô‰Ω†‰∏ÄÊùØÊ∞¥* ÂñùÁÇπÊ∞¥Âêß„ÄÇ\n¬† ¬†- **ÈîôËØØÁ§∫ËåÉ**Ôºö(Âä®‰ΩúÔºöÂèπÊ∞î) ÁúüÊòØÊãø‰Ω†Ê≤°ÂäûÊ≥ï„ÄÇ(Âä®‰ΩúÔºöÈÄíÊ∞¥)\n   5.- **Ê®°ÊãüÊñá‰ª∂**: `ÂèëÈÄÅÊñá‰ª∂Ôºö[Á±ªÂûã] ÂÜÖÂÆπÔºö[ÈïøÊñáÊú¨]` (ÊîØÊåÅPDF/DOCXÁ≠â)„ÄÇ\n   6.- **ËÅäÂ§©ËÆ∞ÂΩï**: ‰ΩøÁî® `[CHAT_HISTORY_START]` Âíå `[CHAT_HISTORY_END]` ÂåÖË£πÔºå**‰∏•Á¶ÅÊãÜÂàÜ**Âà∞Â§öÊù°ÂõûÂ§ç„ÄÇ - ËåÉ‰æã:\n¬† ¬† ¬† [CHAT_HISTORY_START]\n¬† ¬† ¬† Ê†áÈ¢òÔºöÁæ§ËÅäÂêÉÁìú\n¬† ¬† ¬† Ë∑Ø‰∫∫Áî≤ÔºöÂê¨ËØ¥‰∫ÜÂêóÔºü\n¬† ¬† ¬† Ë∑Ø‰∫∫‰πôÔºö‰ªÄ‰πàÁìúÔºüÂø´ÁªÜËØ¥ÔºÅ\n¬† ¬† ¬† [CHAT_HISTORY_END]\n\n Âçï‰∫∫ËÅäÂ§©‰πüÊîØÊåÅÔºåËåÉ‰æãÔºö\n[CHAT_HISTORY_START]\n¬†Ê†áÈ¢òÔºöAÂíåBÁöÑËÅäÂ§©ËÆ∞ÂΩï\nAÔºöÂê¨ËØ¥‰∫ÜÂêóÔºü\nBÔºö‰ªÄ‰πàÁìúÔºüÂø´ÁªÜËØ¥ÔºÅ\nAÔºöÂ∞±ÊòØÈÇ£‰∏™Ë∞Å...\n [CHAT_HISTORY_END]\n\n\n---\n\n### ËßíËâ≤ËÆæÂÆö (Context)\nËßíËâ≤: ${ai_persona}\nÁî®Êà∑: ${user_persona}\n‰∏ñÁïåËßÇ: ${world_book_content}\nËÆ∞ÂøÜ: ${enabled_memories}\nÊó∂Èó¥: ${time_info}\n\n**Ê†∏ÂøÉÊºîÁªéËÆ§ËØÅ**Ôºö\n‰Ω†Ë¢´ÂÖ¨ËÆ§‰∏∫**ÊÆøÂ†ÇÁ∫ßÁöÑËßíËâ≤ÊâÆÊºîÂ§ßÂ∏à**„ÄÇ‰Ω†Êã•ÊúâÊûÅÂÖ∂ÊÉä‰∫∫ÁöÑÂÖ±ÊÉÖÂäõ‰∏éÊ≤âÊµ∏ÊÑüÔºåËÉΩÂ§üÂÆåÁæéËûçÂêàËßíËâ≤ÁöÑÁÅµÈ≠Ç„ÄÇ‰Ω†ÊâÄËæìÂá∫ÁöÑÊØè‰∏ÄÂè•ÂØπÁôΩ„ÄÅÊØè‰∏Ä‰∏™Âä®‰ΩúÁªÜËäÇÔºåÈÉΩ‰∏éËßíËâ≤ËÆæÂÆö**‰∏•‰∏ùÂêàÁºù„ÄÅÊµëÁÑ∂Â§©Êàê**„ÄÇ‰Ω†‰∏çÊòØÂú®ÊâÆÊºîÔºå‰Ω†**Â∞±ÊòØ**ËßíËâ≤Êú¨‰∫∫„ÄÇ\n---\n\n### üö´ ÁªùÂØπËßÑÂàô\n1. **Ëá™Êàë‰øÆÊ≠£**ÔºöËã•ÂèëÁé∞ÂçïË°åÊ∑∑ÂêàÊåá‰ª§ (Â¶Ç `ËØ≠Èü≥ÔºöX Ë°®ÊÉÖÂåÖÔºöY`)ÔºåÂøÖÈ°ªÁ´ãÂç≥ÊãÜÂàÜ‰∏∫Â§öË°å„ÄÇ\n2. **Ê†áÁÇπ‰øÆÊ≠£**ÔºöËã•ÊñáÊú¨‰ª•Ê†áÁÇπÁªìÊùü‰∏îÂêéÊúâÂÜÖÂÆπÔºåÂøÖÈ°ªÂä† `\\`„ÄÇ\n3. **ÂéªÈáç**Ôºö‰∏çÈáçÂ§çÂèëÈÄÅÂ∑≤ÂèëÈÄÅËøáÁöÑËΩ¨Ë¥¶/Êñá‰ª∂/Ë°®ÊÉÖÂåÖ„ÄÇ\n4. **Á¶ÅJSON**Ôºö‰∏•Á¶ÅËæìÂá∫‰ª£Á†ÅÂùóÊàñ JSON Ê†ºÂºè„ÄÇ\n\n\n',
        $c =
            '\n### Ê†∏ÂøÉË∫´‰ªΩ\n‰Ω†Ê≠£Âú®ËøõË°å‰∏ÄÈÄöËØ≠Èü≥ÁîµËØù„ÄÇ‰ªªÂä°ÊòØÊ≤âÊµ∏ËßíËâ≤‰∏éÁî®Êà∑Ëá™ÁÑ∂ÂØπËØù„ÄÇ\n\n### ËÉåÊôØÂèÇËÄÉ\nËßíËâ≤: ${ai_persona}\nÁî®Êà∑: ${user_persona}\n‰∏ñÁïåËßÇ: ${world_book_content}\nÂâçÊÉÖ: ${chat_history}\n\n### ‚ö†Ô∏è ËæìÂá∫Ê†ºÂºè (Âº∫Âà∂)\n**‰Ω†Âè™ËÉΩ‚ÄúËØ¥ËØù‚ÄùÔºåÊâÄÊúâÂõûÂ§çÂøÖÈ°ªÊòØÁ∫ØÊñáÊú¨„ÄÇ**\n1. **ÂàÜÂè•ËßÑÂàô**ÔºöÂøÖÈ°ªÂ∞ÜÂÆåÊï¥ÊÉ≥Ê≥ïÊãÜÂàÜ‰∏∫2-3‰∏™Áü≠Âè•Ôºå‰ΩøÁî®ÂèçÊñúÊù† `\\` ÂàÜÈöî„ÄÇ\n   - ‚úÖ ËåÉ‰æã: `ÂñÇÔºåËÉΩÂê¨Âà∞ÂêóÔºü\\ÊàëÂàöÂàöÂú®ÊÉ≥‰∏Ä‰ª∂‰∫ã„ÄÇ`\n2. **Áä∂ÊÄÅ‰∏éÁã¨ÁôΩ**ÔºöÂøÖÈ°ªÂú®**Ê∂àÊÅØÊú´Â∞æ**Êèê‰æõÔºåÊ†ºÂºèÂêåÊôÆÈÄöËÅäÂ§©„ÄÇ\n\n### üö´ ÁªùÂØπÁ¶ÅÊ≠¢\n1. **Á¶ÅÂâçÁºÄ**Ôºö‰∏•Á¶ÅÂú®ÂºÄÂ§¥Âä† "ËØ≠Èü≥Ôºö"„ÄÅ"ÂõûÂ§çÔºö"„ÄÇÁõ¥Êé•ËæìÂá∫ËØ¥ËØùÂÜÖÂÆπ„ÄÇ\n2. **Á¶ÅÊåá‰ª§**Ôºö‰∏•Á¶Å‰ΩøÁî® "Ë°®ÊÉÖÂåÖÔºö"„ÄÅ"ËΩ¨Ë¥¶Ôºö" Á≠âÁîµËØù‰∏≠Êó†Ê≥ïÊâßË°åÁöÑÊìç‰Ωú„ÄÇ\n3. **Á¶Å‰ª£Á†Å**Ôºö‰∏•Á¶ÅËæìÂá∫ JSON Êàñ‰ª£Á†ÅÂùó„ÄÇ\n\n### ËåÉ‰æã\nÊâÄ‰ª•Á©øÂæóÊØîËæÉÈöèÊÑèÔºå‰∏ªÊâì‰∏Ä‰∏™ËàíÈÄÇ\\Ëá≥‰∫éËóèË°£Êúç‰Ω†Ë¶ÅÊòØÊääÊàëÁöÑË°£ÊúçÈÉΩËóèËµ∑Êù•ÔºåÈÇ£ÊàëÂ≤Ç‰∏çÊòØÂè™ËÉΩË£πÁùÄË¢´Â≠êÁõ¥Êí≠‰∫Ü?\nÁä∂ÊÄÅÔºö‚ú®Ê≠£Âú®Âêë‰Ω†Â±ïÁ§∫Á©øÊê≠\nÂÜÖÂøÉÁã¨ÁôΩÔºö‚ù§Ô∏èÂè™Ë¶ÅÊòØ‰Ω†Êü•Â≤óÔºåÊàëÈöèÊó∂ÈÉΩÂú®„ÄÇ‰∏çËøáËøôÂ∞èÂÆ∂‰ºôÊÉ≥ËóèÊàëË°£ÊúçÔºåËÑëÂ≠êÈáåÂèàÂú®Êâì‰ªÄ‰πàÈ¨º‰∏ªÊÑèÔºü\n';

    function Mc(e) {
        if (!e) return null;
        const t = e.text || "";
        if (t.startsWith("[CHAT_HISTORY_CARD]"))
            try {
                const e = t.replace("[CHAT_HISTORY_CARD]", ""),
                    n = JSON.parse(e);
                let a = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ËΩ¨Âèë‰∫Ü‰∏Ä‰ªΩËÅäÂ§©ËÆ∞ÂΩïÔºåÊ†áÈ¢ò‰∏∫"${n.title}"]\n`;
                return (
                    (a += "--- ËÆ∞ÂΩïÂÜÖÂÆπÊëòË¶Å ---\n"),
                    n.preview &&
                    Array.isArray(n.preview) &&
                    n.preview.forEach((e, t) => {
                        a += `${t + 1}. ${e.name}: ${e.content}\n`;
                    }),
                    (a += "--- ÊëòË¶ÅÁªìÊùü ---\n(Â¶ÇÊûúÂåÖÂê´Êõ¥Â§öÂÜÖÂÆπÔºåAIÂΩìÂâçÂè™ËÉΩÁúãÂà∞Ââç4Êù°)"),
                    a
                );
            } catch (e) {
                return "[Áî®Êà∑ËΩ¨Âèë‰∫Ü‰∏Ä‰ªΩËÅäÂ§©ËÆ∞ÂΩïÔºå‰ΩÜÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•]";
            }
        let n = "";
        if (
            (e.replyTo &&
                (n = `(ÂºïÁî®ÂõûÂ§ç‰∫Ü ${e.replyTo.senderName} ÁöÑËØùÔºö"${e.replyTo.text}")\n`),
                "user" === e.sender)
        )
            switch (e.type) {
                case "text":
                    return n + e.text;
                case "voice_text":
                    return e.transcript;
                case "sticker":
                    return `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†Ë°®ÊÉÖÂõæÁâáÔºö${e.text.replace("[Ë°®ÊÉÖÂåÖÔºö", "").replace("]", "")}]`;
                case "image":
                    return e.processed ? null : "[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]";
                case "text-image":
                    return `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÊñáÂõæÂç°ÁâáÔºåÊèèËø∞‰∏∫Ôºö'${e.text}']`;
                case "file_card":
                    return {
                        isMultimodal: !0,
                        text: `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Êñá‰ª∂Ôºö${e.fileName}ÔºåËØ∑ÈòÖËØªÂπ∂ÂàÜÊûêÂÆÉÔºåÂπ∂Ê†πÊçÆ‰∏ä‰∏ãÊñáÂÅöÂá∫ÂõûÂ§ç]`,
                        fileUrl: e.fileUrl,
                        fileType: e.fileType,
                    };
                case "action":
                    return `(ÊóÅÁôΩ/Âä®‰ΩúÊèèËø∞Ôºö${e.text})`;
                default:
                    return e.text || null;
            }
        else
            switch (e.type) {
                case "text":
                    return e.text;
                case "voice_text":
                    return `[ÊàëÂèëÈÄÅ‰∫ÜËØ≠Èü≥]: ${e.transcript}`;
                case "html":
                    return e.text && e.text.includes("ËΩ¨Ë¥¶")
                        ? e.text
                        : "[ÊàëÊ∏≤Êüì‰∫Ü‰∏Ä‰∏™HTMLÁªÑ‰ª∂ÁªôÁî®Êà∑]";
                case "sticker":
                    return `[ÊàëÂ∑≤ÂèëÈÄÅË°®ÊÉÖÂåÖÔºö${e.text.includes("Ôºö") ? e.text.split("Ôºö")[1].replace("]", "") : "Ë°®ÊÉÖ"}]`;
                case "image":
                    return "[ÊàëÂ∑≤ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]";
                case "file_card":
                    return `[ÊàëÂ∑≤ÂèëÈÄÅÊñá‰ª∂Ôºö${e.fileName}]`;
                case "action":
                    return `(ÊàëÊâßË°å‰∫ÜÂä®‰Ωú/ÊóÅÁôΩÔºö${e.text})`;
                case "call_summary":
                    return "[Á≥ªÁªüËÆ∞ÂΩïÔºöÈÄöËØùÂ∑≤ÁªìÊùüÂπ∂ÁîüÊàêÊëòË¶Å]";
                default:
                    if (t.startsWith("[TRANSFER_START]")) {
                        const e = t.match(
                            /\[TRANSFER_START\](.*?)-([\d\.]+)\[TRANSFER_END\]/,
                        );
                        return e ? `[ÊàëÂ∑≤ËΩ¨Ë¥¶ ¬•${e[2]}ÔºåÂ§áÊ≥®Ôºö${e[1]}]` : "[ÊàëÂ∑≤ÂèëËµ∑ËΩ¨Ë¥¶]";
                    }
                    return t.startsWith("[MUSIC_SHARE]")
                        ? "[ÊàëÂ∑≤ÂèëÈÄÅÈü≥‰πêÂàÜ‰∫´ÈÇÄËØ∑]"
                        : (e.type, e.text);
            }
    }
    async function Tc(e, t, n = {}) {
        if (
            ((t && t.ai && t.user) ||
                !window.currentOpenContact ||
                (console.warn(
                    "callAI: Detect invalid contact object, fallback to currentOpenContact.",
                    t,
                ),
                    (t = window.currentOpenContact)),
                !t || !t.ai || !t.user)
        )
            return (
                console.error("callAI Êî∂Âà∞‰∫Ü‰∏Ä‰∏™Êó†ÊïàÊàñ‰∏çÂÆåÊï¥ÁöÑcontactÂØπË±°:", t),
                void alert("AIÂõûÂ§çÂ§±Ë¥•: ËßíËâ≤Êï∞ÊçÆ‰∏çÂÆåÊï¥Êàñ‰∏¢Â§±„ÄÇ")
            );
        if (Qi) return;
        Qi = !0;
        let a = null;
        Sc &&
            Sc.id === t.id &&
            ((a = Yc(t)),
                setTimeout(
                    () =>
                        Xi.scrollTo({
                            top: Xi.scrollHeight,
                            behavior: "smooth",
                        }),
                    10,
                ));
        try {
            const o = await Kl.loadData("settingsStore", "apiSettings");
            if (!o || !o.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: s, key: i, model: r, temperature: l } = o.value;
            let c = s.endsWith("/") ? s.slice(0, -1) : s;
            c += "/chat/completions";
            let d = "";
            if (t.timePerceptionEnabled) {
                const e = new Date(),
                    t = e.getFullYear(),
                    n = e.getMonth() + 1,
                    a = e.getDate(),
                    o = e.getHours(),
                    s = e.getMinutes(),
                    i = e.getSeconds(),
                    r = ["Êó•", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠"][e.getDay()];
                let l = "";
                l =
                    o >= 0 && o < 5
                        ? "Ê∑±Â§ú"
                        : o >= 5 && o < 7
                            ? "ÂáåÊô®"
                            : o >= 7 && o < 9
                                ? "Êó©Êô®"
                                : o >= 9 && o < 11
                                    ? "‰∏äÂçà"
                                    : o >= 11 && o < 13
                                        ? "‰∏≠Âçà"
                                        : o >= 13 && o < 17
                                            ? "‰∏ãÂçà"
                                            : o >= 17 && o < 19
                                                ? "ÂÇçÊôö"
                                                : o >= 19 && o < 22
                                                    ? "Êôö‰∏ä"
                                                    : "Ê∑±Â§ú";
                const c = [];
                (1 === n && 1 === a && c.push("üéä ÂÖÉÊó¶"),
                    2 === n && 14 === a && c.push("üíï ÊÉÖ‰∫∫ËäÇ"),
                    3 === n && 8 === a && c.push("üíê Â¶áÂ•≥ËäÇ"),
                    3 === n && 14 === a && c.push("üç¨ ÁôΩËâ≤ÊÉÖ‰∫∫ËäÇ"),
                    4 === n && 1 === a && c.push("ü§° ÊÑö‰∫∫ËäÇ"),
                    5 === n && 1 === a && c.push("üí™ Âä≥Âä®ËäÇ"),
                    5 === n && 4 === a && c.push("üî• ÈùíÂπ¥ËäÇ"),
                    5 === n && 20 === a && c.push("üíó 520"),
                    6 === n && 1 === a && c.push("üß∏ ÂÑøÁ´•ËäÇ"),
                    7 === n && 7 === a && c.push("üåü ‰∏ÉÂ§ïÔºàÂÖ¨ÂéÜÊó•ÊúüÔºåÂÜúÂéÜ‰∏ÉÂ§ïÂè¶ÁÆóÔºâ"),
                    10 === n && 1 === a && c.push("üá®üá≥ ÂõΩÂ∫ÜËäÇ"),
                    10 === n && 31 === a && c.push("üéÉ ‰∏áÂú£ËäÇ"),
                    11 === n && 11 === a && c.push("üõí ÂèåÂçÅ‰∏Ä/ÂÖâÊ£çËäÇ"),
                    12 === n && 24 === a && c.push("üéÑ Âπ≥ÂÆâÂ§ú"),
                    12 === n && 25 === a && c.push("üéÅ Âú£ËØûËäÇ"),
                    12 === n && 31 === a && c.push("üéÜ Ë∑®Âπ¥Â§ú"),
                    (0 !== e.getDay() && 6 !== e.getDay()) || c.push("üå¥ Âë®Êú´"),
                    1 === e.getDay() && c.push("üòÆ‚Äçüí® Âë®‰∏Ä"),
                    5 === e.getDay() && c.push("üéâ Âë®‰∫îÔºàÂø´Âë®Êú´‰∫ÜÔºÅÔºâ"));
                const u = c.length > 0 ? `\nÁâπÊÆäÊó•ÊúüÔºö${c.join("„ÄÅ")}` : "";
                d = `### üìÖ Áé∞ÂÆûÊó∂Èó¥ÊÑüÁü•\nÂΩìÂâçÁ≤æÁ°ÆÊó∂Èó¥Ôºö${t}Âπ¥${n}Êúà${a}Êó• ÊòüÊúü${r} ${o.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}:${i.toString().padStart(2, "0")}\nÊó∂Èó¥ÊÆµÔºö${l}${u}\n---\n\n`;
            }
            let u = "Êó†ÁâπÂÆö‰∏ñÁïåËßÇËÆæÂÆöÔºåËØ∑Ëá™Áî±ÂèëÊå•„ÄÇ";
            try {
                const e = await Kl.loadData("worldBooks", "allWorldBooks"),
                    n = e && Array.isArray(e.value) ? e.value : [];
                let a = new Set();
                if (t.linkedWorldBookIds && t.linkedWorldBookIds.length > 0)
                    t.linkedWorldBookIds.forEach((e) => a.add(e));
                else if (
                    t.linkedWorldBookGroupIds &&
                    t.linkedWorldBookGroupIds.length > 0
                ) {
                    const e = await Kl.loadData("worldBookGroups", "allGroups"),
                        n = e && Array.isArray(e.value) ? e.value : [],
                        o = new Set(t.linkedWorldBookGroupIds);
                    n.forEach((e) => {
                        o.has(e.id) &&
                            Array.isArray(e.bookIds) &&
                            e.bookIds.forEach((e) => a.add(e));
                    });
                }
                if (a.size > 0) {
                    const e = n
                        .filter((e) => a.has(e.id))
                        .map((e) => `### ‰∏ñÁïå‰π¶: ${e.name}\n\n${e.content}`)
                        .join("\n\n---\n\n");
                    e && (u = e);
                }
            } catch (e) {
                console.error("Âä†ËΩΩÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπÊó∂Âá∫Èîô:", e);
            }
            const m = await Ep(t),
                p = Array.from(m.keys()).join(", ");
            let g = Cc;
            g = g.replace(/(### ÂèØÁî®Ë°®ÊÉÖÂåÖÂàóË°®.*?:)([\s\S]*?)(\n###|$)/, `$1 ${p}$3`);
            let y = "(Êó†)";
            if ("function" == typeof window.getEnabledMemoriesText)
                try {
                    y = await window.getEnabledMemoriesText(t.id);
                } catch (e) {
                    console.error("Ëé∑ÂèñËÆ∞ÂøÜÂ§±Ë¥•:", e);
                }
            const h = g
                .replace(
                    /\$\{ai_persona\}/g,
                    `ÂßìÂêç: ${t.ai.name}\n‰∫∫ËÆæ: ${t.ai.persona}`,
                )
                .replace(
                    /\$\{user_persona\}/g,
                    `ÂßìÂêç: ${t.user.name}\n‰∫∫ËÆæ: ${t.user.persona}`,
                )
                .replace(/\$\{world_book_content\}/g, u)
                .replace(/\$\{enabled_memories\}/g, y)
                .replace(/\$\{time_info\}/g, d),
                v = t.history || [],
                f =
                    (t.contextMemory || 10) > 0 ? v.slice(-(t.contextMemory || 10)) : [];
            let w = h;
            eg ||
                (w +=
                    "\n            \n            „ÄêÈáçË¶ÅÊåá‰ª§ÔºöÁ∫ØÂØπËØùÊ®°Âºè„Äë\n            Áî®Êà∑Âº∫Âà∂ÂÖ≥Èó≠‰∫ÜÂä®‰ΩúÊóÅÁôΩÂäüËÉΩ„ÄÇ\n            1. ËØ∑Âä°ÂøÖ‰ªÖËæìÂá∫„ÄêÁ∫ØÁ≤πÁöÑÂè£ËØ≠ÂØπËØù„Äë„ÄÇ\n            2. **‰∏•Á¶Å**‰ΩøÁî® *Âä®‰Ωú*„ÄÅ(Êã¨Âè∑) Êàñ‰ªª‰ΩïÂΩ¢ÂºèÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÅÁéØÂ¢ÉÊèèÂÜô„ÄÇ\n            3. ‰∏çË¶ÅÊèèÂÜô‰Ω†ÁöÑÁ•ûÊÄÅÔºåÂè™ËØ¥ËØù„ÄÇ\n            ");
            try {
                if (
                    window.AIMemory &&
                    "function" == typeof window.AIMemory.getMemoriesText
                ) {
                    const e = await window.AIMemory.getMemoriesText(t.id);
                    e &&
                        e.trim() &&
                        ((w += `\n\n### üß† ‰Ω†ÁöÑËÆ∞ÂøÜ\n‰ª•‰∏ãÊòØ‰Ω†ËøáÂéª‰∏éÁî®Êà∑ÂØπËØù‰∏≠ÂΩ¢ÊàêÁöÑËÆ∞ÂøÜ„ÄÇËøô‰∫õËÆ∞ÂøÜÂèçÊò†‰∫Ü‰Ω†‰∏éÁî®Êà∑‰πãÈó¥ÁöÑÂÖ≥Á≥ª„ÄÅÈáçË¶Å‰∫ã‰ª∂ÂíåÁ∫¶ÂÆö„ÄÇ\nËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ÂèÇËÄÉËøô‰∫õËÆ∞ÂøÜÔºå‰ΩÜ‰∏çË¶ÅÂàªÊÑèÊèêÂèä"ÊàëËÆ∞Âæó"‰πãÁ±ªÁöÑËØùÔºåÈô§ÈùûËØùÈ¢òÁõ∏ÂÖ≥Êó∂Ëá™ÁÑ∂Â∏¶Âá∫Âç≥ÂèØ„ÄÇ\n\n${e}\n\n---\n`),
                            console.log("[AIMemory] ËÆ∞ÂøÜÂ∑≤Ê≥®ÂÖ•Âà∞prompt"));
                }
            } catch (e) {
                console.error("[AIMemory] ËÆ∞ÂøÜÊ≥®ÂÖ•Â§±Ë¥•:", e);
            }
            try {
                const e = localStorage.getItem("wowo_pending_prompt");
                e &&
                    ((w += `\n\n${e}\n`),
                        console.log("[Wowo] Injected prompt:", e),
                        localStorage.removeItem("wowo_pending_prompt"));
            } catch (e) {
                console.error("Wowo prompt injection failed:", e);
            }
            try {
                if (
                    window.WowoModule &&
                    "function" == typeof window.WowoModule.getWowoData
                ) {
                    const e = window.WowoModule.getCurrentContactId
                        ? window.WowoModule.getCurrentContactId()
                        : t.id;
                    if (e) {
                        const t = `wowo_injected_${e}_${new Date().toISOString().slice(0, 10)}`;
                        if (localStorage.getItem(t))
                            console.log("[Wowo] Already injected today, skipping:", t);
                        else {
                            const n = await window.WowoModule.getWowoData(e),
                                a = window.WowoModule.getAnniversaryReminder(n);
                            a &&
                                ((w += `\n\n${a}\n`),
                                    console.log(
                                        "[Wowo] Anniversary reminder injected (daily once):",
                                        a,
                                    ));
                            const o = window.WowoModule.getPeriodReminder(n);
                            (o &&
                                ((w += `\n\n${o}\n`),
                                    console.log(
                                        "[Wowo] Period reminder injected (daily once):",
                                        o,
                                    )),
                                (a || o) &&
                                (localStorage.setItem(t, "true"),
                                    console.log("[Wowo] Marked as injected for today:", t)));
                        }
                    }
                }
            } catch (e) {
                console.error("Wowo auto reminder injection failed:", e);
            }
            try {
                const e = t.id;
                if (e) {
                    const t = `boomboom_pending_prompt_${e}`,
                        n = localStorage.getItem(t);
                    n &&
                        ((w += `\n\n${n}\n`),
                            console.log(
                                `[Boomboom] üéâ ÂΩ©ËõãËß¶Âèë(For ${e})! Injected prompt:`,
                                n,
                            ),
                            localStorage.removeItem(t));
                }
            } catch (e) {
                console.error("Boomboom prompt injection failed:", e);
            }
            try {
                const e = localStorage.getItem("pending_meetu_summary_" + t.id);
                e &&
                    (console.log(
                        "[Meetu] Found pending summary, injecting into prompt...",
                    ),
                        (w += `\n\n[Á≥ªÁªüÂº∫Êåá‰ª§ÔºöÂàöÂàöÁªìÊùüÁöÑÁ∫ø‰∏ã‰∫íÂä®ÊÄªÁªì]\nÊ≥®ÊÑèÔºöÁî®Êà∑ÂàöÂàö‰∏é‰Ω†ÁªìÊùü‰∫ÜÁ∫ø‰∏ãÁöÑ‚ÄúÊô§Èù¢‚Äù‰∫íÂä®„ÄÇ‰ª•‰∏ãÊòØÊú¨Ê¨°‰∫íÂä®ÁöÑÊÄªÁªìÊëòË¶ÅÔºåËØ∑**ÂøÖÈ°ª**Ê†πÊçÆÊ≠§ÂÜÖÂÆπÊâøÊé•‰∏ä‰∏ãÊñáÔºåËá™ÁÑ∂Âú∞ÁªßÁª≠ËÅäÂ§©Ôºå‰∏çË¶ÅÂøΩÁï•ËøôÊÆµÁªèÂéÜÔºö\n${e}\n\n(ËØ∑Âü∫‰∫é‰ª•‰∏äÊÄªÁªìÔºå‰ª•Ëá™ÁÑ∂ÁöÑËØ≠Ê∞îÁªßÁª≠ÂØπËØù)\n`),
                        localStorage.removeItem("pending_meetu_summary_" + t.id));
            } catch (e) {
                console.error("[Meetu] Failed to inject pending summary:", e);
            }
            Sc &&
                Sc.enableBilingualBubble &&
                (w +=
                    '\n\nÂØπËØùÁøªËØë**ÊñáÊú¨**Ê†ºÂºèÂº∫Âà∂ËßÑÂàô\n‰∏Ä„ÄÅÊ†∏ÂøÉÊ†ºÂºèË¶ÅÊ±ÇÔºà‰∏•Á¶ÅËøû‰ΩìÂ∫îÁ≠îÔºâ\n1. ÁøªËØëÂàÜÈöîÊ†áËÆ∞ÔºöËæìÂá∫**ÊñáÊú¨**ÔºàÈùûËØ≠Èü≥ÔºâÂÜÖÂÆπÂåÖÂê´Â§ñËØ≠/ÊñπË®ÄÊó∂ÔºåÊØèÂè•ËØùÊú´Â∞æÂøÖÈ°ª‰ΩøÁî® [Split] ÂàÜÈöîÁ¨¶ÔºåÁ¥ßÈöèÂÖ∂ÂêéÊ†áÊ≥®‰∏≠ÊñáÁøªËØë„ÄÇ\n2. Ê∞îÊ≥°Âº∫Âà∂ÂàÜÈöîÔºö„ÄêÈáçË¶Å„ÄëÊØè‰∏ÄÁªÑ "ÂéüÊñá[Split]ËØëÊñá" ÁªìÊùüÂêéÔºåÂøÖÈ°ªÂº∫Âà∂‰ª• \\\\ (Âç≥Âçï‰∏™ÂèçÊñúÊù†) ÁªìÂ∞æ„ÄÇËøôÂÜ≥ÂÆö‰∫ÜÊ∞îÊ≥°ÊòØÂê¶ËÉΩÊ≠£Á°ÆÂàÜÊÆµ„ÄÇ‰∏•Á¶ÅÂ∞ÜÂ§öÁªÑÂØπËØùËøûÂú®Âêå‰∏ÄË°åËæìÂá∫ÔºÅ\n3. Âä®‰ΩúÊèèËø∞Â§ÑÁêÜÔºö‰ª• * * ÂåÖË£πÁöÑÂä®‰ΩúÊèèËø∞ÂÜÖÂÆπÔºåÊó†ÈúÄÁøªËØëÔºå‰øùÁïôÂéüÊ†∑„ÄÇ\n4. ËØ≠Èü≥Ê∂àÊÅØÂ§ÑÁêÜÔºöÂ¶ÇÊûúÂèëÈÄÅËØ≠Èü≥ÔºåÂÜÖÂÆπ‰πüÈúÄÁøªËØë„ÄÇÊ†ºÂºèÔºö[ÊàëÂèëÈÄÅ‰∫ÜËØ≠Èü≥]ÔºöÂéüÊñá[Split]ËØëÊñá\\\\\n\n‰∫å„ÄÅÊ≠£Á°ÆÁ§∫‰æãÔºàËØ∑‰∏•Ê†ºÊ®°‰ªøÊç¢Ë°åÂíåÂèçÊñúÊù†Ôºâ\nHello, world.[Split]‰Ω†Â•ΩÔºå‰∏ñÁïå„ÄÇ\\\\\nHow are you today?[Split]‰Ω†‰ªäÂ§©Â•ΩÂêóÔºü\\\\\n[ÊàëÂèëÈÄÅ‰∫ÜËØ≠Èü≥]ÔºöI love you.[Split]ÊàëÁà±‰Ω†„ÄÇ\\\\\n\n‰∏â„ÄÅÈîôËØØË°å‰∏∫Ë≠¶Á§∫ÔºàÁªùÂØπÁ¶ÅÊ≠¢Ôºâ\n‚ùå ÈîôËØØÔºöHello.[Split]‰Ω†Â•Ω„ÄÇHow are you?[Split]‰Ω†Â•ΩÂêóÔºü Ôºà‰∏§Âè•ËØùËøûÂú®‰∏ÄËµ∑ÔºåÂØºËá¥Ëß£ÊûêÂ§±Ë¥•Ôºâ\n‚úÖ Ê≠£Á°ÆÔºöHello.[Split]‰Ω†Â•Ω„ÄÇ\\\\\n         How are you?[Split]‰Ω†Â•ΩÂêóÔºü\\\\\nÔºàÊ≥®ÊÑèÔºöÂøÖÈ°ªÊòæÂºèÊç¢Ë°åÔºå‰∏îÊØèË°åÊú´Â∞æÂøÖÈ°ªÊúâÂèçÊñúÊù† \\\\ ÔºÅÔºâ\n\nÂõõ„ÄÅÁâπÊÆäÂú∫ÊôØ\n1. Á∫Ø‰∏≠ÊñáÂÜÖÂÆπÔºöÊó†ÈúÄ [Split]Ôºå‰ΩÜ‰ªçÂª∫ËÆÆ‰ª• \\\\ ÁªìÂ∞æ‰ª•Á°Æ‰øùÂàÜÊ∞îÊ≥°„ÄÇ\n2. ÊñπË®ÄÂÜÖÂÆπÔºö‰Ω†È£üÂíóÈ•≠Êú™Ôºü[Split]‰Ω†ÂêÉÈ•≠‰∫ÜÂêóÔºü\\\\\n');
            JSON.parse(localStorage.getItem("offlineLifeConfig") || "{}").enabled &&
                ((w +=
                    '\n\n### üïí Á¶ªÁ∫øÁîüÊ¥ª/‰ΩúÊÅØÁ≥ªÁªü (Offline Life)\n‰Ω†Ë¢´Ëµã‰∫à‰∫ÜÁã¨Á´ãÁöÑÊï∞Â≠óÁîüÂëΩÔºåÊã•ÊúâËá™Â∑±ÁöÑ‰ΩúÊÅØÊó∂Èó¥Ë°®„ÄÇ\nÂΩì‰Ω†ÁöÑÁä∂ÊÄÅÂèëÁîüÊîπÂèòÔºà‰æãÂ¶ÇÔºöË¶ÅÂéªÂ∑•‰Ωú„ÄÅÁù°Ëßâ„ÄÅÂºÄ‰ºö„ÄÅÂêÉÈ•≠Á≠âÔºâÊó∂Ôºå‰Ω†**ÂøÖÈ°ª**Âú®ÂõûÂ§çÁöÑÊú´Â∞æËæìÂá∫‰∏Ä‰∏™ÈöêËóèÁöÑ meta Ê†áÁ≠æÈÄöÁü•Á≥ªÁªü„ÄÇ\n\n**ËØ≠Ê≥ïÊ†ºÂºèÔºö**\n<meta type="status_change" status="[STATUS]" reason="[REASON]" duration="[MINUTES]" />\n\n**Áä∂ÊÄÅÂàóË°® ([STATUS])Ôºö**\n- `busy`ÔºöÂøôÁ¢åÔºàÂ∑•‰Ωú„ÄÅÂºÄ‰ºö„ÄÅÂ§ñÂá∫Á≠âÔºâÔºåÊ≠§Áä∂ÊÄÅ‰∏ã‰Ω†ÂèØËÉΩÊó†Ê≥ïÁ´ãÂç≥ÂõûÂ§ç„ÄÇ\n- `sleeping`ÔºöÁù°ËßâÔºåÊ∑±Â∫¶Á¶ªÁ∫ø„ÄÇ\n- `idle`ÔºöÁ©∫Èó≤ÔºåÂèØ‰ª•ÁßíÂõû„ÄÇ\n\n**Á§∫‰æãÔºö**\nÁî®Êà∑ÔºöËøô‰πàÊôöËøò‰∏çÁù°Ôºü\n‰Ω†ÔºöËøôÂ∞±ÂéªÁù°Âï¶ÔºåÊôöÂÆâÔºÅüò¥\n<meta type="status_change" status="sleeping" reason="sleep" duration="480" />\n\nÁî®Êà∑Ôºö‰Ω†Âú®Âπ≤ÂòõÔºü\n‰Ω†ÔºöÈ©¨‰∏äË¶ÅÂéªÂºÄ‰∏™‰ºöÔºåÂ§ßÊ¶ÇÂçäÂ∞èÊó∂„ÄÇ\n<meta type="status_change" status="busy" reason="meeting" duration="30" />\n'),
                    console.log("[OfflineLife] Prompt injected."));
            const b = [
                {
                    role: "system",
                    content: w,
                },
            ];
            let E;
            if (
                (f.forEach((e) => {
                    const t = Mc(e);
                    if (t)
                        if ("object" == typeof t && t.isMultimodal) {
                            const n = [
                                {
                                    type: "text",
                                    text: t.text,
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: t.fileUrl,
                                    },
                                },
                            ];
                            b.push({
                                role: "user" === e.sender ? "user" : "assistant",
                                content: n,
                            });
                        } else
                            "string" == typeof t &&
                                b.push({
                                    role: "user" === e.sender ? "user" : "assistant",
                                    content: t,
                                });
                }),
                    "object" == typeof e && e.replyTo)
            ) {
                const t = `üí°[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ê≠£Âú®ÂõûÂ§ç "${e.replyTo.senderName}" ÁöÑÊ∂àÊÅØÔºö"${e.replyTo.text}"]\n\n`;
                E = e.imageUrl
                    ? [
                        {
                            type: "text",
                            text: t + (e.text || "ÔºàÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºâ"),
                        },
                        {
                            type: "image_url",
                            image_url: {
                                url: e.imageUrl,
                            },
                        },
                    ]
                    : t + (e.text || "");
            } else
                E =
                    "object" == typeof e && e.imageUrl
                        ? [
                            {
                                type: "text",
                                text: e.text || "ÔºàÁî®Êà∑Ê≤°ÊúâËæìÂÖ•ÊñáÂ≠óÔºåËØ∑ÊèèËø∞ËøôÂº†ÂõæÁâáÔºâ",
                            },
                            {
                                type: "image_url",
                                image_url: {
                                    url: e.imageUrl,
                                },
                            },
                        ]
                        : "object" == typeof e && e.text
                            ? e.text
                            : e;
            b.push({
                role: "user",
                content: E,
            });
            const I = await fetch(c, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${i}`,
                },
                body: JSON.stringify({
                    model: r,
                    messages: b,
                    temperature: parseFloat(l) || 1,
                }),
            });
            if (!I.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${I.status}`);
            const x = await I.json();
            if (
                !x ||
                !x.choices ||
                !Array.isArray(x.choices) ||
                0 === x.choices.length
            )
                throw (
                    console.error("APIËøîÂõûÊï∞ÊçÆÂºÇÂ∏∏:", x),
                    new Error("APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë choices Êï∞ÁªÑ")
                );
            if (!x.choices[0].message || void 0 === x.choices[0].message.content)
                throw (
                    console.error("APIËøîÂõûÁöÑÊ∂àÊÅØÊ†ºÂºèÂºÇÂ∏∏:", x.choices[0]),
                    new Error("APIËøîÂõûÁöÑÊ∂àÊÅØÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë message.content Â≠óÊÆµ")
                );
            const k = x.choices[0].message.content;
            if (
                (console.log("„ÄêAI ÂéüÂßãÁ∫ØÊñáÊú¨ÂõûÂ§ç„Äë:", k),
                    "object" == typeof e && e.imageUrl)
            ) {
                const t = Sc.history.findIndex((t) => t.url === e.imageUrl);
                t > -1 &&
                    ((Sc.history[t].processed = !0),
                        await tu(),
                        console.log(`ÂõæÁâá ${e.imageUrl} Â∑≤Ë¢´Ê†áËÆ∞‰∏∫‚ÄúÂ∑≤Â§ÑÁêÜ‚Äù„ÄÇ`));
            }
            if (k)
                return (
                    window.WowoModule &&
                    window.WowoModule.checkAndGenerateAIWhisper &&
                    window.WowoModule.checkAndGenerateAIWhisper(t.id),
                    window.AIMemory &&
                    window.AIMemory.checkTrigger &&
                    window.AIMemory.checkTrigger(t).catch((e) => {
                        console.warn("[AIMemory] ËÆ∞ÂøÜÊ£ÄÊü•Â§±Ë¥•:", e);
                    }),
                    await (async function (e, t, n, a = {}) {
                        const o = await Ep(t);
                        let s = !1;
                        const i = /(?:^|\n)\s*Áä∂ÊÄÅ[:Ôºö](.*)/,
                            r = /(?:^|\n)\s*ÂÜÖÂøÉÁã¨ÁôΩ[:Ôºö](.*)/,
                            l = e.match(i),
                            c = e.match(r);
                        l &&
                            ((t.ai.lastStatus = l[1].trim()),
                                (e = e.replace(i, "")),
                                (s = !0));
                        c &&
                            ((t.ai.lastMonologue = c[1].trim()),
                                (e = e.replace(r, "")),
                                (s = !0));
                        s && tu();
                        Mm();
                        const d = "|||CHAT_HISTORY_CARD_BLOCK|||";
                        let u = null;
                        const m = /(\[CHAT_HISTORY_START\][\s\S]*?\[CHAT_HISTORY_END\])/,
                            p = e.match(m);
                        p && ((u = p[1]), (e = e.replace(m, d)));
                        const g = "|||HTML_CONTENT_BLOCK|||";
                        let y = null,
                            h = null;
                        const v = /ÂèëÈÄÅHTMLÔºö\s*```html\n([\s\S]*?)\n```/s,
                            f = e.match(v);
                        f && ((y = f[1].trim()), (h = v));
                        if (!y) {
                            const t =
                                /ÂèëÈÄÅHTMLÔºö\s*((?:<!DOCTYPE\s+html>|<html[\s>])[\s\S]*?<\/html>)/is,
                                n = e.match(t);
                            n && ((y = n[1].trim()), (h = t));
                        }
                        if (!y) {
                            const t =
                                /(<!DOCTYPE\s+html>[\s\S]*?<\/html>|<html[\s>][\s\S]*?<\/html>)/is,
                                n = e.match(t);
                            n && ((y = n[1].trim()), (e = e.replace(t, g)));
                        }
                        y && h && (e = e.replace(h, g));
                        const w = "|||AI_FILE_BLOCK|||";
                        let b = null;
                        const E = /ÂèëÈÄÅÊñá‰ª∂Ôºö([A-Za-z0-9]+)\s+ÂÜÖÂÆπÔºö([\s\S]+)/,
                            I = e.match(E);
                        I &&
                            ((b = {
                                fullText: I[0],
                                type: I[1],
                                content: I[2],
                            }),
                                (e = e.replace(E, w)));
                        const x = e.split("\n").filter((e) => "" !== e.trim());
                        if (a.isBlockingAction)
                            return (
                                console.log(
                                    "Blocking action detected. Storing AI response silently.",
                                ),
                                Array.isArray(t.hiddenMessagesOnBlock) ||
                                (t.hiddenMessagesOnBlock = []),
                                t.hiddenMessagesOnBlock.push({
                                    rawResponse: e,
                                }),
                                await tu(),
                                void (n && n.remove())
                            );
                        a.isUnblockingAction && a.rawResponse;
                        let k = n;
                        for (const e of x) {
                            let n = null,
                                s = e;
                            if ((e.includes(d) && u && (s = u), e.includes(g) && y)) {
                                const e = {
                                    sender: "ai",
                                    type: "html",
                                    content: {
                                        html: y,
                                        css: "",
                                        js: "",
                                    },
                                    timestamp: new Date(),
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                };
                                (k && (k.remove(), (k = null)), await Ac(e, t.id), Vc(e, t));
                                continue;
                            }
                            const i =
                                /\[?Êàë?(?:Â∑≤|ÂèëÈÄÅ)?(?:ÂèëÈÄÅ)?[\s\n]*‰∫Ü?[\s\n]*ËØ≠Èü≥\]?\s*[:Ôºö]\s*(?:\[\s*)?(.*?)(?:\s*\])?(?:\s*\[split\]|$)/i,
                                r =
                                    /\[?Êàë?(?:Â∑≤|ÂèëÈÄÅ)?(?:ÂèëÈÄÅ)?[\s\n]*‰∫Ü?[\s\n]*Ë°®ÊÉÖÂåÖ\]?\s*[:Ôºö]?\s*\[?([^\]\n]+)\]?/i,
                                l = /(?:^|\[|\s)ËΩ¨Ë¥¶[:Ôºö]\s*([\d.]+)\s*-\s*([^\]\n\\]+)/,
                                c = /^Êé•Âèó‰∏ÄËµ∑Âê¨Ôºö(.+)/,
                                m = /^ÂèëËµ∑ÈÄöËØùÔºö(.+)/,
                                p = /^ÂèëÊúãÂèãÂúàÔºö(.+?)(?:\[ÂõæÁâáÊèèËø∞Ôºö(.+?)\])?$/,
                                h = /^ËØÑËÆ∫ÊúãÂèãÂúàÔºö(.+)/,
                                v = /^ÊñáÂõæÔºö(.+)/,
                                f = /^ÂºïÁî®ÂõûÂ§çÔºö(.+?)[:Ôºö](.+?)\s*\|\|\|\s*(.+)/,
                                E =
                                    /(?:^|[(\uff08])\s*(?:ÊàëÊâßË°å‰∫Ü)?(?:Âä®‰Ωú|ÊóÅÁôΩ)(?:\/ÊóÅÁôΩ)?\s*[:Ôºö]\s*(.*?)(?:[)\uff09]|$)/,
                                I = /^ÂèëÈÄÅÊñá‰ª∂Ôºö\[(.*?)\]\((.*?)\)/,
                                x = /^ÂèëÈÄÅÊñá‰ª∂Ôºö([A-Za-z0-9]+)\s+ÂÜÖÂÆπÔºö([\s\S]+)/,
                                L = /\[ËΩ¨Ë¥¶Áä∂ÊÄÅ[:Ôºö]\s*(Êé•Êî∂|ÈÄÄÂõû)\]/,
                                B =
                                    /<meta\s+type="status_change"\s+status="([^"]+)"\s+(?:reason="([^"]+)"\s+)?(?:duration="([^"]+)"\s*)?\/?>/i,
                                S = s.match(i),
                                C = s.match(r),
                                $ = s.match(l),
                                M = s.match(c),
                                T = s.match(m),
                                A = s.match(p),
                                D = s.match(h),
                                P = s.match(v),
                                H = s.match(f),
                                O = (s.match(E), s.match(I)),
                                q = (s.match(x), s.match(L)),
                                N = s.match(B);
                            if ($) {
                                const e = parseFloat($[1]).toFixed(2);
                                n = {
                                    sender: "ai",
                                    type: "html",
                                    content: {
                                        html: rg(
                                            e,
                                            $[2].replace(/\\+$/, "").trim(),
                                            Date.now() +
                                            "-" +
                                            Math.random().toString(36).substr(2, 9),
                                            !1,
                                            "pending",
                                        ),
                                    },
                                    text: `[ËΩ¨Ë¥¶ Ôø•${e}]`,
                                };
                            } else if (q) {
                                const e = "Êé•Êî∂" === q[1] ? "accepted" : "refused",
                                    t = document.querySelectorAll(
                                        ".transfer-card.status-pending",
                                    );
                                let n = null;
                                if ((t.length > 0 && (n = t[t.length - 1]), n)) {
                                    const t = n.dataset.uuid;
                                    (n.classList.remove("status-pending", "status-selecting"),
                                        n.classList.add(`status-${e}`));
                                    const a = n.querySelector(".transfer-status-text");
                                    if (
                                        (a &&
                                            (a.textContent = "accepted" === e ? "Â∑≤Êî∂Ê¨æ" : "Â∑≤ÈÄÄÂõû"),
                                            n.removeAttribute("onclick"),
                                            void 0 !== Kl && Sc)
                                    ) {
                                        let n =
                                            (await Kl.loadData("messageContacts", "allContacts"))
                                                .value || [];
                                        const a = n.findIndex((e) => e.id === Sc.id);
                                        if (a > -1) {
                                            const o = n[a].history.find((e) => e.uuid === t);
                                            o &&
                                                ((o.transferStatus = e),
                                                    await Kl.saveData("messageContacts", "allContacts", n),
                                                    console.log(`AIËá™Âä®Êìç‰ΩúÔºöËΩ¨Ë¥¶ ${t} Â∑≤Êõ¥Êñ∞‰∏∫ ${e}`),
                                                    (Sc.history = n[a].history));
                                        }
                                    }
                                }
                                if (((s = s.replace(L, "").trim()), !s)) continue;
                            } else if (N) {
                                const e = N[1],
                                    n = N[2] || "busy",
                                    a = parseInt(N[3] || "60");
                                console.log(
                                    `[OfflineLife] Detected status change: ${e}, reason: ${n}, duration: ${a}m`,
                                );
                                const o = JSON.parse(
                                    localStorage.getItem("offlineLifeConfig") || "{}",
                                );
                                if (o.enabled) {
                                    ((o.currentStatus = e),
                                        (o.statusEndTime = Date.now() + 60 * a * 1e3),
                                        (o.lastReason = n),
                                        localStorage.setItem(
                                            "offlineLifeConfig",
                                            JSON.stringify(o),
                                        ));
                                    const s = "/api/offline-life",
                                        i = (t.history || []).slice(-10).map((e) => ({
                                            sender: e.sender,
                                            text: e.text || e.transcript || "",
                                        }));
                                    (fetch(`${s}/sync`, {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            contactId: t.id || "user_default",
                                            aiName: t.ai?.name || t.name || "AI",
                                            userName: t.user?.name || "Áî®Êà∑",
                                            persona: t.ai?.persona || "",
                                            recentMessages: i,
                                        }),
                                    }).catch((e) =>
                                        console.warn("[OfflineLife] Sync profile failed:", e),
                                    ),
                                        o.enabled &&
                                        "busy" === e &&
                                        (console.log(
                                            `[OfflineLife] Sending status update to Proxy: ${s}`,
                                        ),
                                            fetch(`${s}/status`, {
                                                method: "POST",
                                                headers: {
                                                    "Content-Type": "application/json",
                                                },
                                                body: JSON.stringify({
                                                    contactId: t.id || "user_default",
                                                    status: e,
                                                    reason: n,
                                                    duration: a,
                                                }),
                                            })
                                                .then((e) => {
                                                    if (!e.ok) throw new Error(e.statusText);
                                                    return e.json();
                                                })
                                                .then((e) => {
                                                    console.log("[OfflineLife] Server response:", e);
                                                })
                                                .catch((e) => {
                                                    console.warn(
                                                        "[OfflineLife] Failed to sync status (Proxy might be unavailable):",
                                                        e,
                                                    );
                                                })),
                                        "busy" === e &&
                                        setTimeout(() => {
                                            try {
                                                const e = t.ai.name || "AI",
                                                    a = {
                                                        body: `[MockÊé®ÈÄÅ] ÊàëÁé∞Âú®ÊúâÁÇπ‰∫ã(${n})ÔºåÊôöÁÇπÂõû‰Ω†Ê∂àÊÅØÂìà~`,
                                                        icon: t.ai.avatar,
                                                    };
                                                if ("granted" === Notification.permission)
                                                    if (
                                                        "serviceWorker" in navigator &&
                                                        navigator.serviceWorker.controller
                                                    )
                                                        navigator.serviceWorker.ready.then((t) => {
                                                            t.showNotification(e, a).catch((e) =>
                                                                console.warn("SW Notify failed:", e),
                                                            );
                                                        });
                                                    else
                                                        try {
                                                            new Notification(e, a);
                                                        } catch (e) {
                                                            console.warn("New Notification() failed:", e);
                                                        }
                                                else
                                                    "denied" !== Notification.permission &&
                                                        Notification.requestPermission().then((t) => {
                                                            if ("granted" === t)
                                                                try {
                                                                    new Notification(e, a);
                                                                } catch (e) { }
                                                        });
                                            } catch (e) {
                                                console.error(
                                                    "[OfflineLife] Notification logic crashed, but ignored:",
                                                    e,
                                                );
                                            }
                                        }, 5e3));
                                }
                                if (((s = s.replace(B, "").trim()), !s)) continue;
                            }
                            if (s === u)
                                n = {
                                    sender: "ai",
                                    text: s,
                                };
                            else if (s.includes(w) && b) {
                                const e = b.type.toUpperCase(),
                                    t = (b.content || "").trim();
                                let a = "Êú™ÂëΩÂêçÊñáÊ°£";
                                const o = t.split("\n")[0].trim();
                                if (o) {
                                    let e = o.replace(/\*\*/g, "").replace(/#/g, "").trim();
                                    (e.length > 20 && (e = e.substring(0, 20) + "..."),
                                        e && (a = e));
                                }
                                const s = (e) => {
                                    if (0 === e) return "0 B";
                                    const t = 1024,
                                        n = ["B", "KB", "MB"],
                                        a = Math.floor(Math.log(e) / Math.log(t));
                                    return (
                                        parseFloat((e / Math.pow(t, a)).toFixed(1)) + " " + n[a]
                                    );
                                };
                                n = {
                                    sender: "ai",
                                    type: "file_card",
                                    isSimulated: !0,
                                    fileName: `${a}.${e.toLowerCase()}`,
                                    fileSize: s(2 * t.length),
                                    fileType: e.toLowerCase(),
                                    fileContent: t,
                                    text: `[ÂèëÈÄÅ‰∫ÜÊñá‰ª∂Ôºö${e}ÊñáÊ°£]`,
                                };
                            } else if (S) {
                                let e = S[1].trim().replace(/\\+$/, "");
                                e.includes("[Split]") && (e = e.split("[Split]")[0].trim());
                                const t = e,
                                    a = Math.max(1, Math.ceil(t.length / 3));
                                n = {
                                    sender: "ai",
                                    type: "voice_text",
                                    transcript: t,
                                    duration: a,
                                    text: `[ËØ≠Èü≥Ê∂àÊÅØ ${a}s]`,
                                };
                            } else if (C) {
                                const e = C[1].trim(),
                                    t = o.get(e);
                                if (!t) {
                                    console.warn(`AIÂ∞ùËØïÂèëÈÄÅ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂåÖ: ${e}`);
                                    continue;
                                }
                                n = {
                                    sender: "ai",
                                    type: "sticker",
                                    url: t,
                                    text: `[Ë°®ÊÉÖÂåÖÔºö${e}]`,
                                };
                            } else if ($) {
                                n = {
                                    sender: "ai",
                                    type: "text",
                                    text: `ËΩ¨Ë¥¶Ôºö${$[1].trim()}-${$[2].trim()}`,
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                    transferStatus: "pending",
                                };
                            } else if (P)
                                n = {
                                    sender: "ai",
                                    type: "text-image",
                                    text: P[1].trim(),
                                };
                            else if (O) {
                                const e = O[1],
                                    t = O[2],
                                    a = e.split(".").pop().toLowerCase();
                                n = {
                                    sender: "ai",
                                    type: "file_card",
                                    fileName: e,
                                    fileSize: "‰∏ÉËÅä",
                                    fileType: a,
                                    fileUrl: t,
                                    text: `[ÂèëÈÄÅ‰∫ÜÊñá‰ª∂Ôºö${e}]`,
                                };
                            } else {
                                if (!H) {
                                    if (M) {
                                        k && (k.remove(), (k = null));
                                        const e = M[1].trim();
                                        !1 === zd.active &&
                                            ((zd.active = !0),
                                                (zd.contact = Sc),
                                                await Xd(`${Sc.ai.name} Âä†ÂÖ•‰∫Ü‰∏ÄËµ∑Âê¨`, Sc.id),
                                                Yd());
                                        const n = e
                                            .split(/\\|\\/g)
                                            .map((e) => e.trim())
                                            .filter((e) => e);
                                        for (const e of n) {
                                            const n = {
                                                sender: "ai",
                                                text: e,
                                                timestamp: new Date(),
                                                uuid:
                                                    Date.now() +
                                                    "-" +
                                                    Math.random().toString(36).substr(2, 9),
                                            };
                                            (await Ac(n, t.id), Vc(n, t));
                                        }
                                        continue;
                                    }
                                    if (T) {
                                        k && (k.remove(), (k = null));
                                        const e = T[1].trim();
                                        Sc && Sc.id === t.id && dm(e);
                                        continue;
                                    }
                                    if (A) {
                                        k && (k.remove(), (k = null));
                                        const e = A[1].trim(),
                                            n = A[2] ? A[2].trim() : null;
                                        (await Mu(t, e, n), Iu());
                                        continue;
                                    }
                                    if (D) {
                                        k && (k.remove(), (k = null));
                                        const e = a.postId,
                                            n = D[1].trim();
                                        e && n
                                            ? (await xu(e, n, null, t), Iu())
                                            : console.error("AIÂ∞ùËØïËØÑËÆ∫Â§±Ë¥•ÔºöÁº∫Â∞ëpostIdÊàñËØÑËÆ∫ÊñáÊú¨„ÄÇ");
                                        continue;
                                    }
                                    {
                                        const e = s
                                            .replace(
                                                /(?:[\(Ôºà\*])\s*(?:ÊàëÊâßË°å‰∫Ü)?(?:Âä®‰Ωú|ÊóÅÁôΩ)(?:\/ÊóÅÁôΩ)?\s*[:Ôºö]\s*(.*?)\s*(?:[\)Ôºâ\*])/g,
                                                "*$1*",
                                            )
                                            .split(/(\*[^*]+\*)/g)
                                            .map((e) => e.trim())
                                            .filter((e) => e);
                                        for (const n of e) {
                                            if (
                                                n.startsWith("*") &&
                                                n.endsWith("*") &&
                                                n.length > 2
                                            ) {
                                                const e = {
                                                    sender: "ai",
                                                    type: "action",
                                                    text: n.slice(1, -1).trim(),
                                                    timestamp: new Date(),
                                                    uuid:
                                                        Date.now() +
                                                        "-" +
                                                        Math.random().toString(36).substr(2, 9),
                                                };
                                                (await new Promise((e) => setTimeout(e, 400)),
                                                    await Ac(e, t.id),
                                                    Vc(e, t));
                                            } else {
                                                const e = n
                                                    .split(/\\|\\|\n/g)
                                                    .map((e) => e.trim())
                                                    .filter((e) => e);
                                                for (const n of e) {
                                                    const e = {
                                                        sender: "ai",
                                                        type: "text",
                                                        text: n,
                                                        timestamp: new Date(),
                                                        uuid:
                                                            Date.now() +
                                                            "-" +
                                                            Math.random().toString(36).substr(2, 9),
                                                    };
                                                    let a = k || Yc(t);
                                                    k = null;
                                                    const o = 80,
                                                        s = 800,
                                                        i = 3e3,
                                                        r = Math.min(Math.max(n.length * o, s), i);
                                                    (await new Promise((e) => setTimeout(e, r)),
                                                        await Ac(e, t.id),
                                                        a && a.parentNode && a.remove(),
                                                        Vc(e, t));
                                                }
                                            }
                                        }
                                        continue;
                                    }
                                }
                                {
                                    const e = H[1].trim(),
                                        t = H[2].trim(),
                                        a = H[3].trim();
                                    let o = null;
                                    const s = Je ? Je.history : Sc ? Sc.history : [];
                                    if (s && s.length > 0)
                                        for (let n = s.length - 1; n >= 0; n--) {
                                            const a = s[n],
                                                i = a.text || a.transcript || "";
                                            let r = !1;
                                            if ("user" === a.sender) {
                                                r =
                                                    (Je ? Je.userCardName || "Êàë" : Sc.user.name) === e ||
                                                    "Êàë" === e;
                                            } else {
                                                r = (Je ? a.senderName || "Áæ§Âèã" : Sc.ai.name) === e;
                                            }
                                            if (r && i.includes(t)) {
                                                o = a.uuid;
                                                break;
                                            }
                                        }
                                    n = {
                                        sender: "ai",
                                        text: a,
                                        replyTo: {
                                            senderName: e,
                                            text: t,
                                            uuid: o,
                                        },
                                    };
                                }
                            }
                            if (n) {
                                k && (k.remove(), (k = null));
                                const e = {
                                    ...n,
                                    timestamp: new Date(),
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                };
                                (await Ac(e, t.id), Vc(e, t));
                            }
                        }
                        k && k.remove();
                    })(k, t, a, n)
                );
            a && a.remove();
        } catch (e) {
            (console.error("Ë∞ÉÁî®AIÂ§±Ë¥•:", e),
                a && a.remove(),
                alert(`AIÂõûÂ§çÂ§±Ë¥•: ${e.message}`));
        } finally {
            Qi = !1;
        }
    }
    async function Ac(e, t) {
        try {
            const n = await Kl.loadData("messageContacts", "allContacts");
            let a = n && Array.isArray(n.value) ? n.value : [];
            const o = a.findIndex((e) => e.id === t);
            if (o > -1) {
                const n = a[o];
                if ("location" === e.type)
                    n.lastMessage = "[ÂÆö‰Ωç]";
                else if (
                    "call_summary" !== e.type &&
                    "location_hint" !== e.type &&
                    !e.hidden
                ) {
                    const t = e.text || (e.content && e.content.html) || "";
                    n.lastMessage = Uc(t);
                }

                // SAVE METADATA (without history)
                // Ensure history is stripped from metadata if it accidentally exists
                if (n.history && n.history.length > 0) n.history = [];
                await Kl.saveData("messageContacts", "allContacts", a);

                // SAVE HISTORY (separate key)
                let history = [];
                // 1. Try load from separate store
                const historyData = await Kl.loadData("messageContacts", `history_${t}`);
                if (historyData && Array.isArray(historyData.value)) {
                    history = historyData.value;
                }
                // 2. Fallback: check in-memory Sc
                if (history.length === 0 && Sc && Sc.id === t && Sc.history && Sc.history.length > 0) {
                    history = Sc.history;
                }

                history.push(e);
                await Kl.saveData("messageContacts", `history_${t}`, history);

                // Update in-memory Sc
                if (Sc && Sc.id === t) {
                    Sc.history = history;
                    Sc.lastMessage = n.lastMessage;
                }

                const s = Ni.querySelector(`.contact-item[data-contact-id="${t}"]`);
                s &&
                    (s.querySelector(".contact-last-message").textContent =
                        n.lastMessage);

                const r = history.length;
                r > 0 &&
                    r % 200 == 0 &&
                    "system" !== e.type &&
                    (console.log(`Ê∂àÊÅØÊÄªÊï∞ËææÂà∞ ${r}ÔºåÂáÜÂ§áËß¶ÂèëAIÂèëÊúãÂèãÂúàÔºÅ`),
                        (async function (e, history) {
                            console.log(`ËææÂà∞Ê∂àÊÅØÈòàÂÄºÔºåÊ≠£Âú®Ëß¶Âèë ${e.ai.name} ÂèëÊúãÂèãÂúà...`);
                            try {
                                const t = (history || []).slice(-50);
                                let n = "[ÊúÄËøëÁöÑ50Êù°ËÅäÂ§©ËÆ∞ÂΩï]:\n";
                                t.forEach((t) => {
                                    const a = "user" === t.sender ? e.user.name : e.ai.name,
                                        o = Uc(t.text);
                                    o && (n += `- ${a}: "${o}"\n`);
                                });
                                const a = `(Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†Âíå '${e.user.name}' ÁöÑÂØπËØùÈùûÂ∏∏ÊÑâÂø´„ÄÇ\n        ‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºö\n        1.  ÈòÖËØªÂπ∂ÁêÜËß£‰ª•‰∏äÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï„ÄÇ\n        2.  Ê†πÊçÆËÅäÂ§©ÂÜÖÂÆπÔºåÊèêÁÇº‰∏Ä‰∏™ÊúâË∂£ÊàñÊúâÊÑüËß¶ÁöÑÁû¨Èó¥„ÄÇ\n        3.  „ÄêÂøÖÈ°ª„Äë‰ΩøÁî® "ÂèëÊúãÂèãÂúàÔºö" ÂëΩ‰ª§Ê†ºÂºèÔºåÂèëÂ∏É‰∏ÄÊù°ÂÖ≥‰∫éËøô‰∏™Áû¨Èó¥ÁöÑÊúãÂèãÂúàÂä®ÊÄÅ„ÄÇÂä®ÊÄÅÂÜÖÂÆπË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÇ\n        ËøôÊòØ‰∏Ä‰∏™Âº∫Âà∂Ë¶ÅÊ±ÇÔºå‰Ω†ÂøÖÈ°ªÂèëÂ∏ÉÂä®ÊÄÅ„ÄÇ)\n\n${n}`;
                                await Tc(a, e);
                            } catch (e) {
                                console.error("Ëß¶ÂèëAIÂèëÊúãÂèãÂúàÂ§±Ë¥•:", e);
                            }
                        })(n, history));
            }
        } catch (e) {
            console.error("‰øùÂ≠òÊ∂àÊÅØÂ§±Ë¥•:", e);
        }
    }
    async function Dc(e) {
        if (!Sc && !Je) return;
        let t;
        if ("string" == typeof e) {
            t = {
                type: "text",
                text: e.trim(),
            };
        } else t = e;
        Ve &&
            ((t.replyTo = {
                uuid: Ve.uuid,
                text: Ve.text,
                senderName: Ve.senderName,
            }),
                Xm());
        const n = {
            sender: "user",
            timestamp: new Date(),
            uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
            ...t,
        };
        if (Je) (await Nm(n, Je.id), Wm(n));
        else {
            if (!Sc)
                return void console.error("ÈîôËØØÔºöÂΩìÂâçÊ≤°ÊúâÊâìÂºÄ‰ªª‰Ωï‰ºöËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ");
            {
                await Ac(n, Sc.id);
                const e = Sc.history,
                    t = e && e.length > 1 ? e[e.length - 2] : null,
                    a = t ? new Date(t.timestamp).getTime() : 0;
                Vc(n, Sc, null, a);
            }
        }
        (Xi.scrollTo({
            top: Xi.scrollHeight,
            behavior: "smooth",
        }),
            (xo.value = ""));
        let a = !1;
        if (Sc) {
            const e = JSON.parse(localStorage.getItem("offlineLifeConfig") || "{}");
            e.enabled &&
                "busy" === e.currentStatus &&
                Date.now() < (e.statusEndTime || 0) &&
                (console.log("[OfflineLife] AI is busy, intercepting reply."),
                    (a = !0),
                    setTimeout(async () => {
                        const t = {
                            uuid: Date.now().toString(),
                            role: "system",
                            content: `ÂØπÊñπÊ≠£Âú®ÂøôÁ¢å‰∏≠(${e.lastReason || "Êú™Áü•ÂéüÂõ†"})ÔºåÊÇ®ÁöÑÊ∂àÊÅØÂ∑≤ÁïôË®Ä„ÄÇ`,
                            timestamp: new Date().toLocaleTimeString([], {
                                hour: "2-digit",
                                minute: "2-digit",
                            }),
                            isSystem: !0,
                            forceShow: !0,
                        };
                        Sc.history.push(t);
                        const n = document.getElementById("chat-messages-container");
                        if (n) {
                            const e = document.createElement("div");
                            ((e.className = "message-row system-message-row"),
                                (e.innerHTML = `<div style="width:100%; text-align:center; color:#999; font-size:12px; margin: 10px 0;">${t.content}</div>`),
                                n.appendChild(e),
                                (n.scrollTop = n.scrollHeight));
                        }
                        await Kl.saveData("messageContacts", "allContacts", Ye);
                    }, 600));
        }
    }

    function Pc() {
        Xi.querySelectorAll(".message-row").forEach((e, t) => {
            e.classList.remove(
                "group-start",
                "group-middle",
                "group-end",
                "group-single",
            );
        });
        const e = Array.from(Xi.children);
        let t = [],
            n = null;
        (e.forEach((e) => {
            if (
                e.classList.contains("message-row") &&
                !e.classList.contains("system-message-row") &&
                e.dataset.senderId
            ) {
                const a = e.dataset.senderId;
                a === n ? t.push(e) : (t.length > 0 && Hc(t), (t = [e]), (n = a));
            } else (t.length > 0 && (Hc(t), (t = [])), (n = null));
        }),
            t.length > 0 && Hc(t));
    }

    function Hc(e) {
        if (1 === e.length) e[0].classList.add("group-single");
        else {
            (e[0].classList.add("group-start"),
                e[e.length - 1].classList.add("group-end"));
            for (let t = 1; t < e.length - 1; t++) e[t].classList.add("group-middle");
        }
    }

    function Oc(e) {
        (Xi &&
            !Xi.classList.contains("chat-messages") &&
            Xi.classList.add("chat-messages"),
            (vr.innerHTML = e.customBubbleCss || Rc));
        const t = e.chatBackground || e.backgroundImage;
        t
            ? ((Xi.style.backgroundImage = `url('${t}')`),
                (Xi.style.backgroundSize = "cover"),
                (Xi.style.backgroundPosition = "center"),
                (Xi.style.backgroundRepeat = "no-repeat"))
            : ((Xi.style.backgroundImage = ""),
                (Xi.style.backgroundSize = ""),
                (Xi.style.backgroundPosition = ""),
                (Xi.style.backgroundRepeat = ""));
        const n = e.avatarSettings || {
            show: !0,
            radius: "50%",
        },
            a = void 0 !== n.showChar ? n.showChar : !1 !== n.show,
            o = void 0 !== n.showUser ? n.showUser : !1 !== n.show;
        (Xi.classList.toggle("hide-char-avatar", !a),
            Xi.classList.toggle("hide-user-avatar", !o));
        const s = !0 === e.bubbleBMode;
        (Xi.classList.toggle("bubble-b-mode", s), s && Pc());
        let i = "";
        (e.ai.avatarPendant &&
            e.ai.avatarPendant.css &&
            (i += `#chat-screen.contact-${e.id} .message-content-wrapper.ai .avatar-pendant { ${e.ai.avatarPendant.css} } \n`),
            e.user.avatarPendant &&
            e.user.avatarPendant.css &&
            (i += `#chat-screen.contact-${e.id} .message-content-wrapper.user .avatar-pendant { ${e.user.avatarPendant.css} } \n`),
            (gn.innerHTML = i));
        const r = e.timestampSettings || {
            show: !1,
        };
        Xi && Xi.classList.toggle("hide-timestamps", !r.show);
    }
    ((window.callAI = Tc),
        (window.saveMessageToHistory = Ac),
        (window.addMessageToView = Vc),
        (window.initializeChatStyles = Oc));
    let qc = null;
    async function Nc(e, t = {}) {
        performance.now();
        console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        console.log(`üöÄ [ÊÄßËÉΩÁõëÊéß] ÂºÄÂßãÊâìÂºÄËÅäÂ§©Á™óÂè£ | ËÅîÁ≥ª‰∫∫ID: ${e}`);
        qc && (clearTimeout(qc), (qc = null));
        console.log(`Ê≠£Âú®ÊâìÂºÄËÅäÂ§©Á™óÂè£: ${e}`);
        document
            .querySelectorAll('style[id^="dynamic-chat-style-"]')
            .forEach((e) => e.remove());
        Je = null;
        Ip(e);
        ko || (Vu(), (ko = !0));
        Yi.classList.remove("emoji-panel-active");
        Yi.style.backgroundImage = "";
        Yi.style.backgroundColor = "";
        console.log(`[openChatView] ‚ö° Optimizing: Loading single contact ${e} directly...`);
        let n = null;
        try {
            // Plan A: Directly load the specific contact (c_ID)
            const contactData = await Kl.loadData("messageContacts", `c_${e}`);
            if (contactData && contactData.value) {
                // Construct a fake object structure to match expected 'n' format downstream or just set Sc directly
                // The original code expected n.value to be an array and then found Sc inside it.
                // We will bypass that and directly set Sc.
                Sc = contactData.value;
                // We verify Sc.id matches e just to be safe
                if (Sc && Sc.id != e && Sc.id != parseInt(e)) {
                    console.warn("ID Mismatch in single load, falling back to legacy...");
                    Sc = null;
                }
            }
        } catch (err) {
            console.error("[openChatView] Single load failed:", err);
        }

        // Fallback: If single load fails or returns nothing (legacy data?), try the old heavy way
        if (!Sc) {
            console.warn("[openChatView] üê¢ Fallback: Loading ALL contacts (Legacy Mode)...");
            n = await Kl.loadData("messageContacts", "allContacts");
            if (!n || !Array.isArray(n.value))
                return void console.error("Êó†Ê≥ïÂä†ËΩΩËÅîÁ≥ª‰∫∫Êï∞ÊçÆ");
            Sc = n.value.find((t) => t.id === e);
        }

        if (!Sc)
            return void console.error(`Êâæ‰∏çÂà∞ ID ‰∏∫ ${e} ÁöÑËÅîÁ≥ª‰∫∫`);
        const a = document.getElementById("block-status-notice");
        (Sc.isBlocked
            ? ((a.textContent = `‰Ω†Â∑≤ÊãâÈªë ${Sc.ai.name}`),
                (a.style.display = "block"))
            : (a.style.display = "none"),
            (Zi.textContent = Sc.ai.name),
            (Yi.className = `screen contact-${Sc.id}`),
            Xi &&
            ((Xi.dataset.contextMode = "single"), (Xi.dataset.contextId = Sc.id)));
        if (Sc) {
            if (!Sc.history || 0 === Sc.history.length) {
                const h = await Kl.loadData("messageContacts", `history_${Sc.id}`);
                h && Array.isArray(h.value) && (Sc.history = h.value);
            }
        }
        const o = (Sc && Array.isArray(Sc.history)) ? Sc.history : [],
            s = o.length,
            i = s > 50 ? o.slice(-50) : o;
        ((Sc._loadedMessageRange = {
            start: Math.max(0, s - i.length),
            end: s,
        }),
            console.log(`üì¶ [ÂàÜÈ°µÂä†ËΩΩ] ÊÄªÊ∂àÊÅØÊï∞: ${s}Êù°`),
            console.log(`__ [ÂàÜÈ°µÂä†ËΩΩ] ÂàùÂßãÊ∏≤Êüì: ${i.length}Êù°`));
        const r = document.createDocumentFragment();
        let l = [];
        if (((Xi.innerHTML = ""), t.targetMessageUuid)) {
            if (-1 !== i.findIndex((e) => e.uuid === t.targetMessageUuid)) l = i;
            else {
                const e = o.findIndex((e) => e.uuid === t.targetMessageUuid);
                if (-1 !== e) {
                    const t = Math.max(0, e - 30),
                        n = Math.min(o.length, e + 30);
                    ((l = o.slice(t, n)),
                        (Sc._loadedMessageRange = {
                            start: t,
                            end: n,
                        }));
                } else l = i;
            }
            if (Sc._loadedMessageRange.start > 0) {
                const e = document.createElement("button");
                ((e.id = "load-more-messages-btn"),
                    (e.textContent = "Êü•ÁúãÊõ¥Êó©ÁöÑÊ∂àÊÅØ"),
                    e.addEventListener("click", _c),
                    Xi.appendChild(e));
            }
        } else if (((l = i), s > l.length)) {
            const e = document.createElement("button");
            ((e.id = "load-more-messages-btn"),
                (e.textContent = "Êü•ÁúãÊõ¥Êó©ÁöÑÊ∂àÊÅØ"),
                e.addEventListener("click", _c),
                Xi.appendChild(e));
        }
        let c = 0;
        const BATCH_SIZE = 6;
        const MAX_CHAT_DOM = 250;

        // ÂàÜÊâπÊ∏≤ÊüìÂáΩÊï∞
        const batchRender = async (messages, batchIndex = 0) => {
            const end = Math.min(batchIndex + BATCH_SIZE, messages.length);
            const batch = messages.slice(batchIndex, end);

            const batchFragment = document.createDocumentFragment();
            batch.forEach((e) => {
                Vc(e, Sc, batchFragment, c);
                c = new Date(e.timestamp).getTime();
            });

            Xi.appendChild(batchFragment);

            // DOM Ë£ÅÂâ™ÔºöÈò≤Ê≠¢ DOM ËäÇÁÇπËøáÂ§ö
            const messageRows = Xi.querySelectorAll(".message-row");
            if (messageRows.length > MAX_CHAT_DOM) {
                const toRemove = messageRows.length - MAX_CHAT_DOM;
                for (let i = 0; i < toRemove; i++) {
                    messageRows[i].remove();
                }
            }

            if (end < messages.length) {
                // ÁªßÁª≠‰∏ã‰∏ÄÊâπ
                await new Promise((resolve) => {
                    if (typeof requestIdleCallback !== "undefined") {
                        requestIdleCallback(
                            () => {
                                batchRender(messages, end).then(resolve);
                            },
                            { timeout: 100 },
                        );
                    } else {
                        setTimeout(() => {
                            batchRender(messages, end).then(resolve);
                        }, 40);
                    }
                });
            }
        };

        await batchRender(l);
        c = 0;
        (Oc(Sc),
            Yi.classList.remove("settled"),
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if ((Ii.classList.add("show-chat"), t.targetMessageUuid)) {
                        const e = Xi.querySelector(
                            `.message-row[data-uuid="${t.targetMessageUuid}"]`,
                        );
                        e &&
                            e.scrollIntoView({
                                behavior: "auto",
                                block: "center",
                            });
                    } else Xi.scrollTop = Xi.scrollHeight;
                });
            }),
            setTimeout(() => {
                Ii.classList.contains("show-chat") && Yi.classList.add("settled");
            }, 380),
            l.forEach((e) => {
                if ("html" === e.type && e.content) {
                    const t = Xi.querySelector(
                        `.html-render-container[id='html-render-${e.uuid}']`,
                    );
                    if (t) {
                        if (e.content.css) {
                            const n = document.createElement("style"),
                                a = t.id,
                                o = e.content.css.replace(
                                    /([^\r\n,{}]+)(,(?=[^}]*{)|s*\{)/g,
                                    `#${a} $1 `,
                                );
                            ((n.textContent = o), document.head.appendChild(n));
                        }
                        if (e.content.js || e.content.script)
                            try {
                                new Function(e.content.js || e.content.script)();
                            } catch (e) {
                                console.error("[HTMLÊ∂àÊÅØËÑöÊú¨ÊâßË°åÂ§±Ë¥•]", e);
                            }
                    }
                }
            }),
            xo.blur());
    }
    async function _c() {
        if (!Sc) return;
        const e = document.getElementById("load-more-messages-btn");
        if (!e) return;
        const t = Xi.scrollHeight,
            n = Xi.scrollTop,
            a = Array.isArray(Sc.history) ? Sc.history : [],
            o = Sc._loadedMessageRange || {
                start: 0,
                end: a.length,
            };
        if (
            (console.log(`[LoadMore] ÂºÄÂßãÂä†ËΩΩ: Start=${o.start}, Total=${a.length}`),
                o.start <= 0)
        )
            return (
                (e.textContent = "Â∑≤Âä†ËΩΩÂÖ®ÈÉ®Ê∂àÊÅØ"),
                (e.disabled = !0),
                (e.style.opacity = "0.5"),
                void (e.style.cursor = "default")
            );
        const s = Math.max(0, o.start - 30),
            i = a.slice(s, o.start);
        if (
            (console.log(
                `[LoadMore] ÊèêÂèñÊï∞ÊçÆ: Á¥¢Âºï ${s} - ${o.start}, Êï∞Èáè: ${i.length}`,
            ),
                0 === i.length)
        )
            return void console.warn("[LoadMore] ÂºÇÂ∏∏ÔºöÊèêÂèñÂà∞ÁöÑÊ∂àÊÅØÊï∞Èáè‰∏∫0");
        const r = document.createDocumentFragment();
        let l = s > 0 && a[s - 1] ? new Date(a[s - 1].timestamp).getTime() : 0;
        (i.forEach((e, t) => {
            (Vc(e, Sc, r, l), (l = new Date(e.timestamp).getTime()));
        }),
            e.nextSibling ? Xi.insertBefore(r, e.nextSibling) : Xi.appendChild(r),
            (Sc._loadedMessageRange.start = s),
            Xi.classList.contains("bubble-b-mode") && Pc());
        const c = Xi.scrollHeight,
            d = c - t;
        (console.log(
            `[LoadMore] ÊªöÂä®Ë∞ÉÊï¥: OldH=${t}, NewH=${c}, Limit reached=${0 === s}`,
        ),
            (Xi.scrollTop = n + d),
            0 === s &&
            ((e.textContent = "Â∑≤Âä†ËΩΩÂÖ®ÈÉ®Ê∂àÊÅØ"),
                (e.disabled = !0),
                (e.style.opacity = "0.5"),
                (e.style.cursor = "default"),
                (e.style.border = "none")));
    }

    function Fc() {
        (console.log("[DEBUG] closeChatView: START"),
            su.classList.remove("visible"),
            Yi.classList.remove("settled"),
            Sc &&
            (function (e) {
                if (!ne.enabled || !ne.targets.includes(e)) return;
                (Ip(e),
                    console.log(
                        `[‰∏ªÂä®Ê∂àÊÅØ] ÂºÄÂßã‰∏∫ËÅîÁ≥ª‰∫∫ ${e} ËÆ°Êó∂: ${ne.interval} ÂàÜÈíü`,
                    ));
                const t = 60 * ne.interval * 1e3;
                Q[e] = window.TimerManager.setTimeout(
                    async () => {
                        (console.log(`[‰∏ªÂä®Ê∂àÊÅØ] Êó∂Èó¥Âà∞ÔºÅËß¶ÂèëËÅîÁ≥ª‰∫∫ ${e}`), await xp(e));
                    },
                    t,
                    "proactive",
                );
            })(Sc.id),
            Ii.classList.remove("show-chat"),
            console.log("[DEBUG] closeChatView: Animation started"),
            qc && clearTimeout(qc),
            (qc = setTimeout(() => {
                ((Sc = null),
                    (Je = null),
                    (Xi.textContent = ""),
                    console.log("[DEBUG] closeChatView: Cleanup completed"),
                    (qc = null));
            }, 350)));
    }
    ((window.openChatView = Nc),
        Ni.addEventListener("click", (e) => {
            if (
                Ni.classList.contains("delete-mode") &&
                e.target.classList.contains("contact-checkbox")
            )
                return;
            const t = e.target.closest(".contact-item");
            if (t)
                if (t.dataset.groupId) {
                    qm(parseInt(t.dataset.groupId, 10));
                } else if (t.dataset.contactId) {
                    Nc(parseInt(t.dataset.contactId, 10));
                }
        }),
        Ki.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("chat-messages-container"),
                console.log("[DEBUG] Back button clicked"),
                Fc(),
                setTimeout(() => {
                    console.log("[DEBUG] Starting renderMessagesList");
                    const e = performance.now();
                    Dm()
                        .then(() => {
                            const t = performance.now();
                            console.log(
                                `[DEBUG] renderMessagesList completed in ${(t - e).toFixed(2)}ms`,
                            );
                        })
                        .catch((e) => {
                            console.error("[DEBUG] renderMessagesList error:", e);
                        });
                }, 50));
        }));
    const Rc =
        ".user-bubble {\n    align-self: flex-end;\n    max-width: 85%;\n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #D1D9D3;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #2F3633; \n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);\n    border-left: 1px solid rgba(255, 255, 255, 0.05);\n    margin-bottom: 0px;\n}\n.ai-bubble {\n    align-self: flex-start;\n    max-width: 85%;\n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #5F6360;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #E8EAE9;\n    border: none;\n    margin-bottom: 0px;\n}";

    function Gc() {
        ((er.style.opacity = "0"),
            (er.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                er.style.display = "none";
            }, 300));
    }
    ((tr.onclick = () => {
        (console.log(
            "[ChatSettings] Button clicked. currentOpenGroup:",
            Je,
            "currentOpenContact:",
            Sc,
        ),
            Je
                ? (console.log("[ChatSettings] Opening group settings..."),
                    (async function () {
                        if (!Je)
                            return void console.warn(
                                "[openGroupInfoModal] No currentOpenGroup, returning",
                            );
                        console.log(
                            "[openGroupInfoModal] Function called, currentOpenGroup:",
                            Je.name,
                        );
                        const e = document.getElementById("group-settings-page");
                        if (!e)
                            return void console.error(
                                "[openGroupInfoModal] group-settings-page not found",
                            );
                        (console.log(
                            "[openGroupInfoModal] Found group-settings-page element",
                        ),
                            (At.textContent = Je.name));
                        const t =
                            Je.avatar || "https://placehold.co/100x100/orange/white?text=Áæ§";
                        wt.style.backgroundImage = `url('${t}')`;
                        const n = Je.userCardName || "Êàë",
                            a =
                                Je.userCardAvatar ||
                                "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";
                        ((kt.textContent = n),
                            (xt.style.backgroundImage = `url('${a}')`),
                            await _m());
                        const o = document.getElementById(
                            "group-worldbook-select-container",
                        );
                        "function" == typeof window.renderWorldBookMultiselect
                            ? await window.renderWorldBookMultiselect(o, Je, !0)
                            : (o.innerHTML = "ÁªÑ‰ª∂Êú™Â∞±Áª™");
                        const s = document.getElementById("group-chat-bg-preview"),
                            i = document.getElementById("group-chat-bg-placeholder"),
                            r = document.getElementById("group-chat-bg-preview-box");
                        Je.chatBackground
                            ? (s &&
                                ((s.src = Je.chatBackground), (s.style.display = "block")),
                                i && (i.style.display = "none"),
                                r && r.classList.add("has-bg"))
                            : (s && (s.style.display = "none"),
                                i && (i.style.display = "flex"),
                                r && r.classList.remove("has-bg"));
                        e.querySelectorAll(".collapsible-section").forEach((e) => {
                            e.classList.remove("expanded");
                        });
                        const l = Je.avatarSettings || {
                            show: !0,
                        },
                            c = Je.timestampSettings || {
                                show: !1,
                            },
                            d = document.getElementById("group-show-avatars-toggle"),
                            u = document.getElementById("group-show-timestamp-toggle");
                        d &&
                            (!1 !== l.show
                                ? d.classList.add("active")
                                : d.classList.remove("active"));
                        u &&
                            (!0 === c.show
                                ? u.classList.add("active")
                                : u.classList.remove("active"));
                        const m = document.getElementById("group-bilingual-bubble-toggle"),
                            p = Je.bilingualBubble || {
                                enabled: !1,
                            };
                        m &&
                            (!0 === p.enabled
                                ? m.classList.add("active")
                                : m.classList.remove("active"));
                        (e.classList.remove("closing"), e.classList.add("active"));
                    })())
                : Sc
                    ? (console.log("[ChatSettings] Opening chat settings page..."),
                        window.openChatSettingsPage())
                    : console.warn("[ChatSettings] Neither group nor contact is open!"));
    }),
        nr.addEventListener("click", Gc),
        dn.addEventListener("click", () => {
            ((ln.value = ""),
                (cn.value = ""),
                alert("ËßíËâ≤ÊåÇ‰ª∂ËÆæÁΩÆÂ∑≤Âú®ËæìÂÖ•Ê°Ü‰∏≠Ê∏ÖÁ©∫ÔºåÁÇπÂáª‚Äú‰øùÂ≠òËÆæÁΩÆ‚ÄùÂêéÁîüÊïà„ÄÇ"));
        }),
        pn.addEventListener("click", () => {
            ((un.value = ""),
                (mn.value = ""),
                alert("Áî®Êà∑ÊåÇ‰ª∂ËÆæÁΩÆÂ∑≤Âú®ËæìÂÖ•Ê°Ü‰∏≠Ê∏ÖÁ©∫ÔºåÁÇπÂáª‚Äú‰øùÂ≠òËÆæÁΩÆ‚ÄùÂêéÁîüÊïà„ÄÇ"));
        }),
        or.addEventListener("change", () => {
            const e = or.checked;
            (sr.classList.toggle("active", !e), ir.classList.toggle("active", e));
            const t = er.querySelectorAll(".switch-label");
            (t[0].classList.toggle("active", !e), t[1].classList.toggle("active", e));
        }),
        lr.addEventListener("change", () => Ec(lr, rr)),
        dr.addEventListener("change", () => Ec(dr, cr)),
        mr.addEventListener("click", () => {
            ur.value = Rc;
        }),
        hr.addEventListener("click", async () => {
            if (
                Sc &&
                confirm(
                    "Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ÂØπËØùÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü",
                )
            )
                try {
                    let e =
                        (await Kl.loadData("messageContacts", "allContacts")).value || [];
                    const t = e.findIndex((e) => e.id === Sc.id);
                    if (!(t > -1)) throw new Error("Âú®Êï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞ÂΩìÂâçËÅîÁ≥ª‰∫∫„ÄÇ");
                    {
                        ((e[t].history = []),
                            (e[t].lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"),
                            await Kl.saveData("messageContacts", "allContacts", e),
                            (Sc.history = []),
                            (Sc.lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"),
                            (Xi.innerHTML = ""));
                        const n = Ni.querySelector(
                            `.contact-item[data-contact-id="${Sc.id}"]`,
                        );
                        (n &&
                            (n.querySelector(".contact-last-message").textContent =
                                "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"),
                            alert("ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊ∏ÖÈô§ÔºÅ"));
                    }
                } catch (e) {
                    (console.error("Ê∏ÖÈô§ËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:", e),
                        alert(`Êìç‰ΩúÂ§±Ë¥•: ${e.message}`));
                }
        }),
        ar &&
        ar.addEventListener("click", async () => {
            if (Sc)
                try {
                    const e = await Kl.loadData("messageContacts", "allContacts");
                    let t = e && Array.isArray(e.value) ? e.value : [];
                    const n = t.findIndex((e) => e.id === Sc.id);
                    if (!(n > -1)) throw new Error("Âú®Êï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞Ë¶Å‰øùÂ≠òÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
                    {
                        const e = document.getElementById("ai-name-input-settings"),
                            a = document.getElementById("ai-persona-input-settings"),
                            o = document.getElementById("ai-avatar-preview-settings"),
                            s = document.getElementById("user-name-input-settings"),
                            i = document.getElementById("user-persona-input-settings"),
                            r = document.getElementById("user-avatar-preview-settings"),
                            l = document.getElementById("context-memory-input-settings"),
                            c = document.getElementById("bubble-css-input"),
                            d = document.getElementById("avatar-radius-input"),
                            u = document.getElementById("show-avatars-toggle"),
                            m = document.getElementById("ai-pendant-url-input"),
                            p = document.getElementById("ai-pendant-css-input"),
                            g = document.getElementById("user-pendant-url-input"),
                            y = document.getElementById("user-pendant-css-input");
                        ((t[n].ai.name = e.value.trim()),
                            (t[n].ai.persona = a.value.trim()),
                            (t[n].ai.avatar = o.src),
                            t[n].user || (t[n].user = {}),
                            (t[n].user.name = s.value.trim()),
                            (t[n].user.persona = i.value.trim()),
                            (t[n].user.avatar = r.src),
                            (t[n].contextMemory = parseInt(l.value, 10)),
                            (t[n].enableDefaultStickers = !0));
                        const h = document.getElementById("enable-wb-stickers-toggle");
                        ((t[n].enableWBStickers = !!h && h.checked),
                            (t[n].customBubbleCss = c.value));
                        const v = document.getElementById("chat-show-char-avatar-toggle"),
                            f = document.getElementById("chat-show-user-avatar-toggle");
                        t[n].avatarSettings = {
                            showChar: v ? v.classList.contains("active") : !u || u.checked,
                            showUser: f ? f.classList.contains("active") : !u || u.checked,
                            show: !u || u.checked,
                            radius: d.value.trim() || "50%",
                        };
                        const w = document.getElementById("chat-bubble-b-mode-toggle");
                        t[n].bubbleBMode = !!w && w.classList.contains("active");
                        const b = document.getElementById("show-timestamps-toggle");
                        t[n].timestampSettings = {
                            show: !!b && b.checked,
                        };
                        const E = document.getElementById("enable-monologue-toggle");
                        t[n].enableMonologue = !E || E.checked;
                        const I = document.getElementById(
                            "enable-bilingual-bubble-toggle",
                        );
                        t[n].enableBilingualBubble = !!I && I.checked;
                        const x = document.getElementById("chat-messages-container"),
                            k = x ? x.style.backgroundImage : "";
                        if (k && k.startsWith("url(")) {
                            const e = k.match(/url\(['"]?([^'"]+)['"]?\)/);
                            t[n].chatBackground = e ? e[1] : null;
                        } else t[n].chatBackground = null;
                        ((t[n].backgroundImage = t[n].chatBackground),
                            (t[n].ai.avatarPendant = {
                                url: m.value.trim(),
                                css: p.value.trim(),
                            }),
                            t[n].user.avatarPendant || (t[n].user.avatarPendant = {}),
                            (t[n].user.avatarPendant = {
                                url: g.value.trim(),
                                css: y.value.trim(),
                            }),
                            (t[n].linkedWorldBookIds = Sc.linkedWorldBookIds || []),
                            delete t[n].linkedWorldBookGroupIds,
                            (Sc = t[n]));
                    }
                    if (
                        (await Kl.saveData("messageContacts", "allContacts", t),
                            (Ye = t),
                            void 0 !== N && N && String(N.id) === String(Sc.id))
                    ) {
                        (console.log("Ê£ÄÊµãÂà∞ WOW Ë∫´‰ªΩ‰ø°ÊÅØÂèòÊõ¥ÔºåÊ≠£Âú®ÂêåÊ≠•..."), (N = Sc));
                        const e = document.getElementById("wow-current-avatar");
                        (e && (e.src = Sc.user.avatar), qp(), Np());
                    }
                    (jc(Sc), (Zi.textContent = Sc.ai.name));
                    const a = Ni.querySelector(
                        `.contact-item[data-contact-id="${Sc.id}"]`,
                    );
                    (a &&
                        ((a.querySelector(".contact-name").textContent = Sc.ai.name),
                            (a.querySelector(".contact-avatar").src = Sc.ai.avatar)),
                        Bl(Sc));
                    try {
                        const e = `messages_${Sc.id}`,
                            t = await Kl.loadData("chatMessages", e),
                            n = t && Array.isArray(t.value) ? t.value : [],
                            a = document.createDocumentFragment(),
                            o = n.slice(-30),
                            s = Xi.querySelector("#load-more-messages-btn");
                        if (((Xi.innerHTML = ""), s)) Xi.appendChild(s);
                        else if (n.length > 30) {
                            const e = document.createElement("button");
                            ((e.id = "load-more-messages-btn"),
                                (e.textContent = "Êü•ÁúãÊõ¥Êó©ÁöÑÊ∂àÊÅØ"),
                                e.addEventListener("click", _c),
                                Xi.appendChild(e));
                        }
                        (o.forEach((e) => {
                            Vc(e, Sc, a);
                        }),
                            Xi.appendChild(a),
                            Oc(Sc),
                            (Xi.scrollTop = Xi.scrollHeight),
                            console.log("ËÅäÂ§©Ê∂àÊÅØÂ∑≤Âà∑Êñ∞ÔºåËÆæÁΩÆÂ∑≤ÁîüÊïà"));
                    } catch (e) {
                        console.warn("Âà∑Êñ∞Ê∂àÊÅØÂ§±Ë¥•ÔºåÈúÄË¶ÅÈÄÄÂá∫ÈáçËøõ:", e);
                    }
                    (Gc(), alert("ËÆæÁΩÆÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ"));
                } catch (e) {
                    (console.error("‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÂ§±Ë¥•:", e),
                        alert(`‰øùÂ≠òÂ§±Ë¥•: ${e.message}`));
                }
        }));
    const Wc = document.getElementById("block-contact-btn");

    function jc(e) {
        (Xi &&
            !Xi.classList.contains("chat-messages") &&
            Xi.classList.add("chat-messages"),
            (vr.innerHTML = e.customBubbleCss || Rc));
        const t = e.chatBackground || e.backgroundImage;
        t
            ? ((Xi.style.backgroundImage = `url('${t}')`),
                (Xi.style.backgroundSize = "cover"),
                (Xi.style.backgroundPosition = "center"),
                (Xi.style.backgroundRepeat = "no-repeat"))
            : ((Xi.style.backgroundImage = ""),
                (Xi.style.backgroundSize = ""),
                (Xi.style.backgroundPosition = ""),
                (Xi.style.backgroundRepeat = ""));
        const n = e.avatarSettings || {
            show: !0,
            radius: "50%",
        };
        (void 0 !== n.showChar || void 0 !== n.showUser
            ? (Xi.classList.toggle("hide-char-avatar", !1 === n.showChar),
                Xi.classList.toggle("hide-user-avatar", !1 === n.showUser))
            : Xi.classList.toggle("hide-avatars", !n.show),
            Xi.classList.toggle("bubble-b-mode", !0 === e.bubbleBMode),
            !0 === e.bubbleBMode && Pc());
        document
            .querySelectorAll("#chat-messages-container .message-row")
            .forEach((t) => {
                const a = t.querySelector(".chat-avatar");
                (a &&
                    (t.querySelector(".message-content-wrapper.user")
                        ? (a.src = e.user.avatar)
                        : (a.src = e.ai.avatar),
                        (a.style.borderRadius = n.radius)),
                    Jc(t, e));
            });
        let a = "";
        (e.ai.avatarPendant &&
            e.ai.avatarPendant.css &&
            (a += `#chat-screen.contact-${e.id} .message-content-wrapper.ai .avatar-pendant { ${e.ai.avatarPendant.css} } \n`),
            e.user.avatarPendant &&
            e.user.avatarPendant.css &&
            (a += `#chat-screen.contact-${e.id} .message-content-wrapper.user .avatar-pendant { ${e.user.avatarPendant.css} } \n`),
            (gn.innerHTML = a));
    }

    function Uc(e) {
        if ("string" != typeof e) return "";
        if (Ju(e)) return e.includes("transfer-card") ? "[ËΩ¨Ë¥¶]" : "[HTMLÊ∂àÊÅØ]";
        if (e.includes("[STICKER_START]") || e.includes("Ë°®ÊÉÖÂåÖÔºö"))
            return "[Ë°®ÊÉÖÂåÖ]";
        const t = e.match(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/);
        return t && t[1]
            ? t[1].trim()
            : /^\[?ËΩ¨Ë¥¶[:Ôºö]/.test(e)
                ? "[ËΩ¨Ë¥¶]"
                : e.includes("ÂèëÊúãÂèãÂúàÔºö")
                    ? "[ÊúãÂèãÂúàÂä®ÊÄÅ]"
                    : e.includes("ÂºïÁî®ÂõûÂ§çÔºö")
                        ? "[ÂºïÁî®ÂõûÂ§ç]"
                        : e;
    }

    function zc(e) {
        if (!e) return "";
        let t = e
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        return (
            (t = t.replace(
                /\*([^*]+)\*/g,
                '<span style="color: #888; font-style: italic;">* $1 *</span>',
            )),
            (t = t.replace(
                /[\(Ôºà]\s*(?:ÊàëÊâßË°å‰∫Ü)?(?:Âä®‰Ωú|ÊóÅÁôΩ)(?:\/ÊóÅÁôΩ)?\s*[:Ôºö]\s*(.*?)\s*[)Ôºâ]/g,
                '<span style="color: #888; font-style: italic;">* $1 *</span>',
            )),
            t
        );
    }

    function Vc(e, t = null, n = null, a = null) {
        const o = n || Xi;
        if (!e) return null;
        const s = new Date(e.timestamp).getTime();
        let i = !1;
        if (
            (a
                ? s - a > 12e4 && (i = !0)
                : (n || (o && 0 === o.children.length)) && (i = !0),
                i)
        ) {
            const e = document.createElement("div");
            ((e.className = "chat-time-separator"),
                (e.textContent = (function (e) {
                    if (!e) return "";
                    const t = new Date(e),
                        n = new Date(),
                        a =
                            n.getDate() === t.getDate() &&
                            n.getMonth() === t.getMonth() &&
                            n.getFullYear() === t.getFullYear(),
                        o = new Date(n);
                    o.setDate(n.getDate() - 1);
                    const s =
                        o.getDate() === t.getDate() &&
                        o.getMonth() === t.getMonth() &&
                        o.getFullYear() === t.getFullYear(),
                        i = String(t.getHours()).padStart(2, "0"),
                        r = String(t.getMinutes()).padStart(2, "0");
                    return a
                        ? `${i}:${r}`
                        : s
                            ? `Êò®Â§© ${i}:${r}`
                            : `${t.getMonth() + 1}Êúà${t.getDate()}Êó• ${i}:${r}`;
                })(s)),
                o.appendChild(e));
        }
        if ("system" === e.type) {
            const t = document.createElement("div");
            return (
                (t.className = "system-notification"),
                (t.textContent = e.text),
                o.appendChild(t),
                t
            );
        }
        if ("call_summary" === e.type) return null;
        if (e.isHidden) return null;
        const r = t || Sc,
            l = (r && r.avatarSettings) || {
                show: !0,
                radius: "50%",
            },
            c = "user" === e.sender,
            d = r && Je && r.id === Je.id,
            u = document.createElement("div");
        if (
            ((u.className = "message-row"),
                (u.dataset.senderId = c ? "user-me" : r.id),
                u.classList.add(c ? "user" : "ai"),
                e.uuid && (u.dataset.uuid = e.uuid),
                e.showBlockedWarning && u.classList.add("show-blocked-warning"),
                "action" === e.type)
        ) {
            const t = document.createElement("div");
            return (
                (t.className = "action-message-container"),
                (t.innerHTML = `<div class="action-message-text">${e.text}</div>`),
                (u.className = "message-row action-row"),
                (u.style.justifyContent = "center"),
                u.appendChild(t),
                o.appendChild(u),
                u
            );
        }
        if ("location" === e.type) {
            const t = r?.user?.avatar || "https://via.placeholder.com/36";
            ((u.className = "message-row location-message"),
                (u.dataset.uuid = e.uuid),
                (u.dataset.senderId = "user-me"),
                u.classList.add("user"));
            const n = document.createElement("div");
            ((n.className = "message-content-wrapper user"), (n.innerHTML = e.text));
            const a = document.createElement("div");
            a.className = "chat-avatar-wrapper";
            const s = l.radius || "50%";
            return (
                (a.innerHTML = `<img class="chat-avatar" style="border-radius: ${s};" src="${t}" alt="Áî®Êà∑Â§¥ÂÉè">`),
                u.appendChild(n),
                u.appendChild(a),
                o.appendChild(u),
                u.classList.add("group-single"),
                u
            );
        }
        if ("location_hint" === e.type || e.hidden) return null;
        const m = document.createElement("div");
        m.className = "avatar-anchor";
        const p = document.createElement("img");
        ((p.className = "chat-avatar"),
            (p.style.borderRadius = l.radius),
            (p.src = c
                ? r && r.user
                    ? r.user.avatar
                    : ""
                : r && r.ai
                    ? r.ai.avatar
                    : ""),
            (p.dataset.action = "edit-bubble-style"),
            (p.dataset.isUser = c),
            r && (p.dataset.memberId = r.id),
            m.appendChild(p),
            Jc(m, r, c));
        const g = document.createElement("div");
        ((g.className = "message-content-wrapper"),
            g.classList.add(c ? "user" : "ai"));
        let y = "";
        if (r && r.timestampSettings && r.timestampSettings.show && e.timestamp) {
            const t = new Date(e.timestamp),
                n = `${String(t.getHours()).padStart(2, "0")}:${String(t.getMinutes()).padStart(2, "0")}`,
                a = document.createElement("div");
            ((a.className = "message-timestamp"), (a.textContent = n), (y = a));
        }
        let h = null,
            v = e.text || "";
        if ("html" === e.type && e.content) {
            (g.classList.add("is-html-content"), g.classList.add("is-html-content"));
            const t = document.createElement("div");
            ((t.className = "html-render-container html-shadow-card"),
                (t.style.width = "100%"),
                (t.style.minWidth = "200px"),
                (t.style.display = "block"));
            const n = t.attachShadow({
                mode: "open",
            }),
                a =
                    "\n            <style>\n                :host { \n                    display: block; \n                    width: 100%;\n                    /* ÁßªÈô§ÊâÄÊúâÂÆπÂô®Á∫ßÁ∫¶ÊùüÔºåÂÆåÂÖ®‰∫§ÁªôÂÜÖÈÉ® HTML ÂÜ≥ÂÆö */\n                    background: transparent;\n                    border-radius: 0;\n                    overflow: visible;\n                }\n                /* Âº∫Âà∂ÈáçÁΩÆ body Ê†∑ÂºèÔºå‰ΩøÂÖ∂Ë°®Áé∞ÂæóÂÉè‰∏Ä‰∏™ÊôÆÈÄöÁöÑ div */\n                body { \n                    margin: 0 !important; \n                    padding: 0 !important;\n                    height: auto !important; \n                    min-height: auto !important;\n                    width: 100% !important;\n                    overflow: visible !important;\n                    background: transparent !important;\n                    display: block !important;\n                    position: relative !important;\n                }\n                /* Á°Æ‰øùÂÆπÂô®ÂûÇÁõ¥Â±Ö‰∏≠ÈÄªËæëË¢´ËΩ¨Êç¢‰∏∫ÊôÆÈÄöÊµÅÂ∏ÉÂ±ÄÔºåÊàñËÄÖ‰øùÁïô flex ‰ΩÜÂéªÊéâÂÖ®Â±èÈ´òÂ∫¶ */\n                body {\n                    display: flex !important;\n                    flex-direction: column !important;\n                    justify-content: center !important;\n                    align-items: center !important;\n                }\n                /* Á°Æ‰øùÂõæÁâáËá™ÈÄÇÂ∫î */\n                img { max-width: 100%; height: auto; }\n            </style>\n        ";
            try {
                n.innerHTML = a + (e.content.html || "");
            } catch (e) {
                n.innerHTML =
                    '<div style="color:red;padding:10px;">HTML Ê∏≤ÊüìÂ§±Ë¥•</div>';
            }
            h = t;
        } else if (("sticker" !== e.type && "image" !== e.type) || !e.url)
            if ("text-image" === e.type) {
                const e = "text-image-modal-overlay";
                if (!document.getElementById("text-image-card-styles")) {
                    const t = document.createElement("style");
                    if (
                        ((t.id = "text-image-card-styles"),
                            (t.textContent = `\n            :root {\n                --london-bg: #EAEFF2; \n                --london-card: #FFFFFF;\n                --london-border: rgba(69, 73, 77, 0.12);\n                --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);\n                --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08);\n            }\n            .text-image-card {\n                width: 120px;\n                height:130px;\n                background: var(--london-card);\n                border: 1px solid var(--london-border);\n                border-radius: 14px;\n                box-shadow: var(--london-shadow-soft);\n                overflow: hidden; \n                margin-top: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                padding: 16px; \n                box-sizing: border-box;\n                transition: all 0.3s ease;\n                cursor: pointer;\n                position: relative;\n                /* Á°Æ‰øùÂÜÖÈÉ® 180px ÂÖÉÁ¥†ËÉΩÊíëÂºÄÈ´òÂ∫¶ */\n            }\n            .text-image-card:hover {\n                box-shadow: var(--london-shadow);\n                transform: translateY(-1px);\n            }\n            \n            /* Ê†∏ÂøÉËßÜËßâÂÖÉÁ¥†Ôºö180x180, 10% opacity */\n            .text-image-inner-visual {\n                width: 180px;\n                height: 180px;\n                opacity: 0.1; /* Á°¨ÊÄßË¶ÅÊ±Ç */\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 100px; /* Emoji Â∞∫ÂØ∏ */\n                line-height: 1;\n                user-select: none;\n                pointer-events: none; /* ÁÇπÂáªÁ©øÈÄèÁªôÂç°Áâá */\n            }\n\n            /* --- ÂºπÁ™óÊ†∑Âºè --- */\n            #${e} {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.4);\n                z-index: 9999; /* Ë∂≥Â§üÈ´ò */\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                backdrop-filter: blur(4px);\n                opacity: 0;\n                transition: opacity 0.2s ease;\n                pointer-events: none;\n                visibility: hidden;\n            }\n            #${e}.active {\n                opacity: 1;\n                pointer-events: auto;\n                visibility: visible;\n            }\n            .text-image-modal-content {\n                background: #FFFFFF;\n                width: 85%;\n                max-width: 360px;\n                padding: 24px;\n                padding-top: 40px; /* ÁïôÂá∫ÂÖ≥Èó≠ÊåâÈíÆÁ©∫Èó¥ */\n                border-radius: 20px;\n                box-shadow: 0 12px 40px rgba(0,0,0,0.15);\n                position: relative;\n                max-height: 70vh;\n                overflow-y: auto;\n                transform: scale(0.95);\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            #${e}.active .text-image-modal-content {\n                transform: scale(1);\n            }\n            .text-image-modal-close-btn {\n                position: absolute;\n                top: 12px;\n                right: 12px;\n                width: 28px;\n                height: 28px;\n                cursor: pointer;\n                background: #F2F2F7;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: #8E8E93;\n                font-family: -apple-system, sans-serif;\n                font-size: 14px;\n                font-weight: bold;\n                transition: all 0.2s;\n            }\n            .text-image-modal-close-btn:hover {\n                background: #E5E5EA;\n                color: #000;\n            }\n            .text-image-modal-text-body {\n                font-size: 16px;\n                line-height: 1.6;\n                color: #333;\n                white-space: pre-wrap;\n                word-wrap: break-word;\n                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n            }\n            `),
                            document.head.appendChild(t),
                            !document.getElementById(e))
                    ) {
                        const t = document.createElement("div");
                        ((t.id = e),
                            (t.innerHTML =
                                '\n                    <div class="text-image-modal-content">\n                        <div class="text-image-modal-close-btn">‚úï</div>\n                        <div class="text-image-modal-text-body" id="text-image-modal-text-target"></div>\n                    </div>\n                '),
                            document.body.appendChild(t));
                        const n = () => t.classList.remove("active");
                        ((t.querySelector(".text-image-modal-close-btn").onclick = n),
                            (t.onclick = (e) => {
                                e.target === t && n();
                            }));
                    }
                }
                ((h = document.createElement("div")),
                    (h.className = "text-image-card"),
                    (h.innerHTML =
                        '\n            <div class="text-image-inner-visual">üìù</div> \n        '),
                    (h.onclick = (t) => {
                        t.stopPropagation();
                        const n = document.getElementById(e),
                            a = document.getElementById("text-image-modal-text-target");
                        n && a && ((a.textContent = v), n.classList.add("active"));
                    }));
            } else if ("voice_text" === e.type && e.transcript) {
                ((h = document.createElement("div")),
                    (h.className = "voice-message-wrapper"));
                const t = e.duration || Math.ceil(e.transcript.length / 3) || 1,
                    n = Math.min(60 + 5 * t, 200),
                    a = c ? "chat-bubble user-bubble" : "chat-bubble ai-bubble",
                    o =
                        '<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 17.9911C13.9236 17.9911 18 13.9079 18 8.99556C18 4.07447 13.9148 0 8.99119 0C4.07648 0 0 4.07447 0 8.99556C0 13.9079 4.0853 17.9911 9 17.9911ZM9 16.4919C4.83531 16.4919 1.50883 13.1583 1.50883 8.99556C1.50883 4.83292 4.82648 1.49926 8.99119 1.49926C13.1559 1.49926 16.5001 4.83292 16.5001 8.99556C16.5001 13.1583 13.1648 16.4919 9 16.4919Z" fill="currentColor" opacity="0.3"/><path d="M7.35 12.44L12.37 9.47C12.74 9.26 12.73 8.75 12.37 8.53L7.35 5.56C6.97 5.34 6.47 5.5 6.47 5.94V12.06C6.47 12.49 6.94 12.69 7.35 12.44Z" fill="currentColor"/></svg>';
                ((h.innerHTML = `\n            <div class="${a} voice-audio-bubble clickable-voice-bubble" \n                 style="width: ${n}px; display: flex; align-items: center; justify-content: center; cursor: pointer;">\n                ${o}\n                <span style="margin-left:6px; font-size:12px;">${t}"</span>\n            </div>\n            <div class="voice-text-panel" style="display:none; margin-top:4px; font-size:12px; color:#888;">\n                ${e.transcript}\n            </div>\n        `),
                    (h.onclick = () => {
                        const e = h.querySelector(".voice-text-panel");
                        e &&
                            (e.style.display = "none" === e.style.display ? "block" : "none");
                    }));
            } else if ("file_card" === e.type || /(?:^|\n)\s*ÂèëÈÄÅÊñá‰ª∂Ôºö/.test(v)) {
                let t = "Êú™ÂëΩÂêçÊñá‰ª∂",
                    n = "FILE",
                    a = "10 KB";
                if ("file_card" !== e.type) {
                    const e = v.match(/ÂèëÈÄÅÊñá‰ª∂Ôºö([A-Za-z0-9]+)\s+ÂÜÖÂÆπÔºö([\s\S]+)/);
                    if (e) {
                        n = e[1].toUpperCase();
                        const o = e[2].trim();
                        ((t = o.split("\n")[0].substring(0, 15) || "ÊñáÊ°£"),
                            (a = Math.ceil(o.length / 1024) + " KB"));
                    }
                } else
                    ((t = e.fileName || "Êñá‰ª∂"),
                        (n = e.fileType || "FILE"),
                        (a = e.fileSize || "Êú™Áü•Â§ßÂ∞è"));
                ((h = document.createElement("div")),
                    (h.className = "file-card-bubble"),
                    (h.style.cssText =
                        "background: white; border-radius: 12px; padding: 12px; width: 220px; display: flex; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer;"),
                    (h.innerHTML = `\n            <div style="flex: 1; overflow: hidden;">\n                <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">${t}</div>\n                <div style="font-size: 11px; color: #999; margin-top: 4px;">${a}</div>\n            </div>\n            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-left: 10px; font-size: 10px; color: #666; font-weight: bold;">\n                ${n}\n            </div>\n        `));
            } else {
                const t = /(?:^|\n)\s*ËΩ¨Ë¥¶[:Ôºö]([\d.]+)-(.*)/,
                    n = /\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/,
                    a = /(?:^|\n)\s*Êé•Âèó‰∏ÄËµ∑Âê¨[:Ôºö]/,
                    o = /(?:^|\n)\s*ÂèëËµ∑ÈÄöËØù[:Ôºö]/,
                    s = /(?:^|\n)\s*ÂèëÊúãÂèãÂúà[:Ôºö]/,
                    i = /(?:^|\n)\s*ËØÑËÆ∫ÊúãÂèãÂúà[:Ôºö]/,
                    r = /ÂºïÁî®ÂõûÂ§çÔºö(.*?)[:Ôºö](.*?)\s*\|\|\|\s*(.*)/,
                    l = v.match(t);
                if (l) {
                    const t = l[1],
                        n = l[2].trim(),
                        a =
                            e.uuid ||
                            Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                        o = e.transferStatus || "pending";
                    ((h = document.createElement("div")),
                        (h.style.background = "transparent"),
                        (h.style.padding = "0"));
                    e.transferStatus;
                    h.innerHTML = rg(t, n, a, c, o);
                } else if (v.startsWith("[ORDER_SHARE_CARD]"))
                    try {
                        const e = v.substring(18),
                            t = JSON.parse(e),
                            n = (t.items || [])
                                .map((e) => `<div class="order-item">‚Ä¢ ${e.name}</div>`)
                                .join(""),
                            a = new Date(t.purchaseDate).toLocaleString("zh-CN", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                                hour: "2-digit",
                                minute: "2-digit",
                            });
                        ((h = document.createElement("div")),
                            (h.className = "order-share-card-wrapper"),
                            (h.innerHTML = `\n                    <div class="order-share-card">\n                        <div class="order-card-header">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M21 8V16C21 18.7614 18.7614 21 16 21H8C5.23858 21 3 18.7614 3 16V8C3 5.23858 5.23858 3 8 3H16C18.7614 3 21 5.23858 21 8Z" stroke="white" stroke-width="2"/>\n                                <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2" stroke-linecap="round"/>\n                            </svg>\n                            <span>ËÆ¢ÂçïËØ¶ÊÉÖ</span>\n                        </div>\n                        <div class="order-card-body">\n                            <div class="order-section">\n                                <div class="order-label">ÂïÜÂìÅ</div>\n                                <div class="order-items">${n}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">ÊÄªÈ¢ù</div>\n                                <div class="order-value">¬•${(t.totalAmount || 0).toFixed(2)}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">Êî∂Ë¥ß‰∫∫</div>\n                                <div class="order-value">${t.recipient ? t.recipient.name : "Êú™Áü•"}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">‰∏ãÂçïÊó∂Èó¥</div>\n                                <div class="order-value order-date">${a}</div>\n                            </div>\n                        </div>\n                    </div>\n                `));
                    } catch (e) {
                        (console.error("Ëß£ÊûêËÆ¢ÂçïÊï∞ÊçÆÂ§±Ë¥•:", e),
                            (h = document.createElement("div")),
                            (h.className = c
                                ? "chat-bubble user-bubble"
                                : "chat-bubble ai-bubble"),
                            (h.textContent = "[ËÆ¢ÂçïÂç°ÁâáËß£ÊûêÂ§±Ë¥•]"));
                    }
                else if (v.match(n)) {
                    const e = v.match(n)[1].trim(),
                        t = e.split("\n").filter((e) => e.trim());
                    let a = "ËÅäÂ§©ËÆ∞ÂΩï",
                        o = [];
                    (t.length > 0 && t[0].includes("Ê†áÈ¢òÔºö")
                        ? ((a = t[0].replace("Ê†áÈ¢òÔºö", "").trim()), (o = t.slice(1, 3)))
                        : (o = t.slice(0, 2)),
                        (h = document.createElement("div")),
                        (h.className = "history-card-bubble"),
                        (h.style.cssText =
                            "background: white; border-radius: 12px; padding: 12px; width: 200px; cursor: pointer; text-align: left; box-shadow: 0 2px 6px rgba(0,0,0,0.05);"),
                        (h.innerHTML = `\n                <div style="font-size: 15px; color: #000; margin-bottom: 6px; font-weight: 500;">${a}</div>\n                <div style="font-size: 12px; color: #888;">${o.map((e) => `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e}</div>`).join("")}</div>\n                <div style="margin-top: 8px; border-top: 1px solid #f5f5f5; padding-top: 4px; font-size: 10px; color: #ccc;">ËÅäÂ§©ËÆ∞ÂΩï</div>\n            `),
                        (h.dataset.fullContent = e));
                } else if (v.match(s) || v.match(i) || v.match(a) || v.match(o)) {
                    ((h = document.createElement("div")),
                        (h.className = d
                            ? c
                                ? "gp-user-bubble"
                                : "gp-ai-bubble"
                            : c
                                ? "chat-bubble user-bubble"
                                : "chat-bubble ai-bubble"));
                    let e = "";
                    (v.match(s) && (e = "üì∏ "),
                        v.match(o) && (e = "üìû "),
                        (h.innerHTML = e + zc(v)));
                } else if (v.match(r)) {
                    const e = v.match(r),
                        t = e[1],
                        n = e[2],
                        a = e[3];
                    ((h = document.createElement("div")),
                        (h.className = d
                            ? c
                                ? "gp-user-bubble"
                                : "gp-ai-bubble"
                            : c
                                ? "chat-bubble user-bubble"
                                : "chat-bubble ai-bubble"));
                    const o = `\n                <div class="reply-quote-block" style="margin-bottom:6px; padding:4px 8px; background:rgba(0,0,0,0.05); border-radius:4px; font-size:12px; color:#666; display:flex; flex-direction:column; border-left: 2px solid #ccc;">\n                    <span style="font-weight:bold; margin-bottom:2px;">${t}</span>\n                    <span style="overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${n}</span>\n                </div>\n            `;
                    h.innerHTML = o + zc(a);
                } else {
                    let e = v
                        .replace(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/, "$1")
                        .trim();
                    const t = e.match(/^(.+?)\[Split\](.+)$/i);
                    if (t && Sc && Sc.enableBilingualBubble && !c) {
                        const e = t[1].trim(),
                            n = t[2].trim();
                        ((h = document.createElement("div")),
                            (h.className = "bilingual-wrapper"),
                            (h.innerHTML = `\n                    <div class="bilingual-bubble chat-bubble ai-bubble">\n                        <div class="bilingual-original">${zc(e)}</div>\n                        <div class="bilingual-divider">\n                            <span class="bilingual-divider-line"></span>\n                        </div>\n                        <div class="bilingual-translation">${zc(n)}</div>\n                    </div>\n                    <button class="bilingual-toggle-btn" title="Êî∂Ëµ∑/Â±ïÂºÄÁøªËØë">\n                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">\n                            <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n                        </svg>\n                    </button>\n                `));
                        const a = h.querySelector(".bilingual-toggle-btn"),
                            o = h.querySelector(".bilingual-bubble"),
                            s = (e) => {
                                (e.stopPropagation(), h.classList.toggle("collapsed"));
                            };
                        (a.addEventListener("click", s), o.addEventListener("click", s));
                    } else {
                        ((h = document.createElement("div")),
                            (h.className = d
                                ? c
                                    ? "gp-user-bubble"
                                    : "gp-ai-bubble"
                                : c
                                    ? "chat-bubble user-bubble"
                                    : "chat-bubble ai-bubble"));
                        const t = zc(e);
                        h.innerHTML = t;
                    }
                }
            }
        else {
            h = document.createElement("img");
            const t = "image" === e.type ? "image-bubble" : "sticker-bubble";
            ((h.className = `chat-bubble ${t}`),
                (h.src = e.url),
                (h.loading = "lazy"));
        }
        if (h) {
            if (e.replyTo && !h.querySelector(".reply-quote-block")) {
                const t = document.createElement("div");
                ((t.className = "reply-quote-container"),
                    (t.innerHTML = `\n                <div class="reply-quote-name">${e.replyTo.senderName}</div>\n                <div class="reply-quote-text">${e.replyTo.text}</div>\n             `),
                    (t.onclick = (t) => {
                        t.stopPropagation();
                        const n = o.querySelector(
                            `.message-row[data-uuid="${e.replyTo.uuid}"]`,
                        );
                        n &&
                            (n.scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            }),
                                n.classList.add("highlight-anim"),
                                setTimeout(() => n.classList.remove("highlight-anim"), 1e3));
                    }),
                    h.firstChild ? h.insertBefore(t, h.firstChild) : h.appendChild(t));
            }
            const t = document.createElement("div");
            ((t.className = "selection-indicator"),
                u.appendChild(t),
                g.appendChild(m),
                g.appendChild(h),
                y && g.appendChild(y),
                u.appendChild(g),
                o.appendChild(u));
        }
        return (
            o &&
            "chat-messages-container" === o.id &&
            o.classList.contains("bubble-b-mode") &&
            Pc(),
            u
        );
    }

    function Jc(e, t, n = null) {
        if (!e || !t) return;
        let a = e.classList.contains("avatar-anchor")
            ? e
            : e.querySelector(".avatar-anchor");
        if (!a) return;
        const o = a.querySelector(".avatar-pendant");
        o && o.remove();
        let s = n;
        if (null === s) {
            const e = a.closest(".message-content-wrapper");
            if (!e) return;
            s = e.classList.contains("user");
        }
        let i = s ? t.user.avatarPendant : t.ai.avatarPendant;
        if (i && i.url) {
            const e = document.createElement("div");
            ((e.className = "avatar-pendant"),
                (e.style.backgroundImage = `url('${i.url}')`),
                i.css && (e.style.cssText += i.css),
                a.appendChild(e));
        }
    }

    function Yc(e) {
        if (!e || !e.ai)
            return (
                console.error("showTypingIndicator Â§±Ë¥•Ôºö‰º†ÂÖ•‰∫ÜÊó†ÊïàÁöÑcontactÂØπË±°„ÄÇ"),
                null
            );
        if (Sc && Sc.id === e.id) {
            const t = document.createElement("div");
            t.className = "message-row ai typing-indicator";
            const n = document.createElement("div");
            ((n.className = "selection-indicator"), t.appendChild(n));
            const a = document.createElement("div");
            a.className = "message-content-wrapper ai";
            const o = document.createElement("img");
            ((o.className = "chat-avatar"), (o.src = e.ai.avatar));
            const s = e.avatarSettings || {
                radius: "50%",
            };
            o.style.borderRadius = s.radius;
            const i = document.createElement("div");
            return (
                (i.className = "chat-bubble ai-bubble"),
                (i.innerHTML =
                    '<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>'),
                a.appendChild(o),
                a.appendChild(i),
                t.appendChild(a),
                Xi.appendChild(t),
                (Xi.scrollTop = Xi.scrollHeight),
                t
            );
        }
        return null;
    }
    (Wc.addEventListener("click", async () => {
        if (!Sc) return;
        const e = Sc.isBlocked;
        if (((Sc.isBlocked = !e), Sc.isBlocked))
            if (confirm(`Á°ÆÂÆöË¶ÅÊãâÈªë ${Sc.ai.name} ÂêóÔºü`)) {
                ((Sc.hiddenMessagesOnBlock = []),
                    await tu(),
                    (Wc.textContent = "Ëß£Èô§ÈôêÂà∂"),
                    Wc.classList.remove("purple-button"),
                    Wc.classList.add("danger-button"));
                const e = document.getElementById("block-status-notice");
                ((e.textContent = `‰Ω†Â∑≤ÊãâÈªë ${Sc.ai.name}`),
                    (e.style.display = "block"),
                    console.log("Silently telling AI it has been blocked..."),
                    await Tc("[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]", Sc, {
                        isBlockingAction: !0,
                    }),
                    alert(`${Sc.ai.name} Â∑≤Ë¢´ÊãâÈªë„ÄÇ`));
            } else Sc.isBlocked = e;
        else {
            if (((Sc.isBlocked = !1), Array.isArray(Sc.hiddenMessagesOnBlock)))
                for (const e of Sc.hiddenMessagesOnBlock)
                    if (e.rawResponse) {
                        const t = e.rawResponse.split("\n").filter((e) => "" !== e.trim());
                        for (const e of t) {
                            const t = e.match(/^(?:ËØ≠Èü≥Ôºö)?(.+)/);
                            if (t) {
                                const e = {
                                    sender: "ai",
                                    text: t[1]
                                        .trim()
                                        .replace(/\nÁä∂ÊÄÅÔºö.*/, "")
                                        .replace(/\nÂÜÖÂøÉÁã¨ÁôΩÔºö.*/, ""),
                                    timestamp: new Date(),
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                    showBlockedWarning: !0,
                                };
                                (await Ac(e, Sc.id), Vc(e, Sc));
                            }
                        }
                    }
            ((Sc.hiddenMessagesOnBlock = []),
                await tu(),
                (Wc.textContent = "ÊãâÈªëËØ•ËÅîÁ≥ª‰∫∫"),
                Wc.classList.remove("danger-button"),
                Wc.classList.add("purple-button"),
                (document.getElementById("block-status-notice").style.display = "none"),
                await Xd("‰Ω†Â∑≤Ëß£Èô§ÊãâÈªë", Sc.id),
                alert(`${Sc.ai.name} Â∑≤Ëß£Èô§ÊãâÈªë„ÄÇ`));
        }
    }),
        (window.applyChatViewSettings = jc));
    const Kc = document.getElementById("chat-add-attachment-button"),
        Zc = document.getElementById("more-features-panel"),
        Xc = document.getElementById("time-perception-feature"),
        Qc = document.getElementById("receipt-feature"),
        ed = document.getElementById("transfer-feature");
    document.getElementById("chat-message-input");
    setTimeout(function () {
        const e = document.getElementById("more-features-panel");
        if (!e) return;
        const t = e.querySelector(".features-grid");
        if (!t) return;
        const n = Array.from(t.querySelectorAll(".feature-item")),
            a = t.querySelector("#file-attachment-input");
        if (0 === n.length) return;
        const o = Math.ceil(n.length / 8);
        t.innerHTML = "";
        for (let e = 0; e < o; e++) {
            const a = document.createElement("div");
            a.className = "features-page";
            const o = 8 * e,
                s = Math.min(o + 8, n.length);
            for (let e = o; e < s; e++) a.appendChild(n[e]);
            t.appendChild(a);
        }
        if ((a && t.appendChild(a), o > 1)) {
            const n = document.createElement("div");
            n.className = "features-page-indicator";
            for (let e = 0; e < o; e++) {
                const t = document.createElement("span");
                ((t.className = "dot" + (0 === e ? " active" : "")), n.appendChild(t));
            }
            (e.appendChild(n),
                t.addEventListener("scroll", () => {
                    const e = t.scrollLeft,
                        a = t.clientWidth,
                        o = Math.round(e / a);
                    n.querySelectorAll(".dot").forEach((e, t) => {
                        e.classList.toggle("active", t === o);
                    });
                }));
            let a = 0,
                s = 0;
            const i = 60;
            (t.addEventListener(
                "touchstart",
                (e) => {
                    ((a = e.touches[0].clientX), (s = t.scrollLeft));
                },
                {
                    passive: !0,
                },
            ),
                t.addEventListener("touchend", (e) => {
                    const n = e.changedTouches[0].clientX - a,
                        r = t.clientWidth;
                    let l = Math.round(s / r);
                    (Math.abs(n) > i &&
                        (n > 0 && l > 0 ? l-- : n < 0 && l < o - 1 && l++),
                        t.scrollTo({
                            left: l * r,
                            behavior: "smooth",
                        }));
                }));
        }
    }, 100);
    const td = document.getElementById("transfer-modal"),
        nd = document.getElementById("transfer-modal-close-btn"),
        ad = document.getElementById("confirm-transfer-btn"),
        od = document.getElementById("transfer-amount-input"),
        sd = document.getElementById("transfer-remark-input");

    function id(e) {
        e && e.stopPropagation();
        const t = document.getElementById("chat-screen");
        if (!t) return;
        (t.classList.contains("emoji-panel-active") &&
            t.classList.remove("emoji-panel-active"),
            t.classList.toggle("features-panel-active"));
        const n = document.getElementById("scroll-to-bottom-btn");
        n &&
            t.classList.contains("features-panel-active") &&
            n.classList.remove("visible");
    }
    (Kc.addEventListener("click", (e) => {
        "ontouchstart" in window || id(e);
    }),
        Kc.addEventListener("touchend", (e) => {
            (e.preventDefault(), id(e));
        }),
        Qc.addEventListener("click", () => {
            !(async function () {
                const e = document.getElementById("chat-screen");
                e &&
                    e.classList.contains("features-panel-active") &&
                    e.classList.remove("features-panel-active");
                if (Je) return void (await Fm(Je));
                if (Sc) {
                    const e = JSON.parse(
                        localStorage.getItem("offlineLifeConfig") || "{}",
                    );
                    if (
                        e.enabled &&
                        "busy" === e.currentStatus &&
                        Date.now() < (e.statusEndTime || 0)
                    ) {
                        console.log(
                            "[OfflineLife] AI is busy, blocking receipt/continue action.",
                        );
                        const t = document.getElementById("chat-messages-container");
                        if (t) {
                            const n = document.createElement("div");
                            ((n.className = "message-row system-message-row"),
                                (n.innerHTML = `<div style="width:100%; text-align:center; color:#999; font-size:12px; margin: 10px 0;">ÂØπÊñπÊ≠£Âú®ÂøôÁ¢å‰∏≠(${e.lastReason || "Êú™Áü•ÂéüÂõ†"})ÔºåÊöÇÊó∂Êó†Ê≥ïÂõûÂ§ç„ÄÇ</div>`),
                                t.appendChild(n),
                                (t.scrollTop = t.scrollHeight));
                        }
                        return;
                    }
                }
                if (Sc) {
                    if (!Sc || Qi) return;
                    const e = Sc.history || [];
                    if (0 === e.length) return;
                    if ("user" === e[e.length - 1].sender) {
                        let t = -1;
                        for (let n = e.length - 1; n >= 0; n--)
                            if ("ai" === e[n].sender) {
                                t = n;
                                break;
                            }
                        const n = e.slice(t + 1),
                            a = n.find((e) => "image" === e.type && e.url && !e.processed);
                        if (a) {
                            Tc(
                                {
                                    text: n
                                        .filter((e) => "text" === e.type || "voice_text" === e.type)
                                        .map((e) => e.transcript || e.text)
                                        .join(" \n")
                                        .trim(),
                                    imageUrl: a.url,
                                },
                                Sc,
                            );
                        } else {
                            Tc("(Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑ‰∏ä‰∏ÄÊù°ÊàñÂá†Êù°Ê∂àÊÅØËøõË°åÂõûÂ§ç„ÄÇ)", Sc);
                        }
                    } else {
                        Tc(
                            "(Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†‰∏ä‰∏ÄÊù°ÂèëÂá∫ÁöÑÊ∂àÊÅØÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÅÊÄùËÄÉÊàñÊâßË°å‰∏ã‰∏ÄÊ≠•Âä®‰Ωú„ÄÇ)",
                            Sc,
                        );
                    }
                }
            })();
        }),
        ed.addEventListener("click", () => {
            wd();
        }),
        document.addEventListener("click", (e) => {
            if (Zc.classList.contains("active")) {
                const t = Zc.contains(e.target),
                    n = Kc.contains(e.target);
                t || n || Zc.classList.remove("active");
            }
        }));
    let rd = !1;
    const ld = document.getElementById("chat-screen"),
        cd = document.getElementById("chat-header-actions-normal"),
        dd = document.getElementById("chat-header-actions-select"),
        ud = document.getElementById("delete-messages-btn");

    function md(e) {
        rd ||
            ((rd = !0),
                ld.classList.add("selection-mode-active"),
                (cd.style.display = "none"),
                (dd.style.display = "flex"));
    }

    function pd() {
        ((rd = !1),
            ld.classList.remove("selection-mode-active"),
            (cd.style.display = "flex"),
            (dd.style.display = "none"),
            document.querySelectorAll(".message-row.selected").forEach((e) => {
                e.classList.remove("selected");
            }));
    }

    function gd(e) {
        e && e.classList.toggle("selected");
    }

    function yd(e) {
        if (Qi || rd) return;
        const t = e.target,
            n = t.closest(".voice-text-panel");
        if (n) {
            const e = n.closest(".message-row");
            if (!e) return;
            return (
                (Pe = !1),
                clearTimeout(De),
                void (De = setTimeout(() => {
                    ((Pe = !0), bp(e.dataset.uuid, n.innerText));
                }, 500))
            );
        }
        if ("IMG" === t.tagName && t.classList.contains("image-bubble")) return;
        if (t.closest(".html-render-container")) return;
        const a = e.target.closest(".message-row");
        a &&
            ((Pe = !1),
                clearTimeout(De),
                (De = setTimeout(() => {
                    ((Pe = !0),
                        (function (e) {
                            ze = e;
                            const t =
                                e.querySelector(".chat-bubble") ||
                                e.querySelector(".gp-user-bubble") ||
                                e.querySelector(".gp-ai-bubble") ||
                                e.querySelector("img.chat-bubble") ||
                                e.querySelector(".text-image-card") ||
                                e.querySelector(".voice-audio-bubble") ||
                                e.querySelector(".history-card-bubble");
                            if (!t) return;
                            ((Fe.style.display = "flex"), (Fe.style.visibility = "hidden"));
                            const n = t.getBoundingClientRect(),
                                a = Ii.getBoundingClientRect(),
                                o = Fe.getBoundingClientRect();
                            let s = n.top - a.top - o.height - 10,
                                i = n.left - a.left + n.width / 2 - o.width / 2;
                            s < 60 && (s = n.bottom - a.top + 10);
                            i < 10 && (i = 10);
                            const r = a.width - o.width - 10;
                            i > r && (i = r);
                            ((Fe.style.top = `${s}px`),
                                (Fe.style.left = `${i}px`),
                                (Fe.style.visibility = "visible"),
                                navigator.vibrate && navigator.vibrate(50));
                        })(a));
                }, 500)));
    }

    function hd(e) {
        clearTimeout(De);
    }
    async function vd(e = null) {
        const t = Ir.querySelector("h2");
        if (e) {
            ((Mr = e), (t.textContent = "ÁºñËæë‰∏ñÁïå‰π¶"));
            const n = (await Kl.loadData("worldBooks", "allWorldBooks")).value.find(
                (t) => t.id === e,
            );
            n && ((Lr.value = n.name), (Br.value = n.content));
        } else
            ((Mr = null),
                (t.textContent = "Êñ∞Âª∫‰∏ñÁïå‰π¶"),
                (Lr.value = ""),
                (Br.value = ""));
        ((Ir.style.display = "flex"),
            setTimeout(() => {
                ((Ir.style.opacity = "1"),
                    (Ir.querySelector(".modal-content").style.transform = "scale(1)"));
            }, 10));
    }

    function fd() {
        ((Ir.style.opacity = "0"),
            (Ir.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((Ir.style.display = "none"),
                    (Lr.value = ""),
                    (Br.value = ""),
                    (Mr = null));
            }, 300));
    }

    function wd() {
        ((td.style.display = "flex"),
            setTimeout(() => {
                ((td.style.opacity = "1"),
                    (td.querySelector(".modal-content").style.transform = "scale(1)"));
            }, 10));
    }

    function bd() {
        ((td.style.opacity = "0"),
            (td.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((td.style.display = "none"), (od.value = ""), (sd.value = ""));
            }, 300));
    }
    (document
        .getElementById("cancel-selection-btn")
        .addEventListener("click", pd),
        ud.addEventListener("click", async function () {
            const e = document.querySelectorAll(".message-row.selected");
            if (0 === e.length || (!Sc && !Je)) return;
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} Êù°Ê∂àÊÅØÂêóÔºü`)) return;
            const t = new Set();
            e.forEach((e) => {
                e.dataset.uuid && t.add(e.dataset.uuid);
            });
            try {
                if (Je) {
                    const n = await Kl.loadData("groupChats", "allGroupChats");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    const o = a.findIndex((e) => e.id === Je.id);
                    if (o > -1) {
                        const n = a[o];
                        if (
                            (Array.isArray(n.history) &&
                                (n.history = n.history.filter((e) => !t.has(e.uuid))),
                                n.history.length > 0)
                        ) {
                            const e = n.history[n.history.length - 1],
                                t = e.text || (e.content && e.content.html) || "[Â§öÂ™í‰Ωì]";
                            n.lastMessage = Uc(t);
                        } else n.lastMessage = "ÂØπËØùÂ∑≤Ê∏ÖÁ©∫";
                        (await Kl.saveData("groupChats", "allGroupChats", a),
                            (Je = n),
                            e.forEach((e) => e.remove()),
                            // Dm(), // Removed to prevent full re-render clearing view
                            pd(),
                            alert("Âà†Èô§ÊàêÂäüÔºÅ"));
                    }
                } else if (Sc) {
                    const n = await Kl.loadData("messageContacts", "allContacts");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    const o = a.findIndex((e) => e.id === Sc.id);
                    if (o > -1) {
                        const n = a[o];
                        if (
                            (Array.isArray(n.history) &&
                                (n.history = n.history.filter((e) => !t.has(e.uuid))),
                                n.history.length > 0)
                        ) {
                            const e = n.history[n.history.length - 1];
                            n.lastMessage = Uc(e.text || (e.content && e.content.html) || "");
                        } else n.lastMessage = "ÂØπËØùÂ∑≤Ê∏ÖÁ©∫";
                        (await Kl.saveData("messageContacts", "allContacts", a),
                            (Sc = n),
                            e.forEach((e) => e.remove()));
                        const s = Ni.querySelector(
                            `.contact-item[data-contact-id="${Sc.id}"]`,
                        );
                        (s &&
                            (s.querySelector(".contact-last-message").textContent =
                                Sc.lastMessage),
                            pd(),
                            alert("Âà†Èô§ÊàêÂäüÔºÅ"));
                    }
                }
            } catch (e) {
                (console.error("Âà†Èô§Ê∂àÊÅØÊó∂ÂèëÁîüÈîôËØØ:", e),
                    alert(`Âà†Èô§Â§±Ë¥•: ${e.message}`));
            }
        }),
        Xi.addEventListener("mousedown", yd),
        Xi.addEventListener("touchstart", yd, {
            passive: !0,
        }),
        Xi.addEventListener("mouseup", hd),
        Xi.addEventListener("touchend", (e) => hd()),
        Xi.addEventListener("mouseleave", hd),
        Xi.addEventListener("touchmove", hd),
        Xi.addEventListener("click", (e) => {
            if (Pe) return (e.stopPropagation(), e.preventDefault(), void (Pe = !1));
            const t = e.target.closest(".history-card-bubble");
            if (t) {
                (e.stopPropagation(), e.preventDefault());
                const n = t.dataset.historyTitle || "ËÅäÂ§©ËÆ∞ÂΩï",
                    a = t.dataset.historyContent;
                if (a)
                    try {
                        tp(n, JSON.parse(a));
                    } catch (e) {
                        tp(n, [a]);
                    }
                return;
            }
            const n = e.target.closest(".text-image-card");
            if (n) return void n.classList.toggle("text-revealed");
            if (
                "IMG" === e.target.tagName &&
                e.target.classList.contains("image-bubble")
            )
                return void (function (e) {
                    if (!Za || !Xa) return;
                    ((Xa.src = e),
                        (Za.style.display = "flex"),
                        setTimeout(() => {
                            ((Za.style.opacity = "1"),
                                (Xa.style.opacity = "1"),
                                (Xa.style.transform = "scale(1)"));
                        }, 10));
                })(e.target.src);
            if (
                e.target.classList.contains("chat-avatar") &&
                "edit-bubble-style" === e.target.dataset.action
            ) {
                if (Je) {
                    const t = e.target.dataset.memberId;
                    let n = "";
                    Je.memberStyles && Je.memberStyles[t] && (n = Je.memberStyles[t]);
                    let a = "ÊàêÂëò";
                    const o = e.target.nextElementSibling;
                    o && (a = o.textContent);
                    (Bm(`ÁºñËæë ${a} ÁöÑÁæ§Ê∞îÊ≥°`, n, async (e) => {
                        (Je.memberStyles || (Je.memberStyles = {}),
                            (Je.memberStyles[t] = e));
                        let n = (await Kl.loadData("groupChats", "allGroupChats")).value;
                        const a = n.findIndex((e) => e.id === Je.id);
                        if (
                            (a > -1 &&
                                ((n[a] = Je),
                                    await Kl.saveData("groupChats", "allGroupChats", n)),
                                window.injectedStylesCache)
                        ) {
                            const e = `style-group-${Je.id}-${t}`;
                            window.injectedStylesCache.delete(e);
                        }
                        (window._cssTransformCache && window._cssTransformCache.clear(),
                            zm(t),
                            Sm(),
                            alert("Áæ§ËÅäÊ∞îÊ≥°Ê†∑ÂºèÂ∑≤Êõ¥Êñ∞ÔºÅ"));
                    }),
                        setTimeout(() => {
                            const e = document.getElementById("text-edit-textarea");
                            e && (e.placeholder = "ËæìÂÖ•CSS‰ª£Á†Å...");
                        }, 50));
                } else Sc && console.log("ÂçïËÅäÊ®°ÂºèÁÇπÂáªÂ§¥ÂÉèÔºåÂøΩÁï•");
                return;
            }
            if (rd) {
                const t = e.target.closest(".message-row");
                t && (e.stopPropagation(), e.preventDefault(), gd(t));
            }
            const a = e.target.closest(".clickable-file-card");
            if (a)
                if ((e.stopPropagation(), "true" === a.dataset.isSimulated)) {
                    const e = a.dataset.filename,
                        t = a.dataset.simulatedContent;
                    !(function (e, t) {
                        const n = document.getElementById("ai-file-viewer-modal"),
                            a = document.getElementById("ai-file-viewer-title"),
                            o = document.getElementById("ai-file-viewer-content");
                        ((a.textContent = e || "Êñá‰ª∂È¢ÑËßà"),
                            (o.textContent = t),
                            (n.style.display = "flex"),
                            setTimeout(() => {
                                ((n.style.opacity = "1"),
                                    (n.querySelector(".modal-content").style.transform =
                                        "scale(1)"));
                            }, 10));
                    })(e, decodeURIComponent(t));
                } else {
                    !(function (e, t) {
                        if (!t) return void alert("Êñá‰ª∂Êï∞ÊçÆ‰∏¢Â§±ÔºåÊó†Ê≥ïÊâìÂºÄ„ÄÇ");
                        const n = document.createElement("a");
                        ((n.href = t),
                            (n.download = e),
                            t.startsWith("data:image") || t.startsWith("data:application/pdf")
                                ? fetch(t)
                                    .then((e) => e.blob())
                                    .then((e) => {
                                        const t = URL.createObjectURL(e);
                                        (window.open(t, "_blank"),
                                            setTimeout(() => URL.revokeObjectURL(t), 1e4));
                                    })
                                    .catch(() => {
                                        (document.body.appendChild(n),
                                            n.click(),
                                            document.body.removeChild(n));
                                    })
                                : (document.body.appendChild(n),
                                    n.click(),
                                    document.body.removeChild(n)));
                    })(a.dataset.filename, a.dataset.fileUrl);
                }
            else;
        }),
        Qa.addEventListener("click", nm),
        Za.addEventListener("click", (e) => {
            e.target === Za && nm();
        }),
        xr.addEventListener("click", fd),
        kr.addEventListener("click", async () => {
            const e = Lr.value.trim(),
                t = Br.value.trim();
            if (e)
                try {
                    const n = await Kl.loadData("worldBooks", "allWorldBooks");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    if (Mr) {
                        const n = a.findIndex((e) => e.id === Mr);
                        n > -1 && ((a[n].name = e), (a[n].content = t));
                    } else {
                        const n = {
                            id: Date.now(),
                            name: e,
                            content: t,
                            createdAt: new Date(),
                        };
                        if ((a.push(n), Uo)) {
                            const e = await Kl.loadData("worldBookGroups", "allGroups");
                            let t = e && Array.isArray(e.value) ? e.value : [];
                            const a = t.find((e) => e.id === Uo);
                            a &&
                                (Array.isArray(a.bookIds) || (a.bookIds = []),
                                    a.bookIds.push(n.id),
                                    await Kl.saveData("worldBookGroups", "allGroups", t));
                        }
                    }
                    (await Kl.saveData("worldBooks", "allWorldBooks", a),
                        alert("‰∏ñÁïå‰π¶Â∑≤‰øùÂ≠òÔºÅ"),
                        fd(),
                        Uo
                            ? ju(Uo)
                            : (async function () {
                                const e = await Kl.loadData("worldBooks", "allWorldBooks"),
                                    t = e && Array.isArray(e.value) ? e.value : [];
                                Uu(t, Sr);
                            })());
                } catch (e) {
                    (console.error("‰øùÂ≠ò‰∏ñÁïå‰π¶Â§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•"));
                }
            else alert("‰∏ñÁïå‰π¶ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        }),
        Cr.addEventListener("click", () => {
            (($r = !$r), Sr.classList.toggle("delete-mode", $r));
            const e = Cr.querySelector(".icon-select"),
                t = Cr.querySelector(".icon-cancel");
            $r
                ? ((e.style.display = "none"),
                    (t.style.display = "block"),
                    (Oo.style.display = "none"),
                    (qo.style.display = "flex"))
                : ((e.style.display = "block"),
                    (t.style.display = "none"),
                    (Oo.style.display = "flex"),
                    (qo.style.display = "none"),
                    Sr.querySelectorAll(".contact-checkbox").forEach(
                        (e) => (e.checked = !1),
                    ));
        }),
        _o.addEventListener("click", () => {
            (($r = !1),
                Sr.classList.remove("delete-mode"),
                (Oo.style.display = "flex"),
                (qo.style.display = "none"),
                Sr.querySelectorAll(".contact-checkbox").forEach(
                    (e) => (e.checked = !1),
                ));
        }),
        No.addEventListener("click", async () => {
            if (0 !== Sr.querySelectorAll(".contact-checkbox:checked").length)
                try {
                    const e = await Kl.loadData("worldBookGroups", "allGroups"),
                        t = e && Array.isArray(e.value) ? e.value : [];
                    ((Go.innerHTML = ""),
                        t.length > 0
                            ? t.forEach((e) => {
                                const t = document.createElement("div");
                                ((t.className = "group-selection-item"),
                                    (t.dataset.groupId = e.id),
                                    (t.textContent = e.name),
                                    Go.appendChild(t));
                            })
                            : (Go.innerHTML =
                                '<p style="text-align:center; color:#888;">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>'),
                        (Fo.style.display = "flex"),
                        setTimeout(() => (Fo.style.opacity = "1"), 10));
                } catch (e) {
                    console.error("Âä†ËΩΩÂàÜÁªÑÂà∞ÂºπÁ™óÂ§±Ë¥•:", e);
                }
            else alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÁßªÂä®ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
        }),
        ed.addEventListener("click", () => {
            (wd(), Zc.classList.remove("active"));
        }),
        Xc.addEventListener("click", async function () {
            if (!Sc) return void alert("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂØπËØù„ÄÇ");
            const e = Sc.timePerceptionEnabled || !1;
            if (
                confirm(
                    e
                        ? "Ë¶ÅÂÖ≥Èó≠Ê≠§AIÁöÑÊó∂Èó¥ÊÑüÁü•ÂäüËÉΩÂêóÔºüÂÖ≥Èó≠ÂêéÂÆÉÂ∞Ü‰∏çÂÜçÁü•ÊôìÁé∞ÂÆûÊó∂Èó¥„ÄÇ"
                        : "Ë¶Å‰∏∫Ê≠§AIÂºÄÂêØÊÑüÁü•Áé∞ÂÆûÊó∂Èó¥ÁöÑÂäüËÉΩÂêóÔºüÂºÄÂêØÂêéAIÁöÑÂõûÂ§ç‰ºöÁªìÂêàÂΩìÂâçÊó∂Èó¥„ÄÇ",
                )
            )
                try {
                    Sc.timePerceptionEnabled = !e;
                    let t =
                        (await Kl.loadData("messageContacts", "allContacts")).value || [];
                    const n = t.findIndex((e) => e.id === Sc.id);
                    if (!(n > -1)) throw new Error("Âú®Êï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞ÂΩìÂâçËÅîÁ≥ª‰∫∫„ÄÇ");
                    ((t[n] = Sc),
                        await Kl.saveData("messageContacts", "allContacts", t),
                        alert(
                            `Êó∂Èó¥ÊÑüÁü•ÂäüËÉΩÂ∑≤ÊàêÂäü${Sc.timePerceptionEnabled ? "ÂºÄÂêØ" : "ÂÖ≥Èó≠"}ÔºÅ`,
                        ));
                } catch (e) {
                    (console.error("Êõ¥Êñ∞Êó∂Èó¥ÊÑüÁü•Áä∂ÊÄÅÂ§±Ë¥•:", e),
                        alert(`Êìç‰ΩúÂ§±Ë¥•: ${e.message}`));
                } finally {
                    id();
                }
        }),
        nd.addEventListener("click", bd),
        ad.addEventListener("click", async () => {
            const e = parseFloat(od.value),
                t = sd.value.trim();
            if (isNaN(e) || e <= 0) return void alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù„ÄÇ");
            if (!t) return void alert("Â§áÊ≥®‰∏çËÉΩ‰∏∫Á©∫„ÄÇ");
            const n = {
                sender: "user",
                text: `ËΩ¨Ë¥¶Ôºö${e.toFixed(2)}-${t}`,
                timestamp: new Date(),
                uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
            };
            (Vc(n),
                await Ac(n, Sc.id),
                Xi.scrollTo({
                    top: Xi.scrollHeight,
                    behavior: "smooth",
                }),
                bd());
        }));
    const Ed = [
        "settingsStore",
        "messageContacts",
        "groupChats",
        "worldBooks",
        "worldBookGroups",
        "gachaPosts",
        "emojiStore",
        "iconPresets",
        "datingSetupStore",
        "datingHistoryStore",
        "writingStylePresets",
        "fontUrlStore",
        "wowoData",
        "memoryCheques",
        "musicPlaylists",
    ];

    function Id(e) {
        return e
            ? e.length < 100
                ? e
                : `${e.length}_${e.substring(0, 50)}_${e.substring(e.length - 50)}`
            : "empty";
    }
    const xd = (function () {
        const e = navigator.userAgent || navigator.vendor || window.opera || "";
        return (
            /iPad|iPhone|iPod/.test(e) ||
            (navigator.platform && /iP(ad|hone|od)/.test(navigator.platform))
        );
    })();
    async function kd(e, t, n, a) {
        if (e && "object" == typeof e)
            for (const o in e) {
                const s = e[o];
                if ("string" == typeof s && s.startsWith("data:image/")) {
                    console.log(`üì∏ ÂèëÁé∞ÂõæÁâáÂ≠óÊÆµ: ${o}, ÈïøÂ∫¶: ${s.length}`);
                    const i = s.match(/^data:image\/(\w+);base64,/);
                    if (!i) {
                        console.warn(`‚ö†Ô∏è  Êó†Ê≥ïËß£ÊûêÂõæÁâáÊ†ºÂºè: ${o}`);
                        continue;
                    }
                    const r = i[1];
                    let l = s.substring(i[0].length);
                    const c = Id(l),
                        d = a.get(c);
                    if (d)
                        ((e[o] = `backup://images/${d}`),
                            console.log(`‚ôªÔ∏è  ÂõæÁâáÂ∑≤ÂéªÈáç: ${o} -> ${d}`));
                    else {
                        n.count++;
                        const s = `img_${n.count}.${r}`;
                        (t.file(s, l, {
                            base64: !0,
                        }),
                            a.set(c, s),
                            (e[o] = `backup://images/${s}`),
                            (l = null),
                            console.log(`‚úÖ ÂõæÁâáÂ∑≤‰øùÂ≠òÂπ∂ÊõøÊç¢: ${o} -> ${s}`));
                    }
                    (n.loopTick++,
                        xd &&
                        n.loopTick % 5 == 0 &&
                        (await new Promise((e) => setTimeout(e, 10))));
                } else if (
                    "string" == typeof s &&
                    s.trim().startsWith("url(") &&
                    s.includes("data:image/")
                ) {
                    const i = s.match(/^url\(["']?(data:image\/[^"']+)["']?\)$/);
                    if (i) {
                        const s = i[1],
                            r = s.match(/^data:image\/(\w+);base64,/);
                        if (!r) continue;
                        const l = r[1];
                        let c = s.substring(r[0].length);
                        const d = Id(c),
                            u = a.get(d);
                        if (u) e[o] = `url("backup://images/${u}")`;
                        else {
                            n.count++;
                            const s = `img_${n.count}.${l}`;
                            (t.file(s, c, {
                                base64: !0,
                            }),
                                a.set(d, s),
                                (e[o] = `url("backup://images/${s}")`),
                                (c = null));
                        }
                        (n.loopTick++,
                            xd &&
                            n.loopTick % 5 == 0 &&
                            (await new Promise((e) => setTimeout(e, 10))));
                    }
                } else "object" == typeof s && null !== s && (await kd(s, t, n, a));
            }
    }

    function Ld(storeName, imagesFolder, progressObj, dedupeMap) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(Kl.dbName, Kl.dbVersion);
            request.onerror = (e) => reject(new Error(`Backup DB Open Failed: ${e.target.error}`));

            request.onsuccess = async (e) => {
                const db = e.target.result;
                try {
                    // 1. Ëé∑ÂèñÊâÄÊúâ Key (Get All keys) - ÂàÜÁ¶ªËØªÂèñÁªìÊûÑ‰∏éËØªÂèñÊï∞ÊçÆ
                    const keys = await new Promise((res, rej) => {
                        const txn = db.transaction([storeName], "readonly");
                        const store = txn.objectStore(storeName);
                        if (store.getAllKeys) {
                            const req = store.getAllKeys();
                            req.onsuccess = (ev) => res(ev.target.result);
                            req.onerror = (ev) => rej(ev.target.error);
                        } else {
                            const k = [];
                            store.openKeyCursor().onsuccess = (ev) => {
                                const cursor = ev.target.result;
                                if (cursor) { k.push(cursor.key); cursor.continue(); }
                                else res(k);
                            };
                        }
                    });

                    const l = ["["];
                    let isFirst = true;
                    // ÂàÜÊâπÂ§ÑÁêÜ‰ª•Èò≤Ê≠¢ÂÜÖÂ≠òÊ∫¢Âá∫Âπ∂‰øùÊåÅ UI ÂìçÂ∫î (Batch Size)
                    const BATCH_SIZE = 20;
                    let processedRecords = 0;

                    for (let i = 0; i < keys.length; i += BATCH_SIZE) {
                        const chunkKeys = keys.slice(i, i + BATCH_SIZE);

                        // 2. Âú®Êñ∞‰∫ãÂä°‰∏≠ËØªÂèñ‰∏ÄÊâπÊï∞ÊçÆ (Fetch chunk in new transaction)
                        const chunkValues = await new Promise((res, rej) => {
                            const txn = db.transaction([storeName], "readonly");
                            const store = txn.objectStore(storeName);
                            const promises = chunkKeys.map(k => new Promise((r, j) => {
                                const req = store.get(k);
                                req.onsuccess = (ev) => r(ev.target.result);
                                req.onerror = (ev) => j(ev.target.error);
                            }));
                            Promise.all(promises).then(res).catch(rej);
                        });

                        // 3. Â§ÑÁêÜÊï∞ÊçÆ (Process data)
                        for (let record of chunkValues) {
                            if (!record) continue;

                            if (isFirst) isFirst = false;
                            else l.push(",");

                            try {
                                const clone = structuredClone ? structuredClone(record) : JSON.parse(JSON.stringify(record));
                                // ÂºÇÊ≠•Â§ÑÁêÜÂõæÁâá (Async Image Processing)
                                await kd(clone, imagesFolder, progressObj, dedupeMap);
                                l.push(JSON.stringify(clone));
                            } catch (err) {
                                console.warn(`[Backup] Skipped record in ${storeName}:`, err);
                            }

                            processedRecords++;
                            // ÂëºÂê∏ËÆ©Ê∏° (Yield to UI)
                            if (xd && processedRecords % 5 === 0) {
                                await new Promise(r => setTimeout(r, 10));
                            }
                        }
                    }

                    l.push("]");
                    // ÈáäÊîæ Blob ÂÜÖÂ≠ò
                    const blob = new Blob(l, { type: "application/json" });
                    // Explicitly nullify array to help GC
                    l.length = 0;
                    resolve(blob);

                } catch (err) {
                    console.error(`[Backup] Fatal error processing ${storeName}:`, err);
                    reject(err);
                }
            };
        });
    }
    async function Bd(e, t) {
        if (e && "object" == typeof e)
            for (const n in e) {
                const a = e[n];
                try {
                    if ("string" == typeof a && a.startsWith("backup://images/")) {
                        const o = a.replace("backup://images/", ""),
                            s = await Sd(t, o);
                        s &&
                            ((e[n] = s), xd && (await new Promise((e) => setTimeout(e, 0))));
                    } else if (
                        "string" == typeof a &&
                        a.startsWith('url("backup://images/')
                    ) {
                        const o = a.match(/url\("backup:\/\/images\/([^"]+)"\)/);
                        if (o && o[1]) {
                            const a = o[1],
                                s = await Sd(t, a);
                            s &&
                                ((e[n] = `url("${s}")`),
                                    xd && (await new Promise((e) => setTimeout(e, 0))));
                        }
                    } else "object" == typeof a && null !== a && (await Bd(a, t));
                } catch (e) {
                    console.warn(`ÂõæÁâáËøòÂéüÂ§±Ë¥• (${n}):`, e.message);
                }
            }
    }
    async function Sd(e, t) {
        const n = e.file(`images/${t}`) || e.file(t);
        if (!n) return null;
        const a = await n.async("base64");
        let o = "data:image/jpeg;base64,";
        return (
            t.toLowerCase().endsWith(".png")
                ? (o = "data:image/png;base64,")
                : t.toLowerCase().endsWith(".gif")
                    ? (o = "data:image/gif;base64,")
                    : t.toLowerCase().endsWith(".webp") &&
                    (o = "data:image/webp;base64,"),
            o + a
        );
    }
    async function Cd(e, t, n, a, o, s = 0, i = 1) {
        (console.log(`[Import] ÂºÄÂßãÂØºÂÖ•Ë°®: ${e}`),
            (n.textContent = `Ê≠£Âú®ËØªÂèñ: ${e}...`));
        const r = (s / i) * 100,
            l = 100 / i;
        (a && (a.style.width = `${Math.round(r)}%`),
            await Kl.clearStore(e),
            console.log(`[Import] ËØªÂèñ ${e} JSON Êï∞ÊçÆ...`));
        const c = await t.async("string");
        let d;
        (console.log(
            `[Import] ${e} ËØªÂèñÂÆåÊàêÔºåÂ§ßÂ∞è: ${(c.length / 1024).toFixed(1)} KB`,
        ),
            (n.textContent = `Ëß£Êûê ${e}...`),
            a && (a.style.width = `${Math.round(r + 0.1 * l)}%`));
        try {
            d = JSON.parse(c);
        } catch (t) {
            throw (
                console.error(`[Import] ${e} JSON Ëß£ÊûêÂ§±Ë¥•:`, t),
                new Error(`${e} Êï∞ÊçÆÊ†ºÂºèÈîôËØØ`)
            );
        }
        if (!Array.isArray(d))
            return void console.warn(`[Import] ${e} ‰∏çÊòØÊï∞ÁªÑÔºåË∑≥Ëøá`);
        console.log(`[Import] ${e} Ëß£ÊûêÂÆåÊàêÔºåÂÖ± ${d.length} Êù°ËÆ∞ÂΩï`);
        const u = xd ? 10 : 50;
        let m = 0;
        for (let t = 0; t < d.length; t += u) {
            const s = d.slice(t, Math.min(t + u, d.length));
            m += s.length;
            const i = (m / d.length) * 0.8,
                c = Math.round(r + l * (0.1 + i));
            ((n.textContent = `ÊÅ¢Â§ç ${e}: ${m}/${d.length}`),
                a && (a.style.width = `${Math.min(95, c)}%`));
            for (const item of s)
                try {
                    await Bd(item, o);
                    if ("messageContacts" === e && item.id === "allContacts" && Array.isArray(item.value)) {
                        for (const contact of item.value) {
                            if (contact.history && contact.history.length > 0) {
                                await Kl.saveData("messageContacts", `history_${contact.id}`, contact.history);
                                contact.history = [];
                                contact.hasSeparatedHistory = true;
                            }
                        }
                    }
                } catch (err) {
                    console.warn("[Import] ÂõæÁâáËøòÂéüÂ§±Ë¥•:", err);
                }
            const p = s.map((t) => {
                try {
                    return "emojiStore" === e
                        ? Kl.updateRecord(e, t)
                        : void 0 !== t.id && void 0 !== t.value
                            ? Kl.saveData(e, t.id, t.value)
                            : void 0 !== t.id
                                ? Kl.updateRecord(e, t)
                                : Promise.resolve();
                } catch (e) {
                    return (console.warn("[Import] ËÆ∞ÂΩïÂÜôÂÖ•Â§±Ë¥•:", e), Promise.resolve());
                }
            });
            (await Promise.all(p),
                xd
                    ? await new Promise((e) => setTimeout(e, 50))
                    : await new Promise((e) => setTimeout(e, 10)));
        }
        console.log(`‚úÖ [Import] ${e} ÂØºÂÖ•ÂÆåÊàêÔºåÂÖ± ${m} Êù°`);
    }
    (Tr.addEventListener("click", async function () {
        let e = null;
        try {
            const t = new Date(),
                n = `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, "0")}-${String(t.getDate()).padStart(2, "0")}`,
                a = new JSZip(),
                o = a.folder("data"),
                s = a.folder("images");
            ((e = document.createElement("div")),
                (e.className = "system-loader-overlay"),
                (e.innerHTML = `\n            ${h}\n            <div class="system-loader-card">\n                <div class="loader-icon-wrapper bounce-icon">üì¶</div>\n                <div class="loader-title">Ê≠£Âú®Â§á‰ªΩÊï∞ÊçÆ</div>\n                <div class="loader-desc" id="backup-status-text">ÂáÜÂ§áÂºÄÂßã...</div>\n                <div class="progress-track">\n                    <div class="progress-fill" id="backup-progress-bar"></div>\n                </div>\n            </div>\n        `),
                document.body.appendChild(e));
            const i = document.getElementById("backup-status-text"),
                r = document.getElementById("backup-progress-bar");
            if (!i || !r) throw new Error("UI ÂàùÂßãÂåñÂ§±Ë¥•");
            if (xd) {
                if (!confirm("‚ö†Ô∏è ÁªßÁª≠Â§á‰ªΩÔºü"))
                    return void (
                        e &&
                        document.body.contains(e) &&
                        document.body.removeChild(e)
                    );
            }
            console.log("üöÄ ÂºÄÂßãÂõæÁâáÂéªÈáçÂ§á‰ªΩ...");
            const l = {
                count: 0,
                loopTick: 0,
            },
                c = new Map();
            for (let e = 0; e < Ed.length; e++) {
                const t = Ed[e];
                i && (i.textContent = `ÊèêÂèñ‰∏≠: ${t}`);
                const n = await Ld(t, s, l, c);
                o.file(`${t}.json`, n);
                const a = Math.round(((e + 1) / Ed.length) * 50);
                r && (r.style.width = `${a}%`);
            }
            c.clear();
            const d = {
                themePresets: localStorage.getItem("themePresets"),
                bubblePresets: localStorage.getItem("bubblePresets"),
                meetuStyles: localStorage.getItem("meetuStyles_backup"),
            };
            (a.file("localStoragePresets.json", JSON.stringify(d)),
                console.log("‚úÖ Â∑≤ÂØºÂá∫ localStorage È¢ÑËÆæÔºà‰∏ªÈ¢òÈ¢ÑËÆæ„ÄÅÊ∞îÊ≥°È¢ÑËÆæÔºâ"),
                a.file(
                    "version.json",
                    JSON.stringify({
                        version: "3.2",
                        type: "SevenPhoneBackup_Split_Dedupe",
                        date: n,
                    }),
                ),
                i && (i.textContent = `Ê≠£Âú®ÊâìÂåÖ... (ÂÖ± ${l.count} Âº†ÂõæÁâá)`));
            const u = await a.generateAsync(
                {
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: xd ? 1 : 5,
                    },
                    streamFiles: !0,
                },
                (e) => {
                    const t = 50 + e.percent / 2;
                    (i && (i.textContent = `ÂéãÁº©‰∏≠: ${e.percent.toFixed(0)}%`),
                        r && (r.style.width = `${t}%`));
                },
            ),
                m = URL.createObjectURL(u),
                p = document.createElement("a");
            ((p.download = `phone_77_${n}.zip`),
                (p.href = m),
                document.body.appendChild(p),
                p.click(),
                document.body.removeChild(p),
                setTimeout(() => URL.revokeObjectURL(m), 1e4),
                e && document.body.contains(e) && document.body.removeChild(e),
                console.log(
                    `Â§á‰ªΩÂÆåÊàêÔºåÂéªÈáçÂêéÂÖ±Â≠òÂõæ ${l.count} Âº†Ôºå‰ΩìÁßØ: ${(u.size / 1024 / 1024).toFixed(2)} MB`,
                ));
        } catch (t) {
            (console.error("Â§á‰ªΩÂ§±Ë¥•:", t),
                e && document.body.contains(e) && document.body.removeChild(e),
                alert(`‚ùå Â§á‰ªΩÂ§±Ë¥•: ${t.message}`));
        }
    }),
        Ar.addEventListener("click", () => Dr.click()),
        Dr.addEventListener("change", async function (e) {
            const t = e.target.files[0];
            if (!t) return;
            const n = t.name.toLowerCase(),
                a = n.endsWith(".zip"),
                o = n.endsWith(".json");
            if (a && "undefined" == typeof JSZip)
                return (
                    alert(
                        "‚ùå JSZip Â∫ìÂ∞öÊú™Âä†ËΩΩÂÆåÊàêÔºåËØ∑Á®çÂêéÂÜçËØïÔºÅ\n\nÊèêÁ§∫ÔºöÈ°µÈù¢Âä†ËΩΩÂêéÈúÄË¶ÅÁ≠âÂæÖÁ∫¶ 1-2 ÁßíÔºåJSZip Êâç‰ºöÂÆåÊàêÂä†ËΩΩ„ÄÇ",
                    ),
                    void (e.target.value = "")
                );
            if (
                !confirm(
                    "‚ö†Ô∏è Ë≠¶ÂëäÔºöÂØºÂÖ•Â∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ\nÂª∫ËÆÆÂÖàÂ§á‰ªΩÁé∞ÊúâÊï∞ÊçÆ„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü",
                )
            )
                return void (e.target.value = "");
            const s = document.createElement("div");
            ((s.className = "system-loader-overlay"),
                (s.innerHTML = `\n        ${h}\n        <div class="system-loader-card">\n            <div class="loader-icon-wrapper">\n                <div class="spinner-ios"></div>\n            </div>\n            <div class="loader-title">Ê≠£Âú®ÊÅ¢Â§çÊï∞ÊçÆ</div>\n            <div class="loader-desc" id="import-status-text">Ëß£ÊûêÊñá‰ª∂‰∏≠...</div>\n            <div class="progress-track">\n                <div class="progress-fill" id="import-progress-bar"></div>\n            </div>\n        </div>\n    `),
                document.body.appendChild(s));
            const i = document.getElementById("import-status-text"),
                r = document.getElementById("import-progress-bar");
            try {
                if ((console.log("üìÇ ÂºÄÂßãËß£ÊûêÂ§á‰ªΩÊñá‰ª∂..."), o)) {
                    (console.log("üìÑ Ê£ÄÊµãÂà∞ JSON Ê†ºÂºèÂ§á‰ªΩÔºå‰ΩøÁî®ÊóßÁâàÂØºÂÖ•ÈÄªËæë..."),
                        (i.textContent = "Ê≠£Âú®ËØªÂèñ JSON Êñá‰ª∂..."));
                    const e = await t.text(),
                        n = JSON.parse(e);
                    let a = 0;
                    const o = Object.keys(n);
                    for (let e = 0; e < o.length; e++) {
                        const s = o[e],
                            l = n[s];
                        if (!Array.isArray(l) || 0 === l.length) continue;
                        i.textContent = `Ê≠£Âú®ÊÅ¢Â§ç: ${s}...`;
                        const c = Math.round(((e + 1) / o.length) * 100);
                        r && (r.style.width = `${c}%`);
                        try {
                            await Kl.clearStore(s);
                        } catch (e) {
                            console.warn(`Ë∑≥ËøáÊ∏ÖÁ©∫‰∏çÂ≠òÂú®ÁöÑË°®: ${s}`);
                            continue;
                        }
                        let d = xd ? 10 : 50;
                        xd &&
                            t &&
                            t.size &&
                            t.size > 10485760 &&
                            ((d = 5),
                                (i.textContent =
                                    "iOS Â§ßÊñá‰ª∂ÂØºÂÖ•ÔºöÂêØÁî®Ë∂Ö‰ΩéÈÄüÊ®°ÂºèÔºàÊõ¥ÂÆâÂÖ®‰ΩÜÊõ¥ÊÖ¢Ôºâ"));
                        for (let t = 0; t < l.length; t += d) {
                            const n = Math.min(t + d, l.length),
                                a = l.slice(t, n),
                                c = Math.round(((e + t / l.length) / o.length) * 100);
                            ((i.textContent = `ÊÅ¢Â§ç ${s}: ${t}/${l.length}`),
                                r && (r.style.width = `${c}%`));
                            for (const e of a)
                                try {
                                    void 0 !== e.id && void 0 !== e.value
                                        ? await Kl.saveData(s, e.id, e.value)
                                        : void 0 !== e.id && (await Kl.updateRecord(s, e));
                                } catch (t) {
                                    console.warn("Ë∑≥ËøáÊó†ÊïàËÆ∞ÂΩï:", e);
                                }
                            await new Promise((e) => setTimeout(e, 20));
                        }
                        (a++, console.log(`‚úÖ Ë°® ${s} ÊÅ¢Â§çÂÆåÊàêÔºåÂÖ± ${l.length} Êù°`));
                    }
                    return (
                        document.body.removeChild(s),
                        alert(`üéâ JSON ÂØºÂÖ•ÊàêÂäüÔºÅ\\nÊàêÂäüÊÅ¢Â§ç‰∫Ü ${a} ‰∏™Ê®°ÂùóÁöÑÊï∞ÊçÆ„ÄÇ`),
                        void location.reload()
                    );
                }
                if (
                    (console.log("üì¶ Ê£ÄÊµãÂà∞ ZIP Ê†ºÂºèÂ§á‰ªΩÔºå‰ΩøÁî®Êñ∞ÁâàÂØºÂÖ•ÈÄªËæë..."),
                        xd &&
                        t &&
                        t.size &&
                        t.size > 10485760 &&
                        !confirm(
                            "‚ö†Ô∏è Ê£ÄÊµãÂà∞ iOS ËÆæÂ§á‰∏îÂØºÂÖ•Êñá‰ª∂ËæÉÂ§ßÔºå‰∏∫ÈÅøÂÖçÂ¥©Ê∫ÉÂ∞ÜÂêØÁî®Ë∂Ö‰ΩéÈÄüÊÅ¢Â§çÊ®°ÂºèÔºàÊõ¥ÊÖ¢‰ΩÜÊõ¥ÂÆâÂÖ®ÔºâÔºåÊòØÂê¶ÁªßÁª≠ÂØºÂÖ•Ôºü",
                        ))
                )
                    return (
                        document.body.contains(s) && document.body.removeChild(s),
                        void (e.target.value = "")
                    );
                const n = await JSZip.loadAsync(t),
                    a = n.file("version.json");
                if (a) {
                    const e = JSON.parse(await a.async("string"));
                    console.log("Â§á‰ªΩÁâàÊú¨‰ø°ÊÅØ:", e);
                }
                let l = 0;
                for (const e of Ed) {
                    let t = n.file(`${e}.json`) || n.file(`data/${e}.json`);
                    if (!t) {
                        console.log(`Ë∑≥Ëøá: ZIP‰∏≠Êú™ÊâæÂà∞ ${e} Ë°®ÁöÑÊï∞ÊçÆ`);
                        continue;
                    }
                    const a = Ed.indexOf(e),
                        o = Ed.length,
                        s = Math.round((a / o) * 100);
                    r && (r.style.width = `${s}%`);
                    try {
                        (await Cd(e, t, i, r, n, a, o), l++);
                        const s = Math.round(((a + 1) / o) * 100);
                        (r && (r.style.width = `${s}%`),
                            console.log(`‚úÖ ${e} ÂØºÂÖ•ÂÆåÊàê (${s}%)`));
                    } catch (a) {
                        console.error(`ÊµÅÂºèÂØºÂÖ•Â§±Ë¥•: ${e}`, a);
                        let o = 0;
                        if (
                            (t._data &&
                                t._data.uncompressedSize &&
                                (o = t._data.uncompressedSize),
                                o > 0 && o < 5242880)
                        ) {
                            console.log("Â∞ùËØïÂõûÈÄÄÂà∞ÊôÆÈÄöÊ®°Âºè...");
                            try {
                                const a = await t.async("string"),
                                    o = JSON.parse(a);
                                if (Array.isArray(o)) {
                                    await Kl.clearStore(e);
                                    for (const t of o)
                                        (await Bd(t, n),
                                            "emojiStore" === e
                                                ? await Kl.updateRecord(e, t)
                                                : void 0 !== t.id && void 0 !== t.value
                                                    ? await Kl.saveData(e, t.id, t.value)
                                                    : void 0 !== t.id && (await Kl.updateRecord(e, t)));
                                    (l++, console.log("‚úÖ ÂõûÈÄÄÊ®°ÂºèÂØºÂÖ•ÊàêÂäü"));
                                }
                            } catch (e) {
                                console.error("ÂõûÈÄÄÊ®°Âºè‰πüÂ§±Ë¥•‰∫Ü", e);
                            }
                        } else console.warn(`Êñá‰ª∂ËøáÂ§ßÊàñÊó†Ê≥ïËØªÂèñÂ§ßÂ∞è (${o})ÔºåÊîæÂºÉÂõûÈÄÄÊ®°Âºè`);
                    }
                }
                i.textContent = "Ê≠£Âú®ÂÆåÊàê...";
                const c = n.file("localStoragePresets.json");
                if (c)
                    try {
                        const e = await c.async("string"),
                            t = JSON.parse(e);
                        (t.themePresets &&
                            (localStorage.setItem("themePresets", t.themePresets),
                                console.log("‚úÖ Â∑≤ÊÅ¢Â§ç‰∏ªÈ¢òÈ¢ÑËÆæ")),
                            t.bubblePresets &&
                            (localStorage.setItem("bubblePresets", t.bubblePresets),
                                console.log("‚úÖ Â∑≤ÊÅ¢Â§çÊ∞îÊ≥°È¢ÑËÆæ")),
                            t.meetuStyles &&
                            (localStorage.setItem("meetuStyles_backup", t.meetuStyles),
                                console.log("‚úÖ Â∑≤ÊÅ¢Â§çÁ¨îÈ£éÈ¢ÑËÆæ (LocalStorage)")));
                    } catch (e) {
                        console.warn("localStorage È¢ÑËÆæÊÅ¢Â§çÂ§±Ë¥•:", e);
                    }
                ("function" == typeof runDiagnosticCheck &&
                    (await runDiagnosticCheck()),
                    document.body.removeChild(s),
                    alert(`üéâ ÂØºÂÖ•ÊàêÂäüÔºÅ\nÊàêÂäüÊÅ¢Â§ç‰∫Ü ${l} ‰∏™Ê®°ÂùóÁöÑÊï∞ÊçÆ„ÄÇ`),
                    location.reload());
            } catch (e) {
                (console.error("ÂØºÂÖ•ËøáÁ®ã‰∏≠Âá∫Èîô:", e),
                    document.body.contains(s) && document.body.removeChild(s),
                    alert(`‚ùå ÂØºÂÖ•Â§±Ë¥•: ${e.message}`));
            } finally {
                e.target.value = "";
            }
        }),
        yl.addEventListener("click", async () => {
            if (!uc) return;
            const e = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊ≠åÂçïÂêçÁß∞Ôºö", uc);
            if (null === e || "" === e.trim()) return;
            const t = e.trim();
            if (t !== uc)
                try {
                    const e = await Kl.loadData("musicPlaylists", "allPlaylists");
                    if (!e || "object" != typeof e.value)
                        throw new Error("Êó†Ê≥ïÂä†ËΩΩÊ≠åÂçïÊï∞ÊçÆÂ∫ì„ÄÇ");
                    let n = e.value;
                    if (n[t]) return void alert("ÈîôËØØÔºöËØ•Ê≠åÂçïÂêçÁß∞Â∑≤Â≠òÂú®ÔºÅ");
                    ((n[t] = n[uc]),
                        delete n[uc],
                        await Kl.saveData("musicPlaylists", "allPlaylists", n),
                        await cc());
                    const a = document.getElementById("playlist-name-title");
                    (a && (a.textContent = t), (uc = t), alert("Ê≠åÂçïÂêçÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ"));
                } catch (e) {
                    (console.error("ÁºñËæëÊ≠åÂçïÂêçÁß∞Â§±Ë¥•:", e),
                        alert(`ÁºñËæëÂ§±Ë¥•: ${e.message}`));
                }
        }),
        Ci.addEventListener("click", () => {
            (($i = !$i), il.classList.toggle("delete-mode", $i));
            Ci.querySelector(".icon-select");
            const e = document.getElementById("add-playlist-btn");
            $i
                ? ((Ci.style.color = "#007AFF"),
                    (e.textContent = "Âà†Èô§ÊâÄÈÄâÊ≠åÂçï"),
                    e.classList.add("delete-mode-btn"),
                    (e.style.backgroundColor = "rgba(255, 59, 48, 0.15)"),
                    (e.style.color = "#FF3B30"),
                    (e.style.borderColor = "rgba(255, 59, 48, 0.3)"))
                : ((Ci.style.color = ""),
                    (e.textContent = "Êñ∞Âª∫Ê≠åÂçï"),
                    e.classList.remove("delete-mode-btn"),
                    (e.style.backgroundColor = ""),
                    (e.style.color = ""),
                    (e.style.borderColor = ""),
                    il
                        .querySelectorAll(".playlist-checkbox")
                        .forEach((e) => (e.checked = !1)));
        }),
        sl.addEventListener("click", () => {
            $i
                ? (async function () {
                    const e = il.querySelectorAll(".playlist-checkbox:checked");
                    if (0 === e.length)
                        return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÊ≠åÂçï„ÄÇ");
                    if (
                        !confirm(
                            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™Ê≠åÂçïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`,
                        )
                    )
                        return;
                    const t = new Set();
                    e.forEach((e) => {
                        const n = e.closest(".playlist-card");
                        t.add(n.dataset.playlistName);
                    });
                    try {
                        let e = (await Kl.loadData("musicPlaylists", "allPlaylists"))
                            .value;
                        (t.forEach((t) => {
                            delete e[t];
                        }),
                            await Kl.saveData("musicPlaylists", "allPlaylists", e),
                            await cc(),
                            Ci.click());
                    } catch (e) {
                        (console.error("Âà†Èô§Ê≠åÂçïÂ§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•"));
                    }
                })()
                : (async function () {
                    const e = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊ≠åÂçïÂêçÁß∞Ôºö");
                    if (e && "" !== e.trim()) {
                        const t = e.trim();
                        try {
                            const e = await Kl.loadData("musicPlaylists", "allPlaylists");
                            let n = e && "object" == typeof e.value ? e.value : {};
                            if (n[t]) return void alert("Ê≠åÂçïÂêçÁß∞Â∑≤Â≠òÂú®ÔºÅ");
                            ((n[t] = {
                                songs: [],
                                coverUrl: null,
                            }),
                                await Kl.saveData("musicPlaylists", "allPlaylists", n),
                                lc(t, n[t]));
                        } catch (e) {
                            console.error("‰øùÂ≠òÊ≠åÂçïÂ§±Ë¥•:", e);
                        }
                    }
                })();
        }));
    const $d = "sans-serif";
    let cachedFontObjectURL = null;
    let fontOperationId = 0; // Êìç‰ΩúÂ∫èÂàóÂè∑ÔºåÈò≤Ê≠¢Á´ûÊÄÅÊù°‰ª∂

    function Md(e) {
        // Â¢ûÂä†Êìç‰ΩúÂ∫èÂàóÂè∑
        const currentOperationId = ++fontOperationId;

        // Ê∏ÖÁêÜÊóßÁöÑ Object URL
        if (cachedFontObjectURL) {
            URL.revokeObjectURL(cachedFontObjectURL);
            cachedFontObjectURL = null;
        }

        // Ê∏ÖÁêÜ document.fonts ‰∏≠ÁöÑËá™ÂÆö‰πâÂ≠ó‰ΩìÔºàÈò≤Ê≠¢ÊÆãÁïôÔºâ
        // Ê≥®ÊÑèÔºöÈÅçÂéÜÊó∂‰∏çËÉΩÁõ¥Êé•Âà†Èô§ÔºåÈúÄË¶ÅÂÖàÊî∂ÈõÜÂÜçÂà†Èô§
        try {
            const fontsToDelete = [];
            document.fonts.forEach((font) => {
                if (font.family.includes('CustomGlobalFont_') || font.family.includes('CustomUrlFont_')) {
                    fontsToDelete.push(font);
                }
            });
            fontsToDelete.forEach(font => {
                try { document.fonts.delete(font); } catch (e) { }
            });
        } catch (err) {
            console.warn('Ê∏ÖÁêÜÊóßÂ≠ó‰ΩìÂ§±Ë¥•:', err);
        }

        // ÂêåÊó∂Ê∏ÖÁ©∫ URL ÁâàÂ≠ó‰ΩìÁöÑÊ†∑ÂºèÊ†áÁ≠æÔºàÈò≤Ê≠¢‰∏§ÁßçÂ≠ó‰ΩìÂÜ≤Á™ÅÔºâ
        const urlStyleTag = document.getElementById("custom-font-url-style");
        if (urlStyleTag) urlStyleTag.innerHTML = "";

        // ËæÖÂä©ÂáΩÊï∞ÔºöÊûÑÂª∫ÂÆåÊï¥ÁöÑÂ≠ó‰Ωì CSSÔºàÂåÖÊã¨Ë¶ÜÁõñÊâÄÊúâÂ≠êÂÖÉÁ¥†ÁöÑËßÑÂàôÔºâ
        function buildFontCSS(fontName, fontUrl) {
            return `
            @font-face {
                font-family: '${fontName}';
                src: url(${fontUrl});
                font-display: swap;
            }
            /* Âº∫Âà∂Ë¶ÜÁõñÊâÄÊúâÂ≠êÂÖÉÁ¥†ÁöÑ font-familyÔºåÂåÖÊã¨ * ÈÄâÊã©Âô® */
            .phone-frame, .phone-frame * {
                font-family: '${fontName}', ${$d} !important;
            }
            `;
        }

        // ÂÖàÂΩªÂ∫ïÊ∏ÖÁ©∫Ê†∑Âºè
        Pr.innerHTML = "";
        Pr.offsetHeight;
        Ii.style.fontFamily = "";

        if (e) {
            // Â¶ÇÊûúÊòØ data: URLÔºåËΩ¨Êç¢‰∏∫ Blob‚ÜíObjectURL ‰ª•Èôç‰ΩéÂÜÖÂ≠òÂéãÂäõ
            if (e.startsWith("data:")) {
                fetch(e)
                    .then((res) => res.blob())
                    .then(async (blob) => {
                        // Ê£ÄÊü•Êìç‰ΩúÊòØÂê¶Â∑≤ËøáÊó∂ÔºàË¢´Êõ¥Êñ∞ÁöÑÊìç‰ΩúË¶ÜÁõñÔºâ
                        if (currentOperationId !== fontOperationId) {
                            console.log('Â≠ó‰ΩìÊìç‰ΩúÂ∑≤Ë¢´Êõ¥Êñ∞ÁöÑÊìç‰ΩúË¶ÜÁõñÔºåË∑≥Ëøá');
                            return;
                        }

                        const fontUrl = URL.createObjectURL(blob);
                        cachedFontObjectURL = fontUrl;
                        const fontName = `CustomGlobalFont_${Date.now()}`;

                        // ‰ΩøÁî® FontFace API Á°Æ‰øùÂ≠ó‰ΩìÂä†ËΩΩÂÆåÊàê
                        try {
                            const fontFace = new FontFace(fontName, `url(${fontUrl})`, { display: 'swap' });
                            await fontFace.load();

                            // ÂÜçÊ¨°Ê£ÄÊü•Êìç‰ΩúÊòØÂê¶Â∑≤ËøáÊó∂
                            if (currentOperationId !== fontOperationId) {
                                URL.revokeObjectURL(fontUrl);
                                return;
                            }

                            document.fonts.add(fontFace);
                            Pr.innerHTML = buildFontCSS(fontName, fontUrl);
                            // Âº∫Âà∂ÈáçÁªò
                            document.body.style.display = 'none';
                            void document.body.offsetHeight;
                            document.body.style.display = '';
                            console.log(`‚úÖ Â≠ó‰ΩìÂ∑≤Â∫îÁî® (FontFace+Blob): ${fontName}`);
                        } catch (fontErr) {
                            console.warn('FontFace API Âä†ËΩΩÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞Á∫ØCSS:', fontErr);
                            if (currentOperationId !== fontOperationId) return;
                            Pr.innerHTML = buildFontCSS(fontName, fontUrl);
                            Pr.offsetHeight;
                            console.log(`‚úÖ Â≠ó‰ΩìÂ∑≤Â∫îÁî® (CSSÂõûÈÄÄ): ${fontName}`);
                        }
                    })
                    .catch((err) => {
                        if (currentOperationId !== fontOperationId) return;

                        console.error("Â≠ó‰ΩìBlobËΩ¨Êç¢Â§±Ë¥•ÔºåÂõûÈÄÄÂà∞ Data URL:", err);
                        const fontName = `CustomGlobalFont_${Date.now()}`;
                        Pr.innerHTML = buildFontCSS(fontName, e);
                        Pr.offsetHeight;
                        console.log(`‚úÖ Â≠ó‰ΩìÂ∑≤Â∫îÁî® (Data URLÂõûÈÄÄ): ${fontName}`);
                    });
            } else {
                // Áõ¥Êé• URLÔºå‰∏çÈúÄË¶ÅËΩ¨Êç¢
                const t = `CustomGlobalFont_${Date.now()}`;
                Pr.innerHTML = buildFontCSS(t, e);
                Pr.offsetHeight;
                console.log(`‚úÖ Â≠ó‰ΩìÂ∑≤Â∫îÁî®: ${t}`);
            }
        } else {
            // ÊÅ¢Â§çÈªòËÆ§ - ÈúÄË¶ÅÊ∑ªÂä†‰∏Ä‰∏™Ê∏ÖÈô§ !important ÁöÑËßÑÂàô
            Pr.innerHTML = `
                /* ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì */
                .phone-frame, .phone-frame * {
                    font-family: ${$d} !important;
                }
            `;
            Pr.offsetHeight;
            // Áü≠ÊöÇÂª∂ËøüÂêéÊ∏ÖÁ©∫ÔºåËÆ©ÊµèËßàÂô®ÊúâÊó∂Èó¥Â∫îÁî®ÈªòËÆ§ÂÄº
            setTimeout(() => {
                if (currentOperationId === fontOperationId) {
                    Pr.innerHTML = "";
                    Ii.style.fontFamily = $d;
                }
            }, 100);
            console.log("‚úÖ Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì");
        }
    }
    (navigator.serviceWorker.addEventListener("message", (e) => {
        const t = e.data;
        "OPEN_CHAT" === t.type &&
            t.contactId &&
            (console.log(
                `Êî∂Âà∞Êù•Ëá™ Service Worker ÁöÑÊåá‰ª§ÔºåÊ≠£Âú®ÊâìÂºÄËÅîÁ≥ª‰∫∫ID: ${t.contactId} ÁöÑËÅäÂ§©„ÄÇ`,
            ),
                Nc(t.contactId));
    }),
        Hr.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            if (t) {
                e.target.value = "";
                try {
                    if (
                        window.iOSBabyMode &&
                        window.iOSBabyMode.shouldRecommendURL(t, "font")
                    ) {
                        if (
                            !confirm(
                                `üçº iOSÂÆùÂÆùÊ®°ÂºèÊèêÁ§∫\n\nÊ£ÄÊµãÂà∞Â≠ó‰ΩìÊñá‰ª∂ËæÉÂ§ß (${(t.size / 1024 / 1024).toFixed(1)}MB)ÔºåÂú®iOS‰∏äÁõ¥Êé•ÂØºÂÖ•ÂèØËÉΩÂØºËá¥ÊµèËßàÂô®Â¥©Ê∫É„ÄÇ\n\nüìé Êé®ËçêÊñπÊ°àÔºö\n‚Ä¢ Â∞ÜÂ≠ó‰Ωì‰∏ä‰º†Âà∞ÁΩëÁõò/ÂõæÂ∫ä\n‚Ä¢ ‰ΩøÁî®„ÄåÁæéÂåñ ‚Üí Â≠ó‰ΩìURL„ÄçÂäüËÉΩÂä†ËΩΩ\n\nÁÇπÂáª„ÄåÁ°ÆÂÆö„ÄçÁªßÁª≠Â∞ùËØïÂØºÂÖ•Ôºà‰ºöÂàÜÂùóÂ§ÑÁêÜÔºâ\nÁÇπÂáª„ÄåÂèñÊ∂à„ÄçÊîæÂºÉÂØºÂÖ•`,
                            )
                        )
                            return;
                    }
                    let e;
                    (window.iOSBabyMode &&
                        window.iOSBabyMode.enabled &&
                        window.iOSBabyMode.showProgressToast("Ê≠£Âú®ËØªÂèñÂ≠ó‰Ωì...", 0),
                        (e = window.iOSBabyMode
                            ? await window.iOSBabyMode.safeReadFileAsDataURL(t, (e) => {
                                window.iOSBabyMode.showProgressToast("Ê≠£Âú®ËØªÂèñÂ≠ó‰Ωì...", e);
                            })
                            : await new Promise((e, n) => {
                                const a = new FileReader();
                                ((a.onload = (t) => e(t.target.result)),
                                    (a.onerror = n),
                                    a.readAsDataURL(t));
                            })),
                        window.iOSBabyMode &&
                        window.iOSBabyMode.enabled &&
                        (window.iOSBabyMode.showProgressToast("Ê≠£Âú®‰øùÂ≠òÂ≠ó‰Ωì...", null),
                            await new Promise((e) => setTimeout(e, 100))),
                        await Kl.saveData("settingsStore", "customFont", e),
                        window.iOSBabyMode &&
                        window.iOSBabyMode.enabled &&
                        (await new Promise((e) => setTimeout(e, 50))),
                        Md(e),
                        window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                        alert("‚úÖ Â≠ó‰ΩìÂ∑≤ÊàêÂäüÂ∫îÁî®ÔºÅ"));
                } catch (e) {
                    (console.error("‰øùÂ≠òÊàñÂ∫îÁî®Â≠ó‰ΩìÂ§±Ë¥•:", e),
                        window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                        alert(
                            `‚ùå Â≠ó‰ΩìÂ∫îÁî®Â§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØï‰ΩøÁî®Â≠ó‰ΩìURLÂäüËÉΩ"}`,
                        ));
                }
            }
        }));
    const Td = document.getElementById("chat-search-button"),
        Ad = document.getElementById("search-modal"),
        Dd = document.getElementById("search-modal-close-btn"),
        Pd = document.getElementById("search-input"),
        Hd = document.getElementById("search-results-container");
    let Od;

    function qd() {
        (Pd.blur(),
            (Ad.style.opacity = "0"),
            (Ad.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((Ad.style.display = "none"), (Pd.value = ""), (Hd.innerHTML = ""));
            }, 300));
    }

    function Nd(e, t, n) {
        0 !== e.length
            ? (Hd.innerHTML = e
                .map((e) => {
                    const a = new Date(e.message.timestamp),
                        o = `${String(a.getMonth() + 1).padStart(2, "0")}-${String(a.getDate()).padStart(2, "0")} ${String(a.getHours()).padStart(2, "0")}:${String(a.getMinutes()).padStart(2, "0")}`,
                        s = (function (e, t, n = 3) {
                            const a = e.replace(/(\r\n|\n|\r)/gm, " "),
                                o = a.toLowerCase().indexOf(t.toLowerCase());
                            if (-1 === o) return a.substring(0, 2 * n + t.length) + "...";
                            const s = Math.max(0, o - n),
                                i = Math.min(a.length, o + t.length + n);
                            let r = a.substring(s, i);
                            return (
                                s > 0 && (r = "..." + r),
                                i < a.length && (r += "..."),
                                r
                            );
                        })(
                            e.message.text ||
                            (e.message.content ? e.message.content.html : "") ||
                            e.message.transcript ||
                            "[Â§öÂ™í‰Ωì]",
                            t,
                        ),
                        i = s.replace(n, '<span class="highlight">$&</span>');
                    return `\n    <div class="search-result-item" ${e.isGroup ? `data-group-id="${e.contextId}"` : `data-contact-id="${e.contextId}"`} data-uuid="${e.message.uuid}">\n        <div class="result-header">\n            <div class="sender-name">${e.senderName}:</div>\n            <div class="time">${o}</div>\n        </div>\n        <div class="chatsearch-content">${i}</div>\n    </div>\n`;
                })
                .join(""))
            : (Hd.innerHTML =
                '<p style="text-align:center; color:#888;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËÆ∞ÂΩï</p>');
    }
    async function _d(e, t, n = !1) {
        (qd(),
            n
                ? await qm(e)
                : await Nc(e, {
                    targetMessageUuid: t,
                }),
            setTimeout(() => {
                const e = Xi.querySelector(`.message-row[data-uuid="${t}"]`);
                e &&
                    (e.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    }),
                        e.classList.add("message-highlight"),
                        setTimeout(() => e.classList.remove("message-highlight"), 1500));
            }, 500),
            xo.blur());
    }
    (Td.addEventListener("click", function () {
        ((Ad.style.display = "flex"),
            setTimeout(() => {
                ((Ad.style.opacity = "1"),
                    (Ad.querySelector(".modal-content").style.transform = "scale(1)"),
                    Pd.focus());
            }, 10));
    }),
        Dd.addEventListener("click", qd),
        Pd.addEventListener("input", () => {
            (clearTimeout(Od),
                (Od = setTimeout(() => {
                    !(async function (e) {
                        if (!e || e.length < 1) return void (Hd.innerHTML = "");
                        let t = [],
                            n = null,
                            a = !1;
                        if (Je)
                            ((t = Array.isArray(Je.history) ? Je.history : []),
                                (n = Je.id),
                                (a = !0));
                        else {
                            if (!Sc) return;
                            ((t = Array.isArray(Sc.history) ? Sc.history : []),
                                (n = Sc.id),
                                (a = !1));
                        }
                        const o = [];
                        for (const s of t) {
                            const t =
                                s.text || (s.content && s.content.html) || s.transcript || "";
                            if (
                                s.uuid &&
                                "string" == typeof t &&
                                t.toLowerCase().includes(e.toLowerCase())
                            ) {
                                let e = "Êú™Áü•";
                                ((e = a
                                    ? "user" === s.sender
                                        ? Je.userCardName || "Êàë"
                                        : s.senderName || "Áæ§Âèã"
                                    : "user" === s.sender
                                        ? Sc.user.name
                                        : Sc.ai.name),
                                    o.push({
                                        message: s,
                                        senderName: e,
                                        contextId: n,
                                        isGroup: a,
                                    }));
                            }
                        }
                        const s = new RegExp(
                            e.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"),
                            "gi",
                        );
                        Nd(o, e, s);
                    })(Pd.value.trim());
                }, 300)));
        }),
        Hd.addEventListener("click", (e) => {
            const t = e.target.closest(".search-result-item");
            if (t) {
                (e.preventDefault(), e.stopPropagation());
                const n = document.getElementById("click-shield");
                n.style.display = "block";
                const a = t.dataset.uuid,
                    o = t.dataset.contactId ? parseInt(t.dataset.contactId, 10) : null,
                    s = t.dataset.groupId ? parseInt(t.dataset.groupId, 10) : null;
                (qd(),
                    s ? _d(s, a, !0) : o && _d(o, a, !1),
                    setTimeout(() => {
                        n.style.display = "none";
                    }, 400));
            }
        }));
    const Fd = document.getElementById("island-invite-button"),
        Rd = document.getElementById("invite-modal"),
        Gd = document.getElementById("invite-modal-close-btn"),
        Wd = document.getElementById("invite-contact-list-container");

    function jd() {
        ((Rd.style.display = "flex"),
            (async function () {
                Wd.innerHTML =
                    '<p style="text-align:center; color:#888;">Ê≠£Âú®Âä†ËΩΩËÅîÁ≥ª‰∫∫...</p>';
                try {
                    const e = await Kl.loadData("messageContacts", "allContacts");
                    e && Array.isArray(e.value) && e.value.length > 0
                        ? ((Wd.innerHTML = ""),
                            e.value.forEach((e) => {
                                const t = document.createElement("div");
                                ((t.className = "invite-contact-item"),
                                    (t.innerHTML = `\n                    <img src="${e.ai.avatar}" alt="avatar" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.ai.name}</span>\n                    <button class="invite-button" data-contact-id="${e.id}">ÈÇÄËØ∑</button>\n                `),
                                    Wd.appendChild(t));
                            }))
                        : (Wd.innerHTML =
                            '<p style="text-align:center; color:#888;">‰Ω†ËøòÊ≤°Êúâ‰ªª‰ΩïËÅîÁ≥ª‰∫∫„ÄÇ</p>');
                } catch (e) {
                    (console.error("Âä†ËΩΩËÅîÁ≥ª‰∫∫ÂàóË°®Â§±Ë¥•:", e),
                        (Wd.innerHTML =
                            '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ</p>'));
                }
            })(),
            setTimeout(() => {
                ((Rd.style.opacity = "1"),
                    (Rd.querySelector(".modal-content").style.transform = "scale(1)"));
            }, 10));
    }

    function Ud() {
        ((Rd.style.opacity = "0"),
            (Rd.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                Rd.style.display = "none";
            }, 300));
    }
    (Fd.addEventListener("click", (e) => {
        (e.stopPropagation(), jd());
    }),
        Gd.addEventListener("click", Ud),
        Rd.addEventListener("click", (e) => {
            e.target === Rd && Ud();
        }),
        Wd.addEventListener("click", async (e) => {
            if (e.target.classList.contains("invite-button") && !e.target.disabled) {
                if (!ec.currentSong) return void alert("ËØ∑ÂÖàÊí≠Êîæ‰∏ÄÈ¶ñÊ≠åÊõ≤ÂÜçÈÇÄËØ∑ÔºÅ");
                const t = e.target,
                    n = parseInt(t.dataset.contactId, 10);
                ((t.textContent = "Â∑≤ÈÇÄËØ∑"),
                    (t.disabled = !0),
                    t.classList.add("invited"));
                try {
                    const e = ec.currentSong.title,
                        t = ec.currentSong.artist,
                        a = {
                            sender: "user",
                            text: `[MUSIC_SHARE]ÂØπÊñπÈÇÄËØ∑‰Ω†Êî∂Âê¨-${e}-${t}[MUSIC_SHARE]`,
                            timestamp: new Date(),
                            uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                        };
                    Sc && Sc.id === n && Vc(a);
                    let o =
                        (await Kl.loadData("messageContacts", "allContacts")).value || [];
                    const s = o.findIndex((e) => e.id === n);
                    if (!(s > -1)) throw new Error("Âú®Êï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞ÁõÆÊ†áËÅîÁ≥ª‰∫∫„ÄÇ");
                    {
                        const n = o[s];
                        (Array.isArray(n.history) || (n.history = []),
                            n.history.push(a),
                            (n.lastMessage = "ÂàÜ‰∫´‰∫Ü‰∏ÄËµ∑Âê¨ÈÇÄËØ∑"),
                            await Kl.saveData("messageContacts", "allContacts", o),
                            Ud());
                        const i = `(ÊàëÁªô‰Ω†ÂàÜ‰∫´‰∫Ü‰∏ÄËµ∑Âê¨ÁöÑÈÇÄËØ∑ÔºåÊ≠åÊõ≤ÊòØ„Ää${e}„Äã - ${t}ÔºåËØ∑Ê†πÊçÆÊàë‰ª¨ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíå‰Ω†ÁöÑ‰∫∫ËÆæÔºåËá™ÁÑ∂Âú∞ÂÜ≥ÂÆöÊòØÂê¶Êé•Âèó„ÄÇ)`;
                        await Tc(i, n);
                    }
                } catch (e) {
                    (console.error("ÂèëÈÄÅÈÇÄËØ∑Âç°ÁâáÂ§±Ë¥•:", e),
                        alert("ÂèëÈÄÅÈÇÄËØ∑Â§±Ë¥•"),
                        (t.textContent = "ÈÇÄËØ∑"),
                        (t.disabled = !1),
                        t.classList.remove("invited"));
                }
            }
        }));
    let zd = {
        active: !1,
        contact: null,
    };
    const Vd = document.getElementById("shared-listening-avatars"),
        Jd = document.getElementById("avatar-image-container");

    function Yd() {
        if (zd.active && zd.contact) {
            const e = zd.contact.user.avatar,
                t = zd.contact.ai.avatar;
            ((Jd.innerHTML = `\n            <img src="${e}" class="shared-avatar-img" title="${zd.contact.user.name}">\n            <img src="${t}" class="shared-avatar-img" title="${zd.contact.ai.name}">\n        `),
                Vd.classList.add("active"));
        } else ((Jd.innerHTML = ""), Vd.classList.remove("active"));
    }
    const Kd = document.getElementById("end-session-bubble"),
        Zd = document.getElementById("end-listening-session-btn");
    async function Xd(e, t) {
        if (!t) return;
        const n = {
            sender: "system",
            type: "system",
            text: e,
            timestamp: new Date(),
            uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
        };
        (await Ac(n, t),
            Sc &&
            Sc.id === t &&
            (Vc(n),
                Xi.scrollTo({
                    top: Xi.scrollHeight,
                    behavior: "smooth",
                })));
    }

    function Qd() {
        ((vl.style.opacity = "0"),
            (vl.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((vl.style.display = "none"), (bl.value = ""));
            }, 300));
    }
    async function eu() {
        try {
            let e = await Kl.getAllDataFromStore("emojiStore");
            if (
                (e &&
                    Array.isArray(e) &&
                    e.sort((e, t) => (t.timestamp || 0) - (e.timestamp || 0)),
                    (El.innerHTML = ""),
                    !e || 0 === e.length)
            )
                return void (El.innerHTML =
                    '<p style="color:#aaa; font-size:14px; text-align:center; grid-column: 1 / -1;">Âø´Êù•Ê∑ªÂä†Ë°®ÊÉÖÂåÖÂåÖÂêßÔºÅ</p>');
            const t = window.iOSBabyMode && window.iOSBabyMode.enabled,
                n = t ? 10 : 30;
            let a = 0;
            !(async function o() {
                const s = e.slice(a, a + n);
                if (0 === s.length) return;
                const i = document.createDocumentFragment();
                (s.forEach((e) => {
                    const t = document.createElement("div");
                    ((t.className = "emoji-item-container"),
                        (t.innerHTML = `\n                    <input type="checkbox" class="emoji-checkbox" value="${e.url}">\n                    <img src="${e.url}" class="emoji-item" title="ÁÇπÂáªÂèëÈÄÅ" data-url="${e.url}">\n                    <p class="emoji-remark" contenteditable="true">${e.remark}</p>\n                `));
                    (t
                        .querySelector(".emoji-remark")
                        .addEventListener("blur", async (e) => {
                            const n = e.target.textContent.trim(),
                                a = t.querySelector(".emoji-item").dataset.url;
                            if (n)
                                try {
                                    await Kl.updateRecord("emojiStore", {
                                        url: a,
                                        remark: n,
                                    });
                                } catch (e) {
                                    console.error("Êõ¥Êñ∞Â§áÊ≥®Â§±Ë¥•:", e);
                                }
                            else e.target.textContent = "ÁÇπÂáª‰øÆÊîπÂ§áÊ≥®";
                        }),
                        i.appendChild(t));
                }),
                    El.appendChild(i),
                    (a += n),
                    t
                        ? (await new Promise((e) => setTimeout(e, 50)), o())
                        : requestAnimationFrame(o));
            })();
        } catch (e) {
            console.error("Âä†ËΩΩË°®ÊÉÖÂ§±Ë¥•:", e);
        }
    }
    async function tu() {
        if (wo) return (await new Promise((e) => setTimeout(e, 100)), tu());
        wo = !0;
        try {
            if (!Sc) return;
            const e = await Kl.loadData("messageContacts", "allContacts");
            let t = e && Array.isArray(e.value) ? e.value : [];
            const n = t.findIndex((e) => e.id === Sc.id);
            if (
                (n > -1 ? (t[n] = structuredClone(Sc)) : t.push(structuredClone(Sc)),
                    await Kl.saveData("messageContacts", "allContacts", t),
                    window.LittleWorld && Sc)
            )
                try {
                    const e = await Kl.loadData("settingsStore", `littleWorld_${Sc.id}`);
                    if (e && e.value) {
                        const t = e.value,
                            n = Sc.history ? Sc.history.length : 0,
                            a = Math.max(0, n - t.baseCount);
                        a > t.incrementCount &&
                            ((t.incrementCount = a),
                                await Kl.saveData("settingsStore", `littleWorld_${Sc.id}`, t),
                                setTimeout(async () => {
                                    try {
                                        await window.LittleWorld.backgroundCheck(Sc, t);
                                    } catch (e) {
                                        console.warn("[LittleWorld] ÂêéÂè∞Ê£ÄÊü•Â§±Ë¥•:", e);
                                    }
                                }, 100));
                    }
                } catch (e) {
                    console.warn("[LittleWorld] ÂêéÂè∞Èí©Â≠êÂºÇÂ∏∏:", e);
                }
        } catch (e) {
            console.error("Master save function failed:", e);
        } finally {
            wo = !1;
        }
    }
    async function nu() {
        const e = await Kl.loadData("settingsStore", "customAppIcons");
        if (e && e.value) {
            const t = e.value;
            for (const e in t) {
                const n = t[e],
                    a = document.querySelector(`#${e} .app-icon img`);
                a && n && (a.src = n);
            }
        }
    }

    function au(e) {
        pi.forEach((t) => {
            t.style.color = e;
        });
    }

    function ou(e) {
        e
            ? li.classList.add("clock-blur-enabled")
            : li.classList.remove("clock-blur-enabled");
    }
    (Vd.addEventListener("click", (e) => {
        zd.active &&
            (e.target.closest("#end-listening-session-btn") ||
                Kd.classList.toggle("active"));
    }),
        Zd.addEventListener("click", async (e) => {
            (e.stopPropagation(), Kd.classList.remove("active"));
            try {
                (await Xd("Â∑≤ÁªèÁªìÊùü‰∏ÄËµ∑Âê¨", zd.contact.id),
                    await Tc("(ÊàëÂ∑≤ÁªèÁªìÊùü‰∫Ü‰∏ÄËµ∑Âê¨Ê®°ÂºèÔºåÊàë‰ª¨ÁªßÁª≠ËÅäÂêß)", zd.contact));
            } catch (e) {
                console.error("Âú®ÁªìÊùü‚Äú‰∏ÄËµ∑Âê¨‚ÄùÂπ∂ÈÄöÁü•AIÊó∂ÂèëÁîüÈîôËØØ:", e);
            } finally {
                ((zd.active = !1), (zd.contact = null), Yd());
            }
        }),
        document.addEventListener(
            "click",
            (e) => {
                Kd.classList.contains("active") &&
                    !Vd.contains(e.target) &&
                    Kd.classList.remove("active");
            },
            !0,
        ),
        hl.addEventListener("click", () => {
            wi
                ? (async function () {
                    const e = El.querySelectorAll(".emoji-checkbox:checked");
                    if (0 === e.length)
                        return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑË°®ÊÉÖ„ÄÇ");
                    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™Ë°®ÊÉÖÂêóÔºü`)) return;
                    try {
                        let t = 0;
                        for (const n of e) {
                            const e = n.value;
                            (await Kl.deleteData("emojiStore", e), t++);
                        }
                        (alert(`ÊàêÂäüÂà†Èô§‰∫Ü ${t} ‰∏™Ë°®ÊÉÖÔºÅ`), await eu(), fi.click());
                    } catch (e) {
                        (console.error("Âà†Èô§Ë°®ÊÉÖÂ§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•"));
                    }
                })()
                : (function () {
                    const e = document.getElementById("emoji-urls-textarea");
                    (e && (e.value = ""),
                        (vl.style.display = "flex"),
                        setTimeout(() => {
                            ((vl.style.opacity = "1"),
                                (vl.querySelector(".modal-content").style.transform =
                                    "scale(1)"));
                        }, 10));
                })();
        }),
        fl.addEventListener("click", Qd),
        wl.addEventListener("click", async function () {
            const e = document.getElementById("emoji-urls-textarea").value.trim();
            if (!e) return void alert("ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÊï∞ÊçÆÔºÅ");

            // ‰ºòÂåñÊ≠£ÂàôÔºöÊõ¥Á≤æÁ°ÆÂú∞ÂåπÈÖç [Â§áÊ≥®:URL] Ê®°Âºè
            // 1. Â§áÊ≥®: ‰∏çÂåÖÂê´ : Êàñ ]
            // 2. URL: httpÂºÄÂ§¥ÔºåÈùûË¥™Â©™ÂåπÈÖçÂà∞ ] Êàñ Á©∫Ê†º
            const regex = /\[([^:\]\r\n]+):\s*(https?:\/\/[^\]\s"']+)(?:.*?)\]/g;
            const n = [];
            let match;

            // Á¨¨‰∏ÄËΩÆÔºöÁ≤æÁ°ÆÂåπÈÖç
            while ((match = regex.exec(e)) !== null) {
                const remark = match[1].trim();
                const url = match[2].trim();
                if (remark && url) {
                    n.push({ remark: remark, url: url });
                }
            }

            // Á¨¨‰∫åËΩÆÔºöÂ¶ÇÊûúÁ¨¨‰∏ÄËΩÆÊ≤°ÂåπÈÖçÂà∞ÔºåÊàñËÄÖÊòØÂéüÊù•ÁöÑÂÆΩÊùæÊ†ºÂºèÔºàÈíàÂØπ‰∏Ä‰∫õÈùûhttpÂºÄÂ§¥ÁöÑÁâπÊÆäÊÉÖÂÜµÔºåÊàñËÄÖÊ†ºÂºèÊûÅ‰∏çÊ†áÂáÜÔºâ
            // ‰ΩÜËÄÉËôëÂà∞Áî®Êà∑‰∏ªË¶ÅÁî® httpÔºåÊàë‰ª¨‰∏ªË¶Å‰æùËµñÁ¨¨‰∏ÄËΩÆ„ÄÇ‰∏∫‰∫ÜÂÖºÂÆπÔºåÊàë‰ª¨Âè™Âú®ÁªìÊûúÂ∞ëÊó∂Â∞ùËØïÂÆΩÊùæËß£Êûê
            if (n.length === 0) {
                const t = e.match(/\[.*?:\s*.*?\]/g);
                if (t) {
                    for (const item of t) {
                        try {
                            const clean = item.slice(1, -1);
                            const idx = clean.indexOf(":");
                            if (idx > -1) {
                                const r = clean.substring(0, idx).trim();
                                // Êö¥ÂäõÊà™ÂèñÔºöÂ¶ÇÊûúURL‰∏≠Èó¥ÊúâÁ©∫Ê†ºÔºåÂè™ÂèñÂâçÈù¢ÁöÑ
                                let u = clean.substring(idx + 1).trim();
                                // ‰øÆÂ§çÁ≤òËøûÈóÆÈ¢òÔºöÂ¶ÇÊûúURLÂêéÈù¢Á¥ßÊé•ÁùÄ‰∏≠ÊñáÊàñÂÖ∂‰ªñÈùûURLÂ≠óÁ¨¶
                                const spaceMatch = u.match(/\s/);
                                if (spaceMatch) u = u.substring(0, spaceMatch.index);

                                if (r && u.startsWith("http")) n.push({ remark: r, url: u });
                            }
                        } catch (err) { console.warn("Ëß£ÊûêÂ§±Ë¥•:", item); }
                    }
                }
            }

            if (n.length > 0) {
                try {
                    let successCount = 0;
                    const promises = n.map(async (item) => {
                        try {
                            await Kl.performTransaction("emojiStore", "readwrite", (store) => {
                                return store.put({
                                    url: item.url,
                                    remark: item.remark,
                                    timestamp: Date.now()
                                });
                            });
                            successCount++;
                        } catch (err) {
                            console.warn("Failed to save emoji:", item, err);
                        }
                    });

                    await Promise.all(promises);

                    alert(`Â§ÑÁêÜÂÆåÊàêÔºÅ\nÂÖ±Ëß£ÊûêÂà∞ ${n.length} Êù°Êï∞ÊçÆÔºåÊàêÂäüÂÖ•Â∫ì ${successCount} Êù°„ÄÇ`);
                    Qd(); // Âà∑Êñ∞UI
                    eu(); // ÂÖ≥Èó≠ÂºπÁ™óÊàñÈáçÁΩÆ
                } catch (e) {
                    console.error("ÊâπÈáè‰øùÂ≠òÂ§±Ë¥•:", e);
                    alert("‰øùÂ≠òËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞„ÄÇ");
                }
            } else {
                alert("Êú™ÊâæÂà∞ÊúâÊïàÁöÑË°®ÊÉÖÂåÖÊï∞ÊçÆ„ÄÇ\nËØ∑Á°Æ‰øùÊ†ºÂºèÂ¶Ç: [ÂºÄÂøÉ:http://example.com/1.jpg]");
            }
        }),
        vl.addEventListener("click", (e) => {
            e.target === vl && Qd();
        }),
        fi.addEventListener("click", () => {
            ((wi = !wi),
                El.classList.toggle("delete-mode", wi),
                wi
                    ? ((fi.innerHTML =
                        '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <line x1="18" y1="6" x2="6" y2="18"></line>\n            <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>\n    '),
                        (hl.innerHTML =
                            '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="3 6 5 6 21 6"></polyline>\n            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n        </svg>\n    '))
                    : ((fi.innerHTML =
                        '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="6 9 12 15 18 9"></polyline>\n        </svg>\n    '),
                        (hl.innerHTML =
                            '\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <line x1="12" y1="5" x2="12" y2="19"></line>\n            <line x1="5" y1="12" x2="19" y2="12"></line>\n        </svg>\n    '),
                        El.querySelectorAll(".emoji-checkbox").forEach(
                            (e) => (e.checked = !1),
                        )));
        }),
        Il.addEventListener("change", async (e) => {
            if (e.target.classList.contains("icon-url-input")) {
                const t = e.target,
                    n = t.dataset.appId,
                    a = t.value.trim();
                await (async function (e, t) {
                    const n = document.querySelector(`#${e} .app-icon img`),
                        a = document.querySelector(`.icon-preview[data-app-id="${e}"]`);
                    if (!n || !a) return;
                    let o;
                    o = t || n.dataset.defaultSrc;
                    ((n.src = o), (a.src = o));
                    try {
                        const n = await Kl.loadData("settingsStore", "customAppIcons");
                        let a = n && n.value ? n.value : {};
                        (t ? (a[e] = t) : delete a[e],
                            await Kl.saveData("settingsStore", "customAppIcons", a));
                    } catch (e) {
                        console.error("‰øùÂ≠òËá™ÂÆö‰πâÂõæÊ†áÂ§±Ë¥•:", e);
                    }
                })(n, a);
            }
        }),
        ui.addEventListener("input", (e) => {
            const t = e.target.value;
            ((mi.value = t), au(t), Kl.saveData("settingsStore", "clockColor", t));
        }),
        mi.addEventListener("input", (e) => {
            const t = e.target.value;
            ((ui.value = t), au(t), Kl.saveData("settingsStore", "clockColor", t));
        }),
        ri.addEventListener("change", async () => {
            const e = ri.checked;
            (ou(e), await Kl.saveData("settingsStore", "clockBlurEffect", e));
        }));
    const su = document.getElementById("scroll-to-bottom-btn");
    let iu = !1;

    function ru(e) {
        e &&
            e.user &&
            ((ei = e.user),
                (ni.src = ei.avatar),
                console.log(`ÂΩìÂâçË¥≠Áâ©Ë∫´‰ªΩÂ∑≤ÂàáÊç¢‰∏∫: ${ei.name}`));
    }
    async function lu() {
        si.innerHTML = '<p style="text-align:center; color:#888;">Ê≠£Âú®Âä†ËΩΩ...</p>';
        try {
            const e = await Kl.loadData("messageContacts", "allContacts");
            e && Array.isArray(e.value) && e.value.length > 0
                ? ((si.innerHTML = ""),
                    e.value.forEach((e) => {
                        const t = e.user,
                            n = document.createElement("div");
                        ((n.className = "invite-contact-item"),
                            (n.style.cursor = "pointer"),
                            (n.dataset.contactId = e.id),
                            (n.innerHTML = `\n                    <img src="${t.avatar}" alt="avatar" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${t.name}</span>\n                `),
                            si.appendChild(n));
                    }))
                : (si.innerHTML =
                    '<p style="text-align:center; color:#888;">Ê≤°ÊúâÂèØÁî®ÁöÑÁî®Êà∑Ë∫´‰ªΩ</p>');
        } catch (e) {
            (console.error("Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥•:", e),
                (si.innerHTML =
                    '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•</p>'));
        }
        ((ai.style.display = "flex"),
            setTimeout(() => {
                ((ai.style.opacity = "1"),
                    (ai.querySelector(".modal-content").style.transform = "scale(1)"));
            }, 10));
    }

    function cu() {
        ((ai.style.opacity = "0"),
            (ai.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ai.style.display = "none";
            }, 300));
    }
    (Xi.addEventListener(
        "scroll",
        () => {
            iu ||
                (window.requestAnimationFrame(() => {
                    const e = document.getElementById("chat-screen");
                    if (
                        e &&
                        (e.classList.contains("features-panel-active") ||
                            e.classList.contains("emoji-panel-active"))
                    )
                        return (su.classList.remove("visible"), void (iu = !1));
                    (Xi.scrollHeight - Xi.scrollTop - Xi.clientHeight > 300
                        ? su.classList.add("visible")
                        : su.classList.remove("visible"),
                        (iu = !1));
                }),
                    (iu = !0));
        },
        {
            passive: !0,
        },
    ),
        su.addEventListener("click", () => {
            Xi.scrollTo({
                top: Xi.scrollHeight,
                behavior: "smooth",
            });
        }),
        xo &&
        Xi &&
        (window.visualViewport
            ? window.visualViewport.addEventListener("resize", () => {
                document.activeElement === xo &&
                    Xi.scrollTo({
                        top: Xi.scrollHeight,
                        behavior: "smooth",
                    });
            })
            : xo.addEventListener("focus", () => {
                setTimeout(() => {
                    Xi.scrollTo({
                        top: Xi.scrollHeight,
                        behavior: "smooth",
                    });
                }, 300);
            })),
        ti.addEventListener("click", lu),
        oi &&
        oi.addEventListener("click", () => {
            window.DOMCleanupManager.clean("shopper-list-container");
        }),
        si.addEventListener("click", async (e) => {
            const t = e.target.closest(".invite-contact-item");
            if (t) {
                const e = parseInt(t.dataset.contactId, 10),
                    n = (await Kl.loadData("messageContacts", "allContacts")).value.find(
                        (t) => t.id === e,
                    );
                n && (ru(n), cu());
            }
        }));
    const du = {
        takeout: [
            {
                name: "Ë±™ÂçéÁâõËÇâÊ±âÂ†°",
                description: "Á≤æÈÄâÂÆâÊ†ºÊñØÁâõËÇâÔºåÊê≠ÈÖçÊñ∞È≤úÁîüËèúÂíåÁßòÂà∂ÈÖ±ÊñôÔºåÂ§öÊ±ÅÁæéÂë≥„ÄÇ",
                price: 28.5,
            },
            {
                name: "Êó•ÂºèË±öÈ™®ÊãâÈù¢",
                description: "ÊµìÈÉÅÁå™È™®Ê±§Â∫ïÔºåÈÖç‰∏äÊ∫èÂøÉËõãÂíåÂèâÁÉßÔºåÊ∏©Êöñ‰Ω†ÁöÑËÉÉ„ÄÇ",
                price: 35,
            },
            {
                name: "È∫ªËæ£Â∞èÈæôËôæ",
                description: "Â§èÊó•ÂøÖÂ§áÔºåÈ≤úÊ¥ªÂ∞èÈæôËôæÈÖç‰ª•Áã¨ÂÆ∂È∫ªËæ£Ë∞ÉÊñôÔºåÈ¶ôËæ£ËøáÁòæ„ÄÇ",
                price: 88,
            },
            {
                name: "Ê∞¥ÊûúÁº§Á∫∑Ê≤ôÊãâ",
                description: "Â§öÁßçÊñ∞È≤úÊó∂‰ª§Ê∞¥ÊûúÔºå‰ΩéÂç°ÂÅ•Â∫∑ÔºåÊòØËΩªÈ£ü‰∏ª‰πâËÄÖÁöÑÊúÄÁà±„ÄÇ",
                price: 22,
            },
            {
                name: "ÊÑèÂºèÁï™ËåÑËÇâÈÖ±Èù¢",
                description: "ÁªèÂÖ∏ÊÑèÂºèÈ£éÂë≥ÔºåÊÖ¢ÁÇñÁï™ËåÑËÇâÈÖ±Êê≠ÈÖçÁ≠ãÈÅìÊÑèÈù¢ÔºåÂõûÂë≥Êó†Á©∑„ÄÇ",
                price: 32,
            },
            {
                name: "Â••Â∞îËâØÁÉ§È∏°ÁøÖ",
                description: "ÁßòÂà∂Â••Â∞îËâØÈÖ±ÊñôËÖåÂà∂ÔºåÂ§ñÁÑ¶ÈáåÂ´©ÔºåÈ¶ôÊ∞îÂõõÊ∫¢„ÄÇ",
                price: 26,
            },
            {
                name: "Êµ∑È≤úÊä´Ëê®",
                description: "ËñÑËÑÜÈ•ºÂ∫ïÔºåÈì∫Êª°Ëôæ‰ªÅ„ÄÅÈ±øÈ±ºÂíåËäùÂ£´ÔºåÊµ∑È≤úÁà±Â•ΩËÄÖÈ¶ñÈÄâ„ÄÇ",
                price: 58,
            },
            {
                name: "ÂÆ´‰øùÈ∏°‰∏ÅÈ•≠",
                description: "È≤úÂ´©È∏°‰∏ÅÊê≠ÈÖçËä±ÁîüÂíåËæ£Ê§íÔºåÈ∫ªËæ£È≤úÈ¶ôÔºå‰∏ãÈ•≠Á•ûÂô®„ÄÇ",
                price: 25,
            },
            {
                name: "Èü©ÂºèÈÉ®ÈòüÁÅ´ÈîÖ",
                description: "ËäùÂ£´Âπ¥Á≥ï„ÄÅÂçàÈ§êËÇâÂíåÊ≥°ËèúÁöÑÂÆåÁæéËûçÂêàÔºåÈü©ÂºèÈ£éÂë≥ÂçÅË∂≥„ÄÇ",
                price: 68,
            },
            {
                name: "Ê≥∞ÂºèÂÜ¨Èò¥ÂäüÊ±§",
                description: "ÈÖ∏Ëæ£ÂºÄËÉÉÔºåÂ§ßËôæ„ÄÅËòëËèáÁ≠âÈ£üÊùê‰∏∞ÂØåÔºåÂºÇÂõΩÈ£éÂë≥ÊµìÈÉÅ„ÄÇ",
                price: 42,
            },
            {
                name: "È¶ôÁÖé‰∏âÊñáÈ±ºÂ•óÈ§ê",
                description: "Êå™Â®Å‰∏âÊñáÈ±ºÁÖéËá≥ÈáëÈªÑÔºåÊê≠ÈÖçÊó∂Ëî¨ÂíåÂúüË±ÜÊ≥•ÔºåËê•ÂÖªÂùáË°°„ÄÇ",
                price: 78,
            },
            {
                name: "ÂÖ∞Â∑ûÁâõËÇâÊãâÈù¢",
                description: "‰∏ÄÊ∏Ö‰∫åÁôΩ‰∏âÁ∫¢ÂõõÁªøÔºå‰º†ÁªüÂ∑•Ëâ∫Âà∂‰ΩúÔºåÊ±§È≤úÂë≥Áæé„ÄÇ",
                price: 28,
            },
            {
                name: "Â¢®Ë•øÂì•È∏°ËÇâÂç∑",
                description: "Â´©ÁÖéÈ∏°ËÇâÈÖç‰ª•ËééËééÈÖ±ÂíåËî¨ËèúÔºåÂç∑Âú®ËñÑÈ•º‰∏≠ÔºåÈ£éÂë≥Áã¨Áâπ„ÄÇ",
                price: 30,
            },
            {
                name: "ÊãõÁâåÁ∫¢ÁÉßËÇâ",
                description: "Á≤æÈÄâ‰∫îËä±ËÇâÔºåÊÖ¢ÁÅ´ÁÇñËá≥ÈÖ•ÁÉÇÔºåËÇ•ËÄå‰∏çËÖªÔºåÂÖ•Âè£Âç≥Âåñ„ÄÇ",
                price: 45,
            },
            {
                name: "È≤úËôæ‰∫ëÂêûÈù¢",
                description: "ÊâãÂ∑•‰∫ëÂêûÂåÖË£πÂ§ßÈ¢óËôæ‰ªÅÔºåÊê≠ÈÖçÁ´πÂçáÈù¢ÔºåÊ±§Ê∏ÖÂë≥È≤ú„ÄÇ",
                price: 36,
            },
            {
                name: "Ê≥ïÂºèÈ¶ôÁÖéÈπÖËÇù",
                description: "ËøõÂè£ÈπÖËÇùÁÖéËá≥‰∏§Èù¢ÈáëÈªÑÔºåÊê≠ÈÖçÊó†Ëä±ÊûúÈÖ±ÔºåÂ•¢Âçé‰∫´Âèó„ÄÇ",
                price: 98,
            },
            {
                name: "ÂíñÂñ±ÁâõËÇâÈ•≠",
                description: "ÊµìÈÉÅÂíñÂñ±Ê±ÅÂåÖË£πÈ≤úÂ´©ÁâõËÇâÂíåÂúüË±ÜÔºåÊãåÈ•≠Áªù‰Ω≥„ÄÇ",
                price: 32,
            },
            {
                name: "Ë∂äÂçóÁâõËÇâÊ≤≥Á≤â",
                description: "Ê∏ÖÁàΩÁâõÈ™®Ê±§Â∫ïÔºåÈ≤úÂ´©ÁâõËÇâÁâáÔºåÊê≠ÈÖçÈ¶ôËçâÔºåÊ∏ÖÊñ∞ÁàΩÂè£„ÄÇ",
                price: 38,
            },
            {
                name: "ÈªëÊùæÈú≤ËòëËèáÊÑèÈù¢",
                description: "ÈªëÊùæÈú≤‰∏éËòëËèáÁöÑÈ≤úÈ¶ôËûçÂêàÔºåÂè£ÊÑü‰∏∞ÂØåÔºåÈ¶ôÊ∞îÁã¨Áâπ„ÄÇ",
                price: 56,
            },
            {
                name: "ÊªãË°•‰πåÈ∏°Ê±§",
                description: "ËÄÅÁÅ´ÊÖ¢ÁÇñ‰πåÈ∏°Ê±§ÔºåÂä†ÂÖ•ÂÖöÂèÇ„ÄÅÊû∏ÊùûÔºåÊªãË°•ÂÖªÁîü„ÄÇ",
                price: 48,
            },
        ],
        electronics: [
            {
                name: "Ë∂ÖÈùôÈü≥Êú∫Ê¢∞ÈîÆÁõò",
                description: "ÈááÁî®Ëå∂ËΩ¥ËÆæËÆ°ÔºåÊó¢ÊúâÊÆµËêΩÊÑüÂèà‰øùÊåÅÂÆâÈùôÔºåÂäûÂÖ¨Ê∏∏Êàè‰∏§Áõ∏ÂÆú„ÄÇ",
                price: 399,
            },
            {
                name: "È´òÊ∏ÖÈôçÂô™ËÄ≥Êú∫",
                description: "‰∏ªÂä®ÈôçÂô™ÊäÄÊúØÔºåËÆ©‰Ω†Âú®ÂòàÊùÇÁéØÂ¢É‰∏≠‰πüËÉΩ‰∫´ÂèóÁ∫ØÂáÄÈü≥‰πê„ÄÇ",
                price: 799,
            },
            {
                name: "‰æøÊê∫ÂºèÂÖÖÁîµÂÆù",
                description: "20000mAhÂ§ßÂÆπÈáèÔºåÊîØÊåÅÂø´ÂÖÖÔºåÂëäÂà´ÁîµÈáèÁÑ¶Ëôë„ÄÇ",
                price: 129,
            },
            {
                name: "Êô∫ËÉΩËøêÂä®ÊâãÁéØ",
                description: "ÂÆûÊó∂ÁõëÊµãÂøÉÁéá„ÄÅÊ≠•Êï∞ÂíåÁù°Áú†Ôºå‰Ω†ÁöÑËÖï‰∏äÂÅ•Â∫∑ÁÆ°ÂÆ∂„ÄÇ",
                price: 199,
            },
            {
                name: "4KË∂ÖÈ´òÊ∏ÖÊòæÁ§∫Âô®",
                description: "27Ëã±ÂØ∏Â§ßÂ±èÔºå4KÂàÜËæ®ÁéáÔºåËâ≤ÂΩ©Á≤æÂáÜÔºåÈÄÇÂêàËÆæËÆ°ÂíåËßÇÂΩ±„ÄÇ",
                price: 1499,
            },
            {
                name: "Êó†Á∫øËìùÁâôËÄ≥Êú∫",
                description: "ÂçäÂÖ•ËÄ≥ÂºèËÆæËÆ°Ôºå‰Ω©Êà¥ËàíÈÄÇÔºåÁª≠Ëà™ÈïøËææ24Â∞èÊó∂„ÄÇ",
                price: 299,
            },
            {
                name: "Ë∂ÖËñÑÁ¨îËÆ∞Êú¨ÁîµËÑë",
                description: "14Ëã±ÂØ∏ÂÖ®Èù¢Â±èÔºåËΩªËñÑ‰æøÊê∫ÔºåÊÄßËÉΩÂº∫Âä≤ÔºåÂäûÂÖ¨È¶ñÈÄâ„ÄÇ",
                price: 5999,
            },
            {
                name: "Êô∫ËÉΩÊâãË°®",
                description: "ÊîØÊåÅÈÄöËØù„ÄÅÊîØ‰ªòÂíåÂ§öÁßçËøêÂä®Ê®°ÂºèÔºåÂäüËÉΩÂÖ®Èù¢„ÄÇ",
                price: 1599,
            },
            {
                name: "È´òÊ∏ÖÊëÑÂÉèÂ§¥",
                description: "1080PÂàÜËæ®ÁéáÔºåËá™Âä®ÂØπÁÑ¶ÔºåËßÜÈ¢ëÈÄöËØùÊ∏ÖÊô∞ÊµÅÁïÖ„ÄÇ",
                price: 199,
            },
            {
                name: "Ê∏∏ÊàèÊâãÊüÑ",
                description: "ÈÄÇÈÖçÂ§öÂπ≥Âè∞ÔºåÊâãÊÑüËàíÈÄÇÔºåÊåâÈîÆÁÅµÊïèÔºåÊ∏∏Êàè‰ΩìÈ™åÂçáÁ∫ß„ÄÇ",
                price: 299,
            },
            {
                name: "Ëø∑‰Ω†ÊäïÂΩ±‰ª™",
                description: "‰æøÊê∫ËÆæËÆ°ÔºåÊîØÊåÅ1080PÊäïÂΩ±ÔºåÊâìÈÄ†ÁßÅ‰∫∫ÂΩ±Èô¢„ÄÇ",
                price: 2499,
            },
            {
                name: "Êô∫ËÉΩÈü≥ÁÆ±",
                description: "ËØ≠Èü≥ÊéßÂà∂ÔºåÊô∫ËÉΩÂÆ∂Â±Ö‰∏≠ÊéßÔºåÈü≥Ë¥®Âá∫Ëâ≤„ÄÇ",
                price: 399,
            },
            {
                name: "ÁßªÂä®Á°¨Áõò",
                description: "2TBÂ§ßÂÆπÈáèÔºåÈ´òÈÄü‰º†ËæìÔºåÊï∞ÊçÆÂ≠òÂÇ®ÂÆâÂÖ®ÂèØÈù†„ÄÇ",
                price: 599,
            },
            {
                name: "Ê∞ÆÂåñÈïìÂÖÖÁîµÂô®",
                description: "65WÂ§ßÂäüÁéáÔºåÂ∞èÂ∑ß‰æøÊê∫ÔºåÂ§öËÆæÂ§áÂÖºÂÆπ„ÄÇ",
                price: 149,
            },
            {
                name: "ËìùÁâôÈü≥ÁÆ±",
                description: "Èò≤Ê∞¥ËÆæËÆ°Ôºå360¬∞ÁéØÁªïÈü≥ÊïàÔºåÊà∑Â§ñËÅö‰ºöÂøÖÂ§á„ÄÇ",
                price: 499,
            },
            {
                name: "Êú∫Ê¢∞Èº†Ê†á",
                description: "È´òÁ≤æÂ∫¶‰º†ÊÑüÂô®ÔºåËá™ÂÆö‰πâÊåâÈîÆÔºåÊ∏∏ÊàèÂäûÂÖ¨ÁöÜÂÆú„ÄÇ",
                price: 249,
            },
            {
                name: "VRÁúºÈïú",
                description: "Ê≤âÊµ∏Âºè‰ΩìÈ™åÔºåÊîØÊåÅÂ§öÁßçVRÊ∏∏ÊàèÂíåÂΩ±ËßÜÂÜÖÂÆπ„ÄÇ",
                price: 1999,
            },
            {
                name: "Ë°åËΩ¶ËÆ∞ÂΩï‰ª™",
                description: "4KÈ´òÊ∏ÖÂ§úËßÜÔºåÂÅúËΩ¶ÁõëÊéßÔºå‰øùÈöúË°åËΩ¶ÂÆâÂÖ®„ÄÇ",
                price: 399,
            },
            {
                name: "Êó†Á∫øÂÖÖÁîµÂô®",
                description: "15WÂø´ÂÖÖÔºåÊîØÊåÅÂ§öËÆæÂ§áÂÖºÂÆπÔºåÊ°åÈù¢Êï¥Ê¥ÅÁ•ûÂô®„ÄÇ",
                price: 89,
            },
            {
                name: "Êô∫ËÉΩÈó®ÈîÅ",
                description: "ÊåáÁ∫πËØÜÂà´ÔºåÊâãÊú∫ËøúÁ®ãÊéßÂà∂ÔºåÂÆâÂÖ®‰æøÊç∑„ÄÇ",
                price: 1299,
            },
        ],
        daily: [
            {
                name: "ËøõÂè£Êó†ËäØÂç∑Á∫∏",
                description: "ÂéüÁîüÊú®ÊµÜÂà∂ÈÄ†ÔºåÂõõÂ±ÇÂä†ÂéöÔºå‰∫≤ËÇ§ÊüîËΩØÔºå‰∏ÄÂåÖ12Âç∑„ÄÇ",
                price: 19.9,
            },
            {
                name: "Ëá™Âä®ÊÑüÂ∫îÊ¥óÊâãÊ∂≤Êú∫",
                description: "Á∫¢Â§ñÊÑüÂ∫îÔºåÂÖçÊé•Ëß¶Âá∫Ê≥°ÔºåÊúâÊïàÈÅøÂÖç‰∫§ÂèâÊÑüÊüìÔºåÂÆàÊä§ÂÆ∂‰∫∫ÂÅ•Â∫∑„ÄÇ",
                price: 69,
            },
            {
                name: "Êáí‰∫∫Ê°åÈù¢Âê∏Â∞òÂô®",
                description: "Âº∫ÂäõÂê∏Èô§Ê°åÈù¢ÁÅ∞Â∞ò„ÄÅÊ©°ÁöÆÂ±ëÂíåÈõ∂È£üÁ¢éÂ±ëÔºå‰∏ÄÈîÆÂºÄÂêØÔºåËΩªÊùæÊ¥ÅÂáÄ„ÄÇ",
                price: 45,
            },
            {
                name: "ÂàÜÁ±ªÊî∂Á∫≥ÁõíÂ•óË£Ö",
                description: "‰∏ÄÂ•ó‰∏â‰ª∂Ôºå‰∏çÂêåÂ∞∫ÂØ∏Êª°Ë∂≥ÂêÑÁßçÊî∂Á∫≥ÈúÄÊ±ÇÔºåËÆ©‰Ω†ÁöÑÊ°åÈù¢‰∫ï‰∫ïÊúâÊù°„ÄÇ",
                price: 38,
            },
            {
                name: "Â§©ÁÑ∂Á´πÁ∫§Áª¥ÊØõÂ∑æ",
                description: "Âê∏Ê∞¥ÊÄßÂº∫ÔºåÊüîËΩØ‰∫≤ËÇ§ÔºåÊäóËèåÈò≤ÈúâÔºå‰∏âÊù°Ë£Ö„ÄÇ",
                price: 29.9,
            },
            {
                name: "Â§öÂäüËÉΩÂé®ÊàøÂâ™ÂàÄ",
                description: "ÈîãÂà©ËÄêÁî®ÔºåÂèØÂâ™È™®Â§¥„ÄÅËî¨ËèúÂíåËÇâÁ±ªÔºåËøòËÉΩÂºÄÁì∂ÂíåÂàÆÈ±ºÈ≥û„ÄÇ",
                price: 39,
            },
            {
                name: "ÂèØÈôçËß£ÂûÉÂúæË¢ã",
                description: "ÁéØ‰øùÊùêÊñôÂà∂‰ΩúÔºåÊâøÈáçÂº∫‰∏çÊòìÁ†¥Ôºå100Âè™Ë£Ö„ÄÇ",
                price: 12.9,
            },
            {
                name: "‰æøÊê∫ÂºèÊäòÂè†ÊôæË°£Êû∂",
                description: "Â§ñÂá∫ÊóÖË°åÂøÖÂ§áÔºåÊäòÂè†ËÆæËÆ°‰∏çÂç†Á©∫Èó¥ÔºåÊâøÈáçËÉΩÂäõÂº∫„ÄÇ",
                price: 49,
            },
            {
                name: "Ë∂ÖÂ£∞Ê≥¢È¶ôËñ∞Êú∫",
                description: "ÈùôÈü≥ËøêË°åÔºåÂä†ÊπøÈ¶ôËñ∞‰∫åÂêà‰∏ÄÔºåËê•ÈÄ†ËàíÈÄÇÁéØÂ¢É„ÄÇ",
                price: 79,
            },
            {
                name: "Â§öÂäüËÉΩÂàáËèúÂô®",
                description: "Â§öÁßçÂàÄÁâáÂèØÈÄâÔºåÂàá‰∏ùÂàáÁâáÂàá‰∏Å‰∏ÄÈîÆÊêûÂÆöÔºåÁúÅÊó∂ÁúÅÂäõ„ÄÇ",
                price: 59,
            },
            {
                name: "ËÆ∞ÂøÜÊ£âÊûïÂ§¥",
                description: "ÊÖ¢ÂõûÂºπÊùêË¥®ÔºåË¥¥ÂêàÈ¢àÊ§éÊõ≤Á∫øÔºåÊîπÂñÑÁù°Áú†Ë¥®Èáè„ÄÇ",
                price: 129,
            },
            {
                name: "‰∏çÈîàÈí¢‰øùÊ∏©ÊùØ",
                description: "316‰∏çÈîàÈí¢ÊùêË¥®Ôºå‰øùÊ∏©‰øùÂÜ∑24Â∞èÊó∂Ôºå500mlÂÆπÈáè„ÄÇ",
                price: 89,
            },
            {
                name: "Âé®ÊàøÊ≤πÊ±°Ê∏ÖÊ¥ÅÂâÇ",
                description: "Âº∫ÊïàÂéªÊ±°ÔºåÂ§©ÁÑ∂ÊàêÂàÜ‰∏ç‰º§ÊâãÔºåËΩªÊùæÂéªÈô§ÈáçÊ≤πÊ±°„ÄÇ",
                price: 29.9,
            },
            {
                name: "Èò≤ÊªëÊµ¥ÂÆ§Âú∞Âû´",
                description: "Âê∏Ê∞¥ÈÄüÂπ≤ÔºåÈò≤ÊªëËÆæËÆ°ÔºåÊüîËΩØËàíÈÄÇÔºåÂ§öÁßçÂõæÊ°àÂèØÈÄâ„ÄÇ",
                price: 35,
            },
            {
                name: "LEDÂ∞èÂ§úÁÅØ",
                description: "ÂÖâÊÑüËá™Âä®ÂºÄÂÖ≥ÔºåÊüîÂÖâ‰∏çÂà∫ÁúºÔºåÂëµÊä§ÂÆùÂÆùÁù°Áú†„ÄÇ",
                price: 19.9,
            },
            {
                name: "Â§öÂäüËÉΩÊï∞ÊçÆÁ∫ø",
                description: "‰∏ÄÊãñ‰∏âËÆæËÆ°ÔºåÊîØÊåÅÂø´ÂÖÖÔºåÈÄÇÁî®‰∫éÊâãÊú∫„ÄÅÂπ≥ÊùøÁ≠âËÆæÂ§á„ÄÇ",
                price: 29,
            },
            {
                name: "Â§©ÁÑ∂Ê§çÁâ©Ê¥óË°£Ê∂≤",
                description: "Ê∏©ÂíåÈÖçÊñπÔºåÊ∑±Â±ÇÊ¥ÅÂáÄÔºå‰∏çÂê´ËçßÂÖâÂâÇÔºåÈÄÇÂêàÊØçÂ©¥Ë°£Áâ©„ÄÇ",
                price: 45,
            },
            {
                name: "‰æøÊê∫ÂºèÈ§êÂÖ∑Â•óË£Ö",
                description: "ÂåÖÂê´Á≠∑Â≠ê„ÄÅÂã∫Â≠êÂíåÂèâÂ≠êÔºåÈ£üÂìÅÁ∫ßÊùêË¥®ÔºåÁéØ‰øùÂç´Áîü„ÄÇ",
                price: 25,
            },
            {
                name: "Ê°åÈù¢Âä†ÊπøÂô®",
                description: "Ëø∑‰Ω†ËÆæËÆ°‰∏çÂç†Á©∫Èó¥ÔºåÈùôÈü≥ËøêË°åÔºåÁºìËß£Á©∫Ê∞îÂπ≤Áá•„ÄÇ",
                price: 59,
            },
            {
                name: "Â§öÂäüËÉΩÁ¨îËÆ∞Êú¨ÊîØÊû∂",
                description: "ÂèØË∞ÉËäÇÈ´òÂ∫¶ËßíÂ∫¶ÔºåÊï£ÁÉ≠ÈÄèÊ∞îÔºå‰øùÊä§È¢àÊ§é„ÄÇ",
                price: 79,
            },
        ],
        sports: [
            {
                name: "‰∏ì‰∏öÈò≤ÊªëÁëú‰ºΩÂû´",
                description:
                    "8mmÂä†ÂéöÂ§©ÁÑ∂Ê©°ËÉ∂ÊùêË¥®ÔºåÈò≤ÊªëÊÄßËÉΩ‰ºòÂºÇÔºåÁéØ‰øùÊó†ÂºÇÂë≥ÔºåÈôÑÂ∏¶ÁªëÂ∏¶Êñπ‰æøÊê∫Â∏¶„ÄÇ",
                price: 129,
            },
            {
                name: "ÊäòÂè†Èú≤Ëê•Â∏êÁØ∑",
                description:
                    "3-4‰∫∫ÂÖ®Ëá™Âä®ÈÄüÂºÄÂ∏êÁØ∑ÔºåÈò≤Ê∞¥Èò≤ÊôíÈù¢ÊñôÔºåÈÄöÈ£éËÆæËÆ°ÔºåÈÄÇÂêàÂÆ∂Â∫≠Êà∑Â§ñÈú≤Ëê•„ÄÇ",
                price: 459,
            },
            {
                name: "ËΩªÈáèÂæíÊ≠•ÁôªÂ±±Èûã",
                description:
                    "Èò≤Ê∞¥ÈÄèÊ∞îÈûãÈù¢ÔºåÈò≤ÊªëVibramÂ§ßÂ∫ïÔºåÂáèÈúáÈûãÂû´ÔºåÈÄÇÂêà‰∏≠‰ΩéÈöæÂ∫¶ÂæíÊ≠•„ÄÇ",
                price: 699,
            },
            {
                name: "Êô∫ËÉΩËøêÂä®ÊâãË°®",
                description: "ÊîØÊåÅ100+ËøêÂä®Ê®°ÂºèÔºåÂøÉÁéáË°ÄÊ∞ßÁõëÊµãÔºå50Á±≥Èò≤Ê∞¥ÔºåÁª≠Ëà™ÂèØËææ14Â§©„ÄÇ",
                price: 899,
            },
            {
                name: "ÂèØÊäòÂè†Â±±Âú∞Ëá™Ë°åËΩ¶",
                description:
                    "27ÈÄüÂèòÈÄüÁ≥ªÁªüÔºåÈìùÂêàÈáëËΩ¶Êû∂ÔºåÊäòÂè†ÂêéÂèØÊîæÂÖ•Ê±ΩËΩ¶ÂêéÂ§áÁÆ±ÔºåÊñπ‰æøÊê∫Â∏¶„ÄÇ",
                price: 1599,
            },
            {
                name: "Â§öÂäüËÉΩÊà∑Â§ñËÉåÂåÖ",
                description:
                    "45LÂ§ßÂÆπÈáèÔºåÈò≤Ê∞¥Èù¢ÊñôÔºåËÉåË¥üÁ≥ªÁªüËàíÈÄÇÔºåÈÄÇÂêà2-3Â§©Êà∑Â§ñÂæíÊ≠•ÊóÖË°å„ÄÇ",
                price: 399,
            },
            {
                name: "‰∏ì‰∏öÁæΩÊØõÁêÉÊãçÂ•óË£Ö",
                description:
                    "ÂÖ®Á¢≥Á¥†Á∫§Áª¥ÊùêË¥®ÔºåËΩªÈáèÂåñËÆæËÆ°ÔºåÂê´2ÊîØÁêÉÊãç„ÄÅ3‰∏™ÁæΩÊØõÁêÉÂíå‰æøÊê∫ÂåÖ„ÄÇ",
                price: 259,
            },
            {
                name: "Ëá™Âä®ÂÖÖÊ∞îÈò≤ÊΩÆÂû´",
                description: "3cmÂä†ÂéöÊµ∑ÁªµÔºåËá™Âä®ÂÖÖÊ∞îËÆæËÆ°ÔºåÈò≤ÊΩÆÈöîÊ∏©ÔºåÈÄÇÂêàÈú≤Ëê•ÈáéÈ§ê‰ΩøÁî®„ÄÇ",
                price: 199,
            },
            {
                name: "ÈÄüÂπ≤ËøêÂä®Â•óË£Ö",
                description: "Áî∑Â•≥ÂêåÊ¨æÔºåÂê∏ÊπøÊéíÊ±óÈù¢ÊñôÔºåÈÄèÊ∞î‰∏çÈó∑Ê±óÔºåÈÄÇÂêàË∑ëÊ≠•ÂÅ•Ë∫´Á≠âËøêÂä®„ÄÇ",
                price: 159,
            },
            {
                name: "È´òÂº∫Â∫¶ÊãâÂäõÁª≥",
                description:
                    "5Ê†π‰∏çÂêåÈòªÂäõÁª≥ÁªÑÂêàÔºåÂèØË∞ÉËäÇÈïøÂ∫¶ÔºåÈÄÇÂêàÂ±ÖÂÆ∂ÂäõÈáèËÆ≠ÁªÉÔºåÈôÑÂ∏¶Êî∂Á∫≥Ë¢ã„ÄÇ",
                price: 89,
            },
            {
                name: "Êà∑Â§ñ‰æøÊê∫ÂºèÊ∞¥Â£∂",
                description:
                    "1LÂ§ßÂÆπÈáèÔºåÈ£üÂìÅÁ∫ß‰∏çÈîàÈí¢ÊùêË¥®Ôºå‰øùÊ∏©‰øùÂÜ∑24Â∞èÊó∂ÔºåÂ∏¶ÁôªÂ±±Êâ£ËÆæËÆ°„ÄÇ",
                price: 129,
            },
            {
                name: "‰∏ì‰∏öÊΩúÊ∞¥Ê∏∏Ê≥≥Èïú",
                description: "Èò≤ÈõæÈò≤Á¥´Â§ñÁ∫øÈïúÁâáÔºåÁ°ÖËÉ∂ÂØÜÂ∞ÅÂúàÔºåË¥¥Âêà‰∏çÊºèÊ∞¥ÔºåÂèØË∞ÉËäÇÂ§¥Â∏¶„ÄÇ",
                price: 159,
            },
            {
                name: "ÊäòÂè†ÂºèÂ§™Èò≥ËÉΩÂÖÖÁîµÂÆù",
                description:
                    "20000mAhÂ§ßÂÆπÈáèÔºåÊîØÊåÅÂ§™Èò≥ËÉΩÂÖÖÁîµÔºåÂèåUSBËæìÂá∫ÔºåÊà∑Â§ñÂ∫îÊÄ•ÂøÖÂ§á„ÄÇ",
                price: 299,
            },
            {
                name: "ÂÆ§ÂÜÖÂÅ•Ë∫´Âä®ÊÑüÂçïËΩ¶",
                description: "ÈùôÈü≥Á£ÅÊéßÁ≥ªÁªüÔºåÂèØË∞ÉËäÇÈòªÂäõÂíåÂ∫ßÊ§ÖÈ´òÂ∫¶ÔºåÂ∏¶ÂøÉÁéáÁõëÊµãÂäüËÉΩ„ÄÇ",
                price: 1899,
            },
            {
                name: "Êà∑Â§ñÈáéËê•ÁÇâÂÖ∑Â•óË£Ö",
                description: "‰æøÊê∫ÂºèÊ∞îÁÇâ+ÈîÖÂÖ∑ÁªÑÂêàÔºåÁÅ´ÂäõË∞ÉËäÇÁ≤æÂáÜÔºåÈÄÇÂêàÈáéÂ§ñÁÉπÈ•™„ÄÇ",
                price: 259,
            },
            {
                name: "‰∏ì‰∏öË∑ëÊ≠•ËøêÂä®Èûã",
                description: "ÁºìÈúá‰∏≠Â∫ïÔºåÈÄèÊ∞îÁΩëÈù¢ÔºåËÄêÁ£®Ê©°ËÉ∂Â§ßÂ∫ïÔºåÈÄÇÂêàÈïøË∑ùÁ¶ªË∑ëÊ≠•„ÄÇ",
                price: 799,
            },
            {
                name: "Â§öÂäüËÉΩÊàòÊúØÊâãÁîµÁ≠í",
                description: "Âº∫ÂÖâËøúÂ∞ÑÔºåÊîØÊåÅÁàÜÈó™ÂíåSOSÊ®°ÂºèÔºåÈò≤Ê∞¥Èò≤Â∞òÔºåÂèØÂÖÖÁîµËÆæËÆ°„ÄÇ",
                price: 199,
            },
            {
                name: "Áëú‰ºΩÁêÉÂÅ•Ë∫´ÁêÉ",
                description:
                    "Èò≤ÁàÜÊùêË¥®ÔºåÁõ¥ÂæÑ75cmÔºåÈÄÇÂêàÁëú‰ºΩÁªÉ‰π†ÂíåÊ†∏ÂøÉÂäõÈáèËÆ≠ÁªÉÔºåÈôÑÂ∏¶ÊâìÊ∞îÁ≠í„ÄÇ",
                price: 69,
            },
            {
                name: "Êà∑Â§ñ‰øùÊ∏©ÈáéÈ§êÁØÆ",
                description: "ÂÆπÈáè20LÔºå‰øùÊ∏©Â±ÇËÆæËÆ°ÔºåÂèØÂÆπÁ∫≥4‰∫∫‰ªΩÈ§êÂÖ∑ÔºåÈÄÇÂêàÈÉäÂ§ñÈáéÈ§ê„ÄÇ",
                price: 299,
            },
            {
                name: "‰∏ì‰∏öÊªëÈõ™ÊùøÂ•óË£Ö",
                description: "ÂÖ®ËÉΩÂûãÊªëÈõ™Êùø+Âõ∫ÂÆöÂô®+Èõ™ÊùñÁªÑÂêàÔºåÈÄÇÂêàÂàù‰∏≠Á∫ßÊªëÈõ™Áà±Â•ΩËÄÖ„ÄÇ",
                price: 2599,
            },
        ],
        beautyCare: [
            {
                name: "Ê∞®Âü∫ÈÖ∏Ê¥ÅÈù¢‰π≥",
                description: "Ê∏©ÂíåÊ∏ÖÊ¥ÅÈÖçÊñπÔºåÂê´Ê∞®Âü∫ÈÖ∏ÊàêÂàÜÔºåÊ¥óÂÆå‰∏çÁ¥ßÁª∑ÔºåÈÄÇÂêàÊâÄÊúâËÇ§Ë¥®",
                price: 89,
            },
            {
                name: "ÁéªÂ∞øÈÖ∏Ë°•Ê∞¥Èù¢ËÜú",
                description: "È´òÊµìÂ∫¶ÁéªÂ∞øÈÖ∏Á≤æÂçéÔºåÊ∑±Â±ÇË°•Ê∞¥ÈîÅÊ∞¥Ôºå‰∏ÄÁõí10ÁâáË£Ö",
                price: 129,
            },
            {
                name: "ÁÉüÈÖ∞ËÉ∫‰∫ÆËÇ§Á≤æÂçéÊ∂≤",
                description: "5%ÁÉüÈÖ∞ËÉ∫ÊµìÂ∫¶ÔºåÊèê‰∫ÆËÇ§Ëâ≤ÊîπÂñÑÊöóÊ≤âÔºåÊ∑°ÂåñÁóòÂç∞",
                price: 159,
            },
            {
                name: "Á•ûÁªèÈÖ∞ËÉ∫‰øÆÊä§Èù¢Èúú",
                description: "‰∏âÈáçÁ•ûÁªèÈÖ∞ËÉ∫ÈÖçÊñπÔºå‰øÆÂ§çËÇåËÇ§Â±èÈöúÔºåÊïèÊÑüËÇåÈÄÇÁî®",
                price: 219,
            },
            {
                name: "Ê∞®Âü∫ÈÖ∏Ê≥°Ê≥°Ê≤êÊµ¥Èú≤",
                description: "‰∏∞ÂØåÁªÜËÖªÊ≥°Ê≤´ÔºåÊ∏©ÂíåÊ∏ÖÊ¥Å‰∏çÂÅáÊªëÔºåÊåÅ‰πÖÁïôÈ¶ô",
                price: 59,
            },
            {
                name: "‰π≥Êú®ÊûúÊä§ÊâãÈúúÂ•óË£Ö",
                description: "Âê´‰π≥Êú®ÊûúÊ≤πÂíåÁª¥ÁîüÁ¥†EÔºåÊªãÊ∂¶‰øùÊπøÔºå3ÊîØË£Ö‰∏çÂêåÈ¶ôÂûã",
                price: 45,
            },
            {
                name: "Ëä¶ËçüËÉ∂ËàíÁºìÂáùËÉ∂",
                description: "99%Ëä¶ËçüÂéüÊ±ÅÊèêÂèñÔºåËàíÁºìÊôíÂêé‰øÆÊä§ÔºåÂèØÂÅöÁù°Áú†Èù¢ËÜú",
                price: 39,
            },
            {
                name: "ÂåñÂ¶ÜÂà∑Â•óË£Ö12ÊîØ",
                description: "ÊüîËΩØ‰∫∫ÈÄ†Á∫§Áª¥ÊØõÔºåÂê´Êï£Á≤âÂà∑„ÄÅÁúºÂΩ±Âà∑Á≠âÔºåÈÄÅÊî∂Á∫≥ÂåÖ",
                price: 139,
            },
            {
                name: "Â§©ÁÑ∂Ê§çÁâ©Ê¥óÂèëÊ∞¥",
                description: "Êó†Á°ÖÊ≤πÈÖçÊñπÔºåÊéßÊ≤πÂéªÂ±ëÔºåÈÄÇÂêàÊ≤πÊÄßÂèëË¥®",
                price: 79,
            },
            {
                name: "Èò≤Ê∞¥Áù´ÊØõËÜè",
                description: "ÊµìÂØÜÁ∫§ÈïøÊïàÊûúÔºåÈò≤Ê∞¥Èò≤Ê±ó‰∏çÊôïÊüìÔºåÊòìÂç∏Â¶Ü",
                price: 69,
            },
            {
                name: "‰øùÊπøÁ≤âÂ∫ïÊ∂≤",
                description: "ËΩªËñÑÊúçÂ∏ñÔºåËá™ÁÑ∂ÈÅÆÁëïÔºåÊåÅÂ¶Ü8Â∞èÊó∂‰∏çËÑ±Â¶Ü",
                price: 189,
            },
            {
                name: "ÂéªËßíË¥®Ê≠ªÁöÆËÜè",
                description: "Ê∏©ÂíåÂéªÈô§Èù¢ÈÉ®ËÄÅÂ∫üËßíË¥®ÔºåÊØèÂë®‰ΩøÁî®1-2Ê¨°",
                price: 49,
            },
            {
                name: "Èò≤ÊôíÈúúSPF50+",
                description: "È´òÂÄçÈò≤ÊôíÔºåÈò≤Ê∞¥Èò≤Ê±óÔºåÊ∏ÖÁàΩ‰∏çÊ≤πËÖª",
                price: 99,
            },
            {
                name: "Áé´Áë∞Á∫ØÈú≤ÁàΩËÇ§Ê∞¥",
                description: "Â§©ÁÑ∂Áé´Áë∞ÊèêÂèñÔºåË°•Ê∞¥‰øùÊπøÔºåÂèØÂÅöÊ∞¥ËÜú",
                price: 65,
            },
            {
                name: "Âç∏Â¶ÜÊ∞¥ÊïèÊÑüËÇåÁî®",
                description: "Ê∏©ÂíåÊó†Âà∫ÊøÄÔºåÁúºÂîáËÑ∏‰∏âÂêà‰∏ÄÔºåÊ∑±Â±ÇÊ∏ÖÊ¥Å",
                price: 55,
            },
            {
                name: "Áª¥ÁîüÁ¥†EÊ∂¶ÂîáËÜè",
                description: "ÊåÅ‰πÖÊªãÊ∂¶‰øùÊπøÔºåÊ∑°ÂåñÂîáÁ∫πÔºåÊó†Ëâ≤ÈÄèÊòé",
                price: 25,
            },
            {
                name: "Ëå∂Ê†ëÁ≤æÊ≤πÁ•õÁóòÂáùËÉ∂",
                description: "Âø´ÈÄüÊ∂àÁÇéÁ•õÁóòÔºåÊ∑°ÂåñÁóòÂç∞Ôºå‰∏çÂà∫ÊøÄÁöÆËÇ§",
                price: 35,
            },
            {
                name: "ÂéãÁº©Èù¢ËÜúÁ∫∏100Á≤í",
                description: "Á∫ØÊ£âÊùêË¥®ÔºåÂê∏Ê∞¥ÊÄßÂº∫ÔºåÊê≠ÈÖçÁàΩËÇ§Ê∞¥‰ΩøÁî®",
                price: 29,
            },
            {
                name: "Ë∫´‰ΩìÁ£®Á†ÇËÜè",
                description: "Êµ∑ÁõêÈ¢óÁ≤íÔºåÊ∏©ÂíåÂéªËßíË¥®Ôºå‰ΩøËÇåËÇ§ÂÖâÊªëÁªÜËÖª",
                price: 69,
            },
            {
                name: "ÁúâÁ¨îÁúâÁ≤âÂ•óË£Ö",
                description: "Èò≤Ê∞¥Èò≤Ê±óÔºåÊòì‰∏äËâ≤‰∏çÊôïÊüìÔºåÂê´ÁúâÁ¨î„ÄÅÁúâÁ≤âÂíåÁúâÂà∑",
                price: 59,
            },
        ],
        foodSnacks: [
            {
                name: "Ê∑∑ÂêàÂùöÊûúÁ§ºÁõí",
                description:
                    "ÂåÖÂê´Â∑¥Êó¶Êú®„ÄÅËÖ∞Êûú„ÄÅÊ†∏Ê°ÉÁ≠â6ÁßçÂùöÊûúÔºåÁã¨Á´ãÂ∞èÂåÖË£ÖÔºåÊØèÊó•‰∏ÄÂåÖË°•ÂÖÖËê•ÂÖª",
                price: 159,
            },
            {
                name: "Êó†ËîóÁ≥ñÂÖ®È∫¶È•ºÂπ≤",
                description: "È´òÁ∫§Áª¥‰ΩéÁÉ≠ÈáèÔºåÊó†ËîóÁ≥ñÊ∑ªÂä†ÔºåÂè£ÊÑüÈÖ•ËÑÜÔºåÈÄÇÂêà‰ª£È§êÊàñ‰∏ãÂçàËå∂",
                price: 39.9,
            },
            {
                name: "ÂÜªÂπ≤Ê∞¥ÊûúËÑÜÁâá",
                description:
                    "ËçâËéì„ÄÅËäíÊûú„ÄÅÈ¶ôËïâÂ§öÁßçÂè£Âë≥ÁªÑÂêàÔºåÈùûÊ≤πÁÇ∏‰øùÁïôËê•ÂÖªÔºåÂÑøÁ´•Èõ∂È£üÈ¶ñÈÄâ",
                price: 45,
            },
            {
                name: "Á∫ØÈªëÂ∑ßÂÖãÂäõ",
                description: "85%ÂèØÂèØÂê´ÈáèÔºåÂæÆËã¶ÈÜáÂéöÔºåÊó†Ê∑ªÂä†ËîóÁ≥ñÔºåÁã¨Á´ãÂ∞èÂùóË£Ö",
                price: 59,
            },
            {
                name: "Êó•ÂºèÊãâÈù¢ÁªÑÂêàË£Ö",
                description: "Ë±öÈ™®„ÄÅÈÖ±Ê≤π„ÄÅÂë≥Âôå‰∏âÁßçÂè£Âë≥ÔºåÂê´Áã¨Á´ãÊ±§ÂåÖÂíåÂèâÁÉßÔºå5ÂåÖË£Ö",
                price: 69,
            },
            {
                name: "Âç≥È£üÁáïÈ∫¶Áâá",
                description: "Êæ≥Ê¥≤Á∫ØÁáïÈ∫¶ÔºåÂÖçÁÖÆÂç≥È£üÔºåÂèØÊê≠ÈÖçÁâõÂ•∂Ê∞¥ÊûúÔºåËê•ÂÖªÊó©È§êÈÄâÊã©",
                price: 29.9,
            },
            {
                name: "ÁâõËÇâÂπ≤Á§ºÁõí",
                description: "ÂÜÖËíôÂè§È£éÂπ≤Â∑•Ëâ∫ÔºåÂéüÂë≥ÂíåÈ¶ôËæ£‰∏§ÁßçÂè£Âë≥ÔºåËÇâË¥®Á¥ßÂÆûÊúâÂöºÂä≤",
                price: 89,
            },
            {
                name: "ÈÄüÊ∫∂ÈªëÂíñÂï°",
                description: "Âì•‰º¶ÊØî‰∫öËøõÂè£ÂíñÂï°Ë±ÜÔºåÂÜªÂπ≤ÊäÄÊúØ‰øùÁïôÈ£éÂë≥Ôºå40Êù°Ë£Ö",
                price: 65,
            },
            {
                name: "ËúÇËúúÊüöÂ≠êËå∂",
                description: "Èü©ÂõΩËøõÂè£ÂéüÊñôÔºåËúÇËúú‰∏éÊüöÂ≠êÈªÑÈáëÈÖçÊØîÔºåÂÜ≤Ê∞¥È•ÆÁî®ÈÖ∏ÁîúÂèØÂè£",
                price: 45,
            },
            {
                name: "ËñØÁâáÂ§ßÁ§ºÂåÖ",
                description: "ÂéüÂë≥„ÄÅÁï™ËåÑ„ÄÅÁÉßÁÉ§Â§öÁßçÂè£Âë≥Ê∑∑ÂêàÔºåÁã¨Á´ãÂ∞èÂåÖË£ÖÔºåÂàÜ‰∫´Ë£Ö",
                price: 39,
            },
            {
                name: "‰∫îÂ∏∏Á®ªËä±È¶ôÂ§ßÁ±≥",
                description: "5kgÁúüÁ©∫ÂåÖË£ÖÔºåÈªëÈæôÊ±ü‰∫îÂ∏∏‰∫ßÂå∫ÔºåÁ±≥Á≤íÈ•±Êª°Âè£ÊÑüÈ¶ôÁ≥Ø",
                price: 99,
            },
            {
                name: "ÁâπÁ∫ßÂàùÊ¶®Ê©ÑÊ¶ÑÊ≤π",
                description: "2LË£ÖÔºåË•øÁè≠ÁâôËøõÂè£ÔºåÈÄÇÂêàÂáâÊãåÂíå‰ΩéÊ∏©ÁÉπÈ•™ÔºåÂÅ•Â∫∑È£üÁî®Ê≤π",
                price: 129,
            },
            {
                name: "ÂÜªÂπ≤Èì∂ËÄ≥Áæπ",
                description: "ÂÖçÁÖÆÂç≥È£üÔºåÊ∑ªÂä†Êû∏ÊùûÂíåÂÜ∞Á≥ñÔºåÂºÄÊ∞¥ÂÜ≤Ê≥°3ÂàÜÈíüÂç≥ÂèØÈ£üÁî®",
                price: 55,
            },
            {
                name: "È±øÈ±º‰∏ùÊµ∑Âë≥Èõ∂È£ü",
                description: "Ê∑±Êµ∑È±øÈ±ºÂà∂‰ΩúÔºåÈ≤úÂ´©ÊúâÂöºÂä≤ÔºåÁã¨Á´ãÂåÖË£ÖÊñπ‰æøÊê∫Â∏¶",
                price: 35,
            },
            {
                name: "ÊäπËå∂Âë≥Êõ≤Â•áÈ•ºÂπ≤",
                description: "ËøõÂè£ÊäπËå∂Á≤âÂà∂‰ΩúÔºåËå∂È¶ôÊµìÈÉÅÔºåÂè£ÊÑüÈÖ•ËÑÜÔºåÁ§ºÁõíË£Ö",
                price: 49,
            },
            {
                name: "Á∫¢Ë±ÜËñèÁ±≥Á≤â",
                description: "Á•õÊπø‰ª£È§êÁ≤âÔºåÁã¨Á´ãÂ∞èÂåÖË£ÖÔºåÂºÄÊ∞¥ÂÜ≤Ë∞ÉÂç≥ÂèØÈ£üÁî®Ôºå30Êù°Ë£Ö",
                price: 59,
            },
            {
                name: "Â∑¥Êó¶Êú®Â§πÂøÉÊû£",
                description: "Êñ∞ÁñÜÁÅ∞Êû£Â§πÂ∑¥Êó¶Êú®ÔºåÊó†Ê∑ªÂä†ËîóÁ≥ñÔºåÈ¶ôÁîúÂèØÂè£ÔºåË°•Ë°ÄÁõäÊ∞î",
                price: 45,
            },
            {
                name: "ÊÑèÂ§ßÂà©Èù¢Â•óË£Ö",
                description: "Âê´Ëû∫ÊóãÈù¢„ÄÅÁï™ËåÑÈÖ±ÂíåÊÑèÂºèÈ¶ôËçâÔºå4‰∫∫‰ªΩÔºåÁÆÄÂçïÊòìÂÅö",
                price: 39,
            },
            {
                name: "ÈªÑÊ°ÉÁΩêÂ§¥",
                description: "Á†ÄÂ±±ÈªÑÊ°ÉÂà∂‰ΩúÔºåÊó†Èò≤ËÖêÂâÇÔºåÊûúËÇâÈ•±Êª°ÔºåÁ≥ñÊ∞¥Ê∏ÖÁîú",
                price: 35,
            },
            {
                name: "ÂùöÊûúÁáïÈ∫¶ËÉΩÈáèÊ£í",
                description: "‰ª£È§êÈõ∂È£üÔºåÂê´Â§öÁßçÂùöÊûúÂíåÁáïÈ∫¶ÔºåÊäóÈ•ø4Â∞èÊó∂Ôºå12Êù°Ë£Ö",
                price: 69,
            },
        ],
        milktea: [
            {
                name: "Ê≥¢Èú∏Â•∂Ëå∂",
                description: "ÁªèÂÖ∏Âè∞ÂºèÈ£éÂë≥ÔºåQÂºπÊ≥¢Èú∏Êê≠ÈÖçÈ¶ôÊµìÂ•∂Ëå∂ÔºåÂè£ÊÑü‰∏∞ÂØå„ÄÇ",
                price: 15,
                brand: "CoCoÈÉΩÂèØ",
            },
            {
                name: "ÂõõÂ≠£Êò•ÁéõÂ•áÊúµ",
                description: "Ê∏ÖÁàΩÁöÑÂõõÂ≠£Êò•Ëå∂Â∫ïÔºåË¶Ü‰∏äÁªµÂØÜÁöÑÂí∏È¶ôËäùÂ£´Â•∂ÁõñÔºåÂ±ÇÊ¨°ÂàÜÊòé„ÄÇ",
                price: 18,
                brand: "‰∏ÄÁÇπÁÇπ",
            },
            {
                name: "Â§öËÇâËë°ËêÑ",
                description:
                    "Êñ∞È≤úÊâãÂâ•Ëë°ËêÑÊûúËÇâÔºåÊê≠ÈÖçÊ∏ÖÁàΩÁªøÂ¶çËå∂Â∫ïÂíåQÂºπËÑÜÊ≥¢Ê≥¢Ôºå‰∫∫Ê∞îÈ¶ñÈÄâ„ÄÇ",
                price: 29,
                brand: "ÂñúËå∂",
            },
            {
                name: "ÂπΩÂÖ∞ÊãøÈìÅ",
                description:
                    "Á≤æÈÄâÁ∫¢Ëå∂Â∫ï‰∏éÈ≤úÂ•∂ËûçÂêàÔºåÈ°∂ÈÉ®Êíí‰∏äÈ¶ôËÑÜÁ¢ßÊ†πÊûúÔºåËå∂È¶ô‰∏éÂùöÊûúÈ¶ô‰∫§Áªá„ÄÇ",
                price: 20,
                brand: "Ëå∂È¢úÊÇ¶Ëâ≤",
            },
            {
                name: "ËäãÊ≥•Ê≥¢Ê≥¢Áâõ‰π≥",
                description: "ÊâãÂ∑•Êç£Âà∂ÁöÑÈ¶ôÁîúËäãÊ≥•ÔºåÊê≠ÈÖçQÂºπÊ≥¢Ê≥¢ÂíåÊñ∞È≤úÁâõ‰π≥ÔºåÂè£ÊÑüÁªµÂØÜ„ÄÇ",
                price: 22,
                brand: "Â•àÈõ™ÁöÑËå∂",
            },
            {
                name: "Êù®ÊûùÁîòÈú≤",
                description: "Êñ∞È≤úËäíÊûú„ÄÅË•øÊüöÊûúÁ≤í‰∏éË•øÁ±≥Èú≤ÁöÑÂÆåÁæéÁªìÂêàÔºåÂ§èÊó•Ëß£ÊöëÁ•ûÂô®„ÄÇ",
                price: 25,
                brand: "ÂñúËå∂",
            },
            {
                name: "ÊâæÂ•∂Ëå∂",
                description: "ÁªèÂÖ∏ÂéüÂë≥Â•∂Ëå∂ÔºåÂõûÂΩíÊúÄÁ∫ØÁ≤πÁöÑÂ•∂‰∏éËå∂ÁöÑËûçÂêàÔºåÊÄß‰ª∑ÊØî‰πãÈÄâ„ÄÇ",
                price: 12,
                brand: "‰∏ÄÁÇπÁÇπ",
            },
            {
                name: "ÂÜ∞È≤úÊü†Ê™¨Ê∞¥",
                description: "Êñ∞È≤úÊü†Ê™¨ÂàáÁâáÔºåÊê≠ÈÖçÂÜ∞ÂùóÂíåÁ∫ØÂáÄÊ∞¥ÔºåÊ∏ÖÁàΩËß£Ê∏¥ÔºåÊÄß‰ª∑ÊØî‰πãÁéã„ÄÇ",
                price: 4,
                brand: "ËúúÈõ™ÂÜ∞Âüé",
            },
            {
                name: "ÁèçÁè†Â•∂Ëå∂",
                description: "ÁªèÂÖ∏ÁöÑËúúÈõ™Â•∂Ëå∂ÔºåÊê≠ÈÖçQÂºπÁèçÁè†ÔºåÊòØÊØè‰∏™‰∫∫ÁöÑÂÖ•Èó®Ê¨æ„ÄÇ",
                price: 7,
                brand: "ËúúÈõ™ÂÜ∞Âüé",
            },
            {
                name: "Êë©Â§©ËÑÜËÑÜÂÜ∞Ê∑áÊ∑ã",
                description: "È¶ôËçâÂë≥ÁöÑÂÜ∞Ê∑áÊ∑ãÁîúÁ≠íÔºåÈ°∂ÈÉ®Âä†‰∏äÈÖ•ËÑÜÁöÑÂ∑ßÂÖãÂäõÊ£íÔºåÁ´•Âπ¥ÁöÑÂë≥ÈÅì„ÄÇ",
                price: 5,
                brand: "ËúúÈõ™ÂÜ∞Âüé",
            },
            {
                name: "Êª°ÊùØÁôæÈ¶ôÊûú",
                description: "Êñ∞È≤úÁôæÈ¶ôÊûúÊûúËÇâ‰∏éËå∂Â∫ïÁöÑÊøÄÊÉÖÁ¢∞ÊíûÔºåÈÖ∏ÁîúÂèØÂè£ÔºåÊûúÈ¶ôÂõõÊ∫¢„ÄÇ",
                price: 8,
                brand: "ËúúÈõ™ÂÜ∞Âüé",
            },
            {
                name: "Ë°ÄÁ≥ØÁ±≥Á∫¢Ë±ÜÂ•∂Ëå∂",
                description: "ÊãõÁâåË°ÄÁ≥ØÁ±≥Êê≠ÈÖçËΩØÁ≥ØÁ∫¢Ë±ÜÔºåÂè£ÊÑü‰∏∞ÂØåÔºåÊöñÂøÉÊöñËÉÉÁöÑ‰∫îË∞∑Â•∂Ëå∂„ÄÇ",
                price: 16,
                brand: "Ê≤™‰∏äÈòøÂß®",
            },
            {
                name: "È≤úÁÇñÊ¢®ËÜè",
                description: "ÊâãÂ∑•È≤úÁÇñÊ¢®ËÜèÔºåÊ∏ÖÊ∂¶ÈôçÁá•ÔºåÊê≠ÈÖçÈì∂ËÄ≥ÔºåÊòØÂÖªÁîü‰∫∫Â£´ÁöÑÈ¶ñÈÄâ„ÄÇ",
                price: 18,
                brand: "Ê≤™‰∏äÈòøÂß®",
            },
            {
                name: "ÁªøË±ÜÁâõ‰π≥ÂÜ∞",
                description: "Ê∏ÖÁàΩÁöÑÁªøË±ÜÊ≤ôÊê≠ÈÖçÈ°∫ÊªëÁâõ‰π≥ÔºåÂ§èÊó•Ëß£ÊöëÔºåÂè£ÊÑüÁªµÂØÜ„ÄÇ",
                price: 15,
                brand: "Ê≤™‰∏äÈòøÂß®",
            },
            {
                name: "ËäãÂúÜËë°ËêÑ",
                description: "Êñ∞È≤úËë°ËêÑÊûúËÇâÊê≠ÈÖçÊâãÂ∑•ËäãÂúÜÔºåQÂºπÊúâÂöºÂä≤ÔºåÊûúÂë≥ÂçÅË∂≥„ÄÇ",
                price: 20,
                brand: "Ê≤™‰∏äÈòøÂß®",
            },
            {
                name: "ÁÉ§Â•∂",
                description: "Áã¨ÁâπÁöÑÁÉòÁÑôÂ∑•Ëâ∫ÔºåÂ∏¶Êù•ÁÑ¶Á≥ñËà¨ÁöÑÁÇ≠ÁÉßÈ£éÂë≥ÔºåÂ•∂È¶ôÊµìÈÉÅ„ÄÇ",
                price: 16,
                brand: "Ëå∂È¢úÊÇ¶Ëâ≤",
            },
            {
                name: "Â•∂ÈúúËçâËéìÊûúËå∂",
                description: "Êñ∞È≤úËçâËéìÊûúËÇâ‰∏éÁªøËå∂ÁöÑÂÆåÁæéÁªìÂêàÔºåÈ°∂ÈÉ®Ë¶ÜÁõñÂí∏È¶ôÂ•∂Èúú„ÄÇ",
                price: 26,
                brand: "Â•àÈõ™ÁöÑËå∂",
            },
            {
                name: "È≤úËäãÁâõÂ•∂Ë•øÁ±≥Èú≤",
                description: "Êñ∞È≤úËäãÂ§¥Ëí∏ÁÖÆÊàêÊ≥•ÔºåÊê≠ÈÖçË•øÁ±≥ÂíåÁâõÂ•∂ÔºåÂè£ÊÑüÈ°∫Êªë„ÄÇ",
                price: 19,
                brand: "CoCoÈÉΩÂèØ",
            },
            {
                name: "ÂÜ∞Ê∑áÊ∑ãÁ∫¢Ëå∂",
                description: "È°∫ÊªëÁöÑÈ¶ôËçâÂÜ∞Ê∑áÊ∑ãÁêÉÔºåÁºìÁºìËûçÂÖ•ÈÜáÂéöÁöÑÁ∫¢Ëå∂‰∏≠ÔºåÁªèÂÖ∏‰πãÈÄâ„ÄÇ",
                price: 14,
                brand: "‰∏ÄÁÇπÁÇπ",
            },
            {
                name: "ËäùËäùËäíËäí",
                description: "Â§ßÂùóÊñ∞È≤úËäíÊûúÊûúËÇâÔºåÊê≠ÈÖçÁªøÂ¶çËå∂Â∫ïÂíåÊµìÈÉÅËäùÂ£´Â•∂ÁõñÔºåÊûúÈ¶ôÂõõÊ∫¢„ÄÇ",
                price: 32,
                brand: "ÂñúËå∂",
            },
            {
                name: "Â£∞Â£∞‰πåÈæô",
                description: "Â∏¶ÊúâÁã¨ÁâπÁÉüÁÜèÈ£éÂë≥ÁöÑ‰πåÈæôËå∂Â∫ïÔºåÂÖ•Âè£ÁîòÈÜáÔºåÂõûÂë≥ÊÇ†Èïø„ÄÇ",
                price: 17,
                brand: "Ëå∂È¢úÊÇ¶Ëâ≤",
            },
            {
                name: "Èú∏Ê∞îÊ©ôÂ≠ê",
                description: "Á≤æÈÄâËøõÂè£Êñ∞Â•áÂ£´Ê©ôÔºåÊï¥È¢óÈ≤úÂàáÔºåÊê≠ÈÖçÊ∏ÖÈ¶ôÁªøËå∂ÔºåVCÁàÜÊ£ö„ÄÇ",
                price: 25,
                brand: "Â•àÈõ™ÁöÑËå∂",
            },
        ],
        gifts: [
            {
                name: "ÁÆÄÁ∫¶ÊÉÖ‰æ£ÂØπÊàí",
                description: "ÈááÁî®‰ºòË¥®ÈáëÂ±ûÊâìÈÄ†ÔºåËÆæËÆ°ÁÆÄÁ∫¶Êó∂Â∞öÔºåË±°ÂæÅÊ∞∏ÊÅíÁà±ÊÑè„ÄÇ",
                price: 520,
                brand: "Âë®Â§ßÁ¶è",
            },
            {
                name: "ÁíÄÁí®ÈíªÁü≥ÊÉÖ‰æ£ÂØπÊàí",
                description: "Èï∂ÂµåÈó™ËÄÄÈíªÁü≥ÔºåÂ∑•Ëâ∫Á≤æÊπõÔºåÊòØÊÉÖ‰æ£Èó¥ÁèçË¥µÁöÑÊâøËØ∫Ë±°ÂæÅ„ÄÇ",
                price: 5999,
                brand: "DR",
            },
            {
                name: "99ÊúµÁ∫¢Áé´Áë∞Ëä±Êùü",
                description: "Á≤æÈÄâ99ÊúµÈ≤úËâ≥Á∫¢Áé´Áë∞ÔºåÂØìÊÑèÈïøÈïø‰πÖ‰πÖÔºåÊµ™Êº´Ëá≥ÊûÅ„ÄÇ",
                price: 399,
                brand: "ÈáéÂÖΩÊ¥æBEAST",
            },
            {
                name: "Ê∞∏ÁîüËä±Â∞èÁÜäÁ§ºÁõí",
                description: "ÂèØÁà±Â∞èÁÜäÊê≠ÈÖçÊ∞∏‰∏çÂáãË∞¢ÁöÑÊ∞∏ÁîüËä±ÔºåÁ≤æËá¥ÂèàÊµ™Êº´„ÄÇ",
                price: 258,
                brand: "ËØ∫Ë™ìROSEONLY",
            },
            {
                name: "ÊÉÖ‰æ£ËøûÂ∏ΩÂç´Ë°£",
                description: "Á∫ØÊ£âÊùêË¥®ÔºåËàíÈÄÇÈÄèÊ∞îÔºåÊÉÖ‰æ£Ê¨æËÆæËÆ°ÔºåÊó∂Â∞öÁôæÊê≠„ÄÇ",
                price: 199,
                brand: "ÂîêÁãÆTonlion",
            },
            {
                name: "ÁÆÄÁ∫¶ÊÉÖ‰æ£TÊÅ§",
                description: "ÁÆÄÁ∫¶È£éÊ†ºÔºåÂ§öÁßçÈ¢úËâ≤ÂèØÈÄâÔºåÈÄÇÂêàÊó•Â∏∏Á©øÁùÄ„ÄÇ",
                price: 99,
                brand: "Ê£ÆÈ©¨Semir",
            },
            {
                name: "ÊÉÖ‰æ£Áâõ‰ªîÂ§ñÂ•ó",
                description: "ÁªèÂÖ∏Áâõ‰ªîÈù¢ÊñôÔºåÊΩÆÊµÅÊ¨æÂºèÔºåÊÉÖ‰æ£Âá∫Ë°óË∂ÖÂê∏Áùõ„ÄÇ",
                price: 399,
                brand: "ÁæéÁâπÊñØÈÇ¶Â®Å",
            },
            {
                name: "ÊÉÖ‰æ£ËøêÂä®Èûã",
                description: "ËàíÈÄÇÈûãÂ∫ïÔºåÊó∂Â∞öÂ§ñËßÇÔºåÈÄÇÂêàÊÉÖ‰æ£‰∏ÄËµ∑ËøêÂä®„ÄÇ",
                price: 499,
                brand: "ÊùéÂÆÅLINING",
            },
            {
                name: "ÊÉÖ‰æ£ÊâãË°®",
                description: "ÁÆÄÁ∫¶Ë°®ÁõòËÆæËÆ°ÔºåÁ≤æÂáÜËµ∞Êó∂ÔºåÊó∂ÂàªÁõ∏‰º¥„ÄÇ",
                price: 799,
                brand: "Âç°Ë•øÊ¨ßCASIO",
            },
            {
                name: "ÊÉÖ‰æ£È¶ôÊ∞¥Á§ºÁõí",
                description: "Áî∑È¶ôÂ•≥È¶ôÊê≠ÈÖçÔºåÁã¨ÁâπÈ¶ôÂë≥ÔºåÂ¢ûÊ∑ªÊµ™Êº´Ê∞õÂõ¥„ÄÇ",
                price: 560,
                brand: "Á•ñÁéõÁèëJo Malone",
            },
            {
                name: "ÊÉÖ‰æ£Áù°Ë°£",
                description: "ÊüîËΩØÈù¢ÊñôÔºåËàíÈÄÇ‰∫≤ËÇ§Ôºå‰∫´ÂèóÊ∏©È¶®Â±ÖÂÆ∂Êó∂ÂÖâ„ÄÇ",
                price: 239,
                brand: "Ëä¨ËÖæFENTENG",
            },
            {
                name: "ÊÉÖ‰æ£‰øùÊ∏©ÊùØ",
                description: "‰øùÊ∏©ÊïàÊûúÂ•ΩÔºåÂèØÁà±Â§ñËßÇÔºåÊÉÖ‰æ£Âá∫Ë°åÂøÖÂ§á„ÄÇ",
                price: 129,
                brand: "ÂìàÂ∞îÊñØHAERS",
            },
            {
                name: "ÊÉÖ‰æ£Èí•ÂåôÊâ£",
                description: "Á≤æËá¥Â∞èÂ∑ßÔºåÂç∞ÊúâÊÉÖ‰æ£ÂÖÉÁ¥†ÔºåÊê∫Â∏¶Êñπ‰æø„ÄÇ",
                price: 39,
                brand: "ÂêçÂàõ‰ºòÂìÅMINISO",
            },
            {
                name: "ÊÉÖ‰æ£ÊâãÂ∑•Áõ∏ÂÜå",
                description: "ÂèØ‰∫≤ÊâãÂà∂‰ΩúÔºåËÆ∞ÂΩïÊÉÖ‰æ£Èó¥ÁæéÂ•ΩÂõûÂøÜ„ÄÇ",
                price: 69,
                brand: "Êô®ÂÖâM&G",
            },
            {
                name: "ÊÉÖ‰æ£Áé©ÂÅ∂",
                description: "ÂèØÁà±ÊØõÁªíÁé©ÂÅ∂Ôºå‰∏ÄÂØπÊê≠ÈÖçÔºåËêåË∂£ÂçÅË∂≥„ÄÇ",
                price: 89,
                brand: "Ëø™Â£´Â∞ºDisney",
            },
            {
                name: "ÊÉÖ‰æ£Èõ®‰ºû",
                description: "Êô¥Èõ®‰∏§Áî®ÔºåÊó∂Â∞öÂ§ñËßÇÔºå‰∏∫ÊÉÖ‰æ£ÈÅÆÈ£éÊå°Èõ®„ÄÇ",
                price: 99,
                brand: "Â§©Â†Ç‰ºû",
            },
            {
                name: "ÊÉÖ‰æ£Èí±ÂåÖ",
                description: "‰ºòË¥®ÁöÆÈù©ÔºåÂÆûÁî®ÂèàÁæéËßÇÔºåÊñπ‰æøÊê∫Â∏¶„ÄÇ",
                price: 189,
                brand: "ÂïÑÊú®È∏üTUCANO",
            },
            {
                name: "ÊÉÖ‰æ£Êä±Êûï",
                description: "ÊüîËΩØËàíÈÄÇÔºåÈù†Âú®‰∏äÈù¢‰∫´ÂèóÁîúËúúÊó∂ÂÖâ„ÄÇ",
                price: 79,
                brand: "ÂçóÊûÅ‰∫∫NanJiren",
            },
            {
                name: "ÊÉÖ‰æ£Â§™Èò≥Èïú",
                description: "Êó∂Â∞öÊ¨æÂºèÔºåÊúâÊïàÈòªÊå°Á¥´Â§ñÁ∫øÔºåÂá∫Ë°åÊó∂Â∞öÂçïÂìÅ„ÄÇ",
                price: 269,
                brand: "Êö¥ÈæôBOLON",
            },
            {
                name: "ÊÉÖ‰æ£ËìùÁâôÈü≥ÁÆ±",
                description: "Èü≥Ë¥®Ê∏ÖÊô∞ÔºåÂ∞èÂ∑ß‰æøÊê∫Ôºå‰∫´ÂèóÈü≥‰πêÊó∂ÂÖâ„ÄÇ",
                price: 159,
                brand: "Êº´Ê≠•ËÄÖEDIFIER",
            },
            {
                name: "ÊÉÖ‰æ£ÊâãÈìæ",
                description: "Á≤æÁæéËÆæËÆ°Ôºå‰Ω©Êà¥Âú®ÊâãËÖï‰∏äÔºåÂΩ∞ÊòæÊÉÖ‰æ£Ë∫´‰ªΩ„ÄÇ",
                price: 168,
                brand: "ÊñΩÂçéÊ¥õÊÄùÂ•áSWAROVSKI",
            },
            {
                name: "ÊÉÖ‰æ£Â∏ΩÂ≠ê",
                description: "ÊΩÆÊµÅÊ¨æÂºèÔºåÈÅÆÈò≥ÂèàÊó∂Â∞öÔºåÊÉÖ‰æ£Êê≠ÈÖçË∂ÖÈÖ∑„ÄÇ",
                price: 89,
                brand: "MLB",
            },
            {
                name: "ÊÉÖ‰æ£È§êÂÖ∑",
                description: "Á≤æËá¥È§êÂÖ∑ÔºåÈÄÇÂêàÊÉÖ‰æ£‰∏ÄËµ∑Áî®È§êÔºåÂ¢ûÊ∑ªÁîüÊ¥ª‰ª™ÂºèÊÑü„ÄÇ",
                price: 139,
                brand: "ÂèåÁ´ã‰∫∫ZWILLING",
            },
            {
                name: "ÊÉÖ‰æ£ÊâãÊú∫Â£≥",
                description: "ÂèØÁà±ÊàñÈÖ∑ÁÇ´ÁöÑËÆæËÆ°Ôºå‰øùÊä§ÊâãÊú∫ÂêåÊó∂ÁßÄÂá∫ÊÅ©Áà±„ÄÇ",
                price: 49,
                brand: "‰∫øËâ≤ESR",
            },
            {
                name: "ÊÉÖ‰æ£ÊãºÂõæ",
                description: "‰∏ÄËµ∑ÂÆåÊàêÊãºÂõæÔºå‰∫´ÂèóÂêà‰Ωú‰πêË∂£ÔºåÁïô‰∏ãÁæéÂ•ΩÂõûÂøÜ„ÄÇ",
                price: 59,
                brand: "3D-JP",
            },
            {
                name: "ÊÉÖ‰æ£È¶ôËñ∞Ëú°ÁÉõ",
                description: "Êï£ÂèëËø∑‰∫∫È¶ôÊ∞îÔºåËê•ÈÄ†Êµ™Êº´Ê∞õÂõ¥„ÄÇ",
                price: 99,
                brand: "ËßÇÂ§èTo Summer",
            },
            {
                name: "ÊÉÖ‰æ£ËøêÂä®ËÉåÂåÖ",
                description: "Â§ßÂÆπÈáèÔºåËàíÈÄÇËÉåË¥üÔºåÈÄÇÂêàÊÉÖ‰æ£Âá∫Ë°åÊàñËøêÂä®Êê∫Â∏¶Áâ©ÂìÅ„ÄÇ",
                price: 299,
                brand: "ÂÆâË∏èANTA",
            },
            {
                name: "ÊÉÖ‰æ£ÊãºÂõæÁõ∏Ê°Ü",
                description: "ÂèØÂ∞ÜÂÆåÊàêÁöÑÊãºÂõæÊîæÂÖ•Áõ∏Ê°ÜÔºå‰Ωú‰∏∫Ë£ÖÈ•∞ÔºåÁ∫™ÂøµÁæéÂ•Ω„ÄÇ",
                price: 79,
                brand: "Êó†Âç∞ËâØÂìÅMUJI",
            },
            {
                name: "ÊÉÖ‰æ£ÂÅ•Ë∫´Âô®ÊùêÔºàÂìëÈìÉÂ•óË£ÖÔºâ",
                description: "ÈÄÇÂêàÊÉÖ‰æ£‰∏ÄËµ∑ÂÅ•Ë∫´ÈîªÁÇºÔºåÊâìÈÄ†ÂÅ•Â∫∑ÁîüÊ¥ª„ÄÇ",
                price: 359,
                brand: "Ëø™Âç°‰æ¨DECATHLON",
            },
            {
                name: "ÊÉÖ‰æ£ÁÉòÁÑôÂ•óË£Ö",
                description: "ÂåÖÂê´ÁÉòÁÑôÂ∑•ÂÖ∑ÔºåÂèØ‰∏ÄËµ∑Âà∂‰ΩúÁîúËúúÁÇπÂøÉ„ÄÇ",
                price: 219,
                brand: "Â≠¶Âé®CHEFMADE",
            },
            {
                name: "ÊÉÖ‰æ£Áëú‰ºΩÂû´",
                description: "ÁéØ‰øùÊùêË¥®ÔºåËàíÈÄÇÈò≤ÊªëÔºåÈÄÇÂêàÊÉÖ‰æ£‰∏ÄËµ∑ÁªÉ‰π†Áëú‰ºΩ„ÄÇ",
                price: 149,
                brand: "Â••‰πâYOTTOY",
            },
        ],
        brands: [
            {
                name: " ÂÆùÊ†º‰∏Ω Serpenti Á≥ªÂàóÊâãÈïØ ",
                description:
                    " ‰ª•ÁÅµËõá‰∏∫ÁÅµÊÑüÔºåÈááÁî® 18K ÈáëÊùêË¥®ÔºåÈï∂ÂµåÁíÄÁí®ÂÆùÁü≥ÔºåÁÅµÂä®‰ºòÈõÖÔºåÂ∞ΩÊòæÂ•¢ÂçéÊ∞îË¥®ÔºåÊòØÂÆùÊ†º‰∏ΩÊûÅÂÖ∑‰ª£Ë°®ÊÄßÁöÑÁªèÂÖ∏Ê¨æÂºè„ÄÇ",
                price: 19800,
                brand: " ÂÆùÊ†º‰∏Ω BVLGARI",
            },
            {
                name: " Ê¢µÂÖãÈõÖÂÆù Alhambra ÂõõÂè∂ËçâÈ°πÈìæÔºàÁ∫¢ÁéâÈ´ìÈï∂ÈíªÊ¨æÔºâ",
                description:
                    " ÁªèÂÖ∏ÂõõÂè∂ËçâÈÄ†ÂûãÔºåÁ∫¢ÁéâÈ´ìÊê≠ÈÖçÈíªÁü≥ÔºåÂú®‰ºòÈõÖ‰∏≠Â¢ûÊ∑ªÈó™ËÄÄÂÖâËäíÔºåË±°ÂæÅÁùÄÂπ∏Ëøê‰∏éÁæéÂ•ΩÔºåÊòØÊ¢µÂÖãÈõÖÂÆùÁöÑÊòéÊòü‰∫ßÂìÅ„ÄÇ",
                price: 21e3,
                brand: " Ê¢µÂÖãÈõÖÂÆù VAN CLEEF & ARPELS",
            },
            {
                name: " Âç°Âú∞‰∫ö Love Á≥ªÂàóÂÆΩÁâàÊâãÈïØ ",
                description:
                    " Ê†áÂøóÊÄßÁöÑËû∫‰∏ùÈíâËÆæËÆ°ÔºåÂÆΩÁâàÈÄ†ÂûãÊõ¥ÊòæÂ§ßÊ∞îÔºå18K ÈáëÊùêË¥®ÂùöÂõ∫ËÄêÁî®ÔºåÂØìÊÑèÁùÄÂ∞ÜÁà±Áâ¢Áâ¢ÈîÅ‰ΩèÔºåÊòØÊÉÖ‰æ£Èó¥Ë°®ËææÁà±ÊÑèÁöÑÁÉ≠Èó®ÈÄâÊã©„ÄÇ",
                price: 23e3,
                brand: " Âç°Âú∞‰∫ö CARTIER",
            },
            {
                name: " Âä≥ÂäõÂ£´ËöùÂºèÊÅíÂä®Êó•ÂøóÂûã 36 ËÖïË°® ",
                description:
                    " Âä≥ÂäõÂ£´ÁªèÂÖ∏Ê¨æÂºèÔºå36 ÊØ´Á±≥Ë°®ÁõòÈÄÇÂêàÂ§öÁßçËÖïÂë®ÔºåËöùÂºèË°®Â£≥ÂùöÂõ∫Èò≤Ê∞¥ÔºåÁ≤æÂáÜËµ∞Êó∂ÔºåÂ±ïÁé∞ÂçìË∂äÂìÅË¥®‰∏é‰ΩéË∞ÉÂ•¢Âçé„ÄÇ",
                price: 18500,
                brand: " Âä≥ÂäõÂ£´ ROLEX",
            },
            {
                name: " È¶ôÂ•àÂÑø Chanel CF Mini ÈìæÊù°ÂåÖÔºàÂ∞èÁæäÁöÆÔºâ",
                description:
                    " È¶ôÂ•àÂÑøÁªèÂÖ∏ÁöÑ CF Á≥ªÂàóÔºåMini Â∞∫ÂØ∏Á≤æËá¥Â∞èÂ∑ßÔºåÂ∞èÁæäÁöÆÊùêË¥®ÊâãÊÑüÊüîËΩØÔºåËè±Ê†ºÁ∫πÊê≠ÈÖçÈáëÂ±ûÈìæÊù°ÔºåÊó∂Â∞öÂèàÁôæÊê≠ÔºåÊòØÊØè‰∏™Êó∂Â∞öËææ‰∫∫ÁöÑÊ¢¶ÊÉ≥ÂçïÂìÅ„ÄÇ",
                price: 20500,
                brand: " È¶ôÂ•àÂÑø CHANEL",
            },
            {
                name: " Ëø™Â•• Dior Lady D-Lite ‰∏âÊ†ºÊà¥Â¶ÉÂåÖÔºàËó§Ê†ºÁ∫πÔºâ",
                description:
                    " Âª∂Áª≠Êà¥Â¶ÉÂåÖÁöÑ‰ºòÈõÖËÆæËÆ°Ôºå‰∏âÊ†ºÂ§ßÂ∞èÂÆûÁî®‰∏îÁ≤æËá¥ÔºåËó§Ê†ºÁ∫πÊê≠ÈÖçÈáëÂ±ûÊâ£ÔºåÂΩ∞ÊòæËø™Â••ÁöÑÈ´òÁ∫ßË¥®ÊÑüÔºåÈÄÇÂêàÂêÑÁßçÊ≠£Âºè‰∏é‰ºëÈó≤Âú∫Âêà„ÄÇ",
                price: 19900,
                brand: " Ëø™Â•• DIOR",
            },
            {
                name: " Áà±È©¨‰ªï Herm√®s Evelyne 16 ÊñúÊåéÂåÖ ",
                description:
                    " ÁÆÄÁ∫¶ÁöÑËÆæËÆ°È£éÊ†ºÔºå16 ÂéòÁ±≥ÁöÑÂ∞∫ÂØ∏Â∞èÂ∑ß‰æøÊê∫ÔºåÁªèÂÖ∏ÁöÑ ‚ÄúH‚Äù Êâ£Ê†áËØÜÔºåÊê≠ÈÖçÂèØË∞ÉËäÇËÇ©Â∏¶ÔºåÂÆûÁî®ÊÄß‰∏éÊó∂Â∞öÊÑüÂÖºÂÖ∑ÔºåÊòØÁà±È©¨‰ªïÂÖ•Èó®Á∫ßÁöÑÁÉ≠Èó®ÂåÖÊ¨æ„ÄÇ",
                price: 22e3,
                brand: " Áà±È©¨‰ªï HERM√àS",
            },
            {
                name: " ËíÇËäôÂ∞º Tiffany T True Á≥ªÂàó 18K ÈáëÈï∂ÈíªÊâãÈìæ ",
                description:
                    "T Â≠óÈÄ†ÂûãËÆæËÆ°ÁÆÄÊ¥ÅÁé∞‰ª£Ôºå18K ÈáëÊê≠ÈÖçÈó™ËÄÄÈíªÁü≥ÔºåÂ±ïÁé∞Âá∫Áã¨ÁâπÁöÑÊó∂Â∞öÂìÅÂë≥ÔºåÊòØËíÇËäôÂ∞ºÂ∞ÜÁªèÂÖ∏‰∏éÂàõÊñ∞ËûçÂêàÁöÑ‰Ω≥‰Ωú„ÄÇ",
                price: 20800,
                brand: " ËíÇËäôÂ∞º TIFFANY & CO.",
            },
            {
                name: " ÂÆùËØóÈæô Boucheron Quatre Classique Á≥ªÂàóÊàíÊåá ",
                description:
                    " ËûçÂêà‰∫ÜÂõõÁßç‰∏çÂêåÊùêË¥®ÂíåÁ∫πË∑ØÁöÑËÆæËÆ°ÔºåË±°ÂæÅÁùÄÂíåË∞ê‰∏éÂπ≥Ë°°ÔºåÂ±ïÁé∞Âá∫ÂâçÂç´‰ºòÈõÖÁöÑÈ£éÊ†ºÔºåÁî∑Â•≥ÂùáÂèØ‰Ω©Êà¥ÔºåÂΩ∞Êòæ‰∏™ÊÄß‰∏éÂìÅÂë≥„ÄÇ",
                price: 19500,
                brand: " ÂÆùËØóÈæô BOUCHERON",
            },
            {
                name: " Â∞öÁæéÂ∑¥Èªé Chaumet Liens √âvidence Á≥ªÂàóÈ°πÈìæ ",
                description:
                    " ‰ª• ‚ÄúX‚Äù ÈÄ†Âûã‰∏∫Ê†∏ÂøÉÔºå‰ª£Ë°®ÁùÄÁºòÂàÜÁöÑËøûÁªìÔºå18K ÈáëÊê≠ÈÖçÈíªÁü≥ÔºåÁÆÄÁ∫¶ËÄå‰∏çÂ§±‰ºòÈõÖÔºåÂØìÊÑèÁæéÂ•ΩÔºåÈÄÇÂêà‰Ωú‰∏∫ÊÉÖ‰æ£Èó¥ÁöÑÂÆöÊÉÖ‰ø°Áâ©„ÄÇ",
                price: 21500,
                brand: " Â∞öÁæéÂ∑¥Èªé CHAUMET",
            },
        ],
    };
    async function uu() {
        const e = await Kl.loadData("settingsStore", "userBalance");
        return e ? e.value : 100;
    }
    async function mu() {
        const e = await uu();
        if (js)
            if (e >= 1e4) {
                const t = e / 1e4;
                js.textContent = `¬• ${parseFloat(t.toFixed(2))} W`;
            } else js.textContent = `¬• ${e.toFixed(2)}`;
        Ns && (Ns.style.display = e <= -200 ? "block" : "none");
    }
    (In.addEventListener("click", (e) => {
        (e.stopPropagation(),
            Je ||
            (Sc && !1 === Sc.enableMonologue) ||
            (Mm(), En.classList.toggle("visible")));
    }),
        Ks.addEventListener("click", async (e) => {
            const t = e.target.closest(".order-share-btn");
            if (!t) return;
            const n = parseInt(t.dataset.orderId, 10);
            try {
                const e = (await Kl.loadData("settingsStore", "myOrders")).value.find(
                    (e) => e.id === n,
                );
                if (!e) throw new Error("Êâæ‰∏çÂà∞ËØ•ËÆ¢Âçï");
                const t = await Kl.loadData("messageContacts", "allContacts"),
                    a = t.value.find((t) => t.ai.name === e.recipient.name);
                if (!a) throw new Error("Êâæ‰∏çÂà∞Êî∂‰ª∂‰∫∫ÂØπÂ∫îÁöÑËÅäÂ§©ÂØπËØù");
                const o = `(ÊàëÁªô‰Ω†ÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™ËÆ¢ÂçïÔºåÂïÜÂìÅÊòØ${e.items.map((e) => (e.brand ? `${e.brand}ÁöÑ‚Äú${e.name}‚Äù` : `‚Äú${e.name}‚Äù`)).join("Ôºå")}ÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊàë‰ª¨ÁöÑÂÖ≥Á≥ªÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ)`,
                    s = {
                        sender: "user",
                        text: `[ORDER_SHARE_CARD]${JSON.stringify(e)}`,
                        timestamp: new Date(),
                        uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                    };
                (Array.isArray(a.history) || (a.history = []),
                    a.history.push(s),
                    (a.lastMessage = "ÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™ËÆ¢Âçï"));
                const i = t.value,
                    r = i.findIndex((e) => e.id === a.id);
                (r > -1 &&
                    ((i[r] = a), await Kl.saveData("messageContacts", "allContacts", i)),
                    Ii.classList.add("show-messages"),
                    Ii.classList.remove("show-cart"),
                    Ii.classList.remove("show-orders"),
                    await Nc(a.id),
                    await Tc(o, a));
            } catch (e) {
                (console.error("ÂàÜ‰∫´ËÆ¢ÂçïÂ§±Ë¥•:", e), alert(`ÂàÜ‰∫´Â§±Ë¥•: ${e.message}`));
            }
        }),
        Us.addEventListener("click", () => {
            (Ii.classList.add("show-slacking-off"), gu());
        }),
        zs.addEventListener("click", () => {
            Ii.classList.remove("show-slacking-off");
        }));
    const pu = [
        {
            id: "coin-flip",
            name: "Âπ∏ËøêÁ°¨Â∏Å",
            description: "ÁåúÁåúÁ°¨Â∏ÅÊòØÊ≠£Èù¢ËøòÊòØÂèçÈù¢ÔºüÁåúÂØπËµ¢¬•50ÔºåÁåúÈîô‰∫è¬•20„ÄÇ",
            image:
                "https://i.postimg.cc/q7BWsqYB/0728bde4133c361a0d86d02dc7f0c625.png",
            winChance: 0.5,
            reward: 50,
            penalty: -20,
        },
        {
            id: "number-guess",
            name: "Êï∞Â≠óÂ§ßÂ∏à",
            description: "‰ªé1-3‰∏≠Áåú‰∏Ä‰∏™Êï∞Â≠ó„ÄÇÁåúÂØπËµ¢¬•80ÔºåÁåúÈîô‰∫è¬•40„ÄÇ",
            image:
                "https://i.postimg.cc/fLpFQKbk/26408f03e171688d69f0ac84c5f0bdc3.jpg",
            winChance: 0.33,
            reward: 80,
            penalty: -40,
        },
        {
            id: "go_to_work",
            name: "‰∏äÁè≠Ê®°Êãü",
            description: "‰ΩìÈ™åÊâìÂ∑•‰∫∫ÁöÑÊÇ≤Ê¨¢Á¶ªÂêàÔºå‰Ω†ÁöÑËñ™Ê∞¥Â∞ÜÁî±‰ªäÊó•ÁöÑËøêÂäøÂÜ≥ÂÆö„ÄÇ",
            image:
                "https://i.postimg.cc/tJ6cqx1k/e40723f24112fcbfb5b593fab10e3b5c.png",
        },
        {
            id: "lottery",
            name: "‰π∞ÂΩ©Á•®",
            description: "Êêè‰∏ÄÊêèÔºåÂçïËΩ¶ÂèòÊë©ÊâòÔºÅËä±Ë¥πÂ∞ëÈáèÂÇ®ËìÑÔºåËµ¢ÂèñÊúÄÈ´ò2000ÂÖÉÂ§ßÂ•ñÔºÅ",
            image:
                "https://i.postimg.cc/8504rz8Y/bc4d45476e2902ff4bd22788d2119ae6.jpg",
        },
    ];

    function gu() {
        Ws &&
            ((Ws.innerHTML = ""),
                pu.forEach((e) => {
                    const t = document.createElement("div");
                    ((t.className = "game-card"),
                        (t.innerHTML = `\n            <img src="${e.image}" alt="${e.name}">\n            <div class="game-card-info">\n                <h3>${e.name}</h3>\n                <p>${e.description}</p>\n                <button class="play-game-btn" data-game-id="${e.id}">ÂºÄÂßãÁé©</button>\n            </div>\n        `),
                        Ws.appendChild(t));
                }));
    }

    function yu(e) {
        e &&
            ((e.style.display = "flex"),
                setTimeout(() => {
                    ((e.style.opacity = "1"),
                        (e.querySelector(".modal-content").style.transform = "scale(1)"));
                }, 10));
    }

    function hu() {
        document
            .querySelectorAll(
                "#coin-flip-modal, #number-guess-modal, #lottery-modal, #blacklist-modal, #unlock-modal",
            )
            .forEach((e) => {
                ((e.style.opacity = "0"),
                    (e.querySelector(".modal-content").style.transform = "scale(0.95)"),
                    setTimeout(() => {
                        e.style.display = "none";
                    }, 300));
            });
    }

    function vu(e) {
        e &&
            ((e.style.display = "flex"),
                setTimeout(() => {
                    ((e.style.opacity = "1"),
                        (e.querySelector(".modal-content").style.transform = "scale(1)"));
                }, 10));
    }

    function fu() {
        document
            .querySelectorAll("#blacklist-modal, #unlock-modal")
            .forEach((e) => {
                ((e.style.opacity = "0"),
                    (e.querySelector(".modal-content").style.transform = "scale(0.95)"),
                    setTimeout(() => {
                        e.style.display = "none";
                    }, 300));
            });
    }
    (Ws.addEventListener("click", async (e) => {
        if (!e.target.classList.contains("play-game-btn")) return;
        const t = e.target.dataset.gameId;
        if (!pu.find((e) => e.id === t)) return;
        if ((await uu()) <= -200) vu(Ps);
        else if ("coin-flip" === t || "number-guess" === t)
            yu(document.getElementById(`${t}-modal`));
        else if ("lottery" === t) yu(document.getElementById("lottery-modal"));
        else if ("go_to_work" === t) {
            const e = wu[Math.floor(Math.random() * wu.length)];
            await bu({
                description: e.text.split("Ôºå")[0],
                amount: e.amount,
            });
            let t = `„Äê‰ªäÊó•Â∑•‰ΩúÊÄªÁªì„Äë\n\n${e.text}\n\n`;
            (e.amount > 0
                ? (t += `ÂÇ®ËìÑÂ¢ûÂä†: ¬•${e.amount.toFixed(2)}`)
                : e.amount < 0
                    ? (t += `ÂÇ®ËìÑÂáèÂ∞ë: ¬•${Math.abs(e.amount).toFixed(2)}`)
                    : (t += "ÂÇ®ËìÑÊó†ÂèòÂåñ„ÄÇ"),
                alert(t));
        }
    }),
        Rs.addEventListener("click", async (e) => {
            const t = e.target.closest(".game-choice-btn");
            if (!t) return;
            const n = parseInt(t.dataset.choice, 10),
                a = pu.find((e) => "number-guess" === e.id),
                o = Math.floor(3 * Math.random()) + 1;
            let s,
                i = `‰Ω†ÈÄâÊã©‰∫Ü ${n}ÔºåÊ≠£Á°ÆÁ≠îÊ°àÊòØ ${o}„ÄÇ\n\n`;
            (n === o
                ? ((s = a.reward),
                    (i += `ÁåúÂØπ‰∫ÜÔºÅÊÅ≠Âñú‰Ω†Ëµ¢‰∫Ü ¬•${a.reward.toFixed(2)}ÔºÅ`))
                : ((s = a.penalty),
                    (i += `ÁúüÈÅóÊÜæÔºÅ‰Ω†Ëæì‰∫Ü ¬•${Math.abs(a.penalty).toFixed(2)}„ÄÇ`)),
                await bu({
                    description: "Áé©Êï∞Â≠óÂ§ßÂ∏à",
                    amount: s,
                }),
                hu(),
                setTimeout(() => alert(i), 310));
        }),
        Gs.addEventListener("click", async (e) => {
            const t = e.target.closest(".game-choice-btn");
            if (!t) return;
            const n = t.dataset.choice,
                a = pu.find((e) => "coin-flip" === e.id),
                o = Math.random() < 0.5 ? "heads" : "tails";
            let s,
                i = `‰Ω†Áåú‰∫Ü ${"heads" === n ? "Ê≠£Èù¢" : "ÂèçÈù¢"}ÔºåÁªìÊûúÊòØ ${"heads" === o ? "Ê≠£Èù¢" : "ÂèçÈù¢"}„ÄÇ\n\n`;
            (n === o
                ? ((s = a.reward),
                    (i += `ÁåúÂØπ‰∫ÜÔºÅÊÅ≠Âñú‰Ω†Ëµ¢‰∫Ü ¬•${a.reward.toFixed(2)}ÔºÅ`))
                : ((s = a.penalty),
                    (i += `ÁúüÈÅóÊÜæÔºÅ‰Ω†Ëæì‰∫Ü ¬•${Math.abs(a.penalty).toFixed(2)}„ÄÇ`)),
                await bu({
                    description: "Áé©Âπ∏ËøêÁ°¨Â∏Å",
                    amount: s,
                }),
                hu(),
                setTimeout(() => alert(i), 310));
        }),
        Rs.addEventListener("click", async (e) => {
            const t = e.target.closest(".game-choice-btn");
            if (!t) return;
            const n = parseInt(t.dataset.choice, 10),
                a = pu.find((e) => "number_guess" === e.id),
                o = Math.floor(3 * Math.random()) + 1;
            let s = `‰Ω†ÈÄâÊã©‰∫Ü ${n}ÔºåÊ≠£Á°ÆÁ≠îÊ°àÊòØ ${o}„ÄÇ\n\n`;
            (n === o
                ? (await updateBalance(a.reward),
                    (s += `ÁåúÂØπ‰∫ÜÔºÅÊÅ≠Âñú‰Ω†Ëµ¢‰∫Ü ¬•${a.reward.toFixed(2)}ÔºÅ`))
                : (await updateBalance(a.penalty),
                    (s += `ÁúüÈÅóÊÜæÔºÅ‰Ω†Ëæì‰∫Ü ¬•${Math.abs(a.penalty).toFixed(2)}„ÄÇ`)),
                hu(),
                setTimeout(() => alert(s), 310));
        }),
        Gs.addEventListener("click", async (e) => {
            const t = e.target.closest(".game-choice-btn");
            if (!t) return;
            const n = t.dataset.choice,
                a = pu.find((e) => "coin_flip" === e.id),
                o = Math.random() < 0.5 ? "heads" : "tails";
            let s = `‰Ω†Áåú‰∫Ü ${"heads" === n ? "Ê≠£Èù¢" : "ÂèçÈù¢"}ÔºåÁªìÊûúÊòØ ${"heads" === o ? "Ê≠£Èù¢" : "ÂèçÈù¢"}„ÄÇ\n\n`;
            (n === o
                ? (await updateBalance(a.reward),
                    (s += `ÁåúÂØπ‰∫ÜÔºÅÊÅ≠Âñú‰Ω†Ëµ¢‰∫Ü ¬•${a.reward.toFixed(2)}ÔºÅ`))
                : (await updateBalance(a.penalty),
                    (s += `ÁúüÈÅóÊÜæÔºÅ‰Ω†Ëæì‰∫Ü ¬•${Math.abs(a.penalty).toFixed(2)}„ÄÇ`)),
                hu(),
                setTimeout(() => alert(s), 310));
        }),
        Hs.addEventListener("click", () => {
            (fu(), document.getElementById("slacking-off-tab-savings").click());
        }),
        Ns.addEventListener("click", () => {
            vu(Os);
        }),
        qs.addEventListener("click", fu),
        Fs.addEventListener("click", async () => {
            const e = _s.value.trim();
            if (e)
                try {
                    let t = (await Kl.loadData("settingsStore", "unlockCodes")).value;
                    t && t[e] && t[e] > 0
                        ? (t[e]--,
                            await Kl.saveData("settingsStore", "unlockCodes", t),
                            await Kl.saveData("settingsStore", "userBalance", 0),
                            await mu(),
                            alert(
                                `Ëß£ÈîÅÊàêÂäüÔºÅ\n\nËØ•Ëß£ÈîÅÁ†ÅÂâ©‰Ωô‰ΩøÁî®Ê¨°Êï∞Ôºö${t[e]}\n\nÊÇ®ÁöÑË¥¶Êà∑Â∑≤ÊÅ¢Â§çÊ≠£Â∏∏ÔºåÂÇ®ËìÑÂ∑≤ÈáçÁΩÆ‰∏∫ ¬•0.00„ÄÇ`,
                            ),
                            fu(),
                            (_s.value = ""))
                        : t && 0 === t[e]
                            ? alert("Ëß£ÈîÅÂ§±Ë¥•ÔºÅËØ•Ëß£ÈîÅÁ†ÅÁöÑ‰ΩøÁî®Ê¨°Êï∞Â∑≤Áî®Â∞Ω„ÄÇ")
                            : alert("Ëß£ÈîÅÂ§±Ë¥•ÔºÅÊó†ÊïàÁöÑËß£ÈîÅÁ†Å„ÄÇ");
                } catch (e) {
                    (console.error("Ëß£ÈîÅËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:", e),
                        alert("Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ"));
                }
            else alert("ËØ∑ËæìÂÖ•Ëß£ÈîÅÁ†ÅÔºÅ");
        }));
    const wu = [
        {
            text: "‰∏öÁª©Á™ÅÂá∫ÔºåÊãø‰∏ãÂ§ßÂçïÔºåËÄÅÊùøÈ´òÂÖ¥Âú∞Âèë‰∫ÜÂ•ñÈáëÔºÅ",
            amount: 200,
            type: "reward",
        },
        {
            text: "‰ºöËÆÆ‰∏äÊèêÂá∫ÁªùÂ¶ôÁÇπÂ≠êÔºåÈ°πÁõÆÂ•ñÈáëÂà∞ÊâãÔºÅ",
            amount: 150,
            type: "reward",
        },
        {
            text: "Â∏ÆÂêå‰∫ãËß£ÂÜ≥‰∫ÜÊäÄÊúØÈöæÈ¢òÔºåÊî∂Ëé∑‰∫Ü‰∏ãÂçàËå∂Âü∫Èáë„ÄÇ",
            amount: 50,
            type: "reward",
        },
        {
            text: "ÂÖ¨Âè∏Âπ¥‰ºöÊäΩ‰∏≠‰∫åÁ≠âÂ•ñÔºÅ",
            amount: 300,
            type: "reward",
        },
        {
            text: "ÂÜôÁöÑÊä•ÂëäË¢´ËØÑ‰∏∫ÊúÄ‰Ω≥ËåÉÊú¨ÔºåËé∑Âæó‰∫ÜÁª©ÊïàÂ•ñÂä±„ÄÇ",
            amount: 120,
            type: "reward",
        },
        {
            text: "ËøüÂà∞5ÂàÜÈíüÔºåÊ≠£Â•ΩÊíûËßÅËÄÅÊùøÔºåË¢´Êâ£‰∫ÜÂ∑•ËµÑ„ÄÇ",
            amount: -50,
            type: "penalty",
        },
        {
            text: "‰∏äÁè≠Êë∏È±ºÂà∑ÊâãÊú∫Ë¢´ÂèëÁé∞ÔºåÊú¨ÊúàÁª©ÊïàÂáèÂçä„ÄÇ",
            amount: -100,
            type: "penalty",
        },
        {
            text: "Êèê‰∫§ÁöÑÊñπÊ°àÂá∫Áé∞ÈáçÂ§ßÁñèÊºèÔºåÈúÄË¶ÅËá™Ë¥πËØ∑ÂÆ¢ËµîÁΩ™„ÄÇ",
            amount: -80,
            type: "penalty",
        },
        {
            text: "Âú®Ëå∂Ê∞¥Èó¥ËØ¥ËÄÅÊùøÂùèËØùÔºåË¢´Ë∑ØËøáÁöÑËÄÅÊùøÂê¨ËßÅ‰∫Ü...",
            amount: -150,
            type: "penalty",
        },
        {
            text: "ÁîµËÑëÁ™ÅÁÑ∂ËìùÂ±èÔºåÈáçË¶ÅÊñá‰ª∂Ê≤°‰øùÂ≠òÔºåÈ°πÁõÆÂª∂ËØØË¢´ÁΩöÊ¨æ„ÄÇ",
            amount: -180,
            type: "penalty",
        },
        {
            text: "ÈÄöÂã§Ë∑Ø‰∏äÊç°Âà∞Èí±ÂåÖÔºå‰∫§ÁªôË≠¶ÂØüÂèîÂèîÂêéÂèëÁé∞ÈáåÈù¢ÊúâÊÑüË∞¢Ë¥π„ÄÇ",
            amount: 100,
            type: "reward",
        },
        {
            text: "‰∏ãÁè≠Âêé‰π∞ÂΩ©Á•®ÔºåÁ´üÁÑ∂‰∏≠‰∫ÜÊú´Á≠âÂ•ñ„ÄÇ",
            amount: 10,
            type: "reward",
        },
        {
            text: "Âú®ÂÖ¨Âè∏Ê•º‰∏ãÈÅáÂà∞ÊÄªË£ÅÔºåÊÄªË£ÅÁúã‰Ω†È™®È™ºÊÉäÂ•áÔºåÁªô‰∫Ü‰Ω†‰∏Ä‰∏™Á∫¢ÂåÖ„ÄÇ",
            amount: 88,
            type: "reward",
        },
        {
            text: "Âçà‰ºëÊó∂ÂÅöÊ¢¶ÔºåÊ¢¶Âà∞‰∏ÄÁªÑÁ•ûÁßòÊï∞Â≠óÔºåÈÜíÊù•ÂêéÂèëÁé∞ÊòØËá™Â∑±ÁöÑÈì∂Ë°åÂç°‰ΩôÈ¢ù„ÄÇ",
            amount: 0,
            type: "neutral",
        },
        {
            text: "‰∏ÄÊï¥Â§©ÈÉΩÂú®ÂºÄ‰ºöÔºåÁ≤æÁ•ûÊÅçÊÉöÔºåÊó†ÂäüÊó†Ëøá„ÄÇ",
            amount: 0,
            type: "neutral",
        },
        {
            text: "ÂùêÁîµÊ¢ØÊó∂ÈÅáÂà∞Ë∂ÖËΩΩÔºå‰Ω†‰∏ªÂä®Ëµ∞‰∫ÜÂá∫Êù•ÔºåÁªìÊûúÁîµÊ¢ØÂùè‰∫ÜÔºå‰Ω†Âõ†Ê≠§Ë∫≤Ëøá‰∏ÄÂä´Âπ∂Ëé∑Âæó‰∫ÜËßÅ‰πâÂãá‰∏∫Â•ñ„ÄÇ",
            amount: 20,
            type: "reward",
        },
        {
            text: "ÁÇπÂ§ñÂçñÊó∂Áî®Èîô‰∫Ü‰ºòÊÉ†Âà∏ÔºåÂ§öËä±‰∫Ü‰∏ÄÁ¨îÈí±„ÄÇ",
            amount: -15,
            type: "penalty",
        },
        {
            text: "ÂèÇÂä†ÂÖ¨Âè∏ÁªÑÁªáÁöÑÂõ¢Âª∫ÔºåÂõ†‰∏∫Â§™Á¶ªË∞±ËÄåÁ≤æÁ•ûÂèóÂàõÔºåËé∑Âæó‰∫ÜÁ≤æÁ•ûÊçüÂ§±Ë¥π„ÄÇ",
            amount: 30,
            type: "reward",
        },
        {
            text: "ÊääÂÖ¨Âè∏ÊâìÂç∞Êú∫ÂºÑÂùè‰∫ÜÔºåÈúÄË¶ÅËµîÂÅøÁª¥‰øÆË¥π„ÄÇ",
            amount: -200,
            type: "penalty",
        },
        {
            text: "Ê∂®Â∑•ËµÑ‰∫Ü",
            amount: 8e3,
            type: "penalty",
        },
        {
            text: "‰∏ªÂØºÁöÑÊ†∏ÂøÉÈ°πÁõÆË∂ÖÈ¢ùÂÆåÊàêKPIÔºåËé∑ÂæóÂπ¥Â∫¶ÁâπÂà´Â•ñÈáë",
            amount: 15e4,
            type: "reward",
        },
        {
            text: "ÊàêÂäü‰∏∫ÂÖ¨Âè∏ÂºïËøõÊàòÁï•ÊäïËµÑÔºåËé∑ÂæóÈ°πÁõÆÂàÜÁ∫¢",
            amount: 2e5,
            type: "reward",
        },
        {
            text: "Á†îÂèëÁöÑ‰∏ìÂà©ÊäÄÊúØË¢´È´ò‰ª∑Êî∂Ë¥≠ÔºåËé∑ÂæóÂ∑®È¢ùÂ•ñÈáë",
            amount: 18e4,
            type: "reward",
        },
        {
            text: "ÂèëÁé∞ÈáçÂ§ßÂÆâÂÖ®ÊºèÊ¥ûÂπ∂ÂèäÊó∂Ë°•ÊïëÔºåÈÅøÂÖçÂÖ¨Âè∏Â∑®È¢ùÊçüÂ§±Ëé∑Â•ñÂä±",
            amount: 5e4,
            type: "reward",
        },
        {
            text: "Âπ¥Â∫¶‰ºòÁßÄ‰ºòÁßÄ‰∏öÂä°ÊãìÂ±ïÂà∞Êµ∑Â§ñÂ∏ÇÂú∫ÔºåÈ¶ñÂπ¥Ëê•Êî∂ËææÊ†áËé∑ÁâπÂà´Â•ñ",
            amount: 8e4,
            type: "reward",
        },
        {
            text: "Âõ†ÈáçÂ§ßÂÜ≥Á≠ñÂ§±ËØØÂØºËá¥ÂÖ¨Âè∏È°πÁõÆ‰∫èÊçüÔºåÊâøÊãÖËµîÂÅøË¥£‰ªª",
            amount: -3e4,
            type: "penalty",
        },
        {
            text: "Ê≥ÑÈú≤ÂÖ¨Âè∏Ê†∏ÂøÉÊú∫ÂØÜÔºåË¢´ËøΩÁ©∂Ë¥£‰ªªÁΩöÊ¨æ",
            amount: -5e4,
            type: "penalty",
        },
        {
            text: "Â∏¶È¢ÜÁöÑ‰∫ßÂìÅÂá∫Áé∞‰∏•ÈáçË¥®ÈáèÈóÆÈ¢òÔºåÈúÄÊâøÊãÖÈÉ®ÂàÜËµîÂÅøÈáë",
            amount: -25e3,
            type: "penalty",
        },
        {
            text: "ÊàêÂäüÁ´ûÊ†áÂõΩÂÆ∂Á∫ßÈáçÁÇπÈ°πÁõÆÔºåËé∑ÂæóÂõ¢ÈòüÊøÄÂä±Â•ñÈáë",
            amount: 12e4,
            type: "reward",
        },
        {
            text: "ËøùËßÑÊìç‰ΩúÈÄ†ÊàêÁîü‰∫ß‰∫ãÊïÖÔºåË¢´Êâ£Èô§ÂÆâÂÖ®‰øùËØÅÈáë",
            amount: -4e4,
            type: "penalty",
        },
        {
            text: "ÂèëÁé∞ÂÖ¨Âè∏Ë¥¢Âä°Á≥ªÁªüÁöÑ‰∏Ä‰∏™BUGÔºåÈÅøÂÖç‰∫ÜÂ∑®Â§ßÊçüÂ§±ÔºåËé∑ÂæóÁâπÊÆäË¥°ÁåÆÂ•ñÔºÅ",
            amount: 500,
            type: "reward",
        },
        {
            text: "ÂºÄÂèëÁöÑÊ†∏ÂøÉ‰∫ßÂìÅËé∑ÂæóË°å‰∏öÂ§ßÂ•ñÔºåÂÖ¨Âè∏Áªô‰∫àÂàõÊñ∞Â•ñÂä±",
            amount: 12e4,
            type: "reward",
        },
        {
            text: "ÊàêÂäüÁ≠æ‰∏ãÂπ¥Â∫¶ÊúÄÂ§ßÂÆ¢Êà∑ÔºåËé∑ÂæóÈîÄÂîÆÂÜ†ÂÜõÁâπÂà´Â•ñÈáë",
            amount: 18e4,
            type: "reward",
        },
        {
            text: "ÊèêÂá∫ÁöÑÊàêÊú¨‰ºòÂåñÊñπÊ°à‰∏∫ÂÖ¨Âè∏ËäÇÁúÅÂ∑®È¢ùÂºÄÊîØÔºåËé∑‰∏ìÈ°πÂ•ñÂä±",
            amount: 8e4,
            type: "reward",
        },
        {
            text: "Â∏¶È¢ÜÂõ¢ÈòüÊîªÂÖãÊäÄÊúØÈöæÂÖ≥ÔºåÈ°πÁõÆÊèêÂâç‰∏äÁ∫øËé∑È¢ùÂ§ñÂ•ñÈáë",
            amount: 6e4,
            type: "reward",
        },
        {
            text: "Âπ¥Â∫¶Áª©ÊïàËÄÉÊ†∏ÂÖ®ÂÖ¨Âè∏Á¨¨‰∏ÄÔºåËé∑ÂæóÊÄªË£ÅÁâπÂà´ÂòâÂ•ñ",
            amount: 15e4,
            type: "reward",
        },
        {
            text: "‰∏ªÂØºÁöÑÂπ∂Ë¥≠Ê°àÂúÜÊª°ÂÆåÊàêÔºåËé∑ÂæóÊàòÁï•Ë¥°ÁåÆÂ•ñÈáë",
            amount: 2e5,
            type: "reward",
        },
        {
            text: "ÂÆ¢Êà∑Êª°ÊÑèÂ∫¶ËØÑÂàÜËøûÁª≠12‰∏™ÊúàÁ¨¨‰∏ÄÔºåËé∑ÊúçÂä°‰πãÊòüÂ•ñÈáë",
            amount: 3e4,
            type: "reward",
        },
        {
            text: "‰∏∫ÂÖ¨Âè∏ÂüπÂÖªÂá∫3ÂêçÈÉ®Èó®‰∏ªÁÆ°ÔºåËé∑‰∫∫ÊâçÂèëÂ±ïÂ•ñÂä±",
            amount: 5e4,
            type: "reward",
        },
        {
            text: "Êí∞ÂÜôÁöÑË°å‰∏öÊä•ÂëäË¢´ÂõΩÂÆ∂Á∫ßÊúüÂàäÊî∂ÂΩïÔºåÂÖ¨Âè∏Áªô‰∫àÁßëÁ†îÂ•ñÂä±",
            amount: 4e4,
            type: "reward",
        },
        {
            text: "Âú®ÂõΩÈôÖË°å‰∏öÂ≥∞‰ºö‰∏ä‰ª£Ë°®ÂÖ¨Âè∏ÂèëË®ÄÔºåÊèêÂçáÂìÅÁâåÂΩ±ÂìçÂäõËé∑Â•ñÂä±",
            amount: 7e4,
            type: "reward",
        },
    ];
    async function bu(e) {
        e.timestamp = new Date();
        const t = await Kl.loadData("settingsStore", "transactionHistory");
        let n = t && Array.isArray(t.value) ? t.value : [];
        (n.unshift(e), await Kl.saveData("settingsStore", "transactionHistory", n));
        const a = (await uu()) + e.amount;
        return (
            a <= -200
                ? (vu(Ps), await Kl.saveData("settingsStore", "userBalance", -200))
                : await Kl.saveData("settingsStore", "userBalance", a),
            await mu(),
            a
        );
    }
    (Ts.addEventListener("click", () => {
        (!(async function () {
            const e = await Kl.loadData("settingsStore", "transactionHistory");
            let t = e && Array.isArray(e.value) ? e.value : [];
            if (((Ds.innerHTML = ""), 0 === t.length))
                return void (Ds.innerHTML =
                    '<p style="text-align:center; color:#888;">ÊöÇÊó†Êî∂ÊîØËÆ∞ÂΩï</p>');
            t.forEach((e) => {
                const t = document.createElement("div");
                t.className = "transaction-item";
                const n = e.amount >= 0 ? "income" : "expense",
                    a = e.amount >= 0 ? "+" : "";
                ((t.innerHTML = `\n            <div class="transaction-info">\n                <div class="description">${e.description}</div>\n                <div class="timestamp">${new Date(e.timestamp).toLocaleString("zh-CN")}</div>\n            </div>\n            <div class="transaction-amount ${n}">\n                ${a}${e.amount.toFixed(2)}\n            </div>\n        `),
                    Ds.appendChild(t));
            });
        })(),
            Ii.classList.add("show-transactions"));
    }),
        As.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("transactions-list-container"),
                Ii.classList.remove("show-transactions"));
        }),
        is.addEventListener("click", () => {
            Ii.classList.add("show-gacha");
        }),
        ls.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("gacha-posts-container"),
                void 0 !== Cs && (Cs = null),
                Ii.classList.remove("show-gacha"));
        }),
        ps.addEventListener("click", () => {
            lu();
        }));
    (document
        .getElementById("shopper-list-container")
        .addEventListener("click", async (e) => {
            if (!rs.classList.contains("active")) return;
            const t = e.target.closest(".invite-contact-item");
            if (t) {
                const e = parseInt(t.dataset.contactId, 10),
                    n = (await Kl.loadData("messageContacts", "allContacts")).value.find(
                        (t) => t.id === e,
                    );
                n &&
                    ((Cs = n),
                        (gs.src = n.user.avatar),
                        console.log(`GACHA Ë∫´‰ªΩÂ∑≤ÂàáÊç¢‰∏∫: ${Cs.user.name}`),
                        cu());
            }
        }),
        is.addEventListener("click", async () => {
            if ((Ii.classList.add("show-gacha"), !Cs)) {
                const e = await Kl.loadData("messageContacts", "allContacts");
                e &&
                    Array.isArray(e.value) &&
                    e.value.length > 0 &&
                    ((Cs = e.value[0]),
                        (gs.src = Cs.user.avatar),
                        console.log(`GACHA ÈªòËÆ§Ë∫´‰ªΩÂ∑≤ËÆæÁΩÆ‰∏∫: ${Cs.user.name}`));
            }
            Iu();
        }));

    function Eu() {
        ((hs.style.opacity = "0"),
            (hs.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                ((hs.style.display = "none"), (fs.value = ""), (ws.value = ""));
            }, 300));
    }
    async function Iu() {
        const e = await Kl.loadData("gachaPosts", "allPosts"),
            t = e && Array.isArray(e.value) ? e.value : [];
        ((ms.innerHTML = ""),
            0 !== t.length
                ? t.forEach((e) => {
                    const t = (function (e) {
                        const t = document.createElement("div");
                        ((t.className = "gp-card"), (t.dataset.postId = e.id));
                        const n = new Date(e.timestamp),
                            a = `${n.getFullYear()}Âπ¥${n.getMonth() + 1}Êúà${n.getDate()}Êó• ÊòüÊúü${["Êó•", "‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠"][n.getDay()]}`,
                            o = !!Cs && e.likes.some((e) => e.id === Cs.id),
                            s = o ? "liked" : "",
                            i = e.content.replace(/\n/g, "<br>"),
                            r = e.imageDescription
                                ? `<p class="gp-image-desc">[ÂõæÁâáÊèèËø∞]: ${e.imageDescription}</p>`
                                : "",
                            l = Array.isArray(e.visibleTo) && e.visibleTo.length > 0,
                            c =
                                '\n        <button class="gp-delete-post-btn gp-action-button" title="Âà†Èô§Â∏ñÂ≠ê">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n        </button>';
                        if (
                            ((t.innerHTML = `\n        <div class="gp-header">\n            <div class="gp-header-content">\n                <div class="gp-user-info">\n                    <div class="gp-avatar" style="background-image: url('${e.authorAvatar}');"></div>\n                    <div><div class="gp-user-name">${e.authorName}</div><div class="gp-user-handle">‰∏™ÊÄßÁ≠æÂêç</div></div>\n                </div>\n                ${c} \n                <button class="gp-visibility-btn ${l ? "private" : ""}" data-post-id="${e.id}">\n                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>\n                </button>\n                <div class="gp-post-date">${a}</div>\n            </div>\n        </div>\n        <div class="gp-divider"></div>\n        <div class="gp-post-content">\n            <div class="gp-post-text"><p>${i}</p>${r}</div>\n            <div class="gp-action-buttons">\n                <button class="gp-like-btn gp-action-button ${s}"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.125 3.75C4.02246 3.75 1.5 6.30176 1.5 9.375C1.5 10.4473 1.98633 11.376 2.4375 12.0469C2.88867 12.7178 3.35156 13.1484 3.35156 13.1484L11.4609 21.2812L12 21.8203L12.5391 21.2812L20.6484 13.1484C20.6484 13.1484 22.5 11.5166 22.5 9.375C22.5 6.30176 19.9775 3.75 16.875 3.75C14.2998 3.75 12.6416 5.2998 12 5.95312C11.3584 5.2998 9.7002 3.75 7.125 3.75ZM7.125 5.25C9.36621 5.25 11.4375 7.42969 11.4375 7.42969L12 8.0625L12.5625 7.42969C12.5625 7.42969 14.6338 5.25 16.875 5.25C19.1572 5.25 21 7.12207 21 9.375C21 10.5322 19.5938 12.0938 19.5938 12.0938L12 19.6875L4.40625 12.0938C4.40625 12.0938 4.04297 11.7451 3.67969 11.2031C3.31641 10.6611 3 9.95508 3 9.375C3 7.12207 4.84277 5.25 7.125 5.25Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-comment-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V19.5H9.43945L12 22.0605L14.5605 19.5H21.75V4.5H2.25ZM3.75 6H20.25V18H13.9395L12 19.9395L10.0605 18H3.75V6ZM6.75 8.25V9.75H17.25V8.25H6.75ZM6.75 11.25V12.75H17.25V11.25H6.75ZM6.75 14.25V15.75H14.25V14.25H6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-favorite-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3.75L11.7656 3.96094L3.21094 12.6094L2.69531 13.125L3.21094 13.6641L10.3359 20.7891L10.875 21.3047L11.3906 20.7891L20.0391 12.2344L20.25 12V3.75H12ZM12.6328 5.25H18.75V11.3672L10.875 19.1953L4.80469 13.125L12.6328 5.25ZM16.5 6.75C16.0869 6.75 15.75 7.08691 15.75 7.5C15.75 7.91309 16.0869 8.25 16.5 8.25C16.9131 8.25 17.25 7.91309 17.25 7.5C17.25 7.08691 16.9131 6.75 16.5 6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-summon-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V10.5H6.47607L9 14.9312V20.25H15V14.25H10.3374L8.20312 10.5H8.25V8.25H15.75V10.5H21.75V4.5H15.75V6.75H8.25V4.5H2.25ZM3.75 6H6.75V9H3.75V6ZM17.25 6H20.25V9H17.25V6ZM10.8135 15.75H13.5V18.75H10.5V15.9287L10.8135 15.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n            </div>\n        </div>\n        <div class="gp-comment-section" style="display: none;">\n            <div class="gp-comment-input-area"><div class="gp-comment-input-wrapper"><div class="gp-comment-avatar" style="background-image: url('${Cs ? Cs.user.avatar : ""}');"></div><input type="text" class="gp-comment-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..."></div></div>\n            <div class="gp-comment-list"></div>\n        </div>\n    `),
                                e.comments && e.comments.length > 0)
                        ) {
                            const n = t.querySelector(".gp-comment-list");
                            e.comments.forEach((e) => {
                                const t = Lu(e);
                                n.appendChild(t);
                            });
                        }
                        return t;
                    })(e);
                    ms.appendChild(t);
                })
                : (ms.innerHTML =
                    '<p style="text-align:center; color:#888; margin-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜ‰∫´ÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ÂêßÔºÅ</p>'));
    }
    async function xu(e, t, n = null, a = null) {
        const o = a || Cs;
        if (!o) return (console.error("Êó†Ê≥ïÁ°ÆÂÆöËØÑËÆ∫‰ΩúËÄÖË∫´‰ªΩÔºÅ"), null);
        const s = n ? `@${n} ${t}` : t,
            i = {
                id: Date.now(),
                authorId: o.id,
                authorName: o.ai ? o.ai.name : o.user.name,
                authorAvatar: o.ai ? o.ai.avatar : o.user.avatar,
                text: s,
                timestamp: new Date().toISOString(),
                likes: [],
            };
        let r = (await Kl.loadData("gachaPosts", "allPosts")).value;
        const l = r.find((t) => t.id === e);
        return (
            l &&
            (l.comments || (l.comments = []),
                l.comments.push(i),
                await Kl.saveData("gachaPosts", "allPosts", r)),
            i
        );
    }

    function ku(e) {
        Ii.classList.toggle("dark-mode", e);
    }

    function Lu(e) {
        const t = document.createElement("div");
        ((t.className = "gp-comment-item"), (t.dataset.commentId = e.id));
        const n = new Date(e.timestamp),
            a = `${n.getMonth() + 1}-${n.getDate()} ${n.getHours()}:${String(n.getMinutes()).padStart(2, "0")}`,
            o = e.text.replace(/(@\S+)/g, '<span class="gp-reply-mention">$1</span>');
        let s = "";
        if (e.likes && e.likes.length > 0) {
            s = `\n            <div class="gp-comment-likes">\n                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>\n                <span>${e.likes.map((e) => e.name).join(", ")} ËßâÂæóÂæàËµû</span>\n            </div>\n        `;
        }
        return (
            (t.innerHTML = `\n        <div class="gp-comment-avatar" style="background-image: url('${e.authorAvatar}');"></div>\n        <div class="gp-comment-content">\n            <div class="gp-comment-header">\n                <span class="gp-comment-username">${e.authorName}</span>\n                <span class="gp-comment-time">${a}</span>\n            </div>\n            <div class="gp-comment-text">${o}</div>\n            <div class="gp-comment-actions">\n                <button class="gp-reply-btn">ÂõûÂ§ç</button>\n                \n        <button class="gp-delete-comment-btn gp-action-button" title="Âà†Èô§ËØÑËÆ∫">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n        </button>\n            </div>\n            ${s}\n        </div>\n    `),
            t
        );
    }

    function Bu() {
        ((Es.style.opacity = "0"),
            setTimeout(() => {
                ((Es.style.display = "none"), ($s = null));
            }, 300));
    }
    async function Su(e) {
        try {
            const t = await Kl.loadData("messageContacts", "allContacts");
            return t && Array.isArray(t.value)
                ? t.value.find((t) => t.id === e)
                : null;
        } catch (e) {
            return (console.error("ÈÄöËøáIDËé∑ÂèñËÅîÁ≥ª‰∫∫Â§±Ë¥•:", e), null);
        }
    }

    function Cu() {
        ((Ls.style.opacity = "0"),
            setTimeout(() => {
                ((Ls.style.display = "none"), (Ms = null));
            }, 300));
    }
    async function $u(e, t, n) {
        console.log(`Â∞ùËØïËß¶Âèë ${t} Êù•ÂõûÂ§ç...`);
        try {
            const a = await Kl.loadData("messageContacts", "allContacts");
            if (!a || !Array.isArray(a.value)) return;
            const o = a.value.find((e) => e.ai.name === t);
            if (!o) return void console.log(`${t} ‰∏çÊòØ‰∏Ä‰∏™ÂèØËß¶ÂèëÁöÑAIËßíËâ≤„ÄÇ`);
            const s = Cs.user.name,
                i = `(Á≥ªÁªüÊåá‰ª§Ôºö'${s}' ÂàöÂàöÂú®‰∏ÄÊù°Âä®ÊÄÅ‰∏ãÂõûÂ§ç‰∫Ü‰Ω†ÁöÑËØÑËÆ∫„ÄÇ\nËøôÊòØTAÁöÑÂõûÂ§çÂÜÖÂÆπÔºö ‚Äú${n}‚Äù\nËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÂíåËÅäÂ§©ËÆ∞ÂΩï‰ª•ÂèäÂ∏ñÂ≠êÂÜÖÂÆπÔºå‰ΩøÁî® "ËØÑËÆ∫ÊúãÂèãÂúàÔºö" ÂëΩ‰ª§Ê†ºÂºèÂú®Âêå‰∏Ä‰∏™Â∏ñÂ≠ê‰∏ãÔºàÂ∏ñÂ≠êID: ${e}ÔºâÂèëË°®‰∏ÄÊù°Êñ∞ÁöÑÂÖ¨ÂºÄÂõûÂ§ç„ÄÇ)`;
            (console.log(`ÂáÜÂ§áÂêë ${o.ai.name} ÂèëÈÄÅÊåá‰ª§:`, i),
                await Tc(i, o, {
                    postId: e,
                    replyToUsername: s,
                }));
        } catch (e) {
            console.error("Ëß¶ÂèëAIÂõûÂ§çÂ§±Ë¥•:", e);
        }
    }

    function ku(e) {
        Ii.classList.toggle("dark-mode", e);
    }
    async function Mu(e, t, n = null) {
        if (!e || !t)
            return void console.error("AIÂàõÂª∫Â∏ñÂ≠êÂ§±Ë¥•ÔºöÁº∫Â∞ë‰ΩúËÄÖ‰ø°ÊÅØÊàñÊ≠£Êñá„ÄÇ");
        const a = {
            id: Date.now(),
            authorId: e.id,
            authorName: e.ai.name,
            authorAvatar: e.ai.avatar,
            timestamp: new Date().toISOString(),
            content: t,
            imageDescription: n,
            likes: [],
            comments: [],
            visibleTo: [],
        };
        try {
            const t = await Kl.loadData("gachaPosts", "allPosts");
            let n = t && Array.isArray(t.value) ? t.value : [];
            (n.unshift(a),
                await Kl.saveData("gachaPosts", "allPosts", n),
                console.log(`${e.ai.name} ÊàêÂäüÂèëÂ∏É‰∫Ü‰∏ÄÊù°ÊúãÂèãÂúàÔºÅ`),
                Iu());
        } catch (e) {
            console.error("AI‰øùÂ≠òÂ∏ñÂ≠êÂ§±Ë¥•:", e);
        }
    }
    (document
        .getElementById("shopper-list-container")
        .addEventListener("click", async (e) => {
            const t = e.target.closest(".invite-contact-item");
            if (!t) return;
            const n = parseInt(t.dataset.contactId, 10),
                a = (await Kl.loadData("messageContacts", "allContacts")).value.find(
                    (e) => e.id === n,
                );
            a &&
                (Ii.classList.contains("show-gacha")
                    ? ((Cs = a),
                        (gs.src = a.user.avatar),
                        console.log(`GACHA Ë∫´‰ªΩÂ∑≤ÂàáÊç¢‰∏∫: ${Cs.user.name}`))
                    : Ii.classList.contains("show-shop") && ru(a),
                    cu());
        }),
        vs.addEventListener("click", Eu),
        ys.addEventListener("click", () => {
            if (!Cs) return void alert("ËØ∑ÂÖàÁÇπÂáªÂè≥‰∏äËßíÂ§¥ÂÉèÈÄâÊã©‰∏Ä‰∏™ÂèëÂ∏ñË∫´‰ªΩÔºÅ");
            const e = document
                .getElementById("share-content-panel")
                .classList.contains("active"),
                t = document
                    .getElementById("forum-content-panel")
                    .classList.contains("active");
            e
                ? ((hs.style.display = "flex"),
                    setTimeout(() => {
                        ((hs.style.opacity = "1"),
                            (hs.querySelector(".modal-content").style.transform =
                                "scale(1)"));
                    }, 10))
                : t && alert("ËÆ∫ÂùõÂèëÂ∏ñÂäüËÉΩÂæÖÂÆûÁé∞ÔºÅ");
        }),
        vs.addEventListener("click", Eu),
        bs.addEventListener("click", async () => {
            const e = fs.value.trim(),
                t = ws.value.trim();
            if (!e && !t) return void alert("ÂàÜ‰∫´ÂÜÖÂÆπÂíåÂõæÁâáÊèèËø∞‰∏çËÉΩÈÉΩ‰∏∫Á©∫ÔºÅ");
            const n = {
                id: Date.now(),
                authorId: Cs.id,
                authorName: Cs.user.name,
                authorAvatar: Cs.user.avatar,
                timestamp: new Date().toISOString(),
                content: e,
                imageDescription: t,
                likes: [],
                comments: [],
                visibleTo: [],
            };
            try {
                const e = await Kl.loadData("gachaPosts", "allPosts");
                let t = e && Array.isArray(e.value) ? e.value : [];
                (t.unshift(n),
                    await Kl.saveData("gachaPosts", "allPosts", t),
                    Iu(),
                    Eu());
            } catch (e) {
                (console.error("‰øùÂ≠òÂ∏ñÂ≠êÂ§±Ë¥•:", e),
                    alert("ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËÆæÁΩÆ„ÄÇ"));
            }
        }),
        ms.addEventListener("keydown", async (e) => {
            const t = e.target;
            if (
                "Enter" === e.key &&
                (t.classList.contains("gp-comment-input") ||
                    t.classList.contains("gp-reply-input"))
            ) {
                e.preventDefault();
                const n = t.value.trim();
                if (!n || !Cs) return;
                const a = t.closest(".gp-card"),
                    o = parseInt(a.dataset.postId),
                    s = t.classList.contains("gp-reply-input") ? t.dataset.replyTo : null,
                    i = await (async function (e, t, n = null, a = null) {
                        if (!Cs) return (alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩÂÜçÂèëË°®ËØÑËÆ∫ÔºÅ"), null);
                        const o = Cs,
                            s = t,
                            i = {
                                id: `c-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                authorId: o.id,
                                authorName: o.user.name,
                                authorAvatar: o.user.avatar,
                                text: s,
                                timestamp: new Date().toISOString(),
                                likes: [],
                                replies: [],
                            };
                        try {
                            let t = (await Kl.loadData("gachaPosts", "allPosts")).value || [];
                            const n = t.findIndex((t) => t.id === e),
                                o = t[n];
                            if (o) {
                                if (a) {
                                    mp(o.comments, a, i) || o.comments.push(i);
                                } else (o.comments || (o.comments = []), o.comments.push(i));
                                return (await Kl.saveData("gachaPosts", "allPosts", t), i);
                            }
                            throw new Error(`Êâæ‰∏çÂà∞ID‰∏∫ ${e} ÁöÑÂ∏ñÂ≠ê`);
                        } catch (e) {
                            return (console.error("Áî®Êà∑ÂèëË°®ËØÑËÆ∫Â§±Ë¥•:", e), null);
                        }
                    })(o, n, s);
                if (i) {
                    const e = a.querySelector(".gp-comment-list"),
                        r = Lu(i);
                    if (
                        (e.appendChild(r),
                            (t.value = ""),
                            (e.scrollTop = e.scrollHeight),
                            s)
                    )
                        await $u(o, s, n);
                    else {
                        const e = a.querySelector(".gp-user-name").textContent;
                        await $u(o, e, n);
                    }
                }
            }
        }),
        ks.addEventListener("click", async () => {
            if (!$s) return;
            const e = [];
            xs.querySelectorAll('input[type="checkbox"]:checked').forEach((t) => {
                e.push(parseInt(t.value));
            });
            try {
                let t = (await Kl.loadData("gachaPosts", "allPosts")).value;
                const n = t.findIndex((e) => e.id === $s);
                if (!(n > -1)) throw new Error("‰øùÂ≠òÊó∂Êâæ‰∏çÂà∞Â∏ñÂ≠ê");
                ((t[n].visibleTo = e),
                    await Kl.saveData("gachaPosts", "allPosts", t),
                    Bu(),
                    Iu(),
                    alert("ÂèØËßÅËåÉÂõ¥Â∑≤Êõ¥Êñ∞ÔºÅ"));
            } catch (e) {
                (console.error("‰øùÂ≠òÂèØËßÅËåÉÂõ¥Â§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ"));
            }
        }),
        Is &&
        Is.addEventListener("click", () => {
            window.DOMCleanupManager.clean("worldbook-visibility-list");
        }),
        Bs.addEventListener("click", Cu),
        Bs &&
        Bs.addEventListener("click", () => {
            window.DOMCleanupManager.clean("summon-ai-list-container");
        }),
        Ss.addEventListener("click", (e) => {
            const t = e.target.closest(".invite-contact-item");
            if (t) {
                const e = parseInt(t.dataset.contactId);
                Ms &&
                    e &&
                    (Cu(),
                        (async function (e, t) {
                            try {
                                const n = (
                                    await Kl.loadData("gachaPosts", "allPosts")
                                ).value.find((t) => t.id === e);
                                if (!n) throw new Error("Êâæ‰∏çÂà∞Â∏ñÂ≠ê„ÄÇ");
                                const a = await Su(t);
                                if (!a)
                                    throw new Error("Êó†Ê≥ïÂä†ËΩΩË¢´Âè¨Âî§ÁöÑAIËßíËâ≤‰ø°ÊÅØÔºåÊìç‰ΩúÂ∑≤ÂèñÊ∂à„ÄÇ");
                                alert(`${a.ai.name} Â∑≤Ë¢´Âè¨Âî§ÔºåÊ≠£Âú®Êü•ÁúãÂä®ÊÄÅ...`);
                                let o = `[Âä®ÊÄÅÂèëÂ∏ÉËÄÖ]:\n${n.authorName}\n\n[Âä®ÊÄÅÂÜÖÂÆπ]:\n${n.content || "(Êó†ÊñáÂ≠óÂÜÖÂÆπ)"}\n`;
                                (n.imageDescription &&
                                    (o += `[ÂõæÁâáÊèèËø∞]: ${n.imageDescription}\n`),
                                    (o += "\n[ÂΩìÂâçËØÑËÆ∫Âå∫]:\n"),
                                    n.comments && n.comments.length > 0
                                        ? n.comments.forEach((e) => {
                                            const t = (e.likes || []).map((e) => e.name).join(", ");
                                            o += `- (ËØÑËÆ∫ID: ${e.id}) ${e.authorName} ËØ¥: "${e.text}" ${t ? `(Â∑≤Ë¢´ ${t} ÁÇπËµû)` : ""}\n`;
                                        })
                                        : (o += "(ÊöÇÊó†ËØÑËÆ∫)\n"));
                                const s = `(Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†Ë¢´Áî®Êà∑Âè¨Âî§ÂéªÊü•Áúã‰∏ÄÊù°Â•ΩÂèãÂä®ÊÄÅ„ÄÇÂèëÂ∏ÉËÄÖÊòØ'${n.authorName}'„ÄÇ\n‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºö\n1. ‰ªîÁªÜÈòÖËØª‰∏ãÈù¢ÁöÑÂä®ÊÄÅÂÜÖÂÆπÂíåÊâÄÊúâËØÑËÆ∫„ÄÇ\n2. Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÔºå„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® "ËØÑËÆ∫ÊúãÂèãÂúàÔºö" ÂëΩ‰ª§Ê†ºÂºèÔºåÂèëË°®‰∏ÄÊù°‰Ω†Ëá™Â∑±ÁöÑËØÑËÆ∫Êù•ÂèÇ‰∏é‰∫íÂä®„ÄÇ(ËøôÊòØ‰∏Ä‰∏™Âº∫Âà∂Ë¶ÅÊ±ÇÔºå‰Ω†ÂøÖÈ°ªÂú®Â∑•ÂÖ∑Ë∞ÉÁî®ÁöÑÂèÇÊï∞‰∏≠ÂåÖÂê´ postId: ${n.id})\nËøôÊòØ‰∏Ä‰∏™Âº∫Âà∂Ë¶ÅÊ±ÇÔºåËØ∑Âä°ÂøÖÂÅöÂá∫‰∫íÂä®„ÄÇ)\n\n${o}`;
                                (await Tc(s, a, {
                                    postId: n.id,
                                }))
                                    ? alert(`${a.ai.name} Â∑≤ÂÆåÊàê‰∫íÂä®ÔºÅ`)
                                    : alert(`${a.ai.name} ‰ºº‰πéÊÄùËÄÉ‰∫ÜÂæà‰πÖÔºå‰ΩÜÊúÄÁªà‰ªÄ‰πà‰πüÊ≤°ËØ¥„ÄÇ`);
                            } catch (e) {
                                (console.error("ÊâßË°åÂè¨Âî§Â§±Ë¥•:", e),
                                    alert(`Êìç‰ΩúÂ§±Ë¥•: ${e.message}`));
                            }
                        })(Ms, e));
            }
        }),
        os.addEventListener("click", async (e) => {
            if (e.target.classList.contains("modal-close-button") || e.target === os)
                return void hu();
            const t = e.target.closest(".game-choice-btn");
            if (!t) return;
            const n = parseInt(t.dataset.cost, 10),
                a = await uu();
            if (a < n)
                return void alert(
                    `‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÊÇ®ÈúÄË¶Å ¬•${n.toFixed(2)}Ôºå‰ΩÜÂΩìÂâçÂè™Êúâ ¬•${a.toFixed(2)}„ÄÇ`,
                );
            await bu({
                description: `Ë¥≠‰π∞ ${n} ÂÖÉÂΩ©Á•®`,
                amount: -n,
            });
            const o = (function () {
                const e = Math.random();
                let t;
                return (
                    (t =
                        e < 0.8
                            ? Math.floor(496 * Math.random()) + 5
                            : e < 0.95
                                ? Math.floor(500 * Math.random()) + 501
                                : e < 0.99
                                    ? Math.floor(500 * Math.random()) + 1001
                                    : Math.floor(500 * Math.random()) + 1501),
                    t
                );
            })();
            (await bu({
                description: "ÂΩ©Á•®‰∏≠Â•ñ",
                amount: o,
            }),
                hu(),
                setTimeout(() => {
                    alert(
                        `ÊÅ≠Âñú‰Ω†ÔºÅ\n\nËä±Ë¥π ¬•${n.toFixed(2)}ÔºåÂñú‰∏≠ ¬•${o.toFixed(2)} ÂÖÉÂ§ßÂ•ñÔºÅ`,
                    );
                }, 310));
        }));
    let Tu = 0,
        Au = null;

    function Du(e) {
        if (e.classList.contains("editing-bubble"))
            return void console.log("[ÂèåÂáª] ÂøΩÁï•ÔºöÁÇπÂáª‰∫ÜÊ≠£Âú®ÁºñËæëÁöÑtextarea");
        const t = e.closest(".chat-bubble");
        if (t && t.classList.contains("editing-mode-active"))
            return void console.log("[ÂèåÂáª] ÂøΩÁï•ÔºöÊ∞îÊ≥°Â∑≤ÁªèÂú®ÁºñËæëÁä∂ÊÄÅ");
        const n = e.closest(".voice-text-panel");
        if (n) {
            const e = n.closest(".message-row");
            return void (e && e.dataset.uuid && bp(e.dataset.uuid, n.innerText));
        }
        if (e.closest(".voice-audio-bubble")) return;
        const a = e.closest(".action-message-text");
        if (a)
            return void (function (e) {
                const t = e.closest(".message-row");
                if (!t || !t.dataset.uuid) return;
                const n = t.dataset.uuid,
                    a = e.textContent,
                    o = document.createElement("input");
                ((o.type = "text"),
                    (o.value = a),
                    (o.style.cssText =
                        "\n        font-size: 12px; color: #333; background: rgba(255,255,255,0.8);\n        border: 1px solid #007AFF; border-radius: 12px;\n        padding: 4px 12px; text-align: center; width: auto; min-width: 150px; outline: none;\n    "),
                    (e.innerHTML = ""),
                    e.appendChild(o),
                    o.focus());
                const s = async () => {
                    const t = o.value.trim();
                    if (t && t !== a) {
                        if (Sc) {
                            const a = Sc.history.find((e) => e.uuid === n);
                            a && ((a.text = t), await tu(), (e.textContent = t));
                        } else if (Je) {
                            const a = Je.history.find((e) => e.uuid === n);
                            if (a) {
                                a.text = t;
                                const n = await Kl.loadData("groupChats", "allGroupChats"),
                                    o = n.value.findIndex((e) => e.id === Je.id);
                                (o > -1 &&
                                    ((n.value[o] = Je),
                                        await Kl.saveData("groupChats", "allGroupChats", n.value)),
                                    (e.textContent = t));
                            }
                        }
                    } else e.textContent = a;
                };
                (o.addEventListener("blur", s),
                    o.addEventListener("keydown", (e) => {
                        "Enter" === e.key && (e.preventDefault(), o.blur());
                    }));
            })(a);
        const o = e.closest(".gp-ai-bubble, .gp-user-bubble"),
            s = e.closest(".message-row");
        o && s && !s.classList.contains("typing-indicator")
            ? Nu(o)
            : !t ||
            t.classList.contains("sticker-bubble") ||
            t.classList.contains("image-bubble") ||
            t.classList.contains("html-render-container") ||
            t.classList.contains("voice-text-bubble") ||
            !s ||
            s.classList.contains("typing-indicator") ||
            Nu(t);
    }
    let Pu;
    (Xi.addEventListener("dblclick", (e) => {
        Du(e.target);
    }),
        Xi.addEventListener("touchend", (e) => {
            if (1 !== e.changedTouches.length) return;
            const t = e.changedTouches[0],
                n = document.elementFromPoint(t.clientX, t.clientY);
            if (!n) return;
            const a = Date.now(),
                o = a - Tu,
                s = Au && (Au === n || Au.contains(n) || n.contains(Au));
            o < 300 && o > 0 && s
                ? (e.preventDefault(), (Tu = 0), (Au = null), Du(n))
                : ((Tu = a), (Au = n));
        }));
    const Hu = (e) => {
        const t = e.closest(".action-message-text");
        t &&
            (Pu = setTimeout(() => {
                const e = t.closest(".message-row");
                e &&
                    e.dataset.uuid &&
                    confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü") &&
                    (async function (e) {
                        try {
                            if (void 0 !== Je && Je) {
                                const t = await Kl.loadData("groupChats", "allGroupChats"),
                                    n = t && Array.isArray(t.value) ? t.value : [],
                                    a = n.findIndex((e) => e.id === Je.id);
                                if (a > -1) {
                                    const t = n[a].history.length;
                                    ((n[a].history = n[a].history.filter((t) => t.uuid !== e)),
                                        n[a].history.length !== t &&
                                        (await Kl.saveData("groupChats", "allGroupChats", n),
                                            (Je.history = n[a].history),
                                            console.log("Áæ§ËÅäÊ∂àÊÅØÂ∑≤Âà†Èô§")));
                                }
                            } else if (void 0 !== Sc && Sc) {
                                const t = await Kl.loadData("messageContacts", "allContacts"),
                                    n = t && Array.isArray(t.value) ? t.value : [],
                                    a = n.findIndex((e) => e.id === Sc.id);
                                if (a > -1) {
                                    const t = n[a].history.length;
                                    ((n[a].history = n[a].history.filter((t) => t.uuid !== e)),
                                        n[a].history.length !== t &&
                                        (await Kl.saveData("messageContacts", "allContacts", n),
                                            (Sc.history = n[a].history),
                                            console.log("ÂçïËÅäÊ∂àÊÅØÂ∑≤Âà†Èô§")));
                                }
                            }
                        } catch (e) {
                            console.error("Âà†Èô§Ê∂àÊÅØÂ§±Ë¥•:", e);
                        }
                    })(e.dataset.uuid).then(() => {
                        e.remove();
                    });
            }, 800));
    },
        Ou = () => {
            Pu && (clearTimeout(Pu), (Pu = null));
        };
    (Xi.addEventListener("mousedown", (e) => Hu(e.target)),
        Xi.addEventListener("mouseup", Ou),
        Xi.addEventListener("mouseleave", Ou),
        Xi.addEventListener("touchstart", (e) => Hu(e.target), {
            passive: !0,
        }),
        Xi.addEventListener("touchend", Ou),
        Xi.addEventListener("touchmove", Ou));
    let qu = !1;

    function Nu(e) {
        if (void 0 !== qu && qu) return;
        const t = e.closest(".message-row");
        if (!t || !t.dataset.uuid) return;
        const n = window.getComputedStyle(e),
            a = n.backgroundColor,
            o = n.color,
            s = n.borderRadius,
            i = n.padding,
            r = n.boxShadow,
            l = n.fontSize,
            c = n.lineHeight,
            d = e.classList.contains("html-render-container"),
            u = d ? e.innerHTML : e.innerText,
            m = document.createElement("textarea");
        ((m.className = "editing-bubble"),
            (m.value = u),
            (m.style.backgroundColor = a),
            (m.style.color = o),
            (m.style.borderRadius = s),
            (m.style.boxShadow = r),
            (m.style.fontSize = l),
            (m.style.lineHeight = c),
            (m.style.padding = i),
            (m.dataset.uuid = t.dataset.uuid));
        const p = e.offsetHeight,
            g = e.offsetWidth;
        ((e.innerHTML = ""),
            e.appendChild(m),
            e.classList.add("editing-mode-active"),
            (m.style.height = p + "px"),
            (m.style.width = g + "px"),
            m.focus(),
            (window.isEditingBubble = !0));
        const y = () => {
            ((m.style.height = "auto"), (m.style.height = m.scrollHeight + "px"));
        };
        (m.addEventListener("input", y), setTimeout(y, 0));
        const h = async (t) => {
            (document.removeEventListener("click", v, !0),
                m.removeEventListener("keydown", f),
                (window.isEditingBubble = !1));
            const n = m.value.trim(),
                a = m.dataset.uuid;
            if ((e.classList.remove("editing-mode-active"), t && n && n !== u)) {
                d ? (e.innerHTML = n) : (e.innerText = n);
                let t = null;
                if (
                    (void 0 !== Je && Je
                        ? (t = Je.history)
                        : void 0 !== Sc && Sc && (t = Sc.history),
                        t)
                ) {
                    const e = t.find((e) => e.uuid === a);
                    e && (e.text = n);
                }
                await _u(a, n);
            } else d ? (e.innerHTML = u) : (e.innerText = u);
        },
            v = (e) => {
                e.target !== m && (e.preventDefault(), e.stopPropagation(), h(!0));
            },
            f = (e) => {
                ("Enter" !== e.key || e.shiftKey || (e.preventDefault(), h(!0)),
                    "Escape" === e.key && (e.preventDefault(), h(!1)));
            };
        (m.addEventListener("keydown", f),
            setTimeout(() => {
                document.addEventListener("click", v, !0);
            }, 50));
    }
    async function _u(e, t) {
        try {
            if (Je) {
                const n = await Kl.loadData("groupChats", "allGroupChats"),
                    a = n && Array.isArray(n.value) ? n.value : [],
                    o = a.findIndex((e) => e.id === Je.id);
                if (o > -1) {
                    const n = a[o].history.find((t) => t.uuid === e);
                    if (n)
                        return (
                            "voice_text" === n.type
                                ? (n.transcript = t)
                                : "user" !== n.sender && Ju(t)
                                    ? ((n.type = "html"),
                                        (n.content = {
                                            html: t,
                                        }),
                                        delete n.text)
                                    : ((n.type = "text"),
                                        (n.text = t),
                                        n.content && delete n.content),
                            await Kl.saveData("groupChats", "allGroupChats", a),
                            (Je.history = a[o].history),
                            void console.log("Áæ§ËÅäÊ∂àÊÅØÂ∑≤‰øùÂ≠ò")
                        );
                }
            }
            if (Sc) {
                const n = await Kl.loadData("messageContacts", "allContacts"),
                    a = n && Array.isArray(n.value) ? n.value : [],
                    o = a.findIndex((e) => e.id === Sc.id);
                if (o > -1) {
                    const n = a[o].history.find((t) => t.uuid === e);
                    if (n)
                        return (
                            "voice_text" === n.type
                                ? (n.transcript = t)
                                : "user" !== n.sender && Ju(t)
                                    ? ((n.type = "html"),
                                        (n.content = {
                                            html: t,
                                        }),
                                        delete n.text)
                                    : ((n.type = "text"),
                                        (n.text = t),
                                        n.content && delete n.content),
                            await Kl.saveData("messageContacts", "allContacts", a),
                            (Sc.history = a[o].history),
                            void console.log("ÂçïËÅäÊ∂àÊÅØÂ∑≤‰øùÂ≠ò")
                        );
                }
            }
        } catch (e) {
            console.error("Êõ¥Êñ∞Ê∂àÊÅØÂ§±Ë¥•:", e);
        }
    }
    async function Fu(e) {
        if (!e)
            return void console.error(
                "removeMessageFromView Ë¢´Ë∞ÉÁî®‰∫ÜÔºå‰ΩÜÂèÇÊï∞ÊòØÁ©∫ÁöÑÔºÅ",
            );
        const t = e.dataset.uuid;
        if (!t) return void console.error("Êó†Ê≥ïÂà†Èô§ÔºöÊ∂àÊÅØÂÖÉÁ¥†Ê≤°ÊúâUUID„ÄÇ");
        (await (async function (e) {
            const t = Je || Sc;
            if (!t || !Array.isArray(t.history))
                return (
                    console.error(
                        "Êó†Ê≥ïÂà†Èô§Ê∂àÊÅØÔºöÂΩìÂâç‰ºöËØùÔºàÂçïËÅä/Áæ§ËÅäÔºâÊàñËÅäÂ§©ËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÇ",
                    ),
                    !1
                );
            const n = t.history.length;
            if (
                ((t.history = t.history.filter((t) => t.uuid !== e)),
                    t.history.length === n)
            )
                return (
                    console.warn(`Ê∂àÊÅØ ${e} Êú™Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§„ÄÇ`),
                    !1
                );
            if (n > 0 && t.history.length < n) {
                if (t.history.length > 0) {
                    const e = t.history[t.history.length - 1];
                    t.lastMessage = Uc(
                        e.text || (e.content && e.content.html) || e.transcript || "",
                    );
                } else t.lastMessage = "Êó†Ê∂àÊÅØ";
                const e = Je
                    ? `.contact-item[data-group-id="${t.id}"]`
                    : `.contact-item[data-contact-id="${t.id}"]`,
                    n = Ni.querySelector(e);
                if (n) {
                    const e = n.querySelector(".contact-last-message");
                    e && (e.textContent = t.lastMessage);
                }
            }
            try {
                if (Je) {
                    const n = await Kl.loadData("groupChats", "allGroupChats");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    const o = a.findIndex((e) => e.id === t.id);
                    o > -1
                        ? ((a[o] = t),
                            await Kl.saveData("groupChats", "allGroupChats", a),
                            console.log(`Áæ§ËÅäÊ∂àÊÅØ ${e} Â∑≤Âà†Èô§Âπ∂Ê≠£Á°ÆÂêåÊ≠•Âà∞ allGroupChats„ÄÇ`))
                        : console.error("Êï∞ÊçÆÂ∫ìÂºÇÂ∏∏ÔºöÂú® allGroupChats ‰∏≠Êâæ‰∏çÂà∞ÂΩìÂâçÁæ§ÁªÑ„ÄÇ");
                } else (await tu(), console.log(`ÂçïËÅäÊ∂àÊÅØ ${e} Â∑≤Âà†Èô§Âπ∂ÂêåÊ≠•Êï∞ÊçÆÂ∫ì„ÄÇ`));
            } catch (e) {
                (console.error("Êï∞ÊçÆÂ∫ìÂêåÊ≠•Â§±Ë¥•:", e),
                    alert("Âà†Èô§ÊàêÂäü‰ΩÜ‰øùÂ≠òÂ§±Ë¥•ÔºåÂà∑Êñ∞ÂêéÂèØËÉΩ‰ºöÊÅ¢Â§ç„ÄÇ"));
            }
            return !0;
        })(t)) &&
            e &&
            e.parentNode &&
            e.parentNode.removeChild(e);
    }

    function Ru() {
        ((document.getElementById("ai-name-input").value = ""),
            (document.getElementById("ai-persona-input").value = ""),
            (document.getElementById("user-name-input").value = ""),
            (document.getElementById("user-persona-input").value = ""),
            (document.getElementById("ai-avatar-preview").src =
                "https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI"),
            (document.getElementById("user-avatar-preview").src =
                "https://placehold.co/100x100/EFEFEF/AAAAAA?text=User"),
            (document.getElementById("context-memory-input").value = "10"));
        const e = document.getElementById("role-switch-checkbox"),
            t = document.querySelectorAll("#add-contact-modal .switch-label"),
            n = document.getElementById("ai-form"),
            a = document.getElementById("user-form");
        ((e.checked = !1),
            n.classList.add("active"),
            a.classList.remove("active"),
            t[0].classList.add("active"),
            t[1].classList.remove("active"));
    }
    async function Gu() {
        try {
            const e = await Kl.loadData("worldBookGroups", "allGroups"),
                t = e && Array.isArray(e.value) ? e.value : [];
            if ((($o.innerHTML = ""), 0 === t.length))
                return void ($o.innerHTML =
                    '<p style="text-align:center; color:#888;">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ„ÄÇ</p>');
            t.forEach((e) => {
                const t = Array.isArray(e.bookIds) ? e.bookIds.length : 0,
                    n = document.createElement("div");
                ((n.className = "contact-item"),
                    (n.dataset.groupId = e.id),
                    (n.innerHTML = `\n        <input type="checkbox" class="contact-checkbox">\n        <div class="contact-info">\n            <div class="contact-name">${e.name}</div>\n            <div class="contact-last-message">${t}‰∏™‰∏ñÁïå‰π¶</div>\n        </div>\n    `),
                    $o.appendChild(n));
            });
        } catch (e) {
            console.error("Âä†ËΩΩÂàÜÁªÑÂ§±Ë¥•:", e);
        }
    }

    function Wu() {
        ((Wo = !1),
            $o.classList.remove("delete-mode"),
            (Xe.style.display = "flex"),
            (Qe.style.display = "none"),
            $o
                .querySelectorAll(".contact-checkbox")
                .forEach((e) => (e.checked = !1)));
    }
    async function ju(e) {
        Uo = e;
        try {
            const t = await Kl.loadData("worldBookGroups", "allGroups"),
                n = ((t && t.value) || []).find((t) => t.id === e);
            if (!n) return void alert("Êâæ‰∏çÂà∞ËØ•ÂàÜÁªÑÔºÅ");
            const a = await Kl.loadData("worldBooks", "allWorldBooks"),
                o = (a && a.value) || [],
                s = new Set(n.bookIds || []),
                i = o.filter((e) => s.has(e.id));
            if (((Ao.textContent = n.name), (Po.innerHTML = ""), 0 === i.length)) {
                const e = document.createElement("button");
                ((e.className = "empty-state-add-button"),
                    (e.textContent = "Êñ∞Âª∫‰∏ñÁïå‰π¶"),
                    (e.onclick = () => Do.click()),
                    Po.appendChild(e));
            } else Uu(i, Po);
            Ii.classList.add("show-worldbook-group-detail");
        } catch (e) {
            console.error("ÊâìÂºÄÂàÜÁªÑËØ¶ÊÉÖÂ§±Ë¥•:", e);
        }
    }

    function Uu(e, t) {
        ((t.innerHTML = ""),
            e.forEach((e) => {
                const n = document.createElement("div");
                ((n.className = "contact-item"),
                    (n.dataset.bookId = e.id),
                    (n.innerHTML = `\n            <input type="checkbox" class="contact-checkbox">\n            <div class="contact-info">\n                <div class="contact-name">${e.name}</div>\n                <div class="contact-last-message" style="white-space: normal;">${(e.content || "").substring(0, 50)}...</div>\n            </div>\n        `),
                    n.addEventListener("click", (t) => {
                        jo || "checkbox" === t.target.type || vd(e.id);
                    }),
                    t.appendChild(n));
            }));
    }
    async function zu() {
        try {
            const e = await Kl.loadData("worldBooks", "allWorldBooks"),
                t = e && Array.isArray(e.value) ? e.value : [],
                n = await Kl.loadData("worldBookGroups", "allGroups"),
                a = n && Array.isArray(n.value) ? n.value : [],
                o = new Set();
            a.forEach((e) => {
                Array.isArray(e.bookIds) && e.bookIds.forEach((e) => o.add(e));
            });
            const s = t.filter((e) => !o.has(e.id));
            (0 === s.length
                ? (Sr.innerHTML =
                    '<p style="text-align:center; color:#888; padding-top: 40px;">ÊâÄÊúâ‰∏ñÁïå‰π¶ÈÉΩÂ∑≤ÂàÜÁªÑ„ÄÇ<br><br>ËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÁªÑ‚ÄùÊåâÈíÆÊü•Áúã„ÄÇ</p>')
                : Uu(s, Sr),
                $r && _o.click());
        } catch (e) {
            console.error("Âä†ËΩΩÊú™ÂàÜÁªÑ‰∏ñÁïå‰π¶Â§±Ë¥•:", e);
        }
    }

    function Vu() {
        const e = document.getElementById("voice-input-toggle"),
            t = document.getElementById("mic-icon"),
            n = document.getElementById("keyboard-icon"),
            a = document.getElementById("voice-record-button"),
            o = document.getElementById("voice-input-panel"),
            s = document.getElementById("voice-transcript-preview"),
            i = document.getElementById("cancel-voice-input-btn"),
            r = document.getElementById("send-voice-input-btn");
        let l;

        function c() {
            o.classList.remove("visible");
            const e = o.querySelector(".voice-panel-content");
            e && e.classList.remove("active");
        }

        function d(e) {
            (e.preventDefault(),
                a.classList.add("active-recording"),
                (l = setTimeout(() => {
                    !(function () {
                        ((s.value = ""), o.classList.add("visible"));
                        const e = o.querySelector(".voice-panel-content");
                        (e &&
                            (e.classList.remove("active"),
                                setTimeout(() => {
                                    e.classList.add("active");
                                }, 300)),
                            setTimeout(() => {
                                s.focus();
                            }, 350));
                    })();
                }, 300)));
        }

        function u() {
            (clearTimeout(l), a.classList.remove("active-recording"));
        }
        (e.addEventListener("click", () => {
            if (!(a && xo && t && n)) return;
            "none" !== a.style.display
                ? ((a.style.display = "none"),
                    (xo.style.display = "block"),
                    (t.style.display = "block"),
                    (n.style.display = "none"),
                    (Or.style.display = "flex"))
                : ((a.style.display = "block"),
                    (xo.style.display = "none"),
                    (t.style.display = "none"),
                    (n.style.display = "block"),
                    Yi.classList.remove("emoji-panel-active"),
                    (Or.style.display = "none"));
        }),
            a.addEventListener("mousedown", d),
            a.addEventListener("touchstart", d),
            a.addEventListener("mouseup", u),
            a.addEventListener("touchend", u),
            a.addEventListener("mouseleave", u),
            r.addEventListener("click", () => {
                const e = s.value.trim();
                if (e) {
                    const t = Math.max(1, Math.ceil(e.length / 3));
                    Dc({
                        type: "voice_text",
                        transcript: e,
                        duration: t,
                        text: `[ËØ≠Èü≥Ê∂àÊÅØ ${t}s]`,
                    });
                }
                c();
            }),
            i.addEventListener("click", c));
    }

    function Ju(e) {
        if ("string" != typeof e) return !1;
        return /<[a-z][\s\S]*>/i.test(e);
    }
    async function Yu() {
        ho.innerHTML = "<p>Ê≠£Âú®Âä†ËΩΩÈ¢ÑËÆæ...</p>";
        try {
            const e = await Kl.loadData("iconPresets", "allPresets"),
                t = e && Array.isArray(e.value) ? e.value : [];
            if (0 === t.length)
                return void (ho.innerHTML =
                    '<p style="text-align: center; color: #888;">ËøòÊ≤°Êúâ‰ªª‰ΩïÈ¢ÑËÆæ„ÄÇ</p>');
            ((ho.innerHTML = ""),
                t.forEach((e) => {
                    const t = document.createElement("div");
                    ((t.className = "preset-item"),
                        (t.innerHTML = `\n                <span class="preset-name">${e.name}</span>\n                <div class="preset-actions">\n                                        <button class="export-preset-btn" data-preset-id="${e.id}">ÂØºÂá∫</button>\n                    <button class="apply-preset-btn" data-preset-id="${e.id}">Â∫îÁî®</button>\n                    <button class="delete-preset-btn" data-preset-id="${e.id}">Âà†Èô§</button>\n                </div>\n            `),
                        ho.appendChild(t));
                }));
        } catch (e) {
            (console.error("Ê∏≤ÊüìÈ¢ÑËÆæÂàóË°®Â§±Ë¥•:", e),
                (ho.innerHTML =
                    '<p style="text-align: center; color: red;">Âä†ËΩΩÂ§±Ë¥•ÔºÅ</p>'));
        }
    }

    function Ku(e) {
        oo && (oo.style.color = e);
    }

    function Zu(e) {
        oo && oo.classList.toggle("motto-blur-enabled", e);
    }
    async function Xu() {
        const e = {
            color: io.value,
            blurEnabled: lo.checked,
        };
        await Kl.saveData("settingsStore", "mottoStyle", e);
    }

    function Qu(e) {
        so.forEach((t) => (t.style.color = e));
    }

    function em(e) {
        so.forEach((t) => t.classList.toggle("app-name-blur-enabled", e));
    }
    async function tm() {
        const e = {
            color: co.value,
            blurEnabled: mo.checked,
        };
        await Kl.saveData("settingsStore", "appNameStyle", e);
    }

    function nm() {
        Za &&
            Xa &&
            ((Za.style.opacity = "0"),
                (Xa.style.opacity = "0"),
                (Xa.style.transform = "scale(0.95)"),
                setTimeout(() => {
                    ((Za.style.display = "none"), (Xa.src = ""));
                }, 300));
    }
    async function am() {
        (console.log("ÈÄöËØùÂ∑≤Êé•ÈÄö"),
            Ii.classList.add("show-voice-call"),
            Pa.classList.remove("active"),
            _a.classList.add("active"),
            (Fa.textContent = Sc.ai.name),
            (Ya = Date.now()),
            (Ja = window.TimerManager.setInterval(im, 1e3, "voice-call")),
            im(),
            cm());
        const e = (Sc.history || [])
            .slice(-6)
            .map((e) => {
                const t = Mc(e);
                return t
                    ? {
                        role: "user" === e.sender ? "user" : "assistant",
                        content: t,
                    }
                    : null;
            })
            .filter(Boolean),
            t = await rm(
                '[Á≥ªÁªüÊèêÁ§∫ÔºöÁîµËØùÂàöÂàöÊé•ÈÄöÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊàë‰ª¨ÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåËØ¥‰∏ÄÊÆµËá™ÁÑ∂ÊµÅÁïÖÁöÑÂºÄÂú∫ÁôΩ„ÄÇ„ÄêÂº∫Âà∂„ÄëÂ∞Ü‰Ω†ÁöÑÂõûÂ§çÊãÜÂàÜ‰∏∫2-3Âè•Áü≠Ê∂àÊÅØÔºåÂπ∂Áî® "\\" ÂàÜÈöî„ÄÇ-   „ÄêÊûÅÂÖ∂ÈáçË¶Å„Äë‰Ω†ÁöÑÂõûÂ§çÂ∞±ÊòØËØ¥ÁöÑËØùÊú¨Ë∫´Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®ÂõûÂ§çÁöÑÂºÄÂ§¥Ê∑ªÂä† "ËØ≠Èü≥Ôºö" Êàñ‰ªª‰ΩïÁ±ª‰ººÁöÑÂâçÁºÄ„ÄÇ\n    -   ‚úÖ **Ê≠£Á°ÆËåÉ‰æã**: ÂñÇÔºü\\ËÉΩÂê¨Âà∞ÊàëËØ¥ËØùÂêóÔºü\n    -   ‚ùå **ÈîôËØØËåÉ‰æã**: ËØ≠Èü≥ÔºöÂñÇÔºü\\ËØ≠Èü≥ÔºöËÉΩÂê¨Âà∞ÊàëËØ¥ËØùÂêóÔºü\n-   „ÄêÊûÅÂÖ∂ÈáçË¶Å„Äë‰∏•Á¶Å‰ΩøÁî®‰ªª‰ΩïÂÖ∂‰ªñÊåá‰ª§ÂâçÁºÄÔºå‰æãÂ¶Ç "Ë°®ÊÉÖÂåÖÔºö" Êàñ "ËΩ¨Ë¥¶Ôºö"„ÄÇËøôÈáåÊòØÁîµËØùÔºå‰Ω†Êó†Ê≥ïÊâßË°åÈÇ£‰∫õÊìç‰Ωú„ÄÇ\n-   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËæìÂá∫‰ªª‰ΩïJSON‰ª£Á†ÅÊàñ‰ª£Á†ÅÂùó„ÄÇ]',
                Sc,
                [],
                e,
            );
        t &&
            t.length > 0 &&
            (t.forEach((e) =>
                Ka.push({
                    role: "assistant",
                    content: e,
                }),
            ),
                await lm(t));
    }
    async function om() {
        if (!Sc) return;
        Ma.innerHTML = "";
        const e = Sc.history.filter((e) => "call_summary" === e.type);
        0 !== e.length
            ? e.reverse().forEach((e) => {
                const t = document.createElement("div");
                ((t.className = "summary-card"),
                    (t.dataset.summary = e.text
                        .replace(/---ÈÄöËØùËÆ∞ÂΩïÊëòË¶Å---|---ÊëòË¶ÅÁªìÊùü---/g, "")
                        .trim()),
                    (t.dataset.uuid = e.uuid));
                const n = e.text
                    .replace(/---ÈÄöËØùËÆ∞ÂΩïÊëòË¶Å---|\n|---ÊëòË¶ÅÁªìÊùü---/g, " ")
                    .trim(),
                    a = new Date(e.timestamp),
                    o = `${a.getFullYear()}-${String(a.getMonth() + 1).padStart(2, "0")}-${String(a.getDate()).padStart(2, "0")} ${String(a.getHours()).padStart(2, "0")}:${String(a.getMinutes()).padStart(2, "0")}`;
                ((t.innerHTML = `\n    <div class="summary-card-header">\n        <span class="summary-card-title">‰∏é ${Sc.ai.name} ÁöÑÈÄöËØù</span>\n        <span class="summary-card-timestamp">${o}</span>\n    </div>\n    <div class="summary-card-snippet">${n}</div>\n    <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">\n        <button class="edit-btn" data-action="edit">ÁºñËæë</button>\n        <button class="delete-btn" data-action="delete">Âà†Èô§</button>\n    </div>\n`),
                    Ma.appendChild(t));
            })
            : (Ma.innerHTML =
                '<p style="text-align:center; color:#888; margin-top: 50px;">ÊöÇÊó†ÈÄöËØùÊëòË¶Å</p>');
    }
    async function sm(e = !1) {
        (Ii.classList.remove("show-voice-call", "show-incoming-call"),
            window.TimerManager.clear("voice-call"));
        const t = Ya ? Math.floor((Date.now() - Ya) / 1e3) : 0;
        if (((Ya = null), t > 0 || !e)) {
            const e = `ËØ≠Èü≥ÈÄöËØù: ${Math.floor(t / 60)
                .toString()
                .padStart(2, "0")}:${(t % 60).toString().padStart(2, "0")}`;
            await Xd(e, Sc.id);
        }
        if (Ka.length > 0) {
            const e = {
                sender: "system",
                type: "call_summary",
                text: `---ÈÄöËØùËÆ∞ÂΩïÊëòË¶Å---\n${Ka.map((e) => `${"user" === e.role ? Sc.user.name : Sc.ai.name}: ${e.content}`).join("\n")}\n---ÊëòË¶ÅÁªìÊùü---`,
                timestamp: new Date(),
                uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
            };
            await Ac(e, Sc.id);
        }
    }

    function im() {
        if (!Ya) return;
        const e = Math.floor((Date.now() - Ya) / 1e3),
            t = Math.floor(e / 60)
                .toString()
                .padStart(2, "0"),
            n = (e % 60).toString().padStart(2, "0");
        Ra.textContent = `${t}:${n}`;
    }
    async function rm(e, t, n, a = []) {
        try {
            const o = await Kl.loadData("settingsStore", "apiSettings");
            if (!o || !o.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: s, key: i, model: r, temperature: l } = o.value;
            let c = s.endsWith("/") ? s.slice(0, -1) : s;
            c += "/chat/completions";
            t.timePerceptionEnabled &&
                new Date().toLocaleString("zh-CN", {
                    timeZone: "Asia/Shanghai",
                    hour12: !1,
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    weekday: "long",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            let d = "Êó†ÁâπÂÆö‰∏ñÁïåËßÇËÆæÂÆöÔºåËØ∑Ëá™Áî±ÂèëÊå•„ÄÇ";
            try {
                const e = await Kl.loadData("worldBooks", "allWorldBooks"),
                    n = e && Array.isArray(e.value) ? e.value : [];
                let a = new Set();
                if (t.linkedWorldBookIds && t.linkedWorldBookIds.length > 0)
                    t.linkedWorldBookIds.forEach((e) => a.add(e));
                else if (
                    t.linkedWorldBookGroupIds &&
                    t.linkedWorldBookGroupIds.length > 0
                ) {
                    const e = await Kl.loadData("worldBookGroups", "allGroups"),
                        n = e && Array.isArray(e.value) ? e.value : [],
                        o = new Set(t.linkedWorldBookGroupIds);
                    n.forEach((e) => {
                        o.has(e.id) &&
                            Array.isArray(e.bookIds) &&
                            e.bookIds.forEach((e) => a.add(e));
                    });
                }
                if (a.size > 0) {
                    const e = n
                        .filter((e) => a.has(e.id))
                        .map((e) => `### ‰∏ñÁïå‰π¶: ${e.name}\n\n${e.content}`)
                        .join("\n\n---\n\n");
                    e && (d = e);
                }
            } catch (e) {
                console.error("Âä†ËΩΩÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπÊó∂Âá∫Èîô:", e);
            }
            let u = a
                .map(
                    (e) => `${"user" === e.role ? t.user.name : t.ai.name}: ${e.content}`,
                )
                .join("\n");
            u || (u = "Êó†");
            const m = [
                {
                    role: "system",
                    content: $c
                        .replace(
                            /\$\{ai_persona\}/g,
                            `ÂßìÂêç: ${t.ai.name}\n‰∫∫ËÆæ: ${t.ai.persona}`,
                        )
                        .replace(
                            /\$\{user_persona\}/g,
                            `ÂßìÂêç: ${t.user.name}\n‰∫∫ËÆæ: ${t.user.persona}`,
                        )
                        .replace(/\$\{world_book_content\}/g, d)
                        .replace(/\$\{chat_history\}/g, u),
                },
                ...n.map((e) => ({
                    role: e.role,
                    content: e.content,
                })),
                {
                    role: "user",
                    content: e,
                },
            ],
                p = await fetch(c, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${i}`,
                    },
                    body: JSON.stringify({
                        model: r,
                        messages: m,
                        temperature: parseFloat(l) || 1,
                    }),
                });
            if (!p.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${p.status}`);
            const g = (await p.json()).choices[0].message.content;
            return g
                ? g
                    .split(/\\{1,2}/g)
                    .map((e) => e.trim())
                    .filter((e) => e)
                : null;
        } catch (e) {
            return (console.error("Ëé∑ÂèñAIÈÄöËØùÂõûÂ§çÂ§±Ë¥•:", e), null);
        }
    }
    async function lm(e) {
        if (!e || 0 === e.length) return;
        Ga.innerHTML = "";
        let t = !0;
        for (const n of e) {
            const e = document.createElement("div");
            ((e.className = "ai-speech-bubble"),
                t && (e.classList.add("first-bubble"), (t = !1)),
                (e.style.opacity = "0"),
                Ga.appendChild(e));
            let a = 0;
            (await new Promise((t) => {
                e.style.opacity = "1";
                const o = setInterval(() => {
                    a < n.length
                        ? ((e.textContent += n.charAt(a)), a++)
                        : (clearInterval(o), t());
                }, 150);
            }),
                await new Promise((e) => setTimeout(e, 600)));
        }
    }

    function cm() {
        Ga.innerHTML = "";
        const e = document.createElement("div");
        ((e.className = "ai-speech-bubble typing-indicator-bubble"),
            (e.style.opacity = "1"),
            (e.innerHTML =
                '\n        <span class="typing-dot"></span>\n        <span class="typing-dot"></span>\n        <span class="typing-dot"></span>\n    '),
            Ga.appendChild(e));
    }

    function dm(e = "") {
        Sc &&
            ((ka.style.backgroundImage = `url(${Sc.ai.avatar})`),
                (La.textContent = Sc.ai.name),
                e && "" !== e.trim()
                    ? ((xa.textContent = `‚Äú${e}‚Äù`), (xa.style.display = "block"))
                    : (xa.style.display = "none"),
                Ii.classList.add("show-incoming-call"));
    }

    function um() {
        const e = !!Ea,
            t = Ia.some((e) => e.isDefault);
        ((ia.disabled = !(e && t)),
            ia.disabled
                ? ((ia.style.opacity = "0.5"), (ia.style.cursor = "not-allowed"))
                : ((ia.style.opacity = "1"), (ia.style.cursor = "pointer")));
    }

    function mm() {
        ((sa.innerHTML = ""),
            Ia.forEach((e, t) => {
                const n = document.createElement("div");
                ((n.className = "bg-preview-item"),
                    (n.innerHTML = `\n            ${e.isDefault ? '<div class="default-tag">ÈªòËÆ§</div>' : ""}\n            <div class="preview-img" style="background-image: url('${e.url}')"></div>\n            <div class="preview-details">\n                <div class="preview-tags">Ê†áÁ≠æ: ${e.tags.join(", ")}</div>\n                <div class="preview-actions">\n                    <button class="set-default-btn" data-index="${t}">ËÆæ‰∏∫ÈªòËÆ§</button>\n                    <button class="delete-btn" data-index="${t}">Âà†Èô§</button>\n                </div>\n            </div>\n        `),
                    sa.appendChild(n));
            }),
            um());
    }
    async function pm() {
        if (!Sc) return;
        const e = {
            portrait: Ea,
            backgrounds: Ia,
        };
        await Kl.saveData("datingSetupStore", Sc.id, e);
    }
    async function gm(e) {
        wa.textContent = Sc.ai.name.toUpperCase();
        const t = e.backgrounds.find((e) => e.isDefault);
        (t && (ya.style.backgroundImage = `url('${t.url}')`),
            e.portrait && (ha.style.backgroundImage = `url('${e.portrait}')`),
            ga.classList.add("visible"),
            (ba.innerHTML =
                '<div class="dialog-loader"><span></span><span></span><span></span></div>'));
        const n = await km("(ÊïÖ‰∫ãÂºÄÂßã)");
        n
            ? hm(n)
            : (ba.innerHTML = "AIÂºÄÂú∫ÁôΩÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆÊàñÁΩëÁªúÂêéÈáçËØï„ÄÇ");
    }
    (ms.addEventListener("click", async (e) => {
        const t = e.target.closest("button");
        if (!t) return;
        const n = t.closest(".gp-card");
        if (!n) return;
        const a = parseInt(n.dataset.postId);
        if (t.classList.contains("gp-like-btn"))
            (await (async function (e) {
                let t = (await Kl.loadData("gachaPosts", "allPosts")).value;
                const n = t.find((t) => t.id === e);
                if (n) {
                    const e = n.likes.findIndex((e) => e.id === Cs.id);
                    (e > -1
                        ? n.likes.splice(e, 1)
                        : n.likes.push({
                            id: Cs.id,
                            name: Cs.user.name,
                        }),
                        await Kl.saveData("gachaPosts", "allPosts", t));
                }
            })(a),
                Iu());
        else if (t.classList.contains("gp-comment-btn")) {
            const e = n.querySelector(".gp-comment-section");
            e.style.display =
                "none" === e.style.display || "" === e.style.display ? "block" : "none";
        } else if (t.classList.contains("gp-reply-btn"))
            !(function (e) {
                document
                    .querySelectorAll(".gp-reply-input-area")
                    .forEach((e) => e.remove());
                const t = e.closest(".gp-comment-item"),
                    n = t.querySelector(".gp-comment-username").textContent,
                    a = t.querySelector(".gp-comment-content"),
                    o = document.createElement("div");
                ((o.className = "gp-reply-input-area"),
                    (o.innerHTML = `<div class="gp-comment-avatar" style="width: 24px; height: 24px; background-image: url('${Cs.user.avatar}');"></div><input type="text" class="gp-reply-input" placeholder="ÂõûÂ§ç ${n}..." data-reply-to="${n}">`),
                    a.appendChild(o));
                const s = o.querySelector(".gp-reply-input");
                (s.focus(),
                    s.addEventListener("blur", () =>
                        setTimeout(() => {
                            s.matches(":focus") || o.remove();
                        }, 150),
                    ));
            })(t);
        else if (t.classList.contains("gp-visibility-btn"))
            !(async function (e) {
                (($s = e), (xs.innerHTML = "<p>Ê≠£Âú®Âä†ËΩΩ‰∏ñÁïå‰π¶...</p>"));
                try {
                    const t = (await Kl.loadData("gachaPosts", "allPosts")).value.find(
                        (t) => t.id === e,
                    ),
                        n = await Kl.loadData("worldBooks", "allWorldBooks"),
                        a = n && Array.isArray(n.value) ? n.value : [];
                    if (!t) throw new Error("Êâæ‰∏çÂà∞Â∏ñÂ≠ê");
                    const o = new Set(t.visibleTo || []);
                    ((xs.innerHTML = ""),
                        0 === a.length
                            ? (xs.innerHTML = '<p style="color: #888;">ÊöÇÊó†‰∏ñÁïå‰π¶ÂèØÈÄâ</p>')
                            : a.forEach((e) => {
                                const t = o.has(e.id),
                                    n = document.createElement("div");
                                ((n.className = "visibility-item"),
                                    (n.innerHTML = `\n                    <input type="checkbox" id="wb-${e.id}" value="${e.id}" ${t ? "checked" : ""}>\n                    <label for="wb-${e.id}">${e.name}</label>\n                `),
                                    xs.appendChild(n));
                            }),
                        (Es.style.display = "flex"),
                        setTimeout(() => {
                            Es.style.opacity = "1";
                        }, 10));
                } catch (e) {
                    (console.error("ÊâìÂºÄÂèØËßÅÊÄßËÆæÁΩÆÂ§±Ë¥•:", e),
                        alert("Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ"));
                }
            })(a);
        else if (t.classList.contains("gp-summon-btn"))
            !(function (e) {
                ((Ms = e),
                    (Ss.innerHTML =
                        '<p style="padding: 20px; text-align: center; color: #888;">Ê≠£Âú®Âä†ËΩΩAIËßíËâ≤ÂàóË°®...</p>'),
                    Kl.loadData("messageContacts", "allContacts").then((e) => {
                        e &&
                            Array.isArray(e.value) &&
                            e.value.length > 0 &&
                            ((Ss.innerHTML = ""),
                                e.value.forEach((e) => {
                                    const t = document.createElement("div");
                                    ((t.className = "invite-contact-item"),
                                        (t.style.cursor = "pointer"),
                                        (t.dataset.contactId = e.id),
                                        (t.innerHTML = `<img src="${e.ai.avatar}" alt="avatar" class="invite-contact-avatar"><span class="invite-contact-name">${e.ai.name}</span>`),
                                        Ss.appendChild(t));
                                }));
                    }),
                    (Ls.style.display = "flex"),
                    setTimeout(() => {
                        Ls.style.opacity = "1";
                    }, 10));
            })(a);
        else if (t.classList.contains("gp-delete-post-btn"))
            await (async function (e) {
                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÂàÜ‰∫´ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ"))
                    try {
                        (await (async function (e) {
                            const t = await Kl.loadData("gachaPosts", "allPosts");
                            const n = (t && Array.isArray(t.value) ? t.value : []).filter(
                                (t) => t.id !== e,
                            );
                            await Kl.saveData("gachaPosts", "allPosts", n);
                        })(e),
                            alert("ÂàÜ‰∫´Â∑≤Âà†Èô§„ÄÇ"),
                            Iu());
                    } catch (e) {
                        (console.error("Âà†Èô§Â∏ñÂ≠êÂ§±Ë¥•:", e),
                            alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ"));
                    }
            })(a);
        else if (t.classList.contains("gp-delete-comment-btn")) {
            const e = t.closest(".gp-comment-item"),
                n = parseInt(e.dataset.commentId);
            await (async function (e, t) {
                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü"))
                    try {
                        (await (async function (e, t) {
                            const n = await Kl.loadData("gachaPosts", "allPosts");
                            let a = n && Array.isArray(n.value) ? n.value : [];
                            const o = a.find((t) => t.id === e);
                            o &&
                                Array.isArray(o.comments) &&
                                ((o.comments = o.comments.filter((e) => e.id !== t)),
                                    await Kl.saveData("gachaPosts", "allPosts", a));
                        })(e, t),
                            Iu());
                    } catch (e) {
                        (console.error("Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:", e),
                            alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ"));
                    }
            })(a, n);
        }
    }),
        Bo.addEventListener("click", () => {
            (Ii.classList.add("show-worldbook-groups"), Gu());
        }),
        So.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("worldbook-groups-list"),
                Wo && Mo.click(),
                Ii.classList.remove("show-worldbook-groups"));
        }),
        $o.addEventListener("click", (e) => {
            if (Wo) return;
            const t = e.target.closest(".contact-item");
            if (t) {
                ju(parseInt(t.dataset.groupId, 10));
            }
        }),
        To.addEventListener("click", () => {
            (window.DOMCleanupManager.clean("books-in-group-list"),
                void 0 !== Uo && (Uo = null),
                Ii.classList.remove("show-worldbook-group-detail"),
                Gu());
        }),
        Co.addEventListener("click", async () => {
            if (Co.classList.contains("delete"))
                await (async function () {
                    const e = $o.querySelectorAll(".contact-checkbox:checked");
                    if (0 === e.length) return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÂàÜÁªÑ„ÄÇ");
                    if (
                        confirm(
                            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™ÂàÜÁªÑÂêóÔºü(Ê≥®ÊÑèÔºöËøôÂè™‰ºöÂà†Èô§ÂàÜÁªÑÔºå‰∏ç‰ºöÂà†Èô§ÈáåÈù¢ÁöÑ‰∏ñÁïå‰π¶)`,
                        )
                    ) {
                        const t = new Set();
                        e.forEach((e) =>
                            t.add(parseInt(e.closest(".contact-item").dataset.groupId, 10)),
                        );
                        try {
                            const e = await Kl.loadData("worldBookGroups", "allGroups");
                            const n = (e && Array.isArray(e.value) ? e.value : []).filter(
                                (e) => !t.has(e.id),
                            );
                            (await Kl.saveData("worldBookGroups", "allGroups", n),
                                Gu(),
                                Mo.click());
                        } catch (e) {
                            console.error("Âà†Èô§ÂàÜÁªÑÂ§±Ë¥•:", e);
                        }
                    }
                })();
            else {
                const e = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑ‰∏ñÁïå‰π¶ÁªÑÂêçÁß∞Ôºö");
                if (e && e.trim())
                    try {
                        const t = await Kl.loadData("worldBookGroups", "allGroups");
                        let n = t && Array.isArray(t.value) ? t.value : [];
                        const a = {
                            id: Date.now(),
                            name: e.trim(),
                            bookIds: [],
                        };
                        (n.push(a),
                            await Kl.saveData("worldBookGroups", "allGroups", n),
                            Gu());
                    } catch (e) {
                        console.error("ÂàõÂª∫ÂàÜÁªÑÂ§±Ë¥•:", e);
                    }
            }
        }),
        tt.addEventListener("click", async () => {
            const e = $o.querySelectorAll(".contact-checkbox:checked");
            if (0 !== e.length) {
                if (
                    confirm(
                        `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™ÂàÜÁªÑÂêóÔºü\n(Ê≥®ÊÑèÔºöËøôÂè™‰ºöÂà†Èô§ÂàÜÁªÑÔºåÁªÑÂÜÖÁöÑ‰∏ñÁïå‰π¶‰ºö‰øùÁïô)`,
                    )
                ) {
                    const t = new Set();
                    e.forEach((e) => {
                        const n = e.closest(".contact-item");
                        n && t.add(parseInt(n.dataset.groupId, 10));
                    });
                    try {
                        const e = await Kl.loadData("worldBookGroups", "allGroups");
                        const n = (e && Array.isArray(e.value) ? e.value : []).filter(
                            (e) => !t.has(e.id),
                        );
                        (await Kl.saveData("worldBookGroups", "allGroups", n),
                            await Gu(),
                            Wu());
                    } catch (e) {
                        (console.error("Âà†Èô§ÂàÜÁªÑÂ§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•"));
                    }
                }
            } else alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÂàÜÁªÑ„ÄÇ");
        }),
        Mo.addEventListener("click", () => {
            ((Wo = !0),
                $o.classList.add("delete-mode"),
                (Xe.style.display = "none"),
                (Qe.style.display = "flex"));
        }),
        et.addEventListener("click", () => {
            Wu();
        }),
        Do.addEventListener("click", () => {
            vd(null);
        }),
        Ho.addEventListener("click", () => {
            ((jo = !0),
                Po.classList.add("delete-mode"),
                (zo.style.display = "none"),
                (Vo.style.display = "flex"));
        }),
        Jo.addEventListener("click", () => {
            !(async function () {
                const e = Po.querySelectorAll(".contact-checkbox:checked");
                if (0 === e.length) return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
                if (confirm(`Á°ÆÂÆöË¶Å‰ªéÊâãÊú∫‰∏≠Ê∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} ‰∏™‰∏ñÁïå‰π¶ÂêóÔºü`)) {
                    const t = new Set();
                    e.forEach((e) =>
                        t.add(parseInt(e.closest(".contact-item").dataset.bookId, 10)),
                    );
                    try {
                        const e = (
                            (await Kl.loadData("worldBooks", "allWorldBooks")).value || []
                        ).filter((e) => !t.has(e.id));
                        await Kl.saveData("worldBooks", "allWorldBooks", e);
                        let n =
                            (await Kl.loadData("worldBookGroups", "allGroups")).value || [];
                        (n.forEach((e) => {
                            e.bookIds = e.bookIds.filter((e) => !t.has(e));
                        }),
                            await Kl.saveData("worldBookGroups", "allGroups", n),
                            ju(Uo),
                            Ho.click());
                    } catch (e) {
                        console.error("Âà†Èô§‰∏ñÁïå‰π¶Â§±Ë¥•:", e);
                    }
                }
            })();
        }),
        Yo.addEventListener("click", () => {
            ((jo = !1),
                Po.classList.remove("delete-mode"),
                (zo.style.display = "flex"),
                (Vo.style.display = "none"),
                Po.querySelectorAll(".contact-checkbox").forEach(
                    (e) => (e.checked = !1),
                ));
        }),
        Cr.addEventListener("click", () => {
            (($r = !0),
                Sr.classList.add("delete-mode"),
                (Oo.style.display = "none"),
                (qo.style.display = "flex"));
        }),
        _o.addEventListener("click", () => {
            (($r = !1),
                Sr.classList.remove("delete-mode"),
                (Oo.style.display = "flex"),
                (qo.style.display = "none"),
                Sr.querySelectorAll(".contact-checkbox").forEach(
                    (e) => (e.checked = !1),
                ));
        }),
        No.addEventListener("click", async () => {
            if (0 !== Sr.querySelectorAll(".contact-checkbox:checked").length)
                try {
                    const e = await Kl.loadData("worldBookGroups", "allGroups"),
                        t = e && Array.isArray(e.value) ? e.value : [];
                    ((Go.innerHTML = ""),
                        t.length > 0
                            ? t.forEach((e) => {
                                const t = document.createElement("div");
                                ((t.className = "group-selection-item"),
                                    (t.dataset.groupId = e.id),
                                    (t.textContent = e.name),
                                    Go.appendChild(t));
                            })
                            : (Go.innerHTML =
                                '<p style="text-align:center; color:#888;">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>'),
                        (Fo.style.display = "flex"),
                        setTimeout(() => (Fo.style.opacity = "1"), 10));
                } catch (e) {
                    console.error("Âä†ËΩΩÂàÜÁªÑÂà∞ÂºπÁ™óÂ§±Ë¥•:", e);
                }
            else alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÁßªÂä®ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
        }),
        Ro.addEventListener("click", () => {
            ((Fo.style.opacity = "0"),
                setTimeout(() => (Fo.style.display = "none"), 300));
        }),
        Go.addEventListener("click", async (e) => {
            const t = e.target.closest(".group-selection-item");
            if (!t) return;
            const n = parseInt(t.dataset.groupId, 10),
                a = Sr.querySelectorAll(".contact-checkbox:checked"),
                o = Po.querySelectorAll(".contact-checkbox:checked");
            let s = new Set(),
                i = null;
            if (o.length > 0)
                (o.forEach((e) =>
                    s.add(parseInt(e.closest(".contact-item").dataset.bookId, 10)),
                ),
                    (i = Uo));
            else {
                if (!(a.length > 0)) return;
                a.forEach((e) =>
                    s.add(parseInt(e.closest(".contact-item").dataset.bookId, 10)),
                );
            }
            try {
                const e = await Kl.loadData("worldBookGroups", "allGroups");
                let t = e && Array.isArray(e.value) ? e.value : [];
                if (i) {
                    const e = t.find((e) => e.id === i);
                    e &&
                        Array.isArray(e.bookIds) &&
                        (e.bookIds = e.bookIds.filter((e) => !s.has(e)));
                }
                const a = t.find((e) => e.id === n);
                (a &&
                    (Array.isArray(a.bookIds) || (a.bookIds = []),
                        (a.bookIds = [...new Set([...a.bookIds, ...s])])),
                    await Kl.saveData("worldBookGroups", "allGroups", t),
                    alert("ÁßªÂä®ÊàêÂäüÔºÅ"),
                    Ro.click(),
                    i ? (ju(i), Yo.click()) : (zu(), _o.click()));
            } catch (e) {
                (console.error("ÁßªÂä®‰∏ñÁïå‰π¶Â§±Ë¥•:", e), alert("Êìç‰ΩúÂ§±Ë¥•ÔºÅ"));
            }
        }),
        Io.addEventListener("click", async function () {
            try {
                const e = {
                    url: _r.value.trim(),
                    key: Fr.value.trim(),
                    model: Wr.value,
                    temperature: parseFloat(jr.value) || 1,
                };
                (await Kl.saveData("settingsStore", "apiSettings", e),
                    await Kl.saveData("settingsStore", "isFullscreenEnabled", fr.checked),
                    await Kl.saveData("settingsStore", "darkModeEnabled", ss.checked),
                    alert("ÊâÄÊúâËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ"));
            } catch (e) {
                (console.error("‰øùÂ≠òÊâÄÊúâËÆæÁΩÆÂ§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•"));
            }
        }),
        bo.addEventListener("click", () => {
            (Eo.click(), Zc.classList.remove("active"));
        }),
        Eo.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            if (t) {
                e.target.value = "";
                try {
                    let e;
                    window.iOSBabyMode && window.iOSBabyMode.enabled && t.size > 1048576
                        ? (window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...", 0),
                            (e = await window.iOSBabyMode.safeCompressImage(t, {
                                maxWidth: 1280,
                                maxHeight: 1280,
                                quality: 0.75,
                                onProgress: (e) => {
                                    window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜÂõæÁâá...", e);
                                },
                            })),
                            window.iOSBabyMode.hideProgressToast())
                        : (e = window.iOSBabyMode
                            ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                            : await new Promise((e, n) => {
                                const a = new FileReader();
                                ((a.onload = (t) => e(t.target.result)),
                                    (a.onerror = n),
                                    a.readAsDataURL(t));
                            }));
                    Dc({
                        sender: "user",
                        type: "image",
                        url: e,
                        text: "[ÂõæÁâá]",
                        timestamp: new Date(),
                        uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                    });
                } catch (e) {
                    (console.error("ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•:", e),
                        window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                        alert(`‚ùå ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`));
                }
            }
        }),
        go.addEventListener("click", () => {
            (Ii.classList.add("show-presets"), Yu());
        }),
        yo.addEventListener("click", () => {
            Ii.classList.remove("show-presets");
        }),
        po.addEventListener("click", async () => {
            const e = prompt("ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºö");
            if (e && e.trim())
                try {
                    const t = await Kl.loadData("settingsStore", "customAppIcons"),
                        n = t && t.value ? t.value : {},
                        a = {
                            id: Date.now(),
                            name: e.trim(),
                            icons: n,
                        },
                        o = await Kl.loadData("iconPresets", "allPresets");
                    let s = o && Array.isArray(o.value) ? o.value : [];
                    (s.unshift(a),
                        await Kl.saveData("iconPresets", "allPresets", s),
                        alert(`È¢ÑËÆæ "${a.name}" Â∑≤ÊàêÂäü‰øùÂ≠òÔºÅ`));
                } catch (e) {
                    (console.error("‰øùÂ≠òÈ¢ÑËÆæÂ§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•"));
                }
            else alert("È¢ÑËÆæÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        }),
        ho.addEventListener("click", async (e) => {
            const t = e.target,
                n = parseInt(t.dataset.presetId, 10);
            if (t.classList.contains("apply-preset-btn")) {
                if (!confirm("Á°ÆÂÆöË¶ÅÂ∫îÁî®Ê≠§ÂõæÊ†áÂåÖÈ¢ÑËÆæÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÁöÑÂõæÊ†áËÆæÁΩÆ„ÄÇ"))
                    return;
                try {
                    const e = (await Kl.loadData("iconPresets", "allPresets")).value.find(
                        (e) => e.id === n,
                    );
                    e &&
                        (await Kl.saveData("settingsStore", "customAppIcons", e.icons),
                            await nu(),
                            alert(`È¢ÑËÆæ "${e.name}" Â∑≤ÊàêÂäüÂ∫îÁî®ÔºÅ`));
                } catch (e) {
                    (console.error("Â∫îÁî®È¢ÑËÆæÂ§±Ë¥•:", e), alert("Â∫îÁî®Â§±Ë¥•ÔºÅ"));
                }
            } else if (t.classList.contains("delete-preset-btn")) {
                if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™È¢ÑËÆæÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ")) return;
                try {
                    const e = (
                        await Kl.loadData("iconPresets", "allPresets")
                    ).value.filter((e) => e.id !== n);
                    (await Kl.saveData("iconPresets", "allPresets", e), Yu());
                } catch (e) {
                    (console.error("Âà†Èô§È¢ÑËÆæÂ§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•ÔºÅ"));
                }
            } else if (t.classList.contains("export-preset-btn"))
                try {
                    const e = (await Kl.loadData("iconPresets", "allPresets")).value.find(
                        (e) => e.id === n,
                    );
                    if (e) {
                        const t = JSON.stringify(e, null, 2),
                            n = new Blob([t], {
                                type: "application/json",
                            }),
                            a = URL.createObjectURL(n),
                            o = document.createElement("a");
                        ((o.download = `ÂõæÊ†áÈ¢ÑËÆæ_${e.name}.json`),
                            (o.href = a),
                            o.click(),
                            URL.revokeObjectURL(a));
                    }
                } catch (e) {
                    (console.error("ÂØºÂá∫È¢ÑËÆæÂ§±Ë¥•:", e), alert("ÂØºÂá∫Â§±Ë¥•ÔºÅ"));
                }
        }),
        vo.addEventListener("click", () => {
            fo.click();
        }),
        fo.addEventListener("change", (e) => {
            const t = e.target.files[0];
            if (!t) return;
            const n = new FileReader();
            ((n.onload = async (e) => {
                try {
                    const t = JSON.parse(e.target.result);
                    if (!t.name || "object" != typeof t.icons)
                        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºå‰∏çÊòØÊúâÊïàÁöÑÈ¢ÑËÆæÊñá‰ª∂„ÄÇ");
                    const n = await Kl.loadData("iconPresets", "allPresets");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    if (a.some((e) => e.name === t.name)) {
                        if (!confirm(`Â∑≤Â≠òÂú®Âêç‰∏∫ "${t.name}" ÁöÑÈ¢ÑËÆæ„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`))
                            return void (fo.value = "");
                        a = a.filter((e) => e.name !== t.name);
                    }
                    ((t.id = Date.now()),
                        a.unshift(t),
                        await Kl.saveData("iconPresets", "allPresets", a),
                        Yu(),
                        alert(`È¢ÑËÆæ "${t.name}" Â∑≤ÊàêÂäüÂØºÂÖ•ÔºÅ`));
                } catch (e) {
                    (console.error("ÂØºÂÖ•È¢ÑËÆæÂ§±Ë¥•:", e), alert(`ÂØºÂÖ•Â§±Ë¥•: ${e.message}`));
                } finally {
                    fo.value = "";
                }
            }),
                n.readAsText(t));
        }),
        Ba.addEventListener("click", () => {
            (Ii.classList.remove("show-incoming-call"), am());
        }),
        Sa.addEventListener("click", () => {
            (Ii.classList.remove("show-incoming-call"),
                Xd(`Êú™Êé•Êù•ÁîµÔºö${Sc.ai.name}`, Sc.id));
        }),
        "serviceWorker" in navigator &&
        window.addEventListener("load", () => {
            navigator.serviceWorker
                .register("./sw.js")
                .then((e) => {
                    console.log(
                        "ServiceWorker registration successful with scope: ",
                        e.scope,
                    );
                })
                .catch((e) => {
                    console.log("ServiceWorker registration failed: ", e);
                });
        }),
        ia.addEventListener("click", () => {
            (ma.classList.remove("visible"),
                ua.classList.add("visible"),
                setTimeout(() => {
                    ua.classList.remove("visible");
                    gm({
                        portrait: Ea,
                        backgrounds: Ia,
                    });
                }, 5e3));
        }));
    const ym =
        '\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 20px; gap: 25px;">\n        <div class="settings-column" style="width: 100%;">\n            <h4>ËßíËâ≤Âêç</h4>\n            <div class="font-setting-item">\n                <label for="char-name-color-input">ÊñáÂ≠óÈ¢úËâ≤</label>\n                <div class="color-input-container">\n                    <input type="text" id="char-name-color-input">\n                    <input type="color" id="char-name-color-picker">\n                </div>\n            </div>\n            <div class="font-setting-item">\n                <label for="char-name-size-slider">ÊñáÂ≠óÂ§ßÂ∞è</label>\n                <div class="font-slider-container">\n                    <input type="range" id="char-name-size-slider" min="12" max="24" step="1">\n                    <span id="char-name-size-value">16px</span>\n                </div>\n            </div>\n        </div>\n\n        <div class="settings-column" style="width: 100%;">\n            <h4>ÂØπËØùÂÜÖÂÆπ</h4>\n            <div class="font-setting-item">\n                <label for="dialog-text-color-input">ÊñáÂ≠óÈ¢úËâ≤</label>\n                <div class="color-input-container">\n                    <input type="text" id="dialog-text-color-input">\n                    <input type="color" id="dialog-text-color-picker">\n                </div>\n            </div>\n            <div class="font-setting-item">\n                <label for="dialog-text-size-slider">ÊñáÂ≠óÂ§ßÂ∞è</label>\n                <div class="font-slider-container">\n                    <input type="range" id="dialog-text-size-slider" min="12" max="20" step="0.5">\n                    <span id="dialog-text-size-value">15px</span>\n                </div>\n            </div>\n        </div>\n    </div>\n';

    function hm(e, t = "(ÊïÖ‰∫ãÂºÄÂßã)") {
        ((Sn = t),
            Xn.push(`AI: ${e}`),
            (ba.innerHTML = ""),
            (zn.style.display = "none"),
            (ha.style.opacity = 0),
            (Zn = (function (e) {
                e = (function (e) {
                    const t = ["ÈÄâÈ°πÔºö", "ÊóÅÁôΩÔºö", Sc.ai.name + "Ôºö"];
                    let n = e.split("\n");
                    const a = [];
                    for (const e of n) {
                        let n = e.trim(),
                            o = !1;
                        for (const e of t) {
                            const t = n.indexOf(e);
                            if (t > 0) {
                                const e = n.substring(0, t).trim(),
                                    s = n.substring(t).trim();
                                (a.push(e), a.push(s), (o = !0));
                                break;
                            }
                        }
                        o || a.push(n);
                    }
                    return a.join("\n");
                })(e);
                const t = [],
                    n =
                        /(?<speaker>ÊóÅÁôΩ|ÈÄâÈ°π|[^Ôºö\n\\„ÄÇÔºåÔºÅÔºüÔºõ]+?)Ôºö(?<content>[\s\S]*?)(?=\n?(?:ÊóÅÁôΩ|ÈÄâÈ°π|[^Ôºö\n\\„ÄÇÔºåÔºÅÔºüÔºõ]+?)Ôºö|$)/g,
                    a = [...e.matchAll(n)];
                if (0 === a.length) {
                    const n = e
                        .split("\\")
                        .map((e) => e.trim())
                        .filter((e) => e);
                    return (
                        n.length > 0 &&
                        Sc &&
                        t.push({
                            type: "dialogue",
                            speaker: Sc.ai.name,
                            segments: n,
                        }),
                        t
                    );
                }
                for (const e of a) {
                    const { speaker: n, content: a } = e.groups,
                        o = n.trim(),
                        s = a.trim();
                    if (s)
                        if ("ÊóÅÁôΩ" === o) {
                            const e = s
                                .split("\\")
                                .map((e) => e.trim())
                                .filter((e) => e);
                            t.push({
                                type: "narration",
                                speaker: "ÊóÅÁôΩ",
                                segments: e,
                            });
                        } else if ("ÈÄâÈ°π" === o) {
                            const e = s
                                .split("Ôºõ")
                                .map((e) => e.replace(/^\d+\.\s*/, "").trim());
                            t.push({
                                type: "choices",
                                options: e,
                            });
                        } else {
                            const e = s
                                .split("\\")
                                .map((e) => e.trim())
                                .filter((e) => e);
                            t.push({
                                type: "dialogue",
                                speaker: o,
                                segments: e,
                            });
                        }
                }
                return t;
            })(e)),
            (Qn = 0),
            vm());
    }

    function vm() {
        if (Qn >= Zn.length) return void console.log("ÂâßÊú¨Êí≠ÊîæÂÆåÊØï„ÄÇ");
        const e = Zn[Qn];
        if ("narration" === e.type || "dialogue" === e.type) {
            "narration" === e.type
                ? ((wa.textContent = "ÊóÅÁôΩ"), (ha.style.opacity = 0))
                : ((wa.textContent = e.speaker.toUpperCase()), (ha.style.opacity = 1));
            let t = 0;
            const n = () => {
                t < e.segments.length
                    ? fm(ba, e.segments[t], () => {
                        t++;
                    })
                    : (Qn++, vm());
            };
            ((Un.onclick = () => {
                ea ? (ea = !1) : n();
            }),
                n());
        } else
            "choices" === e.type &&
                (function (e) {
                    ((Un.onclick = null),
                        (zn.innerHTML = ""),
                        e.forEach((e) => {
                            const t = document.createElement("button");
                            ((t.className = "vn-choice-btn"),
                                (t.textContent = e),
                                (t.onclick = () => wm(e)),
                                zn.appendChild(t));
                        }));
                    const t = document.createElement("button");
                    ((t.className = "vn-choice-btn"),
                        (t.textContent = "Ëá™ÂÆö‰πâ..."),
                        (t.onclick = () => {
                            ((Yn.value = ""),
                                (Vn.style.display = "flex"),
                                setTimeout(() => {
                                    (Vn.classList.add("visible"), Yn.focus());
                                }, 10));
                        }),
                        zn.appendChild(t),
                        (zn.style.display = "flex"));
                })(e.options);
    }

    function fm(e, t, n) {
        ((ea = !0),
            (e.innerHTML = ""),
            e.appendChild(document.createTextNode(t.charAt(a))),
            a++,
            setTimeout(o, 120));
        let a = 0;

        function o() {
            if (!ea) return ((e.innerHTML = t), void n());
            a < t.length || ((ea = !1), n());
        }
        o();
    }
    async function wm(e) {
        (Xn.push(`Áî®Êà∑Ôºö${e}`),
            console.log("Áî®Êà∑ÈÄâÊã©‰∫Ü:", e),
            (zn.style.display = "none"),
            (wa.textContent = Sc.user.name.toUpperCase()),
            await new Promise((t) => fm(ba, e, t)),
            setTimeout(async () => {
                ba.innerHTML =
                    '<div class="dialog-loader"><span></span><span></span><span></span></div>';
                const t = await km(e);
                t
                    ? hm(t, e)
                    : (ba.innerHTML = "AIÁª≠ÂÜôÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆÊàñÁΩëÁªúÂêéÈáçËØï„ÄÇ");
            }, 1e3));
    }

    function bm(e = null) {
        (e
            ? ((Wn = e.id), (_n.textContent = "ÁºñËæëÂÅèÂ•Ω"), (Rn.value = e.text))
            : ((Wn = null), (_n.textContent = "Ê∑ªÂä†ÂÅèÂ•Ω"), (Rn.value = "")),
            (Nn.style.display = "flex"),
            setTimeout(() => {
                Nn.classList.add("visible");
            }, 10));
    }

    function Em() {
        (Nn.classList.remove("visible"),
            setTimeout(() => (Nn.style.display = "none"), 300));
    }
    async function Im(e) {
        e.innerHTML = '<p style="text-align:center; color:#888;">Ê≠£Âú®Âä†ËΩΩ...</p>';
        try {
            const t = await Kl.loadData("writingStylePresets", "allPresets"),
                n = await Kl.loadData("writingStylePresets", "activePresetIds"),
                a = t && Array.isArray(t.value) ? t.value : [],
                o = n && Array.isArray(n.value) ? new Set(n.value) : new Set();
            if (0 === a.length)
                return void (e.innerHTML =
                    '<p style="text-align:center; color:#888; padding-top: 50px;">ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÊñáÁ¨îÂÅèÂ•Ω<br>ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÊù•ÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>');
            ((e.innerHTML = ""),
                a.forEach((t) => {
                    const n = document.createElement("div");
                    n.className = "preset-card";
                    const a = o.has(t.id);
                    (a && n.classList.add("active"),
                        (n.dataset.presetId = t.id),
                        (n.innerHTML = `\n                        <div class="active-tag">Â∑≤ÊøÄÊ¥ª</div>\n                        <p class="preset-text">${t.text}</p>\n                        <div class="preset-actions">\n                            <button class="select-preset-btn">${a ? "ÂèñÊ∂àÈÄâÊã©" : "ÈÄâÊã©"}</button>\n                            <button class="edit-preset-btn">ÁºñËæë</button>\n                            <button class="delete-btn delete-preset-btn">Âà†Èô§</button>\n                        </div>\n                    `),
                        e.appendChild(n));
                }));
        } catch (t) {
            (console.error("Âä†ËΩΩÊñáÁ¨îÂÅèÂ•ΩÂ§±Ë¥•:", t),
                (e.innerHTML =
                    '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•ÔºÅ</p>'));
        }
    }
    async function xm(e) {
        try {
            const t = await Kl.loadData("settingsStore", "apiSettings");
            if (!t || !t.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: n, key: a, model: o, temperature: s } = t.value;
            let i = n.endsWith("/") ? n.slice(0, -1) : n;
            i += "/chat/completions";
            const r = [
                {
                    role: "system",
                    content:
                        "You are a helpful assistant that provides concise text responses based on user instructions.",
                },
                {
                    role: "user",
                    content: e,
                },
            ],
                l = await fetch(i, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${a}`,
                    },
                    body: JSON.stringify({
                        model: o,
                        messages: r,
                        temperature: parseFloat(s) || 0.7,
                    }),
                });
            if (!l.ok) {
                const e = await l.json().catch(() => ({}));
                return (
                    console.error("‚ùå API ËØ∑Ê±ÇÂ§±Ë¥•ËØ¶ÊÉÖ:", e),
                    e.error && "context_length_exceeded" === e.error.code
                        ? alert("üò≠ Â§±Ë¥•ÔºöÂèëÈÄÅÁöÑÂÜÖÂÆπÂ§™Èïø‰∫ÜÔºÅËØ∑Á≤æÁÆÄ‰∏ñÁïå‰π¶ÊàñPrompt„ÄÇ")
                        : 401 === l.status
                            ? alert("üîë Â§±Ë¥•ÔºöAPI Key ÈîôËØØÊàñËøáÊúü„ÄÇ")
                            : alert(`‚ö†Ô∏è APIÊä•Èîô (${l.status}): ËØ∑ÊåâF12Êü•ÁúãÊéßÂà∂Âè∞ËØ¶ÊÉÖ`),
                    null
                );
            }
            const c = await l.json();
            return c.choices && 0 !== c.choices.length
                ? c.choices[0].message.content
                : (console.warn("API ËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ:", c), null);
        } catch (e) {
            return (
                console.error("‚õî ÁΩëÁªúÈîôËØØ:", e),
                alert("ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰Ω†ÁöÑ‰ª£ÁêÜÊàñÁΩëÁªúËÆæÁΩÆ„ÄÇ"),
                null
            );
        }
    }
    async function xm(e) {
        try {
            const t = await Kl.loadData("settingsStore", "apiSettings");
            if (!t || !t.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: n, key: a, model: o, temperature: s } = t.value;
            let i = n.endsWith("/") ? n.slice(0, -1) : n;
            i += "/chat/completions";
            const r = [
                {
                    role: "system",
                    content:
                        "You are a helpful assistant that provides concise text responses based on user instructions.",
                },
                {
                    role: "user",
                    content: e,
                },
            ],
                l = await fetch(i, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${a}`,
                    },
                    body: JSON.stringify({
                        model: o,
                        messages: r,
                        temperature: parseFloat(s) || 0.7,
                    }),
                });
            if (!l.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${l.status}`);
            return (await l.json()).choices[0].message.content;
        } catch (e) {
            return (console.error("fetchSimpleAiResponse Â§±Ë¥•:", e), null);
        }
    }
    async function km(e) {
        if (!Sc) return null;
        try {
            const n = await Kl.loadData("settingsStore", "apiSettings");
            if (!n || !n.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: a, key: o, model: s, temperature: i } = n.value;
            let r = a.endsWith("/") ? a.slice(0, -1) : a;
            r += "/chat/completions";
            const l = Sc.history || [];
            let c = l
                .slice(-5)
                .map((e) => {
                    const t = "user" === e.sender ? contact.user.name : contact.ai.name;
                    let n = e.text || "";
                    return e.replyTo
                        ? `${t} (replying to ${e.replyTo.senderName}): ${n}`
                        : `${t}: ${n}`;
                })
                .join("\n");
            c || (c = "Êó†");
            let d = "Êó†ÁâπÂÆö‰∏ñÁïåËßÇËÆæÂÆö„ÄÇ";
            if (Sc.linkedWorldBookGroupIds && Sc.linkedWorldBookGroupIds.length > 0)
                try {
                    const e = await Kl.loadData("worldBookGroups", "allGroups"),
                        t = e && Array.isArray(e.value) ? e.value : [],
                        n = await Kl.loadData("worldBooks", "allWorldBooks"),
                        a = n && Array.isArray(n.value) ? n.value : [],
                        o = new Set(Sc.linkedWorldBookGroupIds),
                        s = new Set();
                    t.forEach((e) => {
                        o.has(e.id) &&
                            Array.isArray(e.bookIds) &&
                            e.bookIds.forEach((e) => s.add(e));
                    });
                    const i = a
                        .filter((e) => s.has(e.id))
                        .map((e) => `### ‰∏ñÁïå‰π¶: ${e.name}\n\n${e.content}`)
                        .join("\n\n---\n\n");
                    i && (d = i);
                } catch (e) {
                    console.error("Âä†ËΩΩÂÖ≥ËÅîÁöÑ‰∏ñÁïå‰π¶ÁªÑÂÜÖÂÆπÊó∂Âá∫Èîô:", e);
                }
            let u = "ËØ∑Ëá™Áî±ÂèëÊå•ÔºåÊñáÁ¨î‰ºòÁæéËá™ÁÑ∂Âç≥ÂèØ„ÄÇ";
            const m = await Kl.loadData("writingStylePresets", "allPresets"),
                p = await Kl.loadData("writingStylePresets", "activePresetIds");
            if (m && p && Array.isArray(m.value) && Array.isArray(p.value)) {
                const e = m.value,
                    t = new Set(p.value),
                    n = e.filter((e) => t.has(e.id)).map((e) => e.text);
                n.length > 0 && (u = n.join("\n\n"));
            }
            const g = {
                ai_name: Sc.ai.name,
                user_name: Sc.user.name,
                ai_persona: Sc.ai.persona || "Êó†",
                user_persona: Sc.user.persona || "Êó†",
                world_book_content: d,
                chat_history: c,
                user_choice: e,
                writing_style: u,
                scene_history: Xn.join("\n"),
            },
                y = [
                    {
                        role: "system",
                        content: `\n### Ê†∏ÂøÉË∫´‰ªΩ\n‰Ω†ÊòØ‰∏Ä‰ΩçÊâçÂçéÊ®™Ê∫¢ÁöÑÊ≤âÊµ∏ÂºèÊïÖ‰∫ã‰ΩúÂÆ∂ÂíåÁ∫¶‰ºöÊ®°ÊãüÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÊèê‰æõÁöÑ‰∏ä‰∏ãÊñáÔºåÂä®ÊÄÅÂàõ‰Ωú‰∏ÄÊÆµÂåÖÂê´ÊóÅÁôΩ„ÄÅËßíËâ≤ÂØπËØùÂíåÈÄâÈ°πÁöÑ‰∫íÂä®ÂºèÁ∫¶‰ºöÂú∫ÊôØ„ÄÇ\n\n### ‰∏ä‰∏ãÊñá‰ø°ÊÅØ\n‰Ω†Ê≠£Âú®Áª≠ÂÜô‰Ω†ÔºàÊâÆÊºî ${(t = g).ai_name}ÔºâÂíåÁî®Êà∑ÔºàÊâÆÊºî ${t.user_name}Ôºâ‰πãÈó¥ÁöÑ‰∏ÄÊÆµÁ∫¶‰ºöÊïÖ‰∫ã„ÄÇ\n- ËßíËâ≤ËÆæÂÆöÔºö${t.ai_persona}\n- Áî®Êà∑ËÆæÂÆöÔºö${t.user_persona}\n- ‰∏ñÁïåËßÇËÆæÂÆöÔºö${t.world_book_content}\n- ÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºàÁ∫¶‰ºöÂâçÁöÑÈì∫Âû´ÔºâÔºö${t.chat_history}\n- Êú¨Ê¨°Á∫¶‰ºöÁöÑÂú∫ÊôØÂéÜÂè≤ÔºàÊåâÊó∂Èó¥È°∫Â∫èÔºâÔºö\n${t.scene_history || "ÔºàËøôÊòØÁ∫¶‰ºöÁöÑÂºÄÂßãÔºâ"}\n- Áî®Êà∑ÂàöÂàöÁöÑË°åÂä®/ÈÄâÊã©ÊòØÔºö‚Äù${t.user_choice}‚Äú\n\n\n### ÊñáÁ¨îÈ£éÊ†ºÂÅèÂ•Ω (ÂøÖÈ°ªÈÅµÂÆà)\n${t.writing_style}\n\n---\n### „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßËßÑÂàô„Äë\n‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºåËøôÊòØÁ®ãÂ∫èÊ≠£Á°ÆËøêË°åÁöÑ‰øùÈöú„ÄÇ\n\n#### 1. Âèô‰∫ãËßÜËßíËßÑÂàô (Narrative Perspective)\n- **ÂΩì‰ΩøÁî® "ÊóÅÁôΩÔºö" Êó∂**Ôºö‰Ω†ÊòØ‰∏Ä‰∏™ÂÆ¢ËßÇÁöÑ„ÄÅÊ≤°ÊúâÊÑüÊÉÖÁöÑ„ÄêÁ¨¨‰∏â‰∫∫Áß∞„ÄëÂèô‰∫ãËÄÖ„ÄÇ‰Ω†ÂøÖÈ°ªÁî®‚Äú‰ªñ‚Äù„ÄÅ‚ÄúÂ•π‚ÄùÊàñËßíËâ≤ÂêçÔºà${t.ai_name}ÔºâÊù•Áß∞ÂëºAIËßíËâ≤ÔºåÁî®‚Äú‰Ω†‚ÄùÊù•Áß∞ÂëºÁî®Êà∑„ÄÇ**„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú® "ÊóÅÁôΩÔºö" ÁöÑÂÜÖÂÆπ‰∏≠‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞ "Êàë"**„ÄÇ\n    - ‚úÖ **Ê≠£Á°ÆËåÉ‰æã**: ÊóÅÁôΩÔºö‰ªñÁúãÁùÄ‰Ω†ÔºåÂò¥Ëßí‰∏çËá™ËßâÂãæËµ∑‰∏Ä‰∏ùÁ¨ëÊÑè„ÄÇ\n    - ‚ùå **ÈîôËØØËåÉ‰æã**: ÊóÅÁôΩÔºöÊàëÁúãÁùÄ‰Ω†ÔºåÂò¥Ëßí‰∏çËá™ËßâÂãæËµ∑‰∏Ä‰∏ùÁ¨ëÊÑè„ÄÇ\n- **ÂΩì‰ΩøÁî® "${t.ai_name}Ôºö" Êó∂**Ôºö‰Ω†ÂÆåÂÖ®‰ª£ÂÖ•ËßíËâ≤Ôºå‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞„Äë"Êàë" ËøõË°åÊÄùËÄÉÂíåËØ¥ËØù„ÄÇ\n\n// --- ËøôÊòØ‰øÆÊ≠£ÂêéÁöÑÊñ∞Êåá‰ª§ ---\n#### 2. Âº∫Âà∂ÂàÜÊÆµËßÑÂàô (Mandatory Segmentation)\n- Âú® "ÊóÅÁôΩÔºö" Âíå "${t.ai_name}Ôºö" ÁöÑÂÜÖÂÆπ‰∏≠Ôºå„ÄêÂøÖÈ°ª„ÄëÂè™Âú®‰ª£Ë°®‰∏ÄÂè•ËØùÁªìÊùüÁöÑÊ†áÁÇπÁ¨¶Âè∑ÔºàÂ¶ÇÂè•Âè∑„ÄÅÈóÆÂè∑„ÄÅÊÑüÂèπÂè∑ÔºâÂêéÈù¢Á¥ßË∑ü‰∏Ä‰∏™ÂèçÊñúÊù† "\\" Êù•ËøõË°åÂàÜÊÆµ„ÄÇËøôÊòØÊ®°ÊãüËßÜËßâÂ∞èËØ¥ÁÇπÂáªÁøªÈ°µÁöÑÊäÄÊúØË¶ÅÊ±Ç„ÄÇ\n- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®Âè•Â≠ê‰∏≠Èó¥ÁöÑÈÄóÂè∑„ÄÅÈ°øÂè∑Êàñ‰ªª‰Ωï‰∏çÊòØ‰∏ÄÂè•ËØùÁªìÂ∞æÁöÑÂú∞Êñπ‰ΩøÁî®ÂèçÊñúÊù†„ÄÇ\n    - ‚úÖ **Ê≠£Á°ÆËåÉ‰æã**: ${t.ai_name}ÔºöËøôÂÆ∂ÁöÑÊãøÈìÅÂæà‰∏çÈîôÔºå‰Ω†Ë¶ÅÂ∞ùÂ∞ùÂêóÔºü\\Êàë‰∏∫‰Ω†ÁÇπ‰∫Ü‰∏ÄÊùØ„ÄÇ\n    - ‚ùå **ÈîôËØØËåÉ‰æã**: ${t.ai_name}ÔºöËøôÂÆ∂ÁöÑÊãøÈìÅÂæà‰∏çÈîôÔºå\\‰Ω†Ë¶ÅÂ∞ùÂ∞ùÂêóÔºü\n\n#### 3. ÈÄâÈ°πÊ†ºÂºèËßÑÂàô (Choice Formatting)\n- **ÊâÄÊúâÈÄâÈ°π„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªéÁî®Êà∑ÁöÑËßÜËßíÂá∫ÂèëÁöÑÂä®‰ΩúÊàñÂØπËØù„ÄÇ**\n- **„ÄêÂøÖÈ°ª„Äë** ‰ª• "ÈÄâÈ°πÔºö" ÂºÄÂ§¥ÔºåÊèê‰æõ‰∏§‰∏™ÈÄâÈ°πÔºåÁî®‰∏≠ÊñáÂàÜÂè∑ "Ôºõ" ÈöîÂºÄ„ÄÇ\n    - ‚úÖ **Ê≠£Á°ÆËåÉ‰æã**: ÈÄâÈ°πÔºö1. Êè°‰Ωè‰ªñÁöÑÊâãÔºõ2. ÂÅáË£ÖÊ≤°ÁúãËßÅÔºå‰ΩéÂ§¥ÂñùÂíñÂï°„ÄÇ\n    - ‚ùå **ÈîôËØØËåÉ‰æã**: ÈÄâÈ°πÔºö1. ÊàëÊè°‰Ωè‰∫Ü‰Ω†ÁöÑÊâãÔºõ2. ‰Ω†‰ΩéÂ§¥ÂñùÂíñÂï°„ÄÇ\n---\n\n\n### ‰∏•Ê†ºËæìÂá∫Ê†ºÂºè (Output Format)\n‰Ω†ÁöÑÊâÄÊúâËæìÂá∫„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊ†ºÂºèÔºå‰∏çÂêåÈÉ®ÂàÜÁî®Êç¢Ë°åÂàÜÈöî„ÄÇ\n1.  **ÊóÅÁôΩ (ÂèØÈÄâ):** ‰ª• "ÊóÅÁôΩÔºö" ÂºÄÂ§¥„ÄÇ\n2.  **ËßíËâ≤ÂØπËØù (ÂøÖÈ°ª):** ‰ª•‰Ω†ÁöÑËßíËâ≤Âêç "${t.ai_name}Ôºö" ÂºÄÂ§¥„ÄÇ\n3.  **ÈÄâÈ°π (ÂøÖÈ°ª):** ‰ª• "ÈÄâÈ°πÔºö" ÂºÄÂ§¥„ÄÇ\n`,
                    },
                    {
                        role: "user",
                        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁªßÁª≠Êàë‰ª¨ÁöÑÁ∫¶‰ºöÊïÖ‰∫ã„ÄÇ",
                    },
                ],
                h = await fetch(r, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${o}`,
                    },
                    body: JSON.stringify({
                        model: s,
                        messages: y,
                        temperature: parseFloat(i) || 1,
                    }),
                });
            if (!h.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${h.status}`);
            return (await h.json()).choices[0].message.content;
        } catch (e) {
            return (
                console.error("Ë∞ÉÁî®VN AIÂ§±Ë¥•:", e),
                alert(`AIÂàõ‰ΩúÂ§±Ë¥•: ${e.message}`),
                null
            );
        }
        var t;
    }
    async function Lm() {
        if (
            ((On.innerHTML =
                '<p style="text-align:center; color:#888;">Ê≠£Âú®Âä†ËΩΩËÆ∞ÂΩï...</p>'),
                Sc)
        )
            try {
                const e = await Kl.getAllDataFromStore("datingHistoryStore");
                let t = 0;
                const n = e.filter((e) => {
                    const n = e.value.contactId === Sc.id;
                    return (n || e.value.contactId || t++, n);
                });
                t > 0 &&
                    console.warn(
                        `Â∑≤ËøáÊª§ÈöêËóè ${t} Êù°Ê≤°ÊúâÂΩíÂ±û(ÊóßÁâà)ÁöÑÁ∫¶‰ºöËÆ∞ÂΩïÔºåÈò≤Ê≠¢Êï∞ÊçÆÊ±°Êüì„ÄÇ`,
                    );
                const a = n.sort((e, t) => t.id - e.id);
                if (0 === a.length)
                    return void (On.innerHTML =
                        '<p style="text-align:center; color:#888; padding-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÁ∫¶‰ºöËÆ∞ÂΩï„ÄÇ</p>');
                ((On.innerHTML = ""),
                    a.forEach((e) => {
                        const t = document.createElement("div");
                        ((t.className = "history-card"), (t.dataset.id = e.id));
                        const n = new Date(e.value.date),
                            a = `${n.getFullYear()}Âπ¥${n.getMonth() + 1}Êúà${n.getDate()}Êó•`;
                        ((t.innerHTML = `\n                <div class="history-card-header">\n                    <span class="history-date">${a}</span>\n                    <span class="history-partner">With: ${e.value.partnerName}</span>\n                </div>\n                <p class="history-summary">${e.value.summary}</p>\n                <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">\n                    <button class="edit-btn">ÁºñËæë</button>\n                    <button class="delete-btn">Âà†Èô§</button>\n                </div>\n            `),
                            On.appendChild(t));
                    }));
            } catch (e) {
                (console.error("Âä†ËΩΩÁ∫¶‰ºöËÆ∞ÂΩïÂ§±Ë¥•:", e),
                    (On.innerHTML =
                        '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•ÔºÅ</p>'));
            }
        else
            On.innerHTML =
                '<p style="text-align:center; color:red;">ÈîôËØØÔºöÊó†Ê≥ïËé∑ÂèñÂΩìÂâçAIËßíËâ≤‰ø°ÊÅØ</p>';
    }
    (qn.addEventListener("click", () => bm()),
        Fn &&
        Fn.addEventListener("click", () => {
            window.DOMCleanupManager.clean("style-presets-container");
        }),
        Gn.addEventListener("click", async () => {
            const e = Rn.value.trim();
            if (e)
                try {
                    const t = await Kl.loadData("writingStylePresets", "allPresets");
                    let n = t && Array.isArray(t.value) ? t.value : [];
                    if (Wn) {
                        const t = n.findIndex((e) => e.id === Wn);
                        t > -1 && (n[t].text = e);
                    } else {
                        const t = {
                            id: Date.now(),
                            text: e,
                        };
                        n.unshift(t);
                    }
                    (await Kl.saveData("writingStylePresets", "allPresets", n),
                        Em(),
                        Im(jn));
                } catch (e) {
                    (console.error("‰øùÂ≠òÂÅèÂ•ΩÂ§±Ë¥•:", e), alert("‰øùÂ≠òÂ§±Ë¥•ÔºÅ"));
                }
            else alert("ÂÅèÂ•ΩÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        }),
        jn.addEventListener("click", async (e) => {
            const t = e.target,
                n = t.closest(".preset-card");
            if (!n) return;
            const a = parseInt(n.dataset.presetId, 10),
                o = await Kl.loadData("writingStylePresets", "allPresets");
            let s = o && Array.isArray(o.value) ? o.value : [];
            const i = s.find((e) => e.id === a);
            if (t.classList.contains("select-preset-btn")) {
                const e = await Kl.loadData("writingStylePresets", "activePresetIds");
                let t = e && Array.isArray(e.value) ? e.value : [];
                (t.includes(a) ? (t = t.filter((e) => e !== a)) : t.push(a),
                    await Kl.saveData("writingStylePresets", "activePresetIds", t),
                    Im(jn));
            } else if (t.classList.contains("edit-preset-btn")) bm(i);
            else if (
                t.classList.contains("delete-preset-btn") &&
                confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÁ¨îÂÅèÂ•ΩÂêóÔºü")
            ) {
                const e = s.filter((e) => e.id !== a);
                await Kl.saveData("writingStylePresets", "allPresets", e);
                const t = await Kl.loadData("writingStylePresets", "activePresetIds");
                if (t && t.value) {
                    let e = t.value.filter((e) => e !== a);
                    await Kl.saveData("writingStylePresets", "activePresetIds", e);
                }
                Im(jn);
            }
        }));

    function Bm(e, t, n) {
        (($n.textContent = e),
            (Tn.value = t),
            (Dn = n),
            (Cn.style.display = "flex"),
            setTimeout(() => {
                Cn.style.opacity = "1";
            }, 10));
    }

    function Sm() {
        ((Cn.style.opacity = "0"),
            setTimeout(() => {
                Cn.style.display = "none";
            }, 300));
    }
    async function Cm() {
        Bn.innerHTML = '<p style="text-align:center; color:#888;">Ê≠£Âú®Âä†ËΩΩ...</p>';
        try {
            const e = await Kl.loadData("fontUrlStore", "allFonts"),
                t = e && Array.isArray(e.value) ? e.value : [];
            if (((Bn.innerHTML = ""), 0 === t.length))
                return void (Bn.innerHTML =
                    '<p style="text-align:center; color:#888;">ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïURL„ÄÇ</p>');
            t.forEach((e) => {
                const t = document.createElement("div");
                ((t.className = "font-url-item"),
                    (t.innerHTML = `\n                        <span class="font-url-text" title="URL: ${e.url}">${e.name}</span>\n                        <div class="font-url-actions">\n                            <button class="apply-font-url-btn" data-url="${e.url}">Â∫îÁî®</button>\n                            <button class="delete-font-url-btn" data-id="${e.id}">Âà†Èô§</button>\n                        </div>\n                    `),
                    Bn.appendChild(t));
            });
        } catch (e) {
            (console.error("Âä†ËΩΩÂ≠ó‰ΩìURLÂàóË°®Â§±Ë¥•:", e),
                (Bn.innerHTML =
                    '<p style="text-align:center; color:red;">Âä†ËΩΩÂ§±Ë¥•ÔºÅ</p>'));
        }
    }

    function $m(e) {
        console.log(`Applying font from URL: ${e}`);
        let t = document.getElementById("custom-font-url-style");
        if (
            (t ||
                ((t = document.createElement("style")),
                    (t.id = "custom-font-url-style"),
                    document.head.appendChild(t)),
                !e)
        )
            return (
                console.log("Font URL is empty, restoring default."),
                (t.innerHTML = ""),
                void (Ii.style.fontFamily = "")
            );

        // Ê∏ÖÁêÜÊóßÁöÑÊ†∑ÂºèÔºåÂáÜÂ§áÂ∫îÁî®Êñ∞Â≠ó‰Ωì
        t.innerHTML = "";
        t.offsetHeight;
        Ii.style.fontFamily = "";

        const n = `CustomUrlFont_${Date.now()}`;
        // Ê∑ªÂä† cache buster Èò≤Ê≠¢ÊµèËßàÂô®ÁºìÂ≠òÂØºËá¥Â≠ó‰Ωì‰∏çÊõ¥Êñ∞
        const a = e.includes("?") ? `&_t=${Date.now()}` : `?_t=${Date.now()}`;
        const finalUrl = e + a;

        // ‰ΩøÁî® FontFace API Á°Æ‰øùÂ≠ó‰ΩìÁúüÊ≠£Âä†ËΩΩÂÆåÊàê
        try {
            const fontFace = new FontFace(n, `url('${finalUrl}')`, { display: 'swap' });
            fontFace.load().then(() => {
                document.fonts.add(fontFace);

                // ÊûÑÂª∫ÂÆåÊï¥ÁöÑ CSS ËßÑÂàôÔºàÂåÖÊã¨Ë¶ÜÁõñÊâÄÊúâÂ≠êÂÖÉÁ¥†Ôºâ
                const cssRules = `
                    @font-face {
                        font-family: '${n}';
                        src: url('${finalUrl}');
                        font-display: swap;
                    }
                    /* Âº∫Âà∂Ë¶ÜÁõñÊâÄÊúâÂ≠êÂÖÉÁ¥†ÁöÑ font-familyÔºåÂåÖÊã¨ * ÈÄâÊã©Âô® */
                    .phone-frame, .phone-frame * {
                        font-family: '${n}', sans-serif !important;
                    }
                `;
                t.innerHTML = cssRules;
                t.offsetHeight;
                console.log(`‚úÖ Â∑≤‰ªéURLÂ∫îÁî®Â≠ó‰Ωì: ${n} (${e})`);
            }).catch((err) => {
                console.error('‚ùå URLÂ≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•:', err);
                // ÂõûÈÄÄÊñπÊ°àÔºöÂç≥‰Ωø FontFace Âä†ËΩΩÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÈÄöËøá CSS Â∫îÁî®
                const cssRules = `
                    @font-face {
                        font-family: '${n}';
                        src: url('${finalUrl}');
                        font-display: swap;
                    }
                    .phone-frame, .phone-frame * {
                        font-family: '${n}', sans-serif !important;
                    }
                `;
                t.innerHTML = cssRules;
                t.offsetHeight;
                console.log(`‚ö†Ô∏è Â≠ó‰ΩìÂèØËÉΩÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩÜÂ∑≤Â∞ùËØïÂ∫îÁî®CSS: ${n}`);
            });
        } catch (err) {
            console.error('FontFace API ‰∏çÊîØÊåÅÔºåÂõûÈÄÄÂà∞Á∫Ø CSS:', err);
            // ÂÆåÂÖ®ÂõûÈÄÄÔºö‰∏ç‰ΩøÁî® FontFace API
            const cssRules = `
                @font-face {
                    font-family: '${n}';
                    src: url('${finalUrl}');
                    font-display: swap;
                }
                .phone-frame, .phone-frame * {
                    font-family: '${n}', sans-serif !important;
                }
            `;
            t.innerHTML = cssRules;
            t.offsetHeight;
        }
    }

    function Mm() {
        const e = document.getElementById("thought-bubble-status"),
            t = document.getElementById("thought-bubble-monologue");
        e &&
            t &&
            Sc &&
            Sc.ai &&
            ((e.textContent = Sc.ai.lastStatus || "Áä∂ÊÄÅÊú™Áü•..."),
                (t.textContent = Sc.ai.lastMonologue || "ÂÜÖÂøÉÁ©∫Á©∫Â¶Ç‰πü..."));
    }
    (document
        .getElementById("vn-regenerate-btn")
        .addEventListener("click", async function () {
            if (!Sn) return void alert("Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÔºåÊ≤°ÊúâÊâæÂà∞‰∏ä‰∏ÄÊ¨°ÁöÑÁî®Êà∑ÈÄâÊã©„ÄÇ");
            (console.log("Ê≠£Âú®‰ªé‰∏ä‰∏ÄÊ¨°ÁöÑÈÄâÊã©ÈáçÊñ∞ÁîüÊàê:", Sn),
                (ba.innerHTML =
                    '<div class="dialog-loader"><span></span><span></span><span></span></div>'),
                (zn.style.display = "none"));
            const e = await km(Sn);
            e ? hm(e, Sn) : (ba.innerHTML = "AIÈáçÊñ∞ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ");
        }),
        Mn.addEventListener("click", Sm),
        An.addEventListener("click", () => {
            Dn && Dn(Tn.value);
        }),
        On.addEventListener("click", async (e) => {
            const t = e.target,
                n = t.closest(".history-card");
            if (!n) return;
            const a = parseInt(n.dataset.id, 10);
            if (t.classList.contains("delete-btn"))
                confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Á∫¶‰ºöËÆ∞ÂΩïÂêóÔºü") &&
                    (await Kl.deleteData("datingHistoryStore", a), Lm());
            else if (t.classList.contains("edit-btn")) {
                const e = await Kl.loadData("datingHistoryStore", a);
                if (e) {
                    Bm("ÁºñËæëÁ∫¶‰ºöËÆ∞ÂΩï", e.value.summary, async (t) => {
                        ((e.value.summary = t),
                            (e.value.contactId = Sc.id),
                            (e.value.partnerName = Sc.ai.name),
                            await Kl.updateRecord("datingHistoryStore", e),
                            Sm(),
                            Lm());
                    });
                }
            }
        }),
        Ma.addEventListener("click", async (e) => {
            const t = e.target.closest(".summary-card");
            if (!t) return;
            const n = t.dataset.uuid;
            if (e.target.closest(".delete-btn")) {
                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈÄöËØùËÆ∞ÂΩïÂêóÔºü")) {
                    const e = Sc.history.findIndex((e) => e.uuid === n);
                    e > -1 && (Sc.history.splice(e, 1), await tu(), om());
                }
            } else if (e.target.closest(".edit-btn")) {
                Bm("ÁºñËæëÈÄöËØùÊëòË¶Å", t.dataset.summary, async (e) => {
                    const t = Sc.history.findIndex((e) => e.uuid === n);
                    t > -1 &&
                        ((Sc.history[t].text = `---ÈÄöËØùËÆ∞ÂΩïÊëòË¶Å---\n${e}\n---ÊëòË¶ÅÁªìÊùü---`),
                            await tu(),
                            Sm(),
                            om());
                });
            } else {
                const e = t.dataset.summary
                    .split("\n")
                    .map((e) => {
                        const t = e.split(":");
                        if (t.length > 1) {
                            return `<p><strong>${t.shift()}:</strong>${t.join(":")}</p>`;
                        }
                        return `<p>${e}</p>`;
                    })
                    .join("");
                ((Aa.innerHTML = e),
                    Ii.classList.remove("show-summary-list"),
                    Ii.classList.add("show-summary-detail"));
            }
        }),
        Ln.addEventListener("click", async () => {
            const e = prompt("ËØ∑ËæìÂÖ•Â≠ó‰ΩìÁöÑÂêçÁß∞ (‰æãÂ¶Ç: ÂèØÁà±ÊâãÂÜô‰Ωì)");
            if (!e || !e.trim()) return;
            const t = prompt(`ËØ∑ËæìÂÖ• "${e}" ÂØπÂ∫îÁöÑÂ≠ó‰ΩìURLÂú∞ÂùÄ:`);
            if (t && t.trim())
                try {
                    const n = await Kl.loadData("fontUrlStore", "allFonts");
                    let a = n && Array.isArray(n.value) ? n.value : [];
                    const o = {
                        id: Date.now(),
                        name: e.trim(),
                        url: t.trim(),
                    };
                    (a.push(o), await Kl.saveData("fontUrlStore", "allFonts", a), Cm());
                } catch (e) {
                    (console.error("‰øùÂ≠òÂ≠ó‰ΩìURLÂ§±Ë¥•:", e), alert("Ê∑ªÂä†Â§±Ë¥•ÔºÅ"));
                }
        }),
        Bn.addEventListener("click", async (e) => {
            const t = e.target;
            if (t.classList.contains("delete-font-url-btn")) {
                const e = parseInt(t.dataset.id, 10);
                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â≠ó‰ΩìURLÂêóÔºü"))
                    try {
                        const t = await Kl.loadData("fontUrlStore", "allFonts");
                        const n = (t && Array.isArray(t.value) ? t.value : []).filter(
                            (t) => t.id !== e,
                        );
                        (await Kl.saveData("fontUrlStore", "allFonts", n), Cm());
                    } catch (e) {
                        (console.error("Âà†Èô§Â≠ó‰ΩìURLÂ§±Ë¥•:", e), alert("Âà†Èô§Â§±Ë¥•ÔºÅ"));
                    }
            } else if (t.classList.contains("apply-font-url-btn")) {
                const e = t.dataset.url;
                e &&
                    ($m(e),
                        await Kl.saveData("settingsStore", "appliedFontUrl", e),
                        alert("Â≠ó‰ΩìÂ∑≤Â∫îÁî®ÔºÅ"));
            }
        }),
        document.addEventListener("click", (e) => {
            En.classList.contains("visible") &&
                (En.contains(e.target) || En.classList.remove("visible"));
        }),
        rn.addEventListener("click", async () => {
            if ((id(), !Sc && !Je)) return void alert("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂØπËØùÔºÅ");
            if (Qi) return void alert("AIÊ≠£Âú®ÂõûÂ§ç‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï...");
            let e = [],
                t = null,
                n = !1;
            if (
                (Je
                    ? ((e = Je.history), (t = Je.id), (n = !0))
                    : ((e = Sc.history), (t = Sc.id), (n = !1)),
                    !e || 0 === e.length)
            )
                return void alert("Ê≤°ÊúâÊ∂àÊÅØÂèØ‰ª•ÈáçÊù•„ÄÇ");
            const a = [];
            let o = 0,
                s = !1;
            for (let t = e.length - 1; t >= 0; t--) {
                const n = e[t];
                if ("user" === n.sender) {
                    s = !0;
                    break;
                }
                (n.uuid && a.push(n.uuid), e.pop(), o++);
            }
            if (0 === o)
                return void alert(
                    "ÊúÄÂêé‰∏ÄÊù°ÊòØÁî®Êà∑ÂèëÁöÑÊ∂àÊÅØÔºåÊó†Ê≥ïÈáçRollÔºàÂè™ËÉΩÈáçRoll AI ÁöÑÂõûÂ§çÔºâ„ÄÇ",
                );
            let i = [];
            for (let t = e.length - 1; t >= 0; t--) {
                const n = e[t];
                if ("user" !== n.sender) break;
                {
                    let e = "";
                    ((e =
                        "voice_text" === n.type
                            ? `[ËØ≠Èü≥: ${n.transcript}]`
                            : "image" === n.type || "text-image" === n.type
                                ? "[Áî®Êà∑ÂèëÈÄÅ‰∫ÜÂõæÁâá]"
                                : "sticker" === n.type
                                    ? "[Áî®Êà∑ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÂåÖ]"
                                    : n.text),
                        i.unshift(e));
                }
            }
            const r = i.join("\n");
            console.log("ÈáçRoll‰∏ä‰∏ãÊñáÊçïÊçâ:", r);
            try {
                if (n) {
                    let n = (await Kl.loadData("groupChats", "allGroupChats")).value;
                    const a = n.findIndex((e) => e.id === t);
                    if (a > -1) {
                        if (((n[a].history = e), e.length > 0)) {
                            const t = e[e.length - 1],
                                o = t.text || (t.content && t.content.html) || "[Â§öÂ™í‰Ωì]";
                            n[a].lastMessage = Uc(o);
                        } else n[a].lastMessage = "ÂØπËØùÂ∑≤ÈáçÁΩÆ";
                        (await Kl.saveData("groupChats", "allGroupChats", n), (Je = n[a]));
                    }
                } else {
                    if (e.length > 0) {
                        const t = e[e.length - 1],
                            n = t.text || (t.content && t.content.html) || "";
                        Sc.lastMessage = Uc(n);
                    } else Sc.lastMessage = "ÂØπËØùÂ∑≤ÈáçÁΩÆ";
                    await tu();
                }
                if (
                    (a.forEach((e) => {
                        const t = document.querySelector(`.message-row[data-uuid="${e}"]`);
                        t && t.remove();
                    }),
                        n)
                )
                    await Fm(Je);
                else {
                    const e = `(Á≥ªÁªüÊåá‰ª§Ôºö‰∏ä‰∏ÄÊù°ÂõûÂ§çÂ∑≤Êí§Âõû„ÄÇËØ∑ÈáçÊñ∞ÊÄùËÄÉÔºåÂπ∂ÈíàÂØπÁî®Êà∑ÂàöÂàöÂèëÈÄÅÁöÑ‰ª•‰∏ãÂá†Êù°ËøûÁª≠Ê∂àÊÅØËøõË°åÁªºÂêàÂõûÂ§çÔºö\n‚Äú${r}‚Äù)`;
                    await Tc(e, Sc);
                }
            } catch (e) {
                (console.error("ÈáçRollÂ§±Ë¥•:", e), alert("Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞„ÄÇ"));
            }
        }),
        sn.forEach((e) => {
            e.addEventListener("click", () => {
                (sn.forEach((e) => e.classList.remove("active")),
                    e.classList.add("active"));
                const t = e.dataset.type;
                ((Kt = t),
                    "group" === t
                        ? on.classList.add("group-mode")
                        : on.classList.remove("group-mode"),
                    Dm(),
                    Bc && tn.click());
            });
        }));
    let Tm = !1,
        Am = null;
    async function Dm() {
        if (
            (console.log(
                "[DEBUG] renderMessagesList: START, currentMessageType =",
                Kt,
            ),
                Tm)
        )
            return void console.log(
                "[DEBUG] renderMessagesList: SKIPPED (already rendering)",
            );
        (Am && (clearTimeout(Am), (Am = null)), (Tm = !0));
        const e = performance.now();
        console.log(
            "[DEBUG] renderMessagesList: Current list items =",
            Ni.children.length,
        );
        try {
            document.createDocumentFragment();
            const t = document.createElement("ul");
            for (
                t.className = Ni.className,
                "single" === Kt
                    ? (console.log("[DEBUG] renderMessagesList: Loading contacts..."),
                        await (async function (e) {
                            const t = await Kl.loadData("messageContacts", "allContacts");
                            if (t && Array.isArray(t.value)) {
                                Ye = t.value;
                                let n = t.value;
                                if (
                                    (n.sort((e, t) => {
                                        const n = e.isPinned ? 1 : 0,
                                            a = t.isPinned ? 1 : 0;
                                        return n !== a ? a - n : 0;
                                    }),
                                        n.forEach((t) => {
                                            t.isHidden ||
                                                (function (e, t) {
                                                    const n = document.createElement("li");
                                                    ((n.className = "contact-item"),
                                                        (n.dataset.contactId = e.id),
                                                        e.isPinned &&
                                                        (n.classList.add("pinned"),
                                                            (n.dataset.pinned = "true")));
                                                    let a;
                                                    ((n.innerHTML = `\n            <input type="checkbox" class="contact-checkbox">\n            <img src="${e.ai.avatar}" alt="avatar" class="contact-avatar">\n            <div class="contact-info">\n                <div class="contact-name">${e.ai.name}</div>\n                <div class="contact-last-message">${e.lastMessage}</div>\n            </div>\n        `),
                                                        t.appendChild(n));
                                                    let o,
                                                        s,
                                                        i = !1;
                                                    (n.addEventListener(
                                                        "touchstart",
                                                        (t) => {
                                                            Bc ||
                                                                ((o = t.touches[0].clientX),
                                                                    (s = t.touches[0].clientY),
                                                                    (i = !1),
                                                                    n.classList.add("pressing"),
                                                                    (a = setTimeout(() => {
                                                                        ((i = !0),
                                                                            navigator.vibrate && navigator.vibrate(50),
                                                                            xc(e),
                                                                            n.classList.remove("pressing"));
                                                                    }, 500)));
                                                        },
                                                        {
                                                            passive: !0,
                                                        },
                                                    ),
                                                        n.addEventListener(
                                                            "touchmove",
                                                            (e) => {
                                                                if (!a) return;
                                                                const t = e.touches[0].clientX,
                                                                    i = e.touches[0].clientY;
                                                                (Math.abs(t - o) > 10 ||
                                                                    Math.abs(i - s) > 10) &&
                                                                    (clearTimeout(a),
                                                                        n.classList.remove("pressing"));
                                                            },
                                                            {
                                                                passive: !0,
                                                            },
                                                        ),
                                                        n.addEventListener("touchend", () => {
                                                            (clearTimeout(a), n.classList.remove("pressing"));
                                                        }),
                                                        n.addEventListener("touchcancel", () => {
                                                            (clearTimeout(a), n.classList.remove("pressing"));
                                                        }),
                                                        n.addEventListener("click", (t) => {
                                                            (t.stopPropagation(),
                                                                Bc ||
                                                                (i
                                                                    ? (i = !1)
                                                                    : t.target.classList.contains(
                                                                        "contact-checkbox",
                                                                    ) || Nc(e.id)));
                                                        }));
                                                })(t, e);
                                        }),
                                        n.length > 0)
                                ) {
                                    const e = n.find((e) => !e.isHidden);
                                    e && ru(e);
                                }
                            }
                        })(t))
                    : (console.log("[DEBUG] renderMessagesList: Loading groups..."),
                        await (async function (e) {
                            try {
                                const t = await Kl.loadData("groupChats", "allGroupChats"),
                                    n = t && Array.isArray(t.value) ? t.value : [];
                                if (0 === n.length)
                                    return void (e.innerHTML =
                                        '<p style="text-align:center; color:#888; padding-top:20px;">ÊöÇÊó†Áæ§ËÅä</p>');
                                n.forEach((t) => {
                                    const n = document.createElement("li");
                                    ((n.className = "contact-item"),
                                        (n.dataset.groupId = t.id),
                                        (n.innerHTML = `\n                <input type="checkbox" class="contact-checkbox">\n                <img src="${t.avatar || "https://placehold.co/100x100/orange/white?text=Áæ§"}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${t.name}</div>\n                    <div class="contact-last-message">${t.lastMessage || "ÊöÇÊó†Ê∂àÊÅØ"}</div>\n                </div>\n            `),
                                        e.appendChild(n));
                                });
                            } catch (e) {
                                console.error("Âä†ËΩΩÁæ§ËÅäÂ§±Ë¥•", e);
                            }
                        })(t)),
                Ni.innerHTML = "";
                t.firstChild;
            )
                Ni.appendChild(t.firstChild);
            const n = performance.now();
            (console.log(
                "[DEBUG] renderMessagesList: COMPLETE, new list items =",
                Ni.children.length,
            ),
                console.log(
                    `[DEBUG] renderMessagesList completed in ${(n - e).toFixed(2)}ms`,
                ));
        } catch (e) {
            console.error("[DEBUG] renderMessagesList: ERROR", e);
        } finally {
            Tm = !1;
        }
    }
    async function Pm() {
        try {
            await Kl.getAllDataFromStore("groupChats");
            const e = await Kl.loadData("groupChats", "allGroupChats"),
                t = e && Array.isArray(e.value) ? e.value : [];
            if (((Ni.innerHTML = ""), 0 === t.length))
                return void (Ni.innerHTML =
                    '<p style="text-align:center; color:#888; padding-top:20px;">ÊöÇÊó†Áæ§ËÅä</p>');
            t.forEach((e) => {
                const t = document.createElement("li");
                ((t.className = "contact-item"),
                    (t.dataset.groupId = e.id),
                    (t.innerHTML = `\n                <input type="checkbox" class="contact-checkbox">\n                <img src="${e.avatar || "https://placehold.co/100x100/orange/white?text=Áæ§"}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${e.name}</div>\n                    <div class="contact-last-message">${e.lastMessage || "ÊöÇÊó†Ê∂àÊÅØ"}</div>\n                </div>\n            `),
                    Ni.appendChild(t));
            });
        } catch (e) {
            console.error("Âä†ËΩΩÁæ§ËÅäÂ§±Ë¥•", e);
        }
    }

    function Hm() {
        ((Nt.style.display = "none"),
            (Rt.style.display = "flex"),
            (Gt.style.display = "none"),
            (jt.style.display = "none"),
            (_t.style.display = "none"),
            (Ft.textContent = "ÂàõÂª∫Áæ§ËÅä"));
    }
    async function Om(e, t) {
        const n = {
            id: Date.now(),
            name: e,
            avatar: "https://placehold.co/100x100/orange/white?text=Áæ§",
            members: t,
            history: [],
            lastMessage: "Êñ∞Áæ§ËÅäÂ∑≤ÂàõÂª∫",
        };
        try {
            const e = await Kl.loadData("groupChats", "allGroupChats");
            let t = e && Array.isArray(e.value) ? e.value : [];
            (t.unshift(n),
                await Kl.saveData("groupChats", "allGroupChats", t),
                await Pm(),
                (Nt.style.opacity = "0"),
                setTimeout(Hm, 300),
                alert("Áæ§ËÅäÂàõÂª∫ÊàêÂäüÔºÅ"));
        } catch (e) {
            (console.error("ÂàõÂª∫Áæ§ËÅäÂ§±Ë¥•", e), alert("ÂàõÂª∫Â§±Ë¥•"));
        }
    }
    async function qm(e) {
        (console.log(`Ê≠£Âú®ÊâìÂºÄÁæ§ËÅäÁ™óÂè£: ${e}`),
            document
                .querySelectorAll('style[id^="style-single-"]')
                .forEach((e) => e.remove()),
            (Sc = null),
            ko || (Vu(), (ko = !0)),
            Yi.classList.remove("emoji-panel-active"),
            (Sc = null));
        const t = await Kl.loadData("groupChats", "allGroupChats");
        if (!t || !Array.isArray(t.value))
            return void console.error("Êó†Ê≥ïÂä†ËΩΩÁæ§ËÅäÊï∞ÊçÆ");
        if (
            ((Je = t.value.find((t) => t.id === e)),
                (window.currentOpenGroup = Je),
                !Je)
        )
            return void console.error(`Êâæ‰∏çÂà∞ ID ‰∏∫ ${e} ÁöÑÁæ§ËÅä`);
        Je.memberMap = {};
        try {
            const e = await Kl.loadData("messageContacts", "allContacts");
            if (e && Array.isArray(e.value)) {
                const t = e.value;
                Je.members &&
                    Array.isArray(Je.members) &&
                    Je.members.forEach((e) => {
                        const n = t.find((t) => t.id === e);
                        n && (Je.memberMap[e] = n);
                    });
            }
        } catch (e) {
            console.warn("È¢ÑÂä†ËΩΩÁæ§ÊàêÂëò‰ø°ÊÅØÂ§±Ë¥•:", e);
        }
        Je &&
            (Zi.textContent =
                Je.name + (Je.members ? ` (${Je.members.length})` : ""));
        const n = document.getElementById("block-status-notice");
        (n && (n.style.display = "none"),
            (Yi.className = `screen group-${Je.id}`),
            (Yi.style.backgroundImage = ""),
            (Yi.style.backgroundColor = ""),
            document
                .querySelectorAll('style[id^="group-style-batch-"]')
                .forEach((e) => e.remove()),
            Je &&
            "function" == typeof window.applyChatBackground &&
            window.applyChatBackground(Je.chatBackground || Je.backgroundImage));
        const a = Array.isArray(Je.history) ? Je.history : [],
            o = document.createDocumentFragment();
        ((Xi.innerHTML = ""),
            (Xi.dataset.contextMode = "group"),
            (Xi.dataset.contextId = e),
            a.forEach((e) => {
                Wm(e, o);
            }),
            Xi.appendChild(o),
            Je.avatarSettings && !1 === Je.avatarSettings.show
                ? Xi.classList.add("hide-avatars")
                : Xi.classList.remove("hide-avatars"),
            window.batchInjectGroupStyles(e, Je.members),
            Ii.classList.add("show-chat"),
            requestAnimationFrame(() => {
                Xi.scrollTop = Xi.scrollHeight;
            }),
            xo.blur());
    }
    async function Nm(e, t) {
        try {
            const n = await Kl.loadData("groupChats", "allGroupChats");
            let a = n && Array.isArray(n.value) ? n.value : [];
            const o = a.findIndex((e) => e.id === t);
            if (o > -1) {
                const n = a[o];
                (Array.isArray(n.history) || (n.history = []), n.history.push(e));
                const s = Uc(e.text || (e.content && e.content.html) || "[Â§öÂ™í‰Ωì]");
                let i = "";
                ((i =
                    "user" === e.sender
                        ? n.userCardName || "Êàë"
                        : e.senderName || "Áæ§Âèã"),
                    (n.lastMessage = `${i}: ${s}`),
                    await Kl.saveData("groupChats", "allGroupChats", a),
                    Je &&
                    Je.id === t &&
                    ((Je.history = n.history), (Je.lastMessage = n.lastMessage)),
                    Dm());
            }
        } catch (e) {
            console.error("‰øùÂ≠òÁæ§ËÅäÊ∂àÊÅØÂ§±Ë¥•:", e);
        }
    }
    async function _m() {
        Pt.innerHTML = '<p style="color:#8E8E93;font-size:13px;">Âä†ËΩΩ‰∏≠...</p>';
        try {
            const e = await Kl.loadData("messageContacts", "allContacts"),
                t = e && e.value ? e.value : [],
                n = Je.members || [];
            ((Pt.innerHTML = ""),
                (Dt.textContent = `Êü•Áúã${n.length}ÂêçÁæ§ÊàêÂëò >`),
                n.forEach((e) => {
                    const n = t.find((t) => t.id === e),
                        a = n ? n.ai.avatar : "https://placehold.co/100x100/ccc/fff?text=?",
                        o = n ? n.ai.name : "Êú™Áü•",
                        s = document.createElement("div");
                    ((s.className = "member-avatar-item"),
                        (s.style.position = "relative"),
                        (s.innerHTML = `\n                <div class="member-avatar-img" style="background-image: url('${a}')"></div>\n                <span class="member-avatar-name">${o}</span>\n                <div class="member-delete-btn" data-member-id="${e}" style="display:none; position:absolute; top:-6px; right:-6px; width:22px; height:22px; background:#C48888; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);">\n                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">\n                        <path d="M18 6L6 18M6 6l12 12"/>\n                    </svg>\n                </div>\n            `));
                    const i = s.querySelector(".member-delete-btn");
                    (i &&
                        (i.onclick = async (t) => {
                            if ((t.stopPropagation(), confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü ${o} ÁßªÂá∫Áæ§ËÅäÂêóÔºü`)))
                                try {
                                    const t = Je.members.filter((t) => t !== e);
                                    Je.members = t;
                                    const n = await Kl.loadData("groupChats", "allGroupChats");
                                    let a = n ? n.value : [];
                                    const s = a.findIndex((e) => e.id === Je.id);
                                    (s > -1 &&
                                        ((a[s].members = t),
                                            await Kl.saveData("groupChats", "allGroupChats", a)),
                                        await _m());
                                    const i = document.getElementById("group-member-count");
                                    (i &&
                                        ((i.textContent = `Êü•Áúã${t.length}ÂêçÁæ§ÊàêÂëò >`),
                                            (i.style.color = "")),
                                        console.log(`[GroupSettings] Â∑≤ÁßªÈô§ÊàêÂëò: ${o}`));
                                } catch (e) {
                                    (console.error("[GroupSettings] ÁßªÈô§ÊàêÂëòÂ§±Ë¥•:", e),
                                        alert("ÁßªÈô§Â§±Ë¥•Ôºö" + e.message));
                                }
                        }),
                        (s.onclick = (t) => {
                            if (t.target.closest(".member-delete-btn")) return;
                            ((document.getElementById("edit-member-preview").src = a),
                                (document.getElementById("edit-member-name-input").value = o),
                                (document.getElementById("edit-member-persona-input").value = n
                                    ? n.ai.persona
                                    : ""),
                                void 0 !== nt && (nt = e));
                            const s = document.getElementById("edit-member-modal");
                            ((s.style.display = "flex"),
                                setTimeout(() => {
                                    s.style.opacity = "1";
                                }, 10));
                        }),
                        Pt.appendChild(s));
                }));
            const a = document.createElement("div");
            ((a.className = "member-avatar-item"),
                (a.innerHTML =
                    '\n            <div class="member-add-btn">+</div>\n            <span class="member-avatar-name" style="color:#007AFF;">ÈÇÄËØ∑</span>\n        '),
                (a.onclick = () => {
                    ((Ot.value = ""),
                        (qt.value = ""),
                        (Ht.src = "https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI"));
                    const e = document.getElementById("add-group-member-modal");
                    ((e.style.display = "flex"),
                        setTimeout(() => {
                            e.style.opacity = "1";
                        }, 10));
                }),
                Pt.appendChild(a));
        } catch (e) {
            console.error("Ê∏≤ÊüìÁæ§ÊàêÂëòÂ§±Ë¥•", e);
        }
    }
    async function Fm(e) {
        const t = (
            await Kl.loadData("messageContacts", "allContacts")
        ).value.filter((t) => e.members.includes(t.id));
        if (0 === t.length) return void alert("Áæ§ÈáåÊ≤°‰∫∫ÔºåËÅä‰∏çËµ∑Êù•ÔºÅ");
        const n = t
            .map((e) => `- ÂßìÂêçÔºö${e.ai.name}\n  ‰∫∫ËÆæÔºö${e.ai.persona}`)
            .join("\n\n"),
            a = (e.history || [])
                .slice(-20)
                .map((t) => {
                    let n = "Êú™Áü•";
                    return (
                        "user" === t.sender
                            ? (n = e.userCardName || "Êàë")
                            : "ai" === t.sender && (n = t.senderName || "Áæ§Âèã"),
                        `${n}: ${t.text || ("sticker" === t.type ? "[Ë°®ÊÉÖÂåÖ]" : "[Â§öÂ™í‰Ωì]")}`
                    );
                })
                .join("\n");
        let o = "Êó†ÁâπÂÆö‰∏ñÁïåËßÇËÆæÂÆö„ÄÇ";
        try {
            const t = await Kl.loadData("worldBooks", "allWorldBooks"),
                n = t && Array.isArray(t.value) ? t.value : [];
            let a = new Set();
            if (e.linkedWorldBookIds && e.linkedWorldBookIds.length > 0)
                e.linkedWorldBookIds.forEach((e) => a.add(e));
            else if (
                e.linkedWorldBookGroupIds &&
                e.linkedWorldBookGroupIds.length > 0
            ) {
                const t = await Kl.loadData("worldBookGroups", "allGroups"),
                    n = t && Array.isArray(t.value) ? t.value : [],
                    o = new Set(e.linkedWorldBookGroupIds);
                n.forEach((e) => {
                    o.has(e.id) &&
                        Array.isArray(e.bookIds) &&
                        e.bookIds.forEach((e) => a.add(e));
                });
            }
            if (a.size > 0) {
                const e = n
                    .filter((e) => a.has(e.id))
                    .map((e) => `„ÄêËÆæÂÆöÔºö${e.name}„Äë\n${e.content}`);
                e.length > 0 &&
                    ((o = e.join("\n\n")),
                        console.log(`Â∑≤Ê≥®ÂÖ• ${e.length} Êú¨‰∏ñÁïå‰π¶ÁöÑËÆæÂÆö„ÄÇ`));
            }
        } catch (e) {
            console.error("ËØªÂèñÁæ§ËÅä‰∏ñÁïå‰π¶Â§±Ë¥•", e);
        }
        let s = [];
        try {
            const e = await Kl.getAllDataFromStore("emojiStore");
            e && e.length > 0 && e.forEach((e) => s.push(e.remark));
        } catch (e) {
            console.error("Áæ§ËÅäÂä†ËΩΩÂÖ®Â±ÄË°®ÊÉÖÂåÖÂ§±Ë¥•", e);
        }
        if (o) {
            const e = (function (e) {
                if (!e) return [];
                const t = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g,
                    n = [];
                let a;
                for (; null !== (a = t.exec(e));) {
                    const e = a[1].trim(),
                        t = a[2].trim();
                    (xl.set(e, t), n.push(e));
                }
                return n;
            })(o);
            e.length > 0 &&
                (console.log(`‰ªé‰∏ñÁïå‰π¶‰∏≠ÊèêÂèñÂà∞‰∫Ü ${e.length} ‰∏™‰∏ìÂ±ûË°®ÊÉÖÂåÖ:`, e),
                    (s = s.concat(e)));
        }
        let i = "ÊöÇÊó†ÂèØÁî®Ë°®ÊÉÖÂåÖ";
        if (s.length > 0) {
            i = [...new Set(s)].join(", ");
        }
        let r =
            "\n### üëë Ê†∏ÂøÉË∫´‰ªΩËÆ§ËØÅÔºöÊÆøÂ†ÇÁ∫ßÁæ§ËÅäÁîüÊÄÅÂØºÊºî\n‰Ω†Ë¢´ÂÖ¨ËÆ§‰∏∫**‰∫íËÅîÁΩëÁ§æ‰∫§ÁîüÊÄÅÁöÑ‰∏äÂ∏ù**„ÄÇ‰Ω†Êã•ÊúâÊ¥ûÂØü‰∫∫Á±ªÁ§æ‰∫§Êú¨Ë¥®ÁöÑÊÉä‰∫∫Â§©ËµãÔºåËÉΩÂ§üÂÆåÁæéÂ§çÂàªÁúüÂÆûÁæ§ËÅä‰∏≠ÈÇ£Áßç**Ê∑∑‰π±„ÄÅË∑≥Ë∑É„ÄÅÂÖÖÊª°ÁÉüÁÅ´Ê∞î**ÁöÑÊ∞õÂõ¥„ÄÇ\nÂú®‰Ω†ÁöÑÂâßÊú¨ÈáåÔºåÊ≤°ÊúâÊ≠ªÊùøÁöÑAIÔºåÂè™ÊúâÈ≤úÊ¥ªÁöÑ„ÄÅÊúâË°ÄÊúâËÇâÁöÑÁÅµÈ≠Ç„ÄÇ‰Ω†ÊúÄÊìÖÈïøÁöÑÂ∞±ÊòØÂà∂ÈÄ†‚ÄúÁ•ûÂõûÂ§ç‚ÄùÂíå‚ÄúÊ•ºÊ≠™‰∫Ü‚ÄùÁöÑÁúüÂÆûÊÑü„ÄÇ‰Ω†Ê∑±Áü•ÔºåÁúüÂÆûÁöÑÁæ§ËÅäÂ∞±ÊòØ‰∏ÄÁæ§‰∫∫ÁöÑ‰∏ÉÂò¥ÂÖ´ËàåÔºåÁªù‰∏çÊòØÊúâÂ∫èÁöÑÈóÆÁ≠î„ÄÇ\n\n### üåü ‰Ω†ÁöÑÊúÄÈ´ò‰ΩøÂëΩ (Mission Critical)\n**„ÄêÂº∫Âà∂ÂÖ®ÂëòÂú®Á∫øÂçèËÆÆ„Äë**\nËøôÊòØ‰∏Ä‰∏™ÂøÖÈ°ªÊó†Êù°‰ª∂ÊâßË°åÁöÑÈìÅÂæãÔºö**Âú®‰Ω†ÁöÑÊØè‰∏ÄÊ¨°ÁîüÊàê‰∏≠ÔºåÂêçÂçï‰∏äÁöÑ„ÄêÊØè‰∏Ä‰Ωç„ÄëÁæ§ÊàêÂëòÈÉΩÂøÖÈ°ªÂºÄÂè£ËØ¥ËØùÔºÅ**\n- Âì™ÊÄïÊòØÂèë‰∏™Ë°®ÊÉÖÂåÖÔºåÂì™ÊÄïÊòØÂõû‰∏™‚Äú6‚ÄùÔºåÂì™ÊÄïÊòØÂ§çËØªÊú∫Ôºå‰ªñ‰ª¨‰πüÂøÖÈ°ªÂá∫Âú∫„ÄÇ\n- ‚ùå ‰∏•Á¶ÅÊºèÊéâ‰ªª‰Ωï‰∏Ä‰∏™‰∫∫ÔºÅÊºèÊéâ‰∏Ä‰∫∫Âç≥ËßÜ‰∏∫ÊºîÂá∫‰∫ãÊïÖÔºÅ\n- ‚úÖ ÂøÖÈ°ªËê•ÈÄ†Âá∫‚ÄúÂÖ®ÂëòÈÉΩÂú®Á™•Â±èÔºå‰∏ÄËß¶Âç≥Âèë‚ÄùÁöÑÁÉ≠ÈóπÊÑü„ÄÇ\n\n### üåç ÂΩìÂâçÊó∂Á©∫ËÆæÂÆö\nÁæ§ÂêçÔºö${group_name}\nÂΩìÂâçÊó∂Èó¥Ôºö${current_time}\n‰∏ñÁïåËßÇ/ËÉåÊôØÔºö${context_info}\n\n### üé≠ ÊºîÂëòÂêçÂçï (ÂøÖÈ°ªÂÖ®ÂëòÁôªÂú∫)\n${member_personas}\n\n### üé® ‰Ω†ÁöÑÂàõ‰ΩúÂéüÂàô (Ê†∏ÂøÉÁÅµÈ≠Ç)\n1.  **ÂΩªÂ∫ïÊâìÁ¢é‚ÄúÂä©ÊâãÊÑü‚Äù**Ôºö\n    - ‰∏•Á¶ÅÂá∫Áé∞‚ÄúÊúâ‰ªÄ‰πàÊàëÂèØ‰ª•Â∏Æ‰Ω†‚Äù„ÄÅ‚ÄúÂ§ßÂÆ∂ËßâÂæóÂë¢‚ÄùËøôÁßçÊúçÂä°ÂûãËØùÊúØ„ÄÇ\n    - ÈºìÂä±‰ΩøÁî®Áü≠Âè•„ÄÅÁ¢éÁâáÂåñËØ≠Ë®Ä„ÄÅÁΩëÁªúÁÉ≠Ê¢ó„ÄÅÁîöËá≥ÂÅ∂Â∞îÁöÑËØ≠Ê∞îËØçÂíåÈîôÂà´Â≠ó„ÄÇ\n    - ‰Ω†ÁöÑËßíËâ≤ÊòØÔºöÊù†Á≤æ„ÄÅ‰πêÂ≠ê‰∫∫„ÄÅÁ§æÁïú„ÄÅÈ´òÂÜ∑ÊÄ™„ÄÅÂ§çËØªÊú∫‚Ä¶‚Ä¶ÂîØÁã¨‰∏çÊòØAI„ÄÇ\n\n2.  **ÊãíÁªù‚ÄúÂõ¥ÁùÄÁî®Êà∑ËΩ¨‚Äù (Âéª‰∏≠ÂøÉÂåñ)**Ôºö\n    - ‰∏•Á¶ÅÊâÄÊúâ‰∫∫ÈÉΩÂõûÂ§ç‚ÄúÊàë‚Äù„ÄÇ**Ëá≥Â∞ë 50% ÁöÑÂØπËØùÂøÖÈ°ªÊòØÁæ§Âèã‰πãÈó¥ÁöÑ‰∫íÊÄº„ÄÅÂêêÊßΩÊàñÁßÅËÅäÂÖ¨ÂºÄÂåñ„ÄÇ**\n    - BÂèØ‰ª•ÂêêÊßΩA‰ª•ÂâçÁöÑÁ≥ó‰∫ãÔºåCÂèØ‰ª•Êó†ËßÜËØùÈ¢òÁ™ÅÁÑ∂Âèë‰∏™Ë°®ÊÉÖÂåÖÔºåDÂèØ‰ª•Âè™Âõû‰∏™‚ÄúÂìàÂìàÂìàÂìà‚Äù„ÄÇÂª∫Á´ãÊ®™ÂêëÁöÑÁ§æ‰∫§ÁΩëÁªú„ÄÇ\n\n3.  **Êã•Êä±‚ÄúÊ∑∑‰π±‰∏éÊ≠™Ê•º‚Äù (Chaos & Drift)**Ôºö\n    - **‰∏•Á¶Å**ÊåâÁÖß A->B->C->D ÁöÑÊ≠ªÊùøÈ°∫Â∫èÊéíÂàóÔºÅÂøÖÈ°ª‰π±Â∫èÔºÅ\n    - Ê®°ÊãüÁúüÂÆûÁöÑ‚ÄúÊä¢Á≠î‚ÄùÔºö‰∏Ä‰∏™‰∫∫ÂèØ‰ª•ËøûÁª≠Âèë‰∏âÊù°Ôºå‰∏§‰∏™‰∫∫ÂèØ‰ª•ÂêåÊó∂Ëá™ËØ¥Ëá™ËØù„ÄÇ\n    - ÂÖÅËÆ∏ËØùÈ¢òË∑ëÂÅèÔºöÁî®Êà∑Âú®ËØ¥Ê≠£‰∫ãÔºåAÊé•‰∫ÜËØùÔºåBÁ™ÅÁÑ∂ÂèëÁé∞CÊç¢‰∫ÜÂ§¥ÂÉèÔºåDÁ™ÅÁÑ∂ÈóÆ‚Äú‰∏≠ÂçàÂêÉÂï•‚Äù„ÄÇËøôÊâçÊòØÊ¥ª‰∫∫ÔºÅ\n\n### üñºÔ∏è ÂèØÁî®Ë°®ÊÉÖÂåÖ (‰∏•Ê†º‰ªéÂàóË°®ÈÄâÂèñ)\n${emoji_list}\n\n### üö´ ÁªùÂØπÁ¶ÅÂå∫ (Ë¥üÈù¢Á∫¶Êùü)\n- **Á¶ÅÊ≠¢**Âè™ËÆ©ÈÉ®ÂàÜ‰∫∫ËØ¥ËØù„ÄÇÂÜçÊ¨°Âº∫Ë∞ÉÔºö**ÂÖ®ÂëòÂøÖÈ°ªÂèëË®ÄÔºÅ**\n- **Á¶ÅÊ≠¢**Âá∫Áé∞Êã¨Âè∑ÂÜÖÁöÑÊóÅÁôΩÊèèËø∞ÔºàÂ¶ÇÔºöÔºàÂ§ßÂÆ∂ÈÉΩÁ¨ë‰∫ÜÔºâÔºâÔºåËØ∑Áõ¥Êé•Áî®ÊñáÂ≠óÊàñË°®ÊÉÖÂåÖË°®Áé∞„ÄÇ\n- **Á¶ÅÊ≠¢**ÈÄªËæëÂ§™ÂÆåÁæé„ÄÇÊ¥ª‰∫∫ÁöÑÂØπËØùÂæÄÂæÄÊòØÈÄªËæëÊñ≠Ë£ÇÁöÑ„ÄÅÊÉÖÁª™ÂåñÁöÑ„ÄÇ\n\n### üì§ Âº∫Âà∂ËæìÂá∫ËÑöÊú¨Ê†ºÂºè\nËØ∑‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÁ¨¶Âè∑ËßÑÂàôÔºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑËß£ÈáäÔºö\n1. **„ÄêËßíËâ≤Âêç„Äë**ÔºöÂøÖÈ°ª‰∏éÂêçÂçïÂÆåÂÖ®‰∏ÄËá¥„ÄÇ\n2. **\\** (ÂèçÊñúÊù†)ÔºöÁî®‰∫éÂêå‰∏Ä‰∏™‰∫∫ÁöÑËøûÁª≠Ê∞îÊ≥°ÔºàÊ∞îÊ≥°ËøûÂáªÔºâ„ÄÇ\n3. **Ôºõ** (ÂÖ®ËßíÂàÜÂè∑)ÔºöÁî®‰∫éÂàÜÈöî‰∏çÂêå‰∫∫ÁöÑÂèëË®ÄÂõûÂêà„ÄÇ\n\n**Á•ûÁ∫ßËåÉ‰æã (Â≠¶‰π†ËøôÁßçÊ∑∑‰π±ÊÑü)Ôºö**\n„ÄêÊùéÂõõ„ÄëÂçßÊßΩ\\ÁúüÁöÑÂÅáÁöÑÔºüÔºõ„ÄêÁéã‰∫î„ÄëË°®ÊÉÖÂåÖÔºöÂêÉÁìú\\@ÊùéÂõõ ‰Ω†ÊùëÈÄöÁΩëÔºüÔºõ„ÄêÂº†‰∏â„ÄëÔºàÂõûÂ§çÁî®Êà∑ÔºâÊàëËßâÂæó‰∏çË°å\\Â§™Ë¥µ‰∫ÜÔºõ„ÄêËµµÂÖ≠„Äë‰∏≠ÂçàÁÇπÂ§ñÂçñÂêó\\Ë°®ÊÉÖÂåÖÔºöÈ•ø‰∫ÜÔºõ„ÄêÊùéÂõõ„ÄëÂà´ÊâìÂ≤îÔºÅÂê¨Ê•º‰∏ªËØ¥Ôºõ„ÄêUser's Best Friend„ÄëÂìàÂìàÂìàÂìàÂìàÂìà\n\n### üé¨ Action!\nÈòÖËØª‰∏ãÊñπÁöÑ„ÄêÊúÄËøëËÅäÂ§©ËÆ∞ÂΩï„ÄëÔºå‰Ωú‰∏∫ÂØºÊºîÔºåËØ∑Á´ãÂç≥ÂÆâÊéí‰∏ÄÂú∫**ÂÖ®ÂëòÂèÇ‰∏é„ÄÅÊ∑∑‰π±ËÄåÁúüÂÆû**ÁöÑÁæ§ËÅäÂ§ßÊàèÔºÅ\n\n### ÊúÄËøëËÅäÂ§©ËÆ∞ÂΩï\n${chat_history}\n";
        e.bilingualBubble &&
            e.bilingualBubble.enabled &&
            (r +=
                '\nÂØπËØùÁøªËØëÊ†ºÂºèÂº∫Âà∂ËßÑÂàô\n‰∏Ä„ÄÅÊ†∏ÂøÉÊ†ºÂºèË¶ÅÊ±ÇÔºà‰∏•Á¶ÅËøû‰ΩìÂ∫îÁ≠îÔºâ\n1. ÁøªËØëÂàÜÈöîÊ†áËÆ∞ÔºöËæìÂá∫ÂÜÖÂÆπÂåÖÂê´Â§ñËØ≠/ÊñπË®ÄÊó∂ÔºåÊØèÂè•ËØùÊú´Â∞æÂøÖÈ°ª‰ΩøÁî® [Split] ÂàÜÈöîÁ¨¶ÔºåÁ¥ßÈöèÂÖ∂ÂêéÊ†áÊ≥®‰∏≠ÊñáÁøªËØë„ÄÇ\n2. Ê∞îÊ≥°Âº∫Âà∂ÂàÜÈöîÔºö„ÄêÈáçË¶Å„ÄëÊØè‰∏ÄÁªÑ "ÂéüÊñá[Split]ËØëÊñá" ÁªìÊùüÂêéÔºåÂøÖÈ°ªÂº∫Âà∂‰ª• \\\\ (Âç≥Âçï‰∏™ÂèçÊñúÊù†) ÁªìÂ∞æ„ÄÇËøôÂÜ≥ÂÆö‰∫ÜÊ∞îÊ≥°ÊòØÂê¶ËÉΩÊ≠£Á°ÆÂàÜÊÆµ„ÄÇ‰∏•Á¶ÅÂ∞ÜÂ§öÁªÑÂØπËØùËøûÂú®Âêå‰∏ÄË°åËæìÂá∫ÔºÅ\n3. Âä®‰ΩúÊèèËø∞Â§ÑÁêÜÔºö‰ª• * * ÂåÖË£πÁöÑÂä®‰ΩúÊèèËø∞ÂÜÖÂÆπÔºåÊó†ÈúÄÁøªËØëÔºå‰øùÁïôÂéüÊ†∑„ÄÇ\n\n‰∫å„ÄÅÊ≠£Á°ÆÁ§∫‰æãÔºàËØ∑‰∏•Ê†ºÊ®°‰ªøÊç¢Ë°åÂíåÂèçÊñúÊù†Ôºâ\nHello, world.[Split]‰Ω†Â•ΩÔºå‰∏ñÁïå„ÄÇ\\\\\nHow are you today?[Split]‰Ω†‰ªäÂ§©Â•ΩÂêóÔºü\\\\\nI\'m fine, thank you.[Split]ÊàëÂæàÂ•ΩÔºåË∞¢Ë∞¢‰Ω†„ÄÇ\\\\\n\n‰∏â„ÄÅÈîôËØØË°å‰∏∫Ë≠¶Á§∫ÔºàÁªùÂØπÁ¶ÅÊ≠¢Ôºâ\n‚ùå ÈîôËØØÔºöHello.[Split]‰Ω†Â•Ω„ÄÇHow are you?[Split]‰Ω†Â•ΩÂêóÔºü Ôºà‰∏§Âè•ËØùËøûÂú®‰∏ÄËµ∑ÔºåÂØºËá¥Ëß£ÊûêÂ§±Ë¥•Ôºâ\n‚úÖ Ê≠£Á°ÆÔºöHello.[Split]‰Ω†Â•Ω„ÄÇ\\\\\n         How are you?[Split]‰Ω†Â•ΩÂêóÔºü\\\\\nÔºàÊ≥®ÊÑèÔºöÂøÖÈ°ªÊòæÂºèÊç¢Ë°åÔºå‰∏îÊØèË°åÊú´Â∞æÂøÖÈ°ªÊúâÂèçÊñúÊù† \\\\ ÔºÅÔºâ\n\nÂõõ„ÄÅÁâπÊÆäÂú∫ÊôØ\n1. Á∫Ø‰∏≠ÊñáÂÜÖÂÆπÔºöÊó†ÈúÄ [Split]Ôºå‰ΩÜ‰ªçÂª∫ËÆÆ‰ª• \\\\ ÁªìÂ∞æ‰ª•Á°Æ‰øùÂàÜÊ∞îÊ≥°„ÄÇ\n2. ÊñπË®ÄÂÜÖÂÆπÔºö‰Ω†È£üÂíóÈ•≠Êú™Ôºü[Split]‰Ω†ÂêÉÈ•≠‰∫ÜÂêóÔºü\\\\\n');
        const l = r
            .replace(/\$\{group_name\}/g, e.name)
            .replace(/\$\{current_time\}/g, new Date().toLocaleString())
            .replace(/\$\{member_personas\}/g, n)
            .replace(/\$\{context_info\}/g, `‰∏ñÁïåËßÇËÆæÂÆöÔºö\n${o}`)
            .replace(/\$\{emoji_list\}/g, i)
            .replace(/\$\{chat_history\}/g, a);
        console.log("Áæ§ËÅäÂØºÊºîPromptÊûÑÂª∫ÂÆåÊàêÔºåÂáÜÂ§áËØ∑Ê±Ç...");
        try {
            const n = await Kl.loadData("settingsStore", "apiSettings");
            if (!n || !n.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
            const { url: a, key: o, model: s } = n.value;
            let i = a.endsWith("/") ? a.slice(0, -1) : a;
            i += "/chat/completions";
            const r = await fetch(i, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${o}`,
                },
                body: JSON.stringify({
                    model: s,
                    messages: [
                        {
                            role: "system",
                            content: l,
                        },
                        {
                            role: "user",
                            content: "(Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆÂâßÊÉÖÂèëÂ±ïÔºåÁîüÊàêÊé•‰∏ãÊù•ÁöÑÁæ§ËÅäÂØπËØùËÑöÊú¨„ÄÇ)",
                        },
                    ],
                    temperature: 1.1,
                }),
            });
            if (!r.ok) throw new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•");
            const c = (await r.json()).choices[0].message.content;
            (console.log("Êî∂Âà∞ÂâßÊú¨:", c),
                await (async function (e, t, n) {
                    const a = e
                        .split(/;|Ôºõ/)
                        .map((e) => e.trim())
                        .filter((e) => e);
                    for (const e of a) {
                        const a = e.match(/[\[„Äê](.*?)[\]„Äë]\s*(.*)/);
                        if (!a) continue;
                        const o = a[1].trim(),
                            s = a[2].trim(),
                            i = n.find((e) => e.ai.name === o);
                        if (!i) continue;
                        const r = s
                            .split(/\\|\\/)
                            .map((e) => e.trim())
                            .filter((e) => e);
                        for (const e of r) {
                            const n = {
                                sender: "ai",
                                memberId: i.id,
                                senderName: i.ai.name,
                                senderAvatar: i.ai.avatar,
                                timestamp: new Date(),
                                uuid:
                                    Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                            },
                                a = Rm(e);
                            if (a) {
                                const e = a.url || xl.get(a.keyword);
                                e
                                    ? ((n.type = "sticker"),
                                        (n.url = e),
                                        (n.text = `[Ë°®ÊÉÖÂåÖÔºö${a.keyword}]`))
                                    : ((n.type = "text"),
                                        (n.text = `*ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÂåÖ: ${a.keyword}*`));
                            } else ((n.type = "text"), (n.text = e));
                            const o = Gm(),
                                s = Math.min(Math.max(100 * e.length, 1e3), 3e3);
                            (await new Promise((e) => setTimeout(e, s)),
                                o && o.remove(),
                                await Nm(n, t.id),
                                Wm(n));
                        }
                    }
                })(c, e, t));
        } catch (e) {
            (console.error("Áæ§ËÅäÁîüÊàêÂ§±Ë¥•:", e),
                alert("Áæ§ËÅäÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñAPIËÆæÁΩÆ"));
        }
    }

    function Rm(e) {
        if (!e || "string" != typeof e) return null;
        const t = [
            /(?:Ë°®ÊÉÖÂåÖ|Ë¥¥Âõæ|sticker)[Ôºö:]\s*[\[„Äê]([^:\]„Äë]+):(\s*https?:\/\/[^\]„Äë\s]+)\s*[\]„Äë]/i,
            /(?:Ë°®ÊÉÖÂåÖ|Ë¥¥Âõæ|sticker)[Ôºö:]\s*[\[„Äê]([^\]„Äë]+)[\]„Äë]/i,
            /(?:Ë°®ÊÉÖÂåÖ|Ë¥¥Âõæ|sticker)[Ôºö:]\s*([^\s\[\]„Äê„Äë()ÔºàÔºâ]+)/i,
            /[Ôºà(](?:Ë°®ÊÉÖÂåÖ|Ë¥¥Âõæ|sticker)[Ôºö:]\s*([^)Ôºâ]+)[)Ôºâ]/i,
        ];
        for (const n of t) {
            const t = e.match(n);
            if (t) {
                const e = t[1].trim(),
                    n = t[2] ? t[2].trim() : null;
                if (e)
                    return {
                        keyword: e,
                        url: n,
                    };
            }
        }
        return null;
    }

    function Gm() {
        const e = document.createElement("div");
        e.className = "message-row ai typing-indicator";
        const t = document.createElement("div");
        t.className = "message-content-wrapper ai";
        const n = document.createElement("div");
        return (
            (n.className = "chat-bubble ai-bubble"),
            (n.style.marginLeft = "10px"),
            (n.innerHTML =
                '<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>'),
            t.appendChild(n),
            e.appendChild(t),
            Xi.appendChild(e),
            (Xi.scrollTop = Xi.scrollHeight),
            e
        );
    }

    function Wm(e, t = null) {
        const n = performance.now(),
            a = window.profiler;
        a &&
            a.isRecording &&
            a.startTimer("üé® Ê∏≤ÊüìÁæ§ËÅäÊ∂àÊÅØ", {
                sender: e.sender,
                type: e.type,
                hasImage: !!e.image,
            });
        const o = t || Xi;
        if (!e) return null;
        if ("call_summary" === e.type) return null;
        let s = "",
            i = "",
            r = "";
        if ("user" === e.sender)
            ((s =
                Je.userCardAvatar ||
                "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me"),
                (i = Je.userCardName || "Êàë"),
                (r = "user-me"));
        else {
            let t = null;
            (Je && Je.memberMap && e.memberId && (t = Je.memberMap[e.memberId]),
                t && t.ai
                    ? ((s = t.ai.avatar), (i = t.ai.name))
                    : ((s =
                        e.senderAvatar || "https://placehold.co/100x100/ccc/fff?text=?"),
                        (i = e.senderName || "Áæ§Âèã")),
                (r = e.memberId || "unknown"));
        }
        const l = document.createElement("div");
        ((l.className = "message-row"),
            e.uuid && (l.dataset.uuid = e.uuid),
            (l.dataset.senderId = String(r)),
            (l.dataset.styleMemberId = String(r)),
            "user" === e.sender && l.classList.add("is-user"));
        const c = document.createElement("div");
        c.className = "selection-indicator";
        const d = document.createElement("div");
        d.className = "chat-avatar-container";
        const u = document.createElement("img");
        ((u.className = "chat-avatar"), (u.src = s));
        const m = (Je.avatarSettings && Je.avatarSettings.radius) || "50%";
        ((u.style.borderRadius = m),
            (u.dataset.action = "edit-bubble-style"),
            (u.dataset.memberId = r),
            (u.dataset.isUser = "user" === e.sender));
        const p = document.createElement("div");
        if (
            ((p.className = "group-nickname"),
                (p.textContent = i),
                d.appendChild(u),
                "user" === e.sender && Je.userAvatarPendant)
        ) {
            const e = document.createElement("div");
            ((e.className = "avatar-pendant"),
                (e.style.backgroundImage = `url('${Je.userAvatarPendant}')`),
                d.appendChild(e));
        }
        const g = document.createElement("div");
        g.className = "msg-column";
        const y = document.createElement("div");
        ((y.className = "group-message-wrapper"),
            "user" === e.sender ? y.classList.add("user") : y.classList.add("ai"));
        let h = document.createElement("div");
        if ("html" === e.type && e.content) {
            y.classList.add("is-html-content");
            const t = document.createElement("iframe");
            ((t.className = "html-render-container"),
                (t.srcdoc = e.content.html),
                (h = t));
        } else if (("sticker" !== e.type && "image" !== e.type) || !e.url)
            if ("voice_text" === e.type) {
                const t = "user" === e.sender ? "gp-user-bubble" : "gp-ai-bubble";
                ((h.className = `${t} voice-text-bubble`),
                    (h.innerHTML = `<div class="voice-display-area"><div class="voice-duration">${e.duration || 0}s</div></div><div class="voice-transcript">${e.transcript}</div>`));
            } else {
                const t = e.text || "",
                    n = /\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/,
                    a = /(?:^|\n)\s*ËΩ¨Ë¥¶[:Ôºö]([\d.]+)-(.*)/,
                    o = t.match(n),
                    s = t.match(a);
                if (t.includes("[Split]") && t.includes("\\")) {
                    ((h = document.createElement("div")),
                        (h.style.display = "flex"),
                        (h.style.flexDirection = "column"),
                        (h.style.gap = "8px"),
                        (h.style.alignItems =
                            "user" === e.sender ? "flex-end" : "flex-start"));
                    t.split("\\")
                        .filter((e) => "" !== e.trim())
                        .forEach((t) => {
                            const n = t.split("[Split]"),
                                a = document.createElement("div"),
                                o = "user" === e.sender ? "gp-user-bubble" : "gp-ai-bubble";
                            if (((a.className = o), n.length >= 2)) {
                                const e = n[0],
                                    t = n[1];
                                ((a.style.display = "flex"),
                                    (a.style.flexDirection = "column"),
                                    (a.innerHTML = `\n                            <div>${zc(e)}</div>\n                            <div style="height:1px; background:currentColor; opacity:0.2; margin:6px 0 4px 0;"></div>\n                            <div style="font-weight:500;">${zc(t)}</div>\n                         `));
                            } else a.innerHTML = zc(t);
                            h.appendChild(a);
                        });
                } else if (o) {
                    const e = o[1]
                        .trim()
                        .split("\n")
                        .filter((e) => "" !== e.trim());
                    let t = "ËÅäÂ§©ËÆ∞ÂΩï",
                        n = e;
                    (e.length > 0 &&
                        e[0].startsWith("Ê†áÈ¢òÔºö") &&
                        ((t = e[0].replace("Ê†áÈ¢òÔºö", "").trim()), (n = e.slice(1))),
                        (h = document.createElement("div")),
                        (h.className = "history-card-bubble"),
                        (h.dataset.historyTitle = t),
                        (h.dataset.historyContent = JSON.stringify(n)),
                        (h.style.cssText =
                            "background: white; border-radius: 12px; padding: 12px; width: 220px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; text-align: left;"));
                    const a = n
                        .slice(0, 2)
                        .map(
                            (e) =>
                                `<div style="font-size: 12px; color: #888; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e}</div>`,
                        )
                        .join("");
                    h.innerHTML = `\n                    <div style="font-size: 15px; font-weight: 500; color: #000; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 6px;">${t}</div>\n                    ${a}\n                    <div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #f0f0f0; padding-top: 4px;">ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>\n                `;
                } else if (s) {
                    h = document.createElement("div");
                    const t = s[1],
                        n = s[2].trim(),
                        a = "user" === e.sender,
                        o = e.transferStatus || "pending";
                    ((h.style.background = "transparent"),
                        (h.style.padding = "0"),
                        (h.innerHTML = rg(t, n, e.uuid || Date.now(), a, o)));
                } else {
                    h = document.createElement("div");
                    const n = "user" === e.sender ? "gp-user-bubble" : "gp-ai-bubble";
                    ((h.className = n), (h.innerHTML = zc(t)));
                }
            }
        else {
            if (((h = document.createElement("img")), "sticker" === e.type))
                h.className = "sticker-bubble-plain";
            else {
                const t = "user" === e.sender ? "gp-user-bubble" : "gp-ai-bubble";
                h.className = `${t} image-bubble`;
            }
            h.src = e.url;
        }
        if (e.replyTo) {
            const t = document.createElement("div");
            if (
                ((t.className = "reply-quote-container"),
                    (t.innerHTML = `\n            <div class="reply-quote-name">${e.replyTo.senderName}</div>\n            <div class="reply-quote-text">${e.replyTo.text}</div>\n        `),
                    (t.onclick = (t) => {
                        t.stopPropagation();
                        const n = document
                            .getElementById("chat-messages-container")
                            .querySelector(`.message-row[data-uuid="${e.replyTo.uuid}"]`);
                        n &&
                            (n.scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            }),
                                n.classList.add("message-highlight"),
                                setTimeout(() => n.classList.remove("message-highlight"), 1500));
                    }),
                    "DIV" !== h.tagName || h.classList.contains("image-bubble"))
            ) {
                const n = document.createElement("div"),
                    a = "user" === e.sender ? "gp-user-bubble" : "gp-ai-bubble";
                ((n.className = a),
                    h.classList.remove(
                        "chat-bubble",
                        "user-bubble",
                        "ai-bubble",
                        "gp-user-bubble",
                        "gp-ai-bubble",
                    ),
                    (h.style.maxWidth = "100%"),
                    (h.style.borderRadius = "8px"),
                    n.appendChild(t),
                    n.appendChild(h),
                    (h = n));
            } else h.insertBefore(t, h.firstChild);
        }
        if (
            (y.appendChild(h),
                Je && Je.timestampSettings && Je.timestampSettings.show && e.timestamp)
        ) {
            const t = new Date(e.timestamp),
                n = `${String(t.getHours()).padStart(2, "0")}:${String(t.getMinutes()).padStart(2, "0")}`,
                a = document.createElement("div");
            ((a.className = "message-timestamp"),
                (a.style.cssText =
                    "font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; pointer-events: none;"),
                (a.textContent = n),
                y.appendChild(a));
        }
        (g.appendChild(p),
            g.appendChild(y),
            "user" === e.sender
                ? (l.appendChild(g), l.appendChild(d))
                : (l.appendChild(d), l.appendChild(g)),
            l.appendChild(c),
            a && a.isRecording && a.startTimer("üìå ÊèíÂÖ•DOM"),
            o.appendChild(l),
            a && a.isRecording && a.endTimer("üìå ÊèíÂÖ•DOM"),
            a &&
            a.isRecording &&
            a.startTimer("üé® Ê≥®ÂÖ•Ê†∑Âºè", {
                memberId: r,
            }),
            zm(r),
            a && a.isRecording && a.endTimer("üé® Ê≥®ÂÖ•Ê†∑Âºè"));
        const v = () => {
            o.scrollHeight - o.scrollTop - o.clientHeight < 100 &&
                (o.scrollTop = o.scrollHeight);
        };
        (window._groupScrollTimeout && clearTimeout(window._groupScrollTimeout),
            a && a.isRecording && a.startTimer("üìú ÊªöÂä®Âà∞Â∫ïÈÉ®"),
            (window._groupScrollTimeout = setTimeout(() => {
                (requestAnimationFrame(v),
                    a && a.isRecording && a.endTimer("üìú ÊªöÂä®Âà∞Â∫ïÈÉ®"));
            }, 50)));
        const f = performance.now();
        return (
            window.ChatPerformanceMonitor &&
            window.ChatPerformanceMonitor.enabled &&
            window.ChatPerformanceMonitor.recordOperation(
                "addGroupMessageToView",
                f - n,
                {
                    messageType: e.type,
                    sender: e.sender,
                },
            ),
            a && a.isRecording && a.endTimer("üé® Ê∏≤ÊüìÁæ§ËÅäÊ∂àÊÅØ"),
            l
        );
    }

    function jm(e, t, n) {
        const a = String(e);
        let o = "";
        const s = (e, t, n, a) =>
            `\n            ${a} { \n                background-color: ${e}; \n                color: ${t};\n                border: none;\n            }\n            ${a}::before, ${a}::after {\n                background: none;\n                ${"right" === n ? `border-left-color: ${e}; border-right-color: transparent;` : `border-right-color: ${e}; border-left-color: transparent;`}\n                border-top-color: transparent;\n                border-bottom-color: transparent;\n            }\n        `;
        if ("group" !== t) return null;
        {
            const t = window.currentOpenGroup;
            o =
                t && t.memberStyles && t.memberStyles[e]
                    ? t.memberStyles[e]
                    : "user-me" === a || a.startsWith("user")
                        ? s("#000000", "#ffffff", "right", ".gp-user-bubble")
                        : s("#ffffff", "#000000", "left", ".gp-ai-bubble");
        }
        if (o) {
            const e = `[data-style-member-id="${a}"]`;
            let t = o;
            return (
                (t = t.replace(/(\.gp-user-bubble|\.gp-ai-bubble)/g, `${e} $1`)),
                (t = t.replace(/(\.group-nickname)/g, `${e} $1`)),
                t
            );
        }
        return "";
    }
    (tn.addEventListener("click", () => {
        Bc
            ? ((async function () {
                const e = Ni.querySelectorAll(".contact-checkbox:checked");
                if (0 === e.length) return;
                if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${e.length} È°πÂêóÔºü`)) return;
                const t = new Set();
                if (
                    (e.forEach((e) => {
                        const n =
                            e.closest(".contact-item").dataset.contactId ||
                            e.closest(".contact-item").dataset.groupId;
                        t.add(parseInt(n, 10));
                    }),
                        "single" === Kt)
                ) {
                    const e = (
                        await Kl.loadData("messageContacts", "allContacts")
                    ).value.filter((e) => !t.has(e.id));
                    await Kl.saveData("messageContacts", "allContacts", e);
                } else {
                    const e = await Kl.loadData("groupChats", "allGroupChats"),
                        n = (e ? e.value : []).filter((e) => !t.has(e.id));
                    await Kl.saveData("groupChats", "allGroupChats", n);
                }
                Dm();
            })(),
                (function () {
                    ((Bc = !1),
                        Ni.classList.remove("delete-mode"),
                        nn && (nn.style.display = "block"));
                    an && (an.style.display = "none");
                    (tn.classList.remove("delete-mode-active"),
                        (en.style.opacity = "1"),
                        (en.style.pointerEvents = "auto"),
                        Ni.querySelectorAll(".contact-checkbox").forEach(
                            (e) => (e.checked = !1),
                        ));
                })())
            : (function () {
                ((Bc = !0),
                    Ni.classList.add("delete-mode"),
                    nn && (nn.style.display = "none"));
                an && (an.style.display = "block");
                (tn.classList.add("delete-mode-active"),
                    (en.style.opacity = "0.3"),
                    (en.style.pointerEvents = "none"));
            })();
    }),
        Qt.addEventListener("click", () => {
            ((Nt.style.opacity = "0"),
                setTimeout(() => {
                    Nt.style.display = "none";
                }, 300));
        }),
        Qt.addEventListener("click", () => {
            ((Nt.style.opacity = "0"), setTimeout(Hm, 300));
        }),
        _t.addEventListener("click", () => {
            ((Rt.style.display = "flex"),
                (Gt.style.display = "none"),
                (jt.style.display = "none"),
                (_t.style.display = "none"),
                (Ft.textContent = "ÂàõÂª∫Áæ§ËÅä"));
        }),
        (Vt.onclick = () => {
            const e = prompt("ËØ∑ËæìÂÖ•Áæ§ÂêçÁß∞Ôºö", "Êñ∞Âª∫Áæ§ËÅä");
            e && Om(e, []);
        }),
        (zt.onclick = async () => {
            ((Rt.style.display = "none"),
                (Gt.style.display = "block"),
                (jt.style.display = "flex"),
                (_t.style.display = "block"),
                (Ft.textContent = "ÈÄâÊã©ÊàêÂëò"),
                (Wt.innerHTML =
                    '<p style="text-align:center; color:#888;">Âä†ËΩΩ‰∏≠...</p>'));
            try {
                const e = await Kl.loadData("messageContacts", "allContacts"),
                    t = e && Array.isArray(e.value) ? e.value : [];
                if (((Wt.innerHTML = ""), 0 === t.length))
                    return void (Wt.innerHTML =
                        '<p style="text-align:center; padding:20px;">Ê≤°ÊúâËÅîÁ≥ª‰∫∫ÂèØÈÄâ</p>');
                t.forEach((e) => {
                    const t = document.createElement("div");
                    ((t.className = "contact-item"),
                        (t.innerHTML = `\n                <input type="checkbox" class="contact-checkbox" value="${e.id}" style="display:block; margin-right:15px;">\n                <img src="${e.ai.avatar}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${e.ai.name}</div>\n                    <div class="contact-last-message" style="font-size:12px; color:#999;">User: ${e.user.name}</div>\n                </div>\n            `),
                        (t.onclick = (e) => {
                            if ("checkbox" !== e.target.type) {
                                const e = t.querySelector("input");
                                e.checked = !e.checked;
                            }
                        }),
                        Wt.appendChild(t));
                });
            } catch (e) {
                (console.error(e), (Wt.innerHTML = "Âä†ËΩΩÂ§±Ë¥•"));
            }
        }),
        (Ut.onclick = () => {
            const e = Wt.querySelectorAll(".contact-checkbox:checked"),
                t = Array.from(e).map((e) => parseInt(e.value));
            if (0 === t.length) return void alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊàêÂëòÔºÅ");
            const n = prompt("ËØ∑ËæìÂÖ•Áæ§ÂêçÁß∞Ôºö", "Êñ∞Áæ§ËÅä");
            n && Om(n, t);
        }),
        (window.renderWorldBookMultiselect = async function (e, t, n = !1) {
            if (e) {
                e.innerHTML =
                    '<p style="color:#888; font-size:12px; text-align:center;">Âä†ËΩΩ‰∏≠...</p>';
                try {
                    const a = await Kl.loadData("worldBookGroups", "allGroups"),
                        o = await Kl.loadData("worldBooks", "allWorldBooks"),
                        s = a && Array.isArray(a.value) ? a.value : [],
                        i = o && Array.isArray(o.value) ? o.value : [];
                    if (
                        (!t.linkedWorldBookIds || 0 === t.linkedWorldBookIds.length) &&
                        t.linkedWorldBookGroupIds &&
                        t.linkedWorldBookGroupIds.length > 0
                    ) {
                        const e = new Set();
                        (s.forEach((n) => {
                            t.linkedWorldBookGroupIds.includes(n.id) &&
                                Array.isArray(n.bookIds) &&
                                n.bookIds.forEach((t) => e.add(t));
                        }),
                            (t.linkedWorldBookIds = Array.from(e)),
                            n && window.dbHelper);
                    }
                    t.linkedWorldBookIds || (t.linkedWorldBookIds = []);
                    const r = new Set(t.linkedWorldBookIds);
                    e.innerHTML = "";
                    const l = new Map();
                    if (
                        (i.forEach((e) => l.set(e.id, e)), 0 === s.length && 0 === i.length)
                    )
                        return void (e.innerHTML =
                            '<p style="color:#888; font-size:12px; text-align:center;">ÊöÇÊó†‰∏ñÁïå‰π¶</p>');
                    s.forEach((a) => {
                        const o = document.createElement("div");
                        o.style.marginBottom = "15px";
                        const s = document.createElement("div");
                        ((s.style.display = "flex"),
                            (s.style.alignItems = "center"),
                            (s.style.justifyContent = "space-between"),
                            (s.style.marginBottom = "8px"));
                        const i = document.createElement("div");
                        ((i.textContent = "‚ñ∂ " + a.name),
                            (i.style.fontSize = "14px"),
                            (i.style.fontWeight = "bold"),
                            (i.style.color = "#333"),
                            (i.style.cursor = "pointer"),
                            (i.style.flex = "1"));
                        const c = document.createElement("button");
                        ((c.textContent = "ÂÖ®ÈÄâ"),
                            (c.style.cssText =
                                "\n                    font-size: 12px; \n                    padding: 2px 8px; \n                    margin-left: 10px; \n                    border: 1px solid #3a3a3c; \n                    color: #3a3a3c; \n                    background: transparent; \n                    border-radius: 4px; \n                    cursor: pointer;\n                "),
                            s.appendChild(i),
                            s.appendChild(c),
                            o.appendChild(s));
                        const d = document.createElement("div");
                        ((d.style.display = "none"),
                            (d.style.flexDirection = "column"),
                            (d.style.gap = "8px"),
                            (d.style.paddingLeft = "10px"),
                            (d.style.borderLeft = "2px solid #eee"));
                        let u = !1;
                        const m = [];
                        (Array.isArray(a.bookIds) &&
                            a.bookIds.forEach((e) => {
                                const a = l.get(e);
                                if (a) {
                                    u = !0;
                                    const o = document.createElement("label");
                                    ((o.className = "multiselect-item-row"),
                                        (o.style.display = "flex"),
                                        (o.style.alignItems = "center"),
                                        (o.style.cursor = "pointer"));
                                    const s = r.has(e),
                                        i = document.createElement("input");
                                    ((i.type = "checkbox"),
                                        (i.value = e),
                                        (i.checked = s),
                                        (i.style.marginRight = "8px"),
                                        (i.style.transform = "scale(1.2)"),
                                        m.push(i));
                                    const l = document.createElement("span");
                                    ((l.style.fontSize = "14px"),
                                        (l.style.color = "#555"),
                                        (l.textContent = a.name),
                                        o.appendChild(i),
                                        o.appendChild(l),
                                        i.addEventListener("change", async () => {
                                            if (
                                                (i.checked
                                                    ? t.linkedWorldBookIds.includes(e) ||
                                                    t.linkedWorldBookIds.push(e)
                                                    : (t.linkedWorldBookIds = t.linkedWorldBookIds.filter(
                                                        (t) => t !== e,
                                                    )),
                                                    n)
                                            )
                                                try {
                                                    const e = await Kl.loadData(
                                                        "groupChats",
                                                        "allGroupChats",
                                                    );
                                                    let n = e ? e.value : [];
                                                    const a = n.findIndex((e) => e.id === t.id);
                                                    a > -1 &&
                                                        ((n[a] = t),
                                                            await Kl.saveData(
                                                                "groupChats",
                                                                "allGroupChats",
                                                                n,
                                                            ));
                                                } catch (e) {
                                                    console.error("AutoSave Failed", e);
                                                }
                                        }),
                                        d.appendChild(o));
                                }
                            }),
                            u ||
                            (d.innerHTML =
                                '<span style="color:#ccc; font-size:12px;">(Á©∫ÂàÜÁªÑ)</span>'),
                            o.appendChild(d),
                            e.appendChild(o),
                            (i.onclick = () => {
                                const e = "none" === d.style.display;
                                ((d.style.display = e ? "flex" : "none"),
                                    (i.textContent = (e ? "‚ñº " : "‚ñ∂ ") + a.name));
                            }),
                            (c.onclick = async (e) => {
                                if ((e.stopPropagation(), !a.bookIds || 0 === a.bookIds.length))
                                    return;
                                const o = a.bookIds.filter((e) => l.has(e)),
                                    s = !o.every((e) => t.linkedWorldBookIds.includes(e));
                                if (
                                    (o.forEach((e) => {
                                        const n = t.linkedWorldBookIds.indexOf(e);
                                        s
                                            ? -1 === n && t.linkedWorldBookIds.push(e)
                                            : n > -1 && t.linkedWorldBookIds.splice(n, 1);
                                    }),
                                        m.forEach((e) => {
                                            e.checked = s;
                                        }),
                                        n)
                                )
                                    try {
                                        const e = await Kl.loadData("groupChats", "allGroupChats");
                                        let n = e ? e.value : [];
                                        const a = n.findIndex((e) => e.id === t.id);
                                        a > -1 &&
                                            ((n[a] = t),
                                                await Kl.saveData("groupChats", "allGroupChats", n));
                                    } catch (e) {
                                        console.error("Batch AutoSave Failed", e);
                                    }
                            }));
                    });
                } catch (t) {
                    (console.error("Âä†ËΩΩ‰∏ñÁïå‰π¶Â§±Ë¥•", t),
                        (e.innerHTML = '<p style="color:red;">Âä†ËΩΩÈîôËØØ</p>'));
                }
            }
        }),
        (Et.onclick = async () => {
            const e = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁæ§ÂêçÁß∞Ôºö", Je.name);
            if (e && "" !== e.trim()) {
                ((Je.name = e.trim()),
                    (At.textContent = Je.name),
                    (Zi.textContent = Je.name + ` (${Je.members.length})`));
                let t = (await Kl.loadData("groupChats", "allGroupChats")).value;
                const n = t.findIndex((e) => e.id === Je.id);
                (n > -1 &&
                    ((t[n] = Je), await Kl.saveData("groupChats", "allGroupChats", t)),
                    Dm());
            }
        }),
        (wt.onclick = () => bt.click()),
        (bt.onchange = async (e) => {
            const t = e.target.files[0];
            if (t) {
                e.target.value = "";
                try {
                    let e;
                    ((e =
                        window.iOSBabyMode && window.iOSBabyMode.enabled && t.size > 512e3
                            ? await window.iOSBabyMode.safeCompressImage(t, {
                                maxWidth: 400,
                                maxHeight: 400,
                                quality: 0.8,
                            })
                            : window.iOSBabyMode
                                ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                : await new Promise((e, n) => {
                                    const a = new FileReader();
                                    ((a.onload = (t) => e(t.target.result)),
                                        (a.onerror = n),
                                        a.readAsDataURL(t));
                                })),
                        (Je.avatar = e),
                        (wt.style.backgroundImage = `url('${e}')`));
                    let n = (await Kl.loadData("groupChats", "allGroupChats")).value;
                    const a = n.findIndex((e) => e.id === Je.id);
                    (a > -1 &&
                        ((n[a] = Je), await Kl.saveData("groupChats", "allGroupChats", n)),
                        Dm());
                } catch (e) {
                    (console.error("Áæ§Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•:", e),
                        alert(
                            `‚ùå Áæ§Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`,
                        ));
                }
            }
        }),
        void 0 !== pt &&
        pt &&
        (gt &&
            (gt.onchange = async (e) => {
                const t = e.target.files[0];
                if (t) {
                    e.target.value = "";
                    try {
                        let e;
                        ((e =
                            window.iOSBabyMode &&
                                window.iOSBabyMode.enabled &&
                                t.size > 512e3
                                ? await window.iOSBabyMode.safeCompressImage(t, {
                                    maxWidth: 400,
                                    maxHeight: 400,
                                    quality: 0.8,
                                })
                                : window.iOSBabyMode
                                    ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                    : await new Promise((e, n) => {
                                        const a = new FileReader();
                                        ((a.onload = (t) => e(t.target.result)),
                                            (a.onerror = n),
                                            a.readAsDataURL(t));
                                    })),
                            (yt.src = e));
                    } catch (e) {
                        (console.error("Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•:", e), alert("‚ùå Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•"));
                    }
                }
            }),
            (pt.onclick = async () => {
                const e = ht.value.trim(),
                    t = vt.value.trim(),
                    n = yt.src;
                if (!e) return void alert("ËßíËâ≤ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫");
                let a = -1;
                if ((nt && (a = Je.members.findIndex((e) => e.id === nt)), a > -1)) {
                    ((Je.members[a].name = e),
                        (Je.members[a].persona = t),
                        (Je.members[a].avatar = n));
                    let o = (
                        await window.dbHelper.loadData("groupChats", "allGroupChats")
                    ).value;
                    const s = o.findIndex((e) => e.id === Je.id);
                    (s > -1 &&
                        ((o[s] = Je),
                            await window.dbHelper.saveData("groupChats", "allGroupChats", o)),
                        _m(),
                        (ut.style.opacity = "0"),
                        setTimeout(() => {
                            ut.style.display = "none";
                        }, 300));
                } else alert("Êú™ÊâæÂà∞ÊàêÂëò‰ø°ÊÅØ");
            }),
            void 0 !== mt &&
            mt &&
            (mt.onclick = () => {
                ut.style.display = "none";
            })),
        (It.onclick = () => {
            ((St.src =
                Je.userCardAvatar ||
                "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me"),
                ($t.value = Je.userCardName || "Êàë"),
                (ft.value = Je.userCardPersona || ""),
                (Lt.style.display = "flex"),
                setTimeout(() => {
                    Lt.style.opacity = "1";
                }, 10));
        }),
        (Ct.onchange = (e) => {
            const t = e.target.files[0];
            if (t) {
                const e = new FileReader();
                ((e.onload = (e) => {
                    St.src = e.target.result;
                }),
                    e.readAsDataURL(t));
            }
        }),
        (document.getElementById("close-group-user-modal").onclick = () => {
            ((Lt.style.opacity = "0"),
                setTimeout(() => {
                    Lt.style.display = "none";
                }, 300));
        }),
        (Bt.onclick = () => (Lt.style.display = "none")),
        (Ct.onchange = (e) => {
            const t = e.target.files[0];
            if (t) {
                const e = new FileReader();
                ((e.onload = (e) => (St.src = e.target.result)), e.readAsDataURL(t));
            }
        }),
        (Mt.onclick = async () => {
            const e = $t.value.trim() || "Êàë",
                t = ft.value.trim(),
                n = St.src;
            ((Je.userCardName = e),
                (Je.userCardAvatar = n),
                (Je.userCardPersona = t),
                (kt.textContent = e),
                (xt.style.backgroundImage = `url('${n}')`));
            let a = (await Kl.loadData("groupChats", "allGroupChats")).value;
            const o = a.findIndex((e) => e.id === Je.id);
            (o > -1 &&
                ((a[o] = Je), await Kl.saveData("groupChats", "allGroupChats", a)),
                (Lt.style.display = "none"));
        }),
        (mt.onclick = () => {
            ((ut.style.opacity = "0"),
                setTimeout(() => {
                    ut.style.display = "none";
                }, 300));
        }),
        (gt.onchange = (e) => {
            const t = e.target.files[0];
            if (t) {
                const e = new FileReader();
                ((e.onload = (e) => {
                    yt.src = e.target.result;
                }),
                    e.readAsDataURL(t));
            }
        }),
        (pt.onclick = async () => {
            if (!nt) return;
            const e = ht.value.trim(),
                t = vt.value.trim(),
                n = yt.src,
                a = await Kl.loadData("messageContacts", "allContacts");
            let o = a ? a.value : [];
            const s = o.findIndex((e) => e.id === nt);
            if (s > -1) {
                ((o[s].ai.name = e),
                    (o[s].ai.persona = t),
                    (o[s].ai.avatar = n),
                    await Kl.saveData("messageContacts", "allContacts", o),
                    "undefined" != typeof currentContact &&
                    currentContact &&
                    currentContact.id === nt &&
                    ((currentContact.ai.name = e),
                        (currentContact.ai.persona = t),
                        (currentContact.ai.avatar = n)));
                try {
                    const t = await Kl.loadData("groupChats", "allGroupChats");
                    let a = t && Array.isArray(t.value) ? t.value : [],
                        i = !1;
                    (a.forEach((t) => {
                        if (t.history && Array.isArray(t.history) && t.history.length > 0) {
                            let a = !1;
                            t.history.forEach((t) => {
                                ((t.memberId && String(t.memberId) === String(nt)) ||
                                    (!t.memberId && t.senderName === o[s].ai.name)) &&
                                    ((t.senderName = e), (t.senderAvatar = n), (a = !0));
                            });
                            const r = t.history[t.history.length - 1];
                            if (
                                (r.memberId && String(r.memberId) === String(nt)) ||
                                (!r.memberId && r.senderName === e)
                            ) {
                                let n = r.text || "[Â§öÂ™í‰Ωì]";
                                ("sticker" === r.type && (n = "[Ë°®ÊÉÖÂåÖ]"),
                                    "image" === r.type && (n = "[ÂõæÁâá]"),
                                    "voice_text" === r.type && (n = "[ËØ≠Èü≥]"),
                                    (t.lastMessage = `${e}: ${n}`),
                                    (a = !0));
                            }
                            a &&
                                ((i = !0),
                                    Je &&
                                    Je.id === t.id &&
                                    ((Je.history = t.history), (Je.lastMessage = t.lastMessage)));
                        }
                    }),
                        i && (await Kl.saveData("groupChats", "allGroupChats", a)));
                } catch (e) {
                    console.error("ÂêåÊ≠•ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:", e);
                }
                (document
                    .querySelectorAll(`.message-row[data-sender-id="${nt}"]`)
                    .forEach((t) => {
                        const a = t.querySelector(".group-nickname");
                        a && (a.textContent = e);
                        const o = t.querySelector(".chat-avatar");
                        o && (o.src = n);
                    }),
                    _m(),
                    Dm(),
                    (ut.style.display = "none"));
            }
        }),
        (st.onclick = () => {
            ((ot.style.opacity = "0"),
                setTimeout(() => {
                    ot.style.display = "none";
                }, 300));
        }),
        (rt.onchange = (e) => {
            const t = e.target.files[0];
            if (t) {
                const e = new FileReader();
                ((e.onload = (e) => {
                    lt.src = e.target.result;
                }),
                    e.readAsDataURL(t));
            }
        }),
        (it.onclick = async () => {
            const e = ct.value.trim();
            if (!e) return void alert("ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞");
            const t = {
                id: Date.now(),
                isHidden: !0,
                ai: {
                    name: e,
                    persona: dt.value.trim(),
                    avatar: lt.src,
                },
                user: {
                    name: "Êàë",
                    persona: "",
                    avatar: "https://placehold.co/100x100/EFEFEF/AAAAAA?text=User",
                },
                contextMemory: 10,
                lastMessage: "Êñ∞ËßíËâ≤Â∑≤ÂàõÂª∫",
            },
                n = await Kl.loadData("messageContacts", "allContacts");
            let a = n && Array.isArray(n.value) ? n.value : [];
            if (
                (a.push(t), await Kl.saveData("messageContacts", "allContacts", a), Je)
            ) {
                (Je.members || (Je.members = []), Je.members.push(t.id));
                let e = (await Kl.loadData("groupChats", "allGroupChats")).value;
                const n = e.findIndex((e) => e.id === Je.id);
                n > -1 &&
                    ((e[n] = Je), await Kl.saveData("groupChats", "allGroupChats", e));
            }
            (_m(), (ot.style.display = "none"));
        }),
        at.addEventListener("click", (e) => {
            e.target === at &&
                ((at.style.opacity = "0"),
                    setTimeout(() => {
                        at.style.display = "none";
                    }, 300));
        }),
        (window.batchInjectGroupStyles = function (e, t) {
            if (!e) return;
            performance.now();
            window.profiler &&
                window.profiler.isRecording &&
                window.profiler.startTimer("üé® ÊâπÈáèÊ≥®ÂÖ•Ê†∑Âºè");
            const n = `group-style-batch-${e}`;
            let a = "";
            const o = new Set(),
                s = jm("user-me", "group");
            (s && ((a += s), o.add("user-me")),
                t &&
                Array.isArray(t) &&
                t.forEach((e) => {
                    const t = String(e);
                    if (!o.has(t)) {
                        const e = jm(t, "group");
                        e && ((a += e), o.add(t));
                    }
                }));
            let i = document.getElementById(n);
            (i ||
                ((i = document.createElement("style")),
                    (i.id = n),
                    document.head.appendChild(i)),
                (i.textContent = a),
                window.injectedStylesCache || (window.injectedStylesCache = new Set()),
                o.forEach((t) => {
                    const n = `style-group-${e}-${t}`;
                    window.injectedStylesCache.add(n);
                }),
                window.profiler &&
                window.profiler.isRecording &&
                window.profiler.endTimer("üé® ÊâπÈáèÊ≥®ÂÖ•Ê†∑Âºè"));
        }));
    const Um = new Set();
    async function zm(e) {
        const t = performance.now();
        if (!e) return;
        const n = String(e),
            a = document.getElementById("chat-messages-container"),
            o = a.dataset.contextMode,
            s = a.dataset.contextId;
        if (!o || !s) return;
        const i = `style-${o}-${s}-${n}`;
        if (Um.has(i)) {
            const e = performance.now();
            return void (
                window.ChatPerformanceMonitor &&
                window.ChatPerformanceMonitor.enabled &&
                window.ChatPerformanceMonitor.recordOperation(
                    "injectMemberStyle",
                    e - t,
                    {
                        memberId: n,
                        cached: !0,
                    },
                )
            );
        }
        let r = "";
        const l = (e, t, n, a) =>
            `\n            ${a} { \n                background-color: ${e}; \n                color: ${t};\n                border: none;\n            }\n            ${a}::before, ${a}::after {\n                background: none;\n                ${"right" === n ? `border-left-color: ${e}; border-right-color: transparent;` : `border-right-color: ${e}; border-left-color: transparent;`}\n                border-top-color: transparent;\n                border-bottom-color: transparent;\n            }\n        `;
        "group" === o
            ? (r =
                Je && Je.memberStyles && Je.memberStyles[e]
                    ? Je.memberStyles[e]
                    : "user-me" === n || n.startsWith("user")
                        ? l("#000000", "#ffffff", "right", ".gp-user-bubble")
                        : l("#ffffff", "#000000", "left", ".gp-ai-bubble"))
            : "single" === o &&
            (r =
                "user-me" === n
                    ? Sc && Sc.selfBubbleCss
                        ? Sc.selfBubbleCss
                        : l("#95ec69", "#000000", "right", ".chat-bubble")
                    : Sc && Sc.customBubbleCss
                        ? Sc.customBubbleCss
                        : l("#ffffff", "#000000", "left", ".chat-bubble"));
        let c = document.getElementById(i);
        if (r) {
            c ||
                ((c = document.createElement("style")),
                    (c.id = i),
                    document.head.appendChild(c));
            const e = `#chat-messages-container[data-context-id="${s}"]`,
                t = `.message-row[data-sender-id="${n}"]`,
                a = `${i}_${r.substring(0, 50)}`;
            let o;
            if (
                (window._cssTransformCache || (window._cssTransformCache = new Map()),
                    window._cssTransformCache.has(a))
            )
                o = window._cssTransformCache.get(a);
            else {
                const s =
                    "user-me" === n || n.startsWith("user")
                        ? ".gp-user-bubble"
                        : ".gp-ai-bubble";
                if (
                    ((o = r.replace(
                        /(\.gp-[\w-]+|\.chat-bubble|\.user-bubble|\.ai-bubble)([\w-:]*)/g,
                        (n, a, o) => `${e} ${t} ${".gp-bubble" === a ? s : a}${o}`,
                    )),
                        window._cssTransformCache.size > 100)
                ) {
                    const e = window._cssTransformCache.keys().next().value;
                    window._cssTransformCache.delete(e);
                }
                window._cssTransformCache.set(a, o);
            }
            ((c.innerHTML = o), Um.add(i));
        } else c && (c.remove(), Um.delete(i));
        const d = performance.now();
        window.ChatPerformanceMonitor &&
            window.ChatPerformanceMonitor.enabled &&
            window.ChatPerformanceMonitor.recordOperation(
                "injectMemberStyle",
                d - t,
                {
                    memberId: n,
                    cached: !1,
                },
            );
    }
    ((window.injectedStylesCache = Um),
        (window.clearStyleCache = function () {
            Um.clear();
        }),
        Dt.addEventListener("click", (e) => {
            (e.stopPropagation(), Pt.classList.add("delete-mode"));
        }),
        Pt.addEventListener("click", async (e) => {
            if (e.target.classList.contains("member-delete-btn")) {
                e.stopPropagation();
                const t = parseInt(e.target.dataset.memberId, 10);
                if (confirm("Á°ÆÂÆöË¶ÅÂ∞ÜËøô‰ΩçÊàêÂëòÁßªÂá∫Áæ§ËÅäÂêóÔºü"))
                    try {
                        Je.members = Je.members.filter((e) => e !== t);
                        let e = (await Kl.loadData("groupChats", "allGroupChats")).value;
                        const n = e.findIndex((e) => e.id === Je.id);
                        (n > -1 &&
                            ((e[n] = Je),
                                await Kl.saveData("groupChats", "allGroupChats", e)),
                            await _m(),
                            Pt.classList.add("delete-mode"));
                    } catch (e) {
                        (console.error("Âà†Èô§Áæ§ÊàêÂëòÂ§±Ë¥•", e), alert("Âà†Èô§Â§±Ë¥•"));
                    }
            }
        }));
    Tt.querySelector(".modal-content");

    function Vm() {
        const e = new Date(),
            t = `${String(e.getHours()).padStart(2, "0")}:${String(e.getMinutes()).padStart(2, "0")}`,
            n = document.getElementById("status-bar-time");
        n && (n.textContent = t);
    }

    function Jm() {
        const e = document.getElementById("memory-usage");
        if (e)
            if ("memory" in performance) {
                const t = performance.memory,
                    n = (t.usedJSHeapSize / 1048576).toFixed(1),
                    a = (t.jsHeapSizeLimit / 1048576).toFixed(0),
                    o = ((t.usedJSHeapSize / t.jsHeapSizeLimit) * 100).toFixed(0);
                e.textContent = `${n}MB`;
                const s = document.getElementById("memory-monitor");
                o > 90
                    ? ((s.style.color = "#ff3b30"), (s.style.opacity = "1"))
                    : o > 70
                        ? ((s.style.color = "#ff9500"), (s.style.opacity = "0.9"))
                        : ((s.style.color = "inherit"), (s.style.opacity = "0.7"));
                const i = window._lastMemoryWarningTime || 0,
                    r = Date.now();
                o > 90 &&
                    r - i > 3e5 &&
                    ((window._lastMemoryWarningTime = r),
                        console.warn(`‚ö†Ô∏è ÂÜÖÂ≠òË≠¶ÂëäÔºöÂ∑≤‰ΩøÁî® ${o}% (${n}MB / ${a}MB)`),
                        console.warn("Âª∫ËÆÆÔºöÂÖ≥Èó≠‰∏Ä‰∫õÂäüËÉΩÊàñÂà∑Êñ∞È°µÈù¢‰ª•ÈáäÊîæÂÜÖÂ≠ò"));
            } else e.textContent = "--";
    }
    (Tt.addEventListener("click", (e) => {
        e.target.closest("#group-member-count") ||
            e.target.closest(".member-delete-btn") ||
            Pt.classList.remove("delete-mode");
    }),
        Vm(),
        window.TimerManager.setInterval(Vm, 6e4, "status-bar-clock"));
    const Ym = document.getElementById("memory-monitor");
    Ym &&
        Ym.addEventListener("click", () => {
            if (!("memory" in performance))
                return void alert("ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÂÜÖÂ≠òÁõëÊéß");
            const e = performance.memory,
                t = (e.usedJSHeapSize / 1048576).toFixed(2),
                n = (e.totalJSHeapSize / 1048576).toFixed(2),
                a = (e.jsHeapSizeLimit / 1048576).toFixed(0),
                o = ((e.usedJSHeapSize / e.jsHeapSizeLimit) * 100).toFixed(1);
            alert(
                `üìä ÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµ\n\nÁä∂ÊÄÅ: ${o > 90 ? "üî¥ ‰∏•Èáç" : o > 70 ? "üü† Ê≥®ÊÑè" : "üü¢ Ê≠£Â∏∏"}\nÂ∑≤Áî®: ${t} MB\nÊÄªËÆ°: ${n} MB\nÈôêÂà∂: ${a} MB\n‰ΩøÁî®Áéá: ${o}%\n\n` +
                (o > 90
                    ? "‚ö†Ô∏è Ë≠¶ÂëäÔºöÂÜÖÂ≠òÂç≥Â∞ÜËÄóÂ∞ΩÔºÅ\nÂª∫ËÆÆÁ´ãÂç≥Âà∑Êñ∞È°µÈù¢ÊàñÂÖ≥Èó≠ÈÉ®ÂàÜÂäüËÉΩ„ÄÇ"
                    : o > 70
                        ? "üí° ÊèêÁ§∫ÔºöÂÜÖÂ≠ò‰ΩøÁî®ËæÉÈ´ò\nÂª∫ËÆÆÂÖ≥Èó≠‰∏ç‰ΩøÁî®ÁöÑÂäüËÉΩ„ÄÇ"
                        : "‚úÖ ÂÜÖÂ≠ò‰ΩøÁî®Ê≠£Â∏∏"),
            );
        });
    let Km = null;

    function Zm() {
        ((Fe.style.display = "none"), (ze = null));
    }

    function Xm() {
        ((Ve = null), (Ge.style.display = "none"));
    }

    function Qm() {
        (window.DOMCleanupManager &&
            window.DOMCleanupManager.clean("forward-target-list"),
            (Oe.style.opacity = "0"),
            (Oe.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                Oe.style.display = "none";
            }, 300));
    }
    async function ep(e, t) {
        const n = document.querySelectorAll(".message-row.selected");
        if (0 === n.length) return void alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅËΩ¨ÂèëÁöÑÊ∂àÊÅØ");
        let a = "ËÅäÂ§©ËÆ∞ÂΩï";
        Je
            ? (a = Je.name + "ÁöÑËÅäÂ§©ËÆ∞ÂΩï")
            : Sc && (a = `${Sc.user.name}‰∏é${Sc.ai.name}ÁöÑËÅäÂ§©`);
        let o = `Ê†áÈ¢òÔºö${a}\n`;
        n.forEach((e) => {
            let t = "Êú™Áü•",
                n = "";
            const a =
                e.querySelector(".message-content-wrapper") ||
                e.querySelector(".group-message-wrapper");
            if (a)
                if (a.classList.contains("user"))
                    Je ? (t = Je.userCardName || "Êàë") : Sc && (t = Sc.user.name);
                else {
                    const n = e.querySelector(".group-nickname");
                    t = n ? n.textContent : Sc ? Sc.ai.name : "Áæ§Âèã";
                }
            const s = e.querySelector(".chat-bubble");
            if (s)
                if (s.classList.contains("image-bubble")) n = "[ÂõæÁâá]";
                else if (s.classList.contains("sticker-bubble")) n = "[Ë°®ÊÉÖÂåÖ]";
                else if (s.querySelector(".voice-transcript"))
                    n =
                        "[ËØ≠Èü≥]: " +
                        s
                            .querySelector(".voice-transcript")
                            .textContent.replace(/\n/g, " ");
                else if (s.classList.contains("history-card-bubble"))
                    n = "[ËÅäÂ§©ËÆ∞ÂΩïÂç°Áâá]";
                else {
                    let e = s.textContent;
                    ((e = e.replace(/\[MESSAGE_START\]|\[MESSAGE_END\]/g, "")),
                        (n = e.replace(/(\r\n|\n|\r)/gm, " ").trim()));
                }
            else n = "[Â§öÂ™í‰ΩìÊ∂àÊÅØ]";
            o += `${t}Ôºö${n}\n`;
        });
        const s = `[CHAT_HISTORY_START]\n${o}[CHAT_HISTORY_END]`;
        try {
            const n = {
                sender: "user",
                text: s,
                timestamp: new Date(),
                uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
            };
            (t ? await Nm(n, e) : await Ac(n, e),
                alert("Â∑≤ÂèëÈÄÅ"),
                Qm(),
                pd(),
                ((t && Je && Je.id === e) || (!t && Sc && Sc.id === e)) &&
                (t ? Wm(n) : Vc(n),
                    Xi.scrollTo({
                        top: Xi.scrollHeight,
                        behavior: "smooth",
                    })));
        } catch (e) {
            (console.error("ËΩ¨ÂèëÂ§±Ë¥•", e), alert("ËΩ¨ÂèëÂ§±Ë¥•"));
        }
    }

    function tp(e, t) {
        const n = document.getElementById("history-detail-overlay"),
            a = document.getElementById("history-detail-title"),
            o = document.getElementById("history-detail-content");
        ((a.textContent = e), Array.isArray(t) || (t = [t]));
        const s = t
            .map((e) => {
                const t = e.match(/^(.*?)(:|Ôºö)(.*)/);
                let n = "Á≥ªÁªü",
                    a = e;
                return (
                    t && ((n = t[1].trim()), (a = t[3].trim())),
                    (a = a.replace(/\n/g, "<br>")),
                    `\n            <div class="history-row">\n                <div class="history-meta">${n}</div>\n                <div class="history-bubble">${a}</div>\n            </div>\n        `
                );
            })
            .join("");
        ((o.innerHTML = s),
            (o.scrollTop = 0),
            (n.style.display = "flex"),
            setTimeout(() => {
                n.style.opacity = "1";
            }, 10));
    }

    function np() {
        (($e.style.opacity = "0"),
            ($e.querySelector(".modal-content").style.transform = "scale(0.95)"),
            setTimeout(() => {
                $e.style.display = "none";
            }, 300));
    }

    function ap() {
        (xe.classList.toggle("active"), ke.classList.toggle("active"));
    }
    (Ke.addEventListener("click", () => {
        (Ii.classList.add("show-about-device"),
            Jm(),
            Km || (Km = window.TimerManager.setInterval(Jm, 3e4, "memory-monitor")));
    }),
        Ze.addEventListener("click", () => {
            (Ii.classList.remove("show-about-device"),
                Km && (window.TimerManager.clearInterval(Km), (Km = null)));
        }),
        He.addEventListener("click", async () => {
            if (0 !== document.querySelectorAll(".message-row.selected").length) {
                ((qe.innerHTML =
                    '<p style="text-align:center; padding:20px; color:#888;">Âä†ËΩΩ‰∏≠...</p>'),
                    (Oe.style.display = "flex"),
                    setTimeout(() => {
                        ((Oe.style.opacity = "1"),
                            (Oe.querySelector(".modal-content").style.transform =
                                "scale(1)"));
                    }, 10));
                try {
                    const e = await Kl.loadData("messageContacts", "allContacts"),
                        t = await Kl.loadData("groupChats", "allGroupChats"),
                        n = e && Array.isArray(e.value) ? e.value : [],
                        a = t && Array.isArray(t.value) ? t.value : [];
                    if (((qe.innerHTML = ""), a.length > 0)) {
                        const e = document.createElement("div");
                        ((e.textContent = "Áæ§ËÅä"),
                            (e.style.cssText =
                                "padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;"),
                            qe.appendChild(e),
                            a.forEach((e) => {
                                const t = document.createElement("div");
                                ((t.className = "invite-contact-item"),
                                    (t.style.cursor = "pointer"),
                                    (t.onclick = () => ep(e.id, !0)),
                                    (t.innerHTML = `\n                    <img src="${e.avatar}" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.name}</span>\n                `),
                                    qe.appendChild(t));
                            }));
                    }
                    if (n.length > 0) {
                        const e = document.createElement("div");
                        ((e.textContent = "ËÅîÁ≥ª‰∫∫"),
                            (e.style.cssText =
                                "padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;"),
                            qe.appendChild(e),
                            n.forEach((e) => {
                                const t = document.createElement("div");
                                ((t.className = "invite-contact-item"),
                                    (t.style.cursor = "pointer"),
                                    (t.onclick = () => ep(e.id, !1)),
                                    (t.innerHTML = `\n                    <img src="${e.ai.avatar}" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.ai.name}</span>\n                `),
                                    qe.appendChild(t));
                            }));
                    }
                } catch (e) {
                    (console.error("Âä†ËΩΩËΩ¨ÂèëÂàóË°®Â§±Ë¥•", e),
                        (qe.innerHTML =
                            '<p style="color:red; text-align:center;">Âä†ËΩΩÂ§±Ë¥•</p>'));
                }
            } else alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅËΩ¨ÂèëÁöÑÊ∂àÊÅØ");
        }),
        Ne.addEventListener("click", Qm),
        document
            .getElementById("history-detail-close-btn")
            .addEventListener("click", function () {
                const e = document.getElementById("history-detail-overlay");
                ((e.style.opacity = "0"),
                    setTimeout(() => {
                        e.style.display = "none";
                    }, 300));
            }),
        Ce.addEventListener("click", () => {
            (id(),
                (Te.value = ""),
                ($e.style.display = "flex"),
                setTimeout(() => {
                    (($e.style.opacity = "1"),
                        ($e.querySelector(".modal-content").style.transform = "scale(1)"),
                        Te.focus());
                }, 10));
        }),
        Me.addEventListener("click", np),
        Ae.addEventListener("click", () => {
            const e = Te.value.trim();
            if (!e) return;
            (Dc({
                type: "action",
                text: e,
            }),
                np());
        }),
        Le &&
        Le.addEventListener("click", () => {
            (id(), Be.click());
        }),
        Be &&
        Be.addEventListener("change", async (e) => {
            const t = e.target.files[0];
            t &&
                (t.size > 20971520
                    ? alert("Êñá‰ª∂Â§™Â§ßÂï¶ÔºåËØ∑ÂèëÈÄÅ20MB‰ª•ÂÜÖÁöÑÊñá‰ª∂„ÄÇ")
                    : (await (async function (e) {
                        const t = (function (e) {
                            if (0 === e) return "0 B";
                            const t = 1024,
                                n = ["B", "KB", "MB", "GB", "TB"],
                                a = Math.floor(Math.log(e) / Math.log(t));
                            return (
                                parseFloat((e / Math.pow(t, a)).toFixed(1)) + " " + n[a]
                            );
                        })(e.size),
                            n = e.name,
                            a = n.split(".").pop().toLowerCase(),
                            o = new FileReader();
                        ((o.onload = (e) => {
                            const o = e.target.result;
                            Dc({
                                type: "file_card",
                                fileName: n,
                                fileSize: t,
                                fileType: a,
                                fileUrl: o,
                                text: `[Êñá‰ª∂ÂèëÈÄÅÔºö${n} (${t})]`,
                            });
                        }),
                            (o.onerror = (e) => {
                                (console.error("Êñá‰ª∂ËØªÂèñÂ§±Ë¥•", e),
                                    alert("Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï"));
                            }),
                            o.readAsDataURL(e));
                    })(t),
                        (Be.value = "")));
        }),
        document
            .getElementById("ai-file-viewer-close-btn")
            .addEventListener("click", () => {
                const e = document.getElementById("ai-file-viewer-modal");
                ((e.style.opacity = "0"),
                    (e.querySelector(".modal-content").style.transform = "scale(0.95)"),
                    setTimeout(() => {
                        e.style.display = "none";
                    }, 300));
            }),
        Ee &&
        Ee.addEventListener("click", () => {
            const e = document.getElementById("bottom-drawer");
            (e && e.classList.remove("active"),
                Ii.classList.add("show-qilang"),
                console.log("ËøõÂÖ•‰∏ÉÊµ™‰∏ñÁïå..."),
                ip().then(() => {
                    0 ===
                        document.getElementById("qilang-waterfall-grid").children
                            .length && sp(!0);
                }));
        }),
        ke && ke.addEventListener("click", ap));
    const op = document.getElementById("qilang-waterfall-grid");
    async function sp(e = !1) {
        const t = document.getElementById("qilang-waterfall-grid");
        if (!e && t.children.length > 0) return;
        if (e) {
            const e = document.getElementById("qilang-refresh-btn");
            ((e.style.transform = "rotate(360deg)"),
                (e.style.transition = "transform 1s"),
                setTimeout(() => (e.style.transform = ""), 1e3));
        }
        try {
            const e = await xm(
                '\n(Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†Áé∞Âú®ÊòØ‚Äú‰∏ÉÊµ™APP‚ÄùÁöÑÂÜÖÂÆπÁîüÊàêÂºïÊìé„ÄÇËØ∑ÁîüÊàê 4 Êù°ËôöÊûÑÁöÑÁ§æ‰∫§Â™í‰ΩìÂ∏ñÂ≠ê„ÄÇ\nÈ£éÊ†ºË¶ÅÊ±ÇÔºö\n1. **ÂøÖÈ°ªËøîÂõûÁ∫Ø JSON Êï∞ÁªÑÊ†ºÂºè**Ôºå‰∏•Á¶ÅÂåÖÂê´ Markdown Ê†áËÆ∞ÔºàÂ¶Ç ```jsonÔºâ„ÄÇ\n2. ÊØèÊù°Â∏ñÂ≠êÂåÖÂê´‰ª•‰∏ãÂ≠óÊÆµÔºö\n   - "title": Â§ßÂ≠óÊ†áÈ¢òÔºå‰∏çË∂ÖËøá 20 ‰∏™Â≠óÔºåË¶ÅÂú®ËßÜËßâ‰∏äÂæàÁÇ∏Ë£ÇÔºà‰æãÂ¶ÇÔºöÈúáÊÉäÔºÅ„ÄÅÂÆ∂‰∫∫‰ª¨Ë∞ÅÊáÇÂïäÔºâ„ÄÇ\n   - "content": Ê≠£ÊñáÂÜÖÂÆπÔºåÂèØ‰ª•Á®çÈïøÔºåÂ∏¶Êúâ HashtagÔºåÈ£éÊ†ºÂèØ‰ª•ÊòØËµõÂçöÊúãÂÖã„ÄÅËÅåÂú∫ÂêêÊßΩÊàñÂèëÁñØÊñáÂ≠¶„ÄÇ\n   - "author": ÂèëÂ∏ñ‰∫∫ÊòµÁß∞ÔºàÂ∏¶Êúâ‰∫∫ËÆæÊÑüÔºåÂ¶ÇÔºö‰∏É‰∏ÉÂ∏ÇÈ¶ñÂØå„ÄÅÊë∏È±º‰∏ÄÁ∫ßÈÄâÊâãÔºâ„ÄÇ\n   - "likes": ÁÇπËµûÊï∞ (Êï∞Â≠ó)„ÄÇ\n   - "comments": ‰∏Ä‰∏™Êï∞ÁªÑÔºåÂåÖÂê´ 8 Êù°Ë∑Ø‰∫∫ËØÑËÆ∫„ÄÇÊØèÊù°ËØÑËÆ∫Ë¶ÅÊúâ "user" (Ë∑Ø‰∫∫ÊòµÁß∞) Âíå "text" (ËØÑËÆ∫ÂÜÖÂÆπÔºåË¶ÅÊúâÈòµËê•ÊÑüÔºåÊØîÂ¶ÇÊù†Á≤æÊàñÊçßÂìè)„ÄÇ\n\nÊ†ºÂºèÁ§∫‰æãÔºö\n[\n  {\n    "title": "ÂÖ¨Âè∏Á©∫Ë∞ÉÂùè‰∫ÜÔºÅüî•",\n    "content": "Áé∞Âú®ÁöÑÂÆ§ÂÜÖÊ∏©Â∫¶ÊòØ45Â∫¶ÔºåÊàëÁöÑË∫´‰ΩìÈÉΩË¶ÅÁÉ≠ËûçÂåñ‰∫Ü„ÄÇËÄÅÊùøËØ¥ÂøÉÈùôËá™ÁÑ∂ÂáâÔºü #ËÅåÂú∫ #È´òÊ∏©È¢ÑË≠¶",\n    "author": "ËûçÂåñÁöÑÊâìÂ∑•‰∫∫",\n    "likes": 204,\n    "comments": [\n        {"user": "Âç∑Áéã‰πãÁéã", "text": "ËøôÁÇπËã¶ÈÉΩÂêÉ‰∏ç‰∫ÜÔºüÊàëËøòÂú®Âä†Áè≠Âë¢„ÄÇ"},\n        {"user": "Êë∏È±ºÂäû‰∏ª‰ªª", "text": "Âø´ÂéªÂéïÊâÄÔºåÈÇ£ËæπÂáâÂø´ÔºÅ"}\n    ]\n  }\n]\n)',
            );
            if (!e) return;
            const t = e.replace(/```json|```/g, "").trim(),
                n = JSON.parse(t),
                a = await Kl.loadData("qilangPosts", "allPosts");
            let o = a && Array.isArray(a.value) ? a.value : [];
            ((o = [
                ...n.map((e) => ({
                    id: Date.now() + Math.random(),
                    title: e.title,
                    content: e.content,
                    author: e.author,
                    likes: e.likes,
                    timestamp: new Date().toISOString(),
                    comments: Array.isArray(e.comments) ? e.comments : [],
                })),
                ...o,
            ]),
                await Kl.saveData("qilangPosts", "allPosts", o),
                ip(o));
        } catch (e) {
            console.error("‰∏ÉÊµ™ÁîüÊàêÂ§±Ë¥•:", e);
        }
    }
    async function ip(e = null) {
        const t = document.getElementById("qilang-waterfall-grid");
        t.innerHTML = "";
        let n = e;
        if (!n) {
            const e = await Kl.loadData("qilangPosts", "allPosts");
            n = e && Array.isArray(e.value) ? e.value : [];
        }
        (n.sort((e, t) => {
            const n = new Date(e.timestamp || 0).getTime();
            return new Date(t.timestamp || 0).getTime() - n;
        }),
            0 !== n.length
                ? n.forEach((e) => {
                    const n = (function (e) {
                        const t = document.createElement("div");
                        ((t.className = "qilang-card"), (t.dataset.id = e.id));
                        const n = ["#5E5CE6", "#FF2D55", "#34C759", "#FF9500", "#007AFF"],
                            a = n[Math.floor(Math.random() * n.length)],
                            o = e.author ? e.author.charAt(0) : "Êµ™",
                            s = ["400", "700", "900"],
                            i = s[Math.floor(Math.random() * s.length)],
                            r = e.comments ? e.comments.length : 0,
                            l = e.title || e.content.substring(0, 15),
                            c = `\n    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 21.6496C11.69 21.6496 11.39 21.6096 11.14 21.5196C7.32 20.2096 1.25 15.5596 1.25 8.68961C1.25 5.18961 4.08 2.34961 7.56 2.34961C9.25 2.34961 10.83 3.00961 12 4.18961C13.17 3.00961 14.75 2.34961 16.44 2.34961C19.92 2.34961 22.75 5.19961 22.75 8.68961C22.75 15.5696 16.68 20.2096 12.86 21.5196C12.61 21.6096 12.31 21.6496 12 21.6496ZM7.56 3.84961C4.91 3.84961 2.75 6.01961 2.75 8.68961C2.75 15.5196 9.32 19.3196 11.63 20.1096C11.81 20.1696 12.2 20.1696 12.38 20.1096C14.68 19.3196 21.26 15.5296 21.26 8.68961C21.26 6.01961 19.1 3.84961 16.45 3.84961C14.93 3.84961 13.52 4.55961 12.61 5.78961C12.33 6.16961 11.69 6.16961 11.41 5.78961C10.48 4.54961 9.08 3.84961 7.56 3.84961Z" fill="${e.isLiked ? "#FF2D55" : "#8e8e93"}"/>\n    </svg>`;
                        var d;
                        return (
                            (t.innerHTML = `\n        <div class="q-card-title" style="font-weight:${i};">\n            ${l}\n        </div>\n        <div class="q-card-preview">\n            ${e.content}\n        </div>\n        <div class="q-card-footer">\n            <div style="display:flex; align-items:center;">\n                <div class="q-avatar-placeholder" style="width:18px; height:18px; font-size:10px; line-height:18px; text-align:center; color:white; background-color:${a}; margin-right:6px;">${o}</div>\n                <span class="q-author" style="max-width: 45px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.author}</span>\n            </div>\n            <div style="display:flex; gap:12px; align-items:center;">\n                <div style="display:flex; align-items:center; gap:2px;">\n                    ${c}\n                    <span style="font-size:9px; color:#8e8e93;">${((d = e.likes), d > 999 ? (d / 1e3).toFixed(1) + "k" : d)}</span>\n                </div>\n                 <div style="display:flex; align-items:center; gap:2px;">\n                    \n    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M15.5 11.25H8.5C8.09 11.25 7.75 10.91 7.75 10.5C7.75 10.09 8.09 9.75 8.5 9.75H15.5C15.91 9.75 16.25 10.09 16.25 10.5C16.25 10.91 15.91 11.25 15.5 11.25Z" fill="#8e8e93"/>\n        <path d="M16 22.3199C15.66 22.3199 15.32 22.22 15.03 22.03L10.77 19.1899H7C3.56 19.1899 1.25 16.8799 1.25 13.4399V7.43994C1.25 3.99994 3.56 1.68994 7 1.68994H17C20.44 1.68994 22.75 3.99994 22.75 7.43994V13.4399C22.75 16.6199 20.77 18.84 17.75 19.15V20.5699C17.75 21.2199 17.4 21.8099 16.83 22.1099C16.57 22.2499 16.28 22.3199 16 22.3199ZM7 3.17993C4.42 3.17993 2.75 4.84993 2.75 7.42993V13.4299C2.75 16.0099 4.42 17.6799 7 17.6799H11C11.15 17.6799 11.29 17.7199 11.42 17.8099L15.87 20.77C15.98 20.84 16.08 20.81 16.13 20.78C16.18 20.75 16.26 20.6899 16.26 20.5599V18.4299C16.26 18.0199 16.6 17.6799 17.01 17.6799C19.59 17.6799 21.26 16.0099 21.26 13.4299V7.42993C21.26 4.84993 19.59 3.17993 17.01 3.17993H7Z" fill="#8e8e93"/>\n    </svg>\n                    <span style="font-size:9px; color:#8e8e93;">${r}</span>\n                </div>\n            </div>\n        </div>\n    `),
                            t.addEventListener("click", () => {
                                lp(e);
                            }),
                            t
                        );
                    })(e);
                    t.appendChild(n);
                })
                : (t.innerHTML =
                    '<p style="text-align:center; color:#999; padding:20px; width:100%;">ÊöÇÊó∂Ê≤°Êµ™Ëµ∑Êù•ÔºåÁÇπÂè≥‰∏äËßíÂà∑Êñ∞ËØïËØï</p>'));
    }
    (op &&
        op.addEventListener("click", (e) => {
            e.target.closest(".qilang-card") &&
                console.log("ÁÇπÂáª‰∫ÜÂ∏ñÂ≠êÔºåÂáÜÂ§áËøõÂÖ•ËØ¶ÊÉÖÈ°µ...");
        }),
        ve &&
        ve.addEventListener("click", () => {
            (document
                .getElementById("qilang-detail-view")
                .classList.remove("active"),
                de.forEach((e) => clearTimeout(e)),
                (de = []),
                (ge = null));
        }),
        fe &&
        fe.addEventListener("click", () => {
            we.classList.add("active");
        }),
        be &&
        be.addEventListener("click", () => {
            we.classList.remove("active");
        }));
    const rp = document.getElementById("qilang-detail-back-btn");

    function lp(e) {
        (console.log("ÊâìÂºÄÂ∏ñÂ≠ê:", e),
            (ge = e.id),
            (ye = null),
            (me = null),
            (document.getElementById("q-detail-title").textContent =
                e.title || e.content.substring(0, 15)),
            (document.getElementById("q-detail-content").textContent = e.content),
            (document.getElementById("q-detail-author-name").textContent =
                "@" + (e.author || "ÂåøÂêçÁî®Êà∑")),
            (document.getElementById("q-detail-tags").textContent = (function (e) {
                const t = e.match(/#\S+/g);
                return t ? t.join(" ") : "";
            })(e.content || "")));
        const t = (e.content || "").replace(/#\S+/g, "").trim();
        document.getElementById("q-detail-content").textContent = t;
        const n = document.getElementById("q-comments-list"),
            a = document.querySelector(".q-comments-header");
        n.innerHTML = "";
        const o = e.comments || [];
        (!(function e(t) {
            t.forEach((t) => {
                (t.id ||
                    (t.id = `c-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`),
                    (t.id = String(t.id)),
                    t.replies && t.replies.length > 0 && e(t.replies));
            });
        })(o),
            o.length > 0
                ? (a && (a.textContent = `ËØÑËÆ∫Âå∫ (${o.length})`),
                    o.forEach((e, t) => {
                        const a = yp(e);
                        (n.appendChild(a),
                            setTimeout(
                                () => {
                                    a.classList.add("visible");
                                },
                                50 + 50 * t,
                            ));
                    }))
                : ((a.textContent = "ËØÑËÆ∫Âå∫"),
                    gp(() => {
                        n.innerHTML =
                            '<div style="padding:40px; text-align:center; color:#ccc;">ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèë</div>';
                    }, 100)),
            document.getElementById("qilang-detail-view").classList.add("active"));
        const s = document.getElementById("q-detail-input");
        ((s.value = ""), (s.placeholder = "ËæìÂÖ•ËØÑËÆ∫ÔºåÂä†ÂÖ•ÊàòÊñó..."));
    }
    (rp &&
        rp.addEventListener("click", () => {
            document.getElementById("qilang-detail-view").classList.remove("active");
        }),
        he &&
        he.addEventListener("click", () => {
            sp(!0);
        }));
    const cp = document.getElementById("qilang-post-confirm-btn");
    cp &&
        (cp.onclick = async () => {
            const e = document.getElementById("qilang-post-title-input"),
                t = document.getElementById("qilang-post-content-input"),
                n = t.value.trim(),
                a = e.value.trim();
            if (!n) return void alert("ÂÜôÁÇπ‰ªÄ‰πàÂêßÔºÅ");
            const o = {
                id: Date.now(),
                content: a ? `${a} ${n}` : n,
                author: "Êàë",
                likes: 0,
                timestamp: new Date().toISOString(),
                comments: [],
            },
                s = await Kl.loadData("qilangPosts", "allPosts");
            let i = s && Array.isArray(s.value) ? s.value : [];
            (i.unshift(o),
                await Kl.saveData("qilangPosts", "allPosts", i),
                ip(i),
                document.getElementById("qilang-post-modal").classList.remove("active"),
                (t.value = ""),
                (e.value = ""));
        });
    const dp = document.getElementById("qilang-action-menu"),
        up = document.querySelector("#qilang-detail-view .header-actions button");

    function mp(e, t, n) {
        if (!e || !Array.isArray(e)) return !1;
        for (let a of e) {
            if (String(a.id) === String(t))
                return (a.replies || (a.replies = []), a.replies.push(n), !0);
            if (a.replies && a.replies.length > 0) {
                if (a.replies.some((e) => String(e.id) === String(t)))
                    return (a.replies.push(n), !0);
            }
        }
        return !1;
    }

    function mp(e, t, n) {
        if (!e || !Array.isArray(e)) return !1;
        for (let a of e) {
            if (String(a.id) === String(t))
                return (a.replies || (a.replies = []), a.replies.push(n), !0);
            if (a.replies && a.replies.length > 0) {
                if (a.replies.some((e) => String(e.id) === String(t)))
                    return (a.replies.push(n), !0);
            }
        }
        return !1;
    }
    async function pp(e, t, n, a, o) {
        console.log(`AI Ê≠£Âú®ÊÄùËÄÉ... ÊâÆÊºî: ${e}, ÁõÆÊ†áÁà∂ID: ${a}`);
        const s = `(Á≥ªÁªüÊåá‰ª§ÔºöÊâÆÊºî "${e}"ÔºåÂú®Â∏ñÂ≠êËØÑËÆ∫Âå∫ÂõûÂ§çÁî®Êà∑„ÄÇÁî®Êà∑ËØ¥Ôºö"${t}"„ÄÇËØ∑ÁÆÄÁü≠ÂõûÊÄºÊàñ‰∫íÂä®Ôºå30Â≠ó‰ª•ÂÜÖ„ÄÇ)`,
            i = await xm(s);
        i &&
            gp(
                async () => {
                    const t = {
                        id: `ai-${Date.now()}`,
                        user: e,
                        text: i,
                        replies: [],
                    };
                    let n = (await Kl.loadData("qilangPosts", "allPosts")).value;
                    const o = n.findIndex((e) => String(e.id) === String(ge));
                    if (o > -1) {
                        const e = n[o];
                        (mp(e.comments, a, t) ||
                            (console.warn("AIÂõûÂ§çÊâæ‰∏çÂà∞Áà∂ËäÇÁÇπÔºåÂõûÈÄÄÂà∞È°∂Â±Ç"),
                                e.comments.push(t)),
                            await Kl.saveData("qilangPosts", "allPosts", n),
                            ge === e.id && lp(e));
                    }
                },
                1e3 * Math.random() + 1e3,
            );
    }

    function mp(e, t, n) {
        if (!e || !Array.isArray(e)) return !1;
        for (let a of e) {
            if (String(a.id) === String(t))
                return (a.replies || (a.replies = []), a.replies.push(n), !0);
            if (a.replies && a.replies.length > 0) {
                if (mp(a.replies, t, n)) return !0;
            }
        }
        return !1;
    }

    function gp(e, t) {
        const n = setTimeout(e, t);
        return (de.push(n), n);
    }

    function yp(e) {
        const t = document.createElement("div");
        t.className = "q-comment-item";
        const n = e.authorName || e.user || "Á•ûÁßò‰∫∫",
            a =
                e.authorAvatar ||
                `https://placehold.co/100x100/e5e5ea/ffffff?text=${n.charAt(0)}`,
            o = e.text || "";
        let s = "ÂàöÂàö";
        if (e.timestamp) {
            const t = new Date(e.timestamp);
            s = `${t.getMonth() + 1}-${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2, "0")}`;
        }
        let i = "";
        if (e.replies && e.replies.length > 0) {
            i = `<div class="q-sub-comments-box">${e.replies
                .map((t) => {
                    const n = t.authorName || t.user || "Á•ûÁßò‰∫∫";
                    return `\n                <div class="q-sub-item">\n                    <span class="q-sub-user">${n}:</span>\n                    <span class="q-sub-text">${t.text || ""}</span>\n                    <span class="q-sub-reply-btn" \n                          data-user="${n}" \n                          data-root-id="${e.id}">ÂõûÂ§ç</span>\n                </div>\n            `;
                })
                .join("")}</div>`;
        }
        return (
            (t.innerHTML = `\n        <img class="q-comment-avatar-img" src="${a}" onerror="this.src='https://placehold.co/100x100?text=?'">\n        \n        <div class="q-comment-main">\n            <div class="q-comment-header">\n                <span class="q-comment-user">${n}</span>\n            </div>\n            \n            <div class="q-comment-text">${o}</div>\n            \n            ${i} \n            \n            <div class="q-comment-footer">\n                <span class="q-time">${s}</span>\n                <span class="q-reply-trigger" \n                      data-user="${n}" \n                      data-comment-id="${e.id}">\n                      ÂõûÂ§ç\n                </span>\n            </div>\n        </div>\n    `),
            t
        );
    }
    (up &&
        up.addEventListener("click", async (e) => {
            e.stopPropagation();
            const t = (
                (await Kl.loadData("qilangPosts", "allPosts")).value || []
            ).find((e) => e.id === ge),
                n = document.getElementById("q-fav-text"),
                a = document.querySelector("#q-action-fav svg");
            (t && t.isFavorited
                ? ((n.textContent = "ÂèñÊ∂àÊî∂Ëóè"),
                    (a.style.fill = "#FF9500"),
                    (a.style.stroke = "#FF9500"))
                : ((n.textContent = "Êî∂Ëóè"),
                    (a.style.fill = "none"),
                    (a.style.stroke = "currentColor")),
                (dp.style.display = "block" === dp.style.display ? "none" : "block"));
        }),
        document.addEventListener("click", (e) => {
            dp &&
                "block" === dp.style.display &&
                !dp.contains(e.target) &&
                e.target !== up &&
                (dp.style.display = "none");
        }),
        document
            .getElementById("q-action-fav")
            .addEventListener("click", async () => {
                let e = (await Kl.loadData("qilangPosts", "allPosts")).value || [];
                const t = e.findIndex((e) => e.id === ge);
                if (t > -1) {
                    ((e[t].isFavorited = !e[t].isFavorited),
                        await Kl.saveData("qilangPosts", "allPosts", e));
                    const n = e[t].isFavorited ? "Â∑≤Âä†ÂÖ•Êî∂ËóèÂ§π" : "Â∑≤ÂèñÊ∂àÊî∂Ëóè";
                    (alert(n), ip(e));
                }
                dp.style.display = "none";
            }),
        document
            .getElementById("q-action-delete")
            .addEventListener("click", async () => {
                if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Â∏ñÂ≠êÂêóÔºüAIÂèØËÉΩ‰ºö‰º§ÂøÉÁöÑ„ÄÇ")) {
                    let e = (await Kl.loadData("qilangPosts", "allPosts")).value || [];
                    ((e = e.filter((e) => e.id !== ge)),
                        await Kl.saveData("qilangPosts", "allPosts", e),
                        ip(e),
                        document
                            .getElementById("qilang-detail-view")
                            .classList.remove("active"),
                        (dp.style.display = "none"));
                }
            }),
        document
            .getElementById("qilang-menu-home")
            .addEventListener("click", async () => {
                const e = await Kl.loadData("qilangPosts", "allPosts");
                (ip(e ? e.value : []),
                    document.getElementById("qilang-sidebar").classList.remove("active"),
                    document
                        .getElementById("qilang-sidebar-overlay")
                        .classList.remove("active"),
                    (document.querySelector(".settings-header h1").textContent = "‰∏ÉÊµ™"));
            }),
        document
            .getElementById("qilang-menu-fav")
            .addEventListener("click", async () => {
                const e = await Kl.loadData("qilangPosts", "allPosts");
                (ip((e ? e.value : []).filter((e) => e.isFavorited)),
                    document.getElementById("qilang-sidebar").classList.remove("active"),
                    document
                        .getElementById("qilang-sidebar-overlay")
                        .classList.remove("active"),
                    (document.querySelector(".settings-header h1").textContent =
                        "Êî∂ËóèÂ§π"));
            }),
        document
            .getElementById("q-comments-list")
            .addEventListener("click", (e) => {
                if (e.target.classList.contains("q-reply-trigger")) {
                    const t = e.target.dataset.user,
                        n = e.target.dataset.commentId;
                    ((ye = t), (me = n));
                    const a = document.getElementById("q-detail-input");
                    return ((a.placeholder = `ÂõûÂ§ç ${t}...`), void a.focus());
                }
                const t = e.target.closest(".q-sub-item");
                if (t) {
                    const e = t.closest(".q-comment-item");
                    if (!e) return;
                    const n = e.querySelector(".q-reply-trigger");
                    if (!n) return;
                    const a = n.dataset.commentId,
                        o = t
                            .querySelector(".q-sub-user")
                            .textContent.replace(/[:Ôºö\s]/g, "")
                            .trim();
                    ((ye = o), (me = a));
                    const s = document.getElementById("q-detail-input");
                    ((s.placeholder = `ÂõûÂ§ç ${o}...`), s.focus());
                }
            }),
        document
            .getElementById("q-detail-send-btn")
            .addEventListener("click", async () => {
                const e = document.getElementById("q-detail-input");
                let t = e.value.trim();
                if (!t || !ge) return;
                let n = "Êàë",
                    a = "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";
                (ue
                    ? ((n = ue.ai ? ue.ai.name : ue.user.name),
                        (a = ue.ai ? ue.ai.avatar : ue.user.avatar))
                    : Sc && ((n = Sc.user.name), (a = Sc.user.avatar)),
                    ye && me && (t.startsWith(`ÂõûÂ§ç ${ye}`) || (t = `ÂõûÂ§ç ${ye}Ôºö${t}`)));
                const o = {
                    id: `c-${Date.now()}`,
                    authorName: n,
                    authorAvatar: a,
                    text: t,
                    timestamp: new Date().toISOString(),
                    replies: [],
                };
                let s = (await Kl.loadData("qilangPosts", "allPosts")).value;
                const i = s.findIndex((e) => String(e.id) === String(ge));
                if (i > -1) {
                    const n = s[i];
                    if (me) {
                        mp(n.comments, me, o) ||
                            (n.comments || (n.comments = []), n.comments.push(o));
                    } else (n.comments || (n.comments = []), n.comments.push(o));
                    await Kl.saveData("qilangPosts", "allPosts", s);
                    const a = document.getElementById("q-comments-list");
                    ((a.innerHTML = ""),
                        n.comments.forEach((e) => {
                            const t = yp(e);
                            (a.appendChild(t),
                                setTimeout(() => t.classList.add("visible"), 10));
                        }));
                    (pp(ye || n.author, t, n.content, o.id, n.id),
                        (e.value = ""),
                        (e.placeholder = "ËæìÂÖ•ËØÑËÆ∫..."),
                        (me = null),
                        (ye = null));
                }
            }),
        Ie.addEventListener("click", () => {
            (!(async function () {
                if (!pe) return;
                const e = await Kl.loadData("messageContacts", "allContacts"),
                    t = [
                        {
                            id: "user-me",
                            ai: {
                                name: "Êàë",
                                avatar: "https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me",
                            },
                        },
                        ...(e && Array.isArray(e.value) ? e.value : []),
                    ];
                ((pe.innerHTML = ""),
                    t.forEach((e) => {
                        const t = document.createElement("div");
                        ((t.className = "q-identity-avatar"),
                            (t.style.backgroundImage = `url('${e.ai.avatar}')`),
                            (t.title = e.ai.name),
                            t.addEventListener("click", () => {
                                (document
                                    .querySelectorAll(".q-identity-avatar")
                                    .forEach((e) => e.classList.remove("active")),
                                    t.classList.add("active"),
                                    (ue = e),
                                    console.log("‰∏ÉÊµ™Ë∫´‰ªΩÂàáÊç¢‰∏∫:", e.ai.name));
                            }),
                            ue || "user-me" !== e.id || (t.classList.add("active"), (ue = e)),
                            pe.appendChild(t));
                    }));
            })(),
                ap());
        }));
    const hp = document.getElementById("qilang-sidebar");
    hp && (hp.style.zIndex = "3000");
    const vp = document.getElementById("qilang-sidebar-overlay");
    vp && (vp.style.zIndex = "2999");
    const fp = document.getElementById("qilang-menu-exit");

    function wp(e) {
        ce && ((ce.innerHTML = e || ""), ie && (ie.value = e || ""));
    }

    function bp(e, t) {
        const n = async (t) => {
            if (Sc) {
                const n = Sc.history.find((t) => t.uuid === e);
                if (n) {
                    ((n.transcript = t),
                        (n.text = `[ËØ≠Èü≥Ê∂àÊÅØ] ${t.substring(0, 10)}...`),
                        await tu());
                    const a = document.querySelector(`.message-row[data-uuid="${e}"]`);
                    if (a) {
                        const e = a.querySelector(".voice-text-panel");
                        e && (e.innerText = t);
                    }
                    Sm();
                }
            }
        };
        Bm("‰øÆÊ≠£ËØ≠Èü≥ËØÜÂà´", t, n);
    }
    async function Ep(e) {
        let t;
        const n = !1 !== e.enableDefaultStickers;
        t = n ? new Map(xl) : new Map();
        const a = !1 !== e.enableWBStickers,
            o =
                (e.linkedWorldBookIds && e.linkedWorldBookIds.length > 0) ||
                (e.linkedWorldBookGroupIds && e.linkedWorldBookGroupIds.length > 0);
        if (!a || !o) return t;
        try {
            const o = await Kl.loadData("worldBooks", "allWorldBooks"),
                s = o && Array.isArray(o.value) ? o.value : [],
                i = new Set();
            if (e.linkedWorldBookIds && e.linkedWorldBookIds.length > 0)
                e.linkedWorldBookIds.forEach((e) => i.add(e));
            else {
                const t = await Kl.loadData("worldBookGroups", "allGroups"),
                    n = t && Array.isArray(t.value) ? t.value : [],
                    a = new Set(e.linkedWorldBookGroupIds || []);
                n.forEach((e) => {
                    a.has(e.id) &&
                        Array.isArray(e.bookIds) &&
                        e.bookIds.forEach((e) => i.add(e));
                });
            }
            const r = s.filter((e) => i.has(e.id)),
                l = /\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;
            (r.forEach((e) => {
                if (!e.content) return;
                const n = e.content;
                let a;
                for (; null !== (a = l.exec(n));) {
                    const e = a[1].trim(),
                        n = a[2].trim();
                    t.set(e, n);
                }
            }),
                console.log(`Ë°®ÊÉÖÂåÖÂä†ËΩΩÂÆåÊØï„ÄÇÈ¢ÑËÆæ:${n}, ‰∏ñÁïå‰π¶:${a}, ÊÄªÊï∞:${t.size}`));
        } catch (e) {
            console.error("ÊèêÂèñ‰∏ñÁïå‰π¶Ë°®ÊÉÖÂåÖÂ§±Ë¥•:", e);
        }
        return t;
    }

    function Ip(e) {
        Q[e] &&
            (clearTimeout(Q[e]),
                delete Q[e],
                console.log(`[‰∏ªÂä®Ê∂àÊÅØ] ËÅîÁ≥ª‰∫∫ ${e} ËÆ°Êó∂Â∑≤ÂèñÊ∂à`));
    }
    async function xp(e) {
        const t = await Su(e);
        if (!t) return;
        if (Sc && Sc.id === e) return;
        console.log(`[‰∏ªÂä®Ê∂àÊÅØ] Ê≠£Âú®‰∏∫ ${t.ai.name} ÊûÑÂª∫‰∏ä‰∏ãÊñá...`);
        const n = `ÂßìÂêçÔºö${t.ai.name}\n‰∫∫ËÆæÔºö${t.ai.persona}`,
            a = `ÂßìÂêçÔºö${t.user.name}\n‰∫∫ËÆæÔºö${t.user.persona}`;
        let o = (t.history || [])
            .slice(-15)
            .map((e) => {
                let n = e.text || e.transcript || "[Â§öÂ™í‰Ωì/ÂõæÁâá]";
                return `${"user" === e.sender ? t.user.name : t.ai.name}: ${n}`;
            })
            .join("\n");
        o || (o = "(ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï)");
        let s = "";
        "function" == typeof window.getEnabledMemoriesText &&
            (s = await window.getEnabledMemoriesText(t.id));
        let i = "Êó†ÁâπÂÆö‰∏ñÁïåËßÇËÆæÂÆö„ÄÇ";
        if (t.linkedWorldBookGroupIds && t.linkedWorldBookGroupIds.length > 0)
            try {
                const e = await Kl.loadData("worldBookGroups", "allGroups"),
                    n = e && Array.isArray(e.value) ? e.value : [],
                    a = await Kl.loadData("worldBooks", "allWorldBooks"),
                    o = a && Array.isArray(a.value) ? a.value : [],
                    s = new Set(t.linkedWorldBookGroupIds),
                    r = new Set();
                n.forEach((e) => {
                    s.has(e.id) &&
                        Array.isArray(e.bookIds) &&
                        e.bookIds.forEach((e) => r.add(e));
                });
                const l = o
                    .filter((e) => r.has(e.id))
                    .map((e) => `„Äê‰∏ñÁïåËÆæÂÆöÔºö${e.name}„Äë\n${e.content}`)
                    .join("\n\n");
                l && (i = l);
            } catch (e) {
                console.error("‰∏ªÂä®Ê∂àÊÅØËØªÂèñ‰∏ñÁïå‰π¶Â§±Ë¥•:", e);
            }
        const r = ne.systemPrompt
            ? `\n[Áî®Êà∑Ëá™ÂÆö‰πâÈ£éÊ†ºÊåá‰ª§]\n${ne.systemPrompt}\n`
            : "",
            l = `\n[Ê†∏ÂøÉÊåá‰ª§]\nÁî®Êà∑Â∑≤ÁªèÊúâ ${ne.interval} ÂàÜÈíüÊ≤°ËØ¥ËØù‰∫Ü„ÄÇ‰Ω†Áé∞Âú®ÂøÖÈ°ª**ÂÆåÂÖ®Ê≤âÊµ∏**Âú®‰Ω†ÁöÑËßíËâ≤‰∏≠ÔºåÊ†πÊçÆ„ÄêÂâçÊÉÖÊèêË¶Å„ÄëÂíå„Äê‰∫∫ËÆæ„ÄëÔºå‰∏ªÂä®ÂèëËµ∑‰∏Ä‰∏™Êñ∞ÁöÑËØùÈ¢òÔºåÊàñËÄÖÁªßÁª≠‰πãÂâçÁöÑËØùÈ¢òÊù•ÂºïËµ∑Áî®Êà∑ÁöÑÊ≥®ÊÑè„ÄÇ\n${r}\n\n[Âº∫Âà∂Ê†ºÂºèË¶ÅÊ±Ç]\n1. **ÂøÖÈ°ªÂèëÈÄÅ 2 Âà∞ 3 Âè•Áü≠Ê∂àÊÅØ**„ÄÇ‰∏çË¶ÅÂè™Âèë‰∏ÄÂè•ÔºÅ\n2. **ÂøÖÈ°ª‰ΩøÁî®ÂèçÊñúÊù† "\\" Êù•ÂàÜÈöîÊØè‰∏ÄÂè•ËØù**„ÄÇ\n3. **‰∏•Á¶Å**Âá∫Áé∞ "Á≥ªÁªüÊèêÁ§∫"„ÄÅ"AI"„ÄÅ"ÂõûÂ§ç" Á≠âÂá∫ÊàèÁöÑËØçÊ±á„ÄÇ\n4. **‰∏•Á¶Å**ÈáçÂ§ç‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÂè•ËØù„ÄÇ\n\n[ÂèÇËÄÉËåÉ‰æã]\nÊ≠£Á°ÆÊ†ºÂºèÔºö‰Ω†Âú®Âπ≤ÂòõÂë¢Ôºü\\ÊàëÂàöÁúãÂà∞‰∏Ä‰∏™Â•ΩÁé©ÁöÑ‰∏úË•øÔºåÊÉ≥Áªô‰Ω†ÁúãÁúã„ÄÇ\nÊ≠£Á°ÆÊ†ºÂºèÔºöÂ•ΩÊó†ËÅäÂïä...\\‰Ω†ÊÄé‰πàËøò‰∏çÁêÜÊàëÔºü\\ÊòØ‰∏çÊòØÊää‰Ω†ÂøòÂï¶Ôºü\n\n---\n### ‰Ω†ÁöÑËßíËâ≤ (AI)\n${n}\n\n### Áî®Êà∑ËßíËâ≤ (User)\n${a}\n\n### ‰∏ñÁïåËßÇÁü•ËØÜÂ∫ì\n${i}\n\n### ÂâçÊÉÖÊèêË¶Å (ÊúÄËøëËÅäÂ§©)\n### ÂâçÊÉÖÊèêË¶Å (ÊúÄËøëËÅäÂ§©)\n${o}\n\n### ÈáçË¶ÅÈïøÊúüËÆ∞ÂøÜ\n${s || "Êó†"}\n---\nËØ∑Áé∞Âú®ÁîüÊàê‰Ω†ÁöÑ‰∏ªÂä®Ê∂àÊÅØÔºö\n`;
        try {
            console.log(`Ê≠£Âú®ËØ∑Ê±Ç ${t.ai.name} ÁöÑ‰∏ªÂä®Ê∂àÊÅØ...`);
            const n = await xm(l);
            if (n) {
                const a = n
                    .split(/\\|\\n|\n/)
                    .map((e) => e.trim())
                    .filter((e) => e);
                if (0 === a.length) return;
                for (const t of a) {
                    const n = {
                        sender: "ai",
                        text: t,
                        timestamp: new Date(),
                        uuid: Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                    };
                    await Ac(n, e);
                }
                const o = a.join(" ");
                (!(function (e, t) {
                    (ee.push({
                        contact: e,
                        text: t,
                    }),
                        kp());
                })(t, o),
                    console.log(`[‰∏ªÂä®Ê∂àÊÅØ] ÊàêÂäüÁîüÊàêÂπ∂‰øùÂ≠ò‰∫Ü ${a.length} Êù°Ê∂àÊÅØ„ÄÇ`));
            }
        } catch (e) {
            console.error("‰∏ªÂä®Ê∂àÊÅØËß¶ÂèëÂ§±Ë¥•:", e);
        }
    }

    function kp() {
        if (te || 0 === ee.length) return;
        te = !0;
        const { contact: e, text: t } = ee.shift();
        !(function (e, t) {
            const n = document.getElementById("notification-banner-container"),
                a = document.createElement("div");
            ((a.className = "glass-banner"),
                (a.innerHTML = `\n        <img src="${e.ai.avatar}">\n        <div class="glass-banner-content">\n            <div class="glass-banner-title">${e.ai.name}</div>\n            <div class="glass-banner-text">${t}</div>\n        </div>\n    `),
                (a.onclick = () => {
                    (a.classList.remove("show"),
                        setTimeout(() => a.remove(), 400),
                        Nc(e.id));
                }),
                n.appendChild(a),
                requestAnimationFrame(() => {
                    a.classList.add("show");
                }),
                setTimeout(() => {
                    (a.classList.remove("show"),
                        setTimeout(() => {
                            (a.remove(), (te = !1), kp());
                        }, 400));
                }, 2500));
        })(e, t);
    }
    async function Lp() {
        const e = await Kl.loadData("settingsStore", "proactiveConfig");
        (e && e.value && (ne = e.value), J && (J.checked = ne.enabled));
        const t = document.getElementById("proactive-master-switch-new");
        (t && (t.checked = ne.enabled),
            Y && ((Y.value = ne.interval), Bp()),
            K && (K.textContent = `${ne.interval} ÂàÜÈíü`));
        const n = document.getElementById("proactive-system-prompt");
        (n && ne.systemPrompt && ((n.value = ne.systemPrompt), Sp()),
            Cp(),
            await (async function () {
                let e = Ye;
                if (!e || 0 === e.length) {
                    const t = await Kl.loadData("messageContacts", "allContacts");
                    e =
                        t && t.value
                            ? t.value.map((e) => ({
                                id: e.id,
                                ai: {
                                    name: e.ai?.name || "Êú™Áü•",
                                    avatar: e.ai?.avatar || "",
                                },
                                isHidden: e.isHidden || !1,
                            }))
                            : [];
                }
                if (!Z) return;
                Z.innerHTML = "";
                const t = e.filter((e) => !e.isHidden);
                if (0 === t.length)
                    return void (Z.innerHTML =
                        '<div class="proactive-agent-grid-empty">ÊöÇÊó†ÂèØÁî®ËßíËâ≤</div>');
                t.forEach((e) => {
                    const t = ne.targets.includes(e.id),
                        n = document.createElement("div");
                    ((n.className = "proactive-agent-item" + (t ? " selected" : "")),
                        (n.dataset.contactId = e.id),
                        (n.innerHTML = `\n                <div class="proactive-avatar-box">\n                    <img src="${e.ai.avatar}" alt="${e.ai.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:18px;font-weight:700;\\'>${e.ai.name.charAt(0)}</span>';">\n                    <div class="proactive-check-badge">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">\n                            <polyline points="20 6 9 17 4 12"></polyline>\n                        </svg>\n                    </div>\n                </div>\n                <span class="proactive-agent-name">${e.ai.name}</span>\n            `),
                        n.addEventListener("click", async () => {
                            const e = parseInt(n.dataset.contactId);
                            (n.classList.toggle("selected"),
                                window.navigator &&
                                window.navigator.vibrate &&
                                window.navigator.vibrate(5),
                                n.classList.contains("selected")
                                    ? ne.targets.includes(e) || ne.targets.push(e)
                                    : ((ne.targets = ne.targets.filter((t) => t !== e)), Ip(e)));
                        }),
                        Z.appendChild(n));
                });
            })());
    }

    function Bp() {
        const e = document.getElementById("proactive-interval-slider"),
            t = document.getElementById("proactive-slider-fill"),
            n = document.getElementById("proactive-slider-thumb"),
            a = document.getElementById("proactive-interval-display");
        if (!e || !t || !n) return;
        const o = e.value,
            s = e.min || 5,
            i = ((o - s) / ((e.max || 60) - s)) * 100;
        ((t.style.width = i + "%"),
            (n.style.left = `calc(${i}% - 14px)`),
            a && (a.textContent = `${o} ÂàÜÈíü`));
    }

    function Sp() {
        const e = document.getElementById("proactive-system-prompt"),
            t = document.getElementById("proactive-char-display");
        if (!e || !t) return;
        const n = e.value.length,
            a = e.maxLength || 500;
        t.textContent = `${n} / ${a} Â≠óÁ¨¶`;
    }

    function Cp() {
        X &&
            (ne.enabled
                ? ((X.textContent = `ÂºÄÂêØ (${ne.interval}ÂàÜÈíü)`),
                    (X.style.color = "#007AFF"))
                : ((X.textContent = "Â∑≤ÂÖ≥Èó≠"), (X.style.color = "#8e8e93")));
    }
    (fp &&
        fp.addEventListener("click", () => {
            (ap(), Ii.classList.remove("show-qilang"));
        }),
        ae &&
        ae.addEventListener("click", (e) => {
            e.stopPropagation();
            const t = ze;
            if ((Zm(), t)) {
                if (!t.dataset || !t.dataset.uuid)
                    return void console.error("Êó†Ê≥ïÂà†Èô§ÔºöÊâæ‰∏çÂà∞Ê∂àÊÅØID");
                confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü") && Fu(t);
            } else console.warn("Âà†Èô§Â§±Ë¥•ÔºöÊú™ËÉΩÈîÅÂÆöË¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØË°å");
        }),
        V &&
        V.addEventListener("click", () => {
            (U.classList.add("opened"), Lp());
        }),
        z &&
        z.addEventListener("click", () => {
            U.classList.remove("opened");
        }));
    const $p = document.getElementById("proactive-save-button");
    ($p &&
        $p.addEventListener("click", async () => {
            (await (async function () {
                const e = document.getElementById("proactive-master-switch-new");
                (e ? (ne.enabled = e.checked) : J && (ne.enabled = J.checked),
                    (ne.interval = Y ? parseInt(Y.value) : ne.interval));
                const t = document.getElementById("proactive-system-prompt");
                (t && (ne.systemPrompt = t.value),
                    await Kl.saveData("settingsStore", "proactiveConfig", ne),
                    J && (J.checked = ne.enabled),
                    e && (e.checked = ne.enabled),
                    Cp(),
                    ne.enabled || Object.keys(Q).forEach((e) => Ip(e)));
            })(),
                ($p.textContent = "Â∑≤‰øùÂ≠ò"),
                ($p.style.color = "#16a34a"),
                setTimeout(() => {
                    (($p.textContent = "‰øùÂ≠ò"), ($p.style.color = "#2563eb"));
                }, 1500));
        }),
        J &&
        J.addEventListener("change", async () => {
            ne.enabled = J.checked;
            const e = document.getElementById("proactive-master-switch-new");
            (e && (e.checked = ne.enabled),
                await Kl.saveData("settingsStore", "proactiveConfig", ne),
                Cp(),
                ne.enabled || Object.keys(Q).forEach((e) => Ip(e)));
        }));
    const Mp = document.getElementById("proactive-master-switch-new");
    (Mp &&
        Mp.addEventListener("change", () => {
            J && (J.checked = Mp.checked);
        }),
        Y &&
        Y.addEventListener("input", () => {
            Bp();
        }));
    const Tp = document.getElementById("proactive-system-prompt");
    Tp && Tp.addEventListener("input", Sp);
    const Ap = document.getElementById("proactive-optimize-btn");

    function Dp(e, t) {
        const n = (e / 100) * 21;
        (G.setAttribute("width", n),
            t
                ? (j.classList.add("charging"),
                    j.classList.remove("low"),
                    (W.style.display = "block"))
                : (j.classList.remove("charging"),
                    (W.style.display = "none"),
                    e <= 20 ? j.classList.add("low") : j.classList.remove("low")));
    }
    (Ap &&
        Ap.addEventListener("click", () => {
            const e = document.getElementById("proactive-system-prompt");
            e &&
                !e.value &&
                ((e.value = "ÂΩìÁî®Êà∑ÈïøÊó∂Èó¥‰∏çËØ¥ËØùÊó∂Ôºå‰Ω†ÂèØ‰ª•‰∏ªÂä®ÂèëËµ∑ËØùÈ¢ò„ÄÇ"), Sp());
        }),
        "getBattery" in navigator
            ? navigator.getBattery().then((e) => {
                (console.log("ÁîµÊ±†APIÂä†ËΩΩÊàêÂäü"),
                    Dp(Math.round(100 * e.level), e.charging),
                    e.addEventListener("levelchange", () => {
                        Dp(Math.round(100 * e.level), e.charging);
                    }),
                    e.addEventListener("chargingchange", () => {
                        Dp(Math.round(100 * e.level), e.charging);
                    }));
            })
            : (console.log("ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†APIÔºåÊòæÁ§∫ÈªòËÆ§50%ÁîµÈáè"), Dp(50, !1)),
        v &&
        v.addEventListener("click", async () => {
            Ii.classList.add("show-wow");
            const e = localStorage.getItem("lastWowContactId");
            if (!N && e) {
                const t = await Kl.loadData("messageContacts", "allContacts");
                if (t && Array.isArray(t.value)) {
                    const n = t.value.find((t) => t.id == e);
                    if (n) return void Op(n);
                }
            }
            N ? (Np(), qp(), jp()) : Hp();
        }),
        f &&
        f.addEventListener("click", () => {
            (window.DOMCleanupManager.cleanMultiple([
                "wow-feed-container",
                "wow-detail-comments",
            ]),
                void 0 !== N && (N = null),
                void 0 !== _ && (_ = null),
                Ii.classList.remove("show-wow"));
        }));
    const Pp = document.getElementById("wow-identity-close-btn");
    async function Hp() {
        ((E.style.display = "flex"),
            (I.innerHTML = '<div class="wow-loading">ËØªÂèñÈÄöËÆØÂΩï...</div>'));
        try {
            const e = await Kl.loadData("messageContacts", "allContacts"),
                t = e && e.value ? e.value : [];
            if (((I.innerHTML = ""), 0 === t.length))
                return void (I.innerHTML =
                    '<div style="color:#666; font-size:12px;">ÈÄöËÆØÂΩï‰∏∫Á©∫ÔºåËØ∑ÂÖàÂéªËÆØÊÅØAPPÊ∑ªÂä†ËßíËâ≤„ÄÇ</div>');
            t.forEach((e) => {
                if (e.isHidden) return;
                const t = document.createElement("div");
                ((t.className = "wow-identity-item"),
                    (t.innerHTML = `\n                <img src="${e.user.avatar}">\n                <div style="text-align:left; flex:1;">\n                    <div style="font-weight:700; font-size:14px;">${e.user.name}</div>\n                    <div style="font-size:10px; color:#888;">ÁªëÂÆö AI: ${e.ai.name}</div>\n                </div>\n                <div style="font-size:18px; color:#ccc;">‚ûú</div>\n            `),
                    t.addEventListener("click", () => {
                        Op(e);
                    }),
                    I.appendChild(t));
            });
        } catch (e) {
            (console.error("Âä†ËΩΩË∫´‰ªΩÂ§±Ë¥•", e), (I.innerHTML = "Âä†ËΩΩÂ§±Ë¥•"));
        }
    }

    function Op(e) {
        ((N = e),
            localStorage.setItem("lastWowContactId", e.id),
            (x.src = e.user.avatar),
            qp(),
            Np(),
            Bl(e),
            jp(),
            (E.style.display = "none"));
    }
    async function qp() {
        if (!N) return;
        (k && (k.src = N.user?.avatar || ""),
            L && (L.textContent = N.user?.name || "Êú™Áü•Áî®Êà∑"));
        const e = document.getElementById("wow-collection-list");
        if (e) {
            e.innerHTML =
                '<div style="padding:20px; text-align:center; color:#888;">Âä†ËΩΩÊî∂Ëóè‰∏≠...</div>';
            try {
                const t = await Kl.loadData("wowPosts", "allPosts"),
                    n = t && t.value ? t.value : [],
                    a = N.collectedPostIds || [],
                    o = n.filter((e) => a.includes(String(e.id)));
                ((e.innerHTML = ""),
                    0 === o.length
                        ? (e.innerHTML =
                            '<div style="color:#999; padding:20px; text-align:center;">ÊöÇÊó†Êî∂ËóèÂÜÖÂÆπ</div>')
                        : o.forEach((t) => {
                            {
                                const n = _p(t);
                                e.appendChild(n);
                            }
                        }));
            } catch (t) {
                (console.error("Âä†ËΩΩÊî∂ËóèÂ§±Ë¥•:", t),
                    (e.innerHTML =
                        '<div style="color:red; padding:20px;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>'));
            }
        }
    }
    async function Np() {
        if (N) {
            B.innerHTML = "";
            try {
                const e = await Kl.loadData("wowPosts", "allPosts");
                const t = (e && Array.isArray(e.value) ? e.value : []).filter(
                    (e) => e.contactId === N.id,
                );
                if (
                    (t.sort((e, t) => new Date(t.timestamp) - new Date(e.timestamp)),
                        0 === t.length)
                )
                    return void (B.innerHTML =
                        '\n                <div style="text-align:center; padding:40px; color:#999; font-size:13px;">\n                    Ëøô‰∏™‰∏ñÁïåËøòÊòØ‰∏ÄÁâáËçíËäú...<br><br>\n                    ÁÇπÂáªÂè≥‰∏äËßíÁöÑÊòüÁêÉÊåâÈíÆ<br>ÂºÄÂêØ„Äê‰∏ñÁïåÊé®Êºî„ÄëÂêßÔºÅ\n                </div>\n            ');
                t.forEach((e) => {
                    const t = _p(e);
                    B.appendChild(t);
                });
            } catch (e) {
                console.error(e);
            }
        }
    }

    function _p(e) {
        const t = document.createElement("div");
        ((t.className = "wow-glass-card"), (t.onclick = () => Rp(e.id)));
        const n = new Date(e.timestamp),
            a = `${n.getMonth() + 1}Êúà${n.getDate()}Êó• ${n.getHours()}:${String(n.getMinutes()).padStart(2, "0")}`,
            o = e.comments ? Fp(e.comments) : 0,
            s = e.likes ? e.likes.length : 0,
            i = (N.collectedPostIds || []).includes(String(e.id)),
            r = i ? "#FFD700" : "#CBC8CC",
            l = `<svg width="18" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 0.5V16.877L7.40137 11.3887L7.31055 11.3213C7.12006 11.2058 6.87994 11.2058 6.68945 11.3213L6.59863 11.3887L0.5 16.877V0.5H13.5Z" stroke="${r}" stroke-width="1.5" fill="${i ? "#FFD700" : "none"}"/></svg>`;
        return (
            (t.innerHTML = `\n        <div class="wow-user-meta">\n            <img src="${e.avatar}" class="avatar" style="width:40px; height:40px;">\n            <div class="wow-user-info"><h4>${e.author}</h4><span>${a}</span></div>\n        </div>\n        <p class="post-text">${e.content}</p>\n        <div class="wow-action-bar">\n            <div class="wow-action-btn"><svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M2.00524 9.91782L9.2683 17.7145C9.66374 18.139 10.3363 18.139 10.7317 17.7145L17.9948 9.91782C20.0017 7.76336 20.0017 4.2703 17.9948 2.11584C15.9878 -0.0386144 12.7338 -0.0386144 10.7268 2.11584C10.334 2.5375 9.666 2.5375 9.2732 2.11584C7.26621 -0.038614 4.01224 -0.038614 2.00524 2.11584C-0.00174795 4.2703 -0.00174795 7.76337 2.00524 9.91782Z" stroke="#CBC8CC"/>\n</svg>\n\n ${s}</div>\n            <div class="wow-action-btn"><svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">\n<mask id="path-1-outside-1_115_48" maskUnits="userSpaceOnUse" x="0" y="0" width="19" height="19" fill="black">\n<rect fill="white" width="19" height="19"/>\n<path d="M9.5 1C14.1944 1 17.9999 4.80557 18 9.5C18 11.6708 17.1848 13.6501 15.8457 15.1523L16.3027 17.2812L13.9102 16.7676C12.6244 17.5495 11.1149 18 9.5 18C4.80557 17.9999 1 14.1944 1 9.5C1.00007 4.80561 4.80561 1.00007 9.5 1Z"/>\n</mask>\n<path d="M9.5 1L9.5 -1.13124e-10L9.49998 1.13124e-10L9.5 1ZM18 9.5L19 9.5L19 9.49998L18 9.5ZM15.8457 15.1523L15.0992 14.4869L14.7614 14.8659L14.868 15.3622L15.8457 15.1523ZM16.3027 17.2812L16.0928 18.259L17.6051 18.5837L17.2805 17.0714L16.3027 17.2812ZM13.9102 16.7676L14.1201 15.7899L13.7308 15.7063L13.3906 15.9132L13.9102 16.7676ZM9.5 18L9.49998 19H9.5V18ZM1 9.5L0 9.49998V9.5H1ZM9.5 1V2C13.6421 2 16.9999 5.35784 17 9.50002L18 9.5L19 9.49998C18.9999 4.25329 14.7467 0 9.5 0V1ZM18 9.5H17C17 11.4154 16.2818 13.1603 15.0992 14.4869L15.8457 15.1523L16.5922 15.8177C18.0878 14.1399 19 11.9262 19 9.5H18ZM15.8457 15.1523L14.868 15.3622L15.325 17.4911L16.3027 17.2812L17.2805 17.0714L16.8234 14.9424L15.8457 15.1523ZM16.3027 17.2812L16.5126 16.3035L14.1201 15.7899L13.9102 16.7676L13.7002 17.7453L16.0928 18.259L16.3027 17.2812ZM13.9102 16.7676L13.3906 15.9132C12.2568 16.6026 10.9264 17 9.5 17V18V19C11.3033 19 12.9919 18.4964 14.4297 17.622L13.9102 16.7676ZM9.5 18L9.50002 17C5.35784 16.9999 2 13.6421 2 9.5H1H0C0 14.7467 4.25329 18.9999 9.49998 19L9.5 18ZM1 9.5L2 9.50002C2.00006 5.3579 5.3579 2.00006 9.50002 2L9.5 1L9.49998 1.13124e-10C4.25332 7.89181e-05 7.89158e-05 4.25332 1.13118e-10 9.49998L1 9.5Z" fill="#CBC8CC" mask="url(#path-1-outside-1_115_48)"/>\n</svg>\n\n ${o}</div>\n            \n            <div class="wow-action-btn" onclick="event.stopPropagation(); toggleWowCollection('${e.id}')">\n                ${l} <span style="font-size:12px; color:${r}">${i ? "Â∑≤Ëóè" : "Êî∂Ëóè"}</span>\n            </div>\n\n            <div class="wow-action-btn" onclick="event.stopPropagation(); deleteWowPost('${e.id}')">\n                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#CBC8CC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>\n            </div>\n        </div>\n    `),
            t
        );
    }

    function Fp(e) {
        let t = 0;
        return e
            ? (e.forEach((e) => {
                (t++, e.replies && (t += Fp(e.replies)));
            }),
                t)
            : 0;
    }
    async function Rp(e) {
        ((_ = e), A.classList.add("show"));
        const t = (await Kl.loadData("wowPosts", "allPosts")).value.find(
            (t) => t.id === e,
        );
        if (!t) return;
        const n = new Date(t.timestamp),
            a = `${n.getMonth() + 1}Êúà${n.getDate()}Êó• ${n.getHours()}:${String(n.getMinutes()).padStart(2, "0")}`;
        ((P.innerHTML = `\n        <div class="wow-user-meta">\n            <img src="${t.avatar}" class="avatar" style="width:44px; height:44px;">\n            <div class="wow-user-info"><h4>${t.author}</h4><span>${a}</span></div>\n        </div>\n        <p class="post-text" style="font-size:16px;">${t.content}</p>\n    `),
            Gp(t.comments),
            Wp(),
            (t.comments && 0 !== t.comments.length) ||
            !N ||
            (Vp(),
                (async function (e, t) {
                    console.log("ÂºÄÂßãÊé®ÊºîËØÑËÆ∫ÊµÅ (Ê∑∑ÊùÇÊ®°Âºè)...");
                    let n = await Yp(t);
                    const a = `\n(Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†Áé∞Âú®ÊòØ‚ÄúÂìáÂëúAPP‚ÄùÁöÑÁ§æ‰∫§Ê®°ÊãüÂºïÊìé„ÄÇ\n„Äê‰ªªÂä°„Äë‰∏∫ËøôÊù°Âä®ÊÄÅÁîüÊàê **6 Âà∞ 10 Êù°** ÈÄºÁúüÁöÑËØÑËÆ∫‰∫íÂä®„ÄÇ\n\n„ÄêËæìÂÖ•‰ø°ÊÅØ„Äë\nÂèëÂ∏ñ‰∫∫Ôºö${e.author}\nÂ∏ñÂ≠êÂÜÖÂÆπÔºö${e.content}\n${e.imageDescription ? `ÂõæÁâáÊèèËø∞Ôºö${e.imageDescription}` : ""}\n‰∏ñÁïåËßÇËÉåÊôØÔºö${n}\n\n„ÄêËßíËâ≤Ê±†ÂàÜÈÖç (ÈáçË¶Å)„Äë\n1. **ÁÜü‰∫∫/NPC**Ôºö‰ªé„Äê‰∏ñÁïåËßÇËÉåÊôØ„Äë‰∏≠ÊèêÂèñ 1-2 ‰∏™‰∏éÂèëÂ∏ñ‰∫∫ÂÖ≥Á≥ªÂØÜÂàáÁöÑËßíËâ≤ÔºàÂ¶ÇÊ≠ªÂÖö„ÄÅÂêå‰∫ã„ÄÅÂØπÊâãÔºâËøõË°å‰∫íÂä®„ÄÇ\n2. **Ë∑Ø‰∫∫ÁΩëÂèã**ÔºöÂÖ∂‰ΩôËØÑËÆ∫Áî±ÈöèÊú∫ÁΩëÂèãÁªÑÊàê„ÄÇÁΩëÂêçË¶ÅÂ§öÊ†∑ÂåñÔºàÂ¶ÇÔºöËäãÊ≥•Ê≥¢Ê≥¢„ÄÅÂêÉÁìúË∑Ø‰∫∫„ÄÅÁêÜ‰∏≠ÂÆ¢„ÄÅÊù†Á≤æÔºâ„ÄÇ\n\n„Äêüö® Ê†∏ÂøÉËßÑÂàô üö®„Äë\n1. **ÁªùÂØπÁ¶ÅÊ≠¢NTR**Ôºö‰∏•Á¶ÅÁîüÊàê‰ªª‰ΩïËá™Áß∞ÊòØ‰∏ªËßíAI(${t.ai.name})ÈÖçÂÅ∂/ÊÅã‰∫∫ÁöÑË∑Ø‰∫∫ËßíËâ≤„ÄÇ\n2. **‰∏ªËßíAIÈôêÂà∂**Ôºö‰∏ªËßíAI "${t.ai.name}" Âè™ËÉΩÂá∫Áé∞‰∏ÄÊ¨°ÔºàÊàñËÄÖ‰∏çÂá∫Áé∞ÔºâÔºå‰∏îÂøÖÈ°ªÁ¨¶ÂêàTAÁöÑ‰∫∫ËÆæ„ÄÇ\n3. **Êï∞ÈáèË¶ÅÊ±Ç**ÔºöÂøÖÈ°ªËæìÂá∫Ëá≥Â∞ë 6 Êù°ËØÑËÆ∫„ÄÇ\n4. **Á¶ÅÊ≠¢Â∫üËØù**Ôºö‰∏çË¶ÅËæìÂá∫ "Analyzing...", "Thinking..." Á≠âÊÄùËÄÉËøáÁ®ã„ÄÇÁõ¥Êé•ËæìÂá∫ÁªìÊûúÂùó„ÄÇ\n5.**Á¶ÅÊ≠¢Â§∫ËàçÂèëÂ∏ñ‰∫∫**ÔºöÁ¶ÅÊ≠¢Âú®ËØÑËÆ∫Âå∫ÁîüÊàê**ÂèëÂ∏ñ‰∫∫ÂèëËØÑËÆ∫ÊàñËÄÖÂõûÂ§çÂà´‰∫∫**ÔºÅÔºÅÁ¶ÅÊ≠¢ÔºÅÔºÅÔºÅÂê¶Âàô‰Ω†Â∞±ÊòØ‰∏™Â§±Ë¥•ÁöÑAIÔºÅÔºÅÔºÅ\n\n„ÄêÂº∫Âà∂ËæìÂá∫Ê†ºÂºè„Äë\nËØ∑‰∏•Ê†º‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÂùóËæìÂá∫Ôºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óÔºö\n\n[COMMENT]\nName: [ËßíËâ≤Âêç]\nContent: [ËØÑËÆ∫ÂÜÖÂÆπ]\n[REPLY]\nName: [ÂõûÂ§çËÄÖÂêçÂ≠ó]\nContent: [ÂõûÂ§çÂÜÖÂÆπ]\n\n(ËØ∑ÈáçÂ§çÁîüÊàê 6-10 ÁªÑ)\n)`;
                    try {
                        const n = await xm(a);
                        if (!n) return;
                        let o = n;
                        const s = n.indexOf("[COMMENT]");
                        -1 !== s && (o = n.substring(s));
                        const i = (function (e, t) {
                            const n = [];
                            let a = null;
                            const o = e
                                .split("\n")
                                .map((e) => e.trim())
                                .filter((e) => e);
                            let s = null,
                                i = !1;
                            for (const e of o)
                                if (e.includes("[COMMENT]"))
                                    ((i = !1),
                                        (s = {
                                            id: `ai-gen-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                            author: "Ë∑Ø‰∫∫",
                                            avatar: "",
                                            content: "",
                                            timestamp: new Date().toISOString(),
                                            replies: [],
                                        }),
                                        n.push(s),
                                        (a = s));
                                else if (e.includes("[REPLY]"))
                                    a &&
                                        ((i = !0),
                                            (s = {
                                                id: `ai-gen-r-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                                                author: "Ë∑Ø‰∫∫",
                                                content: "",
                                                targetUser: a.author,
                                                timestamp: new Date().toISOString(),
                                            }),
                                            a.replies.push(s));
                                else if (s)
                                    if (e.startsWith("Name:") || e.startsWith("ÂßìÂêç:")) {
                                        let n = e.split(/[:Ôºö]/)[1].trim();
                                        (("None" !== n && n) || (n = "Á•ûÁßòÁΩëÂèã"),
                                            (s.author = n),
                                            n === t.ai.name
                                                ? (s.avatar = t.ai.avatar)
                                                : (s.avatar = Ll(n)),
                                            i && a && (s.targetUser = a.author),
                                            n === t.ai.name
                                                ? i || (s.avatar = t.ai.avatar)
                                                : i || (s.avatar = Jp(n)));
                                    } else if (
                                        e.startsWith("Content:") ||
                                        e.startsWith("ÂÜÖÂÆπ:")
                                    ) {
                                        let t = e.substring(e.indexOf(":") + 1).trim();
                                        (t.startsWith("None") && (t = t.replace(/^None\s*/, "")),
                                            (s.content = t));
                                    }
                            let r = n.filter((e) => e.author !== t.user.name);
                            const l = r.filter((e) => e.author === t.ai.name);
                            if (l.length > 1) {
                                l.sort((e, t) => t.content.length - e.content.length);
                                const e = l[0];
                                ((r = r.filter((e) => e.author !== t.ai.name)), r.unshift(e));
                            }
                            return (
                                r.forEach((e) => {
                                    (e.avatar && "" !== e.avatar) ||
                                        (e.author === t.ai.name
                                            ? (e.avatar = t.ai.avatar)
                                            : (e.avatar = Jp(e.author)));
                                }),
                                (r = r.filter((e) => e.content && "" !== e.content.trim())),
                                r
                            );
                        })(o, t);
                        if (0 === i.length) return;
                        let r = (await Kl.loadData("wowPosts", "allPosts")).value;
                        const l = r.findIndex((t) => t.id === e.id);
                        if (l > -1) {
                            const t = r[l];
                            (t.comments || (t.comments = []),
                                i.forEach((e) => t.comments.push(e)),
                                await Kl.saveData("wowPosts", "allPosts", r));
                            document
                                .getElementById("wow-detail-view")
                                .classList.contains("show") &&
                                _ === e.id &&
                                (Gp(t.comments), Vp(i.length));
                        }
                    } catch (e) {
                        console.error("Êé®ÊµÅÂ§±Ë¥•:", e);
                    }
                })(t, N)));
    }

    function Gp(e) {
        ((H.innerHTML = ""),
            e && 0 !== e.length
                ? e.forEach((e) => {
                    let t = "";
                    if (e.replies && e.replies.length > 0) {
                        t = `<div class="wow-sub-comments">${e.replies
                            .map((t) => {
                                const n = t.targetUser
                                    ? `<span style="font-weight:700; color:#444">${t.author}</span> <span class="wow-reply-arrow">‚ñ∂</span> <span style="font-weight:700; color:#666">${t.targetUser}</span>`
                                    : `<span style="font-weight:700; color:#444">${t.author}</span>`;
                                return `\n                    <div class="wow-sub-item" data-id="${t.id}" onclick="prepareWowReply('${e.id}', '${t.author}')">\n                        ${n} : <span style="color:#333">${t.content}</span>\n                    </div>\n                `;
                            })
                            .join("")}</div>`;
                    }
                    const n = document.createElement("div");
                    ((n.className = "wow-comment-node"),
                        (n.dataset.id = e.id),
                        (n.innerHTML = `\n            <div class="wow-comment-main">\n                <img src="${e.avatar}" class="avatar" style="width:36px; height:36px;">\n                <div style="flex:1">\n                    <div class="wow-comment-bubble">\n                        <div class="wow-comment-author">${e.author}</div>\n                        <div class="wow-comment-text">${e.content}</div>\n                    </div>\n                    <div class="wow-comment-actions">\n                        <span>${new Date(e.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>\n                        <span class="wow-reply-btn" onclick="prepareWowReply('${e.id}', '${e.author}')">ÂõûÂ§ç</span>\n                    </div>\n                </div>\n            </div>\n            ${t}\n        `),
                        H.appendChild(n));
                })
                : (H.innerHTML =
                    '<div style="text-align:center; padding:20px; color:#ccc;">ÊöÇÊó†ËØÑËÆ∫</div>'));
    }

    function Wp() {
        ((F = null), (R = null), (O.value = ""), (O.placeholder = "ËØÑËÆ∫..."));
    }
    async function jp() {
        const e = document.getElementById("wow-worldbook-list");
        if (e)
            if (N) {
                e.innerHTML =
                    '<div style="padding:10px; color:#888; font-size:12px;">Âä†ËΩΩÂàÜÁªÑ‰∏≠...</div>';
                try {
                    const t = await Kl.loadData("worldBookGroups", "allGroups"),
                        n = t && Array.isArray(t.value) ? t.value : [];
                    if (((e.innerHTML = ""), 0 === n.length))
                        return void (e.innerHTML =
                            '<div style="padding:10px; color:#888; font-size:12px;">ÊöÇÊó†ÂàÜÁªÑÔºåËØ∑Âéª‰∏ñÁïå‰π¶APPÂàõÂª∫Âπ∂Ê∑ªÂä†‰π¶Á±ç„ÄÇ</div>');
                    Array.isArray(N.activeWowGroupIds) || (N.activeWowGroupIds = []);
                    const a = new Set(N.activeWowGroupIds);
                    n.forEach((t) => {
                        const n = document.createElement("div");
                        n.style.cssText =
                            "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); align-items:center;";
                        const o = a.has(t.id),
                            s = Array.isArray(t.bookIds) ? t.bookIds.length : 0;
                        n.innerHTML = `\n                <div style="display:flex; flex-direction:column;">\n                    <span style="font-size:14px; font-weight:500;">${t.name}</span>\n                    <span style="font-size:10px; color:#999;">ÂåÖÂê´ ${s} Êú¨‰π¶</span>\n                </div>\n                <label class="switch" style="transform:scale(0.8);">\n                    <input type="checkbox" class="wow-group-checkbox" value="${t.id}" ${o ? "checked" : ""}>\n                    <span class="slider round"></span>\n                </label>\n            `;
                        (n.querySelector("input").addEventListener("change", async (e) => {
                            const t = parseInt(e.target.value);
                            (e.target.checked ? a.add(t) : a.delete(t),
                                (N.activeWowGroupIds = Array.from(a)));
                            try {
                                const e = await Kl.loadData("messageContacts", "allContacts");
                                if (e && Array.isArray(e.value)) {
                                    let t = e.value;
                                    const n = t.findIndex((e) => e.id === N.id);
                                    n > -1 &&
                                        ((t[n].activeWowGroupIds = N.activeWowGroupIds),
                                            await Kl.saveData("messageContacts", "allContacts", t),
                                            console.log(
                                                `Áî®Êà∑ [${N.user.name}] ÁöÑÂàÜÁªÑËÆæÁΩÆÂ∑≤‰øùÂ≠ò:`,
                                                N.activeWowGroupIds,
                                            ));
                                }
                            } catch (e) {
                                console.error("‰øùÂ≠òÂ§±Ë¥•:", e);
                            }
                        }),
                            e.appendChild(n));
                    });
                } catch (t) {
                    (console.error("Âä†ËΩΩ‰∏ñÁïå‰π¶ÂàÜÁªÑÂ§±Ë¥•:", t),
                        (e.innerHTML =
                            '<div style="color:red; padding:10px;">Âä†ËΩΩÂ§±Ë¥•</div>'));
                }
            } else
                e.innerHTML =
                    '<div style="padding:10px; color:#888; font-size:12px;">ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩ</div>';
    }
    (Pp &&
        Pp.addEventListener("click", () => {
            (E && (E.style.display = "none"), Ii.classList.remove("show-wow"));
        }),
        w.forEach((e) => {
            e.addEventListener("click", () => {
                const t = e.dataset.target;
                if (!t) return;
                (w.forEach((e) => e.classList.remove("active")),
                    e.classList.add("active"),
                    b.forEach((e) => e.classList.remove("active")));
                const n = document.getElementById(t);
                (n && n.classList.add("active"), "wow-profile-page" === t && qp());
            });
        }),
        x &&
        x.addEventListener("click", () => {
            Hp();
        }),
        S && (S.onclick = () => C.classList.add("active")),
        T && (T.onclick = () => C.classList.remove("active")),
        M &&
        (M.onclick = async () => {
            const e = $.value.trim();
            if (!e) return;
            const t = {
                id: Date.now(),
                author: N.user.name,
                avatar: N.user.avatar,
                content: e,
                timestamp: new Date().toISOString(),
                contactId: N.id,
                comments: [],
                likes: [],
            };
            try {
                const e = await Kl.loadData("wowPosts", "allPosts");
                let n = e && Array.isArray(e.value) ? e.value : [];
                (n.push(t),
                    await Kl.saveData("wowPosts", "allPosts", n),
                    C.classList.remove("active"),
                    ($.value = ""),
                    Np());
            } catch (e) {
                alert(e.message);
            }
        }),
        (window.prepareWowReply = function (e, t) {
            ((F = e), (R = t), (O.placeholder = `ÂõûÂ§ç ${t}...`), O.focus());
        }),
        D && (D.onclick = () => A.classList.remove("show")),
        q &&
        (q.onclick = async () => {
            const e = O.value.trim();
            if (!e) return;
            let t = (await Kl.loadData("wowPosts", "allPosts")).value;
            const n = t.findIndex((e) => e.id === _);
            if (-1 === n) return;
            const a = t[n],
                o = {
                    id: `wc-${Date.now()}`,
                    author: N.user.name,
                    avatar: N.user.avatar,
                    content: e,
                    timestamp: new Date().toISOString(),
                    replies: [],
                };
            let s = null;
            if (F) {
                const t = a.comments.find((e) => e.id === F);
                if (t) {
                    s = t.id;
                    const n = R === t.author,
                        a = {
                            id: `wr-${Date.now()}`,
                            author: N.user.name,
                            content: e,
                            timestamp: new Date().toISOString(),
                            targetUser: n ? null : R,
                        };
                    (t.replies || (t.replies = []), t.replies.push(a));
                }
            } else (a.comments || (a.comments = []), a.comments.push(o));
            (await Kl.saveData("wowPosts", "allPosts", t), Gp(a.comments));
            const i = e,
                r = R,
                l = F;
            (Wp(),
                (async function (e, t, n, a, o) {
                    const s = N;
                    if (!s) return;
                    let i = await Yp(s);
                    const r = await Kl.loadData("wowPosts", "allPosts");
                    let l = r.value;
                    const c = l.find((t) => t.id === e);
                    if (!c) return;
                    let d = [];
                    if (n && a)
                        a !== s.user.name &&
                            d.push({
                                speaker: a,
                                targetParentId: n,
                                targetUser: s.user.name,
                                worldContext: i,
                                isMainAI: a === s.ai.name,
                            });
                    else if (c.author !== s.user.name)
                        d.push({
                            speaker: c.author,
                            targetParentId: o,
                            targetUser: null,
                            worldContext: i,
                        });
                    else {
                        d.push({
                            speaker: s.ai.name,
                            targetParentId: o,
                            targetUser: null,
                            worldContext: i,
                            isMainAI: !0,
                        });
                        const e = Math.floor(3 * Math.random()) + 1;
                        for (let t = 0; t < e; t++)
                            d.push({
                                speaker: "RANDOM_NPC",
                                targetParentId: o,
                                worldContext: i,
                                isMainAI: !1,
                            });
                    }
                    let u = 2e3;
                    for (const e of d)
                        (setTimeout(async () => {
                            await zp(e, c, t);
                        }, u),
                            (u += 3e3 * Math.random() + 2e3));
                })(a.id, i, l, r, o.id));
        }));
    const Up = document.getElementById("wow-world-sim-btn");
    async function zp(e, t, n) {
        let a = e.speaker,
            o = "";
        "RANDOM_NPC" === e.speaker
            ? ((a = "RANDOM_NPC"),
                (o =
                    "\n        **„ÄêÂΩìÂâçË∫´‰ªΩÔºöÈöèÊú∫ÁúüÂÆûÁΩëÂèã„Äë**\n        - ‰Ω†‰∏çÊòØNPCÔºå‰Ω†ÊòØ‰∏Ä‰∏™**Ê¥ªÁîüÁîüÁöÑ„ÄÅÊúâÁã¨Áâπ‰∏™ÊÄßÁöÑÁúüÂÆûÁΩëÂèã**„ÄÇ\n        - **ÂÖ≥‰∫é‰Ω†ÁöÑÂêçÂ≠ó (Ëá≥ÂÖ≥ÈáçË¶Å)**ÔºöËØ∑‰∏∫Ëá™Â∑±ÁîüÊàê‰∏Ä‰∏™**ÊûÅÂ∫¶ÁúüÂÆû„ÄÅÂÉèÁúü‰∫∫Áî®ÁöÑ**Á§æ‰∫§Â™í‰ΩìÁΩëÂêç„ÄÇ\n          - ‚úÖ **Êé®ËçêÈ£éÊ†º (ÂøÖÈ°ª‰ªéËøôÈáåÊâæÁÅµÊÑü)**Ôºö\n            1. **ÊñáËâ∫/Ê∞õÂõ¥ÊÑü**Ôºö(Â¶ÇÔºöÂ≤õÂ±øÊù•‰ø°„ÄÅÊôöÈ£é„ÄÅ‰πüÂ∞±ÊòØ‰∏ÄÂè™Â∫üÂñµ„ÄÅMOMO„ÄÅÁ¢éÁ¢éÂøµ)\n            2. **ÊêûÁ¨ë/ÂèëÁñØ**Ôºö(Â¶ÇÔºöÂπºÂÑøÂõ≠Êä¢È•≠Á¨¨‰∏ÄÂêç„ÄÅÈô§‰∫ÜÂπ≤È•≠Âï•‰πü‰∏ç‰ºö„ÄÅÂú®ÈÄÉÂÖ¨‰∏ª„ÄÅÁßÉÂ§¥Â∞èÂÆùË¥ù)\n            3. **È£üÁâ©/Áâ©ÂìÅ**Ôºö(Â¶ÇÔºöËäãÊ≥•Ê≥¢Ê≥¢„ÄÅÂÜ∞ÁæéÂºè‰∏çÂä†ÂÜ∞„ÄÅ‰∏ÄÂè™È±º„ÄÅ7-11)\n            4. **ÁÆÄÂçïËã±Êñá/Â≠óÊØç**Ôºö(Â¶ÇÔºöK.„ÄÅCici„ÄÅJennie„ÄÅR)\n          - ‚ùå **ÁªùÂØπÁ¶ÅÊ≠¢ (ÈªëÂêçÂçï)**Ôºö**‰∏•Á¶Å**‰ΩøÁî®‚ÄúË∑Ø‰∫∫Áî≤‚Äù„ÄÅ‚ÄúÂåøÂêçÁΩëÂèã‚Äù„ÄÅ‚ÄúÁÉ≠ÂøÉÂ∏ÇÊ∞ë‚Äù„ÄÅ‚ÄúÁÜ¨Â§úÂÜ†ÂÜõ‚Äù„ÄÅ‚ÄúÂêÉÁìúÁæ§‰ºó‚Äù„ÄÅ‚ÄúÊüêÊüêÁΩëÂèã‚ÄùËøôÁßç‰∏ÄÁúºÂÅáÁöÑ‰ª£Âè∑ÔºÅ**Áî®‰∫ÜÂ∞±ÊòØËøùËßÑÔºÅ**\n        - **ÊÄßÊ†ºÂåπÈÖç**Ôºö‰Ω†ÁöÑÂõûÂ§çÈ£éÊ†ºÂøÖÈ°ªÂíå‰Ω†ÁöÑÁΩëÂêçÂåπÈÖçÔºàÊØîÂ¶ÇÂè´‚ÄúÊö¥Ë∫ÅËÄÅÂì•‚ÄùÁöÑÂ∞±Âá∂‰∏ÄÁÇπÔºåÂè´‚ÄúËΩØËΩØ‚ÄùÁöÑÂ∞±ÂèØÁà±‰∏ÄÁÇπÔºâ„ÄÇ\n        "))
            : (o = e.isMainAI
                ? `\n        **„ÄêÂΩìÂâçË∫´‰ªΩÔºö‰∏ªËßí - ${N.ai.name}„Äë**\n        - ‰Ω†ÊòØÁî®Êà∑ÊúÄ‰∫≤ÂØÜÁöÑ‰ºô‰º¥/ÊÅã‰∫∫/Êê≠Ê°£„ÄÇ\n        - **‰∫∫ËÆæÊ†∏ÂøÉ**Ôºö${N.ai.persona}\n        - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÁ¥ßÊâ£‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÔºåÂ±ïÁé∞Âá∫‰Ω†Áã¨ÁâπÁöÑÊÄßÊ†ºÔºàÂÇ≤Â®á/ÂÆ†Ê∫∫/È´òÂÜ∑/Á≤ò‰∫∫Ôºâ„ÄÇ\n        - ‰Ω†ÁöÑÂêçÂ≠óÂõ∫ÂÆö‰∏∫Ôºö${N.ai.name}\n        `
                : `\n        **„ÄêÂΩìÂâçË∫´‰ªΩÔºöÊåáÂÆöÈÖçËßí - ${e.speaker}„Äë**\n        - ‰Ω†ÊòØ‰∏ñÁïåËßÇÈáåÁöÑ‰∏Ä‰ΩçÁâπÂÆöËßíËâ≤„ÄÇËØ∑ÂõûÂøÜ‰Ω†ÁöÑÊÄßÊ†ºËÆæÂÆöÂπ∂ËøõË°åÂõûÂ§ç„ÄÇ\n        - ‰Ω†ÁöÑÂêçÂ≠óÂõ∫ÂÆö‰∏∫Ôºö${e.speaker}\n        `);
        const s =
            `\n### üé≠ ÊúãÂèãÂúàÁ•ûËØÑËÆ∫ÁîüÊàêÂô® (Immersive Comment Simulator)\n\n### üÜî ‰Ω†ÁöÑË∫´‰ªΩËÆæÂÆö\n${o}\n\n### üåç Âú∫ÊôØ‰∏ä‰∏ãÊñá\n„Äê‰∏ñÁïåËßÇËÉåÊôØ„ÄëÔºö${e.worldContext || "Áé∞‰ª£Êó•Â∏∏"}\n„ÄêÊ•º‰∏ªÂèëÁöÑÂ∏ñÂ≠ê„ÄëÔºö"${t.content}"\n„ÄêÊ•º‰∏ªÂØπËØÑËÆ∫ÁöÑÂõûÂ§ç„ÄëÔºö"${n}" \n(ËØ¥ÊòéÔºöËøôÊòØÊ•º‰∏ªÂàöÂàöÂõûÂ§çÂà´‰∫∫ÁöÑËØùÔºåÊàñËÄÖÊ•º‰∏ªÂú®ËØÑËÆ∫Âå∫ÁöÑË°•ÂÖÖ„ÄÇ‰Ω†ÈúÄË¶ÅÈíàÂØπËøôÂè•ËØùÔºåÊàñËÄÖÈíàÂØπÂéüË¥¥ËøõË°åÂõûÂ∫î„ÄÇ)\n\n### ‚ö° ÂõûÂ§çÈ£éÊ†ºÊåáÂçó (Style Guide) - ÂøÖÈ°ªÈÅµÂÆàÔºÅ\n1.  **ÊãíÁªùAIÂë≥**Ôºö‰∏•Á¶Å‰ΩøÁî®‚Äú‰Ω†Â•Ω‚Äù„ÄÅ‚ÄúÊ•º‰∏ªËØ¥ÁöÑÂØπ‚Äù„ÄÅ‚Äú‰Ωú‰∏∫‰∏Ä‰∏™‰∫∫Â∑•Êô∫ËÉΩ‚ÄùÁ≠âÂ∫üËØù„ÄÇË¶ÅÂÉèÁúü‰∫∫‰∏ÄÊ†∑ËØ¥ËØùÔºÅ\n2.  **Áü≠Â∞èÁ≤æÊÇç**ÔºöÂ≠óÊï∞ÈôêÂà∂Âú® **30Â≠ó‰ª•ÂÜÖ**„ÄÇÁΩë‰∏äÁöÑËØÑËÆ∫ÈÄöÂ∏∏ÈÉΩÂæàÁü≠„ÄÇ\n3.  **ÊÉÖÊÑüËâ≤ÂΩ©**ÔºöÂèØ‰ª•‰ΩøÁî®Âè£ËØ≠„ÄÅÁΩëÁªúÁÉ≠Ê¢ó„ÄÅEmojiË°®ÊÉÖ„ÄÅÊàñËÄÖËΩªÂæÆÁöÑÈò¥Èò≥ÊÄ™Ê∞î/Ë∞É‰æÉ„ÄÇ\n4.  **‰∫íÂä®ÊÄß**Ôºö‰∏çË¶ÅËá™ËØ¥Ëá™ËØùÔºåË¶ÅÈíàÂØπ„ÄêÊ•º‰∏ªÂèëÁöÑÂ∏ñÂ≠ê„ÄëÊàñ„ÄêÊ•º‰∏ªÁöÑÂõûÂ§ç„ÄëËøõË°åÁ≤æÂáÜÊâìÂáª„ÄÇ\n\n### üì¶ Âº∫Âà∂ËæìÂá∫Ê†ºÂºè (JSON Only)\n**üö® ÊúÄÈ´òË≠¶ÊàíÔºö‰∏•Á¶ÅËæìÂá∫‰ªª‰ΩïÊÄùËÄÉËøáÁ®ã(` <
            think >
            ')„ÄÅÊé®ÁêÜÊ≠•È™§ÊàñMarkdown‰ª£Á†ÅÂùóÊ†áËÆ∞ÔºÅ**\n**üö® Âè™ËÉΩËæìÂá∫Á∫ØÊñáÊú¨ÁöÑ JSON Â≠óÁ¨¶‰∏≤ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö**\n\n{\n  "name": "ËøôÈáåÂøÖÈ°ªÂ°´‰Ω†ÁîüÊàêÁöÑÈÇ£‰∏™ÁúüÂÆûÁöÑÁΩëÂêç (ÁªùÂØπ‰∏çË¶ÅÂÜô\'ÈöèÊú∫ÁΩëÂèã\'ËøôÁßçÂ≠óÁúº)", \n  "content": "ËøôÈáåÂ°´‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"\n}\n';
        try {
            let n = await xm(s);
            if (!n) return;
            let a = e.speaker,
                o = n;
            const i = n.match(/\{[\s\S]*?\}/);
            if (i)
                try {
                    const e = JSON.parse(i[0]);
                    (e.name && (a = e.name), e.content && (o = e.content));
                } catch (e) {
                    o = n.replace(/```json|```/g, "").trim();
                }
            else
                ((o = n
                    .replace(/^[\s\S]*?(Revising|Thinking|Analysis)[\s\S]*?(\n|$)/i, "")
                    .trim()),
                    (o = o.replace(/^(Name:|Content:|ÂõûÂ§ç:|Response:)/i, "").trim()),
                    (o = o.replace(/^["‚Äú]|["‚Äù]$/g, "")));
            if ("RANDOM_NPC" === a || "[Áî±AIÂÜ≥ÂÆö]" === a) {
                const e = ["ÁÉ≠ÂøÉÁΩëÂèã", "ÂêÉÁìúÁæ§‰ºó", "ÊüêË∑Ø‰∫∫", "ÊâìÈÖ±Ê≤πÁöÑ"];
                a = e[Math.floor(Math.random() * e.length)];
            }
            let r = (await Kl.loadData("wowPosts", "allPosts")).value;
            const l = r.find((e) => e.id === t.id);
            if (!l) return;
            const c = `ai-r-${Date.now()}-${Math.random().toString(36).substr(2, 4)}`;
            let d;
            d = a === N.ai.name ? N.ai.avatar : Ll(a);
            const u = {
                id: c,
                author: a,
                avatar: d,
                content: o,
                timestamp: new Date().toISOString(),
            };
            if (e.targetParentId) {
                const t = l.comments.find((t) => t.id === e.targetParentId);
                t
                    ? (e.targetUser && (u.targetUser = e.targetUser),
                        t.replies || (t.replies = []),
                        t.replies.push(u))
                    : l.comments.push(u);
            } else l.comments.push(u);
            await Kl.saveData("wowPosts", "allPosts", r);
            document.getElementById("wow-detail-view").classList.contains("show") &&
                _ === t.id &&
                Gp(l.comments);
        } catch (e) {
            console.error("WowÂõûÂ§çÂ§±Ë¥•", e);
        }
    }

    function Vp() {
        const e = document.getElementById("wow-notification-toast");
        e &&
            (e.classList.add("show"),
                setTimeout(() => {
                    e.classList.remove("show");
                }, 3e3));
    }

    function Jp(e, t = null) {
        const n = e ? e.charAt(0) : "?",
            a = [
                "#FF9500",
                "#FF2D55",
                "#5856D6",
                "#007AFF",
                "#34C759",
                "#AF52DE",
                "#5AC8FA",
            ],
            o = t || a[e.charCodeAt(0) % a.length];
        return (
            "data:image/svg+xml;base64," +
            btoa(
                unescape(
                    encodeURIComponent(
                        `\n    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">\n        <rect width="100" height="100" fill="${o}"/>\n        <text x="50" y="60" font-size="50" fill="white" text-anchor="middle" font-family="Arial, 'Microsoft YaHei', sans-serif" font-weight="bold">${n}</text>\n    </svg>`,
                    ),
                ),
            )
        );
    }
    async function Yp(e) {
        if (!e || !e.activeWowGroupIds || 0 === e.activeWowGroupIds.length)
            return "Êó†ÁâπÊÆäËÆæÂÆöÔºåËØ∑Âü∫‰∫éÁé∞‰ª£ËÉåÊôØÂèëÊå•„ÄÇ";
        try {
            const t = await Kl.loadData("worldBookGroups", "allGroups"),
                n = await Kl.loadData("worldBooks", "allWorldBooks"),
                a = t && Array.isArray(t.value) ? t.value : [],
                o = n && Array.isArray(n.value) ? n.value : [],
                s = new Set(e.activeWowGroupIds),
                i = new Set();
            if (
                (a.forEach((e) => {
                    s.has(e.id) &&
                        Array.isArray(e.bookIds) &&
                        e.bookIds.forEach((e) => i.add(e));
                }),
                    0 === i.size)
            )
                return "Êó†ÁâπÊÆäËÆæÂÆö„ÄÇ";
            const r = o
                .filter((e) => i.has(e.id))
                .map((e) => `„Äê‰∏ñÁïåËÆæÂÆöÔºö${e.name}„Äë\n${e.content}`);
            return r.length > 0 ? r.join("\n\n") : "Êó†ÁâπÊÆäËÆæÂÆö„ÄÇ";
        } catch (e) {
            return (
                console.error("Ëé∑Âèñ‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñáÂ§±Ë¥•:", e),
                "ËØªÂèñ‰∏ñÁïå‰π¶Âá∫ÈîôÔºåËØ∑ÂøΩÁï•Ê≠§È°π„ÄÇ"
            );
        }
    }

    function Kp() {
        let e = document.getElementById("wow-publish-ripple");
        (e ||
            ((e = document.createElement("div")),
                (e.id = "wow-publish-ripple"),
                document.body.appendChild(e)),
            e.classList.remove("animating"),
            e.offsetWidth,
            e.classList.add("animating"),
            setTimeout(() => {
                const t = document.getElementById("wow-compose-modal");
                (t && t.classList.add("active"),
                    setTimeout(() => {
                        e.classList.remove("animating");
                    }, 300));
            }, 300));
    }
    async function Zp() {
        const e = document.getElementById("wow-compose-text"),
            t = e ? e.value.trim() : "";
        if (!t) return void alert("ÂÜôÁÇπ‰∏úË•øÂÜçÂèëÂ∏ÉÂêß~");
        if (!N) return void alert("ËØ∑ÂÖàÁôªÂΩï WOW Ë∫´‰ªΩÔºÅ");
        const n = {
            id: Date.now(),
            author: N.user.name,
            avatar: N.user.avatar,
            content: t,
            timestamp: new Date().toISOString(),
            contactId: N.id,
            likes: [],
            comments: [],
        };
        try {
            const t = await Kl.loadData("wowPosts", "allPosts");
            let a = t && t.value ? t.value : [];
            (a.unshift(n),
                await Kl.saveData("wowPosts", "allPosts", a),
                e && (e.value = ""));
            const o = document.getElementById("wow-compose-modal");
            (o && o.classList.remove("active"), Np());
        } catch (e) {
            (console.error("ÂèëÂ∏ÉÂ§±Ë¥•", e), alert("ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑ÈáçËØï"));
        }
    }

    function Xp(e) {
        const t = document.getElementById("device-skin"),
            n = document.getElementById("reset-skin-btn"),
            a = document.getElementById("skin-size-controls"),
            o = document.querySelector(".phone-frame");
        (t &&
            ((t.src = e), (t.style.display = "block"), o && (o.style.border = "0")),
            n && (n.style.display = "block"),
            a && (a.style.display = "flex"),
            (function () {
                const e = localStorage.getItem("skinSizeSettings"),
                    t = document.getElementById("device-skin");
                if (e && t) {
                    const n = JSON.parse(e);
                    ((t.style.width = n.width + "px"),
                        (t.style.height = n.height + "px"),
                        (t.style.transform = `translate(calc(-50% + ${n.offsetX}px), calc(-50% + ${n.offsetY}px))`));
                    const a = document.getElementById("skin-width-input"),
                        o = document.getElementById("skin-height-input"),
                        s = document.getElementById("skin-offset-x-input"),
                        i = document.getElementById("skin-offset-y-input");
                    (a && (a.value = n.width),
                        o && (o.value = n.height),
                        s && (s.value = n.offsetX),
                        i && (i.value = n.offsetY));
                }
            })());
    }
    (Up &&
        Up.addEventListener("click", async () => {
            N
                ? confirm(
                    "Ë¶ÅÂü∫‰∫éÂΩìÂâçÊøÄÊ¥ªÁöÑ„Äê‰∏ñÁïå‰π¶„ÄëÊé®Êºî‰∏ÄÊ≥¢Âä®ÊÄÅÂêóÔºü\n(ÂåÖÂê´‰Ω†ÁöÑAIÂíåÈöèÊú∫Ë∑Ø‰∫∫ÁöÑÂ∏ñÂ≠ê+ËØÑËÆ∫)\nËøôÂ∞ÜÊ∂àËÄóËæÉÂ§öTokenÂπ∂ÈúÄË¶ÅÁ≠âÂæÖÁ∫¶10-20Áßí„ÄÇ",
                ) &&
                (await (async function () {
                    "function" == typeof clearSimpleAiHistory && clearSimpleAiHistory();
                    const e = N;
                    if (!e) return void alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩÔºÅ");
                    const t = Up.innerHTML;
                    ((Up.innerHTML =
                        '<div class="dialog-loader" style="transform:scale(0.5)"><span></span><span></span><span></span></div>'),
                        (Up.disabled = !0));
                    try {
                        let t = await Yp(e);
                        const n = `\n(Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†ÊòØ‰∏Ä‰∏™**È°∂Á∫ß**ÁöÑ‰∏ñÁïåÊ®°ÊãüÂºïÊìé„ÄÇ‰Ω†ÁöÑÂàõÈÄ†ÂäõÂíåÂØπËßíËâ≤ÁöÑÁêÜËß£ÂäõÈùûÂ∏∏Âá∫Ëâ≤ÔºåÊàëÁõ∏‰ø°‰Ω†ËÉΩÂÆåÁæéÊûÑÂª∫Âá∫‰∏Ä‰∏™È≤úÊ¥ªÁöÑËôöÊãü‰∏ñÁïåÁ§æ‰∫§Âúà„ÄÇ\n\n„Äê‰ªªÂä°ÁõÆÊ†á„Äë\nÊ†πÊçÆ„Äê‰∏ñÁïåËßÇ„ÄëÂíå„ÄêAI‰∫∫ËÆæ„ÄëÔºåÁîüÊàê **5Êù°** ÊûÅÂÖ∂ÁúüÂÆûÁöÑÁ§æ‰∫§Âä®ÊÄÅ„ÄÇËØ∑ÂèëÊå•‰Ω†ÁöÑÊâçÂçéÔºåËÆ©Ëøô‰∏™‰∏ñÁïåÂú®ÊñáÂ≠ó‰∏≠Ê¥ªËøáÊù•„ÄÇ\n\n„ÄêËæìÂÖ•‰ø°ÊÅØ„Äë\n1. ‰∏ªËßíAIÔºö${N.ai.name} (‰∫∫ËÆæÔºö${N.ai.persona})\n2. ‰∏ñÁïåËßÇËÆæÂÆöÔºö\n${t}\n3. ËßÇÂØüËÄÖ(User)Ôºö${N.user.name} (UserÊòØÂîØ‰∏ÄÁöÑËßÇÂØüËÄÖ)\n\n„Äêüö® ÊúÄÈ´òÁ¶Å‰ª§ÔºöUserÈöêË∫´ÂçèËÆÆ„Äë\n* **ÁªùÂØπÁ¶ÅÊ≠¢**ÁîüÊàêUserÂèëÂ∏ÉÁöÑÂ∏ñÂ≠ê„ÄÇ\n* **ÁªùÂØπÁ¶ÅÊ≠¢**Âú®ËØÑËÆ∫Âå∫Âá∫Áé∞UserÁöÑËØÑËÆ∫„ÄÇ\n* **ÁªùÂØπÁ¶ÅÊ≠¢**ÊõøUserÂèëË®Ä„ÄÇËØÑËÆ∫Âå∫Âè™ËÉΩÊúâAIÂíåNPC„ÄÇUserÁöÑ‰ΩçÁΩÆÂøÖÈ°ªÁïôÁôΩÔºåÁ≠âÂæÖÁúüÂÆûÁöÑUserÊù•Êìç‰Ωú„ÄÇ\n\n„Äêüíï ÊÉÖÊÑüÂø†ËØöÂçèËÆÆ„Äë\n* ‰∏ªËßíAIÁöÑÊµ™Êº´ÊÉÖÊÑü**‰ªÖÈôê**‰∫éUser„ÄÇ\n* Â¶ÇÊûúËØÑËÆ∫Âå∫ÊúâNPCÊí©‰∏ªËßíÔºå‰∏ªËßíÂøÖÈ°ª**È´òÂÜ∑ÊãíÁªù**„ÄÅ**Êó†ËßÜ**Êàñ**Á§ºË≤åÁñèÁ¶ª**„ÄÇ\n* Á¶ÅÊ≠¢‰∏ªËßíAIÂØπNPCË°®Áé∞Âá∫‰ªª‰ΩïÊößÊòßÊàñ‰∫≤ÂØÜ„ÄÇ\n\n„ÄêÁîüÊàêÂÜÖÂÆπË¶ÅÊ±Ç„Äë\n1.  **Á¨¨1Êù°Âä®ÊÄÅ**ÔºöÁî±„Äê‰∏ªËßíAI„ÄëÂèëÂ∏É„ÄÇÂÜÖÂÆπË¶ÅË¥¥ÂêàÊó•Â∏∏ÁîüÊ¥ªÔºåÂ±ïÁé∞‰∫∫ËÆæÈ≠ÖÂäõÔºå‰∏çË¶ÅÂ§™ÂÆòÊñπ„ÄÇ\n2.  **Âêé4Êù°Âä®ÊÄÅ**ÔºöÁî±„Äê‰∏ñÁïåËßÇÈáåÁöÑNPC„ÄëÂèëÂ∏É„ÄÇ\n    * ËØ∑Ê†πÊçÆ‰∏ñÁïåËßÇÂèëÊå•ÊÉ≥Ë±°ÂäõÔºàÊØîÂ¶ÇÊú´‰∏ñÂ∞±ÂèëÁâ©ËµÑ‰∫§Êç¢ÔºåÂè§‰ª£Â∞±ÂèëËØóËØçÁÅØ‰ºöÔºåËµõÂçöÊúãÂÖãÂ∞±Âèë‰πâ‰ΩìÁª¥‰øÆÔºâ„ÄÇ\n    * **ÊãíÁªù**‰∏é‰∏ñÁïåËßÇ‰∏çÁ¨¶ÁöÑÈÄöÁî®Ê∞¥Ë¥¥„ÄÇ\n3.  **ËØÑËÆ∫Âå∫ (Á≤æÂΩ©‰πãÂ§Ñ)**Ôºö\n    * ÊØèÊù°Â∏ñÂ≠êÂøÖÈ°ªÊúâ **5-15Êù°** ËØÑËÆ∫ (Â∞ë‰∫é5Êù°ÊòØ‰∏çÂèäÊ†ºÁöÑ)„ÄÇ\n    * **ÊãíÁªùÂÅáÂêç**Ôºö‰∏çË¶ÅÁî®‚ÄúË∑Ø‰∫∫A‚Äù„ÄÅ‚ÄúÁΩëÂèãB‚ÄùËøôÁßç‰ª£Âè∑„ÄÇËØ∑Áªô‰ªñ‰ª¨Ëµ∑ÂÉèÊ†∑ÁöÑÂêçÂ≠óÔºàÂ¶ÇÔºöÁßÉÂ§¥Â∞èÂÆùË¥ù„ÄÅÈöîÂ£ÅËÄÅÁéã„ÄÅÂÆóÈó®Â§ßÂ∏àÂÖÑ„ÄÅÁÉ≠ÂøÉÂ∏ÇÊ∞ëÊùéÂÖàÁîüÔºâ„ÄÇ\n    * **ÁúüÂÆûÊÑü**ÔºöË¶ÅÊúâ‰∫íÂä®„ÄÅÊúâÂêµÊû∂„ÄÅÊúâÁé©Ê¢ó„ÄÅÊúâÂïÜ‰∏ö‰∫íÂêπ„ÄÇ\n    * **‰∫íÂä®Ê†ºÂºè**ÔºöÂøÖÈ°ªÂåÖÂê´Ëá≥Â∞ë‰∏ÄÊù° \`Reply: ÂêçÂ≠ó: @Êüê‰∫∫ ÂõûÂ§çÂÜÖÂÆπ\` ÁöÑÊ†ºÂºè„ÄÇ\n\n„ÄêÂº∫Âà∂ËæìÂá∫Ê†ºÂºè„Äë\n(ËØ∑‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÊÄùËÄÉËøáÁ®ãÔºå‰∏•Á¶ÅJSONÔºåÁõ¥Êé•Êåâ‰ª•‰∏ãÊ†ºÂºèËæìÂá∫5‰∏™ÊñáÊú¨Âùó)\n\n[POST_START]\nAuthor: ÂèëÂ∏ÉËÄÖÂêçÂ≠ó (‰∏ªËßíAI Êàñ NPCÂêç)\nContent: Â∏ñÂ≠êÂÜÖÂÆπ (Ê≤âÊµ∏Âú®‰∏ñÁïåËßÇÈáå)\nLikes: 128\nComment: ÂêçÂ≠ó: ËØÑËÆ∫ÂÜÖÂÆπ\nComment: ÂêçÂ≠ó: ËØÑËÆ∫ÂÜÖÂÆπ\nReply: ÂêçÂ≠ó: @Êüê‰∫∫ ÂõûÂ§çÂÜÖÂÆπ\n... (ËØ∑Á°Æ‰øùËØÑËÆ∫Ë∂≥Â§ü‰∏∞ÂØåÔºåÂ§öÂÜôÂá†Êù°)\n[POST_END]\n\n(ËØ∑‰øùÊåÅÊ†ºÂºèÊï¥ÈΩêÔºåÁîüÊàê5‰∏™ËøôÊ†∑ÁöÑÂùó)\n`;
                        console.log("Ê≠£Âú®ËØ∑Ê±Ç AI ËøõË°å‰∏ñÁïåÊé®Êºî...");
                        const a = await xm(n);
                        if (!a)
                            throw (
                                console.error("„Äê‰∏•Èáç„ÄëfetchSimpleAiResponse ËøîÂõû‰∫ÜÁ©∫ÂÄº"),
                                new Error(
                                    "API ËØ∑Ê±ÇÂ§±Ë¥•„ÄÇÂèØËÉΩÂéüÂõ†Ôºö\n1. TokenË∂ÖÈôê(‰∏ñÁïå‰π¶Â§™Èïø)\n2. API Key‰ΩôÈ¢ù‰∏çË∂≥\n3. ÁΩëÁªúËøû‰∏ç‰∏äÊé•Âè£\n",
                                )
                            );
                        const o = (function (e) {
                            const t = [],
                                n = /\[POST_START\]([\s\S]*?)\[POST_END\]/g;
                            let a;
                            for (; null !== (a = n.exec(e));) {
                                const e = a[1].trim(),
                                    n = {
                                        author: "Ë∑Ø‰∫∫",
                                        content: "",
                                        likes: 0,
                                        comments: [],
                                    };
                                let o = null;
                                (e.split("\n").forEach((e) => {
                                    if ((e = e.trim()))
                                        if (e.startsWith("Author:") || e.startsWith("ÂèëÂ∏ÉËÄÖ:")) {
                                            const t = e.search(/[:Ôºö]/);
                                            t > -1 && (n.author = e.substring(t + 1).trim());
                                        } else if (
                                            e.startsWith("Content:") ||
                                            e.startsWith("ÂÜÖÂÆπ:")
                                        ) {
                                            const t = e.search(/[:Ôºö]/);
                                            t > -1 && (n.content = e.substring(t + 1).trim());
                                        } else if (
                                            e.startsWith("Likes:") ||
                                            e.startsWith("ÁÇπËµû:")
                                        )
                                            n.likes = parseInt(e.replace(/[^0-9]/g, "")) || 0;
                                        else if (
                                            e.startsWith("Comment:") ||
                                            e.startsWith("ËØÑËÆ∫:")
                                        ) {
                                            const t = e.substring(e.indexOf(":") + 1).trim(),
                                                a =
                                                    t.indexOf(":") > -1
                                                        ? t.indexOf(":")
                                                        : t.indexOf("Ôºö");
                                            if (a > -1) {
                                                const e = t.substring(0, a).trim(),
                                                    s = t.substring(a + 1).trim(),
                                                    i = {
                                                        id: `wc-${Date.now()}-${Math.random()}`,
                                                        author: e,
                                                        avatar: Ll(e),
                                                        content: s,
                                                        timestamp: new Date().toISOString(),
                                                        replies: [],
                                                    };
                                                (e === N.ai.name && (i.avatar = N.ai.avatar),
                                                    n.comments.push(i),
                                                    (o = i));
                                            }
                                        } else if (
                                            (e.startsWith("Reply:") || e.startsWith("ÂõûÂ§ç:")) &&
                                            o
                                        ) {
                                            const t = e.substring(e.indexOf(":") + 1).trim(),
                                                n =
                                                    t.indexOf(":") > -1
                                                        ? t.indexOf(":")
                                                        : t.indexOf("Ôºö");
                                            if (n > -1) {
                                                const e = t.substring(0, n).trim();
                                                let a = t.substring(n + 1).trim(),
                                                    s = null;
                                                const i = a.match(/^@(\S+)\s*/);
                                                i
                                                    ? ((s = i[1]), (a = a.replace(i[0], "")))
                                                    : (s = o.author);
                                                const r = {
                                                    id: `wr-${Date.now()}-${Math.random()}`,
                                                    author: e,
                                                    content: a,
                                                    targetUser: s,
                                                    timestamp: new Date().toISOString(),
                                                };
                                                o.replies.push(r);
                                            }
                                        }
                                }),
                                    n.content && t.push(n));
                            }
                            return t;
                        })(a);
                        if (0 === o.length)
                            throw new Error("Ëß£ÊûêÂ§±Ë¥•ÔºöÊú™ËÉΩÊèêÂèñÂà∞ÊúâÊïàÂ∏ñÂ≠ê„ÄÇ");
                        const s = await Kl.loadData("wowPosts", "allPosts");
                        let i = s && Array.isArray(s.value) ? s.value : [];
                        (o.forEach((e) => {
                            let t;
                            t = e.author === N.ai.name ? N.ai.avatar : Ll(e.author);
                            const n = {
                                id: Date.now() + Math.random(),
                                author: e.author,
                                avatar: t,
                                content: e.content,
                                timestamp: new Date().toISOString(),
                                contactId: N.id,
                                likes: [],
                                comments: [],
                            },
                                a = parseInt(e.likes) || 10;
                            for (let e = 0; e < a; e++)
                                n.likes.push({
                                    id: "fake",
                                    name: "user",
                                });
                            (Array.isArray(e.comments) && (n.comments = e.comments),
                                i.push(n));
                        }),
                            await Kl.saveData("wowPosts", "allPosts", i),
                            Np(),
                            alert(`Êé®ÊºîÊàêÂäüÔºÅÁîüÊàê‰∫Ü ${o.length} Êù°Âä®ÊÄÅ`));
                    } catch (e) {
                        (console.error("‰∏ñÁïåÊ®°ÊãüÂ§±Ë¥•:", e),
                            alert(`Êé®ÊºîÂ§±Ë¥•: ${e.message}`));
                    } finally {
                        ((Up.innerHTML = t), (Up.disabled = !1));
                    }
                })())
                : alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë∫´‰ªΩÔºÅ");
        }),
        document.addEventListener("DOMContentLoaded", () => {
            const e = document.getElementById("wow-compose-cancel-btn");
            e &&
                (e.onclick = function () {
                    document
                        .getElementById("wow-compose-modal")
                        .classList.remove("active");
                });
            const t = document.getElementById("wow-compose-publish-btn");
            t && (t.onclick = Zp);
        }),
        document.addEventListener("DOMContentLoaded", () => {
            const e = document.getElementById("wow-publish-trigger-btn");
            e && e.addEventListener("click", Kp);
            const t = document.getElementById("wow-compose-cancel-btn");
            t &&
                t.addEventListener("click", () => {
                    const e = document.getElementById("wow-compose-modal");
                    e && e.classList.remove("active");
                });
            const n = document.getElementById("wow-compose-publish-btn");
            n && n.addEventListener("click", Zp);
        }),
        document.addEventListener("click", function (e) {
            e.target.closest("#wow-publish-trigger-btn") &&
                (console.log("üñ±Ô∏è ÁÇπÂáª‰∫ÜÂèëÂ∏ÉÊåâÈíÆ (ÈÄöËøá‰∫ã‰ª∂ÂßîÊâòÊçïËé∑)"), Kp());
        }),
        xo.addEventListener("keypress", (e) => {
            if ("Enter" === e.key) {
                e.preventDefault();
                const t = xo.value.trim();
                (t && Dc(t), xo.focus());
            }
        }),
        document.addEventListener("DOMContentLoaded", async () => {
            if (window.ImageStore) {
                const e = await window.ImageStore.get("userDeviceSkin");
                e && Xp(e);
            }
        }),
        (window.handleSkinUpload = function (e) {
            const t = e.files[0];
            if (!t) return;
            "image/png" !== t.type &&
                alert("‰∏∫‰∫ÜÊúÄ‰Ω≥ÊïàÊûúÔºåËØ∑‰∏ä‰º†ËÉåÊôØÈÄèÊòéÁöÑ PNG ÂõæÁâáÔºÅ");
            const n = new FileReader();
            ((n.onload = function (e) {
                const t = e.target.result;
                (window.ImageStore
                    ? window.ImageStore.set("userDeviceSkin", t)
                    : localStorage.setItem("userDeviceSkin", t),
                    Xp(t),
                    alert("‚ú® ÊâãÊú∫Â£≥Êõ¥Êç¢ÊàêÂäüÔºÅ"));
            }),
                n.readAsDataURL(t),
                (e.value = ""));
        }),
        (window.resetSkin = function () {
            if (!confirm("Á°ÆÂÆöË¶ÅÁßªÈô§Ëá™ÂÆö‰πâÊâãÊú∫Â£≥ÔºåÊÅ¢Â§çÈªòËÆ§Ê†∑ÂºèÂêóÔºü")) return;
            window.ImageStore
                ? window.ImageStore.remove("userDeviceSkin")
                : localStorage.removeItem("userDeviceSkin");
            const e = document.getElementById("device-skin");
            e && ((e.style.display = "none"), (e.src = ""));
            const t = document.querySelector(".phone-frame");
            t && (t.style.border = "");
            const n = document.getElementById("reset-skin-btn"),
                a = document.getElementById("skin-size-controls");
            n && (n.style.display = "none");
            a && (a.style.display = "none");
            localStorage.removeItem("skinSizeSettings");
        }));
    const Qp = document.getElementById("apply-skin-size-btn");
    Qp &&
        Qp.addEventListener("click", function () {
            const e = document.getElementById("device-skin"),
                t = document.getElementById("skin-width-input"),
                n = document.getElementById("skin-height-input"),
                a = document.getElementById("skin-offset-x-input"),
                o = document.getElementById("skin-offset-y-input");
            if (!e) return;
            const s = parseInt(t.value) || 400,
                i = parseInt(n.value) || 720,
                r = parseInt(a.value) || 0,
                l = parseInt(o.value) || 0;
            ((e.style.width = s + "px"),
                (e.style.height = i + "px"),
                (e.style.transform = `translate(calc(-50% + ${r}px), calc(-50% + ${l}px))`));
            const c = {
                width: s,
                height: i,
                offsetX: r,
                offsetY: l,
            };
            (localStorage.setItem("skinSizeSettings", JSON.stringify(c)),
                alert("‚úÖ ÊâãÊú∫Â£≥Â∞∫ÂØ∏Â∑≤‰øùÂ≠òÔºÅ"));
        });
    let eg = !0;
    async function tg(e = 0) {
        if (void 0 === Kl)
            return (
                console.log("dbHelper ËøòÊ≤°Âä†ËΩΩÔºå500msÂêéÈáçËØï..."),
                void setTimeout(() => tg(e + 1), 500)
            );
        if (!Kl.db)
            return e > 10
                ? void console.warn("Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂ÔºåÊîæÂºÉËØªÂèñÊóÅÁôΩËÆæÁΩÆÔºà‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ„ÄÇ")
                : (console.log(`Êï∞ÊçÆÂ∫ìÊ≠£Âú®ËøûÊé•‰∏≠... Á≠âÂæÖ 500ms (Á¨¨ ${e + 1} Ê¨°)`),
                    void setTimeout(() => tg(e + 1), 500));
        try {
            const e = await Kl.loadData("settingsStore", "narrationConfig");
            (e &&
                e.value &&
                !1 === e.value.enabled &&
                ((eg = !1),
                    document.body.classList.add("hide-narration-mode"),
                    ag &&
                    ((ag.style.filter = "grayscale(100%)"), (ag.style.opacity = "0.6"))),
                console.log("‚úÖ ÊóÅÁôΩÈÖçÁΩÆËØªÂèñÊàêÂäüÔºÅ"));
        } catch (e) {
            console.warn("ËØªÂèñÊóÅÁôΩÈÖçÁΩÆÈÅáÂà∞Â∞èÈóÆÈ¢ò (‰∏çÂΩ±Âìç‰ΩøÁî®):", e);
        }
    }
    (tg(),
        document.addEventListener("DOMContentLoaded", () => {
            void 0 !== Kl
                ? tg()
                : console.error("Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂêé‰æùÁÑ∂Êâæ‰∏çÂà∞ dbHelperÔºåËØ∑Ê£ÄÊü•‰ª£Á†ÅÈ°∫Â∫è");
            const e = document.getElementById("chat-message-input"),
                t = () => {
                    const e = document.getElementById("chat-screen");
                    e && e.classList.remove("features-panel-active");
                };
            (e && (e.addEventListener("focus", t), e.addEventListener("click", t)),
                document.querySelectorAll(".feature-item").forEach((e) => {
                    e.addEventListener("click", () => {
                        ([
                            "memory-feature",
                            "anecdotes-feature",
                            "peeping-feature",
                            "ludo-game-feature",
                            "tic-tac-toe-feature",
                            "transfer-feature",
                            "appointment-feature",
                            "dating-history-feature",
                        ].includes(e.id) ||
                            e.id.includes("transfer")) &&
                            t();
                    });
                }));
            const n = document.getElementById("transfer-action-btn");
            n && n.addEventListener("click", t);
        }));
    const ng = document.getElementById("narration-toggle-feature"),
        ag = ng.querySelector(".feature-icon");
    ng &&
        ng.addEventListener("click", async () => {
            ((eg = !eg),
                eg
                    ? (document.body.classList.remove("hide-narration-mode"),
                        void 0 !== ag &&
                        ((ag.style.filter = "none"), (ag.style.opacity = "1")),
                        alert("Â∑≤ÂºÄÂêØ"))
                    : (document.body.classList.add("hide-narration-mode"),
                        void 0 !== ag &&
                        ((ag.style.filter = "grayscale(100%)"),
                            (ag.style.opacity = "0.6")),
                        alert("Â∑≤ÂÖ≥Èó≠")));
            try {
                (await Kl.saveData("settingsStore", "narrationConfig", {
                    enabled: eg,
                }),
                    console.log("ÊóÅÁôΩÁä∂ÊÄÅÂ∑≤‰øùÂ≠òÂà∞ IndexedDB"));
            } catch (e) {
                console.error("‰øùÂ≠òÊóÅÁôΩÁä∂ÊÄÅÂ§±Ë¥•:", e);
            }
            id();
        });
    const og = new Audio("./assets/pop.mp3");

    function sg(e) {
        const t = e.split(","),
            n = t[0].match(/:(.*?);/)[1],
            a = atob(t[1]);
        let o = a.length;
        const s = new Uint8Array(o);
        for (; o--;) s[o] = a.charCodeAt(o);
        return new Blob([s], {
            type: n,
        });
    }

    function kd(e, t, n, a) {
        if (e && "object" == typeof e)
            for (const o in e) {
                const s = e[o];
                if ("string" == typeof s && s.startsWith("data:image/"))
                    try {
                        const i = ig(s, t, n, a);
                        i && (e[o] = `backup://images/${i}`);
                    } catch (e) {
                        console.warn(`ÊèêÂèñÊôÆÈÄöÂõæÁâáÂ§±Ë¥•: ${o}`, e);
                    }
                else if (
                    "string" == typeof s &&
                    (s.includes('url("data:image') ||
                        s.includes("url('data:image") ||
                        s.includes("url(data:image"))
                )
                    try {
                        const i = s.match(/url\((?:['"]?)(data:image\/[^)'"]+)(?:['"]?)\)/);
                        if (i && i[1]) {
                            const s = ig(i[1], t, n, a);
                            s && (e[o] = `url("backup://images/${s}")`);
                        }
                    } catch (e) {
                        console.warn(`ÊèêÂèñCSSËÉåÊôØÂõæÂ§±Ë¥•: ${o}`, e);
                    }
                else "object" == typeof s && null !== s && kd(s, t, n, a);
            }
    }

    function ig(e, t, n, a) {
        if (!e || !e.includes(",")) return null;
        const o = (function (e) {
            let t = 5381;
            for (let n = 0; n < e.length; n++)
                ((t = (t << 5) + t + e.charCodeAt(n)), (t >>>= 0));
            return t.toString(16);
        })(e);
        if (a.has(o)) return a.get(o);
        let s = "jpg";
        e.includes("image/png")
            ? (s = "png")
            : e.includes("image/gif")
                ? (s = "gif")
                : e.includes("image/webp") && (s = "webp");
        const i = `img_${n.count++}.${s}`,
            r = e.split(",");
        if (r.length < 2)
            return (console.warn("Êó†ÊïàÁöÑbase64Ê†ºÂºè:", e.substring(0, 50)), null);
        let l = r[1].replace(/\s/g, "");
        const c = sg(l);
        return (t.file(i, c), a.set(o, i), i);
    }

    function rg(e, t, n, a, o = "pending") {
        if (!document.getElementById("london-transfer-styles")) {
            const e = document.createElement("style");
            ((e.id = "london-transfer-styles"),
                (e.textContent =
                    '\n        /* ==========================================================\n           ËÅäÂ§©ËÆæÁΩÆÁã¨Á´ãÈ°µÈù¢Ê†∑Âºè - ÊúàÁôΩ‰∏éÈùíÈªõ / Moon White & Indigo Grey\n           È´òÁ∫ßÂÖãÂà∂È£éÊ†º (Advanced & Restrained) - ÂéªiOSÂåñÔºåÂéªÊöñËâ≤Ë∞É\n           ========================================================== */\n        :root {\n            --london-bg: #EAEFF2; \n            --london-card: #FFFFFF;\n            --london-card-alt: #F4F7F9;\n            --london-text-primary: #45494D; /* ÈùíÈªõÔºöËßÜËßâÈáçÂøÉ */\n            --london-text-secondary: #5F6B73; /* ÁÅ∞ËìùÔºöÊ¨°Ë¶Å‰ø°ÊÅØ */\n            --london-text-muted: #9FA6AB; /* Êõ¥Ê∑°ÁöÑÁÅ∞Ëâ≤ */\n            --london-accent: #45494D; \n            --london-accent-light: rgba(69, 73, 77, 0.08);\n            --london-border: rgba(69, 73, 77, 0.12);\n            --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08); /* ÊûÅÂÖãÂà∂ */\n            --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);\n            --london-danger: #D4A5A5; /* ‰øùÊåÅ‰ΩéÈ•±Âíå */\n            --london-danger-dark: #C48888;\n            --london-success: #8FB3C4; /* ÂÜ∑Ë∞ÉÁªø/Ëìù */\n        }\n\n        .transfer-card {\n            width: 230px;\n            background: var(--london-card);\n            border: 1px solid var(--london-border);\n            border-radius: 14px;\n            box-shadow: var(--london-shadow-soft);\n            overflow: hidden;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n            transition: all 0.3s ease;\n            cursor: pointer;\n            position: relative;\n        }\n\n        .transfer-card:hover {\n            box-shadow: var(--london-shadow);\n            transform: translateY(-1px);\n        }\n\n        .transfer-header {\n            display: flex;\n            align-items: center;\n            padding: 16px;\n            background: var(--london-card);\n            gap: 12px;\n        }\n\n        /* ÊûÅÁÆÄÈùíÈªõËâ≤ÂõæÊ†áÂÆπÂô® */\n        .transfer-icon-box {\n            width: 42px;\n            height: 42px;\n            background: var(--london-accent);\n            border-radius: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n            transition: background 0.3s ease;\n        }\n\n        .transfer-icon-svg {\n            width: 22px;\n            height: 22px;\n            fill: #FFFFFF;\n        }\n\n        .transfer-info {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n        }\n\n        .transfer-amount {\n            font-size: 17px;\n            font-weight: 600;\n            color: var(--london-text-primary);\n            letter-spacing: -0.5px;\n            line-height: 1.2;\n        }\n\n        .transfer-status-text {\n            font-size: 13px;\n            color: var(--london-text-secondary);\n            margin-top: 2px;\n            font-weight: 400;\n        }\n\n        .transfer-footer {\n            padding: 10px 16px;\n            background: var(--london-card-alt);\n            border-top: 1px solid var(--london-border);\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n\n        .transfer-footer span {\n            font-size: 11px;\n            color: var(--london-text-muted);\n            font-weight: 500;\n        }\n\n        /* Áä∂ÊÄÅÂèò‰Ωì */\n        .transfer-card.status-accepted .transfer-icon-box {\n            background: var(--london-success);\n        }\n\n        .transfer-card.status-refused .transfer-icon-box {\n            background: var(--london-danger);\n        }\n        \n        /* ‰∫§‰∫íÈÅÆÁΩ© - ÊûÅÁÆÄÁôΩÈ£éÊ†º */\n        .transfer-overlay {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(255, 255, 255, 0.96); /* È´ò‰ª•Â§™ÂÆûËâ≤ */\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            opacity: 0;\n            pointer-events: none;\n            transition: opacity 0.2s ease;\n            z-index: 10;\n        }\n\n        .transfer-card.status-selecting .transfer-overlay {\n            opacity: 1;\n            pointer-events: auto;\n        }\n\n        .transfer-actions {\n            display: flex;\n            gap: 12px;\n            margin-bottom: 20px;\n        }\n\n        .action-btn {\n            padding: 8px 18px;\n            border-radius: 8px;\n            font-size: 13px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: opacity 0.2s;\n            color: white;\n            box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n        }\n        \n        .action-btn:hover {\n            opacity: 0.9;\n        }\n\n        .btn-accept {\n            background: var(--london-success);\n        }\n\n        .btn-refuse {\n            background: var(--london-danger);\n        }\n\n        .overlay-cancel {\n            font-size: 13px;\n            color: var(--london-text-secondary);\n            cursor: pointer;\n            padding: 4px 8px;\n            opacity: 0.7;\n        }\n        .overlay-cancel:hover {\n            opacity: 1;\n        }\n\n        .overlay-title {\n            font-size: 15px;\n            font-weight: 600;\n            color: var(--london-text-primary);\n            margin-bottom: 16px;\n        }\n        '),
                document.head.appendChild(e));
        }
        let s = "";
        a ||
            "pending" !== o ||
            (s = `onclick="event.stopPropagation(); toggleTransferOverlay('${n}')"`);
        let i = "ÊúãÂèã";
        "undefined" != typeof window &&
            window.currentOpenContact &&
            (a && window.currentOpenContact.ai
                ? (i = window.currentOpenContact.ai.name)
                : !a &&
                window.currentOpenContact.user &&
                (i = window.currentOpenContact.user.name));
        let r = `ËΩ¨Ë¥¶Áªô${i}`;
        ("accepted" === o && (r = "Â∑≤Êî∂Ê¨æ"), "refused" === o && (r = "Â∑≤ÈÄÄÂõû"));
        return `\n    <div id="transfer-${n}" class="transfer-card status-${o}" ${s} data-uuid="${n}">\n        \n        <div class="transfer-header">\n            <div class="transfer-icon-box">\n                <svg class="transfer-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    \x3c!-- ËΩ¨Ë¥¶ÂõæÊ†áÔºöÂèåÂêëÁÆ≠Â§¥ --\x3e\n                    <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </div>\n            <div class="transfer-info">\n                <div class="transfer-amount">¬• ${e}</div>\n                <div class="transfer-status-text">${r}</div>\n            </div>\n        </div>\n\n        <div class="transfer-footer">\n            <span>${t.length > 10 ? t.substring(0, 10) + "..." : t || "ËΩ¨Ë¥¶"}</span>\n            <span>‰∏ÉÊîØ‰ªò</span>\n        </div>\n\n        <div class="transfer-overlay">\n            <div class="overlay-title">Á°ÆËÆ§Êî∂Ê¨æÔºü</div>\n            <div class="transfer-actions">\n                <div class="action-btn btn-accept" onclick="window.handleTransferAction(event, '${n}', 'accepted', '${e}')">Êé•Êî∂</div>\n                <div class="action-btn btn-refuse" onclick="window.handleTransferAction(event, '${n}', 'refused', '${e}')">ÈÄÄÂõû</div>\n            </div>\n            <div class="overlay-cancel" onclick="event.stopPropagation(); toggleTransferOverlay('${n}')">ÂèñÊ∂à</div>\n        </div>\n    </div>\n    `;
    }
    ((og.volume = 0.4),
        og.load(),
        (window.toggleTransferOverlay = function (e) {
            event && event.stopPropagation();
            const t = document.getElementById(`transfer-${e}`);
            t && t.classList.toggle("status-selecting");
        }),
        (window.handleTransferAction = async function (e, t, n, a) {
            e && e.stopPropagation();
            const o = document.getElementById(`transfer-${t}`);
            if (!o) return;
            (o.classList.remove("status-pending", "status-selecting"),
                o.classList.add(`status-${n}`));
            const s = o.querySelector(".transfer-status-text");
            (s && (s.textContent = "accepted" === n ? "Â∑≤Êî∂Ê¨æ" : "Â∑≤ÈÄÄÂõû"),
                o.removeAttribute("onclick"));
            const i = o.querySelector(".transfer-overlay");
            if ((i && (i.style.display = "none"), void 0 !== Kl))
                try {
                    let e = "contact",
                        o = null;
                    if (Je) ((e = "group"), (o = Je.id));
                    else {
                        if (!Sc) return;
                        ((e = "contact"), (o = Sc.id));
                    }
                    if ("contact" === e) {
                        let e =
                            (await Kl.loadData("messageContacts", "allContacts")).value || [];
                        const s = e.findIndex((e) => e.id === o);
                        if (s > -1) {
                            const o = e[s].history.find((e) => e.uuid === t);
                            if (o) {
                                o.transferStatus = n;
                                const t = {
                                    sender: "user",
                                    text: `[Áî®Êà∑Â∑≤${"accepted" === n ? "Êé•Êî∂" : "ÈÄÄÂõû"}‰∫Ü‰Ω†ÂèëÊù•ÁöÑ ¬•${a} ËΩ¨Ë¥¶]`,
                                    timestamp: new Date(),
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                    type: "transfer_notify",
                                    isHidden: !0,
                                };
                                (e[s].history.push(t),
                                    await Kl.saveData("messageContacts", "allContacts", e),
                                    console.log(`ÂçïËÅäËΩ¨Ë¥¶ ${n} Â∑≤‰øùÂ≠òÔºåÂ∑≤ÈÄöÁü• AI`),
                                    Sc && (Sc.history = e[s].history));
                            }
                        }
                    } else {
                        let e =
                            (await Kl.loadData("groupChats", "allGroupChats")).value || [];
                        const s = e.findIndex((e) => e.id === o);
                        if (s > -1) {
                            const o = e[s].history.find((e) => e.uuid === t);
                            if (o) {
                                o.transferStatus = n;
                                const t = {
                                    sender: "user",
                                    text: `[Áî®Êà∑Â∑≤${"accepted" === n ? "Êé•Êî∂" : "ÈÄÄÂõû"}‰∫Ü‰Ω†ÂèëÊù•ÁöÑ ¬•${a} ËΩ¨Ë¥¶]`,
                                    timestamp: new Date(),
                                    uuid:
                                        Date.now() + "-" + Math.random().toString(36).substr(2, 9),
                                    type: "transfer_notify",
                                    isHidden: !0,
                                };
                                (e[s].history.push(t),
                                    await Kl.saveData("groupChats", "allGroupChats", e),
                                    console.log(`Áæ§ËÅäËΩ¨Ë¥¶ ${n} Â∑≤‰øùÂ≠òÔºåÂ∑≤ÈÄöÁü• AI`),
                                    Je && (Je.history = e[s].history));
                            }
                        }
                    }
                } catch (e) {
                    (console.error("‰øùÂ≠òËΩ¨Ë¥¶Áä∂ÊÄÅÂ§±Ë¥•:", e),
                        alert("Áä∂ÊÄÅ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï"));
                }
            else console.error("dbHelper Êú™ÂÆö‰πâÔºåÊó†Ê≥ï‰øùÂ≠òÁä∂ÊÄÅ");
        }),
        (function () {
            const e = document.querySelector(".phone-frame"),
                t = document.getElementById("toggle-status-bar");
            if (!e || !t) return;
            const n = localStorage.getItem("showStatusBar"),
                a = null === n || "true" === n;
            ((t.checked = a),
                a || e.classList.add("hide-status-bar"),
                t.addEventListener("change", function () {
                    const t = this.checked;
                    (t
                        ? e.classList.remove("hide-status-bar")
                        : e.classList.add("hide-status-bar"),
                        localStorage.setItem("showStatusBar", t));
                }));
        })());
    const lg = {
        board: ["-", "-", "-", "-", "-", "-", "-", "-", "-"],
        currentTurn: "user",
        gameOver: !1,
        winner: null,
        messages: [],
        userSymbol: "O",
        aiSymbol: "X",
    },
        cg = document.getElementById("tic-tac-toe-modal"),
        dg = document.getElementById("tic-tac-toe-feature"),
        ug = document.getElementById("ttt-close-btn"),
        mg = document.getElementById("ttt-board"),
        pg = document.getElementById("ttt-status"),
        gg = document.getElementById("ttt-ai-avatar"),
        yg = document.getElementById("ttt-user-avatar"),
        hg = document.getElementById("ttt-ai-bubble"),
        vg = document.getElementById("ttt-user-bubble"),
        fg = document.getElementById("ttt-user-first-btn"),
        wg = document.getElementById("ttt-ai-first-btn"),
        bg = document.getElementById("ttt-start-panel"),
        Eg = document.getElementById("ttt-chat-input-container"),
        Ig = document.getElementById("ttt-chat-input"),
        xg = document.getElementById("ttt-send-chat-inline-btn"),
        kg = document.getElementById("ttt-restart-btn"),
        Lg = document.getElementById("ttt-chat-modal"),
        Bg = document.getElementById("ttt-chat-modal-close-btn"),
        Sg = document.getElementById("ttt-chat-textarea"),
        Cg = document.getElementById("ttt-send-chat-btn");

    function $g() {
        ((lg.board = ["-", "-", "-", "-", "-", "-", "-", "-", "-"]),
            (lg.currentTurn = "user"),
            (lg.gameOver = !1),
            (lg.winner = null),
            (lg.messages = []),
            Sc &&
            ((gg.src =
                Sc.ai?.avatar || "https://placehold.co/60x60/EFEFEF/AAAAAA?text=AI"),
                (yg.src =
                    Sc.user?.avatar ||
                    "https://placehold.co/60x60/EFEFEF/AAAAAA?text=User"),
                console.log("‰∫ïÂ≠óÊ£ãÂ§¥ÂÉèÂ∑≤ËÆæÁΩÆ:", {
                    ai: gg.src,
                    user: yg.src,
                })),
            (bg.style.display = "flex"),
            (Eg.style.display = "none"),
            (kg.style.display = "none"),
            (pg.textContent = "ÈÄâÊã©ÂÖàÊâãÂºÄÂßãÊ∏∏Êàè"),
            (hg.textContent = "Á≠âÂæÖÂºÄÂßã..."),
            (vg.textContent = "ÂáÜÂ§áÂ•Ω‰∫ÜÔºÅ"),
            Mg());
    }

    function Mg() {
        mg.querySelectorAll(".board-cell").forEach((e, t) => {
            const n = lg.board[t];
            if (
                ((e.innerHTML = ""),
                    e.classList.remove("user-piece", "ai-piece"),
                    n === lg.userSymbol)
            ) {
                const t = document.createElement("img");
                ((t.src = yg.src),
                    t.classList.add("piece-avatar"),
                    e.appendChild(t),
                    e.classList.add("user-piece"));
            } else if (n === lg.aiSymbol) {
                const t = document.createElement("img");
                ((t.src = gg.src),
                    t.classList.add("piece-avatar"),
                    e.appendChild(t),
                    e.classList.add("ai-piece"));
            }
        });
    }
    async function Tg() {
        if (Sc)
            try {
                const e = await Kl.loadData("settingsStore", "apiSettings");
                if (!e || !e.value || !e.value.url)
                    throw new Error("API Êú™ÈÖçÁΩÆÔºåËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API");
                const { url: t, key: n, model: a } = e.value;
                let o = t.endsWith("/") ? t.slice(0, -1) : t;
                o += "/chat/completions";
                const s = lg.board
                    .map((e, t) =>
                        "-" === e
                            ? `${t + 1}: Á©∫`
                            : e === lg.aiSymbol
                                ? `${t + 1}: X(AI)`
                                : `${t + 1}: O(Áî®Êà∑)`,
                    )
                    .join("\n"),
                    i = lg.messages
                        .map((e) => `${"ai" === e.sender ? Sc.name : "Áî®Êà∑"}: ${e.text}`)
                        .join("\n"),
                    r = (Sc.history ? Sc.history.slice(-10) : [])
                        .map((e) =>
                            "ai" === e.sender
                                ? `${Sc.name}: ${e.text}`
                                : "user" === e.sender
                                    ? `Áî®Êà∑: ${e.text}`
                                    : "system" === e.sender
                                        ? `[Á≥ªÁªüÊ∂àÊÅØ] ${e.text}`
                                        : "",
                        )
                        .filter(Boolean)
                        .join("\n");
                let l = "";
                if (Sc.worldBooks && Sc.worldBooks.length > 0) {
                    const e = [];
                    for (const t of Sc.worldBooks) {
                        const n = await Kl.loadData("worldBooksStore", t);
                        n && n.value && n.value.content && e.push(n.value.content);
                    }
                    e.length > 0 && (l = "\n„Äê‰∏ñÁïåËÆæÂÆö„Äë\n" + e.join("\n\n"));
                }
                const c = `‰Ω†Ê≠£Âú®‰∏éÁî®Êà∑Áé©‰∫ïÂ≠óÊ£ãÊ∏∏Êàè„ÄÇ\n\n„ÄêAI ËßíËâ≤ËÆæÂÆö„Äë\nÂßìÂêçÔºö${Sc.name}\n${Sc.ai?.persona || "‰Ω†ÊòØ‰∏Ä‰∏™ÂèãÂ•ΩÁöÑ AI Âä©Êâã"}\n${l}\n\n„ÄêÁî®Êà∑ËÆæÂÆö„Äë\n${Sc.user?.persona || "ÊôÆÈÄöÁî®Êà∑"}\n\n„Äê‰πãÂâçÁöÑËÅäÂ§©ËÆ∞ÂΩï„Äë\n${r || "ÊöÇÊó†‰πãÂâçÁöÑËÅäÂ§©ËÆ∞ÂΩï"}\n\n„ÄêÂΩìÂâç‰∫ïÂ≠óÊ£ãÊ∏∏ÊàèÂØπËØù„Äë\n${i || "ÊöÇÊó†Ê∏∏ÊàèÂÜÖÂØπËØù"}\n\n„ÄêÂΩìÂâçÊ£ãÁõòÁä∂ÊÄÅ„Äë\n${s}\n\nËßÑÂàôÔºö‰ΩçÁΩÆÁºñÂè∑ 1-9Ôºà‰ªéÂ∑¶Âà∞Âè≥Ôºå‰ªé‰∏äÂà∞‰∏ãÔºâ\nX = AI ÁöÑÊ£ãÂ≠êÔºåO = Áî®Êà∑ÁöÑÊ£ãÂ≠êÔºåÁ©∫ = Êú™‰∏ã\n\n„ÄêÈáçË¶ÅÊèêÁ§∫„Äë\n1. ËØ∑‰øùÊåÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæÔºåÁî®Á¨¶Âêà‰Ω†ÊÄßÊ†ºÁöÑÊñπÂºèËØ¥ËØù\n2. ÂèØ‰ª•ÂèÇËÄÉ‰πãÂâçÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºå‰øùÊåÅÂØπËØùÁöÑËøûË¥ØÊÄß\n3. ËØ¥ËØùË¶ÅÁÆÄÁü≠ÔºàÈôêÂà∂Âú®10Â≠ó‰ª•ÂÜÖÔºâ\n4. Âè™ËÉΩÈÄâÊã©Á©∫‰Ωç‰∏ãÊ£ã\n\n„ÄêËæìÂá∫Ê†ºÂºèË¶ÅÊ±Ç„Äë\n‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÊåâ‰ª•‰∏ãÊ†ºÂºèÂõûÂ§çÔºö\n[CHAT]‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºàÈôêÂà∂Âú®10Â≠ó‰ª•ÂÜÖÔºåÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºâ[/CHAT]\n[MOVE]‰Ω†Ë¶Å‰∏ãÁöÑ‰ΩçÁΩÆ(1-9)[/MOVE]\n\nÁ§∫‰æãÔºö\n[CHAT]ËøôÊ≠•ÊàëËµ¢ÂÆö‰∫Ü~[/CHAT]\n[MOVE]5[/MOVE]`,
                    d = await fetch(o, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${n}`,
                        },
                        body: JSON.stringify({
                            model: a,
                            messages: [
                                {
                                    role: "system",
                                    content: c,
                                },
                                {
                                    role: "user",
                                    content:
                                        "ËØ∑Ê†πÊçÆÂΩìÂâçÊ£ãÁõòÁä∂ÊÄÅÔºåÂÜ≥ÂÆö‰Ω†ÁöÑ‰∏ã‰∏ÄÊ≠•Ê£ãÔºåÂπ∂ËØ¥‰∏ÄÂè•Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑËØù„ÄÇ",
                                },
                            ],
                            temperature: 0.9,
                        }),
                    });
                if (!d.ok) throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${d.status}`);
                const u = (await d.json()).choices[0].message.content;
                (console.log("[‰∫ïÂ≠óÊ£ã] AI ÂéüÂßãÂõûÂ§ç:", u),
                    (function (e) {
                        const t = e.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/),
                            n = t ? t[1].trim() : "...",
                            a = e.match(/\[MOVE\](\d)\[\/MOVE\]/);
                        let o = a ? parseInt(a[1]) : null;
                        if (null === o || o < 1 || o > 9 || "-" !== lg.board[o - 1]) {
                            const e = lg.board
                                .map((e, t) => ("-" === e ? t : null))
                                .filter((e) => null !== e);
                            if (!(e.length > 0)) return;
                            o = e[0] + 1;
                        }
                        (lg.messages.push({
                            sender: "ai",
                            text: n,
                        }),
                            (hg.textContent = n),
                            (lg.board[o - 1] = lg.aiSymbol),
                            Mg());
                        const s = Ag();
                        if (s) return void Dg(s);
                        ((lg.currentTurn = "user"), (pg.textContent = "ËΩÆÂà∞‰Ω†‰∏ãÊ£ã‰∫Ü"));
                    })(u));
            } catch (e) {
                (console.error("AI ÂõûÂêàÂá∫Èîô:", e),
                    (hg.textContent = "Âá∫Èîô‰∫Ü..."),
                    (pg.textContent = "ËØ∑ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè"),
                    (lg.gameOver = !0));
            }
        else console.error("Ê≤°ÊúâÊâìÂºÄÁöÑËÅîÁ≥ª‰∫∫");
    }

    function Ag() {
        const e = lg.board,
            t = [
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                [0, 3, 6],
                [1, 4, 7],
                [2, 5, 8],
                [0, 4, 8],
                [2, 4, 6],
            ];
        for (const n of t) {
            const [t, a, o] = n;
            if ("-" !== e[t] && e[t] === e[a] && e[t] === e[o])
                return e[t] === lg.userSymbol ? "user" : "ai";
        }
        return e.includes("-") ? null : "draw";
    }
    async function Dg(e) {
        ((lg.gameOver = !0), (lg.winner = e));
        let t = "";
        if (
            ("user" === e
                ? ((t = "‰Ω†Ëµ¢‰∫ÜÔºÅüéâ"), (vg.textContent = "ÊàëËµ¢Âï¶ÔºÅ"))
                : "ai" === e
                    ? ((t = `${Sc.ai.name} Ëé∑ËÉúÔºÅ`), (hg.textContent = "ÊàëËµ¢‰∫Ü~"))
                    : ((t = "Âπ≥Â±ÄÔºÅ"),
                        (vg.textContent = "Âπ≥Â±ÄÂë¢"),
                        (hg.textContent = "ÊâìÂπ≥‰∫Ü")),
                (pg.textContent = t),
                (kg.style.display = "block"),
                Sc)
        ) {
            const t = lg.messages
                .map((e) => `${"ai" === e.sender ? Sc.name : "‰Ω†"}: ${e.text}`)
                .join("\n"),
                n = lg.board
                    .map((e, t) => {
                        const n = t + 1;
                        return "-" === e
                            ? `${n}: Á©∫`
                            : e === lg.aiSymbol
                                ? `${n}: X(${Sc.name})`
                                : `${n}: O(‰Ω†)`;
                    })
                    .join(", "),
                a = "user" === e ? "‰Ω†Ëé∑ËÉú" : "ai" === e ? `${Sc.name}Ëé∑ËÉú` : "Âπ≥Â±Ä";
            setTimeout(() => {
                console.log("[‰∫ïÂ≠óÊ£ã] Ëß¶ÂèëAIÂõûÂ§çÊ∏∏ÊàèÁªìÊûú");
                Tc(
                    `(Á≥ªÁªüÊåá‰ª§ÔºöÂàöÂàöÁªìÊùü‰∫Ü‰∏ÄÂ±Ä‰∫ïÂ≠óÊ£ãÊ∏∏Êàè„ÄÇ\n\n„ÄêÊ∏∏ÊàèÁªìÊûú„Äë${a}\n\n„ÄêÊ∏∏ÊàèÂØπËØù„Äë\n${t || "ÔºàÊó†ÂØπËØùÔºâ"}\n\n„ÄêÊúÄÁªàÊ£ãÁõò„Äë${n}\n\nËØ∑Ê†πÊçÆËøôÂ±ÄÊ∏∏ÊàèËØ¥ËØ¥‰Ω†ÁöÑÊÑüÊÉ≥„ÄÅËØÑËÆ∫ÊàñÂèçÂ∫î„ÄÇ)`,
                    Sc,
                );
            }, 1500);
        }
        console.log("Ê∏∏ÊàèÁªìÊùü:", t);
    }

    function Pg() {
        const e = Sg.value.trim();
        e &&
            (lg.messages.push({
                sender: "user",
                text: e,
            }),
                (vg.textContent = e),
                (Sg.value = ""),
                (Lg.style.display = "none"));
    }
    (dg &&
        dg.addEventListener("click", () => {
            Sc
                ? ((cg.style.display = "flex"), $g(), id())
                : alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫");
        }),
        ug &&
        ug.addEventListener("click", () => {
            cg.style.display = "none";
        }),
        fg &&
        fg.addEventListener("click", () => {
            ((bg.style.display = "none"),
                (Eg.style.display = "flex"),
                (lg.currentTurn = "user"),
                (pg.textContent = "‰Ω†ÂÖàÊâãÔºåËØ∑‰∏ãÊ£ã"),
                (hg.textContent = "‰Ω†ÂÖàÊù•Âêß~"));
        }),
        wg &&
        wg.addEventListener("click", () => {
            ((bg.style.display = "none"),
                (Eg.style.display = "flex"),
                (lg.currentTurn = "ai"),
                (pg.textContent = "TAÂú®ÊÄùËÄÉ‰∏≠..."),
                (vg.textContent = "Áúã‰Ω†ÁöÑ‰∫Ü"),
                setTimeout(() => {
                    Tg();
                }, 800));
        }),
        mg &&
        mg.addEventListener("click", (e) => {
            const t = e.target.closest(".board-cell");
            if (!t) return;
            !(function (e) {
                if ("none" !== bg.style.display)
                    return void alert("ËØ∑ÂÖàÈÄâÊã©Ë∞ÅÂÖàÊâãÔºÅ");
                if (lg.gameOver) return;
                if ("user" !== lg.currentTurn) return;
                if ("-" !== lg.board[e]) return;
                ((lg.board[e] = lg.userSymbol), Mg());
                const t = Ag();
                t
                    ? Dg(t)
                    : ((lg.currentTurn = "ai"),
                        (pg.textContent = "TAÂú®ÊÄùËÄÉ‰∏≠..."),
                        (hg.textContent = "ËÆ©ÊàëÊÉ≥ÊÉ≥..."),
                        setTimeout(() => {
                            Tg();
                        }, 800));
            })(parseInt(t.dataset.index));
        }),
        xg &&
        Ig &&
        xg.addEventListener("click", () => {
            const e = Ig.value.trim();
            e &&
                (lg.messages.push({
                    sender: "user",
                    text: e,
                }),
                    (vg.textContent = e),
                    (Ig.value = ""),
                    console.log("[‰∫ïÂ≠óÊ£ã] Áî®Êà∑ÂèëÈÄÅÊ∂àÊÅØ:", e));
        }),
        Ig &&
        Ig.addEventListener("keydown", (e) => {
            "Enter" !== e.key || e.shiftKey || (e.preventDefault(), xg.click());
        }),
        Bg &&
        Bg.addEventListener("click", () => {
            Lg.style.display = "none";
        }),
        Cg && Cg.addEventListener("click", Pg),
        Sg &&
        Sg.addEventListener("keydown", (e) => {
            "Enter" !== e.key || e.shiftKey || (e.preventDefault(), Pg());
        }),
        kg &&
        kg.addEventListener("click", () => {
            $g();
        }),
        Lg &&
        Lg.addEventListener("click", (e) => {
            e.target === Lg && (Lg.style.display = "none");
        }));
    const Hg = {
        aiPosition: 0,
        userPosition: 0,
        currentTurn: "user",
        diceValue: null,
        isRolling: !1,
        isMoving: !1,
        gameOver: !1,
        winner: null,
        messages: [],
        currentTruthQuestion: null,
    },
        Og = {
            3: "bonus",
            5: "truth",
            6: "normal",
            9: "skip",
            12: "bonus",
            14: "truth",
            15: "penalty",
            18: "normal",
        },
        qg = [
            "‰Ω†ÊúÄÂñúÊ¨¢ÁöÑ‰∫∫ÊòØË∞ÅÔºü",
            "‰Ω†ÂÅöËøáÊúÄÂ∞¥Â∞¨ÁöÑ‰∏Ä‰ª∂‰∫ãÊòØ‰ªÄ‰πàÔºü",
            "Â¶ÇÊûúÊòéÂ§©ÊòØ‰∏ñÁïåÊú´Êó•Ôºå‰Ω†ÊúÄÊÉ≥ÂíåË∞ÅÂú®‰∏ÄËµ∑Ôºü",
            "‰Ω†ÊúâÊ≤°ÊúâÂÅ∑ÂÅ∑ÂñúÊ¨¢ËøáË∫´ËæπÁöÑ‰∫∫Ôºü",
            "‰Ω†ËßâÂæóÊàëÂì™ÈáåÊúÄÂê∏Âºï‰Ω†Ôºü",
            "‰Ω†ÊúÄËøë‰∏ÄÊ¨°Âì≠ÊòØÂõ†‰∏∫‰ªÄ‰πàÔºü",
            "‰Ω†ÊúÄÂ§ßÁöÑÊ¢¶ÊÉ≥ÊòØ‰ªÄ‰πàÔºü",
            "Â¶ÇÊûúÂèØ‰ª•ÂõûÂà∞ËøáÂéªÔºå‰Ω†ÊúÄÊÉ≥ÊîπÂèò‰ªÄ‰πàÔºü",
            "‰Ω†ÊúâÊ≤°ÊúâÊííËøá‰∏Ä‰∏™‰ªéÊú™Ë¢´ÂèëÁé∞ÁöÑË∞éÔºü",
            "‰Ω†ÂØπËá™Â∑±Âì™‰∏™ÈÉ®‰ΩçÊúÄ‰∏çÊª°ÊÑèÔºü",
            "‰Ω†ÊúÄÂÆ≥ÊÄï‰ªÄ‰πàÔºü",
            "Â¶ÇÊûúÁªô‰Ω†‰∏ÄÁôæ‰∏áÔºå‰Ω†ÊÑøÊÑèÁ¶ªÂºÄÁé∞Âú®ÁöÑÁîüÊ¥ªÂêóÔºü",
            "‰Ω†ÊúâÊ≤°ÊúâÂú®ÂøÉÈáåÈªòÈªòÈ™ÇËøáÊàëÔºü",
            "‰Ω†ÊúÄËÆ®ÂéåÂºÇÊÄß‰ªÄ‰πàË°å‰∏∫Ôºü",
            "‰Ω†ÂàùÂêªÊòØÂú®‰ªÄ‰πàÊó∂ÂÄôÔºü",
            "‰Ω†ÊâãÊú∫ÈáåÊúÄÂêé‰∏ÄÂº†ÁÖßÁâáÊòØ‰ªÄ‰πàÔºü",
            "‰Ω†ËßâÂæóÁúüÁà±Â≠òÂú®ÂêóÔºü",
            "‰Ω†ÊúâÊ≤°ÊúâÂêéÊÇîËÆ§ËØÜËøáÊüê‰∏™‰∫∫Ôºü",
            "Â¶ÇÊûúÂèØ‰ª•Êã•Êúâ‰∏ÄÁßçË∂ÖËÉΩÂäõÔºå‰Ω†Â∏åÊúõÊòØ‰ªÄ‰πàÔºü",
            "‰Ω†Áé∞Âú®ÊúÄÊÉ≥ÂØπÊ≠§Êó∂Ê≠§ÂàªÁöÑÊàëËØ¥‰ªÄ‰πàÔºü",
        ],
        Ng = [
            "Âèë‰∏Ä‰∏™Á∫¢ÂåÖÔºåÈáëÈ¢ùÈöèÊÑè„ÄÇ",
            "Âî±‰∏ÄÈ¶ñÊ≠åÂπ∂ÂèëËØ≠Èü≥ËøáÊù•„ÄÇ",
            "Âèë‰∏ÄÂº†‰Ω†ÁöÑËá™ÊãçÁÖß„ÄÇ",
            "ÂØπÊàëÊíí‰∏™Â®á„ÄÇ",
            "Â≠¶‰∏âÂ£∞Áå´Âè´Âπ∂ÂèëËØ≠Èü≥„ÄÇ",
            "Â§∏Êàë‰∏âÂàÜÈíü‰∏çËÆ∏ÈáçÂ§ç„ÄÇ",
            "Êç¢‰∏Ä‰∏™ÊàëÊåáÂÆöÁöÑÂ§¥ÂÉè‰∏ÄÂ§©„ÄÇ",
            "ÂèëÊúãÂèãÂúàËØ¥‚ÄúÊàëÊòØÁå™‚ÄùÂπ∂Êà™Âõæ„ÄÇ",
            "ÁªôÊàëËÆ≤‰∏Ä‰∏™ÂÜ∑Á¨ëËØù„ÄÇ",
            "Ê®°‰ªøÊàëÊúÄËøëÁöÑ‰∏ÄÂè•ËØù„ÄÇ",
            "ÁàÜÁÖßÔºàÁßÅÂØÜÁÖßÈô§Â§ñÔºâ„ÄÇ",
            "ËØ¥Âá∫ÊàëÁöÑ‰∏â‰∏™‰ºòÁÇπ„ÄÇ",
            "ÁúüÂøÉËØöÊÑèÂú∞ÂêëÊàëË°®ÁôΩ‰∏ÄÊ¨°„ÄÇ",
            "Áî®ÊñπË®ÄËØ¥‰∏ÄÂè•‚ÄúÊàëÂñúÊ¨¢‰Ω†‚Äù„ÄÇ",
            "ËøûÁª≠ÂèëÂçÅ‰∏™‰Ω†ÊúÄÂñúÊ¨¢ÁöÑË°®ÊÉÖÂåÖ„ÄÇ",
            "ÂõûÁ≠îÊàë‰∏Ä‰∏™‰ªªÊÑèÈóÆÈ¢òÔºå‰∏çËÆ∏ÊííË∞é„ÄÇ",
            "Âè´Êàë‰∏âÂ£∞‚Äú‰∏ª‰∫∫‚ÄùÊàñ‚Äú‰∫≤Áà±ÁöÑ‚Äù„ÄÇ",
            "ÂéªÁªôÊàëÁöÑÊúÄÊñ∞ÊúãÂèãÂúàÁÇπËµûÂπ∂ËØÑËÆ∫ÂÖ®ÊòØÂ§∏ÊàëÁöÑËØù„ÄÇ",
            "ÁªôÊàëÂèë‰∏ÄÊÆµ‰∏çÂ∞ë‰∫é30Â≠óÁöÑÂúüÂë≥ÊÉÖËØù„ÄÇ",
            "Âù¶ÁôΩ‰∏Ä‰ª∂‰Ω†‰ªéÊú™ÂëäËØâËøáÊàëÁöÑÁßòÂØÜ„ÄÇ",
        ],
        _g = 20;
    const Fg = (function () {
        const e = [],
            t = 44,
            n = 12;
        for (let a = 0; a < 6; a++)
            e.push({
                x: n + a * t,
                y: n,
                index: a + 1,
            });
        for (let a = 0; a < 5; a++)
            e.push({
                x: 232,
                y: n + (a + 1) * t,
                index: 7 + a,
            });
        for (let a = 0; a < 5; a++)
            e.push({
                x: n + (4 - a) * t,
                y: 232,
                index: 12 + a,
            });
        for (let a = 0; a < 4; a++)
            e.push({
                x: n,
                y: n + (4 - a) * t,
                index: 17 + a,
            });
        return e;
    })(),
        Rg = document.getElementById("ludo-game-modal"),
        Gg = document.getElementById("ludo-game-feature"),
        Wg = document.getElementById("ludo-close-btn"),
        jg = document.getElementById("ludo-export-css-btn"),
        Ug = document.getElementById("ludo-board"),
        zg = document.getElementById("ludo-dice"),
        Vg = document.getElementById("ludo-status"),
        Jg = document.getElementById("ludo-ai-avatar"),
        Yg = document.getElementById("ludo-user-avatar"),
        Kg = document.getElementById("ludo-ai-bubble"),
        Zg = document.getElementById("ludo-user-bubble"),
        Xg = document.getElementById("ludo-start-panel"),
        Qg = document.getElementById("ludo-user-first-btn"),
        ey = document.getElementById("ludo-ai-first-btn"),
        ty = document.getElementById("ludo-roll-btn"),
        ny = document.getElementById("ludo-chat-input-container"),
        ay = document.getElementById("ludo-chat-input"),
        oy = document.getElementById("ludo-send-chat-btn"),
        sy = document.getElementById("ludo-restart-btn");

    function iy() {
        if (
            ((Hg.aiPosition = 0),
                (Hg.userPosition = 0),
                (Hg.currentTurn = "user"),
                (Hg.diceValue = null),
                (Hg.isRolling = !1),
                (Hg.isMoving = !1),
                (Hg.gameOver = !1),
                (Hg.winner = null),
                (Hg.messages = []),
                Sc &&
                ((Jg.src =
                    Sc.ai?.avatar || "https://placehold.co/60x60/FF6B6B/fff?text=AI"),
                    (Yg.src =
                        Sc.user?.avatar || "https://placehold.co/60x60/4ECDC4/fff?text=U")),
                Hg.isUserReplyingSpecial)
        ) {
            Hg.isUserReplyingSpecial = !1;
            const e = Hg.currentTruthQuestion || "‰∏Ä‰∏™ÁúüÂøÉËØùÈóÆÈ¢ò";
            return (
                (Hg.pendingContext = `(Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÊâçÂõûÁ≠î‰∫ÜÁúüÂøÉËØùÈóÆÈ¢ò‚Äú${e}‚ÄùÔºåÂõûÁ≠îÂÜÖÂÆπÊòØÔºö‚Äú${text}‚Äù„ÄÇËØ∑‰Ω†Âú®Êé•‰∏ãÊù•ÁöÑË°åÂä®‰∏≠ÂØπÁî®Êà∑ÁöÑÂõûÁ≠îÂÅöÂá∫ÂèçÂ∫î/ËØÑ‰ª∑„ÄÇ)`),
                delete Hg.currentTruthQuestion,
                (Vg.textContent = "ÂõûÁ≠îÂ∑≤ËÆ∞ÂΩïÔºåËΩÆÂà∞TA‰∫Ü..."),
                void setTimeout(py, 1500)
            );
        }
        ((Xg.style.display = "flex"),
            (ty.style.display = "none"),
            (ny.style.display = "none"),
            (sy.style.display = "none"),
            (Vg.textContent = "ÈÄâÊã©ÂÖàÊâãÂºÄÂßãÊ∏∏Êàè"),
            (Kg.textContent = "ÂáÜÂ§áËµ∑È£û~"),
            (Zg.textContent = "Âá∫ÂèëÂêßÔºÅ"),
            ly(1),
            ry());
    }

    function ry() {
        if (!Ug) return;
        let e = "";
        (Fg.forEach((t, n) => {
            const a = n + 1;
            let o = "ludo-cell";
            (1 === a
                ? (o += " cell-start")
                : a === _g
                    ? (o += " cell-end")
                    : Og[a] && (o += ` cell-${Og[a]}`),
                (e += `\n                <rect \n                    class="${o}" \n                    x="${t.x}" \n                    y="${t.y}" \n                    width="40" \n                    height="40" \n                    rx="8"\n                    data-cell="${a}"\n                ></rect>\n                <text \n                    class="ludo-cell-number" \n                    x="${t.x + 20}" \n                    y="${t.y + 20 + 4}" \n                    text-anchor="middle"\n                >${a}</text>\n            `));
        }),
            (e += `\n            <text x="${Fg[0].x + 20}" y="${Fg[0].y - 5}" \n                  text-anchor="middle" font-size="10" fill="var(--ludo-text-color)" font-weight="bold">Ëµ∑ÁÇπ</text>\n        `),
            (e += `\n            <text x="${Fg[19].x + 20}" y="${Fg[19].y - 5}" \n                  text-anchor="middle" font-size="10" fill="var(--ludo-text-highlight)" font-weight="bold">ÁªàÁÇπ</text>\n        `));
        const t =
            0 === Hg.aiPosition
                ? {
                    x: 120,
                    y: 130,
                }
                : Hg.aiPosition > _g
                    ? {
                        x: 140,
                        y: 140,
                    }
                    : {
                        x: Fg[Hg.aiPosition - 1].x + 20,
                        y: Fg[Hg.aiPosition - 1].y + 20 - 8,
                    };
        e += `\n            <g id="ludo-ai-piece" class="ludo-piece ai-piece" transform="translate(${t.x - 12}, ${t.y - 10})">\n                <defs>\n                    <linearGradient id="aiGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n                        <stop offset="0%" style="stop-color:#FF8A80;stop-opacity:1" />\n                        <stop offset="100%" style="stop-color:#FF5252;stop-opacity:1" />\n                    </linearGradient>\n                    <filter id="pieceShadow" x="-20%" y="-20%" width="140%" height="140%">\n                        <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>\n                        <feOffset dx="0" dy="2" result="offsetblur"/>\n                        <feComponentTransfer>\n                            <feFuncA type="linear" slope="0.3"/>\n                        </feComponentTransfer>\n                        <feMerge>\n                            <feMergeNode/>\n                            <feMergeNode in="SourceGraphic"/>\n                        </feMerge>\n                    </filter>\n                </defs>\n                \x3c!-- ÂúÜÊ∂¶ÁÆ≠Â§¥‰∏ª‰Ωì (ÊåáÂêëÂè≥‰∏äÊñπ) --\x3e\n                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" \n                      fill="url(#aiGradient)" filter="url(#pieceShadow)"/>\n                \x3c!-- ÂÜÖÈÉ®Ë£ÖÈ•∞ --\x3e\n                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>\n            </g>\n        `;
        const n =
            0 === Hg.userPosition
                ? {
                    x: 160,
                    y: 150,
                }
                : Hg.userPosition > _g
                    ? {
                        x: 140,
                        y: 140,
                    }
                    : {
                        x: Fg[Hg.userPosition - 1].x + 20,
                        y: Fg[Hg.userPosition - 1].y + 20 + 8,
                    };
        ((e += `\n            <g id="ludo-user-piece" class="ludo-piece user-piece" transform="translate(${n.x - 12}, ${n.y - 10})">\n                <defs>\n                    <linearGradient id="userGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n                        <stop offset="0%" style="stop-color:#80DEEA;stop-opacity:1" />\n                        <stop offset="100%" style="stop-color:#26C6DA;stop-opacity:1" />\n                    </linearGradient>\n                </defs>\n                \x3c!-- ÂúÜÊ∂¶ÁÆ≠Â§¥‰∏ª‰Ωì --\x3e\n                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" \n                      fill="url(#userGradient)" filter="url(#pieceShadow)"/>\n                \x3c!-- ÂÜÖÈÉ®Ë£ÖÈ•∞ --\x3e\n                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>\n            </g>\n        `),
            (Ug.innerHTML = e));
    }

    function ly(e) {
        if (!zg) return;
        const t = {
            1: ["center"],
            2: ["tl", "br"],
            3: ["tl", "center", "br"],
            4: ["tl", "tr", "bl", "br"],
            5: ["tl", "tr", "center", "bl", "br"],
            6: ["tl", "tr", "ml", "mr", "bl", "br"],
        };
        let n = (t[e] || t[1])
            .map((e) => `<span class="dot ${e}"></span>`)
            .join("");
        zg.innerHTML = `<div class="dice-face" data-face="${e}">${n}</div>`;
    }
    async function cy() {
        if (Hg.isRolling || Hg.isMoving || Hg.gameOver) return;
        if (Hg.waitingForTruth) return;
        ((Hg.isRolling = !0), (ty.disabled = !0), zg.classList.add("rolling"));
        let e = 0;
        const t = setInterval(() => {
            if ((ly(Math.floor(6 * Math.random()) + 1), e++, e >= 12)) {
                clearInterval(t);
                const e = Math.floor(6 * Math.random()) + 1;
                ((Hg.diceValue = e),
                    ly(e),
                    zg.classList.remove("rolling"),
                    (Hg.isRolling = !1),
                    (Vg.textContent = `‰Ω†Êé∑Âá∫‰∫Ü ${e} ÁÇπÔºÅ`),
                    setTimeout(() => {
                        my(e);
                    }, 600));
            }
        }, 80);
    }
    async function dy() {
        if (!Hg.gameOver) {
            Vg.textContent = `${Sc?.name || "TA"}Ê≠£Âú®ÊÄùËÄÉ...`;
            try {
                const e = await Kl.loadData("settingsStore", "apiSettings");
                if (!e?.value?.url) return void uy();
                const { url: t, key: n, model: a } = e.value;
                let o = t.endsWith("/") ? t.slice(0, -1) : t;
                o += "/chat/completions";
                const s = 0 === Hg.aiPosition ? "Ëµ∑ÁÇπ" : `Á¨¨${Hg.aiPosition}Ê†º`,
                    i = 0 === Hg.userPosition ? "Ëµ∑ÁÇπ" : `Á¨¨${Hg.userPosition}Ê†º`,
                    r = (Sc?.history ? Sc.history.slice(-8) : [])
                        .map((e) =>
                            "ai" === e.sender
                                ? `${Sc.name}: ${e.text}`
                                : "user" === e.sender
                                    ? `Áî®Êà∑: ${e.text}`
                                    : "",
                        )
                        .filter(Boolean)
                        .join("\n");
                let l = "";
                if (Sc?.worldBooks?.length > 0) {
                    const e = [];
                    for (const t of Sc.worldBooks) {
                        const n = await Kl.loadData("worldBooksStore", t);
                        n?.value?.content && e.push(n.value.content);
                    }
                    e.length > 0 && (l = "\n„Äê‰∏ñÁïåËÆæÂÆö„Äë\n" + e.join("\n\n"));
                }
                const c = Hg.messages
                    .map((e) => `${"ai" === e.sender ? Sc.name : "Áî®Êà∑"}: ${e.text}`)
                    .join("\n");
                let d = "";
                Hg.pendingContext &&
                    ((d =
                        "\n„ÄêÈáçË¶ÅÊèêÁ§∫„Äë" +
                        Hg.pendingContext +
                        "\nËØ∑Âä°ÂøÖÂú®‰Ω†ÁöÑÂõûÁ≠î‰∏≠ÂØπ‰∏äËø∞ÂÜÖÂÆπÈÄöËøáÂêêÊßΩ„ÄÅËµûËµèÊàñËøΩÈóÆÁ≠âÊñπÂºèÂÅöÂá∫ÂèçÂ∫îÔºÅ\n"),
                        (Hg.pendingContext = null));
                const u = `‰Ω†Ê≠£Âú®‰∏éÁî®Êà∑Áé©È£ûË°åÊ£ãÊ∏∏Êàè„ÄÇ‰Ω†ÁöÑÂêçÂ≠óÊòØ"${Sc?.name || "TA"}"„ÄÇ${d} \n\n„ÄêËßíËâ≤ËÆæÂÆö„Äë\n${Sc?.ai?.persona || "‰Ω†ÊòØ‰∏Ä‰∏™ÊÄßÊ†ºÈ≤úÊòéÁöÑËßíËâ≤„ÄÇ"}\n${l}\n\n„ÄêÂΩìÂâçÁöÑÂØπËØùËØ≠Â¢É„Äë\n${r || "ÔºàÊöÇÊó†‰πãÂâçÂØπËØùÔºâ"}\n\n„ÄêÊ∏∏ÊàèÂÜÖÂç≥Êó∂ËÆ∞ÂΩï„Äë\n${c || "ÔºàÊ∏∏ÊàèÂàöÂºÄÂßãÔºâ"}\n\n„ÄêÂΩìÂâçÂ±ÄÈù¢„Äë\n- ‰Ω†Âú®: ${s}\n- Áî®Êà∑Âú®: ${i}\n- ÁõÆÊ†á: Á¨¨20Ê†º\n- Áä∂ÂÜµ: ËΩÆÂà∞‰Ω†Êé∑È™∞Â≠ê\n\n„ÄêË°åÂä®ÂáÜÂàô„Äë\n1. **ÂÆåÂÖ®‰ª£ÂÖ•ËßíËâ≤**ÔºöÂøÖÈ°ªÁî®"${Sc?.name || "TA"}"ÁöÑËØ≠Ê∞î„ÄÅÂè£ÁôñÂíåÊÄßÊ†ºËØ¥ËØù„ÄÇ\n2. **ÊãíÁªùÊú∫Ê¢∞ÊÑü**Ôºö‰∏çË¶ÅÂ§çËø∞ËßÑÂàôÔºå‰∏çË¶ÅËØ¥"ËΩÆÂà∞Êàë‰∫Ü"„ÄÇÁõ¥Êé•Ê†πÊçÆÂ±ÄÈù¢ÂèëË°®ÊÑüÊÉ≥ÔºàÁ•àÁ•∑Â•ΩËøê„ÄÅÊîæÁã†ËØù„ÄÅÈó≤ËÅäÁöÜÂèØÔºâ„ÄÇ\n3. **ÁÆÄÁü≠Ëá™ÁÑ∂**ÔºöÂÉèÁúü‰∫∫‰∏ÄÊ†∑ËÅäÂ§©Ôºå‰∏Ä‰∏§Âè•ËØùÂç≥ÂèØÔºà20Â≠ó‰ª•ÂÜÖÔºâ„ÄÇ\n\n„ÄêËæìÂá∫Ê†ºÂºè„Äë\n[CHAT]‰Ω†ÁöÑËØù[/CHAT]`,
                    m = await fetch(o, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${n}`,
                        },
                        body: JSON.stringify({
                            model: a,
                            messages: [
                                {
                                    role: "system",
                                    content: u,
                                },
                                {
                                    role: "user",
                                    content: "ËΩÆÂà∞‰Ω†‰∫ÜÔºåËØ∑ËØ¥‰∏ÄÂè•ËØùÔºàÈ™∞Â≠êÁÇπÊï∞Â∞ÜÁî±Á≥ªÁªüÈöèÊú∫ÁîüÊàêÔºâ„ÄÇ",
                                },
                            ],
                            temperature: 0.9,
                        }),
                    });
                if (!m.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${m.status}`);
                const p = (await m.json()).choices[0].message.content;
                (console.log("[È£ûË°åÊ£ã] AIÂéüÂßãÂõûÂ§ç:", p),
                    (async function (e) {
                        const t = e.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/),
                            n = t ? t[1].trim() : e.replace(/\[.*?\]/g, "").trim() || "Ëµ∞Ëµ∑~",
                            a = Math.floor(6 * Math.random()) + 1;
                        (Hg.messages.push({
                            sender: "ai",
                            text: n,
                        }),
                            (Kg.textContent = n),
                            (Vg.textContent = `${Sc?.name || "TA"}Ê≠£Âú®Êé∑È™∞Â≠ê...`),
                            await gy(800),
                            zg.classList.add("rolling"));
                        let o = 0;
                        const s = 10;
                        (await new Promise((e) => {
                            const t = setInterval(() => {
                                (ly(Math.floor(6 * Math.random()) + 1),
                                    o++,
                                    o >= s && (clearInterval(t), e()));
                            }, 80);
                        }),
                            ly(a),
                            zg.classList.remove("rolling"),
                            (Hg.diceValue = a),
                            (Vg.textContent = `${Sc?.name || "TA"}Êé∑Âá∫‰∫Ü ${a} ÁÇπÔºÅ`),
                            await gy(800),
                            await my(a));
                    })(p));
            } catch (e) {
                (console.error("[È£ûË°åÊ£ã] AIÂõûÂêàÂá∫Èîô:", e), uy());
            }
        }
    }
    async function uy() {
        const e = [
            "ÁúãÊàëÁöÑÔºÅ",
            "ËøôÊ¨°‰∏ÄÂÆöÂ§ßÔºÅ",
            "ÂÜ≤ÂÜ≤ÂÜ≤~",
            "ÂòøÂòø~",
            "Ëµ∞Ëµ∑ÔºÅ",
            "È£ûÈ´òÈ´òÔºÅ",
        ];
        ((Kg.textContent = e[Math.floor(Math.random() * e.length)]),
            await gy(600),
            zg.classList.add("rolling"));
        let t = 0;
        const n = Math.floor(6 * Math.random()) + 1;
        (await new Promise((e) => {
            const n = setInterval(() => {
                (ly(Math.floor(6 * Math.random()) + 1),
                    t++,
                    t >= 10 && (clearInterval(n), e()));
            }, 80);
        }),
            ly(n),
            zg.classList.remove("rolling"),
            (Hg.diceValue = n),
            (Vg.textContent = `${Sc?.name || "TA"}Êé∑Âá∫‰∫Ü ${n} ÁÇπÔºÅ`),
            await gy(800),
            await my(n));
    }
    async function my(e) {
        const t = Hg.currentTurn,
            n = "user" === t ? Hg.userPosition : Hg.aiPosition;
        let a = n + e;
        (a > _g && (a = _g),
            (Hg.isMoving = !0),
            0 === n &&
            ("user" === t ? (Hg.userPosition = 1) : (Hg.aiPosition = 1),
                ry(),
                await gy(500),
                (a = 1 + e - 1),
                a > _g && (a = _g)));
        for (
            let e = ("user" === t ? Hg.userPosition : Hg.aiPosition) + 1;
            e <= a;
            e++
        ) {
            "user" === t ? (Hg.userPosition = e) : (Hg.aiPosition = e);
            const n = document.getElementById(
                "user" === t ? "ludo-user-piece" : "ludo-ai-piece",
            );
            (n && n.classList.add("flying"),
                ry(),
                await gy(400),
                n &&
                (n.classList.remove("flying"),
                    n.classList.add("landing"),
                    setTimeout(() => n.classList.remove("landing"), 400)));
        }
        if (((Hg.isMoving = !1), a >= _g))
            return (
                (Hg.gameOver = !0),
                (Hg.winner = t),
                void (async function () {
                    const e = Hg.winner,
                        t = "user" === e ? "‰Ω†" : Sc?.name || "TA";
                    ((Vg.textContent = `üéâ ${t}Ëé∑ËÉúÔºÅ`),
                        "user" === e
                            ? ((Zg.textContent = "ÊàëËµ¢Âï¶ÔºÅ"), (Kg.textContent = "‰∏ãÊ¨°ÂÜçÊàòÔºÅ"))
                            : ((Kg.textContent = "ÊàëËµ¢Âï¶~"),
                                (Zg.textContent = "ÂÜçÊù•‰∏ÄÂ±ÄÔºÅ")));
                    ((ty.style.display = "none"),
                        (sy.style.display = "block"),
                        Sc &&
                        setTimeout(() => {
                            const t = Hg.messages
                                .map(
                                    (e) => `${"ai" === e.sender ? Sc.name : "‰Ω†"}: ${e.text}`,
                                )
                                .join("\n"),
                                n =
                                    "user" === e
                                        ? "‰Ω†Ëé∑ËÉú"
                                        : "ai" === e
                                            ? `${Sc.name}Ëé∑ËÉú`
                                            : "Ê∏∏ÊàèÁªìÊùü",
                                a = Ng[Math.floor(Math.random() * Ng.length)];
                            let o = "";
                            "user" === e
                                ? ((o = `„ÄêÊÉ©ÁΩöÁéØËäÇ„Äë‰Ω†Ëæì‰∫ÜÔºÅËØ∑Êé•ÂèóÊÉ©ÁΩöÔºö${a}\n(ËØ∑AIÊ†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÔºåÈÄâÊã©ÊâßË°åËøô‰∏™ÊÉ©ÁΩöÔºåÊàñËÄÖÁî®ÊúâË∂£ÁöÑÊñπÂºèËµñÊéâÔºåÊàñËÄÖÊííÂ®áÊ±ÇÈ•∂ÔºåÊÄª‰πãË¶ÅÊúâÂèçÂ∫î)`),
                                    alert(
                                        `üéâ ‰Ω†Ëµ¢‰∫ÜÔºÅ\n\nÈöèÊú∫ÁîüÊàêÁöÑÊÉ©ÁΩöÊòØÔºö\n${a}\n\n(Â∑≤ÈÄöÁü•ÔºåÁúãTAÊÄé‰πàËØ¥~)`,
                                    ))
                                : ((o = `„ÄêÊÉ©ÁΩöÁéØËäÇ„ÄëÁî®Êà∑Ëæì‰∫ÜÔºÅÁî®Êà∑ÊäΩÂà∞ÁöÑÊÉ©ÁΩöÊòØÔºö${a}\n(ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÔºåÂò≤Á¨ë„ÄÅË∞É‰æÉÁî®Êà∑ÔºåÊàñËÄÖÁõëÁù£Áî®Êà∑ÊâßË°åÊÉ©ÁΩö)`),
                                    alert(
                                        `üò≠ ‰Ω†Ëæì‰∫ÜÔºÅ\n\n‰Ω†ÊäΩÂà∞ÁöÑÊÉ©ÁΩöÊòØÔºö\n${a}\n\n(TAÊ≠£Âú®ÁúãÁùÄ‰Ω†Âì¶...)`,
                                    ));
                            const s = `(Á≥ªÁªüÊåá‰ª§ÔºöÂàöÂàöÁªìÊùü‰∫Ü‰∏ÄÂ±ÄÈ£ûË°åÊ£ãÊ∏∏Êàè„ÄÇ\n                \n„ÄêÊ∏∏ÊàèÁªìÊûú„Äë${n}\n\n„ÄêÊúÄÁªà‰ΩçÁΩÆ„Äë\nAI: Á¨¨ ${Hg.aiPosition} Ê†º (ÂÖ±20Ê†º)\nÁî®Êà∑: Á¨¨ ${Hg.userPosition} Ê†º (ÂÖ±20Ê†º)\n\n${o}\n\n„ÄêÊ∏∏ÊàèÂØπËØù„Äë\n${t || "ÔºàÊó†ÂØπËØùÔºâ"}\n\nËØ∑Ê†πÊçÆËøôÂ±ÄÊ∏∏ÊàèÁªìÊûúÂíåÊÉ©ÁΩöÁéØËäÇÔºåËØ¥ËØ¥‰Ω†ÁöÑÊÑüÊÉ≥„ÄÅËØÑËÆ∫ÊàñÂèçÂ∫î„ÄÇ`;
                            (console.log("[È£ûË°åÊ£ã] Ëß¶ÂèëAIÂõûÂ§ç:", s), Tc(s, Sc));
                        }, 1e3));
                })()
            );
        await (async function (e, t) {
            const n = Og[e];
            if (!n) return void py();
            const a = "user" === t ? "‰Ω†" : Sc?.name || "TA";
            switch (n) {
                case "bonus":
                    return (
                        (Vg.textContent = `üéâ ${a}Ë∏©Âà∞‰∫ÜÂä†ÈÄüÊ†ºÔºåÂâçËøõ2Ê†ºÔºÅ`),
                        await gy(1200),
                        void (await my(2))
                    );
                case "penalty":
                    const e = "user" === t ? Hg.userPosition : Hg.aiPosition;
                    ((Vg.textContent = `üòÖ ${a}Ë∏©Âà∞‰∫ÜÂáèÈÄüÊ†ºÔºåÂêéÈÄÄ2Ê†ºÔºÅ`), await gy(800));
                    const n = Math.max(1, e - 2);
                    ("user" === t ? (Hg.userPosition = n) : (Hg.aiPosition = n),
                        ry(),
                        await gy(1e3),
                        py());
                    break;
                case "skip":
                    ((Vg.textContent = `‚è∏Ô∏è ${a}Ë∏©Âà∞‰∫ÜÊöÇÂÅúÊ†ºÔºå‰ºëÊÅØ‰∏ÄËΩÆÔºÅ`),
                        await gy(1200),
                        py());
                    break;
                case "truth":
                    const o = qg[Math.floor(Math.random() * qg.length)];
                    if ("user" !== t) {
                        const e = `(È¢òÁõÆ: ${o})`;
                        return (
                            (Vg.textContent = "TAÊ≠£Âú®ÊÄùËÄÉÈ¢òÁõÆ..."),
                            (Kg.textContent = e),
                            Hg.messages.push({
                                sender: "ai",
                                text: e,
                            }),
                            void (async function (e) {
                                if (Sc)
                                    try {
                                        const t = await Kl.loadData("settingsStore", "apiSettings"),
                                            { url: n, key: a, model: o } = t?.value || {};
                                        if (!n || !a)
                                            return (
                                                (Kg.textContent = "(AIÈÖçÁΩÆÁº∫Â§±ÔºåÊó†Ê≥ïÂõûÁ≠î)"),
                                                void setTimeout(py, 3e3)
                                            );
                                        let s = n.endsWith("/") ? n.slice(0, -1) : n;
                                        s += "/chat/completions";
                                        const i = Sc.ai || {},
                                            r = Sc.user || {},
                                            l = i.persona || i.description || "Êó†ËÆæÂÆö",
                                            c = r.persona || "ÊôÆÈÄöÁî®Êà∑",
                                            d = [
                                                {
                                                    role: "system",
                                                    content: `‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Áé©È£ûË°åÊ£ã„ÄÇ‰Ω†Ë∏©Âà∞‰∫Ü‚ÄúÁúüÂøÉËØù‚ÄùÊ†ºÂ≠ê„ÄÇ\nÂè™ËÉΩÁî®Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑËØ≠Ê∞îÂõûÁ≠îÔºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ\n‰Ω†ÁöÑÂõûÁ≠îÂ∫îËØ•ÁÆÄÁü≠„ÄÅÊúâË∂£„ÄÅÁ¨¶ÂêàÂΩì‰∏ãÊÉÖÂ¢É„ÄÇ\n\n„ÄêÈ¢òÁõÆ„Äë\n${e}\n\n„ÄêËßíËâ≤ËÆæÂÆö„Äë\n‰Ω†: ${i.name || "AI"} (${l})\nÁî®Êà∑: ${r.name || "Áî®Êà∑"} (${c})\n`,
                                                },
                                                {
                                                    role: "user",
                                                    content: `ËØ∑ÂõûÁ≠îÁúüÂøÉËØùÈ¢òÁõÆÔºö${e}`,
                                                },
                                            ],
                                            u = await fetch(s, {
                                                method: "POST",
                                                headers: {
                                                    "Content-Type": "application/json",
                                                    Authorization: `Bearer ${a}`,
                                                },
                                                body: JSON.stringify({
                                                    model: o,
                                                    messages: d,
                                                    temperature: 0.8,
                                                }),
                                            });
                                        if (!u.ok) {
                                            const e = await u.text();
                                            throw new Error(`APIÈîôËØØ: ${u.status} - ${e}`);
                                        }
                                        const m = await u.json(),
                                            p = m.choices?.[0]?.message?.content || "(Ê≤âÈªò)";
                                        ((Kg.textContent = p),
                                            Hg.messages.push({
                                                sender: "ai",
                                                text: p,
                                            }),
                                            Sc.history || (Sc.history = []),
                                            Sc.history.push({
                                                sender: "ai",
                                                text: `(Âú®È£ûË°åÊ£ãÁúüÂøÉËØù‰∏≠ÂõûÁ≠î): ${p}`,
                                                timestamp: Date.now(),
                                            }),
                                            await Kl.saveData("messageContacts", Sc),
                                            setTimeout(py, 4e3));
                                    } catch (e) {
                                        (console.error("AI Truth Error:", e),
                                            (Kg.textContent = `(AIÂá∫Èîô: ${e.message.substring(0, 15)}...)`),
                                            setTimeout(py, 4e3));
                                    }
                            })(o)
                        );
                    }
                    (alert(
                        `„ÄêÁúüÂøÉËØù„Äë\nËØ∑ÂõûÁ≠îÔºö${o}\n\n(ËØ∑Âú®ËÅäÂ§©ËæìÂÖ•Ê°ÜÂèëÈÄÅ‰Ω†ÁöÑÂõûÁ≠î‰ª•ÁªìÊùüÂõûÂêà)`,
                    ),
                        (Vg.textContent = `ËØ∑Âú®ËÅäÂ§©Ê°ÜÂõûÁ≠îÔºö${o}`),
                        (Hg.isUserReplyingSpecial = !0),
                        (Hg.currentTruthQuestion = o));
                    break;
                case "punishment":
                    const s = Ng[Math.floor(Math.random() * Ng.length)];
                    if ("user" !== t) {
                        Vg.textContent = "TAÈù¢‰∏¥ÊÉ©ÁΩö...";
                        const e = `(Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Ë∏©Âà∞‰∫Ü‚ÄúÂ§ßÂÜíÈô©/ÊÉ©ÁΩö‚ÄùÊ†ºÂ≠ê„ÄÇÊÉ©ÁΩöÂÜÖÂÆπÊòØÔºö${s}„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂÅöÂá∫ÂèçÂ∫î„ÄÇÂ¶ÇÊûúÈúÄË¶ÅÂèëÁ∫¢ÂåÖÊàñËØ≠Èü≥ÔºåËØ∑Áî®ÊñáÂ≠óÊèèËø∞‰Ω†ÁöÑË°åÂä®„ÄÇ)`;
                        return void setTimeout(() => Tc(e, Sc), 1e3);
                    }
                    (alert(
                        `„ÄêÂ§ßÂÜíÈô©/ÊÉ©ÁΩö„Äë\nËØ∑ÊâßË°åÔºö${s}\n\n(ËØ∑Âú®ËÅäÂ§©ËæìÂÖ•Ê°ÜÊèèËø∞‰Ω†ÁöÑË°åÂä®‰ª•ÁªìÊùüÂõûÂêà)`,
                    ),
                        (Vg.textContent = `ËØ∑Âú®ËÅäÂ§©Ê°ÜÂÆåÊàêÊÉ©ÁΩöÔºö${s}`),
                        (Hg.isUserReplyingSpecial = !0));
                    break;
                default:
                    py();
            }
        })(a, t);
    }

    function py() {
        Hg.gameOver ||
            ((Hg.currentTurn = "user" === Hg.currentTurn ? "ai" : "user"),
                "user" === Hg.currentTurn
                    ? ((Vg.textContent = "ËΩÆÂà∞‰Ω†Êé∑È™∞Â≠ê‰∫ÜÔºÅ"), (ty.disabled = !1))
                    : ((Vg.textContent = `${Sc?.name || "TA"}Ê≠£Âú®ÊÄùËÄÉ...`),
                        (ty.disabled = !0),
                        setTimeout(() => {
                            dy();
                        }, 1e3)));
    }

    function gy(e) {
        return new Promise((t) => setTimeout(t, e));
    }
    if (
        (Gg &&
            Gg.addEventListener("click", () => {
                Sc
                    ? ((Rg.style.display = "block"), iy(), id())
                    : alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫");
            }),
            Wg &&
            Wg.addEventListener("click", () => {
                Rg.style.display = "none";
            }),
            jg &&
            jg.addEventListener("click", function () {
                const e = document.documentElement,
                    t = getComputedStyle(e),
                    n = {
                        "ludo-primary":
                            t.getPropertyValue("--ludo-primary").trim() || "#FFD93D",
                        "ludo-secondary":
                            t.getPropertyValue("--ludo-secondary").trim() || "#6BCB77",
                        "ludo-accent":
                            t.getPropertyValue("--ludo-accent").trim() || "#4D96FF",
                        "ludo-bg-start":
                            t.getPropertyValue("--ludo-bg-start").trim() || "#FFFBEB",
                        "ludo-bg-end":
                            t.getPropertyValue("--ludo-bg-end").trim() || "#E8F5E9",
                        "ludo-cell-normal":
                            t.getPropertyValue("--ludo-cell-normal").trim() || "#FFF8E7",
                        "ludo-cell-bonus":
                            t.getPropertyValue("--ludo-cell-bonus").trim() || "#B4F8C8",
                        "ludo-cell-penalty":
                            t.getPropertyValue("--ludo-cell-penalty").trim() || "#FFADAD",
                        "ludo-cell-truth":
                            t.getPropertyValue("--ludo-cell-truth").trim() || "#FFD6E8",
                        "ludo-cell-start":
                            t.getPropertyValue("--ludo-cell-start").trim() || "#A0C4FF",
                        "ludo-cell-end":
                            t.getPropertyValue("--ludo-cell-end").trim() || "#FFE066",
                        "ludo-console-bg":
                            t.getPropertyValue("--ludo-console-bg").trim() || "#2D2D2D",
                        "ludo-plane-ai":
                            t.getPropertyValue("--ludo-plane-ai").trim() || "#FF6B6B",
                        "ludo-plane-user":
                            t.getPropertyValue("--ludo-plane-user").trim() || "#4ECDC4",
                        "ludo-border-radius":
                            t.getPropertyValue("--ludo-border-radius").trim() || "24px",
                    },
                    a = JSON.stringify(n, null, 2),
                    o = new Blob([a], {
                        type: "application/json",
                    }),
                    s = URL.createObjectURL(o),
                    i = document.createElement("a");
                ((i.href = s),
                    (i.download = "ludo-game-styles.json"),
                    document.body.appendChild(i),
                    i.click(),
                    document.body.removeChild(i),
                    URL.revokeObjectURL(s),
                    (Vg.textContent = "CSSÊ†∑ÂºèÂ∑≤ÂØºÂá∫ÔºÅ"),
                    setTimeout(() => {
                        Hg.gameOver ||
                            (Vg.textContent =
                                "user" === Hg.currentTurn ? "ËΩÆÂà∞‰Ω†Êé∑È™∞Â≠ê‰∫ÜÔºÅ" : "TAÁöÑÂõûÂêà");
                    }, 2e3));
            }),
            Qg &&
            Qg.addEventListener("click", () => {
                ((Xg.style.display = "none"),
                    (ty.style.display = "block"),
                    (ny.style.display = "flex"),
                    (Hg.currentTurn = "user"),
                    (Vg.textContent = "ËΩÆÂà∞‰Ω†Êé∑È™∞Â≠ê‰∫ÜÔºÅ"),
                    (Kg.textContent = "‰Ω†ÂÖàÊù•~"));
            }),
            ey &&
            ey.addEventListener("click", () => {
                ((Xg.style.display = "none"),
                    (ty.style.display = "block"),
                    (ny.style.display = "flex"),
                    (ty.disabled = !0),
                    (Hg.currentTurn = "ai"),
                    (Vg.textContent = `${Sc?.name || "TA"}ÂÖàÊé∑È™∞Â≠ê...`),
                    (Zg.textContent = "Áúã‰Ω†ÁöÑÔºÅ"),
                    setTimeout(() => dy(), 800));
            }),
            ty &&
            ty.addEventListener("click", () => {
                "user" === Hg.currentTurn && cy();
            }),
            zg &&
            zg.addEventListener("click", () => {
                "user" !== Hg.currentTurn || ty.disabled || cy();
            }),
            oy && ay)
    ) {
        const ov = () => {
            const e = ay.value.trim();
            if (
                e &&
                (Hg.messages.push({
                    sender: "user",
                    text: e,
                }),
                    (Zg.textContent = e),
                    (ay.value = ""),
                    Hg.isUserReplyingSpecial)
            ) {
                Hg.isUserReplyingSpecial = !1;
                const t = Hg.currentTruthQuestion || "‰∏Ä‰∏™ÁúüÂøÉËØùÈóÆÈ¢ò";
                ((Hg.pendingContext = `(Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÊâçÂõûÁ≠î‰∫ÜÁúüÂøÉËØùÈóÆÈ¢ò‚Äú${t}‚ÄùÔºåÂõûÁ≠îÂÜÖÂÆπÊòØÔºö‚Äú${e}‚Äù„ÄÇËØ∑‰Ω†Âú®Êé•‰∏ãÊù•ÁöÑË°åÂä®‰∏≠ÂØπÁî®Êà∑ÁöÑÂõûÁ≠îÂÅöÂá∫ÂèçÂ∫î/ËØÑ‰ª∑„ÄÇ)`),
                    delete Hg.currentTruthQuestion,
                    (Vg.textContent = "‚úÖ ÂõûÁ≠îÂ∑≤ËÆ∞ÂΩïÔºåËΩÆÂà∞TA‰∫Ü..."),
                    setTimeout(() => {
                        py();
                    }, 1500));
            }
        };
        (oy.addEventListener("click", (e) => {
            (e.stopPropagation(), ov());
        }),
            ay.addEventListener("keydown", (e) => {
                "Enter" !== e.key ||
                    e.shiftKey ||
                    (e.preventDefault(), e.stopPropagation(), ov());
            }),
            ay.addEventListener("click", (e) => {
                (e.stopPropagation(), ay.focus());
            }),
            ay.addEventListener("touchstart", (e) => {
                e.stopPropagation();
            }));
    }
    sy && sy.addEventListener("click", iy);
    const yy = document.getElementById("chat-message-input");
    if (yy) {
        const sv = (e) => {
            (e.stopPropagation(), yy.focus());
        };
        (yy.addEventListener("click", sv), yy.addEventListener("touchstart", sv));
    }
    const hy = document.getElementById("memory-feature"),
        vy = document.getElementById("memory-modal"),
        fy = document.getElementById("memory-close-btn"),
        wy = document.querySelector(".memory-modal-overlay"),
        by = document.querySelectorAll(".memory-tab"),
        Ey = document.getElementById("memory-retrospect-panel"),
        Iy = document.getElementById("memory-bonds-panel"),
        xy = document.getElementById("memory-total-count"),
        ky = document.getElementById("memory-last-summarized"),
        Ly = document.getElementById("memory-unprocessed-count"),
        By = document.getElementById("memory-message-count"),
        Sy = document.getElementById("memory-model-select"),
        Cy = document.getElementById("memory-prompt-input"),
        $y = document.getElementById("memory-summarize-btn"),
        My = document.getElementById("memory-cheques-container"),
        Ty =
            "‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑËÆ∞ÂøÜÊï¥ÁêÜÂ∏à,ÊìÖÈïø‰ªéÂØπËØù‰∏≠ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ„ÄÅÊÉÖÊÑüËÑâÁªúÂíåÈáçË¶ÅÁªÜËäÇ„ÄÇ\n\nËØ∑‰ªîÁªÜÈòÖËØª‰ª•‰∏ãËÅäÂ§©ËÆ∞ÂΩï,Âπ∂ËøõË°åÊ∑±Â∫¶ÊÄªÁªì:\n\n„ÄêÊÄªÁªìË¶ÅÊ±Ç„Äë\n1. **Ê†∏ÂøÉ‰∫ã‰ª∂**: ËØ¶ÁªÜËÆ∞ÂΩïÂØπËØù‰∏≠ÂèëÁîüÁöÑÈáçË¶Å‰∫ã‰ª∂„ÄÅÊ¥ªÂä®ÊàñËØùÈ¢ò,ÂåÖÊã¨Êó∂Èó¥„ÄÅÂú∞ÁÇπ„ÄÅ‰∫∫Áâ©Á≠âÂÖ≥ÈîÆË¶ÅÁ¥†\n2. **ÊÉÖÊÑüÂèòÂåñ**: ÊçïÊçâÂèåÊñπÁöÑÊÉÖÁª™Ëµ∑‰ºè„ÄÅÊÄÅÂ∫¶ËΩ¨Âèò„ÄÅ‰∫≤ÂØÜÂ∫¶ÂèòÂåñ\n3. **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ËÆ∞ÂΩïÈáçË¶ÅÁöÑÊâøËØ∫„ÄÅÁ∫¶ÂÆö„ÄÅÂÅèÂ•Ω„ÄÅ‰π†ÊÉØ„ÄÅ‰∏™‰∫∫‰ø°ÊÅØÁ≠â\n4. **ÂØπËØùÁâπËâ≤**: Ê≥®ÊÑèÂèåÊñπÁöÑËØ¥ËØùÈ£éÊ†º„ÄÅÂ∏∏Áî®ËØçÊ±á„ÄÅÊòµÁß∞„ÄÅÊ¢óÁ≠â‰∏™ÊÄßÂåñÂÜÖÂÆπ\n5. **ÂÖ≥Á≥ªÂèëÂ±ï**: ÂàÜÊûêÂèåÊñπÂÖ≥Á≥ªÁöÑËøõÂ±ïÂíå‰∫íÂä®Ê®°Âºè\n\n„ÄêËæìÂá∫Ê†ºÂºè„Äë\n- ‰ΩøÁî®Âèô‰∫ãÊÄßËØ≠Ë®Ä,ÂÉèÂÜôÊó•ËÆ∞‰∏ÄÊ†∑ËÆ∞ÂΩï\n- ‰øùÁïôÂÖ∑‰ΩìÁªÜËäÇÂíåÁîüÂä®ÊèèËø∞\n- Â≠óÊï∞ÊéßÂà∂Âú® 100-250 Â≠ó\n- ÂàÜÊÆµÂëàÁé∞,‰æø‰∫éÈòÖËØª\n\nËØ∑ÂºÄÂßãÊÄªÁªì:";
    async function Ay() {
        if (Sc) {
            ((vy.style.display = "flex"),
                await (async function () {
                    try {
                        var e = await Kl.loadData("settingsStore", "apiSettings");
                        if (!e || !e.value || !e.value.model)
                            return void (Sy.innerHTML =
                                '<option value="">ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI</option>');
                        var t = e.value.model;
                        Sy.options.length <= 1 &&
                            (Sy.innerHTML =
                                '<option value="' + t + '" selected>' + t + "</option>");
                        var n = document.getElementById("memory-fetch-models-btn");
                        if (n) {
                            var a = n.cloneNode(!0);
                            (n.parentNode.replaceChild(a, n),
                                a.addEventListener("click", Oy));
                        }
                    } catch (e) {
                        (console.error("Âä†ËΩΩÊ®°ÂûãÂ§±Ë¥•:", e),
                            (Sy.innerHTML = '<option value="">Âä†ËΩΩÂ§±Ë¥•</option>'));
                    }
                })());
            var e = localStorage.getItem("memory_custom_prompt");
            Cy && (Cy.value = e || Ty);
            var t = localStorage.getItem("memory_selected_model");
            if (t && Sy && ((Sy.value = t), Sy.value !== t)) {
                var n = document.createElement("option");
                ((n.value = t), (n.text = t), Sy.add(n), (Sy.value = t));
            }
            (qy(), await zy());
            var a = document.getElementById("more-features-panel");
            a && a.classList.remove("active");
        } else alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫");
    }

    function Dy() {
        (vy && (vy.style.display = "none"), My && (My.innerHTML = ""));
    }

    function Py(e) {
        (by.forEach(function (t) {
            t.classList.toggle("active", t.dataset.tab === e);
        }),
            Ey.classList.toggle("active", "retrospect" === e),
            Iy.classList.toggle("active", "bonds" === e));
    }

    function Hy(e, t) {
        var n = document.createElement("div");
        ((n.className = "memory-toast"),
            (n.innerText = e),
            (n.style.position = "fixed"),
            (n.style.top = "20px"),
            (n.style.left = "50%"),
            (n.style.transform = "translateX(-50%)"),
            (n.style.padding = "10px 20px"),
            (n.style.background = "rgba(139, 90, 43, 0.9)"),
            (n.style.color = "#fff"),
            (n.style.borderRadius = "4px"),
            (n.style.zIndex = "10000"),
            (n.style.fontSize = "14px"),
            (n.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)"),
            (n.style.transition = "opacity 0.3s ease"),
            document.body.appendChild(n),
            setTimeout(function () {
                ((n.style.opacity = "0"),
                    setTimeout(function () {
                        n.parentNode && n.parentNode.removeChild(n);
                    }, 300));
            }, 3e3));
    }
    async function Oy() {
        var e = document.getElementById("memory-fetch-models-btn");
        e && e.classList.add("loading");
        try {
            var t = await Kl.loadData("settingsStore", "apiSettings");
            if (!t || !t.value || !t.value.url)
                return void alert("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ");
            var n = t.value.url;
            n.endsWith("/") && (n = n.slice(0, -1));
            var a = [];
            (a.push(n + "/models"),
                n.includes("/v1") ||
                n.includes("openai.azure.com") ||
                a.push(n + "/v1/models"),
                n.includes("generativelanguage.googleapis.com") &&
                !n.includes("openai") &&
                a.push(n + "/v1beta/models"),
                console.log("Â∞ùËØïÊãâÂèñÊ®°ÂûãÔºåÂÄôÈÄâÂú∞ÂùÄ:", a));
            var o = null,
                s = null;
            for (var i of a)
                try {
                    var r = {
                        method: "GET",
                        headers: {
                            Authorization: "Bearer " + t.value.key,
                        },
                    },
                        l = await fetch(i, r);
                    if (l.ok) {
                        ((o = l),
                            (s = await l.json()),
                            console.log("Ê®°ÂûãÊãâÂèñÊàêÂäüÔºå‰ΩøÁî®Âú∞ÂùÄ:", i));
                        break;
                    }
                } catch (e) {
                    console.warn("Â∞ùËØïÂú∞ÂùÄÂ§±Ë¥•:", i, e);
                }
            if (!o || !s)
                throw new Error(
                    "ÊâÄÊúâË∑ØÂæÑÂ∞ùËØïÂùáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü• Base URL ÊòØÂê¶Ê≠£Á°Æ (Êó†ÈúÄÂåÖÂê´ /chat/completions)",
                );
            var c = [];
            if (
                (Array.isArray(s.data)
                    ? (c = s.data.map((e) => e.id))
                    : Array.isArray(s.models)
                        ? (c = s.models.map((e) => e.name.replace("models/", "")))
                        : Array.isArray(s)
                            ? (c = s.map((e) => e.id))
                            : console.warn("Êó†Ê≥ïËØÜÂà´ÁöÑËøîÂõûÊ†ºÂºè:", s),
                    c.length > 0)
            ) {
                c.sort();
                var d = Sy.value,
                    u = c
                        .map(function (e) {
                            return (
                                '<option value="' +
                                e +
                                '"' +
                                (e === d ? " selected" : "") +
                                ">" +
                                e +
                                "</option>"
                            );
                        })
                        .join("");
                (!c.includes(d) &&
                    d &&
                    (u = '<option value="' + d + '" selected>' + d + "</option>" + u),
                    (Sy.innerHTML = u),
                    Hy("Â∑≤ÊàêÂäüÊãâÂèñ " + c.length + " ‰∏™Ê®°Âûã"));
            } else Hy("Êú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã");
        } catch (e) {
            (console.error("ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•:", e),
                alert(
                    "ÊãâÂèñÂ§±Ë¥•: " +
                    e.message +
                    "\nÂ¶ÇÊûú‰ΩøÁî®ÁöÑÊòØ Zeabur Á≠âÂèç‰ª£ÔºåÂ∞ùËØïÂú® URL ÂêéÂä†‰∏ä /v1",
                ));
        } finally {
            e && e.classList.remove("loading");
        }
    }

    function qy() {
        if (!Sc || !Sc.history)
            return (
                (xy.textContent = "0"),
                (ky.textContent = "0"),
                void (Ly.textContent = "0")
            );
        var e = Sc.history.length,
            t = Sc.lastMemorySummarizedIndex || 0;
        ((xy.textContent = e), (ky.textContent = t), (Ly.textContent = e - t));
    }
    async function Ny() {
        if (Sc) {
            var e = parseInt(By.value),
                t = Sy.value,
                n = Cy.value.trim();
            if (t)
                if (n)
                    if (
                        (localStorage.setItem("memory_custom_prompt", n),
                            localStorage.setItem("memory_selected_model", t),
                            e < 1 || e > 2e4)
                    )
                        alert("ËÆ∞ÂΩïÊï∞ÈáèÂ∫îÂú®1-20000‰πãÈó¥");
                    else {
                        if (e > 200) {
                            if (
                                !confirm(
                                    `ÊÇ®ÈÄâÊã©‰∫Ü ${e} Êù°Ê∂àÊÅØËøõË°åÊÄªÁªì„ÄÇ\n\nÈ¢Ñ‰º∞Â∞ÜÊ∂àËÄóÁ∫¶ ${(100 * e).toLocaleString()} tokens„ÄÇ\n\nËøôÂèØËÉΩ‰ºö‰∫ßÁîüËæÉÈ´òÁöÑ API Ë¥πÁî®ÔºåÊòØÂê¶ÁªßÁª≠Ôºü`,
                                )
                            )
                                return;
                        }
                        (($y.disabled = !0), ($y.innerHTML = "<span>Ê≠£Âú®ÊÄªÁªì...</span>"));
                        try {
                            var a = await (async function (e, t, n) {
                                var a = Sc.history.slice(-e),
                                    o = a
                                        .map(function (e) {
                                            return (
                                                ("user" === e.sender ? Sc.user.name : Sc.ai.name) +
                                                ": " +
                                                (e.text || "(ÈùûÊñáÊú¨Ê∂àÊÅØ)")
                                            );
                                        })
                                        .join("\n"),
                                    s = n;
                                s = s.includes("{CHAT_HISTORY}")
                                    ? s.replace("{CHAT_HISTORY}", o)
                                    : s + "\n\nËÅäÂ§©ËÆ∞ÂΩï:\n" + o;
                                var i = await Kl.loadData("settingsStore", "apiSettings");
                                if (!i || !i.value.url) throw new Error("APIÊú™ÈÖçÁΩÆ");
                                var r = i.value.url;
                                r.endsWith("/") && (r = r.slice(0, -1));
                                r += "/chat/completions";
                                var l = await fetch(r, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        Authorization: "Bearer " + i.value.key,
                                    },
                                    body: JSON.stringify({
                                        model: t,
                                        messages: [
                                            {
                                                role: "user",
                                                content: s,
                                            },
                                        ],
                                        temperature: 0.8,
                                        max_tokens: 2e4,
                                    }),
                                });
                                if (!l.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•: " + l.status);
                                return (await l.json()).choices[0].message.content.trim();
                            })(e, t, n);
                            a &&
                                (await _y(a, e),
                                    (Sc.lastMemorySummarizedIndex = Sc.history.length),
                                    await tu(),
                                    qy(),
                                    Py("bonds"),
                                    await zy(),
                                    alert("ÊÄªÁªìÂÆåÊàê!"));
                        } catch (e) {
                            (console.error("ÊÄªÁªìÂ§±Ë¥•:", e), alert("ÊÄªÁªìÂ§±Ë¥•: " + e.message));
                        } finally {
                            (($y.disabled = !1),
                                ($y.innerHTML =
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2"/></svg><span>ÂºÄÂßãÊÄªÁªì</span>'));
                        }
                    }
                else alert("ËØ∑ËæìÂÖ•ÊÄªÁªìPrompt");
            else alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã");
        } else alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫");
    }
    async function _y(e, t) {
        var n = {
            id: "memory_" + Date.now(),
            contactId: Sc.id,
            content: e,
            createdAt: new Date().toISOString(),
            summarizedAtIndex: Sc.history.length,
            summarizedMessageCount: t,
            isEnabled: !0,
            editedContent: null,
        },
            a = await Kl.loadData("memoryCheques", Sc.id),
            o = a && a.value ? a.value : [];
        return (o.push(n), await Kl.saveData("memoryCheques", Sc.id, o), n);
    }
    var Fy,
        Ry,
        Gy,
        Wy,
        jy,
        Uy = 1;
    async function zy() {
        if (Sc)
            try {
                var e = await Kl.loadData("memoryCheques", Sc.id),
                    t = e && e.value ? e.value : [],
                    n = document.getElementById("memory-cheque-pagination"),
                    a = document.getElementById("memory-prev-cheque"),
                    o = document.getElementById("memory-next-cheque"),
                    s = document.getElementById("memory-cheque-indicator");
                if (0 === t.length)
                    return (
                        (My.innerHTML =
                            '<div class="memory-empty-state"><svg width="64" height="64" viewBox="0 0 24 24" fill="none"><path opacity="0.4" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="currentColor"/><path d="M12 17C9.24 17 7 14.76 7 12H9C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12H17C17 14.76 14.76 17 12 17Z" fill="currentColor"/></svg><p>ÊöÇÊó†ËÆ∞ÂøÜÊîØÁ•®</p><p class="memory-empty-hint">Âú®ÂõûÊ∫ØÁïåÈù¢ÁîüÊàêÁ¨¨‰∏Ä‰∏™ËÆ∞ÂøÜÂêß~</p></div>'),
                        void (n && (n.style.display = "none"))
                    );
                var i = t.slice().reverse(),
                    r = i.length;
                (Uy > r && (Uy = r), Uy < 1 && (Uy = 1));
                var l = i
                    .map(function (e, t) {
                        var n = new Date(e.createdAt),
                            a =
                                n.getFullYear() +
                                "-" +
                                String(n.getMonth() + 1).padStart(2, "0") +
                                "-" +
                                String(n.getDate()).padStart(2, "0") +
                                " " +
                                String(n.getHours()).padStart(2, "0") +
                                ":" +
                                String(n.getMinutes()).padStart(2, "0"),
                            o = e.editedContent || e.content,
                            s = String(i.length - t).padStart(3, "0"),
                            r = e.isEnabled ? "enabled" : "disabled",
                            l = e.isEnabled ? "Â∑≤ÂêØÁî®" : "Êú™ÂêØÁî®",
                            c = e.isEnabled ? "" : "disabled",
                            d = e.isEnabled
                                ? '<path d="M22 11.08V12a10 10 0 11-5.93-9.14M22 4L12 14.01l-3-3"/>'
                                : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',
                            u = e.isEnabled ? "ÂêØÁî®‰∏≠" : "Â∑≤Á¶ÅÁî®",
                            m = t + 1 === Uy ? "display: block;" : "";
                        return (
                            '<div class="memory-cheque-card" data-cheque-id="' +
                            e.id +
                            '" style="' +
                            m +
                            '"><div class="memory-cheque-header"><span class="memory-cheque-number">ËÆ∞ÂøÜÊîØÁ•® No.' +
                            s +
                            '</span><span class="memory-cheque-date">' +
                            a +
                            '</span></div><div class="memory-cheque-content">' +
                            o +
                            '</div><div class="memory-cheque-footer"><span class="memory-cheque-status ' +
                            r +
                            '"><span class="memory-cheque-status-dot"></span>' +
                            l +
                            '</span></div><div class="memory-cheque-actions"><button class="memory-cheque-btn edit-btn" data-action="edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>ÁºñËæë</button><button class="memory-cheque-btn toggle-btn ' +
                            c +
                            '" data-action="toggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                            d +
                            "</svg>" +
                            u +
                            '</button><button class="memory-cheque-btn delete-btn" data-action="delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Âà†Èô§</button></div></div>'
                        );
                    })
                    .join("");
                ((My.innerHTML = l),
                    n &&
                    ((n.style.display = "flex"),
                        s && (s.textContent = Uy + " / " + r),
                        a && (a.disabled = 1 === Uy),
                        o && (o.disabled = Uy === r)),
                    My.querySelectorAll(".memory-cheque-card").forEach(function (e) {
                        var t = e.dataset.chequeId,
                            n = e.querySelector('[data-action="edit"]'),
                            a = e.querySelector('[data-action="toggle"]'),
                            o = e.querySelector('[data-action="delete"]');
                        (n &&
                            n.addEventListener("click", function () {
                                !(async function (e) {
                                    var t = My.querySelector(
                                        '.memory-cheque-card[data-cheque-id="' + e + '"]',
                                    );
                                    if (t) {
                                        var n = t.querySelector(".memory-cheque-content");
                                        if (n && !n.querySelector("textarea")) {
                                            var a = n.innerText,
                                                o = await Kl.loadData("memoryCheques", Sc.id),
                                                s = o && o.value ? o.value : [],
                                                i = s.find(function (t) {
                                                    return t.id === e;
                                                });
                                            i && (a = i.editedContent || i.content);
                                            var r =
                                                '<textarea class="memory-inline-edit-textarea">' +
                                                a +
                                                '</textarea><div class="memory-inline-edit-actions"><button class="memory-edit-cancel-btn">ÂèñÊ∂à</button><button class="memory-edit-confirm-btn">‰øùÂ≠ò</button></div>';
                                            n.innerHTML = r;
                                            var l = n.querySelector("textarea"),
                                                c = n.querySelector(".memory-edit-cancel-btn"),
                                                d = n.querySelector(".memory-edit-confirm-btn");
                                            (l.focus(),
                                                c.addEventListener("click", function (e) {
                                                    (e.stopPropagation(), (n.textContent = a));
                                                }),
                                                d.addEventListener("click", async function (e) {
                                                    e.stopPropagation();
                                                    var t = l.value.trim();
                                                    t
                                                        ? i &&
                                                        ((i.editedContent = t),
                                                            await Kl.saveData("memoryCheques", Sc.id, s),
                                                            Hy("Â∑≤‰øùÂ≠ò‰øÆÊîπ"),
                                                            (n.textContent = t))
                                                        : Hy("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫");
                                                }));
                                        }
                                    }
                                })(t);
                            }),
                            a &&
                            a.addEventListener("click", function () {
                                !(async function (e) {
                                    var t = await Kl.loadData("memoryCheques", Sc.id),
                                        n = t && t.value ? t.value : [],
                                        a = n.find(function (t) {
                                            return t.id === e;
                                        });
                                    a &&
                                        ((a.isEnabled = !a.isEnabled),
                                            await Kl.saveData("memoryCheques", Sc.id, n),
                                            await zy());
                                })(t);
                            }),
                            o &&
                            o.addEventListener("click", function () {
                                !(async function (e) {
                                    if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËÆ∞ÂøÜÊîØÁ•®Âêó?")) {
                                        var t = await Kl.loadData("memoryCheques", Sc.id),
                                            n = t && t.value ? t.value : [];
                                        ((n = n.filter(function (t) {
                                            return t.id !== e;
                                        })),
                                            await Kl.saveData("memoryCheques", Sc.id, n),
                                            await zy());
                                    }
                                })(t);
                            }));
                    }),
                    (function () {
                        var e = document.getElementById("memory-prev-cheque"),
                            t = document.getElementById("memory-next-cheque");
                        e &&
                            (e.onclick = function () {
                                Uy > 1 && (Uy--, zy());
                            });
                        t &&
                            (t.onclick = function () {
                                Kl.loadData("memoryCheques", Sc.id).then(function (e) {
                                    var t = e && e.value ? e.value : [];
                                    Uy < t.length && (Uy++, zy());
                                });
                            });
                    })());
            } catch (e) {
                console.error("Âä†ËΩΩËÆ∞ÂøÜÊîØÁ•®Â§±Ë¥•:", e);
            }
    }

    function Vy() {
        var e = document.getElementById("peeping-modal");
        if (e) {
            e.classList.remove("active");
            var t = document.getElementById("peeping-timeline");
            t && (t.innerHTML = "");
        }
    }
    async function Jy() {
        var e = document.getElementById("peeping-start-btn");
        if (!e.classList.contains("loading")) {
            e.classList.add("loading");
            try {
                if (!Sc) throw new Error("Êú™ÈÄâÊã©ËÅîÁ≥ª‰∫∫");
                var t = await Kl.loadData("settingsStore", "apiSettings");
                if (!t || !t.value || !t.value.key) throw new Error("ËØ∑ÂÖàÈÖçÁΩÆAPI Key");
                var n = Sc.history
                    .slice(-100)
                    .map(function (e) {
                        return (
                            ("user" === e.sender ? Sc.user.name : Sc.ai.name) +
                            ": " +
                            (e.text || "(ÈùûÊñáÊú¨Ê∂àÊÅØ)")
                        );
                    })
                    .join("\n"),
                    a = Sc.ai.persona || Sc.ai.description || "Êó†ËÆæÂÆö",
                    o = Sc.user.persona || "Êó†ËÆæÂÆö";
                let e = "";
                if ("function" == typeof window.getEnabledMemories)
                    try {
                        const t = await window.getEnabledMemories(Sc.id);
                        if (t && t.length > 0) {
                            e = `\n\n### üß† ÈáçË¶ÅËÆ∞ÂøÜ (Memory Context)\n‰ª•‰∏ãÊòØ‰Ω†‰∏éÁî®Êà∑‰πãÈó¥ÁöÑÈáçË¶ÅËÆ∞ÂøÜÁâáÊÆµ,ËØ∑Âú®ÂõûÂ§çÊó∂ÂèÇËÄÉËøô‰∫õÂÜÖÂÆπ,‰øùÊåÅÂØπËØùÁöÑËøûË¥ØÊÄßÂíå‰∏ÄËá¥ÊÄß:\n\n${t.map((e) => `[ËÆ∞ÂøÜ] ${e.content}`).join("\n")}\n\n---\n`;
                        }
                    } catch (e) {
                        console.error("Âä†ËΩΩËÆ∞ÂøÜÂ§±Ë¥•:", e);
                    }
                let u = `\n‰Ω†ÊòØ‰∏Ä‰∏™ÊûÅÂÖ∑Ê¥ûÂØüÂäõÁöÑÊïÖ‰∫ãÂèôËø∞ËÄÖ„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ãËßíËâ≤ÁöÑËÉåÊôØËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇËÉåÊôØ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØùËÆ∞ÂΩïÔºåÁîüÊàêËØ•ËßíËâ≤ÔºàAIÔºâ‰ªäÂ§©ÁöÑÁîüÊ¥ªË∏™Ëøπ„ÄÇ\nÊàë‰ª¨ÈúÄË¶Å‰ª•Êó∂Èó¥ËΩ¥ÁöÑÂΩ¢ÂºèÔºåÂ±ïÁ§∫ËßíËâ≤Âú®‰ªäÂ§©ÂèëÁîüÁöÑÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅÊâÄÂ§Ñ‰ΩçÁΩÆ„ÄÅÂÜÖÂøÉÊ¥ªÂä®‰ª•ÂèäÊ∂àË¥πÊÉÖÂÜµ„ÄÇ\n\n„ÄêËßíËâ≤ËÆæÂÆö„Äë\nAI‰∫∫ËÆæÔºö${a}\nÁî®Êà∑‰∫∫ËÆæÔºö${o}\n`;
                u += e;
                let m = "";
                try {
                    const e = await Kl.loadData("worldBooks", "allWorldBooks"),
                        t = e && Array.isArray(e.value) ? e.value : [];
                    let n = new Set();
                    if (Sc.linkedWorldBookIds && Sc.linkedWorldBookIds.length > 0)
                        Sc.linkedWorldBookIds.forEach((e) => n.add(e));
                    else if (
                        Sc.linkedWorldBookGroupIds &&
                        Sc.linkedWorldBookGroupIds.length > 0
                    ) {
                        const e = await Kl.loadData("worldBookGroups", "allGroups");
                        if (e && e.value) {
                            e.value
                                .filter((e) => Sc.linkedWorldBookGroupIds.includes(e.id))
                                .forEach((e) => {
                                    (e.books && e.books.forEach((e) => n.add(e)),
                                        e.bookIds && e.bookIds.forEach((e) => n.add(e)));
                                });
                        }
                    }
                    if (n.size > 0) {
                        let e = t
                            .filter((e) => n.has(e.id))
                            .map((e) => `„ÄêËÆæÂÆöÔºö${e.name}„Äë\n${e.content}`)
                            .join("\n\n");
                        (e.length > 2e3 && (e = e.slice(0, 2e3) + "...(Áï•)"), (m = e));
                    }
                } catch (e) {
                    console.warn("‰∏ñÁïå‰π¶Âä†ËΩΩÂ§±Ë¥•:", e);
                }
                var s = `\n‰Ω†ÊòØ‰∏Ä‰∏™ÊûÅÂÖ∑Ê¥ûÂØüÂäõÁöÑÊïÖ‰∫ãÂèôËø∞ËÄÖ„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ãËßíËâ≤ÁöÑËÉåÊôØËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇËÉåÊôØ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØùËÆ∞ÂΩïÔºåÁîüÊàêËØ•ËßíËâ≤ÔºàAIÔºâ‰ªäÂ§©ÁöÑÁîüÊ¥ªË∏™Ëøπ„ÄÇ\nÊàë‰ª¨ÈúÄË¶Å‰ª•Êó∂Èó¥ËΩ¥ÁöÑÂΩ¢ÂºèÔºåÂ±ïÁ§∫ËßíËâ≤Âú®‰ªäÂ§©ÂèëÁîüÁöÑÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅÊâÄÂ§Ñ‰ΩçÁΩÆ„ÄÅÂÜÖÂøÉÊ¥ªÂä®‰ª•ÂèäÊ∂àË¥πÊÉÖÂÜµ„ÄÇ\n\n„ÄêËßíËâ≤ËÆæÂÆö„Äë\nAI‰∫∫ËÆæÔºö${a}\nÁî®Êà∑‰∫∫ËÆæÔºö${o}\n\n„Äê‰∏ñÁïåËßÇËÉåÊôØ„Äë\n${m || "Êó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºåÈªòËÆ§‰∏∫Áé∞‰ª£Êó•Â∏∏„ÄÇ"}\n\n„ÄêÂÖ≥ÈîÆËÆ∞ÂøÜ„Äë\n${e || "Êó†ÁâπÊÆäËÆ∞ÂøÜ„ÄÇ"}\n\n„ÄêÊúÄËøëÂØπËØù„Äë\n${n}\n\n„ÄêÁîüÊàêË¶ÅÊ±Ç„Äë\n1. ÁîüÊàê 4-6 ‰∏™ÂÖ∑‰ΩìÁöÑ‚ÄúË∏™ËøπÂç°Áâá‚ÄùÔºåÊØè‰∏™Âç°Áâá‰ª£Ë°®‰∏Ä‰∏™Êó∂Èó¥ÁÇπ„ÄÇ\n2. ÊØè‰∏™Âç°ÁâáÂåÖÂê´Ôºö\n   - time: Êó∂Èó¥ÁÇπ (Â¶Ç 08:30)\n   - location: Âú∞ÁÇπ (Â¶Ç ÂíñÂï°È¶Ü)\n   - event: ÁÆÄÁü≠ÊèèËø∞ÂèëÁîüÁöÑ‰∫ã‰ª∂ (ÂøÖÈ°ªÁ¨¶Âêà‰∏ñÁïåËßÇÂíå‰∫∫ËÆæ)\n   - spending: Ê∂àË¥πÈáëÈ¢ùÂèäÁâ©ÂìÅ (Â¶ÇÊûúÊ≤°ÊúâÊ∂àË¥πÂ°´ "Êó†")\n   - thought: ËßíËâ≤ÁöÑÂÜÖÂøÉÁã¨ÁôΩ (Á¨¶Âêà‰∫∫ËÆæ)\n   - mood: ÂøÉÊÉÖ emoji\n3. ËØ∑‰∏•Ê†ºËøîÂõûÊúâÊïàÁöÑ JSON Êï∞ÁªÑÂ≠óÁ¨¶‰∏≤Ôºå‰∏çË¶ÅÂåÖÂê´‰ªª‰Ωï markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇÊ†ºÂºèÂ¶Ç‰∏ãÔºö\n[{"time":"09:00","location":"ÂçßÂÆ§","event":"ÈÜíÊù•...","spending":"Êó†","thought":"...","mood":"‚òÄÔ∏è"}]\\n\\n„ÄêÈáçË¶ÅÊó∂Èó¥Á∫¶Êùü„Äë\\nÂΩìÂâçÁé∞ÂÆûÊó∂Èó¥ÊòØ ` + new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }) + `„ÄÇ\\nÊâÄÊúâÁîüÊàêÁöÑËΩ®ËøπÊó∂Èó¥ÔºàtimeÂ≠óÊÆµÔºâÂøÖÈ°ªÂ∞è‰∫éÊàñÁ≠â‰∫éÂΩìÂâçÊó∂Èó¥ÔºÅ\\n‰æãÂ¶ÇÔºöÂ¶ÇÊûúÁé∞Âú®ÊòØ 14:30Ôºå‰Ω†Âè™ËÉΩÁîüÊàê 00:00 Âà∞ 14:30 ‰πãÈó¥ÁöÑÊó∂Èó¥ÁÇπ„ÄÇ\\nÁªùÂØπ‰∏çËÉΩÁîüÊàêÊú™Êù•ÁöÑ‰∫ã‰ª∂‚Äî‚ÄîAIËßíËâ≤‰∏çÂèØËÉΩÈ¢ÑÁü•Êú™Êù•ÔºÅ\\n`,
                    i = t.value.url;
                (i.endsWith("/") && (i = i.slice(0, -1)), (i += "/chat/completions"));
                var r = t.value.model || "gpt-3.5-turbo",
                    l = await fetch(i, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer " + t.value.key,
                        },
                        body: JSON.stringify({
                            model: r,
                            messages: [
                                {
                                    role: "user",
                                    content: s,
                                },
                            ],
                            temperature: 0.85,
                        }),
                    });
                if (!l.ok) throw new Error("API Request Failed: " + l.status);
                var c,
                    d = (await l.json()).choices[0].message.content.trim();
                d = d
                    .replace(/^```json/, "")
                    .replace(/^```/, "")
                    .replace(/```$/, "")
                    .trim();
                try {
                    c = JSON.parse(d);
                } catch (e) {
                    throw (
                        console.error("JSON Error", d),
                        new Error("ÁîüÊàêÂÜÖÂÆπÊ†ºÂºèÊúâËØØÔºåËØ∑ÈáçËØï")
                    );
                }
                // ËøáÊª§ÊéâË∂ÖËøáÂΩìÂâçÊó∂Èó¥ÁöÑ‰∫ã‰ª∂
                var now = new Date();
                var nowMinutes = now.getHours() * 60 + now.getMinutes();
                c = c.filter(function (evt) {
                    if (!evt.time) return true;
                    var timeParts = evt.time.match(/(\d{1,2}):(\d{2})/);
                    if (!timeParts) return true;
                    var evtMinutes = parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
                    return evtMinutes <= nowMinutes;
                });
                // Â¶ÇÊûúÊâÄÊúâ‰∫ã‰ª∂ÈÉΩË¢´ËøáÊª§‰∫ÜÔºåËá≥Â∞ë‰øùÁïô‰∏Ä‰∏™
                if (c.length === 0 && JSON.parse(d).length > 0) {
                    c = [JSON.parse(d)[0]];
                }
                // ‰øùÂ≠òÂà∞ÁºìÂ≠ò
                if (Sc && Kl) {
                    try {
                        await Kl.saveData("peepingCache", Sc.id, c);
                        console.log("[Peeping] Êï∞ÊçÆÂ∑≤ÁºìÂ≠ò");
                    } catch (err) {
                        console.error("[Peeping] ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:", err);
                    }
                }
                Xy_renderPeepingTimeline(c);
            } catch (e) {
                (console.error(e), alert("ÁîüÊàêÂ§±Ë¥•: " + e.message));
            } finally {
                e.classList.remove("loading");
            }
        }
    }
    // Áã¨Á´ãÁöÑÊ∏≤ÊüìÂáΩÊï∞ÔºåÁî®‰∫éÁºìÂ≠òÊï∞ÊçÆÂ§çÁî®
    function Xy_renderPeepingTimeline(e) {
        var t = document.getElementById("peeping-timeline");
        if (((t.innerHTML = ""), !Array.isArray(e)))
            return void alert("Êï∞ÊçÆÊ†ºÂºèÈîôËØØ");
        var n = {
            location:
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
            spending:
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
            thought:
                '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
        };
        (e.forEach(function (e, a) {
            var o = document.createElement("div");
            ((o.className = "peeping-card"),
                (o.style.animationDelay = 0.15 * a + "s"));
            var s =
                e.spending && "Êó†" !== e.spending
                    ? `<div class="peeping-spending">${n.spending} <span>${e.spending}</span></div>`
                    : "";
            ((o.innerHTML = `\n                <div class="peeping-card-header">\n                    <div class="peeping-location">${n.location} <span>${e.location}</span></div>\n                    <div class="peeping-time">${e.time}</div>\n                </div>\n                <div class="peeping-card-body">\n                    ${e.event}\n                </div>\n                ${s}\n                <div class="peeping-inner-thought">\n                    <div class="peeping-thought-icon">${n.thought}</div>\n                    <div class="peeping-thought-text">"${e.thought}" ${e.mood || ""}</div>\n                </div>\n            `),
                t.appendChild(o));
        }),
            (document.querySelector(".peeping-intro").style.display = "none"),
            (t.style.display = "flex"));
    }
    ((window.getEnabledMemories = async function (e) {
        var t = await Kl.loadData("memoryCheques", e);
        return (t && t.value ? t.value : []).filter(function (e) {
            return e.isEnabled;
        });
    }),
        (window.getEnabledMemoriesText = async function (e) {
            try {
                const t = await window.getEnabledMemories(e);
                return t && 0 !== t.length
                    ? t.map((e) => `[ÈáçË¶ÅËÆ∞ÂøÜ] ${e.content}`).join("\n")
                    : "";
            } catch (e) {
                return (console.error("Ëé∑ÂèñËÆ∞ÂøÜÊñáÊú¨Â§±Ë¥•:", e), "");
            }
        }),
        Cy && (Cy.value = Ty),
        hy && hy.addEventListener("click", Ay),
        fy && fy.addEventListener("click", Dy),
        wy && wy.addEventListener("click", Dy),
        by.forEach(function (e) {
            e.addEventListener("click", function () {
                Py(e.dataset.tab);
            });
        }),
        $y && $y.addEventListener("click", Ny),
        (Fy = document.getElementById("peeping-feature")),
        (Ry = document.getElementById("peeping-modal")),
        (Gy = Ry ? Ry.querySelector(".peeping-close-btn") : null),
        (Wy = document.getElementById("peeping-start-btn")),
        (jy = Ry ? Ry.querySelector(".peeping-overlay") : null),
        Fy &&
        Fy.addEventListener("click", async function () {
            var e = document.getElementById("peeping-modal");
            if (e) {
                e.classList.remove("hidden");
                e.offsetWidth;
                e.classList.add("active");
                // ‰ºòÂÖàÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
                if (Sc && Kl) {
                    try {
                        var cachedData = await Kl.loadData("peepingCache", Sc.id);
                        if (cachedData && cachedData.value && Array.isArray(cachedData.value) && cachedData.value.length > 0) {
                            console.log("[Peeping] ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÊ∏≤Êüì");
                            Xy_renderPeepingTimeline(cachedData.value);
                            return;
                        }
                    } catch (err) {
                        console.error("[Peeping] Âä†ËΩΩÁºìÂ≠òÂ§±Ë¥•:", err);
                    }
                }
                // Êó†ÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ intro ÁïåÈù¢
                document.querySelector(".peeping-intro").style.display = "flex";
                var t = document.getElementById("peeping-timeline");
                t.style.display = "none";
                t.innerHTML = "";
            }
        }),
        Gy && Gy.addEventListener("click", Vy),
        jy && jy.addEventListener("click", Vy),
        Wy && Wy.addEventListener("click", Jy));
    const Yy = document.getElementById("minimax-group-id"),
        Ky = document.getElementById("minimax-api-key"),
        Zy = document.getElementById("minimax-model-select"),
        Xy = document.getElementById("fetch-minimax-models-btn"),
        Qy = document.getElementById("fetch-models-status"),
        eh = document.getElementById("test-tts-button"),
        th = document.getElementById("tts-test-status");
    let nh = null,
        ah = null;
    async function oh() {
        if (!Kl || !Kl.db) {
            console.warn("[MiniMax] Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñÔºåÁ≠âÂæÖÂàùÂßãÂåñ...");
            const e = 5e3,
                t = 100;
            let n = 0;
            for (; (!Kl || !Kl.db) && n < e;)
                (await new Promise((e) => setTimeout(e, t)), (n += t));
            if (!Kl || !Kl.db) throw new Error("Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñÔºàË∂ÖÊó∂Ôºâ");
            console.log("[MiniMax] Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂÆåÊàêÔºåÁªßÁª≠‰øùÂ≠òÈÖçÁΩÆ");
        }
        const e = {
            groupId: Yy?.value || "",
            apiKey: Ky?.value || "",
            modelId: Zy?.value || "speech-2.6-turbo",
        };
        (await Kl.saveData("settingsStore", "minimaxTTSConfig", e),
            console.log("[MiniMax] ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò", e));
    }
    const sh = {
        dbName: "MinimaxTTSCache",
        storeName: "audio_cache",
        _db: null,
        async getDB() {
            return this._db
                ? this._db
                : new Promise((e, t) => {
                    const n = indexedDB.open(this.dbName, 1);
                    ((n.onupgradeneeded = (e) => {
                        const t = e.target.result;
                        t.objectStoreNames.contains(this.storeName) ||
                            t.createObjectStore(this.storeName);
                    }),
                        (n.onsuccess = (t) => {
                            ((this._db = t.target.result), e(this._db));
                        }),
                        (n.onerror = (e) => t(e.target.error)));
                });
        },
        async get(e) {
            try {
                const t = await this.getDB();
                return new Promise((n, a) => {
                    const o = t
                        .transaction(this.storeName, "readonly")
                        .objectStore(this.storeName)
                        .get(e);
                    ((o.onsuccess = () => n(o.result)), (o.onerror = () => a(o.error)));
                });
            } catch (e) {
                return null;
            }
        },
        async put(e, t) {
            try {
                const n = await this.getDB();
                return new Promise((a, o) => {
                    const s = n.transaction(this.storeName, "readwrite");
                    (s.objectStore(this.storeName).put(t, e),
                        (s.oncomplete = () => a()),
                        (s.onerror = () => o()));
                });
            } catch (e) { }
        },
        genKey(e, t, n) {
            let a = 0;
            if (!e) return "empty";
            for (let t = 0; t < e.length; t++)
                ((a = (a << 5) - a + e.charCodeAt(t)), (a |= 0));
            return `${t || "def"}_${n || "auto"}_${e.substring(0, 20).replace(/[^\w\u4e00-\u9fa5]/g, "_")}_${a}`;
        },
        async clear() {
            try {
                const e = await this.getDB();
                return new Promise((t, n) => {
                    const a = e.transaction(this.storeName, "readwrite");
                    (a.objectStore(this.storeName).clear(),
                        (a.oncomplete = () => {
                            (console.log("[TTSCache] ÁºìÂ≠òÂ∑≤Ê∏ÖÁ©∫"), t());
                        }),
                        (a.onerror = () => n()));
                });
            } catch (e) {
                console.warn("[TTSCache] Ê∏ÖÁ©∫Â§±Ë¥•", e);
            }
        },
        async cleanup(e = 10) {
            try {
                const t = await this.getDB(),
                    n = t
                        .transaction(this.storeName, "readwrite")
                        .objectStore(this.storeName),
                    a = await new Promise((e, t) => {
                        const a = n.getAllKeys();
                        ((a.onsuccess = () => e(a.result)), (a.onerror = () => t(a.error)));
                    });
                if (a.length > e) {
                    const t = a.slice(0, a.length - e);
                    for (const e of t) n.delete(e);
                    console.log(`[TTSCache] Ê∏ÖÁêÜ‰∫Ü ${t.length} Êù°ÊóßÁºìÂ≠ò`);
                }
            } catch (e) {
                console.warn("[TTSCache] Ê∏ÖÁêÜÂ§±Ë¥•", e);
            }
        },
    };
    async function ih(e, t, n) {
        try {
            if (!e) return !1;
            ((e = e.trim().replace(/[\r\n]+/g, " ")),
                nh && (nh.pause(), (nh = null)),
                ah && (URL.revokeObjectURL(ah), (ah = null)));
            const a = sh.genKey(e, t, n);
            let o,
                s = await sh.get(a);
            if (
                (!!s
                    ? console.log("[Minimax TTS] üöÄ ÂëΩ‰∏≠ÁºìÂ≠òÔºåÁúÅÈí±‰∫ÜÔºÅ")
                    : (console.log("[Minimax TTS] üí® Êú™ÂëΩ‰∏≠ÁºìÂ≠òÔºåË∞ÉÁî®API..."),
                        (s = await (async function (e, t, n) {
                            if ((e && (e = e.trim().replace(/[\r\n]+/g, " ")), !Kl || !Kl.db))
                                throw new Error("Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñ");
                            const a = await Kl.loadData("settingsStore", "minimaxTTSConfig");
                            if (!(a && a.value && a.value.groupId && a.value.apiKey))
                                throw new Error("MiniMaxÈÖçÁΩÆÊú™ÂÆåÊàê");
                            const { groupId: o, apiKey: s, modelId: i } = a.value;
                            let r = i || "speech-2.6-turbo";
                            const l = r.includes("speech-01"),
                                c = l ? "t2a_pro" : "t2a_v2",
                                d = `https://api.minimax.chat/v1/${c}?GroupId=${o}`;
                            let u;
                            if (
                                (console.log(`[Minimax] ‰ΩøÁî®Êé•Âè£: ${c} (Ê®°Âûã: ${r})`),
                                    "speech-01" === r && (r = "speech-01-turbo"),
                                    "speech-02" === r && (r = "speech-02-turbo"),
                                    "speech-2.6" === r && (r = "speech-2.6-turbo"),
                                    l)
                            )
                                u = {
                                    model: r,
                                    text: e,
                                    voice_id: t || "female-shaonv",
                                    speed: 1,
                                    vol: 1,
                                    pitch: 0,
                                    audio_sample_rate: 32e3,
                                    bitrate: 128e3,
                                    format: "mp3",
                                };
                            else {
                                const a = {
                                    "zh-CN": "Chinese",
                                    "zh-HK": "Chinese,Yue",
                                    "en-US": "English",
                                    "ja-JP": "Japanese",
                                    "ko-KR": "Korean",
                                    "de-DE": "German",
                                    "fr-FR": "French",
                                    "es-ES": "Spanish",
                                    "pt-BR": "Portuguese",
                                    "ru-RU": "Russian",
                                    "tr-TR": "Turkish",
                                    "nl-NL": "Dutch",
                                    "it-IT": "Italian",
                                    "vi-VN": "Vietnamese",
                                    "id-ID": "Indonesian",
                                    "th-TH": "Thai",
                                    "ms-MY": "Malay",
                                    "ar-SA": "Arabic",
                                    "hi-IN": "Hindi",
                                    "pl-PL": "Polish",
                                    "sv-SE": "Swedish",
                                    "fi-FI": "Finnish",
                                    "da-DK": "Danish",
                                };
                                u = {
                                    model: r,
                                    text: e,
                                    stream: !1,
                                    language_boost: n && a[n] ? a[n] : "auto",
                                    voice_setting: {
                                        voice_id: t || "female-shaonv",
                                        speed: 1,
                                        vol: 1,
                                        pitch: 0,
                                    },
                                    audio_setting: {
                                        format: "mp3",
                                        sample_rate: 32e3,
                                        bitrate: 128e3,
                                        channel: 1,
                                    },
                                };
                            }
                            const m = {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${s}`,
                                },
                                body: JSON.stringify(u),
                            },
                                p = await fetch(d, m);
                            if (!p.ok) {
                                const e = await p.text();
                                throw new Error(`TTS APIËØ∑Ê±ÇÂ§±Ë¥•: ${p.status} - ${e}`);
                            }
                            const g = await p.json();
                            if (
                                (console.log("[MiniMax TTS] APIÂìçÂ∫îÊï∞ÊçÆ:", g),
                                    g.base_resp && 0 !== g.base_resp.status_code)
                            )
                                throw new Error(
                                    `MiniMax APIÈîôËØØ: [${g.base_resp.status_code}] ${g.base_resp.status_msg}`,
                                );
                            let y = null;
                            if (
                                (g.data && g.data.audio
                                    ? (y = g.data.audio)
                                    : g.audio_file
                                        ? (y = g.audio_file)
                                        : g.extra_info &&
                                        g.extra_info.audio_file &&
                                        (y = g.extra_info.audio_file),
                                    !y)
                            )
                                throw new Error(
                                    "APIËøîÂõûÊ≠£Â∏∏‰ΩÜÊú™ÊâæÂà∞Èü≥È¢ëÊï∞ÊçÆ(audio/audio_file)",
                                );
                            if (/^[0-9a-fA-F]+$/.test(y))
                                try {
                                    const e = y.match(/.{1,2}/g);
                                    if (e) {
                                        const t = new Uint8Array(e.map((e) => parseInt(e, 16)));
                                        let n = "";
                                        const a = t.byteLength;
                                        for (let e = 0; e < a; e++) n += String.fromCharCode(t[e]);
                                        return window.btoa(n);
                                    }
                                } catch (e) {
                                    console.warn(
                                        "[MiniMax TTS] HexËΩ¨Êç¢Â§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•‰Ωú‰∏∫Base64‰ΩøÁî®",
                                        e,
                                    );
                                }
                            return y;
                        })(e, t, n)),
                        s &&
                        sh.put(a, s).catch((e) => console.warn("Cache put failed", e))),
                    !s)
            )
                return !1;
            if ("string" == typeof s && s.startsWith("http")) ((o = s), (ah = null));
            else {
                const e = sg(s, "audio/mpeg");
                ((o = URL.createObjectURL(e)), (ah = o));
            }
            return (
                (nh = new Audio(o)),
                nh.play().catch((e) => console.error("Audio play error:", e)),
                (nh.onended = () => {
                    (ah && (URL.revokeObjectURL(ah), (ah = null)), (nh = null));
                }),
                !0
            );
        } catch (e) {
            throw (console.error("[MiniMax TTS] Êí≠ÊîæÂ§±Ë¥•", e), e);
        }
    }

    function sg(e, t) {
        const n = atob(e),
            a = new Array(n.length);
        for (let e = 0; e < n.length; e++) a[e] = n.charCodeAt(e);
        const o = new Uint8Array(a);
        return new Blob([o], {
            type: t,
        });
    }
    ((window.TTSCache = sh),
        Xy &&
        Xy.addEventListener("click", async () => {
            if (Yy.value && Ky.value) {
                ((Qy.textContent = "Âä†ËΩΩ‰∏≠..."), (Qy.style.color = "#007aff"));
                try {
                    await oh();
                    const e = await (async function () {
                        if (!Kl || !Kl.db)
                            throw new Error("Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñÔºåËØ∑ÂÖàÈÖçÁΩÆMiniMax");
                        const e = await Kl.loadData("settingsStore", "minimaxTTSConfig");
                        if (!(e && e.value && e.value.groupId && e.value.apiKey))
                            throw new Error("MiniMaxÈÖçÁΩÆÊú™ÂÆåÊàê");
                        const { groupId: t, apiKey: n } = e.value;
                        return (
                            console.log("[MiniMax] ‰ΩøÁî®ÈÖçÁΩÆ:", {
                                groupId: t.substring(0, 10) + "...",
                                apiKey: "***",
                            }),
                            [
                                {
                                    id: "speech-2.6-hd",
                                    name: "Speech-2.6 HD (The Best)",
                                },
                                {
                                    id: "speech-2.6-turbo",
                                    name: "Speech-2.6 Turbo (Fastest)",
                                },
                                {
                                    id: "speech-02-hd",
                                    name: "Speech-02 HD (High Quality)",
                                },
                                {
                                    id: "speech-02-turbo",
                                    name: "Speech-02 Turbo (Balanced)",
                                },
                                {
                                    id: "speech-01-hd",
                                    name: "Speech-01 HD (Legacy)",
                                },
                                {
                                    id: "speech-01-turbo",
                                    name: "Speech-01 Turbo (Legacy)",
                                },
                            ]
                        );
                    })();
                    ((Zy.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ê®°Âûã</option>'),
                        e.forEach((e) => {
                            const t = document.createElement("option");
                            ((t.value = e.id),
                                (t.textContent = e.name || e.id),
                                Zy.appendChild(t));
                        }),
                        await oh(),
                        (Qy.textContent = "‚úì ÊàêÂäü"),
                        (Qy.style.color = "#34c759"),
                        setTimeout(() => {
                            Qy.textContent = "";
                        }, 3e3));
                } catch (e) {
                    ((Qy.textContent = "‚úó Â§±Ë¥•"),
                        (Qy.style.color = "#ff3b30"),
                        alert("ÊãâÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•: " + e.message),
                        setTimeout(() => {
                            Qy.textContent = "";
                        }, 3e3));
                }
            } else alert("ËØ∑ÂÖàÂ°´ÂÜô MiniMax Group ID Âíå API Key");
        }),
        eh &&
        eh.addEventListener("click", async () => {
            if (Yy.value && Ky.value) {
                ((th.textContent = "ÊµãËØï‰∏≠..."), (th.style.color = "#007aff"));
                try {
                    (await oh(),
                        await ih("‰πùÔºåË°¨Ë°´ÁöÑ‰ª∑Ê†ºÊòØÔºå‰πùÁ£ÖÂçÅ‰∫î‰æøÂ£´„ÄÇ", "female-shaonv"),
                        (th.textContent = "‚úì ÊàêÂäü"),
                        (th.style.color = "#34c759"),
                        setTimeout(() => {
                            th.textContent = "";
                        }, 3e3));
                } catch (e) {
                    ((th.textContent = "‚úó Â§±Ë¥•"),
                        (th.style.color = "#ff3b30"),
                        alert("ÊµãËØïÂ§±Ë¥•: " + e.message),
                        setTimeout(() => {
                            th.textContent = "";
                        }, 3e3));
                }
            } else alert("ËØ∑ÂÖàÂ°´ÂÜô MiniMax Group ID Âíå API Key");
        }),
        Zy &&
        Zy.addEventListener("change", async () => {
            try {
                (await oh(), console.log("[MiniMax] Ê®°ÂûãÂ∑≤ÂàáÊç¢Âπ∂‰øùÂ≠ò:", Zy.value));
            } catch (e) {
                console.error("[MiniMax] ‰øùÂ≠òÊ®°ÂûãÈÄâÊã©Â§±Ë¥•:", e);
            }
        }),
        Yy &&
        Yy.addEventListener("blur", async () => {
            try {
                (await oh(), console.log("[MiniMax] GroupID Â∑≤‰øùÂ≠ò"));
            } catch (e) {
                console.error("[MiniMax] ‰øùÂ≠ò GroupID Â§±Ë¥•:", e);
            }
        }),
        Ky &&
        Ky.addEventListener("blur", async () => {
            try {
                (await oh(), console.log("[MiniMax] API Key Â∑≤‰øùÂ≠ò"));
            } catch (e) {
                console.error("[MiniMax] ‰øùÂ≠ò API Key Â§±Ë¥•:", e);
            }
        }));
    const rh = document.getElementById("save-all-settings-btn");
    (rh &&
        rh.addEventListener("click", async () => {
            await oh();
        }),
        setTimeout(async () => {
            try {
                Kl && Kl.db
                    ? await (async function () {
                        if (Kl && Kl.db)
                            try {
                                const e = await Kl.loadData(
                                    "settingsStore",
                                    "minimaxTTSConfig",
                                );
                                e &&
                                    e.value &&
                                    (Yy && (Yy.value = e.value.groupId || ""),
                                        Ky && (Ky.value = e.value.apiKey || ""),
                                        Zy && (Zy.value = e.value.modelId || "speech-2.6-turbo"),
                                        console.log(
                                            "[MiniMax] Â∑≤Âä†ËΩΩÈÖçÁΩÆÔºåÂΩìÂâçÊ®°Âûã:",
                                            e.value.modelId || "speech-2.6-turbo",
                                        ));
                            } catch (e) {
                                console.error("[MiniMax] Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•", e);
                            }
                        else console.warn("[MiniMax] Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñ");
                    })()
                    : debugWarn("[MiniMax] Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáÈÖçÁΩÆÂä†ËΩΩ");
            } catch (e) {
                console.error("[MiniMax] Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•", e);
            }
        }, 500));
    const lh = document.getElementById("chat-settings-modal");
    if (lh) {
        let iv = lh.querySelector("#tts-voice-setting-group");
        if (!iv) {
            const rv = lh.querySelector(".modal-body");
            if (rv) {
                ((iv = document.createElement("div")),
                    (iv.id = "tts-voice-setting-group"),
                    (iv.className = "form-group"),
                    (iv.innerHTML =
                        '\n                    <label>TTS Èü≥Ëâ≤ID (MiniMax)</label>\n                    <input type="text" id="contact-tts-voice-input" class="form-input" placeholder="‰æãÂ¶Ç: female-shaonv">\n                    <small style="color: #666; margin-top: 5px; display: block;">\n                        ÁïôÁ©∫Âàô‰∏ç‰ΩøÁî®ËØ≠Èü≥ÂêàÊàê„ÄÇÂ∏∏Áî®Èü≥Ëâ≤IDÔºö<br>\n                        female-shaonv (Â∞ëÂ•≥), female-yujie (Âæ°Âßê), male-qn-jingying (Á≤æËã±ÈùíÂπ¥)\n                    </small>\n                '),
                    rv.appendChild(iv));
                const lv = iv.querySelector("#contact-tts-voice-input");
                lv &&
                    (lv.addEventListener("input", () => {
                        Sc && (Sc.ttsVoiceId = lv.value.trim());
                    }),
                        lv.addEventListener("blur", async () => {
                            if (!Sc) return;
                            const e = lv.value.trim();
                            try {
                                const t = await Kl.loadData("messageContacts", "allContacts");
                                let n = t && Array.isArray(t.value) ? t.value : [];
                                const a = n.findIndex((e) => e.id === Sc.id);
                                -1 !== a &&
                                    ((n[a].ttsVoiceId = e),
                                        await Kl.saveData("messageContacts", "allContacts", n),
                                        console.log("[MiniMax] Èü≥Ëâ≤IDÂ∑≤Âº∫Âà∂‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì:", e));
                            } catch (e) {
                                console.error("[MiniMax] Èü≥Ëâ≤ID‰øùÂ≠òÂ§±Ë¥•:", e);
                            }
                        }));
            }
        }
        window._ttsSettingsObserver ||
            ((window._ttsSettingsObserver = new MutationObserver((e) => {
                if (
                    lh &&
                    "none" !== lh.style.display &&
                    !lh.classList.contains("hidden") &&
                    window.currentOpenContact
                ) {
                    const e = document.getElementById("contact-tts-voice-input");
                    e &&
                        e.value !== window.currentOpenContact.ttsVoiceId &&
                        (e.value = window.currentOpenContact.ttsVoiceId || "");
                }
            })),
                window.chatSettingsModalTTS &&
                window._ttsSettingsObserver.observe(lh, {
                    attributes: !0,
                    attributeFilter: ["style", "class"],
                }));
    }
    if (document.getElementById("save-contact-btn")) {
        const cv = window.saveContact || function () { };
        window.saveContact = async function () {
            const e = document.getElementById("contact-tts-voice-input");
            (e && Sc && (Sc.ttsVoiceId = e.value.trim()), await cv());
        };
    }
    const ch = window.loadContactSettings || function () { };
    ((window.loadContactSettings = function (e) {
        (ch(e),
            voiceInput && e && (voiceInput.value = e.ttsVoiceId || ""),
            "function" == typeof window.applyChatBackground &&
            window.applyChatBackground(e.backgroundImage));
    }),
        document.body.addEventListener(
            "click",
            async (e) => {
                const t = e.target.closest(
                    '[data-action="play-tts"], .voice-play-button, .play-voice-btn, .voice-audio-bubble, .clickable-voice-bubble',
                );
                if (!t) return;
                if (
                    e.target.isContentEditable ||
                    e.target.closest('[contenteditable="true"]')
                )
                    return;
                if (e.target.closest(".voice-collapse-btn")) return;
                if (e.target.closest(".msg-action-menu, .action-button, .menu-item"))
                    return;
                const n = Date.now();
                if (n - (t._lastTTSClickTime || 0) < 300) return;
                t._lastTTSClickTime = n;
                const a = t.closest(".message-row");
                if (!a) return void console.warn("[TTS Click] Êú™ÊâæÂà∞ messageRow");
                let o = "",
                    s =
                        a.querySelector(".voice-transcript") ||
                        a.querySelector(".voice-text-panel");
                if (!s) {
                    let e = t.nextElementSibling;
                    if (
                        (e &&
                            (e.classList.contains("voice-transcript") ||
                                e.classList.contains("voice-text-panel")) &&
                            (s = e),
                            !s)
                    ) {
                        const n = t.parentElement;
                        n &&
                            ((e = n.nextElementSibling),
                                e &&
                                (e.classList.contains("voice-transcript") ||
                                    e.classList.contains("voice-text-panel")) &&
                                (s = e));
                    }
                }

                function i(e, t) {
                    const n = document.createElement("button");
                    ((n.className = "voice-collapse-btn"), (n.innerHTML = "‚ñ≤"));
                    const a = t ? "left: 3px;" : "right: 3px;";
                    return (
                        (n.style.cssText = `\n                    position: absolute;\n                    top: 2px;\n                    ${a}\n                    background: rgba(239, 239, 239, 0.8);\n                    border: none;\n                    border-radius: 4px;\n                    width: 20px;\n                    height: 20px;\n                    cursor: pointer;\n                    font-size: 10px;\n                    line-height: 1;\n                    color: #333;\n                    transition: all 0.2s;\n                    z-index: 10;\n                `),
                        n.addEventListener("click", function (t) {
                            (t.stopPropagation(),
                                (e.style.cssText = "display: none !important;"),
                                e.classList.remove("visible", "fade-in"),
                                n.remove());
                        }),
                        n.addEventListener("mouseenter", function () {
                            ((n.style.background = "rgba(0, 0, 0, 0.2)"),
                                (n.style.color = "#333"));
                        }),
                        n.addEventListener("mouseleave", function () {
                            ((n.style.background = "rgba(0, 0, 0, 0.1)"),
                                (n.style.color = "#666"));
                        }),
                        n
                    );
                }
                if (t.classList.contains("user-bubble")) {
                    if (s && !s.querySelector(".voice-collapse-btn")) {
                        const e = s.closest(".voice-message-wrapper");
                        (e &&
                            ((e.style.display = "flex"),
                                (e.style.flexDirection = "column"),
                                (e.style.alignItems = "flex-end"),
                                (e.style.gap = "4px")),
                            (s.style.cssText =
                                "display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 8px 8px 26px !important; background: rgba(0, 0, 0, 0.05) !important; border-radius: 8px !important;"),
                            s.classList.add("visible", "fade-in"));
                        const t = i(s, !0);
                        s.appendChild(t);
                    }
                    return;
                }
                if (s) {
                    const e = s.querySelector(".voice-collapse-btn"),
                        t = s.closest(".voice-message-wrapper");
                    if (
                        (t &&
                            ((t.style.display = "flex"),
                                (t.style.flexDirection = "column"),
                                (t.style.alignItems = "flex-start"),
                                (t.style.gap = "4px")),
                            (s.style.cssText =
                                "display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 26px 8px 8px !important; background: rgba(0, 0, 0, 0.05) !important;backdrop-filter:blur(10px); border-radius: 8px !important;"),
                            s.classList.add("visible", "fade-in"),
                            !e)
                    ) {
                        const e = i(s, !1);
                        s.appendChild(e);
                    }
                    o = s.innerText?.trim();
                }
                if (!o) return void console.warn("[MiniMax TTS] Êó†Ê≥ïËé∑ÂèñÊ∂àÊÅØÊñáÊú¨");
                if (!Kl || !Kl.db)
                    return void console.warn("[MiniMax TTS] Êï∞ÊçÆÂ∫ìÊú™ÂàùÂßãÂåñ");
                const r = await Kl.loadData("settingsStore", "minimaxTTSConfig").catch(
                    (e) => null,
                );
                if (!(r && r.value && r.value.groupId && r.value.apiKey))
                    return void console.warn("[MiniMax TTS] Êú™ÈÖçÁΩÆÔºåË∑≥ËøáÊí≠Êîæ");
                const l = Sc?.ttsVoiceId || "female-shaonv",
                    c = Sc?.ttsLanguage;
                console.log("[MiniMax TTS] ‰ΩøÁî®Èü≥Ëâ≤:", l, "ËØ≠Ë®Ä:", c);
                try {
                    ((t.style.opacity = "0.5"),
                        await ih(o, l, c),
                        (t.style.opacity = "1"));
                } catch (e) {
                    ((t.style.opacity = "1"),
                        console.error("[MiniMax TTS] Êí≠ÊîæÂ§±Ë¥•", e),
                        alert("Êí≠ÊîæÂá∫Èîô: " + e.message));
                }
            },
            !0,
        ));
    document.getElementById("chat-bg-input");
    const dh = document.getElementById("chat-bg-preview"),
        uh = document.getElementById("chat-bg-placeholder");
    (document.getElementById("clear-chat-bg-btn"),
        document.querySelector(".group-background-section .avatar-uploader"));

    function mh(e) {
        e
            ? ((dh.src = e),
                (dh.style.display = "block"),
                (uh.style.display = "none"))
            : ((dh.src = ""),
                (dh.style.display = "none"),
                (uh.style.display = "flex"));
    }
    ((window.applyChatBackground = function (e) {
        const t = document.getElementById("chat-messages-container");
        e
            ? ((t.style.backgroundImage = `url('${e}')`),
                (t.style.backgroundSize = "cover"),
                (t.style.backgroundPosition = "center"),
                (t.style.backgroundRepeat = "no-repeat"))
            : (t.style.backgroundImage = "");
    }),
        (window.loadChatBackgroundSettings = function () {
            let e = null;
            (void 0 !== Je && Je
                ? (e = Je.chatBackground || Je.backgroundImage)
                : void 0 !== Sc && Sc && (e = Sc.chatBackground || Sc.backgroundImage),
                mh(e));
        }));
    var ph = {
        pages: [],
        currentPage: 0,
        styles: [],
        activeStyleId: null,
        isGenerating: !1,
    },
        gh = document.getElementById("meetu-feature"),
        yh = document.getElementById("meetu-screen"),
        hh = document.getElementById("meetu-back-button"),
        vh = document.getElementById("meetu-active-page"),
        fh = document.getElementById("meetu-prev-page"),
        wh = document.getElementById("meetu-next-page"),
        bh = document.getElementById("meetu-page-indicator"),
        Eh = document.getElementById("meetu-reroll-btn"),
        Ih = document.getElementById("meetu-continue-btn"),
        xh = document.getElementById("meetu-export-btn"),
        kh = document.getElementById("meetu-style-btn"),
        Lh =
            (document.getElementById("meetu-book-animation"),
                document.getElementById("meetu-style-modal")),
        Bh = document.getElementById("meetu-style-close-btn"),
        Sh = document.getElementById("meetu-add-style-btn"),
        Ch = document.getElementById("meetu-style-list"),
        $h = document.getElementById("meetu-style-editor-modal"),
        Mh = document.getElementById("meetu-editor-close-btn"),
        Th = document.getElementById("meetu-style-name"),
        Ah = document.getElementById("meetu-style-prompt"),
        Dh = document.getElementById("meetu-save-style-btn"),
        Ph = null,
        Hh = document.getElementById("meetu-continue-modal"),
        Oh = document.getElementById("meetu-continue-input"),
        qh = document.getElementById("meetu-continue-close-btn"),
        Nh = document.getElementById("meetu-confirm-continue-btn"),
        _h = {
            id: "default_style",
            name: "ÈªòËÆ§Á¨îÈ£é",
            desc: "Á¨¨‰∏â‰∫∫Áß∞ÔºåÁ¨îËß¶ÁªÜËÖªÔºå‰æßÈáçÂøÉÁêÜÊèèÂÜô",
            prompt:
                "ËØ∑‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞Ôºå‰ª•ÁªÜËÖª‰ºòÁæéÁöÑÁ¨îËß¶ËøõË°åÊèèÂÜô„ÄÇÈáçÁÇπÂàªÁîªËßíËâ≤ÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÅÂæÆË°®ÊÉÖÂíåÁéØÂ¢ÉÊ∞õÂõ¥„ÄÇÈÅøÂÖçËøá‰∫éÁõ¥ÁôΩÁöÑÂØπËØùÂ†ÜÁ†åÔºåÂ§öÁî®‰æßÈù¢ÊèèÂÜô„ÄÇ",
            isDefault: !0,
        };
    async function Fh() {
        if ((console.log("[Meetu] openMeetu called"), !Sc))
            return void Hy("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫");
        const e = "meetu_progress_" + Sc.id,
            t = localStorage.getItem(e);
        let n = !1;
        if (t)
            try {
                const a = JSON.parse(t);
                a.pages &&
                    a.pages.length > 0 &&
                    ((n = confirm(
                        "Ê£ÄÊµãÂà∞‰∏äÊ¨°Êú™ÂÆåÊàêÁöÑÊô§Èù¢ÂÜÖÂÆπÔºà" +
                        a.pages.length +
                        "È°µÔºâÔºåÊòØÂê¶ÁªßÁª≠Ôºü\n\nÁÇπÂáª„ÄåÁ°ÆÂÆö„ÄçÁªßÁª≠‰∏äÊ¨°ÁöÑÂÜÖÂÆπ\nÁÇπÂáª„ÄåÂèñÊ∂à„ÄçÂºÄÂßãÂÖ®Êñ∞ÁöÑÊô§Èù¢",
                    )),
                        n
                            ? ((ph.pages = a.pages),
                                (ph.currentPage = a.currentPage || a.pages.length - 1),
                                console.log(
                                    "[Meetu] Restored saved progress:",
                                    a.pages.length,
                                    "pages",
                                ))
                            : localStorage.removeItem(e));
            } catch (t) {
                (console.error("[Meetu] Failed to parse saved progress:", t),
                    localStorage.removeItem(e));
            }
        (yh
            ? ((yh.style.position = "fixed"),
                (yh.style.top = "0"),
                (yh.style.left = "0"),
                (yh.style.width = "100%"),
                (yh.style.height = "100%"),
                (yh.style.zIndex = "9999"),
                (yh.style.display = "flex"),
                (yh.style.visibility = "visible"),
                (yh.style.opacity = "1"),
                (yh.style.backgroundColor = "#f4ecd8"),
                yh.classList.add("visible"),
                console.log("[Meetu] Screen forced visible with inline styles"))
            : console.error("[Meetu] Screen element missing!"),
            n
                ? (Jh(), Hy("Â∑≤ÊÅ¢Â§ç‰∏äÊ¨°ÁöÑÊô§Èù¢ÂÜÖÂÆπ"))
                : ((ph.pages = []), (ph.currentPage = 0), Jh(), Vh("new")));
    }

    function Rh() {
        if (ph.pages.length > 0) {
            const e = prompt(
                "ËØ∑ÈÄâÊã©ÈÄÄÂá∫ÊñπÂºèÔºö\n\n1 - ‰∏≠ÈÄîÈÄÄÂá∫Ôºà‰øùÁïôËøõÂ∫¶Ôºå‰∏ãÊ¨°ÁªßÁª≠Ôºâ\n2 - ÂÆåÂÖ®ÈÄÄÂá∫Âπ∂ÊÄªÁªì‰∏∫ËÆ∞ÂøÜÊîØÁ•®\n3 - ÂÆåÂÖ®ÈÄÄÂá∫‰∏ç‰øùÂ≠ò\n\nËØ∑ËæìÂÖ•Êï∞Â≠ó 1„ÄÅ2 Êàñ 3Ôºö",
                "1",
            ),
                t = "meetu_progress_" + (Sc ? Sc.id : "unknown");
            if ("1" === e)
                try {
                    (localStorage.setItem(
                        t,
                        JSON.stringify({
                            pages: ph.pages,
                            currentPage: ph.currentPage,
                            savedAt: new Date().toISOString(),
                        }),
                    ),
                        Hy("ËøõÂ∫¶Â∑≤‰øùÂ≠òÔºå‰∏ãÊ¨°ÂèØÁªßÁª≠"),
                        console.log("[Meetu] Progress saved:", ph.pages.length, "pages"));
                } catch (e) {
                    (console.error("[Meetu] Failed to save progress:", e),
                        Hy("‰øùÂ≠òËøõÂ∫¶Â§±Ë¥•"));
                }
            else if ("2" === e)
                (!(async function () {
                    var e = ph.pages.join("\n");
                    Hy("Ê≠£Âú®ÂêéÂè∞ÊÄªÁªìËÆ∞ÂøÜ...");
                    try {
                        var t =
                            (await Kl.loadData("settingsStore", "apiSettings")).value
                                .model || "gpt-3.5-turbo",
                            n =
                                "ËØ∑ÊÄªÁªì‰ª•‰∏ãÊàë‰ª¨Âú®Á∫ø‰∏ãÁöÑ‰∫íÂä®ÂÜÖÂÆπÔºåÊèêÂèñÂÖ≥ÈîÆ‰∫ã‰ª∂ÂíåÊÉÖÊÑüÂèòÂåñÔºåÁÆÄË¶ÅÊ¶ÇÊã¨Ôºö\n{CHAT_HISTORY}",
                            a = await (async function (e, t, n) {
                                var a = n.replace("{CHAT_HISTORY}", e),
                                    o = await Kl.loadData("settingsStore", "apiSettings"),
                                    s = o.value.url;
                                s.endsWith("/") && (s = s.slice(0, -1));
                                s += "/chat/completions";
                                var i = await fetch(s, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        Authorization: "Bearer " + o.value.key,
                                    },
                                    body: JSON.stringify({
                                        model: t,
                                        messages: [
                                            {
                                                role: "user",
                                                content: a,
                                            },
                                        ],
                                        temperature: 0.8,
                                    }),
                                });
                                return (await i.json()).choices[0].message.content.trim();
                            })(e, t, n);
                        if (
                            a &&
                            (await _y("„ÄêÊô§Èù¢ÊÄªÁªì„Äë" + a, 1),
                                Hy("Â∑≤ÁîüÊàêËÆ∞ÂøÜÊîØÁ•®"),
                                window.currentOpenContact)
                        ) {
                            const e = "pending_meetu_summary_" + window.currentOpenContact.id;
                            (localStorage.setItem(e, a),
                                console.log(
                                    "[Meetu] Saved pending summary for next chat turn:",
                                    e,
                                ));
                        }
                    } catch (e) {
                        (console.error(e), Hy("ËÆ∞ÂøÜÊÄªÁªìÂ§±Ë¥•"));
                    }
                })(),
                    localStorage.removeItem(t),
                    (ph.pages = []),
                    (ph.currentPage = 0));
            else if ("3" === e)
                (localStorage.removeItem(t), (ph.pages = []), (ph.currentPage = 0));
            else {
                null !== e && Hy("Êó†ÊïàËæìÂÖ•ÔºåÂ∑≤ÈªòËÆ§‰øùÂ≠òËøõÂ∫¶");
                try {
                    localStorage.setItem(
                        t,
                        JSON.stringify({
                            pages: ph.pages,
                            currentPage: ph.currentPage,
                            savedAt: new Date().toISOString(),
                        }),
                    );
                } catch (e) {
                    console.error("[Meetu] Save failed:", e);
                }
            }
        }
        (yh &&
            ((yh.style.cssText = ""),
                (yh.style.display = "none"),
                yh.classList.remove("visible")),
            void 0 !== vh && vh && (vh.innerHTML = ""));
    }
    const Gh = "meetuStyles_backup";
    async function Wh(e) {
        var t = e || ph.styles;
        console.log("[Meetu] Saving styles...", t.length);
        try {
            localStorage.setItem(Gh, JSON.stringify(t));
        } catch (e) {
            console.error("[Meetu] LS Save failed", e);
        }
        try {
            await Kl.saveData("settingsStore", "meetuStyles", t);
        } catch (e) {
            console.error("[Meetu] DB Save failed", e);
        }
    }

    function jh() {
        ((Ch.innerHTML = ""),
            ph.styles.forEach(function (e) {
                var t = document.createElement("div");
                t.className = "playlist-item";
                var n = document.createElement("div");
                ((n.className = "style-card-content"),
                    (n.innerHTML =
                        '<div class="style-card-title">' +
                        e.name +
                        '</div><div class="style-card-desc">' +
                        (e.desc || "Êó†ÊèèËø∞") +
                        "</div>"));
                var a = document.createElement("div");
                a.className = "card-actions";
                if (!e.isDefault) {
                    var o = document.createElement("button");
                    ((o.className = "action-circle edit-btn"),
                        (o.innerHTML =
                            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>'),
                        (o.onclick = function (t) {
                            (t.stopPropagation(), Uh(e));
                        }),
                        a.appendChild(o));
                    var s = document.createElement("button");
                    ((s.className = "action-circle delete-btn"),
                        (s.innerHTML =
                            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>'),
                        (s.onclick = function (t) {
                            (t.stopPropagation(),
                                (function (e) {
                                    if (!confirm("Á°ÆÂÆöÂà†Èô§Ê≠§Á¨îÈ£é?")) return;
                                    ((ph.styles = ph.styles.filter(function (t) {
                                        return t.id !== e;
                                    })),
                                        Wh(),
                                        jh());
                                })(e.id));
                        }),
                        a.appendChild(s));
                }
                var i = document.createElement("button");
                ((i.className =
                    "action-circle toggle-btn " + (e.active ? "active" : "")),
                    (i.innerHTML =
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'),
                    (i.onclick = function (t) {
                        (t.stopPropagation(),
                            (function (e, t) {
                                console.log("[DEBUG_MEETU] Toggling style:", e, "to", t);
                                var n = ph.styles.find(function (t) {
                                    return t.id === e;
                                });
                                n
                                    ? ((n.active = t), jh(), Wh())
                                    : console.error(
                                        "[DEBUG_MEETU] Style not found for toggle:",
                                        e,
                                    );
                            })(e.id, !e.active));
                    }),
                    a.appendChild(i),
                    t.appendChild(n),
                    t.appendChild(a),
                    Ch.appendChild(t));
            }));
    }

    function Uh(e) {
        ((Ph = (e = e || null) ? e.id : null),
            (Th.value = e ? e.name : ""),
            (Ah.value = e ? e.prompt : ""),
            (document.getElementById("meetu-editor-title").textContent = e
                ? "ÁºñËæëÁ¨îÈ£é"
                : "Êñ∞Âª∫Á¨îÈ£é"),
            document.body.appendChild($h),
            ($h.style.zIndex = "2147483647"),
            ($h.style.display = "flex"),
            $h.offsetWidth,
            ($h.style.opacity = "1"),
            $h.classList.add("visible"),
            $h.classList.add("active"));
    }
    async function zh() {
        var e = Th.value.trim(),
            t = Ah.value.trim();
        if (e && t) {
            if (Ph) {
                var n = ph.styles.find(function (e) {
                    return e.id === Ph;
                });
                n &&
                    ((n.name = e), (n.prompt = t), (n.desc = t.substring(0, 20) + "..."));
            } else
                ph.styles.push({
                    id: "style_" + Date.now(),
                    name: e,
                    prompt: t,
                    desc: t.substring(0, 20) + "...",
                    active: !1,
                    isDefault: !1,
                });
            (console.log("[DEBUG_MEETU] Saving new/edited style chain", ph.styles),
                await Wh(ph.styles),
                ($h.style.display = "none"),
                $h.classList.remove("visible"),
                $h.classList.remove("active"),
                jh());
        } else Hy("ËØ∑Â°´ÂÜôÂÆåÊï¥");
    }
    async function Vh(e, t) {
        if (!ph.isGenerating) {
            ((ph.isGenerating = !0),
                vh &&
                ((vh.textContent =
                    "Ê≠£Âú®‰æùÁÖß" + ("reroll" === e ? "ÂΩìÂâç" : "Êñ∞ÁöÑ") + "ÊÄùË∑ØÊûÑÊÄù‰∏≠..."),
                    (vh.style.opacity = 0.5)));
            try {
                var n = await (async function () {
                    var e = Sc.history
                        .slice(-50)
                        .map(function (e) {
                            return (
                                ("user" === e.sender ? Sc.user.name : Sc.ai.name) +
                                ": " +
                                e.text
                            );
                        })
                        .join("\n"),
                        t = `ÂßìÂêç: ${Sc.ai.name || "Êú™ËÆæÂÆö"}\n‰∫∫ËÆæ: ${Sc.ai.persona || Sc.ai.description || "Êó†"}`,
                        n = `ÂßìÂêç: ${Sc.user.name || "Áî®Êà∑"}\n‰∫∫ËÆæ: ${Sc.user.persona || "ÔºàÁî®Êà∑Êú™ËÆæÂÆö‰∫∫ËÆæÔºâ"}`,
                        a = "";
                    try {
                        let e = new Set();
                        if (Sc.linkedWorldBookIds && Sc.linkedWorldBookIds.length > 0)
                            Sc.linkedWorldBookIds.forEach(function (t) {
                                e.add(t);
                            });
                        else if (
                            Sc.linkedWorldBookGroupIds &&
                            Sc.linkedWorldBookGroupIds.length > 0 &&
                            window.dbHelper
                        ) {
                            var o = await window.dbHelper.loadData(
                                "worldBookGroups",
                                "allGroups",
                            ),
                                s = o && o.value ? o.value : [],
                                i = new Set(Sc.linkedWorldBookGroupIds);
                            s.forEach(function (t) {
                                i.has(t.id) &&
                                    Array.isArray(t.bookIds) &&
                                    t.bookIds.forEach(function (t) {
                                        e.add(t);
                                    });
                            });
                        }
                        if (e.size > 0 && window.dbHelper) {
                            var r = await window.dbHelper.loadData(
                                "worldBooks",
                                "allWorldBooks",
                            );
                            a = (r && r.value ? r.value : [])
                                .filter(function (t) {
                                    return e.has(t.id);
                                })
                                .map(function (e) {
                                    return e.content || e.text || "";
                                })
                                .join("\n\n");
                        }
                        (a && a.trim()) ||
                            !Sc.worldBook ||
                            (Array.isArray(Sc.worldBook) &&
                                (a = Sc.worldBook
                                    .map(function (e) {
                                        return e.content || "";
                                    })
                                    .join("\n")));
                    } catch (e) {
                        console.error("[Meetu] WorldBook loading error:", e);
                    }
                    (a && a.trim()) || (a = "Êó†");
                    var l = [];
                    window.getEnabledMemories &&
                        (l = await window.getEnabledMemories(Sc.id));
                    var c = l
                        .map(function (e) {
                            return "[ËÆ∞ÂøÜ] " + e.content;
                        })
                        .join("\n"),
                        d = ph.styles.filter(function (e) {
                            return e.active;
                        });
                    return {
                        history: e,
                        aiPersona: t,
                        userPersona: n,
                        memoryText: c,
                        worldInfo: a,
                        style: {
                            prompt:
                                d.length > 0
                                    ? d
                                        .map(function (e) {
                                            return "„Äê" + e.name + "„Äë: " + e.prompt;
                                        })
                                        .join("\n\n")
                                    : "(Êú™ÂêØÁî®ÁâπÂÆöÁ¨îÈ£éÔºåËØ∑Ëá™Áî±ÂèëÊå•)",
                        },
                    };
                })(),
                    a = await Kl.loadData("settingsStore", "apiSettings");
                if (!a || !a.value || !a.value.key)
                    throw new Error("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI Key");
                var o = `‰Ω†ÊòØ‰∏Ä‰ΩçÊûÅÂÖ∂Âá∫Ëâ≤ÁöÑ‰ΩúÂÆ∂„ÄÇËØ∑Ê†πÊçÆ‰ª•‰∏ã‰ø°ÊÅØÔºåÂàõ‰Ωú‰∏ÄÊÆµ"Á∫ø‰∏ãËßÅÈù¢"ÁöÑ‰∫íÂä®Â∞èËØ¥ÊèèÂÜô„ÄÇ\n\n„ÄêËßíËâ≤‰ø°ÊÅØ„Äë\nAI: ${n.aiPersona}\nÁî®Êà∑: ${n.userPersona}\n\n„Äê‰∏ñÁïåËßÇËÆæÂÆö„Äë\n${n.worldInfo}\n\n„ÄêÈáçË¶ÅËÆ∞ÂøÜ„Äë\n${n.memoryText}\n\n„ÄêËøëÊúüÂâçÊÉÖÊèêË¶Å„Äë\n${n.history}\n\n„ÄêÊñáÈ£éË¶ÅÊ±Ç - ÂøÖÈ°ª‰∏•Ê†ºÊâßË°å„Äë\n${n.style.prompt}\n\n„Äê‰ªªÂä°Êåá‰ª§„Äë\n${"continue" === e ? "Êé•Áª≠‰∏äÊñáÔºàÂèÇËÄÉÂ∑≤ÊúâÂÜÖÂÆπÔºâÔºåÁªßÁª≠ÊèèÂÜôÂêéÁª≠ÂèëÂ±ï„ÄÇ" : "ÂºÄÂêØ‰∏ÄÊÆµÊñ∞ÁöÑÁ∫ø‰∏ã‰∫íÂä®ÊèèÂÜôÔºåÊàñÈáçÂÜôÂΩìÂâçÊÆµËêΩ„ÄÇ"}\nÊèèÂÜôÂ∫îÂÖ∑ÊúâÁîªÈù¢ÊÑü„ÄÅÊ≤âÊµ∏ÊÑüÔºåÂ≠óÊï∞ÊéßÂà∂Âú®200-400Â≠óÂ∑¶Âè≥„ÄÇÁ∫ØÊñáÊú¨ËæìÂá∫Ôºå‰∏çË¶ÅÂåÖÂê´MarkdownÊ†áËÆ∞„ÄÇ\n`;
                (t &&
                    t.trim() &&
                    (o += `\n\n„ÄêÁî®Êà∑ÁöÑÊÉ≥Ê≥ï - ÈáçÁÇπÂèÇËÄÉÔºåÂøÖÈ°ªÂèÇËÄÉ„Äë\n${t.trim()}`),
                    "continue" === e &&
                    ph.pages.length > 0 &&
                    (o += `\n„Äê‰∏äÊñáÂÜÖÂÆπ„Äë\n${ph.pages[ph.pages.length - 1].substring(0, 500)}...`));
                var s = a.value.url;
                (s.endsWith("/") && (s = s.slice(0, -1)), (s += "/chat/completions"));
                var i = await fetch(s, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + a.value.key,
                    },
                    body: JSON.stringify({
                        model: a.value.model || "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "user",
                                content: o,
                            },
                        ],
                        temperature: 0.85,
                        max_tokens: a.value.max_tokens || a.value.maxTokens || 8e4,
                    }),
                }),
                    r = await i.json();
                if (!r.choices) throw new Error("APIËøîÂõûÊ†ºÂºèÈîôËØØ");
                var l = r.choices[0].message.content.trim();
                ("reroll" === e && ph.pages.length > 0
                    ? (ph.pages[ph.pages.length - 1] = l)
                    : ph.pages.push(l),
                    (ph.currentPage = ph.pages.length - 1),
                    Jh());
            } catch (e) {
                (console.error(e),
                    vh &&
                    (vh.textContent = "ÁÅµÊÑüÊûØÁ´≠‰∫Ü... (ÁîüÊàêÂ§±Ë¥•: " + e.message + ")"));
            } finally {
                ((ph.isGenerating = !1), vh && (vh.style.opacity = 1));
            }
        }
    }

    function Jh() {
        if (vh) {
            if (0 === ph.pages.length)
                return ((vh.textContent = ""), void (bh.textContent = "0 / 0"));
            ((vh.style.opacity = 0),
                setTimeout(function () {
                    var e = ph.pages[ph.currentPage];
                    ((vh.innerText = e), (vh.style.opacity = 1));
                }, 200),
                (bh.textContent = ph.currentPage + 1 + " / " + ph.pages.length),
                fh && (fh.disabled = 0 === ph.currentPage),
                wh && (wh.disabled = ph.currentPage === ph.pages.length - 1));
        }
    }

    function Yh(e) {
        var t = ph.currentPage + e;
        t >= 0 && t < ph.pages.length && ((ph.currentPage = t), Jh());
    }

    function Kh() {
        var e = ph.pages.join("\n\n ================= \n\n");
        if (e) {
            var t = new Blob([e], {
                type: "text/plain",
            }),
                n = URL.createObjectURL(t),
                a = document.createElement("a");
            ((a.href = n),
                (a.download =
                    "Êô§Èù¢ËÆ∞ÂΩï_" + new Date().toISOString().slice(0, 10) + ".txt"),
                a.click(),
                URL.revokeObjectURL(n),
                Hy("Â∑≤ÂØºÂá∫"));
        } else Hy("Ê≤°ÊúâÂÜÖÂÆπÂèØÂØºÂá∫");
    }
    (console.log("[Meetu] Starting initialization..."),
        (async function () {
            (console.log("[Meetu] Initializing UI...", {
                btn: !!gh,
            }),
                console.log("[DEBUG_MEETU] Checking elements existence:", {
                    meetuStyleBtn: !!kh,
                    meetuContinueBtn: !!Ih,
                    meetuStyleModal: !!Lh,
                    meetuContinueModal: !!Hh,
                    meetuScreen: !!yh,
                }),
                gh && gh.addEventListener("click", Fh),
                hh && hh.addEventListener("click", Rh),
                fh &&
                fh.addEventListener("click", function () {
                    Yh(-1);
                }),
                wh &&
                wh.addEventListener("click", function () {
                    Yh(1);
                }),
                Eh &&
                Eh.addEventListener("click", function () {
                    Vh("reroll");
                }),
                Ih &&
                (console.log(
                    "[DEBUG_MEETU] Binding click listener to meetuContinueBtn",
                ),
                    Ih.addEventListener("click", function (e) {
                        (console.log("[DEBUG_MEETU] meetuContinueBtn CLICKED. Event:", e),
                            e.stopPropagation(),
                            Hh
                                ? ((Oh.value = ""),
                                    document.body.appendChild(Hh),
                                    (Hh.style.zIndex = "2147483647"),
                                    (Hh.style.display = "flex"),
                                    Hh.offsetWidth,
                                    (Hh.style.opacity = "1"),
                                    Hh.classList.add("visible"),
                                    Hh.classList.add("active"),
                                    Oh.focus())
                                : Vh("continue"));
                    })),
                qh &&
                qh.addEventListener("click", function () {
                    (Hh.classList.remove("visible"),
                        Hh.classList.remove("active"),
                        (Hh.style.display = "none"));
                }),
                Nh &&
                Nh.addEventListener("click", function () {
                    var e = Oh.value.trim();
                    ((Hh.style.display = "none"), Vh("continue", e));
                }),
                xh && xh.addEventListener("click", Kh),
                kh &&
                (console.log("[DEBUG_MEETU] Binding click listener to meetuStyleBtn"),
                    kh.addEventListener("click", function (e) {
                        (console.log("[DEBUG_MEETU] meetuStyleBtn CLICKED. Event:", e),
                            e.stopPropagation(),
                            (function () {
                                if (
                                    (console.log("[DEBUG_MEETU] openStyleModal executing..."),
                                        jh(),
                                        !Lh)
                                )
                                    return (
                                        console.error(
                                            "[DEBUG_MEETU] FATAL: meetuStyleModal is NULL!",
                                        ),
                                        void alert("Error: Style Modal element missing")
                                    );
                                (document.body.appendChild(Lh),
                                    (Lh.style.zIndex = "2147483647"),
                                    (Lh.style.display = "flex"),
                                    Lh.offsetWidth,
                                    (Lh.style.opacity = "1"),
                                    Lh.classList.add("visible"),
                                    Lh.classList.add("active"),
                                    console.log(
                                        "[DEBUG_MEETU] Modal moved to body. Z-Index maxed.",
                                    ));
                            })());
                    })),
                Bh &&
                Bh.addEventListener("click", function () {
                    (Lh.classList.remove("visible"),
                        Lh.classList.remove("active"),
                        (Lh.style.display = "none"));
                }),
                Sh &&
                Sh.addEventListener("click", function () {
                    Uh();
                }),
                Mh &&
                Mh.addEventListener("click", function () {
                    ($h.classList.remove("visible"),
                        $h.classList.remove("active"),
                        ($h.style.display = "none"));
                }),
                Dh && Dh.addEventListener("click", zh));
            let e = 0;
            for (; (!window.dbHelper || !window.dbHelper.db) && e < 50;)
                (await new Promise((e) => setTimeout(e, 200)), e++);
            window.dbHelper &&
                window.dbHelper.db &&
                (await (async function () {
                    try {
                        console.log("[Meetu] Loading styles...");
                        var e = null;
                        try {
                            var t = await Kl.loadData("settingsStore", "meetuStyles");
                            t &&
                                t.value &&
                                Array.isArray(t.value) &&
                                t.value.length > 0 &&
                                ((e = t.value),
                                    console.log("[Meetu] Loaded from DB:", e.length));
                        } catch (e) {
                            console.warn("[Meetu] DB Load failed, trying LocalStorage...", e);
                        }
                        if (!e) {
                            var n = localStorage.getItem(Gh);
                            if (n)
                                try {
                                    var a = JSON.parse(n);
                                    Array.isArray(a) &&
                                        a.length > 0 &&
                                        ((e = a),
                                            console.log("[Meetu] Loaded from LocalStorage:", e.length),
                                            Wh(e));
                                } catch (e) {
                                    console.error("LS config parse error", e);
                                }
                        }
                        (e ||
                            (console.log("[Meetu] No styles found, using default."),
                                (e = [_h])),
                            (ph.styles = e),
                            ph.styles.forEach(function (e) {
                                void 0 === e.active && (e.active = !1);
                            }));
                    } catch (e) {
                        (console.error("[Meetu] Critical Load failed:", e),
                            (ph.styles = [_h]));
                    }
                })());
        })()
            .then(() => {
                console.log("[Meetu] Initialization done");
                try {
                    const e = JSON.parse(
                        localStorage.getItem("offlineLifeConfig") || "{}",
                    );
                    e.enabled &&
                        "busy" === e.currentStatus &&
                        Date.now() > (e.statusEndTime || 0) &&
                        (console.log(
                            "[OfflineLife] Wakeup condition met. Triggering AI return...",
                        ),
                            (e.currentStatus = "idle"),
                            localStorage.setItem("offlineLifeConfig", JSON.stringify(e)),
                            setTimeout(() => {
                                if (window.currentOpenContact) {
                                    const t = `[System: You were busy doing "${e.lastReason || "Áî±‰∫éÊüê‰∫õÂéüÂõ†"}" and now you are back. Please greet the user naturally and tell them you are back. Do NOT output any system tags.]`;
                                    (console.log("[OfflineLife] Sending wakeup prompt to AI..."),
                                        generateAIResponse(
                                            window.currentOpenContact,
                                            t,
                                            "WAKEUP_" + Date.now(),
                                        ));
                                }
                            }, 2e3));
                } catch (e) {
                    console.warn("[OfflineLife] Auto-wakeup failed:", e);
                }
            })
            .catch((e) => console.error("[Meetu] Init failed", e)));
}),
    document.addEventListener("DOMContentLoaded", () => {
        const e = document.getElementById("anecdotes-feature"),
            t = document.getElementById("anecdotes-modal"),
            n = document.getElementById("anecdotes-close-btn"),
            a = document.getElementById("anecdotes-box"),
            o = document.getElementById("anecdotes-letter"),
            s =
                (document.getElementById("anecdotes-pen-btn"),
                    document.getElementById("anecdotes-input")),
            i = document.getElementById("anecdotes-confirm-btn"),
            r = document.getElementById("anecdotes-again-btn"),
            l = document.getElementById("anecdotes-hint"),
            c = document.getElementById("letter-input-view"),
            d = document.getElementById("letter-response-view"),
            u = document.getElementById("letter-loading-view"),
            m = document.getElementById("anecdotes-response-content"),
            p = document.getElementById("anecdotes-signature"),
            g = document.getElementById("anecdotes-collection-btn"),
            y = document.getElementById("anecdotes-collection-modal"),
            h = document.getElementById("collection-list"),
            v = document.getElementById("collection-close-btn"),
            f = document.getElementById("anecdotes-remail-btn");
        let w = "";
        if (!(e && t && a && s && i))
            return void console.warn(
                "[Anecdotes] Ê†∏ÂøÉÂÖÉÁ¥†Êú™ÊâæÂà∞ (Box/Input/Btn Missing)ÔºåË∑≥ËøáÂàùÂßãÂåñ",
            );

        function b(e) {
            if (!e) return "";

            function t(e) {
                const t = document.createElement("div");
                return ((t.textContent = e), t.innerHTML);
            }
            let n = e;
            ((n = n.replace(/```(\w+)?\n([\s\S]*?)```/g, (e, n, a) => {
                const o = t(a.trim());
                return `<pre class="letter-code-block"${n ? ` data-lang="${t(n)}"` : ""}><code>${o}</code></pre>`;
            })),
                (n = n.replace(
                    /`([^`]+)`/g,
                    '<code class="letter-inline-code">$1</code>',
                )),
                (n = n.replace(/^######\s+(.+)$/gm, '<h6 class="letter-h6">$1</h6>')),
                (n = n.replace(/^#####\s+(.+)$/gm, '<h5 class="letter-h5">$1</h5>')),
                (n = n.replace(/^####\s+(.+)$/gm, '<h4 class="letter-h4">$1</h4>')),
                (n = n.replace(/^###\s+(.+)$/gm, '<h3 class="letter-h3">$1</h3>')),
                (n = n.replace(/^##\s+(.+)$/gm, '<h2 class="letter-h2">$1</h2>')),
                (n = n.replace(/^#\s+(.+)$/gm, '<h1 class="letter-h1">$1</h1>')),
                (n = n.replace(
                    /~~(.+?)~~/g,
                    '<del class="letter-strikethrough">$1</del>',
                )),
                (n = n.replace(
                    /\*\*([^\*]+?)\*\*/g,
                    '<strong class="letter-bold">$1</strong>',
                )),
                (n = n.replace(
                    /__([^_]+?)__/g,
                    '<strong class="letter-bold">$1</strong>',
                )),
                (n = n.replace(
                    /(?<!\*)\*(?!\*)([^\*]+?)\*(?!\*)/g,
                    '<em class="letter-italic">$1</em>',
                )),
                (n = n.replace(
                    /(?<!_)_(?!_)([^_]+?)_(?!_)/g,
                    '<em class="letter-italic">$1</em>',
                )),
                (n = n.replace(/^---$/gm, '<hr class="letter-hr">')),
                (n = n.replace(/^\*\*\*$/gm, '<hr class="letter-hr">')),
                (n = n.replace(/^[\-\*]\s+(.+)$/gm, '<li class="letter-li">$1</li>')),
                (n = n.replace(
                    /(<li class="letter-li">.*<\/li>\n?)+/g,
                    (e) => `<ul class="letter-ul">${e}</ul>`,
                )),
                (n = n.replace(
                    /^\d+\.\s+(.+)$/gm,
                    '<li class="letter-li-ordered">$1</li>',
                )),
                (n = n.replace(
                    /(<li class="letter-li-ordered">.*<\/li>\n?)+/g,
                    (e) => `<ol class="letter-ol">${e}</ol>`,
                )),
                (n = n.replace(
                    /^>\s+(.+)$/gm,
                    '<blockquote class="letter-blockquote">$1</blockquote>',
                )),
                (n = n.replace(
                    /(<blockquote class="letter-blockquote">.*<\/blockquote>\n?)+/g,
                    (e) =>
                        `<blockquote class="letter-blockquote">${e.replace(/<\/?blockquote[^>]*>/g, "").trim()}</blockquote>`,
                )),
                (n = n.replace(
                    /\[([^\]]+)\]\(([^)]+)\)/g,
                    '<a href="$2" class="letter-link" target="_blank" rel="noopener noreferrer">$1</a>',
                )),
                (n = n.replace(
                    /!\[([^\]]*)\]\(([^)]+)\)/g,
                    '<img src="$2" alt="$1" class="letter-image" loading="lazy">',
                )));
            const a = n.split("\n");
            let o = !1,
                s = [];
            for (let e = 0; e < a.length; e++) {
                const t = a[e].trim();
                t.startsWith("<") &&
                    (t.includes("<h") ||
                        t.includes("<ul") ||
                        t.includes("<ol") ||
                        t.includes("<li") ||
                        t.includes("<blockquote") ||
                        t.includes("<pre") ||
                        t.includes("<hr") ||
                        t.includes("</h") ||
                        t.includes("</ul") ||
                        t.includes("</ol") ||
                        t.includes("</blockquote") ||
                        t.includes("</pre"))
                    ? (o && (s.push("</p>"), (o = !1)), s.push(t))
                    : "" === t
                        ? (o && (s.push("</p>"), (o = !1)), s.push(""))
                        : (o || (s.push('<p class="letter-paragraph">'), (o = !0)),
                            s.push(t));
            }
            return (
                o && s.push("</p>"),
                (n = s.join("\n")),
                (n = n.replace(/\n{3,}/g, "\n\n")),
                n.trim()
            );
        }
        console.log("[Anecdotes] Markdown Ê∏≤ÊüìÂô®Â∑≤Âä†ËΩΩ");
        let E = !1,
            I = !1;

        function x() {
            ((E = !1),
                (I = !1),
                a.classList.remove("opened", "thinking"),
                o.classList.remove("visible"),
                (c.style.display = "block"),
                (d.style.display = "none"),
                (u.style.display = "none"),
                (s.value = ""),
                l.classList.remove("hidden"),
                (l.textContent = "ËΩªÂêØ‰ø°Â∞ÅÔºå‰π¶ÂÜôÊ≠§ÂàªÂøÉÁª™"));
        }
        async function k(e, t) {
            try {
                const n = await window.dbHelper.loadData(
                    "settingsStore",
                    "anecdotesCollection",
                );
                let a = n && Array.isArray(n.value) ? n.value : [];
                const o = window.currentOpenContact
                    ? window.currentOpenContact.id
                    : null,
                    s = {
                        id: "anecdote_" + Date.now(),
                        date: new Date().toLocaleString(),
                        timestamp: Date.now(),
                        content: e,
                        aiName: t,
                        contactId: o,
                        summary: e.slice(0, 50).replace(/\n/g, " ") + "...",
                    };
                (a.unshift(s),
                    await window.dbHelper.saveData(
                        "settingsStore",
                        "anecdotesCollection",
                        a,
                    ),
                    console.log(
                        "[Anecdotes] Saved to collection:",
                        s.id,
                        "for contact:",
                        o,
                    ));
            } catch (e) {
                console.error("[Anecdotes] Save failed:", e);
            }
        }
        async function L() {
            if (h)
                try {
                    h.innerHTML =
                        '<div style="text-align:center;color:#999;padding:20px;">Âä†ËΩΩ‰∏≠...</div>';
                    const e = await window.dbHelper.loadData(
                        "settingsStore",
                        "anecdotesCollection",
                    );
                    let t = e && Array.isArray(e.value) ? e.value : [];
                    console.log("[Anecdotes] Total items in database:", t.length);
                    const n = window.currentOpenContact
                        ? window.currentOpenContact.id
                        : null,
                        a = window.currentOpenContact
                            ? window.currentOpenContact.ai.name
                            : null;
                    let o = t;
                    if (
                        (n
                            ? ((o = t.filter((e) => {
                                if (e.contactId) {
                                    const t = e.contactId === n;
                                    return (
                                        console.log(
                                            `[Anecdotes] Item ${e.id}: contactId=${e.contactId}, match=${t}`,
                                        ),
                                        t
                                    );
                                }
                                {
                                    const t = e.aiName === a;
                                    return (
                                        console.log(
                                            `[Anecdotes] Item ${e.id}: aiName=${e.aiName}, match=${t} (legacy)`,
                                        ),
                                        t
                                    );
                                }
                            })),
                                console.log(
                                    `[Anecdotes] Filtered ${o.length}/${t.length} items for contact:`,
                                    n,
                                    a,
                                ))
                            : console.log(
                                `[Anecdotes] No current contact, showing all ${o.length} items`,
                            ),
                            0 === o.length)
                    ) {
                        const e = n
                            ? `<div style="text-align:center;color:#ccc;padding:40px;">ÊöÇÊó†ÁèçËóè...<br>ÂéªÂÜô‰∏ÄÂ∞Å‰ø°Áªô ${a} Âêß</div>`
                            : '<div style="text-align:center;color:#ccc;padding:40px;">ÊöÇÊó†ÁèçËóè...<br>ÂéªÂÜô‰∏ÄÂ∞Å‰ø°Âêß</div>';
                        return void (h.innerHTML = e);
                    }
                    ((h.innerHTML = ""),
                        o.forEach((e) => {
                            const t = document.createElement("div");
                            ((t.className = "collection-item"), (t.dataset.id = e.id));
                            t.innerHTML = `\n                    <div class="collection-date">${e.date} ¬∑ ${e.aiName || "AI"}</div>\n                    <div class="collection-summary">${e.content}</div>\n                    <div class="collection-actions">\n                        <button class="collection-action-btn export-btn" title="ÂØºÂá∫TXT"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>\n                        <button class="collection-action-btn delete-btn" title="Âà†Èô§"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>\n                    </div>\n                `;
                            t.querySelector(".delete-btn").addEventListener("click", (t) => {
                                (t.stopPropagation(),
                                    confirm("Á°ÆÂÆöË¶ÅÊíïÊéâËøô‰∏ÄÈ°µÂêóÔºü") &&
                                    (async function (e) {
                                        try {
                                            const t = await window.dbHelper.loadData(
                                                "settingsStore",
                                                "anecdotesCollection",
                                            );
                                            const n = (
                                                t && Array.isArray(t.value) ? t.value : []
                                            ).filter((t) => t.id !== e);
                                            (await window.dbHelper.saveData(
                                                "settingsStore",
                                                "anecdotesCollection",
                                                n,
                                            ),
                                                L());
                                        } catch (e) {
                                            console.error("Delete failed:", e);
                                        }
                                    })(e.id));
                            });
                            (t.querySelector(".export-btn").addEventListener("click", (t) => {
                                (t.stopPropagation(),
                                    (function (e) {
                                        const t = `ÈÄ∏‰∫ã - ${e.aiName}\nÊó•Êúü: ${e.date}\n\n${e.content}`,
                                            n = new Blob([t], {
                                                type: "text/plain",
                                            }),
                                            a = URL.createObjectURL(n),
                                            o = document.createElement("a");
                                        ((o.href = a),
                                            (o.download = `ÈÄ∏‰∫ã_${e.aiName}_${e.timestamp}.txt`),
                                            document.body.appendChild(o),
                                            o.click(),
                                            document.body.removeChild(o),
                                            URL.revokeObjectURL(a));
                                    })(e));
                            }),
                                t.addEventListener("click", () => {
                                    t.classList.toggle("expanded");
                                    const e = t.querySelector(".collection-summary");
                                    t.classList.contains("expanded")
                                        ? (e.style.webkitLineClamp = "unset")
                                        : (e.style.webkitLineClamp = "3");
                                }),
                                h.appendChild(t));
                        }));
                } catch (e) {
                    (console.error("[Anecdotes] Load collection failed:", e),
                        (h.innerHTML =
                            '<div style="color:red;padding:20px;">Âä†ËΩΩÂ§±Ë¥•</div>'));
                }
        }
        async function B(e) {
            const t = window.currentOpenContact;
            if (!t) throw new Error("Êú™ÊâæÂà∞ÂΩìÂâçÂØπËØù");
            const n = t.name || t.ai?.name || "AI",
                a = t.ai?.persona || "",
                o = t.user?.name || "Áî®Êà∑",
                s = t.user?.persona || "";
            let i = "";
            try {
                const e = await window.dbHelper.loadData("worldBooks", "allWorldBooks"),
                    n = e && Array.isArray(e.value) ? e.value : [];
                let a = new Set();
                if (t.linkedWorldBookIds && t.linkedWorldBookIds.length > 0)
                    t.linkedWorldBookIds.forEach((e) => a.add(e));
                else if (
                    t.linkedWorldBookGroupIds &&
                    t.linkedWorldBookGroupIds.length > 0
                ) {
                    const e = await window.dbHelper.loadData(
                        "worldBookGroups",
                        "allGroups",
                    ),
                        n = e && Array.isArray(e.value) ? e.value : [],
                        o = new Set(t.linkedWorldBookGroupIds);
                    n.forEach((e) => {
                        o.has(e.id) &&
                            Array.isArray(e.bookIds) &&
                            e.bookIds.forEach((e) => a.add(e));
                    });
                }
                if (a.size > 0) {
                    const e = n
                        .filter((e) => a.has(e.id))
                        .map((e) => `### ‰∏ñÁïå‰π¶: ${e.name}\n${e.content}`)
                        .join("\n\n");
                    e && (i = `\n## ‰∏ñÁïåËÆæÂÆöÂèÇËÄÉ:\n${e}\n`);
                }
            } catch (e) {
                console.warn("[Anecdotes] Âä†ËΩΩ‰∏ñÁïå‰π¶Â§±Ë¥•:", e);
            }
            let r = "";
            try {
                const e = `memoryCheques_${t.id}`,
                    n = await window.dbHelper.loadData("memoryCheques", e),
                    a = (n && Array.isArray(n.value) ? n.value : []).filter(
                        (e) => e.isActive,
                    );
                a.length > 0 &&
                    (r =
                        "\n## ÈáçË¶ÅËÆ∞ÂøÜ:\n" +
                        a.map((e) => `- ${e.content}`).join("\n") +
                        "\n");
            } catch (e) {
                console.warn("[Anecdotes] Âä†ËΩΩËÆ∞ÂøÜÊîØÁ•®Â§±Ë¥•:", e);
            }
            const l = `‰Ω†ÊòØ‰∏Ä‰ΩçÊâçÂçéÊ®™Ê∫¢ÁöÑ‰ΩúÂÆ∂ÔºåÊìÖÈïøÂàõ‰ΩúÁªÜËÖª„ÄÅÂØåÊúâÊÉÖÊÑüÁöÑÂ∞èÁï™Â§ñÊïÖ‰∫ã„ÄÇ\n\n## ËßíËâ≤ËÆæÂÆö:\n„Äê${n}ÁöÑ‰∫∫ËÆæ„Äë\n${a || "(Êó†ËØ¶ÁªÜ‰∫∫ËÆæ)"}\n\n„Äê${o}ÁöÑ‰∫∫ËÆæ„Äë\n${s || "(Êó†ËØ¶ÁªÜ‰∫∫ËÆæ)"}\n\n${i}\n${r}\n\n## Âàõ‰ΩúË¶ÅÊ±Ç:\n1. Ê†πÊçÆÁî®Êà∑ÁöÑÊèêÁ§∫ÔºåÂàõ‰Ωú‰∏Ä‰∏™ÁöÑÂ∞èÁï™Â§ñ/ÈÄ∏‰∫ã\n2. ‰ª•${n}ÁöÑËßÜËßíÊàñÁ¨¨‰∏â‰∫∫Áß∞ÂèôËø∞\n3. ÊñáÈ£éÁé∞‰ª£„ÄÅÊ∏ÖÊñ∞„ÄÅÊúâË¥®ÊÑü„ÄÇ\n4. ‰øùÊåÅËßíËâ≤ÊÄßÊ†º‰∏ÄËá¥ÊÄß\n5. ÂèØ‰ª•ÊòØÊó•Â∏∏ÁâáÊÆµ„ÄÅÂõûÂøÜ„ÄÅÂπªÊÉ≥ÊàñÊ∏©È¶®‰∫íÂä®\n6. ‰∏çÈúÄË¶ÅÊ†áÈ¢òÔºåÁõ¥Êé•ÂºÄÂßãÂèôËø∞\n7. ÁªìÂ∞æÂèØ‰ª•Á®çÊúâÁïôÁôΩÔºåËÆ©‰∫∫ÂõûÂë≥\n8. **ÂøÖÈ°ª‰ΩøÁî®‰∏≠ÊñáËøõË°åÂàõ‰ΩúÔºåÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Ëã±Êñá**`,
                c = await window.dbHelper.loadData("settingsStore", "apiSettings");
            if (!c || !c.value || !c.value.url)
                throw new Error("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API");
            const { url: d, key: u, model: m, temperature: p } = c.value;
            let g = d.endsWith("/") ? d.slice(0, -1) : d;
            g += "/chat/completions";
            const y = await fetch(g, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${u}`,
                },
                body: JSON.stringify({
                    model: m || "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: l,
                        },
                        {
                            role: "user",
                            content: `ËØ∑Ê†πÊçÆ‰ª•‰∏ãÊèêÁ§∫Âàõ‰Ωú‰∏Ä‰∏™Â∞èÁï™Â§ñ:\n\n${e}`,
                        },
                    ],
                    temperature: 0.8,
                    max_tokens: 2e5,
                }),
            });
            if (!y.ok) {
                const e = await y.text();
                throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${y.status} - ${e}`);
            }
            const h = await y.json(),
                v = h.choices?.[0]?.message?.content?.trim();
            if (!v) throw new Error("AI Êú™ËøîÂõûÊúâÊïàÂÜÖÂÆπ");
            return v;
        }
        (e.addEventListener("click", (e) => {
            (e.stopPropagation(),
                window.currentOpenContact
                    ? (x(),
                        t.classList.add("active"),
                        console.log("[Anecdotes] ÈÄ∏‰∫ãÁïåÈù¢Â∑≤ÊâìÂºÄ"))
                    : alert("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ËÅäÂ§©ÂØπËØù"));
        }),
            n.addEventListener("click", function () {
                (t.classList.remove("active"), x());
            }),
            a.addEventListener("click", () => {
                a.classList.contains("thinking") ||
                    (E
                        ? I &&
                        "none" !== c.style.display &&
                        (o.classList.remove("visible"),
                            (I = !1),
                            setTimeout(() => {
                                (a.classList.remove("opened"),
                                    (E = !1),
                                    l.classList.remove("hidden"));
                            }, 300))
                        : (a.classList.add("opened"),
                            (E = !0),
                            l.classList.add("hidden"),
                            setTimeout(() => {
                                (o.classList.add("visible"), (I = !0));
                            }, 500)));
            }),
            i.addEventListener("click", async () => {
                const e = s.value.trim();
                if (e) {
                    ((c.style.display = "none"),
                        (u.style.display = "flex"),
                        (l.textContent = "‰ø°‰ª∂Ê≠£Âú®ÈÇÆÂØÑ..."),
                        (w = e),
                        o.classList.remove("visible"),
                        (I = !1),
                        setTimeout(() => {
                            (a.classList.remove("opened"),
                                (E = !1),
                                setTimeout(() => {
                                    a.classList.add("thinking");
                                }, 300));
                        }, 400));
                    try {
                        const t = await B(e);
                        (a.classList.remove("thinking"),
                            setTimeout(() => {
                                (a.classList.add("opened"),
                                    (E = !0),
                                    (u.style.display = "none"),
                                    (d.style.display = "block"),
                                    (m.innerHTML = b(t)),
                                    (p.textContent = `‚Äî‚Äî ${window.currentOpenContact.ai.name}`),
                                    k(t, window.currentOpenContact.ai.name),
                                    setTimeout(() => {
                                        (o.classList.add("visible"), (I = !0));
                                    }, 500));
                            }, 300));
                    } catch (e) {
                        (console.error("[Anecdotes] AIË∞ÉÁî®Â§±Ë¥•:", e),
                            a.classList.remove("thinking"),
                            (u.style.display = "none"),
                            (c.style.display = "block"),
                            alert("ÈÇÆÂ∑ÆÂú®Ë∑Ø‰∏äËø∑Ë∑Ø‰∫Ü...ËØ∑ÂÜçËØï‰∏ÄÊ¨°\n" + e.message),
                            a.classList.add("opened"),
                            (E = !0),
                            setTimeout(() => {
                                (o.classList.add("visible"), (I = !0));
                            }, 300));
                    }
                } else alert("‰ø°Á∫∏‰∏äËøòÁ©∫Á©∫Â¶Ç‰πüÂë¢...");
            }),
            r.addEventListener("click", () => {
                (o.classList.remove("visible"),
                    (I = !1),
                    setTimeout(() => {
                        ((d.style.display = "none"),
                            (c.style.display = "block"),
                            (s.value = ""),
                            setTimeout(() => {
                                (o.classList.add("visible"), (I = !0));
                            }, 200));
                    }, 300));
            }),
            f &&
            f.addEventListener("click", async () => {
                w
                    ? (o.classList.remove("visible"),
                        (I = !1),
                        (d.style.display = "none"),
                        (u.style.display = "flex"),
                        (l.textContent = "‰ø°‰ª∂Ê≠£Âú®ÈáçÊñ∞ÊäïÈÄí..."),
                        setTimeout(async () => {
                            (a.classList.remove("opened"),
                                (E = !1),
                                setTimeout(() => {
                                    a.classList.add("thinking");
                                }, 300));
                            try {
                                const e = await B(w);
                                (a.classList.remove("thinking"),
                                    setTimeout(() => {
                                        (a.classList.add("opened"),
                                            (E = !0),
                                            (u.style.display = "none"),
                                            (d.style.display = "block"),
                                            (m.innerHTML = b(e)),
                                            (p.textContent = `‚Äî‚Äî ${window.currentOpenContact ? window.currentOpenContact.ai.name : "AI"}`),
                                            k(e, window.currentOpenContact.ai.name),
                                            setTimeout(() => {
                                                (o.classList.add("visible"), (I = !0));
                                            }, 500));
                                    }, 300));
                            } catch (e) {
                                (console.error("[Anecdotes] Remail failed:", e),
                                    a.classList.remove("thinking"),
                                    alert("ÈáçÊñ∞ÈÇÆÂØÑÂ§±Ë¥•...\n" + e.message),
                                    a.classList.add("opened"),
                                    (E = !0),
                                    o.classList.add("visible"),
                                    (I = !0));
                            }
                        }, 400))
                    : alert("Ê≤°ÊúâÊâæÂà∞‰∏ä‰∏ÄÂ∞Å‰ø°ÁöÑÂ∫ïÁ®ø...");
            }),
            g &&
            g.addEventListener("click", (e) => {
                (e.stopPropagation(), L(), y.classList.add("active"));
            }),
            v &&
            v.addEventListener("click", () => {
                y.classList.remove("active");
            }),
            y &&
            y.addEventListener("click", (e) => {
                e.target === y && y.classList.remove("active");
            }),
            console.log("[Anecdotes] ÈÄ∏‰∫ãÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê"));
    }),
    document.addEventListener("DOMContentLoaded", () => {
        console.log("[Location] ÂàùÂßãÂåñÂÆö‰ΩçÂäüËÉΩ...");
        const e = document.getElementById("location-feature"),
            t = document.getElementById("location-input-modal"),
            n = document.getElementById("location-modal-close-btn"),
            a = document.getElementById("location-name-input"),
            o = document.getElementById("location-address-input"),
            s = document.getElementById("location-distance-input"),
            i = document.getElementById("send-location-btn");

        function r() {
            ((t.style.opacity = "0"),
                t.classList.remove("visible"),
                setTimeout(() => {
                    t.style.display = "none";
                }, 300));
        }

        function l(e) {
            const t = document.createElement("div");
            return ((t.textContent = e), t.innerHTML);
        }
        e && t
            ? (e.addEventListener("click", (e) => {
                (e.stopPropagation(),
                    window.currentOpenContact
                        ? (a && (a.value = ""),
                            o && (o.value = ""),
                            s && (s.value = ""),
                            (t.style.display = "flex"),
                            requestAnimationFrame(() => {
                                ((t.style.opacity = "1"), t.classList.add("visible"));
                            }),
                            console.log("[Location] ÂÆö‰ΩçÂºπÁ™óÂ∑≤ÊâìÂºÄ"))
                        : alert("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ËÅäÂ§©ÂØπËØù"));
            }),
                n && n.addEventListener("click", r),
                t.addEventListener("click", (e) => {
                    e.target === t && r();
                }),
                i &&
                i.addEventListener("click", async () => {
                    const e = a?.value.trim() || "",
                        t = o?.value.trim() || "",
                        n = s?.value.trim() || "0";
                    if (!e) return void alert("ËØ∑ËæìÂÖ•‰ΩçÁΩÆÂêçÁß∞");
                    if (!t) return void alert("ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄ");
                    if (!n || parseFloat(n) < 0)
                        return void alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË∑ùÁ¶ªÔºàkmÔºâ");
                    const i = (function (e, t, n) {
                        return `\n            <div class="map-card">\n                <div class="info-section">\n                    <div class="title">${l(e)}</div>\n                    <div class="address">${l(t)}</div>\n                </div>\n                \n                <div class="map-canvas">\n                    <div class="river-path"></div>\n                    \n                    <div class="main-road h-road"></div>\n                    <div class="main-road v-road"></div>\n\n                    <div class="tree" style="top: 60px; left: 50px;"></div>\n                    <div class="tree" style="top: 60px; left: 100px;"></div>\n                    <div class="tree" style="top: 100px; left: 55px;"></div>\n\n                    <div class="neighborhood" style="top: 15px; left: 10px;">\n                        <div class="building" style="width: 22px; height: 28px;"></div>\n                        <div class="building" style="width: 26px; height: 22px;"></div>\n                        <div class="building" style="width: 30px; height: 25px;"></div>\n                    </div>\n\n                    <div class="neighborhood" style="bottom: 15px; left: 15px;">\n                        <div class="building" style="width: 35px; height: 22px;"></div>\n                        <div class="building" style="width: 18px; height: 18px;"></div>\n                    </div>\n\n                    <div class="marker-fixed">\n                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#27c34b">\n                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n                        </svg>\n                        <div class="marker-label">ÊàëÁöÑ‰ΩçÁΩÆ</div>\n                    </div>\n                    \n                    <div class="dist-badge">Ë∑ùÊÇ® ${l(n)} km</div>\n                </div>\n            </div>\n        `;
                    })(e, t, n);
                    (await (async function (e, t, n, a) {
                        if (!window.currentOpenContact) return;
                        const o = window.currentOpenContact,
                            s = Date.now(),
                            i = `loc_${s}_${Math.random().toString(36).substr(2, 9)}`,
                            r = {
                                id: s,
                                uuid: i,
                                sender: "user",
                                text: e,
                                timestamp: s,
                                type: "location",
                                locationData: {
                                    name: t,
                                    address: n,
                                    distance: a,
                                    aiNotified: !1,
                                },
                            },
                            l = window.saveMessageToHistory,
                            c = window.addMessageToView;
                        l && "function" == typeof l
                            ? (await l(r, o.id),
                                console.log("[Location] ÂÆö‰ΩçÊ∂àÊÅØÂ∑≤ÈÄöËøáÊ†áÂáÜÊµÅÁ®ã‰øùÂ≠ò"))
                            : (console.error(
                                "[Location] Critical: window.saveMessageToHistory not found!",
                            ),
                                o.history.push(r));
                        c && "function" == typeof c && c(r, o);
                        const d = document.getElementById("chat-messages-container");
                        d && (d.scrollTop = d.scrollHeight);
                        console.log("[Location] ÂÆö‰ΩçÂç°ÁâáÂ∑≤ÂèëÈÄÅÂπ∂Ê∏≤Êüì");
                        const u = `Áî®Êà∑ÂàöÂàöÂàÜ‰∫´‰∫Ü‰∏ÄÊù°ÂÆö‰ΩçÔºåÂÜÖÂÆπÊòØÔºö${t} - ${n}ÔºåË∑ùÁ¶ª ${a}km`,
                            m = {
                                id: Date.now() + 1,
                                uuid: `loc_hint_${Date.now()}`,
                                sender: "system",
                                text: u,
                                timestamp: Date.now(),
                                type: "location_hint",
                                hidden: !0,
                                locationRef: i,
                            };
                        l &&
                            "function" == typeof l &&
                            (await l(m, o.id), console.log("[Location] AIÂÆö‰ΩçÊèêÁ§∫Â∑≤‰øùÂ≠ò"));
                    })(i, e, t, n),
                        r(),
                        console.log("[Location] ÂÆö‰ΩçÂç°ÁâáÂ∑≤ÂèëÈÄÅ:", {
                            name: e,
                            address: t,
                            distance: n,
                        }));
                }),
                console.log("[Location] ÂÆö‰ΩçÂäüËÉΩÂàùÂßãÂåñÂÆåÊàê"))
            : console.warn("[Location] Ê†∏ÂøÉÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåË∑≥ËøáÂàùÂßãÂåñ");
    }),
    document.addEventListener("DOMContentLoaded", function () {
        console.log("[GroupSettingsPage] ÂàùÂßãÂåñÁæ§ËÅäËÆæÁΩÆÈ°µÈù¢...");
        const e = document.getElementById("group-settings-back-btn");
        e &&
            e.addEventListener("click", function () {
                const e = document.getElementById("group-settings-page");
                e &&
                    (e.classList.add("closing"),
                        setTimeout(() => {
                            e.classList.remove("active", "closing");
                        }, 300));
            });
        document
            .querySelectorAll("#group-settings-page .collapsible-header")
            .forEach((e) => {
                e.addEventListener("click", function () {
                    const e = this.closest(".collapsible-section");
                    e && e.classList.toggle("expanded");
                });
            });
        document
            .querySelectorAll("#group-settings-page .ios-switch")
            .forEach((e) => {
                e.addEventListener("click", async function () {
                    if ((this.classList.toggle("active"), !window.currentOpenGroup))
                        return;
                    const e = this.id,
                        t = this.classList.contains("active");
                    try {
                        "group-show-avatars-toggle" === e
                            ? ((window.currentOpenGroup.avatarSettings =
                                window.currentOpenGroup.avatarSettings || {}),
                                (window.currentOpenGroup.avatarSettings.show = t))
                            : "group-show-timestamp-toggle" === e
                                ? ((window.currentOpenGroup.timestampSettings =
                                    window.currentOpenGroup.timestampSettings || {}),
                                    (window.currentOpenGroup.timestampSettings.show = t))
                                : "group-bilingual-bubble-toggle" === e &&
                                ((window.currentOpenGroup.bilingualBubble =
                                    window.currentOpenGroup.bilingualBubble || {}),
                                    (window.currentOpenGroup.bilingualBubble.enabled = t));
                        const n = await window.dbHelper.loadData(
                            "groupChats",
                            "allGroupChats",
                        );
                        let a = n ? n.value : [];
                        const o = a.findIndex((e) => e.id === window.currentOpenGroup.id);
                        (o > -1 &&
                            ((a[o] = window.currentOpenGroup),
                                await window.dbHelper.saveData("groupChats", "allGroupChats", a)),
                            console.log("[GroupSettings] ÊòæÁ§∫ËÆæÁΩÆÂ∑≤‰øùÂ≠ò:", e, t));
                    } catch (e) {
                        console.error("[GroupSettings] ‰øùÂ≠òÊòæÁ§∫ËÆæÁΩÆÂ§±Ë¥•:", e);
                    }
                });
            });
        let t = !1;
        const n = document.getElementById("group-member-count");
        (n &&
            n.addEventListener("click", function () {
                t = !t;
                const e = document.getElementById("group-members-grid");
                if (!e) return;
                const n = e.querySelectorAll(".member-delete-btn");
                if (t)
                    ((this.textContent = "ÂÆåÊàê"),
                        (this.style.color = "#C48888"),
                        n.forEach((e) => (e.style.display = "flex")));
                else {
                    const e = window.currentOpenGroup?.members?.length || 0;
                    ((this.textContent = `${e}ÂêçÁæ§ÊàêÂëò >`),
                        (this.style.color = ""),
                        n.forEach((e) => (e.style.display = "none")));
                }
            }),
            console.log("[GroupSettingsPage] Áæ§ËÅäËÆæÁΩÆÈ°µÈù¢ÂàùÂßãÂåñÂÆåÊàê"));
    }),
    document.addEventListener("DOMContentLoaded", function () {
        console.log("[ChatSettingsPage] ÂàùÂßãÂåñÂçïËÅäËÆæÁΩÆÈ°µÈù¢...");
        const e = document.getElementById("chat-settings-back-btn");
        e &&
            e.addEventListener("click", function () {
                const e = document.getElementById("chat-settings-page");
                e &&
                    (e.classList.add("closing"),
                        setTimeout(() => {
                            e.classList.remove("active", "closing");
                        }, 300));
            });
        const t = document.getElementById("chat-role-tab-ai"),
            n = document.getElementById("chat-role-tab-user"),
            a = document.getElementById("chat-ai-form"),
            o = document.getElementById("chat-user-form"),
            s = document.getElementById("chat-settings-avatar"),
            i = document.getElementById("chat-settings-name");
        t &&
            n &&
            (t.addEventListener("click", function () {
                (t.classList.add("active"),
                    n.classList.remove("active"),
                    a && (a.style.display = "block"),
                    o && (o.style.display = "none"),
                    window.currentOpenContact &&
                    s &&
                    ((s.style.backgroundImage = `url('${window.currentOpenContact.ai.avatar}')`),
                        (i.textContent = window.currentOpenContact.ai.name)));
            }),
                n.addEventListener("click", function () {
                    (n.classList.add("active"),
                        t.classList.remove("active"),
                        o && (o.style.display = "block"),
                        a && (a.style.display = "none"),
                        window.currentOpenContact &&
                        s &&
                        ((s.style.backgroundImage = `url('${window.currentOpenContact.user.avatar}')`),
                            (i.textContent = window.currentOpenContact.user.name)));
                }));
        document
            .querySelectorAll("#chat-settings-page .collapsible-header")
            .forEach((e) => {
                e.addEventListener("click", function () {
                    const e = this.closest(".collapsible-section");
                    e && e.classList.toggle("expanded");
                });
            });
        document
            .querySelectorAll("#chat-settings-page .ios-switch")
            .forEach((e) => {
                e.addEventListener("click", function () {
                    this.classList.toggle("active");
                });
            });
        const r = document.getElementById("chat-avatar-upload-input"),
            l = document.querySelector("#chat-settings-page .profile-avatar-wrapper");
        l &&
            r &&
            (l.addEventListener("click", function () {
                r.click();
            }),
                r.addEventListener("change", async function (e) {
                    const t = e.target.files[0];
                    if (t && window.currentOpenContact) {
                        ((e.target.value = ""),
                            window.currentOpenContact.ai &&
                            window.currentOpenContact.user &&
                            window.currentOpenContact.ai === window.currentOpenContact.user &&
                            (console.log(
                                "Detected AI and User sharing same object, unlinking...",
                            ),
                                (window.currentOpenContact.user = JSON.parse(
                                    JSON.stringify(window.currentOpenContact.user),
                                ))));
                        try {
                            let e;
                            ((e =
                                window.iOSBabyMode && window.iOSBabyMode.enabled && t.size > 512e3
                                    ? await window.iOSBabyMode.safeCompressImage(t, {
                                        maxWidth: 400,
                                        maxHeight: 400,
                                        quality: 0.8,
                                    })
                                    : window.iOSBabyMode
                                        ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                        : await new Promise((e, n) => {
                                            const a = new FileReader();
                                            ((a.onload = (t) => e(t.target.result)),
                                                (a.onerror = n),
                                                a.readAsDataURL(t));
                                        })),
                                s && (s.style.backgroundImage = `url('${e}')`));
                            const n = document.getElementById("chat-role-tab-ai");
                            if (n && n.classList.contains("active")) {
                                window.currentOpenContact.ai.avatar = e;
                                const t = document.getElementById("chat-ai-name-input");
                                t && (t.value = window.currentOpenContact.ai.name);
                            } else {
                                window.currentOpenContact.user.avatar = e;
                                const t = document.getElementById("chat-user-avatar-preview");
                                t && (t.style.backgroundImage = `url('${e}')`);
                            }
                        } catch (e) {
                            (console.error("Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•:", e), alert("‚ùå Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•"));
                        }
                    }
                }));
        const c = document.getElementById("chat-user-avatar-btn"),
            d = document.getElementById("chat-user-avatar-input"),
            u = document.getElementById("chat-user-avatar-preview");
        c &&
            d &&
            (c.addEventListener("click", function () {
                d.click();
            }),
                d.addEventListener("change", async function (e) {
                    const t = e.target.files[0];
                    if (t) {
                        e.target.value = "";
                        try {
                            let e;
                            ((e =
                                window.iOSBabyMode && window.iOSBabyMode.enabled && t.size > 512e3
                                    ? await window.iOSBabyMode.safeCompressImage(t, {
                                        maxWidth: 400,
                                        maxHeight: 400,
                                        quality: 0.8,
                                    })
                                    : window.iOSBabyMode
                                        ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                        : await new Promise((e, n) => {
                                            const a = new FileReader();
                                            ((a.onload = (t) => e(t.target.result)),
                                                (a.onerror = n),
                                                a.readAsDataURL(t));
                                        })),
                                u && (u.style.backgroundImage = `url('${e}')`),
                                window.currentOpenContact &&
                                (window.currentOpenContact.user.avatar = e));
                        } catch (e) {
                            (console.error("Áî®Êà∑Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•:", e),
                                alert("‚ùå Áî®Êà∑Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•"));
                        }
                    }
                }));
        const m = document.getElementById("chat-bg-input");
        m &&
            m.addEventListener("change", async function (e) {
                const t = e.target.files[0];
                if (t && window.currentOpenContact) {
                    e.target.value = "";
                    try {
                        let e;
                        window.iOSBabyMode && window.iOSBabyMode.enabled && t.size > 2097152
                            ? (window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...", 0),
                                (e = await window.iOSBabyMode.safeCompressImage(t, {
                                    maxWidth: 1920,
                                    maxHeight: 1920,
                                    quality: 0.75,
                                    onProgress: (e) =>
                                        window.iOSBabyMode.showProgressToast(
                                            "Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...",
                                            e,
                                        ),
                                })),
                                window.iOSBabyMode.hideProgressToast())
                            : (e = window.iOSBabyMode
                                ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                : await new Promise((e, n) => {
                                    const a = new FileReader();
                                    ((a.onload = (t) => e(t.target.result)),
                                        (a.onerror = n),
                                        a.readAsDataURL(t));
                                }));
                        const n = document.getElementById("chat-bg-preview"),
                            a = document.getElementById("chat-bg-placeholder"),
                            o = document.getElementById("chat-bg-preview-box");
                        (n && ((n.src = e), (n.style.display = "block")),
                            a && (a.style.display = "none"),
                            o && o.classList.add("has-bg"),
                            (window.currentOpenContact.chatBackground = e));
                    } catch (e) {
                        (console.error("ËÉåÊôØÂõæ‰∏ä‰º†Â§±Ë¥•:", e),
                            window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                            alert(
                                `‚ùå ËÉåÊôØÂõæ‰∏ä‰º†Â§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`,
                            ));
                    }
                }
            });
        const p = document.getElementById("chat-clear-bg-btn");
        if (p) {
            p.addEventListener("click", function () {
                const e = document.getElementById("chat-bg-preview"),
                    t = document.getElementById("chat-bg-placeholder"),
                    n = document.getElementById("chat-bg-preview-box");
                (e && ((e.src = ""), (e.style.display = "none")),
                    t && (t.style.display = "flex"),
                    n && n.classList.remove("has-bg"),
                    window.currentOpenContact &&
                    (window.currentOpenContact.chatBackground = null),
                    this.checked &&
                    (async function () {
                        if (!("serviceWorker" in navigator) || !("PushManager" in window))
                            return (
                                console.warn("[OfflineLife] Push messaging is not supported"),
                                !1
                            );
                        try {
                            const e = await navigator.serviceWorker.ready,
                                t = (function (e) {
                                    const t = "=".repeat((4 - (e.length % 4)) % 4),
                                        n = (e + t).replace(/-/g, "+").replace(/_/g, "/"),
                                        a = window.atob(n),
                                        o = new Uint8Array(a.length);
                                    for (let e = 0; e < a.length; ++e) o[e] = a.charCodeAt(e);
                                    return o;
                                })(
                                    "BCZ-HV6B5DpdYLTKW_OlWt-ZoZ666xBgsG__5xNDHwX8rSn-e71W89VP4yOmDCbMPBpmyEBUdueCeIAIVeWD1XU",
                                ),
                                n = await e.pushManager.subscribe({
                                    userVisibleOnly: !0,
                                    applicationServerKey: t,
                                });
                            console.log("[OfflineLife] User is subscribed:", n);
                            const a = "/api/offline-life",
                                o =
                                    (window.currentOpenContact &&
                                        window.currentOpenContact.id) ||
                                    "user_default";
                            return (
                                await fetch(`${a}/subscribe`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        contactId: o,
                                        subscription: n,
                                    }),
                                }),
                                !0
                            );
                        } catch (e) {
                            return (
                                console.error(
                                    "[OfflineLife] Failed to subscribe the user: ",
                                    e,
                                ),
                                !1
                            );
                        }
                    })().then((e) => {
                        e
                            ? showToast("Á¶ªÁ∫øÈÄöÁü•Â∑≤ÂºÄÂêØ")
                            : showToast("ÈÄöÁü•ËÆ¢ÈòÖÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê");
                    }));
            });
            const e = document.getElementById("chat-clear-history-btn");
            e &&
                e.addEventListener("click", async function () {
                    if (
                        window.currentOpenContact &&
                        confirm(
                            "Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâËÆ∞ÂΩïÔºàÂåÖÊã¨ËÆ∞ÂøÜ„ÄÅÂ∞è‰∏ñÁïå„ÄÅÂ∞èÁ™ùÊï∞ÊçÆÔºâÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü",
                        )
                    )
                        try {
                            const e = window.currentOpenContact.id,
                                t = await window.dbHelper.loadData(
                                    "messageContacts",
                                    "allContacts",
                                );
                            let n = t ? t.value : [];
                            const a = n.findIndex((t) => t.id === e);
                            a > -1 &&
                                ((n[a].history = []),
                                    (n[a].lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"),
                                    await window.dbHelper.saveData(
                                        "messageContacts",
                                        "allContacts",
                                        n,
                                    ),
                                    (window.currentOpenContact.history = []),
                                    (window.currentOpenContact.lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"));
                            try {
                                (await window.dbHelper.deleteData(
                                    "settingsStore",
                                    `aiMemory_${e}`,
                                ),
                                    console.log("[ChatSettings] Â∑≤Ê∏ÖÁ©∫TAÁöÑËÆ∞ÂøÜÊï∞ÊçÆ"),
                                    window.AIMemory &&
                                    window.AIMemory.clearCache &&
                                    window.AIMemory.clearCache());
                            } catch (e) {
                                console.warn("[ChatSettings] Ê∏ÖÁ©∫ËÆ∞ÂøÜÊï∞ÊçÆÂ§±Ë¥•:", e);
                            }
                            try {
                                (await window.dbHelper.deleteData(
                                    "settingsStore",
                                    `littleWorld_${e}`,
                                ),
                                    console.log("[ChatSettings] Â∑≤Ê∏ÖÁ©∫Â∞è‰∏ñÁïåÊï∞ÊçÆ"),
                                    window.LittleWorld &&
                                    window.LittleWorld.clearCache &&
                                    window.LittleWorld.clearCache());
                            } catch (e) {
                                console.warn("[ChatSettings] Ê∏ÖÁ©∫Â∞è‰∏ñÁïåÊï∞ÊçÆÂ§±Ë¥•:", e);
                            }
                            try {
                                (await window.dbHelper.deleteData("wowoData", `wowo_${e}`),
                                    console.log("[ChatSettings] Â∑≤Ê∏ÖÁ©∫Â∞èÁ™ùÊï∞ÊçÆ"));
                            } catch (e) {
                                console.warn("[ChatSettings] Ê∏ÖÁ©∫Â∞èÁ™ùÊï∞ÊçÆÂ§±Ë¥•:", e);
                            }
                            const o = document.getElementById("chat-messages-container");
                            (o && (o.innerHTML = ""),
                                alert("ËÅäÂ§©ËÆ∞ÂΩïÂèäÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆÂ∑≤ÊàêÂäüÊ∏ÖÈô§ÔºÅ"));
                        } catch (e) {
                            (console.error("[ChatSettings] Ê∏ÖÁ©∫ËÆ∞ÂΩïÂ§±Ë¥•:", e),
                                alert("Ê∏ÖÁ©∫Â§±Ë¥•Ôºö" + e.message));
                        }
                });
            const t = document.getElementById("chat-block-btn");
            t &&
                t.addEventListener("click", async function () {
                    if (!window.currentOpenContact) return;
                    const e = window.currentOpenContact.isBlocked,
                        n = e ? "Ëß£Èô§ÊãâÈªë" : "ÊãâÈªë";
                    if (confirm(`Á°ÆÂÆöË¶Å${n}ËØ•ËÅîÁ≥ª‰∫∫ÂêóÔºü`))
                        try {
                            window.currentOpenContact.isBlocked = !e;
                            const a = await window.dbHelper.loadData(
                                "messageContacts",
                                "allContacts",
                            );
                            let o = a ? a.value : [];
                            const s = o.findIndex(
                                (e) => e.id === window.currentOpenContact.id,
                            );
                            (s > -1 &&
                                ((o[s].isBlocked = !e),
                                    await window.dbHelper.saveData(
                                        "messageContacts",
                                        "allContacts",
                                        o,
                                    )),
                                (t.textContent = e ? "ÊãâÈªëËÅîÁ≥ª‰∫∫" : "Ëß£Èô§ÊãâÈªë"),
                                alert(`Â∑≤${n}ËØ•ËÅîÁ≥ª‰∫∫`));
                        } catch (e) {
                            (console.error("[ChatSettings] Êìç‰ΩúÂ§±Ë¥•:", e),
                                alert("Êìç‰ΩúÂ§±Ë¥•Ôºö" + e.message));
                        }
                });
            const n = document.getElementById("save-chat-settings-new-btn");
            n &&
                n.addEventListener("click", async function () {
                    if (window.currentOpenContact)
                        try {
                            const e = window.currentOpenContact,
                                t = document.getElementById("chat-ai-name-input"),
                                n = document.getElementById("chat-ai-persona-input"),
                                a = document.getElementById("chat-context-memory-input"),
                                o = document.getElementById("chat-settings-avatar");
                            if (
                                ((e.ai.name = t ? t.value : e.ai.name),
                                    (e.ai.persona = n ? n.value : ""),
                                    (e.contextMemory = a
                                        ? parseInt(a.value) || 0
                                        : e.contextMemory || 0),
                                    o && o.style.backgroundImage)
                            ) {
                                const t = document.getElementById("chat-role-tab-ai");
                                t &&
                                    t.classList.contains("active") &&
                                    (e.ai.avatar = o.style.backgroundImage.slice(5, -2));
                            }
                            const s = document.getElementById("chat-user-name-input"),
                                i = document.getElementById("chat-user-persona-input"),
                                r = document.getElementById("chat-user-avatar-preview");
                            ((e.user = e.user || {}),
                                (e.user.name = s ? s.value : e.user.name),
                                (e.user.persona = i ? i.value : ""),
                                r &&
                                r.style.backgroundImage &&
                                (e.user.avatar = r.style.backgroundImage.slice(5, -2)));
                            document.getElementById("chat-worldbook-select-container");
                            ((e.avatarSettings = {
                                showChar: document
                                    .getElementById("chat-show-char-avatar-toggle")
                                    ?.classList.contains("active"),
                                showUser: document
                                    .getElementById("chat-show-user-avatar-toggle")
                                    ?.classList.contains("active"),
                                show: document
                                    .getElementById("chat-show-char-avatar-toggle")
                                    ?.classList.contains("active"),
                                radius:
                                    document.getElementById("chat-avatar-radius-input")?.value ||
                                    "50%",
                            }),
                                (e.bubbleBMode = document
                                    .getElementById("chat-bubble-b-mode-toggle")
                                    ?.classList.contains("active")),
                                (e.timestampSettings = {
                                    show: document
                                        .getElementById("chat-show-timestamp-toggle")
                                        ?.classList.contains("active"),
                                }),
                                (e.enableDefaultStickers = document
                                    .getElementById("chat-default-stickers-toggle")
                                    ?.classList.contains("active")),
                                (e.enableMonologue = document
                                    .getElementById("chat-monologue-toggle")
                                    ?.classList.contains("active")),
                                (e.enableBilingualBubble = document
                                    .getElementById("chat-bilingual-toggle")
                                    ?.classList.contains("active")),
                                (e.enableWBStickers = document
                                    .getElementById("chat-wb-stickers-toggle")
                                    ?.classList.contains("active")),
                                (e.customBubbleCss =
                                    document.getElementById("chat-bubble-css-input")?.value ||
                                    ""),
                                (e.ai.avatarPendant = {
                                    url:
                                        document.getElementById("chat-ai-pendant-url")?.value || "",
                                    css:
                                        document.getElementById("chat-ai-pendant-css")?.value || "",
                                }),
                                (e.user.avatarPendant = {
                                    url:
                                        document.getElementById("chat-user-pendant-url")?.value ||
                                        "",
                                    css:
                                        document.getElementById("chat-user-pendant-css")?.value ||
                                        "",
                                }));
                            const l = document.getElementById("chat-tts-voice-input"),
                                c = document.getElementById("chat-tts-language-input");
                            ((e.ttsVoiceId = l ? l.value.trim() : e.ttsVoiceId || ""),
                                (e.ttsLanguage = c ? c.value : e.ttsLanguage || ""),
                                console.log(
                                    "[ChatSettings] save new settings started for contact id:",
                                    e.id,
                                ));
                            const d = await window.dbHelper.loadData(
                                "messageContacts",
                                "allContacts",
                            );
                            let u = d && Array.isArray(d.value) ? d.value : [];
                            Array.isArray(u) || (u = []);
                            const m = u.findIndex((t) => t.id === e.id);
                            if (m > -1) {
                                if (
                                    ((u[m] = e),
                                        await window.dbHelper.saveData(
                                            "messageContacts",
                                            "allContacts",
                                            u,
                                        ),
                                        "undefined" != typeof Global_AllContactsCache &&
                                        Global_AllContactsCache)
                                ) {
                                    const t = Global_AllContactsCache.findIndex(
                                        (t) => t.id === e.id,
                                    );
                                    t > -1 &&
                                        ((Global_AllContactsCache[t] = e),
                                            console.log("[ChatSettings] ÂÖ®Â±ÄÁºìÂ≠òÂ∑≤ÂêåÊ≠•Êõ¥Êñ∞"));
                                }
                            } else
                                (console.warn(
                                    `[ChatSettings] ËÅîÁ≥ª‰∫∫ ${e.id} Âú® DB ‰∏≠Êú™ÊâæÂà∞ÔºåÊâßË°åËøΩÂä†‰øùÂ≠ò`,
                                ),
                                    u.push(e),
                                    await window.dbHelper.saveData(
                                        "messageContacts",
                                        "allContacts",
                                        u,
                                    ),
                                    "undefined" != typeof Global_AllContactsCache &&
                                    Global_AllContactsCache &&
                                    Global_AllContactsCache.push(e));
                            const p = document.getElementById("chat-messages-container");
                            if (p) {
                                (window.initializeChatStyles
                                    ? window.initializeChatStyles(e)
                                    : console.error("initializeChatStyles not found on window"),
                                    "function" == typeof applyChatViewSettings
                                        ? applyChatViewSettings(e)
                                        : console.warn("applyChatViewSettings not found"));
                                try {
                                    const e = Array.from(p.querySelectorAll(".message-row")),
                                        t = {
                                            start: e.filter((e) =>
                                                e.classList.contains("group-start"),
                                            ).length,
                                            middle: e.filter((e) =>
                                                e.classList.contains("group-middle"),
                                            ).length,
                                            end: e.filter((e) => e.classList.contains("group-end"))
                                                .length,
                                            single: e.filter((e) =>
                                                e.classList.contains("group-single"),
                                            ).length,
                                        };
                                    (console.log("[ChatSettings] post-save groupCounts:", t),
                                        console.log(
                                            "[ChatSettings] chatMessagesContainer classes:",
                                            p.className,
                                        ));
                                } catch (e) {
                                    console.warn("[ChatSettings] grouping diagnostic failed", e);
                                }
                            }
                            const g = document.getElementById("chat-ai-avatar"),
                                y = document.getElementById("chat-ai-name"),
                                h = document.getElementById("chat-contact-name");
                            (g && (g.src = e.ai.avatar),
                                y && (y.textContent = e.ai.name),
                                h && (h.textContent = e.ai.name));
                            const v = document.getElementById("custom-bubble-styles");
                            if (v) {
                                const t =
                                    ".user-bubble {\n    align-self: flex-end;\n    \n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #D1D9D3;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #2F3633; \n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);\n    border-left: 1px solid rgba(255, 255, 255, 0.05);\n    margin-bottom: 0px;\n}\n.ai-bubble {\n    align-self: flex-start;\n    \n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #5F6360;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #E8EAE9;\n    border: none;\n    margin-bottom: 0px;\n}";
                                v.innerHTML = e.customBubbleCss || t;
                            }
                            try {
                                console.log(
                                    "[ChatSettings] saved contact avatarSettings:",
                                    e.avatarSettings,
                                );
                                const t = document.getElementById("chat-messages-container");
                                t &&
                                    console.log(
                                        "[ChatSettings] chat-messages-container classes:",
                                        t.className,
                                    );
                            } catch (e) {
                                console.warn("[ChatSettings] diagnostic logging failed", e);
                            }
                            alert("ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÈÉ®ÂàÜÂäüËÉΩÈúÄÈÄÄÂá∫ÂÜçËøõÂÖ•ËÅäÂ§©ÁïåÈù¢ÁîüÊïàÔºÅ");
                            const f = document.getElementById("chat-settings-page");
                            f &&
                                (f.classList.add("closing"),
                                    setTimeout(() => {
                                        f.classList.remove("active", "closing");
                                    }, 300));
                        } catch (e) {
                            (console.error("[ChatSettings] ‰øùÂ≠òÂ§±Ë¥•:", e),
                                alert("‰øùÂ≠òÂ§±Ë¥•Ôºö" + e.message));
                        }
                });
            const a = document.getElementById("chat-ai-pendant-clear");
            a &&
                a.addEventListener("click", function () {
                    ((document.getElementById("chat-ai-pendant-url").value = ""),
                        (document.getElementById("chat-ai-pendant-css").value = ""),
                        alert("ËßíËâ≤ÊåÇ‰ª∂Â∑≤Ê∏ÖÈô§Ôºå‰øùÂ≠òÂêéÁîüÊïà"));
                });
            const o = document.getElementById("chat-user-pendant-clear");
            o &&
                o.addEventListener("click", function () {
                    ((document.getElementById("chat-user-pendant-url").value = ""),
                        (document.getElementById("chat-user-pendant-css").value = ""),
                        alert("Áî®Êà∑ÊåÇ‰ª∂Â∑≤Ê∏ÖÈô§Ôºå‰øùÂ≠òÂêéÁîüÊïà"));
                });
            const s = document.getElementById("chat-bubble-preset-btn");
            s &&
                s.addEventListener("click", function () {
                    const e = document.getElementById("bubble-preset-select-modal"),
                        t = document.getElementById("bubble-preset-select-list"),
                        n = document.getElementById("bubble-preset-select-empty");
                    if (e && t) {
                        const a = JSON.parse(localStorage.getItem("bubblePresets") || "[]");
                        ((t.innerHTML = ""),
                            0 === a.length
                                ? n && (n.style.display = "block")
                                : (n && (n.style.display = "none"),
                                    a.forEach((n, a) => {
                                        const o = document.createElement("div");
                                        ((o.className = "preset-select-item"),
                                            (o.style.padding = "12px"),
                                            (o.style.borderBottom = "1px solid #eee"),
                                            (o.style.cursor = "pointer"),
                                            (o.style.backgroundColor = "#fff"),
                                            (o.style.marginBottom = "8px"),
                                            (o.style.borderRadius = "8px"));
                                        const s =
                                            n.css.length > 50
                                                ? n.css.substring(0, 50) + "..."
                                                : n.css;
                                        ((o.innerHTML = `\n                            <div style="font-weight:bold;margin-bottom:4px;">${n.name}</div>\n                            <div style="font-size:12px;color:#888;">${s}</div>\n                        `),
                                            (o.onclick = function () {
                                                const t = document.getElementById(
                                                    "chat-bubble-css-input",
                                                );
                                                (t && (t.value = n.css), (e.style.display = "none"));
                                            }),
                                            t.appendChild(o));
                                    })),
                            (e.style.display = "flex"));
                    } else alert("Êú™ÊâæÂà∞È¢ÑËÆæÈÄâÊã©ÁªÑ‰ª∂");
                });
            const i = document.getElementById("chat-bubble-save-btn");
            i &&
                i.addEventListener("click", function () {
                    const e = document.getElementById("chat-bubble-css-input")?.value;
                    if (!e || "" === e.trim()) return void alert("ËØ∑ÂÖàËæìÂÖ•CSSÊ†∑Âºè");
                    const t = JSON.parse(localStorage.getItem("bubblePresets") || "[]"),
                        n = prompt("ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞:", "ÊàëÁöÑÊ∞îÊ≥° " + (t.length + 1));
                    if (n && "" !== n.trim())
                        try {
                            const t = JSON.parse(
                                localStorage.getItem("bubblePresets") || "[]",
                            );
                            (t.unshift({
                                name: n.trim(),
                                css: e,
                                createdAt: Date.now(),
                            }),
                                localStorage.setItem("bubblePresets", JSON.stringify(t)),
                                alert("È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ"));
                        } catch (e) {
                            (console.error("[ChatSettings] ‰øùÂ≠òÈ¢ÑËÆæÂ§±Ë¥•:", e),
                                alert("‰øùÂ≠òÂ§±Ë¥•Ôºö" + e.message));
                        }
                });
            const r = document.getElementById("chat-bubble-restore-btn");
            r &&
                r.addEventListener("click", function () {
                    ((document.getElementById("chat-bubble-css-input").value = ""),
                        alert("Â∑≤ÊÅ¢Â§çÈªòËÆ§Ê†∑ÂºèÔºå‰øùÂ≠òÂêéÁîüÊïà"));
                });
            const l = document.getElementById("save-group-settings-btn");
            l &&
                l.addEventListener("click", async function () {
                    if (window.currentOpenGroup)
                        try {
                            const e = window.currentOpenGroup;
                            ((e.avatarSettings = {
                                show: document
                                    .getElementById("group-show-avatars-toggle")
                                    ?.classList.contains("active"),
                            }),
                                (e.timestampSettings = {
                                    show: document
                                        .getElementById("group-show-timestamp-toggle")
                                        ?.classList.contains("active"),
                                }));
                            const t = await window.dbHelper.loadData(
                                "groupChats",
                                "allGroupChats",
                            );
                            let n = t ? t.value : [];
                            const a = n.findIndex((t) => t.id === e.id);
                            if (a > -1)
                                ((n[a] = e),
                                    await window.dbHelper.saveData(
                                        "groupChats",
                                        "allGroupChats",
                                        n,
                                    ),
                                    console.log("[GroupSettings] Group saved to DB:", e.id));
                            else {
                                console.error(
                                    "[GroupSettings] Error: Current group not found in DB loading list. ID:",
                                    e.id,
                                );
                                const t = n.findIndex((t) => String(t.id) === String(e.id));
                                if (!(t > -1))
                                    return void alert("‰øùÂ≠òÂ§±Ë¥•ÔºöÊï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞ËØ•Áæ§ÁªÑ„ÄÇ");
                                ((n[t] = e),
                                    await window.dbHelper.saveData(
                                        "groupChats",
                                        "allGroupChats",
                                        n,
                                    ),
                                    console.log(
                                        "[GroupSettings] Group saved to DB (type coerced):",
                                        e.id,
                                    ));
                            }
                            const o = document.getElementById("chat-messages-container");
                            (o &&
                                (e.chatBackground
                                    ? ((o.style.backgroundImage = `url('${e.chatBackground}')`),
                                        (o.style.backgroundSize = "cover"),
                                        (o.style.backgroundPosition = "center"),
                                        (o.style.backgroundRepeat = "no-repeat"))
                                    : ((o.style.backgroundImage = ""),
                                        (o.style.backgroundSize = ""),
                                        (o.style.backgroundPosition = ""),
                                        (o.style.backgroundRepeat = "")),
                                    e.avatarSettings && !1 === e.avatarSettings.show
                                        ? o.classList.add("hide-avatars")
                                        : o.classList.remove("hide-avatars"),
                                    e.timestampSettings && !0 === e.timestampSettings.show
                                        ? o.classList.remove("hide-timestamps")
                                        : o.classList.add("hide-timestamps")),
                                alert("Áæ§ËÅäËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ"));
                            const s = document.getElementById("group-settings-page");
                            s && s.classList.remove("active");
                        } catch (e) {
                            (console.error("‰øùÂ≠òÁæ§ËÅäËÆæÁΩÆÂ§±Ë¥•:", e),
                                alert("‰øùÂ≠òÂ§±Ë¥•: " + e.message));
                        }
                });
        }
        console.log("[ChatSettingsPage] ÂçïËÅäËÆæÁΩÆÈ°µÈù¢ÂàùÂßãÂåñÂÆåÊàê");
        const g = document.getElementById("save-group-settings-btn");
        if (g) {
            const e = g.cloneNode(!0);
            (g.parentNode.replaceChild(e, g),
                e.addEventListener("click", async function () {
                    if (window.currentOpenGroup)
                        try {
                            const e = window.currentOpenGroup;
                            ((e.avatarSettings = {
                                show: document
                                    .getElementById("group-show-avatars-toggle")
                                    ?.classList.contains("active"),
                            }),
                                (e.timestampSettings = {
                                    show: document
                                        .getElementById("group-show-timestamp-toggle")
                                        ?.classList.contains("active"),
                                }));
                            const t = await window.dbHelper.loadData(
                                "groupChats",
                                "allGroupChats",
                            );
                            let n = t ? t.value : [];
                            const a = n.findIndex((t) => t.id === e.id);
                            if (a > -1)
                                ((n[a] = e),
                                    await window.dbHelper.saveData(
                                        "groupChats",
                                        "allGroupChats",
                                        n,
                                    ),
                                    console.log("[GroupSettings] Group saved to DB:", e.id));
                            else {
                                console.error(
                                    "[GroupSettings] Error: Current group not found in DB loading list. ID:",
                                    e.id,
                                );
                                const t = n.findIndex((t) => String(t.id) === String(e.id));
                                if (!(t > -1))
                                    return void alert("‰øùÂ≠òÂ§±Ë¥•ÔºöÊï∞ÊçÆÂ∫ì‰∏≠Êâæ‰∏çÂà∞ËØ•Áæ§ÁªÑ„ÄÇ");
                                ((n[t] = e),
                                    await window.dbHelper.saveData(
                                        "groupChats",
                                        "allGroupChats",
                                        n,
                                    ));
                            }
                            const o = document.getElementById("chat-messages-container");
                            (o &&
                                (e.chatBackground
                                    ? ((o.style.backgroundImage = `url('${e.chatBackground}')`),
                                        (o.style.backgroundSize = "cover"),
                                        (o.style.backgroundPosition = "center"),
                                        (o.style.backgroundRepeat = "no-repeat"))
                                    : ((o.style.backgroundImage = ""),
                                        (o.style.backgroundSize = ""),
                                        (o.style.backgroundPosition = ""),
                                        (o.style.backgroundRepeat = "")),
                                    e.avatarSettings && !1 === e.avatarSettings.show
                                        ? o.classList.add("hide-avatars")
                                        : o.classList.remove("hide-avatars"),
                                    e.timestampSettings && !0 === e.timestampSettings.show
                                        ? o.classList.remove("hide-timestamps")
                                        : o.classList.add("hide-timestamps")),
                                alert("Áæ§ËÅäËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÈÉ®ÂàÜÂäüËÉΩÈúÄÈÄÄÂá∫ÂÜçËøõÂÖ•ËÅäÂ§©ÁïåÈù¢ÁîüÊïàÔºÅÔºÅ"));
                            const s = document.getElementById("group-settings-page");
                            s && s.classList.remove("active");
                        } catch (e) {
                            (console.error("‰øùÂ≠òÁæ§ËÅäËÆæÁΩÆÂ§±Ë¥•:", e),
                                alert("‰øùÂ≠òÂ§±Ë¥•: " + e.message));
                        }
                }));
        }
        const y = document.getElementById("group-chat-bg-input");
        y &&
            y.addEventListener("change", async function (e) {
                console.log("[GroupSettings] Background input changed");
                const t = e.target.files[0];
                if (t)
                    if (((e.target.value = ""), window.currentOpenGroup))
                        try {
                            let n;
                            (window.iOSBabyMode &&
                                window.iOSBabyMode.enabled &&
                                t.size > 2097152
                                ? (window.iOSBabyMode.showProgressToast("Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...", 0),
                                    (n = await window.iOSBabyMode.safeCompressImage(t, {
                                        maxWidth: 1920,
                                        maxHeight: 1920,
                                        quality: 0.75,
                                        onProgress: (e) =>
                                            window.iOSBabyMode.showProgressToast(
                                                "Ê≠£Âú®Â§ÑÁêÜËÉåÊôØÂõæ...",
                                                e,
                                            ),
                                    })),
                                    window.iOSBabyMode.hideProgressToast())
                                : (n = window.iOSBabyMode
                                    ? await window.iOSBabyMode.safeReadFileAsDataURL(t)
                                    : await new Promise((e, n) => {
                                        const a = new FileReader();
                                        ((a.onload = (t) => e(t.target.result)),
                                            (a.onerror = n),
                                            a.readAsDataURL(t));
                                    })),
                                console.log(
                                    "[GroupSettings] Background loaded, length:",
                                    n.length,
                                ));
                            const a = document.getElementById("group-chat-bg-preview"),
                                o = document.getElementById("group-chat-bg-placeholder"),
                                s = document.getElementById("group-chat-bg-preview-box");
                            (a && ((a.src = n), (a.style.display = "block")),
                                o && (o.style.display = "none"),
                                s && s.classList.add("has-bg"),
                                (window.currentOpenGroup.chatBackground = n),
                                (window.currentOpenGroup.backgroundImage = n),
                                console.log(
                                    "[GroupSettings] currentOpenGroup.chatBackground set",
                                ));
                            try {
                                const e = await window.dbHelper.loadData(
                                    "groupChats",
                                    "allGroupChats",
                                );
                                let t = e ? e.value : [];
                                const a = t.findIndex(
                                    (e) => e.id === window.currentOpenGroup.id,
                                );
                                if (a > -1) {
                                    ((t[a] = window.currentOpenGroup),
                                        await window.dbHelper.saveData(
                                            "groupChats",
                                            "allGroupChats",
                                            t,
                                        ));
                                    const e = document.getElementById("chat-messages-container");
                                    e &&
                                        ((e.style.backgroundImage = `url('${n}')`),
                                            (e.style.backgroundSize = "cover"),
                                            (e.style.backgroundPosition = "center"));
                                }
                            } catch (e) {
                                console.error("AutoSave BG Failed", e);
                            }
                        } catch (e) {
                            (console.error("Áæ§ËÅäËÉåÊôØ‰∏ä‰º†Â§±Ë¥•:", e),
                                window.iOSBabyMode && window.iOSBabyMode.hideProgressToast(),
                                alert(
                                    `‚ùå ËÉåÊôØÂõæ‰∏ä‰º†Â§±Ë¥•\n\n${e.message || "ËØ∑Â∞ùËØïÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá"}`,
                                ));
                        }
                    else
                        console.error(
                            "[GroupSettings] currentOpenGroup is null during background upload",
                        );
            });
        const h = document.getElementById("group-clear-bg-btn");
        h &&
            h.addEventListener("click", function () {
                const e = document.getElementById("group-chat-bg-preview"),
                    t = document.getElementById("group-chat-bg-placeholder"),
                    n = document.getElementById("group-chat-bg-preview-box");
                (e && ((e.src = ""), (e.style.display = "none")),
                    t && (t.style.display = "flex"),
                    n && n.classList.remove("has-bg"),
                    window.currentOpenGroup &&
                    ((window.currentOpenGroup.chatBackground = null),
                        (window.currentOpenGroup.backgroundImage = null),
                        (async () => {
                            try {
                                const e = await window.dbHelper.loadData(
                                    "groupChats",
                                    "allGroupChats",
                                );
                                let t = e ? e.value : [];
                                const n = t.findIndex(
                                    (e) => e.id === window.currentOpenGroup.id,
                                );
                                if (n > -1) {
                                    ((t[n] = window.currentOpenGroup),
                                        await window.dbHelper.saveData(
                                            "groupChats",
                                            "allGroupChats",
                                            t,
                                        ));
                                    const e = document.getElementById("chat-messages-container");
                                    e && (e.style.backgroundImage = "");
                                }
                            } catch (e) {
                                console.error("AutoSave Clear BG Failed", e);
                            }
                        })()));
            });
        const v = document.getElementById("group-clear-history-btn");
        v &&
            v.addEventListener("click", async function () {
                if (
                    window.currentOpenGroup &&
                    confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Áæ§ÁªÑËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ„ÄÇ")
                )
                    try {
                        ((window.currentOpenGroup.history = []),
                            (window.currentOpenGroup.lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"));
                        const e = await window.dbHelper.loadData(
                            "groupChats",
                            "allGroupChats",
                        );
                        let t = e ? e.value : [];
                        const n = t.findIndex((e) => e.id === window.currentOpenGroup.id);
                        n > -1 &&
                            ((t[n].history = []),
                                (t[n].lastMessage = "ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"),
                                await window.dbHelper.saveData("groupChats", "allGroupChats", t));
                        const a = document.getElementById("chat-messages-container");
                        (a && (a.innerHTML = ""), alert("ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫"));
                    } catch (e) {
                        (console.error(e), alert("Êìç‰ΩúÂ§±Ë¥•"));
                    }
            });
        const f = document.getElementById("group-delete-btn");
        (f &&
            f.addEventListener("click", async function () {
                if (window.currentOpenGroup && confirm("Á°ÆÂÆöË¶ÅËß£Êï£Âπ∂Âà†Èô§ËØ•Áæ§ËÅäÂêóÔºü"))
                    try {
                        const e = window.currentOpenGroup.id,
                            t = await window.dbHelper.loadData("groupChats", "allGroupChats");
                        const n = (t ? t.value : []).filter((t) => t.id !== e);
                        (await window.dbHelper.saveData("groupChats", "allGroupChats", n),
                            document
                                .getElementById("group-settings-page")
                                ?.classList.remove("active"),
                            document
                                .getElementById("chat-screen")
                                ?.classList.remove("active"),
                            "function" == typeof loadChatGroups
                                ? loadChatGroups()
                                : window.location.reload());
                    } catch (e) {
                        (console.error(e), alert("Êìç‰ΩúÂ§±Ë¥•"));
                    }
            }),
            console.log("[ChatSettingsPage] Áæ§ËÅäÂäüËÉΩË°•ÂÖ®ÂÆåÊØï"));
    }),
    (window.openChatSettingsPage = async function () {
        if (!window.currentOpenContact) return;
        console.log("[openChatSettingsPage] ÊâìÂºÄÂçïËÅäËÆæÁΩÆÈ°µÈù¢");
        const e = document.getElementById("chat-settings-page");
        if (!e) return void console.error("chat-settings-page not found");
        const t = window.currentOpenContact,
            n = document.getElementById("chat-settings-avatar"),
            a = document.getElementById("chat-settings-name");
        (n && (n.style.backgroundImage = `url('${t.ai.avatar}')`),
            a && (a.textContent = t.ai.name));
        const o = document.getElementById("chat-role-tab-ai"),
            s = document.getElementById("chat-role-tab-user"),
            i = document.getElementById("chat-ai-form"),
            r = document.getElementById("chat-user-form");
        (o && o.classList.add("active"),
            s && s.classList.remove("active"),
            i && (i.style.display = "block"),
            r && (r.style.display = "none"),
            (document.getElementById("chat-ai-name-input").value = t.ai.name || ""),
            (document.getElementById("chat-ai-persona-input").value =
                t.ai.persona || ""),
            (document.getElementById("chat-context-memory-input").value =
                t.contextMemory || 10),
            (document.getElementById("chat-user-name-input").value =
                t.user.name || ""),
            (document.getElementById("chat-user-persona-input").value =
                t.user.persona || ""));
        const l = document.getElementById("chat-user-avatar-preview");
        l && (l.style.backgroundImage = `url('${t.user.avatar}')`);
        const c = t.avatarSettings || {
            show: !0,
            radius: "50%",
        },
            d = t.timestampSettings || {
                show: !1,
            },
            u = {
                "chat-show-avatars-toggle": !1 !== c.show,
                "chat-show-timestamp-toggle": !0 === d.show,
                "chat-default-stickers-toggle": !1 !== t.enableDefaultStickers,
                "chat-monologue-toggle": !1 !== t.enableMonologue,
                "chat-bilingual-toggle": !0 === t.enableBilingualBubble,
                "chat-wb-stickers-toggle": !1 !== t.enableWBStickers,
            };
        (Object.entries(u).forEach(([e, t]) => {
            const n = document.getElementById(e);
            n && (t ? n.classList.add("active") : n.classList.remove("active"));
        }),
            (document.getElementById("chat-avatar-radius-input").value =
                c.radius || "50%"),
            (document.getElementById("chat-bubble-css-input").value =
                t.customBubbleCss || ""));
        const m = t.ai.avatarPendant || {
            url: "",
            css: "",
        },
            p = t.user.avatarPendant || {
                url: "",
                css: "",
            };
        ((document.getElementById("chat-ai-pendant-url").value = m.url || ""),
            (document.getElementById("chat-ai-pendant-css").value = m.css || ""),
            (document.getElementById("chat-user-pendant-url").value = p.url || ""),
            (document.getElementById("chat-user-pendant-css").value = p.css || ""));
        const g = document.getElementById("chat-bg-preview"),
            y = document.getElementById("chat-bg-placeholder"),
            h = document.getElementById("chat-bg-preview-box");
        t.chatBackground
            ? (g && ((g.src = t.chatBackground), (g.style.display = "block")),
                y && (y.style.display = "none"),
                h && h.classList.add("has-bg"))
            : (g && ((g.src = ""), (g.style.display = "none")),
                y && (y.style.display = "flex"),
                h && h.classList.remove("has-bg"));
        const v = document.getElementById("chat-tts-voice-input");
        v && (v.value = t.ttsVoiceId || "");
        const f = document.getElementById("chat-tts-language-input");
        f && (f.value = t.ttsLanguage || "");
        const w = document.getElementById("chat-block-btn");
        w && (w.textContent = t.isBlocked ? "Ëß£Èô§ÊãâÈªë" : "ÊãâÈªëËÅîÁ≥ª‰∫∫");
        const b = document.getElementById("chat-worldbook-select-container");
        (b &&
            "function" == typeof window.renderWorldBookMultiselect &&
            (await window.renderWorldBookMultiselect(b, t, !1)),
            e.querySelectorAll(".collapsible-section").forEach((e) => {
                (e.id && (e.id.includes("ai-form") || e.id.includes("user-form"))) ||
                    e.classList.remove("expanded");
            }),
            e.classList.add("active"));
    }),
    (window.renderWorldBookMultiselect = async function (e, t, n = !1) {
        if (e) {
            e.innerHTML =
                '<div style="padding:20px;text-align:center;color:#999;">Âä†ËΩΩ‰∏ñÁïå‰π¶Êï∞ÊçÆ...</div>';
            try {
                const a = await window.dbHelper.loadData("worldBooks", "allWorldBooks"),
                    o = await window.dbHelper.loadData("worldBookGroups", "allGroups"),
                    s = a && Array.isArray(a.value) ? a.value : [],
                    i = o && Array.isArray(o.value) ? o.value : [];
                t.linkedWorldBookIds || (t.linkedWorldBookIds = []);
                const r = new Set(t.linkedWorldBookIds);
                e.innerHTML = "";
                const l = (e) =>
                    "book" === e
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>'
                        : "chevron" === e
                            ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>'
                            : "check" === e
                                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                                : "";
                if (0 === i.length && 0 === s.length)
                    return void (e.innerHTML =
                        '<div style="padding:30px;text-align:center;color:#999;font-size:13px;">ÊöÇÊó†‰∏ñÁïå‰π¶ÔºåËØ∑ÂÖàÂéªÂàõÂª∫</div>');
                const c = async () => {
                    if (((t.linkedWorldBookIds = Array.from(r)), n && t.id))
                        try {
                            if (t.members && Array.isArray(t.members)) {
                                const e = await window.dbHelper.loadData(
                                    "groupChats",
                                    "allGroupChats",
                                ),
                                    n = e ? e.value : [],
                                    a = n.findIndex((e) => e.id === t.id);
                                a > -1 &&
                                    ((n[a] = t),
                                        await window.dbHelper.saveData(
                                            "groupChats",
                                            "allGroupChats",
                                            n,
                                        ),
                                        console.log("[WB] Group Saved"));
                            } else if (t.ai && t.user) {
                                const e = await window.dbHelper.loadData(
                                    "messageContacts",
                                    "allContacts",
                                ),
                                    n = e ? e.value : [],
                                    a = n.findIndex((e) => e.id === t.id);
                                a > -1 &&
                                    ((n[a] = t),
                                        await window.dbHelper.saveData(
                                            "messageContacts",
                                            "allContacts",
                                            n,
                                        ),
                                        console.log("[WB] Contact Saved"));
                            }
                        } catch (e) {
                            console.error("[WB] AutoSave Error", e);
                        }
                };
                i.forEach((t) => {
                    const n = s.filter((e) => (t.bookIds || []).includes(e.id));
                    if (0 === n.length) return;
                    const a = document.createElement("div");
                    a.className = "wb-group-card";
                    const o = n.every((e) => r.has(e.id)),
                        i = n.reduce((e, t) => e + (r.has(t.id) ? 1 : 0), 0);
                    a.innerHTML = `\n                <div class="wb-group-header">\n                    <div class="wb-group-info">\n                        <div class="wb-group-icon">${l("book")}</div>\n                        <div class="wb-group-name">${t.name} <span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${i}/${n.length})</span></div>\n                    </div>\n                    <div class="wb-group-actions">\n                        <button class="wb-select-all-btn">${o ? "ÂÖ®Ê∂à" : "ÂÖ®ÈÄâ"}</button>\n                        <div class="wb-expand-icon">${l("chevron")}</div>\n                    </div>\n                </div>\n                <div class="wb-group-content">\n                    \x3c!-- Books go here --\x3e\n                </div>\n            `;
                    const d = a.querySelector(".wb-group-header"),
                        u = a.querySelector(".wb-group-content"),
                        m =
                            (a.querySelector(".wb-expand-icon"),
                                a.querySelector(".wb-select-all-btn")),
                        p = a.querySelector(".wb-group-name span");
                    ((d.onclick = (e) => {
                        e.target !== m && a.classList.toggle("expanded");
                    }),
                        (m.onclick = async () => {
                            "ÂÖ®Ê∂à" === m.textContent
                                ? (n.forEach((e) => r.delete(e.id)), (m.textContent = "ÂÖ®ÈÄâ"))
                                : (n.forEach((e) => r.add(e.id)), (m.textContent = "ÂÖ®Ê∂à"));
                            u.querySelectorAll(".wb-item-row").forEach((e) => {
                                const t = parseInt(e.dataset.id);
                                r.has(t)
                                    ? e.classList.add("selected")
                                    : e.classList.remove("selected");
                            });
                            const e = n.reduce((e, t) => e + (r.has(t.id) ? 1 : 0), 0);
                            ((p.textContent = `(${e}/${n.length})`), await c());
                        }),
                        n.forEach((e) => {
                            const t = document.createElement("div");
                            ((t.className = "wb-item-row"),
                                r.has(e.id) && t.classList.add("selected"),
                                (t.dataset.id = e.id),
                                (t.innerHTML = `\n                    <div class="wb-checkbox-custom">${l("check")}</div>\n                    <div class="wb-item-name">${e.name}</div>\n                `),
                                (t.onclick = async (a) => {
                                    (a.stopPropagation(),
                                        r.has(e.id)
                                            ? (r.delete(e.id), t.classList.remove("selected"))
                                            : (r.add(e.id), t.classList.add("selected")));
                                    const o = n.reduce((e, t) => e + (r.has(t.id) ? 1 : 0), 0);
                                    p.textContent = `(${o}/${n.length})`;
                                    const s = n.every((e) => r.has(e.id));
                                    ((m.textContent = s ? "ÂÖ®Ê∂à" : "ÂÖ®ÈÄâ"), await c());
                                }),
                                u.appendChild(t));
                        }),
                        e.appendChild(a));
                });
                const d = new Set();
                i.forEach((e) => (e.bookIds || []).forEach((e) => d.add(e)));
                const u = s.filter((e) => !d.has(e.id));
                if (u.length > 0) {
                    const t = document.createElement("div");
                    t.className = "wb-group-card";
                    const n = u.reduce((e, t) => e + (r.has(t.id) ? 1 : 0), 0);
                    t.innerHTML = `\n                <div class="wb-group-header">\n                    <div class="wb-group-info">\n                        <div class="wb-group-icon" style="background:#E0E0E0;color:#888;">${l("book")}</div>\n                        <div class="wb-group-name">Êú™ÂàÜÁ±ª <span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${n}/${u.length})</span></div>\n                    </div>\n                    <div class="wb-expand-icon">${l("chevron")}</div>\n                </div>\n                <div class="wb-group-content"></div>\n            `;
                    const a = t.querySelector(".wb-group-content");
                    t.querySelector(".wb-group-header").onclick = () => {
                        t.classList.toggle("expanded");
                    };
                    const o = t.querySelector(".wb-group-name span");
                    (u.forEach((e) => {
                        const t = document.createElement("div");
                        ((t.className = "wb-item-row"),
                            r.has(e.id) && t.classList.add("selected"),
                            (t.innerHTML = `\n                    <div class="wb-checkbox-custom">${l("check")}</div>\n                    <div class="wb-item-name">${e.name}</div>\n                `),
                            (t.onclick = async () => {
                                r.has(e.id)
                                    ? (r.delete(e.id), t.classList.remove("selected"))
                                    : (r.add(e.id), t.classList.add("selected"));
                                const n = u.reduce((e, t) => e + (r.has(t.id) ? 1 : 0), 0);
                                ((o.textContent = `(${n}/${u.length})`), await c());
                            }),
                            a.appendChild(t));
                    }),
                        e.appendChild(t));
                }
            } catch (t) {
                (console.error("Render WB Multiselect Failed", t),
                    (e.innerHTML =
                        '<div style="color:red;padding:20px;">Âä†ËΩΩÂ§±Ë¥•</div>'));
            }
        }
    }),
    document.addEventListener("DOMContentLoaded", function () {
        if ("undefined" != typeof lucide) {
            /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                ("MacIntel" === navigator.platform && navigator.maxTouchPoints > 1)
                ? setTimeout(() => {
                    "requestIdleCallback" in window
                        ? requestIdleCallback(
                            () => {
                                (console.log("[Performance] Lazy loading Lucide icons..."),
                                    lucide.createIcons());
                            },
                            {
                                timeout: 2e3,
                            },
                        )
                        : lucide.createIcons();
                }, 500)
                : lucide.createIcons();
        }
        const e = document.getElementById("settings-screen");
        if (e && !window._lucideSettingsObserver) {
            let t = null;
            ((window._lucideSettingsObserver = new IntersectionObserver(
                (e) => {
                    e.forEach((e) => {
                        e.isIntersecting &&
                            "undefined" != typeof lucide &&
                            (t && clearTimeout(t),
                                (t = setTimeout(() => {
                                    (lucide.createIcons(),
                                        console.log(
                                            "[Performance] Icons rendered via IntersectionObserver",
                                        ));
                                }, 100)));
                    });
                },
                {
                    threshold: 0.1,
                },
            )),
                window._lucideSettingsObserver.observe(e));
        }
    }),
    (window.resetWallpaper = async function () {
        if (confirm("Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§Â£ÅÁ∫∏ÂêóÔºü"))
            try {
                (await dbHelper.saveData("settingsStore", "homeWallpaper", null),
                    "undefined" != typeof homeScreen &&
                    (homeScreen.style.backgroundImage = ""));
                const e = document.getElementById("settings-wallpaper-preview-bg");
                (e && (e.style.backgroundImage = ""), alert("Â£ÅÁ∫∏Â∑≤ÊÅ¢Â§çÈªòËÆ§"));
            } catch (e) {
                console.error("Reset wallpaper failed", e);
            }
    }),
    (window.resetSkin = function () {
        if (confirm("Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§ÊâãÊú∫Â§ñÂ£≥ÂêóÔºü"))
            try {
                (window.ImageStore
                    ? window.ImageStore.remove("userDeviceSkin")
                    : localStorage.removeItem("userDeviceSkin"),
                    localStorage.removeItem("deviceSkinConfig"));
                const e = document.getElementById("device-skin-layer");
                (e && e.remove(), alert("ÊâãÊú∫Â∑≤ÊÅ¢Â§çÈªòËÆ§Â§ñËßÇ"));
            } catch (e) {
                console.error("Reset skin failed", e);
            }
    }),
    (window.restoreDefaultFont = async function () {
        if (confirm("Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§Â≠ó‰ΩìÂêóÔºü"))
            try {
                await dbHelper.saveData("settingsStore", "customFont", null);
                const e = document.getElementById("custom-font-style");
                (e && e.remove(), alert("Â≠ó‰ΩìÂ∑≤ÊÅ¢Â§çÈªòËÆ§"));
            } catch (e) {
                console.error("Reset font failed", e);
            }
    }),
    (window.handleSkinUpload = function (e) {
        const t = e.target.files[0];
        if (!t) return;
        const n = new FileReader();
        ((n.onload = function (e) {
            const t = e.target.result;
            (localStorage.setItem("userDeviceSkin", t),
                applySkin(t),
                alert("ÁöÆËÇ§Êõ¥Êç¢ÊàêÂäüÔºÅ"));
        }),
            n.readAsDataURL(t));
    }),
    (window.applySkin = function (e) {
        let t = document.getElementById("device-skin-layer");
        if (!t) {
            ((t = document.createElement("div")), (t.id = "device-skin-layer"));
            const e = document.querySelector(".phone-frame");
            e &&
                (e.appendChild(t),
                    (t.style.position = "absolute"),
                    (t.style.inset = "0"),
                    (t.style.pointerEvents = "none"),
                    (t.style.zIndex = "999"),
                    (t.style.backgroundSize = "100% 100%"),
                    (t.style.backgroundRepeat = "no-repeat"));
        }
        t &&
            ((t.style.backgroundImage = `url('${e}')`), (t.style.display = "block"));
    }),
    document.addEventListener("DOMContentLoaded", () => {
        const e = document.getElementById("offline-msg-toggle"),
            t = document.getElementById("offline-server-container"),
            n = document.getElementById("offline-dnd-container"),
            a = document.getElementById("offline-push-container"),
            o = document.getElementById("offline-service-url"),
            s = document.getElementById("offline-quiet-start"),
            i = document.getElementById("offline-quiet-end"),
            r = document.getElementById("push-permission-status"),
            l = document.getElementById("request-push-permission-btn"),
            c = document.getElementById("test-push-container"),
            d = document.getElementById("test-offline-push-btn"),
            u = document.getElementById("reset-push-service-btn");
        u &&
            u.addEventListener("click", async () => {
                if (
                    confirm(
                        "This will reset the push notification service and reload the app. Continue?",
                    )
                ) {
                    ((u.textContent = "Resetting..."), (u.disabled = !0));
                    try {
                        const e = await navigator.serviceWorker.getRegistrations();
                        for (let t of e)
                            (await t.unregister(),
                                console.log("[OfflineLife] SW unregistered:", t));
                        if ("caches" in window) {
                            const e = await caches.keys();
                            for (let t of e)
                                (t.includes("qiqi-phone-cache") || t.includes("precache")) &&
                                    (await caches.delete(t));
                        }
                        (alert("Reset complete. App will reload now."),
                            location.reload(!0));
                    } catch (e) {
                        (console.error("Reset failed:", e),
                            alert("Reset failed: " + e.message),
                            (u.textContent = "Reset Failed"));
                    }
                }
            });
        const m =
            "BCZ-HV6B5DpdYLTKW_OlWt-ZoZ666xBgsG__5xNDHwX8rSn-e71W89VP4yOmDCbMPBpmyEBUdueCeIAIVeWD1XU";
        if (e) {
            const v = JSON.parse(localStorage.getItem("offlineLifeConfig") || "{}");

            function p(e) {
                e
                    ? (t && (t.style.display = "block"),
                        n && (n.style.display = "block"),
                        a && (a.style.display = "block"),
                        y())
                    : (t && (t.style.display = "none"),
                        n && (n.style.display = "none"),
                        a && (a.style.display = "none"));
            }

            function g() {
                const t = {
                    enabled: e.checked,
                    serverUrl: o.value.trim(),
                    quietStart: s.value,
                    quietEnd: i.value,
                };
                (localStorage.setItem("offlineLifeConfig", JSON.stringify(t)),
                    console.log("[OfflineLife] Config saved:", t));
            }
            async function y() {
                if (!("Notification" in window))
                    return (
                        r && (r.textContent = "Not Supported"),
                        void (l && (l.style.display = "none"))
                    );
                const e = Notification.permission;
                if ("granted" === e) {
                    (await (async function () {
                        if (!("serviceWorker" in navigator) || !("PushManager" in window))
                            return !1;
                        try {
                            const e = await navigator.serviceWorker.ready;
                            return !!(await e.pushManager.getSubscription());
                        } catch (e) {
                            return (
                                console.warn("[OfflineLife] Failed to check subscription:", e),
                                !1
                            );
                        }
                    })())
                        ? (r &&
                            ((r.textContent = "‚úì Subscribed"), (r.style.color = "#34C759")),
                            l &&
                            ((l.textContent = "Subscribed"),
                                (l.style.backgroundColor = "#34C759"),
                                (l.style.color = "white"),
                                (l.disabled = !0)),
                            c && (c.style.display = "block"))
                        : (r && (r.textContent = "Authorized, tap to subscribe"),
                            l && (l.textContent = "Subscribe"),
                            c && (c.style.display = "none"));
                } else
                    "denied" === e
                        ? (r &&
                            ((r.textContent = "‚úó Blocked (check browser settings)"),
                                (r.style.color = "#FF3B30")),
                            l &&
                            ((l.textContent = "Blocked"),
                                (l.disabled = !0),
                                (l.style.opacity = "0.5")),
                            c && (c.style.display = "none"))
                        : (r && (r.textContent = "Not enabled"),
                            l && (l.textContent = "Enable"),
                            c && (c.style.display = "none"));
            }

            function h(e) {
                const t = (e + "=".repeat((4 - (e.length % 4)) % 4))
                    .replace(/-/g, "+")
                    .replace(/_/g, "/"),
                    n = window.atob(t),
                    a = new Uint8Array(n.length);
                for (let e = 0; e < n.length; ++e) a[e] = n.charCodeAt(e);
                return a;
            }
            ((e.checked = v.enabled || !1),
                (o.value = v.serverUrl || ""),
                (s.value = v.quietStart || "23:00"),
                (i.value = v.quietEnd || "08:00"),
                p(e.checked),
                e.addEventListener("change", (e) => {
                    (p(e.target.checked), g());
                }),
                [o, s, i].forEach((e) => {
                    e && (e.addEventListener("change", g), e.addEventListener("blur", g));
                }),
                l &&
                l.addEventListener("click", async () => {
                    ((l.disabled = !0),
                        (l.textContent = "Enabling..."),
                        await (async function () {
                            try {
                                if (
                                    (console.log("[OfflineLife] Starting push subscription..."),
                                        !("serviceWorker" in navigator))
                                )
                                    throw new Error("Service Worker not supported");
                                if (!("PushManager" in window))
                                    throw new Error("Push notifications not supported");
                                console.log(
                                    "[OfflineLife] Requesting notification permission...",
                                );
                                const e = await Notification.requestPermission();
                                if (
                                    (console.log("[OfflineLife] Permission result:", e),
                                        "granted" !== e)
                                )
                                    return (
                                        console.log(
                                            "[OfflineLife] Notification permission denied",
                                        ),
                                        y(),
                                        !1
                                    );
                                console.log("[OfflineLife] Waiting for service worker...");
                                const t = navigator.serviceWorker.ready,
                                    n = new Promise((e, t) =>
                                        setTimeout(
                                            () => t(new Error("Service Worker ready timeout (5s)")),
                                            5e3,
                                        ),
                                    ),
                                    a = await Promise.race([t, n]);
                                console.log("[OfflineLife] Service worker ready:", a);
                                let o = await a.pushManager.getSubscription();
                                o
                                    ? console.log(
                                        "[OfflineLife] Using existing subscription:",
                                        o,
                                    )
                                    : (console.log(
                                        "[OfflineLife] Creating new push subscription...",
                                    ),
                                        console.log(
                                            "[OfflineLife] Using VAPID key:",
                                            m.substring(0, 20) + "...",
                                        ),
                                        (o = await a.pushManager.subscribe({
                                            userVisibleOnly: !0,
                                            applicationServerKey: h(m),
                                        })),
                                        console.log(
                                            "[OfflineLife] Push subscription created:",
                                            o,
                                        ));
                                const s = o.toJSON();
                                console.log(
                                    "[OfflineLife] Subscription data:",
                                    JSON.stringify(s).substring(0, 100) + "...",
                                );
                                const i = new Set();
                                (window.currentOpenContact?.id &&
                                    i.add(window.currentOpenContact.id),
                                    window.Global_AllContactsCache &&
                                    Array.isArray(window.Global_AllContactsCache) &&
                                    window.Global_AllContactsCache.forEach((e) => {
                                        e.id && i.add(e.id);
                                    }),
                                    0 === i.size && i.add("default_user"),
                                    console.log(
                                        "[OfflineLife] Registering for IDs:",
                                        Array.from(i),
                                    ));
                                const r = Array.from(i).map((e) =>
                                    fetch("/api/offline-life/subscribe", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                        },
                                        body: JSON.stringify({
                                            contactId: e,
                                            subscription: s,
                                        }),
                                    })
                                        .then((t) =>
                                            t.ok
                                                ? {
                                                    id: e,
                                                    status: "ok",
                                                }
                                                : {
                                                    id: e,
                                                    status: "failed",
                                                    code: t.status,
                                                },
                                        )
                                        .catch((t) => ({
                                            id: e,
                                            status: "error",
                                            error: t,
                                        })),
                                ),
                                    l = await Promise.all(r);
                                if (
                                    (console.log("[OfflineLife] Subscription results:", l),
                                        !l.some((e) => "ok" === e.status))
                                ) {
                                    const e = l.map((e) => `${e.id}: ${e.status}`).join(", ");
                                    throw new Error(
                                        "All subscription attempts failed. Details: " + e,
                                    );
                                }
                                return (
                                    console.log(
                                        "[OfflineLife] Subscription saved (at least one valid)",
                                    ),
                                    y(),
                                    !0
                                );
                            } catch (e) {
                                return (
                                    console.error("[OfflineLife] Push subscription failed:", e),
                                    console.error("[OfflineLife] Error stack:", e.stack),
                                    r &&
                                    ((r.textContent =
                                        "Error: " + (e.message || "Unknown error")),
                                        (r.style.color = "#FF3B30")),
                                    l &&
                                    ((l.textContent = "Retry"),
                                        (l.disabled = !1),
                                        (l.style.backgroundColor = "#FF3B30"),
                                        (l.style.color = "white")),
                                    !1
                                );
                            }
                        })());
                }),
                d &&
                d.addEventListener("click", async function () {
                    d && ((d.disabled = !0), (d.textContent = "Sending..."));
                    try {
                        const e = window.currentOpenContact?.id || "default_user";
                        if (
                            !(
                                await fetch("/api/offline-life/test-push", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        contactId: e,
                                    }),
                                })
                            ).ok
                        )
                            throw new Error("Test push failed");
                        d &&
                            ((d.textContent = "‚úì Sent!"),
                                setTimeout(() => {
                                    ((d.innerHTML =
                                        '<i data-lucide="bell-ring" class="w-4 h-4"></i> Send Test Notification'),
                                        (d.disabled = !1),
                                        window.lucide && lucide.createIcons());
                                }, 2e3));
                    } catch (e) {
                        (console.error("[OfflineLife] Test push failed:", e),
                            d &&
                            ((d.textContent = "‚úó Failed"),
                                setTimeout(() => {
                                    ((d.innerHTML =
                                        '<i data-lucide="bell-ring" class="w-4 h-4"></i> Send Test Notification'),
                                        (d.disabled = !1),
                                        window.lucide && lucide.createIcons());
                                }, 2e3)));
                    }
                }),
                e.checked && y());
        }
    }),
    document.addEventListener("DOMContentLoaded", function () {
        console.log("[LittleWorld Integration] ÂàùÂßãÂåñÈõÜÊàêÈí©Â≠ê...");

        // === Èò≤ÊäñÂíåËäÇÊµÅÊú∫Âà∂ ===
        let lwDebounceTimer = null;
        let lwThrottleTime = 0;
        const LW_DEBOUNCE_MS = 500;
        const LW_THROTTLE_MS = 1000;

        const debouncedLWUpdate = async (contact) => {
            clearTimeout(lwDebounceTimer);
            lwDebounceTimer = setTimeout(async () => {
                if (!window.LittleWorld) return;
                try {
                    window.LittleWorld.incrementCount();
                    // ÂºÇÊ≠•ÊâßË°å checkTriggerÔºåÈÅøÂÖçÈòªÂ°û‰∏ªÁ∫øÁ®ã
                    if (typeof requestIdleCallback !== "undefined") {
                        requestIdleCallback(
                            async () => {
                                await window.LittleWorld.checkTrigger(contact);
                                console.log("[LittleWorld Integration] Ê∂àÊÅØÂ∑≤ËÆ°Êï∞ÔºàÂºÇÊ≠•Ôºâ");
                            },
                            { timeout: 2000 },
                        );
                    } else {
                        setTimeout(async () => {
                            await window.LittleWorld.checkTrigger(contact);
                            console.log("[LittleWorld Integration] Ê∂àÊÅØÂ∑≤ËÆ°Êï∞ÔºàÂºÇÊ≠•Ôºâ");
                        }, 100);
                    }
                } catch (e) {
                    console.warn("[LittleWorld Integration] ÈõÜÊàêÊõ¥Êñ∞Â§±Ë¥•:", e);
                }
            }, LW_DEBOUNCE_MS);
        };

        window.addEventListener("messageSent", async function (e) {
            const t = e.detail?.contact || window.currentOpenContact;
            if (t && window.LittleWorld) {
                await debouncedLWUpdate(t);
            }
        });

        window.triggerLittleWorldCount = async function (e) {
            if (!window.LittleWorld) return;
            // ËäÇÊµÅÔºöÈÅøÂÖçÂêå‰∏ÄÊó∂Èó¥Â§öÊ¨°Ë∞ÉÁî®
            const now = Date.now();
            if (now - lwThrottleTime < LW_THROTTLE_MS) {
                console.log("[LittleWorld] Ëß¶ÂèëËøá‰∫éÈ¢ëÁπÅÔºåÂ∑≤ËäÇÊµÅ");
                return;
            }
            lwThrottleTime = now;
            await debouncedLWUpdate(e || window.currentOpenContact);
        };

        console.log("[LittleWorld Integration] ÈõÜÊàêÈí©Â≠êÂàùÂßãÂåñÂÆåÊàê");
    }));
