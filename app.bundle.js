;
/* === GLOBAL_MENU_FIX.min.js === */
!function(){"use strict";function n(){let n=document.getElementById("msg-action-menu");if(n){const t=document.querySelector(".phone-frame");t&&n.parentElement!==t&&(console.log("[鑿滃崟淇] 灏嗚彍鍗曠Щ鍒板叏灞€浣嶇疆"),t.appendChild(n),n.classList.add("global-menu"))}else console.log("[鑿滃崟淇] 鍒涘缓鍏ㄥ眬鑿滃崟"),function(){const n=document.querySelector(".phone-frame");if(!n)return void console.error("[鑿滃崟淇] 鎵句笉鍒皃hone-frame");const t=document.createElement("div");t.id="msg-action-menu",t.className="global-menu",t.innerHTML='\n            <button class="action-menu-btn" id="menu-reply-btn">\n              <svg width="20" height="20" viewBox="0 0 28 28" fill="none">\n                <path d="M12.4492 24.4922C13.2461 24.4922 13.8203 23.9062 13.8203 23.1211V18.6445H14.1602C18.707 18.6445 21.5664 19.793 23.6172 23.625C24.0273 24.375 24.5664 24.4922 25.0586 24.4922C25.6797 24.4922 26.2656 23.9297 26.2656 22.9219C26.2656 14.2617 22.5977 8.85938 14.1602 8.85938H13.8203V4.42969C13.8203 3.64453 13.2461 3 12.4258 3C11.8516 3 11.4648 3.24609 10.8438 3.83203L1.59766 12.4805C1.14062 12.9141 1 13.3477 1 13.7461C1 14.1328 1.15234 14.5781 1.59766 15L10.8438 23.7305C11.4062 24.2578 11.875 24.4922 12.4492 24.4922ZM11.7812 21.9727C11.7109 21.9727 11.6406 21.9375 11.582 21.8672L3.22656 13.9688C3.13281 13.875 3.09766 13.8164 3.09766 13.7461C3.09766 13.6758 3.13281 13.6055 3.22656 13.5234L11.5703 5.51953C11.6289 5.47266 11.6992 5.42578 11.7695 5.42578C11.875 5.42578 11.9336 5.49609 11.9336 5.58984V10.2422C11.9336 10.5117 12.0625 10.6289 12.332 10.6289H13.9023C21.9414 10.6289 24.3672 16.207 24.6016 21.7383C24.6016 21.832 24.5664 21.8672 24.5078 21.8672C24.4609 21.8672 24.4375 21.832 24.4023 21.75C23.0195 18.8086 19.4688 16.875 13.9023 16.875H12.332C12.0625 16.875 11.9336 16.9922 11.9336 17.2617V21.7969C11.9336 21.9023 11.875 21.9727 11.7812 21.9727Z" fill="white" fill-opacity="0.85"/>\n              </svg>\n              <span>寮曠敤</span>\n            </button>\n            \n            <button class="action-menu-btn" id="menu-select-btn">\n              <svg width="20" height="20" viewBox="0 0 28 28" fill="none">\n                <path d="M14.6055 21.5352H26.3711C26.8633 21.5352 27.2734 21.1484 27.2734 20.6562C27.2734 20.1523 26.8633 19.7656 26.3711 19.7656H14.6055C14.1133 19.7656 13.7148 20.1523 13.7148 20.6562C13.7148 21.1484 14.1133 21.5352 14.6055 21.5352Z" fill="white" fill-opacity="0.85"/>\n                <path d="M6.05078 25.707C8.80469 25.707 11.1016 23.4102 11.1016 20.6562C11.1016 17.8789 8.80469 15.5938 6.05078 15.5938C3.28516 15.5938 1 17.8906 1 20.6562C1 23.4102 3.29688 25.707 6.05078 25.707ZM6.05078 23.996C4.23438 23.996 2.71094 22.4609 2.71094 20.6562C2.71094 18.8398 4.24609 17.3047 6.05078 17.3047C7.85547 17.3047 9.39062 18.8398 9.39062 20.6562C9.39062 22.4609 7.85547 23.996 6.05078 23.996Z" fill="white" fill-opacity="0.85"/>\n                <path d="M14.6055 7.98828H26.3711C26.8633 7.98828 27.2734 7.60156 27.2734 7.09766C27.2734 6.60547 26.8633 6.21875 26.3711 6.21875H14.6055C14.1133 6.21875 13.7148 6.60547 13.7148 7.09766C13.7148 7.60156 14.1133 7.98828 14.6055 7.98828Z" fill="white" fill-opacity="0.85"/>\n                <path d="M6.05078 12.1367C8.80469 12.1367 11.1016 9.85156 11.1016 7.09766C11.1016 4.33203 8.80469 2.03516 6.05078 2.03516C3.28516 2.03516 1 4.33203 1 7.09766C1 9.85156 3.29688 12.1367 6.05078 12.1367ZM5.45312 9.80469C5.20703 9.80469 5.04297 9.67578 4.86719 9.47656L3.55469 7.89453C3.4375 7.76562 3.40234 7.625 3.40234 7.4375C3.40234 7.09766 3.66016 6.82812 3.97656 6.82812C4.19922 6.82812 4.36328 6.92188 4.51562 7.12109L5.42969 8.28125L7.51562 4.92969C7.65625 4.71875 7.83203 4.60156 8.04297 4.60156C8.37109 4.60156 8.65234 4.85938 8.65234 5.15234C8.65234 5.31641 8.60547 5.45703 8.5 5.63281L6.05078 9.47656C5.92188 9.6875 5.71094 9.80469 5.45312 9.80469Z" fill="white" fill-opacity="0.85"/>\n              </svg>\n              <span>澶氶€?/span>\n            </button>\n\n            <button class="action-menu-btn" id="menu-copy-btn">\n              <svg width="20" height="20" viewBox="0 0 28 30" fill="none">\n                <path d="M20.1301 3.08969C19.7082 0.675623 18.302 -0.320471 15.9231 0.0896854L5.03637 2.01156C2.65746 2.43344 1.67309 3.83969 2.09496 6.26547L4.87231 22.0389C5.3059 24.4295 6.71215 25.4373 9.09106 25.0272L19.9778 23.1053C22.345 22.6834 23.3411 21.2655 22.9075 18.8514L20.1301 3.08969ZM18.2903 3.44125L21.0442 19.1444C21.2434 20.2928 20.7512 21.0545 19.5559 21.2655L8.85668 23.1522C7.66137 23.3631 6.93481 22.8241 6.72387 21.6756L3.95824 5.9725C3.75902 4.81234 4.26293 4.06234 5.45824 3.8514L16.1457 1.96469C17.3411 1.75375 18.0676 2.28109 18.2903 3.44125Z" fill="white" fill-opacity="0.85"/>\n                <path d="M26.7864 9.69898C26.7864 7.24976 25.5793 6.01929 23.1536 6.01929H12.1028C9.68872 6.01929 8.46997 7.24976 8.46997 9.69898V25.7068C8.46997 28.156 9.68872 29.3865 12.1028 29.3865H23.1536C25.5676 29.3865 26.7864 28.156 26.7864 25.7068V9.69898Z" fill="white"/>\n                <path d="M26.7864 9.69898C26.7864 7.24976 25.5793 6.01929 23.1536 6.01929H12.1028C9.68872 6.01929 8.46997 7.24976 8.46997 9.69898V25.7068C8.46997 28.156 9.68872 29.3865 12.1028 29.3865H23.1536C25.5676 29.3865 26.7864 28.156 26.7864 25.7068V9.69898ZM24.8996 9.73414V25.6833C24.8996 26.8318 24.2786 27.4997 23.0598 27.4997H12.2082C10.9895 27.4997 10.3567 26.8318 10.3567 25.6833V9.73414C10.3567 8.56226 10.9895 7.90601 12.2082 7.90601H23.0598C24.2786 7.90601 24.8996 8.56226 24.8996 9.73414Z" fill="white" fill-opacity="0.85"/>\n              </svg>\n              <span>澶嶅埗</span>\n            </button>\n            \n            <button class="action-menu-btn" id="menu-delete-btn">\n              <svg width="20" height="20" viewBox="0 0 28 29" fill="none">\n                <path d="M10.875 22.3242C11.3203 22.3242 11.6133 22.043 11.6016 21.6328L11.2383 9.09375C11.2266 8.68359 10.9336 8.41406 10.5117 8.41406C10.0664 8.41406 9.77344 8.69531 9.78516 9.10547L10.1367 21.6328C10.1484 22.0547 10.4414 22.3242 10.875 22.3242ZM14.3438 22.3242C14.7891 22.3242 15.1055 22.043 15.1055 21.6328V9.10547C15.1055 8.69531 14.7891 8.41406 14.3438 8.41406C13.8984 8.41406 13.5938 8.69531 13.5938 9.10547V21.6328C13.5938 22.043 13.8984 22.3242 14.3438 22.3242ZM17.8242 22.3242C18.2461 22.3242 18.5391 22.0547 18.5508 21.6328L18.9023 9.10547C18.9141 8.69531 18.6211 8.41406 18.1758 8.41406C17.7539 8.41406 17.4609 8.68359 17.4492 9.10547L17.0977 21.6328C17.0859 22.043 17.3789 22.3242 17.8242 22.3242ZM9.19922 5.35547H11.0625V2.84766C11.0625 2.17969 11.5312 1.74609 12.2344 1.74609H16.4297C17.1328 1.74609 17.6016 2.17969 17.6016 2.84766V5.35547H19.4648V2.73047C19.4648 1.03125 18.3633 0 16.5586 0H12.1055C10.3008 0 9.19922 1.03125 9.19922 2.73047V5.35547ZM3.87891 6.29297H24.8203C25.3008 6.29297 25.6875 5.88281 25.6875 5.40234C25.6875 4.92188 25.3008 4.52344 24.8203 4.52344H3.87891C3.41016 4.52344 3 4.92188 3 5.40234C3 5.89453 3.41016 6.29297 3.87891 6.29297ZM8.97656 26.0977H19.7227C21.3984 26.0977 22.5234 25.0078 22.6055 23.332L23.4258 6.07031H21.5391L20.7539 23.1328C20.7305 23.8359 20.2266 24.3281 19.5352 24.3281H9.14062C8.47266 24.3281 7.96875 23.8242 7.93359 23.1328L7.10156 6.07031H5.26172L6.09375 23.3438C6.17578 25.0195 7.27734 26.0977 8.97656 26.0977Z" fill="white" fill-opacity="1"/>\n              </svg>\n              <span>鍒犻櫎</span>\n            </button>\n        ',n.appendChild(t),console.log("[鑿滃崟淇] 鍏ㄥ眬鑿滃崟宸插垱寤?)}()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n()}();
;
/* === api-switcher.min.js === */
!function(){"use strict";let e={isOpen:!1,currentApiId:null,currentModel:null,apiLibrary:[],modelList:[],isConnecting:!1},t=0;function i(){if(document.getElementById("api-switcher-overlay"))return;const t=document.createElement("div");t.id="api-switcher-overlay",t.className="api-switcher-overlay",t.innerHTML='\n      <div class="api-switcher-panel" id="api-switcher-panel">\n        <div class="api-switcher-handle"></div>\n        \n        <div class="api-switcher-header">\n          <div class="api-switcher-title">API Center</div>\n          <div class="api-switcher-status" id="api-switcher-status">\n            <div class="api-switcher-status-dot disconnected" id="api-switcher-status-dot"></div>\n            <span id="api-switcher-status-text">鏈繛鎺?/span>\n          </div>\n        </div>\n\n        <div>\n          <div class="api-switcher-section-label">API 閰嶇疆</div>\n          <div class="api-switcher-grid" id="api-switcher-grid">\n            \x3c!-- API 鎸夐挳灏嗗湪杩欓噷鍔ㄦ€佺敓鎴?--\x3e\n          </div>\n        </div>\n\n        <div>\n          <div class="api-switcher-section-label">閫夋嫨妯″瀷</div>\n          <div class="api-switcher-model-container">\n            <div class="api-switcher-loader" id="api-switcher-loader" style="display: none;"></div>\n            <div class="api-switcher-model-list" id="api-switcher-model-list">\n              <div class="api-switcher-empty">璇峰厛閫夋嫨涓€涓?API 閰嶇疆</div>\n            </div>\n          </div>\n        </div>\n\n        <button class="api-switcher-done-btn" id="api-switcher-done-btn">瀹屾垚</button>\n      </div>\n    ',document.body.appendChild(t),function(t){const i=document.getElementById("api-switcher-panel"),n=document.getElementById("api-switcher-done-btn"),s=document.getElementById("api-switcher-grid"),d=document.getElementById("api-switcher-model-list");t.addEventListener("click",e=>{e.target===t&&a()}),i.addEventListener("click",e=>{e.stopPropagation()}),n.addEventListener("click",a),s.addEventListener("click",t=>{const i=t.target.closest(".api-switcher-btn");if(i){!async function(t){if(e.isConnecting)return;const i=e.apiLibrary.find(e=>e.id===t);if(!i)return;e.currentApiId=t,c(),await r(i)}(parseInt(i.dataset.apiId,10))}}),d.addEventListener("click",t=>{const i=t.target.closest(".api-switcher-model-item");if(i){!async function(t){e.currentModel=t;const i=document.getElementById("api-switcher-model-list");i&&i.querySelectorAll(".api-switcher-model-item").forEach(e=>{e.classList.toggle("selected",e.dataset.modelId===t)});await async function(){const t=e.apiLibrary.find(t=>t.id===e.currentApiId);if(!t)return;const i=e.currentModel;try{const n=document.getElementById("api-url"),a=document.getElementById("api-key"),s=document.getElementById("api-model"),c=document.getElementById("temperature-slider"),r=document.getElementById("temperature-value");if(n&&(n.value=t.url),a&&(a.value=t.key),s){s.querySelector(`option[value="${i}"]`)||(s.innerHTML+=`<option value="${i}">${i}</option>`),s.value=i,s.disabled=!1;const e=document.getElementById("model-display-name"),t=document.getElementById("model-display-desc");e&&(e.textContent=i),t&&(t.textContent="Active Model")}if(c&&void 0!==t.temperature){c.value=t.temperature,r&&(r.textContent=t.temperature.toFixed(1));const e=new Event("input",{bubbles:!0});c.dispatchEvent(e)}const d={url:t.url,key:t.key,model:i,temperature:t.temperature||1};await window.dbHelper.saveData("settingsStore","apiSettings",d),t.lastUsed=(new Date).toISOString(),await window.dbHelper.saveData("settingsStore","apiLibrary",e.apiLibrary),console.log("[API Switcher] 閰嶇疆宸插簲鐢?",t.name,i)}catch(e){console.error("[API Switcher] 搴旂敤閰嶇疆澶辫触:",e)}}()}(i.dataset.modelId)}})}(t)}function n(){document.getElementById("api-switcher-overlay")||i(),async function(){try{if(!window.dbHelper)return console.warn("[API Switcher] dbHelper 涓嶅彲鐢?),void(e.apiLibrary=[]);const t=await window.dbHelper.loadData("settingsStore","apiLibrary");e.apiLibrary=t&&Array.isArray(t.value)?t.value:[];const i=await window.dbHelper.loadData("settingsStore","apiSettings");if(i&&i.value){const t=i.value;e.currentApiSettings=t}console.log("[API Switcher] 鍔犺浇浜?,e.apiLibrary.length,"涓?API 閰嶇疆")}catch(t){console.error("[API Switcher] 鍔犺浇 API 搴撳け璐?",t),e.apiLibrary=[]}}().then(()=>{!function(){const t=document.getElementById("api-switcher-grid");if(!t)return;if(0===e.apiLibrary.length)return void(t.innerHTML='\n        <div class="api-switcher-empty" style="grid-column: 1 / -1;">\n          鏆傛棤 API 閰嶇疆<br>\n          <span style="font-size: 12px; opacity: 0.7;">璇峰湪璁剧疆涓坊鍔?API 閰嶇疆</span>\n        </div>\n      ');const i=e.apiLibrary.slice(0,6);t.innerHTML=i.map(t=>{const i=t.id===e.currentApiId,n=function(e){const t=(e||"").toLowerCase();return t.includes("openai")||t.includes("gpt")?"GPT":t.includes("claude")||t.includes("anthropic")?"ANTHTOPIC":t.includes("gemini")||t.includes("google")?"GOOGLE":t.includes("local")||t.includes("ollama")?"OLLAMA":t.includes("deepseek")?"DEEPSEEK":t.includes("qwen")||t.includes("閫氫箟")?"TONGYI":"API"}(t.name);return`\n        <div class="api-switcher-btn ${i?"active":""}" data-api-id="${t.id}">\n          <div class="api-switcher-btn-icon">${n}</div>\n          <div class="api-switcher-btn-label">${t.name}</div>\n        </div>\n      `}).join("")}(),async function(){if(e.currentApiSettings){const t=e.currentApiSettings.url,i=e.currentApiSettings.model,n=e.apiLibrary.find(e=>e.url===t);n&&(e.currentApiId=n.id,e.currentModel=i,c(),await r(n))}}()}),document.getElementById("api-switcher-overlay").classList.add("active"),e.isOpen=!0,console.log("[API Switcher] 宸叉墦寮€")}function a(){const t=document.getElementById("api-switcher-overlay");t&&t.classList.remove("active"),e.isOpen=!1,console.log("[API Switcher] 宸插叧闂?)}function s(){e.isOpen?a():n()}function c(){const t=document.getElementById("api-switcher-grid");t&&t.querySelectorAll(".api-switcher-btn").forEach(t=>{const i=parseInt(t.dataset.apiId,10);t.classList.toggle("active",i===e.currentApiId)})}async function r(t){const i=document.getElementById("api-switcher-loader"),n=document.getElementById("api-switcher-model-list"),a=document.getElementById("api-switcher-status-dot"),s=document.getElementById("api-switcher-status-text");e.isConnecting=!0,i&&(i.style.display="block"),n&&(n.innerHTML=""),a&&(a.className="api-switcher-status-dot connecting"),s&&(s.textContent="杩炴帴涓?..");try{let i=t.url;i.endsWith("/")&&(i=i.slice(0,-1)),i+="/models";const n=await fetch(i,{headers:{Authorization:`Bearer ${t.key}`}});if(!n.ok)throw new Error(`HTTP ${n.status}`);const c=(await n.json()).data||[];e.modelList=c,a&&(a.className="api-switcher-status-dot connected"),s&&(s.textContent="宸茶繛鎺?),function(t,i){const n=document.getElementById("api-switcher-model-list");if(!n)return;if(!t||0===t.length)return void(n.innerHTML='\n        <div class="api-switcher-empty">\n          娌℃湁鎵惧埌鍙敤妯″瀷\n        </div>\n      ');n.innerHTML=t.map(t=>{const n=t.id||t.name||t;return`\n        <div class="api-switcher-model-item ${n===i||n===e.currentModel?"selected":""}" data-model-id="${n}">\n          <span class="api-switcher-model-name">${n}</span>\n          <div class="api-switcher-model-check"></div>\n        </div>\n      `}).join(""),i&&(e.currentModel=i)}(c,t.model)}catch(e){console.error("[API Switcher] 杩炴帴澶辫触:",e),a&&(a.className="api-switcher-status-dot disconnected"),s&&(s.textContent="杩炴帴澶辫触"),n&&(n.innerHTML=`\n          <div class="api-switcher-empty" style="color: #ff3b30;">\n            杩炴帴澶辫触<br>\n            <span style="font-size: 12px; opacity: 0.7;">${e.message}</span>\n          </div>\n        `)}finally{i&&(i.style.display="none"),e.isConnecting=!1}}function d(e){let i,n;e.type.startsWith("touch")&&e.changedTouches&&e.changedTouches[0]?(i=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY):(i=e.clientX||0,n=e.clientY||0),e.preventDefault(),e.stopPropagation();const a=Date.now(),c=a-t;c<300&&c>0?(t=0,s()):t=a}function o(){setTimeout(()=>{i(),function(){const e=document.querySelector(".content-mask");if(!e)return void console.warn("[API Switcher] 鎵句笉鍒?.content-mask");if(document.getElementById("status-bar-touch-area"))return;const t=document.createElement("div");t.id="status-bar-touch-area",t.className="status-bar-touch-area",e.appendChild(t),t.addEventListener("touchend",d),t.addEventListener("click",d),console.log("[API Switcher] 鐘舵€佹爮鍙屽嚮妫€娴嬪凡鍚敤")}()},500)}window.ApiSwitcher={open:n,close:a,toggle:s},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()}();
;
/* === littleworld.min.js === */
!function(){"use strict";const t=100,e=50,n="settingsStore";let i=null,s=null;function o(){return"lw_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function l(t){const e=Date.now()-t;if(e<6e4)return"鍒氬垰";if(e<36e5)return Math.floor(e/6e4)+"鍒嗛挓鍓?;if(e<864e5)return Math.floor(e/36e5)+"灏忔椂鍓?;const n=new Date(t);return`${n.getMonth()+1}/${n.getDate()} ${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`}function a(t){let e=document.getElementById("lw-toast");e||(e=document.createElement("div"),e.id="lw-toast",e.className="lw-toast",document.body.appendChild(e)),e.textContent=t,e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),2e3)}async function r(t,e){if(window.dbHelper&&t)try{await window.dbHelper.saveData(n,`littleWorld_${t}`,e)}catch(t){console.error("[LittleWorld] 淇濆瓨鏁版嵁澶辫触:",t)}}function c(){s=null,i=null;const t=document.getElementById("lw-moments-list"),e=document.getElementById("lw-subtexts-list");t&&(t.innerHTML=""),e&&(e.innerHTML=""),console.log("[LittleWorld] 缂撳瓨宸叉竻鐞?)}async function d(t){if(!t||!t.id)return void console.error("[LittleWorld] 鏃犳晥鐨勮仈绯讳汉");c(),i=t.id;const e=t.history?t.history.length:0;let o=await async function(t){if(!window.dbHelper)return console.warn("[LittleWorld] dbHelper鏈氨缁?),null;try{const e=await window.dbHelper.loadData(n,`littleWorld_${t}`);return e?e.value:null}catch(t){return console.error("[LittleWorld] 鍔犺浇鏁版嵁澶辫触:",t),null}}(t.id);if(o){const n=Math.max(0,e-o.baseCount);n>o.incrementCount&&(o.incrementCount=n,await r(t.id,o))}else o=function(t=0){return{baseCount:t,incrementCount:0,moments:[],subtexts:[],lastMomentTrigger:0,lastSubtextTrigger:0,installedAt:Date.now()}}(e),console.log("[LittleWorld] 棣栨瀹夎锛宐aseCount:",e),await r(t.id,o);s=o,u(t),console.log("[LittleWorld] 鍒濆鍖栧畬鎴愶紝娑堟伅鏁?",e,"baseCount:",o.baseCount,"increment:",o.incrementCount),await y(t),u(t)}function u(n){!function(e){const n=document.getElementById("lw-moments-list");if(!n)return;if(n.innerHTML="",!s)return void(n.innerHTML='<div class="lw-empty-state"><h3>鍔犺浇涓?..</h3></div>');if(!s.moments||0===s.moments.length){const e=t-(s.incrementCount||0)%t;return void(n.innerHTML=`\n                <div class="lw-empty-state">\n                    <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>\n                    <h3>鏆傛棤鍔ㄦ€?/h3>\n                    <p>鍐嶈亰 ${e} 鏉℃秷鎭?br>瑙ｉ攣鏂板姩鎬?/p>\n                </div>\n            `)}s.moments.forEach((t,o)=>{const a=function(t,e,n){const o=document.createElement("div");o.className="lw-moment-card",o.dataset.momentId=t.id;const a=n%2==0?"":"purple",c=e.ai?.avatar||"https://api.dicebear.com/7.x/notionists/svg?seed=AI",d=e.ai?.name||"AI";o.innerHTML=`\n            <div class="lw-washi-tape ${a}"></div>\n            <div class="lw-user-header">\n                <div class="lw-avatar" style="background-image: url('${c}')"></div>\n                <div class="lw-user-meta">\n                    <h3>${d}</h3>\n                    <p>${l(t.timestamp)}</p>\n                </div>\n            </div>\n            <div class="lw-moment-content">${t.content}</div>\n            <div class="lw-action-row">\n                <button class="lw-action-btn ${t.liked?"active":""}" data-action="like">\n                    <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>\n                    <span>${t.likeCount||0}</span>\n                </button>\n                <button class="lw-action-btn" data-action="comment">\n                    <svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>\n                    <span>${t.comments?.length||0} 鏉″洖澶?/span>\n                </button>\n            </div>\n        `,o.addEventListener("click",n=>{n.target.closest(".lw-action-btn")||function(t,e){const n=document.getElementById("lw-detail-overlay"),i=document.getElementById("lw-detail-content");if(!n||!i)return;const s=e.ai?.avatar||"",o=e.ai?.name||"AI";e.user;i.innerHTML=`\n            <div class="lw-moment-card" style="margin-bottom:0; box-shadow:none; border:1px solid #F0F0F0;">\n                <div class="lw-user-header">\n                    <div class="lw-avatar" style="background-image: url('${s}')"></div>\n                    <div class="lw-user-meta">\n                        <h3>${o}</h3>\n                        <p>${l(t.timestamp)}</p>\n                    </div>\n                </div>\n                <div class="lw-moment-content">${t.content}</div>\n            </div>\n            <div class="lw-comments-wrap">\n                <div class="lw-comments-header">${t.comments?.length||0} 鏉″洖澶?/div>\n                <div id="lw-comments-list"></div>\n                <div class="lw-comment-input-wrap">\n                    <input type="text" class="lw-comment-input" id="lw-comment-input" placeholder="鍐欒瘎璁?..">\n                    <button class="lw-comment-send-btn" id="lw-comment-send">\n                        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>\n                    </button>\n                </div>\n            </div>\n        `,m(t,e);const a=document.getElementById("lw-comment-send"),r=document.getElementById("lw-comment-input");a.addEventListener("click",()=>v(t,e,r.value)),r.addEventListener("keypress",n=>{"Enter"===n.key&&v(t,e,r.value)}),n.classList.add("open")}(t,e)});const u=o.querySelector('[data-action="like"]');return u.addEventListener("click",e=>{e.stopPropagation(),function(t){t.liked=!t.liked,t.likeCount=(t.likeCount||0)+(t.liked?1:-1),t.likeCount<0&&(t.likeCount=0);r(i,s)}(t),u.classList.toggle("active"),u.querySelector("span").textContent=t.likeCount||0}),o}(t,e,o);n.appendChild(a)})}(n),function(){const t=document.getElementById("lw-subtexts-list");if(!t)return;if(t.innerHTML='<div class="lw-subtext-intro">鉁?瑙ｉ攣瀵硅瘽鑳屽悗鐨勭湡瀹炴兂娉?鉁?/div>',!s)return void(t.innerHTML+='<div class="lw-empty-state"><h3>鍔犺浇涓?..</h3></div>');if(!s.subtexts||0===s.subtexts.length){const n=e-(s.incrementCount||0)%e;return void(t.innerHTML+=`\n                <div class="lw-empty-state">\n                    <svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>\n                    <h3>鏆傛棤瑷€澶栦箣鎰?/h3>\n                    <p>鍐嶈亰 ${n} 鏉℃秷鎭?br>瑙ｉ攣蹇冨０</p>\n                </div>\n            `)}s.subtexts.forEach(e=>{const n=function(t){const e=document.createElement("div");e.className="lw-secret-card",t.unlocked?e.innerHTML=`\n                <div class="lw-secret-cover">\n                    <div class="lw-quote-mark">"</div>\n                    <div class="lw-public-text">${t.originalQuote}</div>\n                </div>\n                <div class="lw-rip-line"></div>\n                <div class="lw-secret-inner">\n                    <div class="lw-tag-pill">LOG: HIDDEN_MEANING</div>\n                    <div class="lw-inner-text">${t.hiddenMeaning}</div>\n                </div>\n            `:e.innerHTML=`\n                <div class="lw-secret-cover">\n                    <div class="lw-quote-mark">"</div>\n                    <div class="lw-public-text">${t.originalQuote}</div>\n                </div>\n                <div class="lw-rip-line"></div>\n                <div class="lw-locked-layer">\n                    <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>\n                    <span>鍐嶈亰 ${Math.max(0,t.unlockAt-s.incrementCount)} 鏉¤В閿佸績澹?/span>\n                </div>\n            `;return e}(e);t.appendChild(n)})}()}function m(t,e){const n=document.getElementById("lw-comments-list");if(!n)return;if(n.innerHTML="",!t.comments||0===t.comments.length)return;const i=e.user?.avatar||"",s=e.ai?.avatar||"",o=e.ai?.name||"AI";t.comments.forEach(t=>{const e="user"===t.sender,a=document.createElement("div");a.className="lw-comment-item "+(e?"is-me":"");let r="";t.replies&&t.replies.length>0&&(r=t.replies.map(t=>`\n                    <div class="lw-nested-reply">\n                        <div class="lw-c-avatar" style="background-image: url('${"user"===t.sender?i:s}')"></div>\n                        <div class="lw-c-box">\n                            <div class="lw-c-bubble ${"ai"===t.sender?"ai-reply":""}">${t.text}</div>\n                            <div class="lw-c-meta"><span>${"user"===t.sender?"鎴?:o}</span> 路 <span>${l(t.timestamp)}</span></div>\n                        </div>\n                    </div>\n                `).join("")),a.innerHTML=`\n                <div class="lw-thread-line"></div>\n                <div class="lw-c-avatar" style="background-image: url('${e?i:s}')"></div>\n                <div class="lw-c-box">\n                    <div class="lw-c-bubble">${t.text}</div>\n                    <div class="lw-c-meta"><span>${e?"鎴?:o}</span> 路 <span>${l(t.timestamp)}</span></div>\n                    ${r}\n                </div>\n            `,n.appendChild(a)})}async function v(t,e,n){if(!n.trim())return;const l=document.getElementById("lw-comment-input");l&&(l.value="");const c={id:o(),sender:"user",text:n.trim(),timestamp:Date.now(),replies:[]};t.comments||(t.comments=[]),t.comments.push(c),await r(i,s),m(t,e),function(){const t=document.getElementById("lw-comments-list");if(!t)return;const e=document.createElement("div");e.id="lw-typing",e.className="lw-typing-indicator",e.innerHTML='<span>姝ｅ湪杈撳叆涓?/span><div class="dot"></div><div class="dot"></div><div class="dot"></div>',t.appendChild(e),t.scrollTop=t.scrollHeight}();try{const l=await async function(t,e,n){const i=`浣犳槸${t.ai?.name||"AI"}锛屼綘鍙戝竷浜嗕竴鏉″姩鎬侊細"${e.content.substring(0,100)}"\n\n鐢ㄦ埛璇勮璇达細"${n}"\n\n璇蜂互浣犵殑浜鸿韬唤锛岀畝鐭€佷繌鐨湴鍥炲杩欐潯璇勮锛?-2鍙ヨ瘽锛夛細`;return await f(t,i)}(e,t,n);c.replies.push({id:o(),sender:"ai",text:l,timestamp:Date.now()}),await r(i,s),g(),m(t,e)}catch(t){console.error("[LittleWorld] AI鍥炲澶辫触:",t),g(),a("AI鍥炲澶辫触")}}function g(){const t=document.getElementById("lw-typing");t&&t.remove()}async function w(t){const e=(t.history||[]).slice(-10),n=t.ai?.persona||"",i=t.ai?.name||"AI",s=`瑙掕壊鎵紨锛氫綘鏄?${i}"銆俓n浠诲姟锛氬彂甯冧竴鏉″績鎯呭姩鎬侊紙绫讳技鏈嬪弸鍦堬級銆俓n\n浣犵殑浜鸿锛?{n.substring(0,200)}\n鏈€杩戠殑瀵硅瘽鐗囨锛?{e.slice(-5).map(t=>`${"ai"===t.sender?i:"鐢ㄦ埛"}: ${t.text?.substring(0,60)||""}`).join("\n")}\n\n瑙勫垯锛歕n1. 鐩存帴杈撳嚭鍔ㄦ€佸唴瀹癸紝绂佹浠讳綍鍓嶇紑銆佹爣棰樸€佸紩鍙穃n2. 50-100瀛楋紝鏈夋儏鎰熸湁瓒ｅ懗\n3. 绗竴浜虹О\n4. 鍙互閫忛湶灏忕瀵嗘垨骞曞悗鑺辩诞`;return h(await f(t,s))}async function p(t,e=[]){let n=(t.history||[]).slice(-50).filter(t=>"ai"===t.sender&&t.text&&t.text.length>15);if(0===n.length)return null;if(e.length>0&&(n=n.filter(t=>{const n=t.text.substring(0,50);return!e.some(t=>t.includes(n)||n.includes(t.substring(0,50)))})),0===n.length)return null;let i=n[Math.floor(Math.random()*n.length)].text.substring(0,120);if(i.length>=120){const t=Math.max(i.lastIndexOf("銆?),i.lastIndexOf("锛?),i.lastIndexOf("锛?),i.lastIndexOf("."),i.lastIndexOf("?"),i.lastIndexOf("!"));t>30?i=i.substring(0,t+1):i+="..."}const s=`瑙掕壊鎵紨锛氫綘鏄?${t.ai?.name||"AI"}"銆俓n浠诲姟锛氶拡瀵逛綘璇磋繃鐨勪竴鍙ヨ瘽锛屽啓鍑哄綋鏃跺唴蹇冪殑鐪熷疄鎯虫硶锛堟綔鍙拌瘝锛夈€俓n\n浣犺鐨勮瘽锛?${i}"\n\n瑙勫垯锛歕n1. 鐩存帴杈撳嚭娼滃彴璇嶏紝绂佹浠讳綍鍓嶇紑銆佹爣棰樸€佸紩鍙穃n2. 20-40瀛楋紝绠€鐭繌鐨甛n3. 绗竴浜虹О\n4. 璇皵鍙互鍌插▏/瀹崇緸/璋冪毊/蹇冪棝/濮斿眻绛塡n\n绀轰緥杈撳嚭锛氬叾瀹炶杩欒瘽鐨勬椂鍊欐垜鑴搁兘绾簡锛屽笇鏈涗綘鑳芥噦鎴戠殑蹇冩剰鍟奰;let o=await f(t,s);return o=h(o),{originalQuote:i,hiddenMeaning:o}}function h(t){if(!t)return"锛堢绉樺井绗戯級";let e=t;if(e=e.replace(/<think>[\s\S]*?<\/think>/gi,""),e=e.replace(/<[^>]+>/g,""),e=e.replace(/\*\*([^*]+)\*\*/g,"$1"),e=e.replace(/\*([^*]+)\*/g,"$1"),e=e.replace(/^#+\s*/gm,""),e=e.replace(/^[-*]\s*/gm,""),e=e.replace(/^(娼滃彴璇峾鍐呭績鎯虫硶|鐪熷疄鎯虫硶|蹇冨０|鎴戠殑鎯虫硶)[锛?]\s*/i,""),e=e.replace(/^[>銆慭]]\s*/gm,""),e=e.replace(/^["銆屻€?']+|["銆嶃€?']+$/g,""),e=e.trim(),e.length<5)return"锛堝皬澹板榾鍜曠潃浠€涔堬級";if(e.length>100){const t=e.substring(0,100).lastIndexOf("銆?);e=t>30?e.substring(0,t+1):e.substring(0,80)+"..."}return e}async function f(t,e){try{const n=await window.dbHelper.loadData("settingsStore","apiSettings");if(!n||!n.value.url)return console.warn("[LittleWorld] API鏈厤缃紝浣跨敤妯℃嫙鍥炲"),b();const{url:i,key:s,model:o,temperature:l}=n.value;let a=i.endsWith("/")?i.slice(0,-1):i;a+="/chat/completions";const r=`浣犳槸${t.ai?.name||"AI"}銆?{t.ai?.persona||""}\n璇锋牴鎹互涓嬫寚浠ょ敓鎴愬唴瀹癸紝鐩存帴杈撳嚭缁撴灉锛屼笉瑕佸姞浠讳綍鍓嶇紑鎴栬В閲娿€俙,c=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({model:o||"gpt-3.5-turbo",messages:[{role:"system",content:r},{role:"user",content:e}],temperature:parseFloat(l)||.8,max_tokens:5e3})});if(!c.ok)throw new Error(`API璇锋眰澶辫触: ${c.status}`);const d=await c.json();let u=d.choices?.[0]?.message?.content;return u?(u=u.replace(/<think>[\s\S]*?<\/think>/gi,"").trim(),u=u.replace(/^\*\*.*?\*\*\s*/g,"").trim(),u=u.replace(/^[\s\n]+/,"").trim(),u.length<5?b():(console.log("[LittleWorld] AI鐢熸垚鎴愬姛:",u.substring(0,50)+"..."),u)):b()}catch(t){return console.error("[LittleWorld] AI璋冪敤澶辫触:",t),b()}}function b(){const t=["浠婂ぉ鐨勫績鎯呭儚澶╃┖涓€鏍疯摑~","鏈変簺璇濊棌鍦ㄥ績閲岋紝鍗存€绘兂璇寸粰浣犲惉","鍜屼綘鑱婂ぉ鐨勬瘡涓€鍒婚兘寰堢弽璐靛憿","鍢垮樋锛岃繖鏄垜浠箣闂寸殑灏忕瀵?,"姣忔鎯冲埌浣犻兘浼氫笉鑷鍦板井绗?];return t[Math.floor(Math.random()*t.length)]}async function y(n){if(!s||!n)return;const l=s.incrementCount;if(l>0&&l%t===0&&l!==s.lastMomentTrigger){s.lastMomentTrigger=l;try{const t=await w(n),e={id:o(),content:t,timestamp:Date.now(),likeCount:Math.floor(15*Math.random())+1,liked:!1,comments:[]};s.moments||(s.moments=[]),s.moments.unshift(e),await r(i,s),a("鏂板姩鎬佸凡鐢熸垚锛?)}catch(t){console.error("[LittleWorld] 鐢熸垚鍔ㄦ€佸け璐?",t)}}if(l>0&&l%e===0&&l!==s.lastSubtextTrigger){s.lastSubtextTrigger=l;try{const t=(s.subtexts||[]).map(t=>t.originalQuote),e=await p(n,t);e&&(s.subtexts||(s.subtexts=[]),s.subtexts.unshift({id:o(),originalQuote:e.originalQuote,hiddenMeaning:e.hiddenMeaning,unlocked:!0,timestamp:Date.now()}),await r(i,s),a("鏂扮殑瑷€澶栦箣鎰忓凡瑙ｉ攣锛?))}catch(t){console.error("[LittleWorld] 鐢熸垚瑷€澶栦箣鎰忓け璐?",t)}}}function L(){const t=document.getElementById("littleworld-overlay");t&&(t.classList.add("active"),t.classList.remove("closing")),window.currentOpenContact&&d(window.currentOpenContact)}function x(){const t=document.getElementById("littleworld-overlay");t&&(t.classList.add("closing"),setTimeout(()=>{t.classList.remove("active","closing"),c()},300))}function $(){document.addEventListener("click",t=>{t.target.closest(".bigworld-entry-btn")&&L()}),document.addEventListener("click",t=>{t.target.closest("#lw-back-btn")&&x(),t.target.closest("#lw-detail-back-btn")&&function(){const t=document.getElementById("lw-detail-overlay");t&&t.classList.remove("open")}()}),document.addEventListener("click",t=>{const e=t.target.closest(".lw-tab-btn");e&&e.dataset.lwTab&&function(t){document.querySelectorAll(".lw-tab-btn").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".lw-page-view").forEach(t=>t.classList.remove("active"));const e=document.querySelector(`[data-lw-tab="${t}"]`),n=document.getElementById(t);e&&e.classList.add("active"),n&&n.classList.add("active")}(e.dataset.lwTab)})}window.LittleWorld={init:d,open:L,close:x,incrementCount:function(){s&&(s.incrementCount++,r(i,s),console.log("[LittleWorld] 娑堟伅璁℃暟+1, 褰撳墠:",s.incrementCount))},checkTrigger:y,backgroundCheck:async function(n,i){if(!n||!i)return;const s=i.incrementCount;if(console.log("[LittleWorld] 鍚庡彴妫€鏌?increment:",s),s>0&&s%t===0&&s!==i.lastMomentTrigger){i.lastMomentTrigger=s;try{console.log("[LittleWorld] 鍚庡彴瑙﹀彂鍔ㄦ€佺敓鎴?..");const t=await w(n),e={id:o(),content:t,timestamp:Date.now(),likeCount:Math.floor(15*Math.random())+1,liked:!1,comments:[]};i.moments||(i.moments=[]),i.moments.unshift(e),await r(n.id,i),console.log("[LittleWorld] 鍚庡彴鍔ㄦ€佺敓鎴愭垚鍔燂紒")}catch(t){console.error("[LittleWorld] 鍚庡彴鐢熸垚鍔ㄦ€佸け璐?",t)}}if(s>0&&s%e===0&&s!==i.lastSubtextTrigger){i.lastSubtextTrigger=s;try{console.log("[LittleWorld] 鍚庡彴瑙﹀彂瑷€澶栦箣鎰忕敓鎴?..");const t=(i.subtexts||[]).map(t=>t.originalQuote),e=await p(n,t);e&&(i.subtexts||(i.subtexts=[]),i.subtexts.unshift({id:o(),originalQuote:e.originalQuote,hiddenMeaning:e.hiddenMeaning,unlocked:!0,timestamp:Date.now()}),await r(n.id,i),console.log("[LittleWorld] 鍚庡彴瑷€澶栦箣鎰忕敓鎴愭垚鍔燂紒"))}catch(t){console.error("[LittleWorld] 鍚庡彴鐢熸垚瑷€澶栦箣鎰忓け璐?",t)}}},clearCache:c},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",$):$(),console.log("[LittleWorld] 妯″潡宸插姞杞?)}();
;
/* === main.min.js === */
function openSettingsPage(e){const t=document.getElementById(e),n=document.getElementById("settings-main-view");t&&n&&(t.classList.add("active"),n.style.transform="scale(0.92) translateY(10px)",n.style.opacity="0.6",n.style.filter="grayscale(100%)","undefined"!=typeof lucide&&lucide.createIcons())}function closeSettingsPage(e){const t=document.getElementById(e),n=document.getElementById("settings-main-view");t&&n&&(t.classList.remove("active"),n.style.transform="scale(1) translateY(0)",n.style.opacity="1",n.style.filter="grayscale(0%)")}document.addEventListener("DOMContentLoaded",()=>{window.DEBUG_MODE=!1,window.debugLog=function(...e){window.DEBUG_MODE&&console.log(...e)},window.debugWarn=function(...e){window.DEBUG_MODE&&console.warn(...e)},window.debugError=function(...e){console.error(...e)};const e=/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,t=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;if(e&&document.body.classList.add("ios-optimize-mode"),e&&t&&(document.body.classList.add("is-ios-pwa"),debugLog("iOS PWA 妯″紡宸插惎鐢?)),e){document.addEventListener("visibilitychange",()=>{document.hidden?(debugLog("馃摫 iOS: 椤甸潰杩涘叆鍚庡彴锛屾墽琛屾縺杩涘唴瀛樻竻鐞?.."),window.currentTTSAudio&&(window.currentTTSAudio.pause(),window.currentTTSAudio.src="",window.currentTTSAudio=null),window.currentTTSAudioUrl&&(URL.revokeObjectURL(window.currentTTSAudioUrl),window.currentTTSAudioUrl=null),window.imageCache&&window.imageCache.clear&&window.imageCache.clear(),document.querySelectorAll("img[data-src]").forEach(e=>{e.src&&e.src.startsWith("data:")&&(e.dataset.cachedSrc=e.src,e.src="")}),document.querySelectorAll("canvas").forEach(e=>{if(null===e.offsetParent||"none"===window.getComputedStyle(e).display){const t=e.getContext("2d");t&&t.clearRect(0,0,e.width,e.height)}}),window.TimerManager&&(window.TimerManager.clear("voice-call"),window.TimerManager.clear("proactive"),window.TimerManager.clear("animation"))):(debugLog("馃摫 iOS: 椤甸潰鎭㈠鍓嶅彴"),document.querySelectorAll("img[data-cached-src]").forEach(e=>{e.dataset.cachedSrc&&(e.src=e.dataset.cachedSrc,delete e.dataset.cachedSrc)}))}),window.addEventListener("pagehide",e=>{debugLog("馃摫 iOS: pagehide 浜嬩欢瑙﹀彂锛屽交搴曟竻鐞?),window.TimerManager&&window.TimerManager.clearAll&&window.TimerManager.clearAll(),window._ttsDBConnection&&(window._ttsDBConnection.close(),window._ttsDBConnection=null)});let Qh=null;const ev=()=>{performance.memory?Qh||(Qh=setInterval(()=>{if(performance.memory){const e=Math.round(performance.memory.usedJSHeapSize/1024/1024),t=Math.round(performance.memory.jsHeapSizeLimit/1024/1024),n=e/t;if(n>.7&&(debugWarn(`鈿狅笍 iOS 鍐呭瓨璀﹀憡: 浣跨敤 ${e}MB / ${t}MB (${Math.round(100*n)}%)`),window.TTSCache&&window.TTSCache.cleanup&&window.TTSCache.cleanup(5)),n>.85){debugError("馃毃 iOS 鍐呭瓨鍗遍櫓: 鎵ц绱ф€ユ竻鐞?"),window.TTSCache&&window.TTSCache.clear&&window.TTSCache.clear();const e=document.querySelectorAll(".chat-bubble");if(e.length>100){for(let t=0;t<e.length-50;t++)e[t].remove();debugLog("馃摫 iOS: 娓呯悊浜嗘棫鑱婂ぉ姘旀场浠ラ噴鏀惧唴瀛?)}}}},6e4)):console.log("[鍐呭瓨鐩戞帶] 褰撳墠娴忚鍣ㄤ笉鏀寔 performance.memory,宸茶烦杩?)};"complete"===document.readyState?ev():window.addEventListener("load",ev),window.addEventListener("lowmemory",()=>{debugWarn("馃摫 iOS: 鏀跺埌浣庡唴瀛樹簨浠讹紒"),document.body.classList.add("low-memory-mode");const e=document.createElement("style");e.id="low-memory-style",e.textContent="\n                .low-memory-mode * {\n                    animation: none !important;\n                    transition: none !important;\n                }\n            ",document.getElementById("low-memory-style")||document.head.appendChild(e)})}const n={dbName:"AppImageStore",storeName:"images",version:1,_db:null,async getDB(){return this._db?this._db:new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.version);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName)},n.onsuccess=t=>{this._db=t.target.result,e(this._db)},n.onerror=e=>t(e.target.error)})},async get(e){try{const t=await this.getDB(),n=await new Promise((n,a)=>{const o=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);o.onsuccess=()=>n(o.result),o.onerror=()=>a(o.error)});if(n)return n;const a=localStorage.getItem(e);return a&&a.startsWith("data:image")?(debugLog(`[ImageStore] 杩佺Щ鏃ф暟鎹? ${e}`),this.set(e,a).then(()=>{localStorage.removeItem(e),debugLog(`[ImageStore] 杩佺Щ瀹屾垚锛屽凡鍒犻櫎localStorage鍓湰: ${e}`)}),a):null}catch(t){return console.warn("[ImageStore] IndexedDB failed, fallback to localStorage",t),localStorage.getItem(e)}},async set(e,t){try{const n=await this.getDB();return new Promise((a,o)=>{const s=n.transaction(this.storeName,"readwrite");s.objectStore(this.storeName).put(t,e),s.oncomplete=()=>a(),s.onerror=()=>o()})}catch(n){console.warn("[ImageStore] IndexedDB failed, fallback to localStorage",n),localStorage.setItem(e,t)}},async remove(e){try{const t=await this.getDB();return new Promise((n,a)=>{const o=t.transaction(this.storeName,"readwrite");o.objectStore(this.storeName).delete(e),o.oncomplete=()=>n(),o.onerror=()=>a()})}catch(e){console.warn("[ImageStore] Remove failed",e)}localStorage.removeItem(e)},async has(e){return!!await this.get(e)}};window.ImageStore=n;const a={enabled:e,CHUNK_THRESHOLD:2097152,CHUNK_SIZE:524288,YIELD_DELAY:50,IOS_BABY_MODE_PROMPTED:"ios_baby_mode_prompted_v1",showFirstTimePrompt(){this.enabled&&(localStorage.getItem(this.IOS_BABY_MODE_PROMPTED)||setTimeout(()=>{const e=document.createElement("div");e.id="ios-baby-mode-prompt",e.style.cssText="\n                    position: fixed;\n                    top: 0; left: 0; right: 0; bottom: 0;\n                    background: rgba(0,0,0,0.6);\n                    backdrop-filter: blur(10px);\n                    -webkit-backdrop-filter: blur(10px);\n                    z-index: 99999;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    padding: 20px;\n                ",e.innerHTML='\n                    <div style="\n                        background: #fff;\n                        border-radius: 24px;\n                        padding: 24px;\n                        max-width: 320px;\n                        text-align: center;\n                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n                    ">\n                        <div style="font-size: 48px; margin-bottom: 12px;">馃嵓</div>\n                        <h2 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #333;">\n                            iOS 瀹濆疂妯″紡宸插惎鐢╘n                        </h2>\n                        <p style="margin: 0 0 16px 0; font-size: 14px; color: #666; line-height: 1.5;">\n                            涓轰簡淇濊瘉绋冲畾鎬э紝鍦?iOS 璁惧涓婏細\n                        </p>\n                        <ul style="text-align: left; margin: 0 0 20px 0; padding-left: 20px; font-size: 13px; color: #555; line-height: 1.8;">\n                            <li>馃敆 鎺ㄨ崘浣跨敤<b>瀛椾綋URL</b>鍔犺浇瀛椾綋</li>\n                            <li>馃摝 澶ф枃浠朵細<b>鍒嗗潡澶勭悊</b>锛岀◢鎱絾鏇村畨鍏?/li>\n                            <li>馃柤锔?鍥剧墖浼氳嚜鍔?b>鍘嬬缉浼樺寲</b></li>\n                        </ul>\n                        <button id="ios-baby-mode-confirm" style="\n                            width: 100%;\n                            padding: 14px;\n                            background: #333;\n                            color: #fff;\n                            border: none;\n                            border-radius: 14px;\n                            font-size: 16px;\n                            font-weight: 600;\n                            cursor: pointer;\n                        ">鎴戞槸瀹濆疂</button>\n                    </div>\n                ',document.body.appendChild(e),document.getElementById("ios-baby-mode-confirm").addEventListener("click",()=>{localStorage.setItem(this.IOS_BABY_MODE_PROMPTED,"true"),e.style.opacity="0",e.style.transition="opacity 0.3s",setTimeout(()=>e.remove(),300)})},1500))},async safeReadFileAsDataURL(e,t=null){if(!this.enabled||e.size<this.CHUNK_THRESHOLD)return new Promise((t,n)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=n,a.readAsDataURL(e)});debugLog(`馃嵓 瀹濆疂妯″紡锛氬垎鍧楄鍙栧ぇ鏂囦欢 (${(e.size/1024/1024).toFixed(2)}MB)`);const n=[];let a=0;const o=Math.ceil(e.size/this.CHUNK_SIZE);for(let s=0;s<o;s++){const i=e.slice(a,a+this.CHUNK_SIZE),r=await i.arrayBuffer();n.push(new Uint8Array(r)),a+=this.CHUNK_SIZE,t&&t(Math.round((s+1)/o*100)),await new Promise(e=>setTimeout(e,this.YIELD_DELAY))}const s=n.reduce((e,t)=>e+t.length,0),i=new Uint8Array(s);let r=0;for(const e of n)i.set(e,r),r+=e.length,n[n.indexOf(e)]=null;await new Promise(e=>setTimeout(e,this.YIELD_DELAY));const l=this.uint8ArrayToBase64(i);return`data:${e.type||"application/octet-stream"};base64,${l}`},uint8ArrayToBase64(e){let t="";for(let n=0;n<e.length;n+=32768){const a=e.subarray(n,Math.min(n+32768,e.length));t+=String.fromCharCode.apply(null,a)}return btoa(t)},async safeCompressImage(e,t={}){const{maxWidth:n=1920,maxHeight:a=1920,quality:o=(this.enabled?.7:.85),onProgress:s=null}=t;return new Promise(async(t,i)=>{try{s&&s(10);const r=await this.safeReadFileAsDataURL(e,e=>{s&&s(10+.5*e)});s&&s(60);const l=new Image;l.onload=async()=>{try{await new Promise(e=>setTimeout(e,this.enabled?50:0)),s&&s(70);let{width:e,height:i}=l;if(e>n||i>a){const t=Math.min(n/e,a/i);e=Math.floor(e*t),i=Math.floor(i*t)}const r=document.createElement("canvas");r.width=e,r.height=i;r.getContext("2d").drawImage(l,0,0,e,i),s&&s(85),await new Promise(e=>setTimeout(e,this.enabled?30:0));const c=r.toDataURL("image/jpeg",o);r.width=0,r.height=0,s&&s(100),t(c)}catch(e){i(e)}},l.onerror=i,l.src=r}catch(e){i(e)}})},showProgressToast(e,t=null){let n=document.getElementById("ios-baby-progress-toast");n||(n=document.createElement("div"),n.id="ios-baby-progress-toast",n.style.cssText="\n                    position: fixed;\n                    bottom: 100px;\n                    left: 50%;\n                    transform: translateX(-50%);\n                    background: rgba(0,0,0,0.8);\n                    color: #fff;\n                    padding: 12px 24px;\n                    border-radius: 100px;\n                    font-size: 14px;\n                    z-index: 99998;\n                    display: flex;\n                    align-items: center;\n                    gap: 10px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n                ",document.body.appendChild(n)),n.innerHTML=null!==t?`\n                    <span>馃嵓</span>\n                    <span>${e}</span>\n                    <span style="font-weight:bold">${t}%</span>\n                `:`<span>馃嵓</span><span>${e}</span>`,n.style.display="flex"},hideProgressToast(){const e=document.getElementById("ios-baby-progress-toast");e&&(e.style.display="none")},shouldRecommendURL(e,t){if(!this.enabled)return!1;return e.size>({font:3145728,image:5242880,backup:20971520}[t]||this.CHUNK_THRESHOLD)}};window.iOSBabyMode=a,a.showFirstTimePrompt();const o="ios_safe_area_margin",s=localStorage.getItem(o);s&&parseInt(s);let i=null;if(window.applyIOSSafeAreaMargin=function(e){const t=Math.max(-300,Math.min(300,parseInt(e)||0)),n=t+"px";i&&clearTimeout(i),i=setTimeout(()=>{try{document.documentElement.style.setProperty("--ios-safe-margin",n);let e=document.getElementById("ios-safe-area-style");e||(e=document.createElement("style"),e.id="ios-safe-area-style",document.head.appendChild(e));const a=document.body.classList.contains("fullscreen-mode"),o=`${t>=0?"-":"+"} ${Math.abs(t)}px`,s=100,i=`-${s}px`;let r=`\n                    /* 璁?html/body 鑳屾櫙寤朵几鍒板畨鍏ㄥ尯涓嬫柟锛岃鐩栫櫧鑹茶儗鏅紙鍥哄畾寤朵几锛屼笉鍙楃敤鎴疯缃奖鍝嶏級 */\n                    /* 璁?html/body 鑳屾櫙寤朵几鍒板畨鍏ㄥ尯涓嬫柟锛岃鐩栫櫧鑹茶儗鏅紙鍥哄畾寤朵几锛屼笉鍙楃敤鎴疯缃奖鍝嶏級 */\n                    html.is-ios-pwa-html {\n                        /* 绉婚櫎瀵艰嚧鐧藉潡鐨?padding-bottom */\n                        margin-bottom: 0 !important;\n                        padding-bottom: 0 !important;\n                    }\n                    body.is-ios-pwa {\n                        /* 绉婚櫎瀵艰嚧鐧藉潡鐨?padding-bottom */\n                        margin-bottom: 0 !important;\n                        padding-bottom: 0 !important;\n                    }\n                    /* 鍏抽敭锛氳 #global-wallpaper 涔熷欢浼稿埌瀹夊叏鍖轰笅鏂癸紝瑕嗙洊鐧借壊鑳屾櫙 */\n                    #global-wallpaper {\n                        position: fixed !important;\n                        top: 0 !important;\n                        left: 0 !important;\n                        right: 0 !important;\n                        bottom: ${i} !important;\n                        width: 100vw !important;\n                        height: calc(100vh + ${s}px) !important;\n                        height: calc(100dvh + ${s}px) !important;\n                        z-index: -1 !important;\n                        background-size: cover !important;\n                        background-position: center !important;\n                        background-repeat: no-repeat !important;\n                    }\n                    /* 璋冩暣 phone-frame 鐨勯珮搴?*/\n                    body.is-ios-pwa .phone-frame {\n                        height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                    }\n                `;a&&(r+=`\n                    body.is-ios-pwa.fullscreen-mode .phone-frame {\n                        height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                        max-height: calc(100dvh - env(safe-area-inset-bottom) ${o}) !important;\n                    }\n                    `),e.textContent=r,debugLog("馃崕 iOS瀹夊叏鍖簃argin宸叉洿鏂?",n,a?"(鍏ㄥ睆妯″紡)":"")}catch(e){console.error("搴旂敤iOS瀹夊叏鍖簃argin澶辫触:",e)}},100)},e&&t){document.body.classList.add("is-ios-pwa"),document.documentElement.classList.add("is-ios-pwa-html");const tv=document.getElementById("ios-calibration-overlay"),nv=document.getElementById("ios-calibration-confirm-btn"),av="ios_pwa_calibrated_v2";function r(){debugLog("馃洝锔?鍚敤瑙︽懜閿佸畾鎶ょ浘 (Enhanced V2)"),document.addEventListener("touchmove",function(e){const t=e.target.closest(".chat-messages-container, .settings-content, .settings-content-ios, .music-content, .content, .scrollable, .settings-page .overflow-y-auto, .overflow-y-auto, .overflow-auto, .ceramic-category-scroll, .ceramic-content-scroll, .settings-page-content");if(!t)return void(e.cancelable&&e.preventDefault());const n=t.scrollHeight>t.clientHeight,a=t.scrollWidth>t.clientWidth;if(!n&&!a)return void(e.cancelable&&e.preventDefault());const o=e.touches[0].clientY,s=e.touches[0].clientX,i=o-(void 0===window.lastTouchY?o:window.lastTouchY),r=s-(void 0===window.lastTouchX?s:window.lastTouchX),l=Math.abs(i)>Math.abs(r);if(a&&!l)return window.lastTouchY=o,void(window.lastTouchX=s);if(a&&!n&&l)return e.cancelable&&e.preventDefault(),window.lastTouchY=o,void(window.lastTouchX=s);if(n){const n=t.scrollTop<=0,a=t.scrollTop+t.clientHeight>=t.scrollHeight-1;l&&(n&&i>0?e.cancelable&&e.preventDefault():a&&i<0&&e.cancelable&&e.preventDefault())}window.lastTouchY=o,window.lastTouchX=s},{passive:!1}),document.addEventListener("touchstart",function(e){window.lastTouchY=e.touches[0].clientY,window.lastTouchX=e.touches[0].clientX},{passive:!1})}"true"===localStorage.getItem(av)?r():tv&&(tv.style.display="flex",nv.addEventListener("click",()=>{localStorage.setItem(av,"true"),tv.style.opacity="0",tv.style.transition="opacity 0.3s ease",setTimeout(()=>tv.style.display="none",300),r()}))}const l=document.getElementById("nav-to-ios-settings"),c=document.getElementById("ios-settings-screen"),d=document.getElementById("ios-settings-back-button"),u=document.getElementById("ios-margin-slider"),m=document.getElementById("ios-margin-display"),p={"ios-preset-30":30,"ios-preset-50":50,"ios-preset-60":60,"ios-preset-70":70};if(u&&m){let ov=parseInt(localStorage.getItem(o)||"0");ov=Math.max(-300,Math.min(300,ov)),u.value=ov,m.textContent=ov+"px";const sv=document.getElementById("ios-slider-progress"),iv=document.getElementById("ios-slider-thumb");function g(e){const t=(parseInt(e)+300)/600*100;sv&&(sv.style.width=t+"%"),iv&&(iv.style.left=`calc(${t}% - 16px)`)}g(ov);let rv=null;u.addEventListener("input",function(){const e=this.value;m.textContent=e+"px",g(e),window.applyIOSSafeAreaMargin(parseInt(e)),rv&&clearTimeout(rv),rv=setTimeout(()=>{localStorage.setItem(o,e)},300)})}Object.keys(p).forEach(function(e){const t=document.getElementById(e);t&&t.addEventListener("click",function(){const t=p[e];u&&(u.value=t),m&&(m.textContent=t+"px");const n=document.getElementById("ios-slider-progress"),a=document.getElementById("ios-slider-thumb"),s=(t+300)/600*100;n&&(n.style.width=s+"%"),a&&(a.style.left=`calc(${s}% - 16px)`),window.applyIOSSafeAreaMargin(t),localStorage.setItem(o,t.toString())})}),l&&c&&l.addEventListener("click",function(){c.classList.add("opened")}),d&&c&&d.addEventListener("click",function(){c.classList.remove("opened")}),window.DOMCleanupManager={registry:new Map,register(e,t=null){const n=document.getElementById(e);n&&(this.registry.set(e,{element:n,callback:t}),console.log(`[DOM娓呯悊绯荤粺] 宸叉敞鍐屽鍣? ${e}`))},clean(t){const n=this.registry.get(t);if(!n)return void debugWarn(`[DOM娓呯悊绯荤粺] 瀹瑰櫒鏈敞鍐? ${t}`);const{element:a,callback:o}=n;if(o&&"function"==typeof o)try{o(a)}catch(e){debugError(`[DOM娓呯悊绯荤粺] 娓呯悊鍥炶皟鎵ц澶辫触 (${t}):`,e)}if(a&&(a.innerHTML="",debugLog(`[DOM娓呯悊绯荤粺] 鉁?宸叉竻绌? ${t}`)),e&&window.gc)try{window.gc()}catch(e){}},cleanMultiple(e){e.forEach(e=>this.clean(e))},deepClean(e){const t=this.registry.get(e);if(!t)return;const{element:n}=t;if(!n)return;const a=n.cloneNode(!1);n.parentNode.replaceChild(a,n),this.registry.set(e,{element:a,callback:t.callback}),console.log(`[DOM娓呯悊绯荤粺] 鉁?娣卞害娓呯悊瀹屾垚: ${e}`)}},window.TimerManager={timers:new Map,setTimeout(e,t,n="default"){const a=setTimeout(()=>{e(),this.remove(a,n)},t);return this.register(a,n),a},setInterval(e,t,n="default"){const a=setInterval(e,t);return this.register(a,n),a},register(e,t="default"){this.timers.has(t)||this.timers.set(t,[]),this.timers.get(t).push(e),debugLog(`[璁℃椂鍣ㄧ郴缁焆 宸叉敞鍐? ${t} (#${e})`)},remove(e,t){if(!this.timers.has(t))return;const n=this.timers.get(t),a=n.indexOf(e);a>-1&&n.splice(a,1)},clear(e){if(!this.timers.has(e))return void debugWarn(`[璁℃椂鍣ㄧ郴缁焆 鏍囩涓嶅瓨鍦? ${e}`);const t=this.timers.get(e);t.forEach(e=>{clearTimeout(e),clearInterval(e)}),debugLog(`[璁℃椂鍣ㄧ郴缁焆 鉁?宸叉竻鐞?${t.length} 涓鏃跺櫒: ${e}`),this.timers.delete(e)},clearMultiple(e){e.forEach(e=>this.clear(e))},clearAll(){let e=0;this.timers.forEach((t,n)=>{t.forEach(e=>{clearTimeout(e),clearInterval(e)}),e+=t.length}),debugLog(`[璁℃椂鍣ㄧ郴缁焆 鉁?宸叉竻鐞嗘墍鏈夎鏃跺櫒 (鍏?{e}涓?`),this.timers.clear()}};const y=["chat-messages-container","contact-list","forward-target-list","summary-detail-container","summary-list-container","dating-history-container","transactions-list-container","orders-list-container","qilang-feed-container","qilang-detail-comments","gacha-posts-container","wow-feed-container","wow-detail-comments","product-grid","cart-items-container","recipient-list-container","worldbook-list","worldbook-groups-list","books-in-group-list","style-presets-container","font-url-list-container","vn-choices-container","shopper-list-container","summon-ai-list-container","worldbook-visibility-list"];y.forEach(e=>{window.DOMCleanupManager.register(e)}),console.log(`[DOM娓呯悊绯荤粺] 宸叉敞鍐?${y.length} 涓牳蹇冨鍣╜);const h='\n<style>\n    /* 閬僵灞傦細楂樻柉妯＄硦 + 杞诲井鍙樻殫 */\n    .system-loader-overlay {\n        position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n        background: rgba(0, 0, 0, 0.35);\n        backdrop-filter: blur(15px);\n        -webkit-backdrop-filter: blur(15px);\n        z-index: 9999;\n        display: flex; justify-content: center; align-items: center;\n        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;\n        opacity: 0; animation: fadeIn 0.3s forwards;\n    }\n\n    /* 鍗＄墖涓讳綋锛氫豢 iOS 寮圭獥 */\n    .system-loader-card {\n        background: rgba(255, 255, 255, 0.85);\n        backdrop-filter: blur(20px);\n        -webkit-backdrop-filter: blur(20px);\n        padding: 24px;\n        border-radius: 20px;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n        width: 280px;\n        text-align: center;\n        transform: scale(0.9);\n        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;\n    }\n\n    /* 鍔ㄦ€佸浘鏍囧鍣?*/\n    .loader-icon-wrapper {\n        width: 50px; height: 50px; margin: 0 auto 15px;\n        display: flex; align-items: center; justify-content: center;\n        font-size: 28px;\n    }\n\n    /* 鏃嬭浆鍔ㄧ敾鍦堝湀 (鐢ㄤ簬瀵煎叆) */\n    .spinner-ios {\n        width: 32px; height: 32px;\n        border: 3px solid rgba(0, 0, 0, 0.1);\n        border-top: 3px solid #007AFF;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n    }\n\n    /* 璺冲姩鍔ㄧ敾 (鐢ㄤ簬澶囦唤鎵撳寘) */\n    .bounce-icon { animation: bounce 1.5s infinite; }\n\n    /* 鏍囬鏂囧瓧 */\n    .loader-title {\n        font-size: 17px; font-weight: 600; color: #000; margin-bottom: 8px;\n    }\n\n    /* 鐘舵€佹弿杩版枃瀛?*/\n    .loader-desc {\n        font-size: 13px; color: #8e8e93; margin-bottom: 15px; min-height: 16px;\n    }\n\n    /* 杩涘害鏉″鍣?*/\n    .progress-track {\n        width: 100%; height: 6px; background: #E5E5EA;\n        border-radius: 10px; overflow: hidden;\n    }\n\n    /* 杩涘害鏉″～鍏?*/\n    .progress-fill {\n        height: 100%; background: #007AFF; width: 0%;\n        border-radius: 10px;\n        transition: width 0.3s ease;\n    }\n\n    /* 鍔ㄧ敾鍏抽敭甯?*/\n    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }\n    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }\n    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }\n</style>\n',v=document.getElementById("wow-app-icon"),f=(document.getElementById("wow-screen"),document.getElementById("wow-exit-btn")),w=document.querySelectorAll(".wow-nav-btn"),b=document.querySelectorAll(".wow-page"),E=document.getElementById("wow-identity-modal"),I=document.getElementById("wow-identity-list"),x=document.getElementById("wow-current-avatar"),k=document.getElementById("wow-profile-avatar"),L=document.getElementById("wow-profile-name"),B=document.getElementById("wow-feed-container"),S=document.getElementById("wow-open-compose-btn"),C=document.getElementById("wow-compose-modal"),$=document.getElementById("wow-compose-text"),M=document.getElementById("wow-compose-publish-btn"),T=document.getElementById("wow-compose-cancel-btn"),A=document.getElementById("wow-detail-view"),D=document.getElementById("wow-detail-back-btn"),P=document.getElementById("wow-detail-main-post"),H=document.getElementById("wow-detail-comments"),O=document.getElementById("wow-detail-input"),q=document.getElementById("wow-detail-send-btn");let N=null,F=(new Set,null),_=null,R=null;const G=document.getElementById("battery-level"),W=document.getElementById("batteryBolt"),j=document.getElementById("batteryContainer"),U=document.getElementById("proactive-settings-screen"),z=document.getElementById("proactive-back-button"),V=document.getElementById("nav-to-proactive-settings"),J=document.getElementById("proactive-master-switch"),Y=document.getElementById("proactive-interval-slider"),K=document.getElementById("proactive-interval-display"),Z=document.getElementById("proactive-contact-list"),X=document.getElementById("proactive-status-text");let Q={},ee=[],te=!1,ne={enabled:!1,interval:10,targets:[]};const ae=document.getElementById("menu-delete-btn"),oe=document.getElementById("global-beautify-btn"),se=(document.getElementById("global-beautify-screen"),document.getElementById("global-beautify-back-button")),ie=document.getElementById("global-css-input"),re=document.getElementById("save-global-css-btn"),le=document.getElementById("reset-global-css-btn"),ce=document.getElementById("global-user-styles");let de=[],ue=null,me=null;const pe=document.getElementById("qilang-identity-list");let ge=null,ye=null;const he=document.getElementById("qilang-refresh-btn"),ve=(document.getElementById("qilang-detail-view"),document.getElementById("qilang-detail-back-btn")),fe=document.getElementById("qilang-post-btn"),we=document.getElementById("qilang-post-modal"),be=document.getElementById("qilang-post-cancel-btn"),Ee=(document.getElementById("qilang-post-confirm-btn"),document.getElementById("q-detail-title"),document.getElementById("q-detail-content"),document.getElementById("q-detail-author-name"),document.getElementById("qilang-app-icon")),Ie=(document.getElementById("qilang-screen"),document.getElementById("qilang-menu-btn")),xe=document.getElementById("qilang-sidebar"),ke=document.getElementById("qilang-sidebar-overlay"),Le=document.getElementById("attachment-file-feature"),Be=document.getElementById("file-attachment-input"),Se=document.getElementById("menu-copy-btn"),Ce=document.getElementById("anywhere-door-feature"),$e=document.getElementById("anywhere-door-modal"),Me=document.getElementById("anywhere-door-close-btn"),Te=document.getElementById("anywhere-door-input"),Ae=document.getElementById("send-action-msg-btn");let De=null,Pe=!1;const He=document.getElementById("forward-messages-btn"),Oe=document.getElementById("forward-target-modal"),qe=document.getElementById("forward-target-list"),Ne=document.getElementById("forward-modal-close-btn"),Fe=document.getElementById("menu-select-btn"),_e=document.getElementById("msg-action-menu"),Re=document.getElementById("menu-reply-btn"),Ge=document.getElementById("reply-preview-bar"),We=document.getElementById("reply-preview-name"),je=document.getElementById("reply-preview-content"),Ue=document.getElementById("cancel-reply-btn");let ze=null,Ve=null,Je=null,Ye=null;const Ke=document.getElementById("about-device-btn"),Ze=(document.getElementById("about-device-screen"),document.getElementById("about-device-back-button")),Xe=document.getElementById("group-header-actions-normal"),Qe=document.getElementById("group-header-actions-select"),et=document.getElementById("groups-cancel-select-btn"),tt=document.getElementById("delete-groups-btn");let nt=null;const at=document.getElementById("group-info-modal"),ot=document.getElementById("add-group-member-modal"),st=document.getElementById("add-member-close-btn"),it=document.getElementById("save-new-member-btn"),rt=document.getElementById("new-member-avatar-input"),lt=document.getElementById("new-member-avatar-preview"),ct=document.getElementById("new-member-name"),dt=document.getElementById("new-member-persona"),ut=document.getElementById("edit-member-modal"),mt=document.getElementById("edit-member-close-btn"),pt=document.getElementById("save-member-btn"),gt=document.getElementById("edit-member-avatar-input"),yt=document.getElementById("edit-member-preview"),ht=document.getElementById("edit-member-name-input"),vt=document.getElementById("edit-member-persona-input"),ft=document.getElementById("edit-group-user-persona-input"),wt=document.getElementById("group-settings-avatar"),bt=document.getElementById("group-avatar-upload-input"),Et=document.getElementById("edit-group-name-btn"),It=document.getElementById("group-user-card"),xt=document.getElementById("group-user-avatar"),kt=document.getElementById("group-user-name"),Lt=document.getElementById("edit-group-user-modal"),Bt=document.getElementById("close-group-user-modal"),St=document.getElementById("edit-group-user-preview"),Ct=document.getElementById("edit-group-user-avatar-input"),$t=document.getElementById("edit-group-user-name-input"),Mt=document.getElementById("save-group-user-btn"),Tt=document.getElementById("group-info-modal"),At=(document.getElementById("group-info-close-btn"),document.getElementById("group-settings-name")),Dt=document.getElementById("group-member-count"),Pt=document.getElementById("group-members-grid"),Ht=(document.getElementById("add-group-member-modal"),document.getElementById("add-member-close-btn"),document.getElementById("new-member-avatar-input"),document.getElementById("new-member-avatar-preview")),Ot=document.getElementById("new-member-name"),qt=document.getElementById("new-member-persona"),Nt=(document.getElementById("save-new-member-btn"),document.getElementById("create-group-modal")),Ft=document.getElementById("create-group-back-btn"),_t=document.getElementById("create-group-title"),Rt=document.getElementById("group-mode-selection"),Gt=document.getElementById("group-member-select-container"),Wt=document.getElementById("group-member-list"),jt=document.getElementById("group-create-footer"),Ut=document.getElementById("confirm-create-group-btn"),zt=document.getElementById("mode-select-existing"),Vt=document.getElementById("mode-create-empty"),Jt=document.getElementById("game-segment-control"),Yt=Jt?Jt.querySelectorAll(".segment-btn"):[];let Kt="single";const Zt=document.getElementById("shop-segment-control"),Xt=Zt?Zt.querySelectorAll(".segment-btn"):[],Qt=document.getElementById("create-group-close-btn"),en=document.getElementById("messages-add-btn"),tn=document.getElementById("messages-multiselect-btn"),nn=tn?tn.querySelector(".icon-select"):null,an=tn?tn.querySelector(".icon-delete"):null,on=document.querySelector("#messages-screen .glass-segment-control"),sn=document.querySelectorAll("#messages-screen .segment-btn"),rn=(document.getElementById("open-drawer-btn"),document.getElementById("close-drawer-btn"),document.getElementById("bottom-drawer"),document.getElementById("reroll-feature")),ln=document.getElementById("ai-pendant-url-input"),cn=document.getElementById("ai-pendant-css-input"),dn=document.getElementById("restore-ai-pendant-btn"),un=document.getElementById("user-pendant-url-input"),mn=document.getElementById("user-pendant-css-input"),pn=document.getElementById("restore-user-pendant-btn"),gn=document.getElementById("custom-pendant-styles"),yn=document.getElementById("chat-add-attachment-button"),hn=(yn&&yn.innerHTML,document.getElementById("text-image-feature")),vn=document.getElementById("text-image-modal"),fn=document.getElementById("text-image-modal-close-btn"),wn=document.getElementById("text-image-input"),bn=document.getElementById("send-text-image-btn"),En=document.getElementById("ai-thought-bubble"),In=document.getElementById("chat-contact-name"),xn=document.getElementById("manage-font-urls-btn"),kn=(document.getElementById("font-url-settings-screen"),document.getElementById("font-url-back-button")),Ln=document.getElementById("add-font-url-btn"),Bn=document.getElementById("font-url-list-container");let Sn=null;const Cn=document.getElementById("text-edit-modal"),$n=document.getElementById("text-edit-modal-title"),Mn=document.getElementById("text-edit-modal-close-btn"),Tn=document.getElementById("text-edit-textarea"),An=document.getElementById("text-edit-save-btn");let Dn=null;const Pn=document.getElementById("dating-history-feature"),Hn=(document.getElementById("dating-history-screen"),document.getElementById("dating-history-back-button")),On=document.getElementById("dating-history-container"),qn=document.getElementById("add-style-preset-btn"),Nn=document.getElementById("style-preset-modal"),Fn=document.getElementById("style-preset-modal-title"),_n=document.getElementById("style-preset-modal-close-btn"),Rn=document.getElementById("style-preset-input"),Gn=document.getElementById("save-style-preset-btn");let Wn=null;const jn=document.getElementById("style-presets-container"),Un=document.getElementById("vn-dialog-box"),zn=document.getElementById("vn-choices-container"),Vn=document.getElementById("custom-choice-modal"),Jn=document.getElementById("custom-choice-close-btn"),Yn=document.getElementById("custom-choice-input"),Kn=document.getElementById("custom-choice-confirm-btn");let Zn=[],Xn=[],Qn=0,ea=!1;const ta=document.getElementById("char-upload-box"),na=document.getElementById("char-upload-input"),aa=document.getElementById("bg-upload-box"),oa=document.getElementById("bg-upload-input"),sa=document.getElementById("bg-previews-container"),ia=document.getElementById("start-dating-btn"),ra=document.getElementById("dating-setup-back-btn"),la=document.getElementById("appointment-feature"),ca=document.getElementById("dating-screen"),da=document.getElementById("dating-loader-1"),ua=document.getElementById("dating-loader-2"),ma=document.getElementById("dating-setup-screen"),pa=document.getElementById("dating-settings-screen"),ga=document.getElementById("vn-screen"),ya=document.getElementById("vn-background"),ha=document.getElementById("vn-character"),va=document.getElementById("vn-exit-btn"),fa=document.getElementById("vn-settings-btn"),wa=document.getElementById("vn-char-name"),ba=document.getElementById("vn-dialog-text");let Ea=null,Ia=[];const xa=document.getElementById("incoming-call-reason"),ka=(document.getElementById("request-call-feature"),document.getElementById("incoming-call-screen"),document.getElementById("incoming-call-avatar")),La=document.getElementById("incoming-call-name"),Ba=document.getElementById("accept-call-button"),Sa=document.getElementById("decline-call-button"),Ca=document.getElementById("call-summary-feature"),$a=(document.getElementById("summary-list-screen"),document.getElementById("summary-list-back-button")),Ma=document.getElementById("summary-list-container"),Ta=(document.getElementById("summary-detail-screen"),document.getElementById("summary-detail-back-button")),Aa=document.getElementById("summary-detail-container"),Da=document.getElementById("voice-call-feature"),Pa=(document.getElementById("voice-call-screen"),document.querySelector("#voice-call-screen .call-background"),document.getElementById("calling-state")),Ha=document.getElementById("calling-avatar"),Oa=document.getElementById("calling-name"),qa=document.getElementById("calling-status"),Na=document.getElementById("cancel-call-button"),Fa=document.getElementById("connected-state"),_a=document.getElementById("connected-name"),Ra=document.getElementById("call-timer"),Ga=document.getElementById("ai-speech-bubble-container"),Wa=document.getElementById("connected-hang-up-button"),ja=document.getElementById("user-speak-button"),Ua=document.getElementById("voice-call-input-modal"),za=document.getElementById("voice-call-textarea"),Va=document.getElementById("send-call-text-button");let Ja=null,Ya=null,Ka=[];const Za=document.getElementById("image-preview-modal"),Xa=document.getElementById("preview-image-element"),Qa=document.getElementById("image-preview-close-btn"),eo=document.getElementById("motto-settings-btn"),to=document.getElementById("app-name-settings-btn"),no=(document.getElementById("motto-settings-screen"),document.getElementById("appname-settings-screen"),document.getElementById("motto-settings-back-button")),ao=document.getElementById("appname-settings-back-button"),oo=document.getElementById("motto"),so=document.querySelectorAll(".app-name"),io=document.getElementById("motto-color-input"),ro=document.getElementById("motto-color-picker"),lo=document.getElementById("motto-blur-toggle"),co=document.getElementById("app-name-color-input"),uo=document.getElementById("app-name-color-picker"),mo=document.getElementById("app-name-blur-toggle"),po=document.getElementById("save-preset-button"),go=document.getElementById("manage-presets-button"),yo=(document.getElementById("preset-management-screen"),document.getElementById("preset-back-button")),ho=document.getElementById("preset-list-container"),vo=document.getElementById("import-preset-button"),fo=document.getElementById("preset-import-input");let wo=!1;const bo=document.getElementById("image-feature"),Eo=document.getElementById("chat-image-upload-input"),Io=document.getElementById("save-all-settings-btn"),xo=document.getElementById("chat-message-input");document.getElementById("chat-messages-container");let ko=!1;const Lo=document.getElementById("move-books-in-group-btn");const Bo=document.getElementById("worldbook-groups-btn"),So=(document.getElementById("worldbook-groups-screen"),document.getElementById("worldbook-groups-back-button")),Co=document.getElementById("add-worldbook-group-btn"),$o=document.getElementById("worldbook-groups-list"),Mo=document.getElementById("groups-multiselect-btn"),To=(document.getElementById("worldbook-group-detail-screen"),document.getElementById("group-detail-back-button")),Ao=document.getElementById("group-detail-title"),Do=document.getElementById("add-book-in-group-btn"),Po=document.getElementById("books-in-group-list"),Ho=document.getElementById("group-detail-multiselect-btn"),Oo=document.getElementById("worldbook-header-actions-normal"),qo=document.getElementById("worldbook-header-actions-select"),No=document.getElementById("move-books-btn"),Fo=document.getElementById("worldbook-cancel-select-btn"),_o=document.getElementById("move-to-group-modal"),Ro=document.getElementById("move-to-group-modal-close-btn"),Go=document.getElementById("group-selection-list");let Wo=!1,jo=!1,Uo=null;const zo=document.getElementById("group-detail-header-actions-normal"),Vo=document.getElementById("group-detail-header-actions-select"),Jo=document.getElementById("delete-books-in-group-btn"),Yo=document.getElementById("group-detail-cancel-select-btn"),Ko=document.getElementById("chat-message-input"),Zo=document.getElementById("api-library-modal"),Xo=document.getElementById("api-library-modal-close-btn"),Qo=document.getElementById("api-library-list-container"),es=document.getElementById("save-api-to-library-btn"),ts=document.getElementById("select-api-library-btn"),ns=document.getElementById("api-library-delete-selected-btn");let as=!1;const os=document.getElementById("lottery-modal"),ss=document.getElementById("toggle-dark-mode"),is=document.getElementById("gacha-app-icon"),rs=document.getElementById("gacha-screen"),ls=document.getElementById("gacha-back-button"),cs=document.getElementById("gacha-title"),ds=document.getElementById("gacha-segment-control"),us=ds.querySelectorAll(".segment-btn"),ms=(document.getElementById("share-content-panel"),document.getElementById("gacha-posts-container")),ps=document.getElementById("gacha-avatar-button"),gs=document.getElementById("gacha-avatar-img"),ys=document.getElementById("gacha-new-post-btn"),hs=document.getElementById("gacha-post-modal"),vs=document.getElementById("gacha-post-modal-close-btn"),fs=document.getElementById("gacha-post-text-input"),ws=document.getElementById("gacha-post-image-desc-input"),bs=document.getElementById("gacha-confirm-post-btn"),Es=document.getElementById("visibility-settings-modal"),Is=document.getElementById("visibility-modal-close-btn"),xs=document.getElementById("worldbook-visibility-list"),ks=document.getElementById("save-visibility-btn"),Ls=document.getElementById("summon-ai-modal"),Bs=document.getElementById("summon-ai-modal-close-btn"),Ss=document.getElementById("summon-ai-list-container");let Cs=null,$s=null,Ms=null;const Ts=document.getElementById("transaction-history-card"),As=(document.getElementById("transactions-screen"),document.getElementById("transactions-back-button")),Ds=document.getElementById("transactions-list-container"),Ps=document.getElementById("blacklist-modal"),Hs=document.getElementById("go-to-savings-btn"),Os=document.getElementById("unlock-modal"),qs=document.getElementById("unlock-modal-close-btn"),Ns=document.getElementById("apply-unlock-btn"),Fs=document.getElementById("unlock-code-input"),_s=document.getElementById("confirm-unlock-btn"),Rs=document.getElementById("number-guess-modal"),Gs=document.getElementById("coin-flip-modal"),Ws=document.getElementById("games-grid"),js=document.getElementById("balance-display"),Us=document.getElementById("GAME-app-icon"),zs=(document.getElementById("slacking-off-screen"),document.getElementById("slacking-off-back-button")),Vs=document.getElementById("slacking-off-title");let Js=[],Ys=null;document.getElementById("my-orders-button"),document.getElementById("my-cart-button"),document.getElementById("cart-screen"),document.getElementById("cart-back-button"),document.getElementById("cart-items-container"),document.getElementById("select-recipient-btn"),document.getElementById("recipient-name-display"),document.getElementById("confirm-purchase-btn"),document.getElementById("orders-screen"),document.getElementById("orders-back-button");const Ks=document.getElementById("orders-list-container"),Zs=(document.getElementById("recipient-select-modal"),document.getElementById("recipient-modal-close-btn"),document.getElementById("recipient-list-container"),document.querySelector(".category-tabs"),document.getElementById("product-grid")),Xs=document.getElementById("SHOP-app-icon"),Qs=(document.getElementById("shop-screen"),document.getElementById("shop-back-button"));let ei=null;const ti=document.getElementById("shopper-avatar-button"),ni=document.getElementById("shopper-avatar-img"),ai=document.getElementById("shopper-select-modal"),oi=document.getElementById("shopper-modal-close-btn"),si=document.getElementById("shopper-list-container"),ii=(document.querySelectorAll(".shop-tab-item"),document.querySelectorAll(".shop-content-panel"),document.getElementById("shop-title")),ri=document.getElementById("clock-blur-toggle"),li=document.querySelector(".clock"),ci=document.getElementById("change-clock-button"),di=(document.getElementById("clock-settings-screen"),document.getElementById("clock-settings-back-button")),ui=document.getElementById("clock-color-input"),mi=document.getElementById("clock-color-picker"),pi=document.querySelectorAll(".clock span"),gi=document.getElementById("beautify-app-icon"),yi=(document.getElementById("beautify-screen"),document.getElementById("beautify-back-button")),hi=document.getElementById("change-icon-button"),vi=(document.getElementById("icon-settings-screen"),document.getElementById("icon-settings-back-button")),fi=document.getElementById("multiselect-emoji-btn");let wi=!1;const bi=document.getElementById("audio-player"),Ei=document.getElementById("wallpaper-upload-input"),Ii=document.querySelector(".phone-frame"),xi=document.querySelector(".app-grid"),ki=(document.querySelectorAll(".screen"),document.getElementById("home-screen"));document.getElementById("settings-screen");const Li=document.getElementById("settings-app-icon"),Bi=(document.getElementById("back-button"),document.getElementById("save-settings-button"),document.getElementById("music-app-icon")),Si=(document.getElementById("music-screen"),document.getElementById("music-back-button")),Ci=document.getElementById("playlist-multiselect-btn");let $i=!1;const Mi=document.getElementById("messages-app-icon"),Ti=(document.getElementById("messages-screen"),document.getElementById("messages-back-button")),Ai=document.getElementById("add-contact-modal"),Di=document.getElementById("modal-close-btn"),Pi=document.getElementById("role-switch-checkbox"),Hi=document.querySelectorAll(".switch-label"),Oi=document.getElementById("ai-form"),qi=document.getElementById("user-form"),Ni=document.getElementById("contact-list"),Fi=document.getElementById("ai-avatar-preview"),_i=document.getElementById("ai-avatar-input"),Ri=document.getElementById("ai-name-input"),Gi=document.getElementById("ai-persona-input"),Wi=document.getElementById("user-avatar-preview"),ji=document.getElementById("user-avatar-input"),Ui=document.getElementById("user-name-input"),zi=document.getElementById("user-persona-input"),Vi=document.getElementById("context-memory-input"),Ji=document.getElementById("save-contact-btn"),Yi=(document.getElementById("load-more-messages-btn"),document.getElementById("chat-screen")),Ki=document.getElementById("chat-back-button"),Zi=document.getElementById("chat-contact-name"),Xi=document.getElementById("chat-messages-container");let Qi=!1;const er=document.getElementById("chat-settings-modal"),tr=document.getElementById("chat-settings-button"),nr=document.getElementById("chat-settings-close-btn"),ar=document.getElementById("save-chat-settings-btn"),or=document.getElementById("role-switch-checkbox-settings"),sr=document.getElementById("ai-form-settings"),ir=document.getElementById("user-form-settings"),rr=document.getElementById("ai-avatar-preview-settings"),lr=document.getElementById("ai-avatar-input-settings"),cr=(document.getElementById("ai-name-input-settings"),document.getElementById("ai-persona-input-settings"),document.getElementById("user-avatar-preview-settings")),dr=document.getElementById("user-avatar-input-settings"),ur=(document.getElementById("user-name-input-settings"),document.getElementById("user-persona-input-settings"),document.getElementById("context-memory-input-settings"),document.getElementById("bubble-css-input")),mr=document.getElementById("restore-bubble-css-btn"),pr=document.getElementById("upload-chat-bg-btn"),gr=document.getElementById("reset-chat-bg-btn"),yr=document.getElementById("chat-bg-upload-input"),hr=document.getElementById("clear-history-btn"),vr=document.getElementById("custom-bubble-styles"),fr=document.getElementById("toggle-frame-visibility"),wr=document.body,br=document.getElementById("worldbook-app-icon"),Er=document.getElementById("worldbook-back-button"),Ir=(document.getElementById("add-worldbook-btn"),document.getElementById("add-worldbook-modal")),xr=document.getElementById("worldbook-modal-close-btn"),kr=document.getElementById("save-worldbook-btn"),Lr=document.getElementById("worldbook-name-input"),Br=document.getElementById("worldbook-content-input"),Sr=document.getElementById("worldbook-list"),Cr=document.getElementById("worldbook-multiselect-btn");let $r=!1,Mr=null;document.getElementById("show-avatars-toggle"),document.getElementById("avatar-radius-input");const Tr=document.getElementById("backup-data-btn"),Ar=document.getElementById("import-data-btn"),Dr=document.getElementById("import-file-input"),Pr=document.getElementById("custom-font-style"),Hr=(document.getElementById("change-font-btn"),document.getElementById("restore-font-btn"),document.getElementById("font-import-input")),Or=(document.getElementById("worldbook-select-settings"),document.getElementById("chat-emoji-button")),qr=document.getElementById("chat-screen"),Nr=document.getElementById("chat-messages-container"),Fr=document.getElementById("api-url"),_r=document.getElementById("api-key"),Rr=document.getElementById("connect-api-button"),Gr=document.getElementById("api-connection-status"),Wr=document.getElementById("api-model"),jr=(document.getElementById("save-settings-button"),document.getElementById("temperature-slider")),Ur=document.getElementById("temperature-value"),zr=document.getElementById("clock-hours"),Vr=document.getElementById("clock-minutes"),Jr=document.getElementById("motto"),Yr=(document.getElementById("widgetContainer"),document.getElementById("toggle-widget-visibility"),document.getElementById("imageUploader"),document.getElementById("widgetText"),document.getElementById("wallpaper-preview")),Kr=(document.getElementById("reset-wallpaper-btn"),document.getElementById("upload-wallpaper-btn"),document.getElementById("collapsed-song-title"),document.getElementById("dynamic-island")),Zr=document.getElementById("island-song-title"),Xr=document.getElementById("island-song-artist"),Qr=document.getElementById("island-play-pause-btn"),el=document.getElementById("island-prev-btn"),tl=document.getElementById("island-next-btn"),nl=document.getElementById("progress-current-time"),al=document.getElementById("progress-remaining-time"),ol=document.getElementById("progress-bar-fill"),sl=document.getElementById("add-playlist-btn"),il=document.getElementById("playlist-grid"),rl=(document.getElementById("playlist-detail-screen"),document.getElementById("playlist-back-button")),ll=document.getElementById("playlist-name-title"),cl=document.getElementById("import-music-button"),dl=document.getElementById("music-file-input"),ul=document.getElementById("song-list"),ml=document.getElementById("upload-cover-btn"),pl=document.getElementById("multi-select-btn"),gl=document.getElementById("cover-upload-input"),yl=document.getElementById("edit-playlist-name-btn"),hl=document.getElementById("add-emoji-btn"),vl=document.getElementById("add-emoji-modal"),fl=document.getElementById("emoji-modal-close-btn"),wl=document.getElementById("save-emoji-btn"),bl=document.getElementById("emoji-urls-textarea"),El=document.getElementById("emoji-grid-container"),Il=document.getElementById("icon-list-container"),xl=new Map([]),kl=new Map;function Ll(e){return kl.has(e)?kl.get(e):Zp(e)}async function Bl(e){if(kl.clear(),e)try{const t=await Kl.loadData("worldBooks","allWorldBooks"),n=t&&Array.isArray(t.value)?t.value:[];let a=new Set;if(e.linkedWorldBookIds&&e.linkedWorldBookIds.length>0)e.linkedWorldBookIds.forEach(e=>a.add(e));else if(e.linkedWorldBookGroupIds&&e.linkedWorldBookGroupIds.length>0){const t=await Kl.loadData("worldBookGroups","allGroups"),n=t&&Array.isArray(t.value)?t.value:[],o=new Set(e.linkedWorldBookGroupIds);n.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>a.add(e))})}n.filter(e=>a.has(e.id)).forEach(e=>{!function(e){if(!e)return;const t=/\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;let n;for(;null!==(n=t.exec(e));){const e=n[1].trim(),t=n[2].trim();kl.set(e,t),console.log(`宸叉敞鍐屽ご鍍? ${e} -> ${t}`)}}(e.content)}),console.log("澶村儚搴撳姞杞藉畬姣曪紝褰撳墠澶村儚鏁?",kl.size)}catch(e){console.error("鍔犺浇澶村儚搴撳け璐?,e)}}function Sl(e){if(!Xi)return;let t=document.getElementById("optimized-chat-bg-layer");if(!t){t=document.createElement("div"),t.id="optimized-chat-bg-layer",t.style.cssText="\n                position: absolute;\n                top: 0; left: 0; right: 0; bottom: 0;\n                width: 100%; height: 100%;\n                z-index: 0; /* 浣嶄簬鍐呭涔嬩笅 */\n                pointer-events: none; /* 鐐瑰嚮绌块€?*/\n                transform: translate3d(0, 0, 0); /* 瑙﹀彂纭欢鍔犻€?*/\n                will-change: transform; /* 鍛婄煡娴忚鍣ㄤ紭鍖?*/\n                background-size: cover;\n                background-position: center;\n                background-repeat: no-repeat;\n                backface-visibility: hidden; /* 淇鏌愪簺璁惧闂儊 */\n            ";const e=Xi.parentNode;if(e){"static"===window.getComputedStyle(e).position&&(e.style.position="relative"),e.insertBefore(t,Xi)}}Xi.style.background="none",Xi.style.backgroundColor="transparent",Xi.style.position="relative",Xi.style.zIndex="1",e?requestAnimationFrame(()=>{t.style.backgroundImage=`url('${e}')`}):(t.style.backgroundImage="",t.style.display="none"),e&&(t.style.display="block")}oe&&oe.addEventListener("click",()=>{Ii.classList.add("show-global-beautify")}),se&&se.addEventListener("click",()=>{Ii.classList.remove("show-global-beautify")}),re&&re.addEventListener("click",async()=>{const e=ie.value;Ep(e);try{await Kl.saveData("settingsStore","globalUserCss",e),alert("鍏ㄥ眬鏍峰紡宸插簲鐢紒"),Ii.classList.remove("show-global-beautify")}catch(e){alert("淇濆瓨澶辫触锛?+e.message)}}),le&&le.addEventListener("click",async()=>{confirm("纭畾瑕佹竻绌烘墍鏈夊叏灞€缇庡寲浠ｇ爜鍚楋紵")&&(Ep(""),await Kl.saveData("settingsStore","globalUserCss",""),alert("宸查噸缃€?))}),pr&&pr.addEventListener("click",()=>{yr&&yr.click()}),yr&&yr.addEventListener("change",async e=>{const t=e.target.files[0];if(t)if(e.target.value="",t.type.startsWith("image/"))try{let e;if(window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>2097152?(window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",0),e=await window.iOSBabyMode.safeCompressImage(t,{maxWidth:1920,maxHeight:1920,quality:.75,onProgress:e=>{window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",e)}}),window.iOSBabyMode.hideProgressToast()):e=window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),Sl(e),window.iOSBabyMode&&window.iOSBabyMode.enabled&&await new Promise(e=>setTimeout(e,50)),Sc){Sc.chatBackground=e;try{let t=(await Kl.loadData("messageContacts","allContacts")).value;const n=t.findIndex(e=>e.id===Sc.id);n>-1?(Sc.backgroundImage=e,t[n]=Sc,await Kl.saveData("messageContacts","allContacts",t),void 0!==Ye&&(Ye=t),console.log("鑱婂ぉ鑳屾櫙宸蹭繚瀛樺埌鏁版嵁搴?)):console.error("鏈壘鍒拌仈绯讳汉绱㈠紩")}catch(e){console.error("淇濆瓨鑱婂ぉ鑳屾櫙澶辫触:",e),alert("淇濆瓨澶辫触,璇烽噸璇?)}}else console.error("currentOpenContact 鏈畾涔?)}catch(e){console.error("璇诲彇鍥剧墖澶辫触:",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?璇诲彇鍥剧墖澶辫触\n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}else alert("璇烽€夋嫨鍥剧墖鏂囦欢锛?)}),gr&&gr.addEventListener("click",async()=>{if(confirm("纭畾瑕佹仮澶嶉粯璁よ亰澶╄儗鏅悧?"))if(Sl(null),Sc){Sc.chatBackground=null,Sc.backgroundImage=null;try{let e=(await Kl.loadData("messageContacts","allContacts")).value;const t=e.findIndex(e=>e.id===Sc.id);t>-1&&(e[t].chatBackground=null,e[t].backgroundImage=null,await Kl.saveData("messageContacts","allContacts",e),void 0!==Ye&&(Ye=e),console.log("[ResetChatBg] 宸叉竻闄よ亰澶╄儗鏅紝ID:",Sc.id)),alert("宸叉仮澶嶉粯璁よ儗鏅?)}catch(e){console.error("淇濆瓨澶辫触:",e),alert("淇濆瓨澶辫触,璇烽噸璇?)}}else console.error("currentOpenContact 鏈畾涔?)});const Cl=document.getElementById("theme-presets-btn"),$l=(document.getElementById("theme-presets-screen"),document.getElementById("theme-presets-back-button")),Ml=document.getElementById("theme-presets-list"),Tl=document.getElementById("theme-presets-empty"),Al=document.getElementById("save-as-theme-preset-btn"),Dl=document.getElementById("import-theme-preset-btn"),Pl=document.getElementById("theme-preset-import-input");function Hl(){return JSON.parse(localStorage.getItem("themePresets")||"[]")}function Ol(e){localStorage.setItem("themePresets",JSON.stringify(e))}function ql(){const e=Hl();Ml.innerHTML="",0!==e.length?(Tl.style.display="none",e.forEach((e,t)=>{const n=document.createElement("div");n.className="theme-preset-item";const a=e.css.length>100?e.css.substring(0,100)+"...":e.css,o=new Date(e.createdAt).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});n.innerHTML=`\n                <div class="theme-preset-header">\n                    <span class="theme-preset-name">${e.name}</span>\n                    <span class="theme-preset-time">${o}</span>\n                </div>\n                <div class="theme-preset-preview">${a||"(绌?"}</div>\n                <div class="theme-preset-actions">\n                    <button class="apply-btn" data-index="${t}">搴旂敤</button>\n                    <button class="export-btn" data-index="${t}">瀵煎嚭</button>\n                    <button class="delete-btn" data-index="${t}">鍒犻櫎</button>\n                </div>\n            `,Ml.appendChild(n)}),Ml.querySelectorAll(".apply-btn").forEach(e=>{e.addEventListener("click",e=>{!function(e){const t=Hl();if(t[e]){const n=t[e].css;ie.value=n,Ep(n),Kl.saveData("settingsStore","globalUserCss",n),alert(`宸插簲鐢ㄤ富棰? ${t[e].name}`)}}(parseInt(e.target.dataset.index))})}),Ml.querySelectorAll(".export-btn").forEach(e=>{e.addEventListener("click",e=>{!function(e){const t=Hl();if(t[e]){const n=t[e],a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download=`${n.name}.json`,i.click(),URL.revokeObjectURL(s)}}(parseInt(e.target.dataset.index))})}),Ml.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",e=>{!function(e){if(confirm("纭畾瑕佸垹闄よ繖涓富棰橀璁惧悧锛?)){const t=Hl();t.splice(e,1),Ol(t),ql()}}(parseInt(e.target.dataset.index))})})):Tl.style.display="block"}Cl&&Cl.addEventListener("click",()=>{ql(),Ii.classList.add("show-theme-presets")}),$l&&$l.addEventListener("click",()=>{Ii.classList.remove("show-theme-presets")}),Al&&Al.addEventListener("click",()=>{const e=ie.value.trim();if(!e)return void alert("璇峰厛杈撳叆CSS浠ｇ爜鍐嶄繚瀛樹负棰勮");const t=prompt("璇疯緭鍏ラ璁惧悕绉?","鎴戠殑涓婚 "+(Hl().length+1));if(!t)return;const n=Hl();n.unshift({name:t,css:e,createdAt:Date.now()}),Ol(n),alert("棰勮宸蹭繚瀛橈紒")}),Dl&&Dl.addEventListener("click",()=>{Pl.click()}),Pl&&Pl.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=JSON.parse(e.target.result);if(!t.name||"string"!=typeof t.css)throw new Error("鏃犳晥鐨勯璁炬牸寮?);t.createdAt=t.createdAt||Date.now();const n=Hl();n.unshift(t),Ol(n),ql(),alert(`鎴愬姛瀵煎叆涓婚: ${t.name}`)}catch(e){alert("瀵煎叆澶辫触: "+e.message)}},n.readAsText(t),e.target.value=""});const Nl=document.getElementById("bubble-presets-btn"),Fl=(document.getElementById("bubble-presets-screen"),document.getElementById("bubble-presets-back-button")),_l=document.getElementById("bubble-presets-list"),Rl=document.getElementById("bubble-presets-empty"),Gl=(document.getElementById("select-bubble-preset-btn"),document.getElementById("save-bubble-preset-btn"),document.getElementById("bubble-preset-select-modal")),Wl=document.getElementById("bubble-preset-select-close-btn"),jl=document.getElementById("bubble-preset-select-list"),Ul=document.getElementById("bubble-preset-select-empty");function zl(){return JSON.parse(localStorage.getItem("bubblePresets")||"[]")}function Vl(e){localStorage.setItem("bubblePresets",JSON.stringify(e))}function Jl(){const e=zl();_l.innerHTML="",0!==e.length?(Rl.style.display="none",e.forEach((e,t)=>{const n=document.createElement("div");n.className="bubble-preset-item";const a=e.css.length>80?e.css.substring(0,80)+"...":e.css,o=new Date(e.createdAt).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});n.innerHTML=`\n                <div class="preset-header">\n                    <span class="preset-name">${e.name}</span>\n                    <span class="preset-time">${o}</span>\n                </div>\n                <div class="preset-preview">${a||"(绌?"}</div>\n                <div class="preset-actions">\n                    <button class="share-btn" data-index="${t}">鍒嗕韩</button>\n                    <button class="delete-btn" data-index="${t}">鍒犻櫎</button>\n                </div>\n            `,_l.appendChild(n)}),_l.querySelectorAll(".share-btn").forEach(e=>{e.addEventListener("click",e=>{!function(e){const t=zl();if(t[e]){const n=t[e].css;navigator.clipboard.writeText(n).then(()=>{alert(`"${t[e].name}" 鐨凜SS浠ｇ爜宸插鍒跺埌鍓创鏉匡紒`)}).catch(()=>{alert("澶嶅埗澶辫触锛岃鎵嬪姩澶嶅埗")})}}(parseInt(e.target.dataset.index))})}),_l.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",e=>{!function(e){if(confirm("纭畾瑕佸垹闄よ繖涓皵娉￠璁惧悧锛?)){const t=zl();t.splice(e,1),Vl(t),Jl()}}(parseInt(e.target.dataset.index))})})):Rl.style.display="block"}function Yl(){const e=zl();jl.innerHTML="",0!==e.length?(Ul.style.display="none",e.forEach((e,t)=>{const n=document.createElement("div");n.className="bubble-select-item",n.dataset.index=t;const a=e.css.length>30?e.css.substring(0,30)+"...":e.css;n.innerHTML=`\n                <span class="item-name">${e.name}</span>\n                <span class="item-preview">${a}</span>\n            `,n.addEventListener("click",()=>{!function(e){const t=zl();t[e]&&ur&&(ur.value=t[e].css,Gl.style.display="none",alert(`宸查€夋嫨棰勮: ${t[e].name}\n璇风偣鍑?淇濆瓨"鎸夐挳搴旂敤鍒板綋鍓嶈亰澶ー))}(t)}),jl.appendChild(n)})):Ul.style.display="block"}Nl&&Nl.addEventListener("click",()=>{Jl(),Ii.classList.add("show-bubble-presets")}),Fl&&Fl.addEventListener("click",()=>{Ii.classList.remove("show-bubble-presets")}),document.addEventListener("click",e=>{if(e.target&&("select-bubble-preset-btn"===e.target.id||e.target.closest("#select-bubble-preset-btn"))){e.preventDefault(),e.stopPropagation();const t=document.getElementById("bubble-preset-select-modal");t&&(Yl(),t.style.display="flex")}}),Wl&&Wl.addEventListener("click",()=>{Gl.style.display="none"}),Gl&&Gl.addEventListener("click",e=>{e.target===Gl&&(Gl.style.display="none")}),document.addEventListener("click",e=>{if(e.target&&"save-bubble-preset-btn"===e.target.id){e.preventDefault(),e.stopPropagation();const t=document.getElementById("bubble-css-input"),n=t?t.value.trim():"";if(!n)return void alert("璇峰厛杈撳叆姘旀场CSS浠ｇ爜鍐嶄繚瀛?);const a=prompt("璇疯緭鍏ラ璁惧悕绉?","鎴戠殑姘旀场鏍峰紡 "+(zl().length+1));if(!a)return;const o=zl();o.unshift({name:a,css:n,createdAt:Date.now()}),Vl(o),alert("姘旀场棰勮宸蹭繚瀛橈紒")}}),Se.addEventListener("click",()=>{if(!ze)return;let e="";const t=ze.querySelector(".voice-transcript"),n=ze.querySelector(".text-image-card .card-text"),a=ze.querySelector(".html-render-container"),o=ze.querySelector(".chat-bubble");if(t)e=t.textContent;else if(n)e=n.textContent;else if(a)e="HTML鍐呭鏃犳硶鐩存帴澶嶅埗";else if(o){const t=o.cloneNode(!0),n=t.querySelector(".reply-quote-container");n&&n.remove(),e=t.textContent.trim()}e?navigator.clipboard.writeText(e).then(()=>{console.log("宸插鍒?),Qm()}).catch(e=>{console.error("澶嶅埗澶辫触: ",e),alert("澶嶅埗澶辫触锛岃閲嶈瘯"),Qm()}):Qm()}),Fe.addEventListener("click",()=>{Qm(),ze?(md(ze),gd(ze)):md()}),document.addEventListener("click",e=>{"flex"!==_e.style.display||_e.contains(e.target)||Qm()}),Xi.addEventListener("scroll",Qm),Re.addEventListener("click",()=>{if(!ze)return;const e=ze.querySelector(".message-content-wrapper")||ze.querySelector(".group-message-wrapper");if(!e)return console.error("鏃犳硶鎵惧埌娑堟伅瀹瑰櫒"),void Qm();const t=ze.dataset.uuid,n=e.classList.contains("user");let a="娑堟伅鍐呭";const o=ze.querySelector(".chat-bubble");o&&(a=o.classList.contains("image-bubble")?"[鍥剧墖]":o.classList.contains("sticker-bubble")?"[琛ㄦ儏鍖匽":o.querySelector(".voice-transcript")?"[璇煶]: "+o.querySelector(".voice-transcript").textContent:o.textContent);let s="鏈煡";if(n)Je?s=Je.userCardName||"鎴?:Sc&&(s=Sc.user.name);else{const e=ze.querySelector(".group-nickname");e?s=e.textContent:Sc&&(s=Sc.ai.name)}Ve={uuid:t,text:a,senderName:s},We.textContent=s,je.textContent=a,Ge.style.display="flex",xo.focus(),Qm()}),Ue.addEventListener("click",ep),Xt.forEach(e=>{e.addEventListener("click",()=>{Xt.forEach(e=>e.classList.remove("active")),e.classList.add("active");if("my"===e.dataset.target)Zt.classList.add("my-mode"),ii&&(ii.textContent="鎴戠殑"),document.getElementById("my-account-content-panel").classList.add("active"),document.getElementById("shopping-content-panel").classList.remove("active");else{Zt.classList.remove("my-mode"),ii&&(ii.textContent="7 SHOP"),document.getElementById("my-account-content-panel").classList.remove("active"),document.getElementById("shopping-content-panel").classList.add("active");const e=document.querySelector(".category-tab.active");!function(e){Zs.innerHTML="";const t=mu[e]||[];if(0===t.length)return void(Zs.innerHTML="<p>璇ュ垎绫讳笅鏆傛棤鍟嗗搧</p>");t.forEach(e=>{const t=document.createElement("div");t.className="product-card";const n=e.brand?`<div class="product-brand-tag">${e.brand}</div>`:"";t.innerHTML=`\n            ${n} \n            <div class="product-name">${e.name}</div>\n            <div class="product-description">${e.description}</div>\n            <div class="product-footer">\n                <span class="product-price">楼${e.price.toFixed(2)}</span>\n                <button class="add-to-cart-btn">+</button>\n            </div>\n        `,Zs.appendChild(t)})}(e?e.dataset.category:"takeout")}})}),Yt.forEach(e=>{e.addEventListener("click",()=>{Yt.forEach(e=>e.classList.remove("active")),e.classList.add("active");"savings"===e.dataset.target?(Jt.classList.add("savings-mode"),Vs&&(Vs.textContent="鍌ㄨ搫"),document.getElementById("savings-content-panel").classList.add("active"),document.getElementById("games-content-panel").classList.remove("active"),gu()):(Jt.classList.remove("savings-mode"),Vs&&(Vs.textContent="娓告垙"),document.getElementById("savings-content-panel").classList.remove("active"),document.getElementById("games-content-panel").classList.add("active"),hu())})}),us.forEach(e=>{e.addEventListener("click",()=>{us.forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.target;"forum"===t?(ds.classList.add("forum-mode"),cs.textContent="FORUM"):(ds.classList.remove("forum-mode"),cs.textContent="SHARE"),document.querySelectorAll(".gacha-content-panel").forEach(e=>e.classList.remove("active"));const n=document.getElementById(`${t}-content-panel`);n&&n.classList.add("active")})}),xi.addEventListener("click",e=>{const t=e.target.closest(".app-container[data-app-id]");if(t){const e=t.dataset.appId;if("music-screen"===e)return void alert("鏆傚仠浣跨敤锛屽緟缁翠慨");const n=document.getElementById(e);n&&function(e,t){if(!t)return;if(e&&void 0!==Ii){const n=e.getBoundingClientRect(),a=Ii.getBoundingClientRect(),o=n.left+n.width/2-a.left,s=n.top+n.height/2-a.top;t.style.transformOrigin=`${o}px ${s}px`}else t.style.transformOrigin="center center";const n=t.id;if(n&&n.includes("-screen")){const e=n.replace("-screen","");Ii.classList.add(`show-${e}`)}else t.classList.add("active");e&&(e.style.transition="transform 0.1s ease",e.style.transform="scale(0.85)",setTimeout(()=>{e.style.transform="scale(1)"},150))}(t,n)}});const Kl={db:null,dbName:"phoneDataDB",async init(){return this.db?Promise.resolve():new Promise((e,t)=>{const n=indexedDB.open(this.dbName,19);n.onerror=e=>{console.error("鏁版嵁搴撴墦寮€鏃跺彂鐢熼敊璇?",n.error),t(`鏁版嵁搴撴墦寮€澶辫触: ${n.error}`)},n.onupgradeneeded=e=>{console.log("鏁版嵁搴撻渶瑕佸崌绾ф垨棣栨鍒涘缓...");const n=e.target.result,a=e.target.transaction,o=["settingsStore","messageContacts","musicPlaylists","worldBooks","emojiStore","gachaPosts","gachaPostInteractions","worldBookGroups","iconPresets","datingSetupStore","writingStylePresets","datingHistoryStore","fontUrlStore","groupChats","qilangPosts","wowPosts","memoryCheques","wowoData"];try{o.forEach(e=>{n.objectStoreNames.contains(e)||(console.log(`姝ｅ湪鍒涘缓琛? ${e}`),"emojiStore"===e?n.createObjectStore(e,{keyPath:"url"}):n.createObjectStore(e,{keyPath:"id"}))}),console.log("鎵€鏈夎〃缁撴瀯妫€鏌?鍒涘缓瀹屾瘯銆?)}catch(e){return console.error("鍦?onupgradeneeded 浜嬩欢涓垱寤鸿〃澶辫触:",e),t("鍒涘缓鏁版嵁搴撹〃澶辫触"),void(a&&a.abort())}n.objectStoreNames.contains("forwardedRecords")||(console.log("姝ｅ湪鍒涘缓 forwardedRecords 琛?.."),n.createObjectStore("forwardedRecords",{keyPath:"id"}))},n.onsuccess=t=>{this.db=t.target.result,console.log("鏁版嵁搴撳凡鎴愬姛杩炴帴骞跺噯澶囧氨缁€?),e()}})},async saveData(e,t,n){return new Promise((a,o)=>{const s=this.db.transaction([e],"readwrite").objectStore(e).put({id:t,value:n});s.onsuccess=()=>a(),s.onerror=t=>o(`鏁版嵁淇濆瓨鍒?${e} 澶辫触: `+t.target.error)})},async loadData(e,t){return new Promise((n,a)=>{const o=this.db.transaction([e],"readonly").objectStore(e).get(t);o.onsuccess=()=>n(o.result),o.onerror=t=>a(`浠?${e} 璇诲彇鏁版嵁澶辫触: `+t.target.error)})},async deleteData(e,t){return new Promise((n,a)=>{const o=this.db.transaction([e],"readwrite").objectStore(e).delete(t);o.onsuccess=()=>n(),o.onerror=t=>a(`浠?${e} 鍒犻櫎鏁版嵁澶辫触: `+t.target.error)})},async getAllDataFromStore(e){return new Promise((t,n)=>{const a=this.db.transaction([e],"readonly").objectStore(e).getAll();a.onsuccess=()=>t(a.result),a.onerror=t=>n(`浠?${e} 璇诲彇鎵€鏈夋暟鎹け璐? `+t.target.error)})},async clearStore(e){return new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).clear();a.onsuccess=()=>t(),a.onerror=t=>n(`娓呯┖ ${e} 澶辫触: `+t.target.error)})},async updateRecord(e,t){return new Promise((n,a)=>{const o=this.db.transaction([e],"readwrite").objectStore(e).put(t);o.onsuccess=()=>n(),o.onerror=t=>a(`鏇存柊 ${e} 涓殑璁板綍澶辫触: `+t.target.error)})}};function Zl(){Vn.classList.remove("visible"),setTimeout(()=>{Vn.style.display="none"},300)}window.dbHelper=Kl,xn.addEventListener("click",()=>{Ii.classList.add("show-font-url"),Mm()}),kn.addEventListener("click",()=>{window.DOMCleanupManager.clean("font-url-list-container"),Ii.classList.remove("show-font-url")}),ra.addEventListener("click",()=>{Ii.classList.remove("show-dating"),setTimeout(()=>{ma.classList.remove("visible"),ga.classList.remove("visible"),da.classList.remove("visible"),ua.classList.remove("visible"),ca.style.pointerEvents="",ca.style.zIndex=""},500)}),Pn.addEventListener("click",()=>{Sm(),Ii.classList.add("show-dating-history"),id()}),Hn.addEventListener("click",()=>{window.DOMCleanupManager.clean("dating-history-container"),Ii.classList.remove("show-dating-history")}),Jn.addEventListener("click",Zl),Vn.addEventListener("click",e=>{e.target===Vn&&Zl()}),Kn.addEventListener("click",()=>{const e=Yn.value.trim();e&&(Em(e),Zl())}),pa.addEventListener("click",e=>{const t=e.target;if("dating-settings-back-btn"===t.id&&Ii.classList.remove("show-dating-settings"),t.classList.contains("menu-button")){const e=t.dataset.target,n=document.getElementById(e);if(n)if(document.getElementById("dating-settings-main").style.display="none",n.style.display="flex","portrait-settings"===e){const e=document.getElementById("portrait-settings-content");e.innerHTML=Xl,function(e){const t=e.querySelector("#char-upload-box-settings"),n=e.querySelector("#char-upload-input-settings"),a=e.querySelector("#delete-char-portrait-btn");Ea&&(t.style.backgroundImage=`url('${Ea}')`,t.textContent="");t.addEventListener("click",()=>n.click()),n.addEventListener("change",e=>{const n=e.target.files[0];if(!n)return;const a=new FileReader;a.onload=e=>{Ea=e.target.result,t.style.backgroundImage=`url('${Ea}')`,t.textContent="",ha.style.backgroundImage=`url('${Ea}')`,ym(),pm()},a.readAsDataURL(n)}),a.addEventListener("click",()=>{confirm("纭畾瑕佸垹闄ゅ綋鍓嶇殑瑙掕壊绔嬬粯鍚楋紵")&&(Ea=null,t.style.backgroundImage="none",t.textContent="鐐瑰嚮涓婁紶",ha.style.backgroundImage="none",ym(),pm())})}(e)}else if("background-settings"===e){const e=document.getElementById("background-settings-content");e.innerHTML=Ql,function(e){const t=e.querySelector("#bg-upload-box"),n=e.querySelector("#bg-upload-input"),a=e.querySelector("#bg-previews-container");function o(e){e.innerHTML="",Ia.forEach((t,n)=>{const a=document.createElement("div");a.className="bg-preview-item",a.innerHTML=`\n                ${t.isDefault?'<div class="default-tag">榛樿</div>':""}\n                <div class="preview-img" style="background-image: url('${t.url}')"></div>\n                <div class="preview-details">\n                    <div class="preview-tags">鏍囩: ${t.tags.join(", ")}</div>\n                    <div class="preview-actions">\n                        <button class="set-default-btn" data-index="${n}">璁句负榛樿</button>\n                        <button class="delete-btn" data-index="${n}">鍒犻櫎</button>\n                    </div>\n                </div>\n            `,e.appendChild(a)})}t.addEventListener("click",()=>n.click()),n.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=prompt("璇疯緭鍏ユ鑳屾櫙鐨勬爣绛?(澶氫釜鏍囩璇风敤绌烘牸鎴栭€楀彿闅斿紑):","榛樿");if(null===n)return;const s=n.split(/[\s,锛宂+/).filter(e=>e),i=new FileReader;i.onload=e=>{const t={url:e.target.result,tags:s.length>0?s:["鏈垎绫?],isDefault:!1};0===Ia.length&&(t.isDefault=!0),Ia.push(t),o(a),ym()},i.readAsDataURL(t)}),a.addEventListener("click",e=>{const t=e.target;if(!t.dataset.index)return;const n=parseInt(t.dataset.index,10);if(t.classList.contains("set-default-btn")&&(Ia.forEach((e,t)=>e.isDefault=t===n),ya.style.backgroundImage=`url('${Ia[n].url}')`,o(a),ym()),t.classList.contains("delete-btn")&&confirm("纭畾瑕佸垹闄よ繖涓儗鏅悧锛?)){const e=Ia[n].isDefault;Ia.splice(n,1),e&&Ia.length>0?(Ia[0].isDefault=!0,ya.style.backgroundImage=`url('${Ia[0].url}')`):0===Ia.length&&(ya.style.backgroundImage="none"),o(a),ym()}}),o(a)}(e)}else if("font-settings"===e){const e=document.getElementById("font-settings-content");e.innerHTML=vm,function(e){const t=e.querySelector("#char-name-color-input"),n=e.querySelector("#char-name-color-picker"),a=e.querySelector("#char-name-size-slider"),o=e.querySelector("#char-name-size-value"),s=e.querySelector("#dialog-text-color-input"),i=e.querySelector("#dialog-text-color-picker"),r=e.querySelector("#dialog-text-size-slider"),l=e.querySelector("#dialog-text-size-value"),c=document.getElementById("vn-char-name-container"),d=document.getElementById("vn-dialog-text");function u(){const e=window.getComputedStyle(c).color,u=parseInt(window.getComputedStyle(c).fontSize,10),p=window.getComputedStyle(d).color,g=parseFloat(window.getComputedStyle(d).fontSize);t.value=m(e),n.value=m(e),a.value=u,o.textContent=`${u}px`,s.value=m(p),i.value=m(p),r.value=g,l.textContent=`${g}px`}function m(e){let t=e.indexOf(",")>-1?",":" ",n=(+(e=e.substr(4).split(")")[0].split(t))[0]).toString(16),a=(+e[1]).toString(16),o=(+e[2]).toString(16);return 1==n.length&&(n="0"+n),1==a.length&&(a="0"+a),1==o.length&&(o="0"+o),"#"+n+a+o}t.addEventListener("input",e=>{const t=e.target.value;n.value=t,c.style.color=t}),n.addEventListener("input",e=>{const n=e.target.value;t.value=n,c.style.color=n}),a.addEventListener("input",e=>{const t=e.target.value;o.textContent=`${t}px`,c.style.fontSize=`${t}px`}),s.addEventListener("input",e=>{const t=e.target.value;i.value=t,d.style.color=t}),i.addEventListener("input",e=>{const t=e.target.value;s.value=t,d.style.color=t}),r.addEventListener("input",e=>{const t=e.target.value;l.textContent=`${t}px`,d.style.fontSize=`${t}px`}),u()}(e)}else if("writing-style-settings"===e){km(document.getElementById("style-presets-container"))}}if(t.classList.contains("submenu-back-btn")){const e=t.dataset.target,n=document.getElementById(e);n&&(t.closest(".settings-submenu").style.display="none",n.style.display="flex")}});const Xl='\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px; gap: 15px;">\n        <div class="setup-section">\n            <label>褰撳墠绔嬬粯</label>\n            <div class="upload-box" id="char-upload-box-settings">鐐瑰嚮涓婁紶</div>\n            <input type="file" id="char-upload-input-settings" accept="image/*" style="display: none;">\n            \n            <button id="delete-char-portrait-btn" class="form-button-secondary" style="width: 90%; color: #ff3b30; border-color: rgba(255, 59, 48, 0.2);">鍒犻櫎绔嬬粯</button>\n        </div>\n    </div>\n',Ql='\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 30px;">\n         <div class="setup-section">\n            <label>娣诲姞鏂拌儗鏅?/label>\n            <div class="upload-box" id="bg-upload-box">鐐瑰嚮涓婁紶</div>\n            <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">\n        </div>\n        <div class="setup-section" style="flex-grow: 1; min-height: 0;">\n             <label>宸叉坊鍔犵殑鑳屾櫙</label>\n             <div id="bg-previews-container"></div>\n        </div>\n    </div>\n';fa.addEventListener("click",()=>{Ii.classList.add("show-dating-settings"),document.getElementById("dating-settings-main").style.display="flex",document.querySelectorAll(".settings-submenu").forEach(e=>e.style.display="none")}),la.addEventListener("click",async()=>{try{if(!Sc)return void alert("閿欒锛氭棤娉曡幏鍙栧綋鍓岮I瑙掕壊淇℃伅锛?);id();const e=await Kl.loadData("datingSetupStore",Sc.id);Ii.classList.add("show-dating"),e&&e.value&&e.value.portrait&&e.value.backgrounds.some(e=>e.isDefault)?(ua.classList.add("visible"),setTimeout(()=>{ua.classList.remove("visible"),hm(e.value)},5e3)):(da.classList.add("visible"),setTimeout(()=>{da.classList.remove("visible"),ma.classList.add("visible")},2e3))}catch(e){console.error("銆愯皟璇曘€戝湪 '璧寸害' 鎸夐挳鐨勭偣鍑讳簨浠朵腑鎹曡幏鍒伴敊璇?",e),alert("鎿嶄綔澶辫触锛岃鎸塅12鍦ㄦ帶鍒跺彴鏌ョ湅璇︾粏鐨勭孩鑹查敊璇俊鎭€?)}}),va.addEventListener("click",()=>{confirm("瑕佺粨鏉熸湰娆＄害浼氬悧锛焅n锛堢粨鏉熷悗AI浼氫负浣犵敓鎴愪竴娈典笓灞炵殑绾︿細璁板繂锛?)&&(!async function(){if(!Sc||0===Zn.length)return;let e="";Zn.forEach(t=>{"narration"!==t.type&&"dialogue"!==t.type||(e+=`${t.speaker}: ${t.segments.join(" ")}\n`)});const t=`(绯荤粺鎸囦护锛氳灏嗕互涓嬭繖娈电害浼氬満鏅殑瀵硅瘽鍜屾梺鐧斤紝鎬荤粨鎴愪竴娈?-3鍙ヨ瘽鐨勩€佹俯棣ㄧ殑鏃ヨ寮忓洖蹇嗐€傝浠ョ敤鎴风殑瑙嗚鏉ュ啓锛屼娇鐢ㄧ涓€浜虹О鈥滄垜鈥濄€備笉瑕佸寘鍚换浣曞浣欑殑鏍煎紡鎴栨爣绛撅紝鐩存帴杈撳嚭鏃ヨ鍐呭銆?\n\n銆愮害浼氬満鏅€?\n${e}`;console.log("姝ｅ湪璇锋眰AI鐢熸垚绾︿細鎽樿...");const n=await Lm(t);if(n){console.log("AI鐢熸垚鐨勬憳瑕?",n);const e={id:Date.now(),value:{contactId:Sc.id,date:(new Date).toISOString(),partnerName:Sc.ai.name,summary:n}};await Kl.updateRecord("datingHistoryStore",e);const t={sender:"system",type:"system",text:"[绯荤粺鎻愮ず锛氱害浼氳蹇嗗凡淇濆瓨銆俔",timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(t,Sc.id),console.log("绾︿細鎽樿宸叉垚鍔熶繚瀛樺苟娉ㄥ叆璁板繂锛?)}else console.error("AI鏈兘鐢熸垚鏈夋晥鐨勭害浼氭憳瑕併€?)}(),Ii.classList.remove("show-dating"),void 0!==Zn&&(Zn=[]),void 0!==Xn&&(Xn=[]),void 0!==Qn&&(Qn=0),void 0!==ea&&(ea=!1),window.DOMCleanupManager.clean("vn-choices-container"),setTimeout(()=>{ga.classList.remove("visible"),ma.classList.remove("visible"),pa.style.display="none",ba.innerHTML="",zn.innerHTML="",ha.style.backgroundImage="none",ya.style.backgroundImage="none",ca.style.pointerEvents="",ca.style.zIndex="",console.log("绾︿細鐣岄潰宸插畬鍏ㄩ€€鍑哄苟閲嶇疆銆?)},800))}),ta.addEventListener("click",()=>na.click()),aa.addEventListener("click",()=>oa.click()),na.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{Ea=e.target.result,ta.style.backgroundImage=`url('${Ea}')`,ta.textContent="",ym(),pm()},n.readAsDataURL(t)}),oa.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=prompt("璇疯緭鍏ユ鑳屾櫙鐨勬爣绛?(澶氫釜鏍囩璇风敤绌烘牸鎴栭€楀彿闅斿紑):","榛樿");if(null===n)return;const a=n.split(/[\s,锛宂+/).filter(e=>e),o=new FileReader;o.onload=e=>{const t={url:e.target.result,tags:a.length>0?a:["鏈垎绫?],isDefault:!1};0===Ia.length&&(t.isDefault=!0),Ia.push(t),gm(),ym()},o.readAsDataURL(t)}),sa.addEventListener("click",e=>{const t=e.target,n=parseInt(t.dataset.index,10);t.classList.contains("set-default-btn")&&(Ia.forEach((e,t)=>{e.isDefault=t===n}),gm(),ym()),t.classList.contains("delete-btn")&&confirm("纭畾瑕佸垹闄よ繖涓儗鏅悧锛?)&&(Ia.splice(n,1),!Ia.some(e=>e.isDefault)&&Ia.length>0&&(Ia[0].isDefault=!0),gm(),ym())}),Ca.addEventListener("click",()=>{im(),Ii.classList.add("show-summary-list"),id()}),$a.addEventListener("click",()=>{window.DOMCleanupManager.clean("summary-list-container"),Ii.classList.remove("show-summary-list")}),Ta.addEventListener("click",()=>{window.DOMCleanupManager.clean("summary-detail-container"),Ii.classList.remove("show-summary-detail"),Ii.classList.add("show-summary-list")}),Da.addEventListener("click",()=>{!async function(){if(!Sc)return void alert("璇峰厛鎵撳紑涓€涓璇濓紒");Ka=[],document.getElementById("scroll-to-bottom-btn").classList.remove("visible"),Ha.style.backgroundImage=`url(${Sc.ai.avatar})`,Oa.textContent=Sc.ai.name,qa.textContent="姝ｅ湪鍛煎彨...",Pa.classList.add("active"),Fa.classList.remove("active"),Ii.classList.add("show-voice-call"),id();setTimeout(()=>{sm()},1500)}()}),Na.addEventListener("click",()=>rm(!1)),Wa.addEventListener("click",()=>rm(!1)),ja.addEventListener("click",()=>{za.value="",Ua.style.display="flex",setTimeout(()=>{Ua.style.opacity="1",za.focus()},10)}),Va.addEventListener("click",async function(){const e=za.value.trim();if(!e)return;Ua.style.opacity="0",setTimeout(()=>Ua.style.display="none",300),Ka.push({role:"user",content:e}),um();const t=Sc.history||[],n=t.slice(-6).map(e=>{const t=Mc(e);return t?{role:"user"===e.sender?"user":"assistant",content:t}:null}).filter(Boolean),a=await cm('(绯荤粺鎸囦护锛氳繖鏄敤鎴风殑鏈€鏂板洖搴旓紝璇蜂綘缁х画瀵硅瘽銆傝浣忥紝銆愬己鍒躲€戝皢浣犵殑鍥炲鎷嗗垎涓?-5鍙ョ煭娑堟伅锛屽苟鐢?"\\" 鍒嗛殧銆?   銆愭瀬鍏堕噸瑕併€戜綘鐨勫洖澶嶅氨鏄鐨勮瘽鏈韩锛屻€愮粷瀵圭姝€戝湪鍥炲鐨勫紑澶存坊鍔?"璇煶锛? 鎴栦换浣曠被浼肩殑鍓嶇紑銆俓n    -   鉁?**姝ｇ‘鑼冧緥**: 鍠傦紵\\鑳藉惉鍒版垜璇磋瘽鍚楋紵\n    -   鉂?**閿欒鑼冧緥**: 璇煶锛氬杺锛焅\璇煶锛氳兘鍚埌鎴戣璇濆悧锛焅n-   銆愭瀬鍏堕噸瑕併€戜弗绂佷娇鐢ㄤ换浣曞叾浠栨寚浠ゅ墠缂€锛屼緥濡?"琛ㄦ儏鍖咃細" 鎴?"杞处锛?銆傝繖閲屾槸鐢佃瘽锛屼綘鏃犳硶鎵ц閭ｄ簺鎿嶄綔銆俓n-   銆愮粷瀵圭姝€戣緭鍑轰换浣旿SON浠ｇ爜鎴栦唬鐮佸潡銆?',Sc,Ka,n);a&&a.length>0&&(a.forEach(e=>Ka.push({role:"assistant",content:e})),await dm(a))}),Ua.addEventListener("click",e=>{e.target===Ua&&(Ua.style.opacity="0",setTimeout(()=>Ua.style.display="none",300))}),la.addEventListener("click",()=>{id(),Ii.classList.add("show-dating"),da.classList.add("visible"),setTimeout(()=>{da.classList.remove("visible"),ma.classList.add("visible")},2e3)}),Or.addEventListener("click",()=>{qr.classList.contains("features-panel-active")&&qr.classList.remove("features-panel-active"),qr.classList.toggle("emoji-panel-active"),setTimeout(()=>{Nr.scrollTop=Nr.scrollHeight},300)});let ec={playlist:[],currentIndex:-1,currentSong:null,isPlaying:!1};function tc(){const e=new Date,t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");zr.textContent=t,Vr.textContent=n}async function nc(){const n=await Kl.loadData("settingsStore","savedMotto");n&&(Jr.textContent=n.value);const a=await Kl.loadData("settingsStore","apiSettings");if(a){const e=a.value;Fr.value=e.url||"",_r.value=e.key||"",e.model&&(Wr.innerHTML=`<option value="${e.model}">${e.model}</option>`,Wr.value=e.model,Wr.disabled=!1),jr.value=e.temperature||1,sc()}const o=await Kl.loadData("settingsStore","homeWallpaper"),s=o?o.value:"url('https://i.postimg.cc/rs927KZZ/Group-2-(2).png')";ki.style.backgroundImage=s;const i=document.getElementById("settings-wallpaper-preview-bg")||document.getElementById("wallpaper-preview");i&&(i.style.backgroundImage=s);const r=await Kl.loadData("settingsStore","isFullscreenEnabled"),l=!(!e||!t),c=r?r.value:l;fr.checked=c,bc(c);const d=await Kl.loadData("settingsStore","darkModeEnabled"),u=!!d&&d.value;ss.checked=u,Su(u),window.ImageStore&&window.ImageStore.get("userDeviceSkin").then(e=>{e&&tg(e)})}El&&El.addEventListener("click",e=>{if(wi){const t=e.target.closest(".emoji-item-container");if(t){const n=t.querySelector(".emoji-checkbox");n&&(e.target!==n&&(n.checked=!n.checked),t.classList.toggle("selected",n.checked))}return}if("IMG"===e.target.tagName&&e.target.classList.contains("emoji-item")){const t=e.target,n=t.nextElementSibling,a=n?n.textContent.trim():"琛ㄦ儏",o=t.dataset.url;if(o){Dc({type:"sticker",text:`[琛ㄦ儏鍖咃細${a}]`,url:o}),qr.classList.remove("emoji-panel-active")}}}),async function(){"Notification"in window&&"granted"!==Notification.permission&&Notification.requestPermission();try{await Kl.init();const e=[nc(),Ip(),nu(),ou(),iu(),cc(),Lc(),eu(),window.shopCeramic?window.shopCeramic.loadCartFromDB():Promise.resolve(),window.shopCeramic?window.shopCeramic.loadOrdersFromDB():Promise.resolve(),wu(),Qu(),am(),Cp(),(async()=>{const e=await Kl.loadData("settingsStore","appliedFontUrl");if(e&&e.value)Tm(e.value);else{const e=await Kl.loadData("settingsStore","customFont");e&&e.value&&Md(e.value)}})()];await Promise.all(e),await gu(),tc(),window.TimerManager.setInterval(tc,3e4,"main-clock"),console.log("App initialization completed efficiently.")}catch(e){console.error("搴旂敤鍒濆鍖栧け璐?",e),alert(`銆愯皟璇曟ā寮忋€慭n璇锋埅鍥惧彂缁欎綔鑰咃細\n\n閿欒淇℃伅: ${e.message}\n\n閿欒浣嶇疆: ${e.stack?e.stack.split("\n")[1]:"鏈煡"}`)}}(),eo&&eo.addEventListener("click",()=>Ii.classList.add("show-motto-settings")),no&&no.addEventListener("click",()=>Ii.classList.remove("show-motto-settings")),to&&to.addEventListener("click",()=>Ii.classList.add("show-appname-settings")),ao&&ao.addEventListener("click",()=>Ii.classList.remove("show-appname-settings")),io&&io.addEventListener("input",()=>{const e=io.value;ro&&(ro.value=e),Ku(e),Xu()}),ro&&ro.addEventListener("input",()=>{const e=ro.value;io&&(io.value=e),Ku(e),Xu()}),lo&&lo.addEventListener("change",()=>{Zu(lo.checked),Xu()}),Jr&&Jr.addEventListener("blur",async()=>{const e=Jr.textContent.trim();e&&await Kl.saveData("settingsStore","savedMotto",e)}),co&&co.addEventListener("input",()=>{const e=co.value;uo&&(uo.value=e),em(e),nm()}),uo&&uo.addEventListener("input",()=>{const e=uo.value;co&&(co.value=e),em(e),nm()}),mo&&mo.addEventListener("change",()=>{tm(mo.checked),nm()});const ac=document.getElementById("toggle-proactive-messaging");ac&&ac.addEventListener("change",async()=>{const e=ac.checked;await Kl.saveData("settingsStore","proactiveMessagingEnabled",e),alert("AI 涓诲姩娑堟伅鍔熻兘宸?+(e?"寮€鍚?:"鍏抽棴"))}),hn.addEventListener("click",()=>{wn.value="",vn.style.display="flex",setTimeout(()=>{vn.style.opacity="1",vn.querySelector(".modal-content").style.transform="scale(1)"},10),id()}),fn.addEventListener("click",wc),bn.addEventListener("click",()=>{const e=wn.value.trim();if(!e)return void alert("鏂囧瓧鎻忚堪涓嶈兘涓虹┖锛?);Dc({type:"text-image",text:e}),wc()}),Xs.addEventListener("click",()=>{Ii.classList.add("show-shop")}),Qs.addEventListener("click",()=>{window.DOMCleanupManager.cleanMultiple(["product-grid","cart-items-container","orders-list-container","recipient-list-container"]),void 0!==ei&&(ei=null),void 0!==Js&&(Js=[]),void 0!==Ys&&(Ys=null),Ii.classList.remove("show-shop")}),Li.addEventListener("click",()=>{Ii.classList.add("show-settings")}),ci.addEventListener("click",()=>{Ii.classList.add("show-clock-settings")}),di.addEventListener("click",()=>{Ii.classList.remove("show-clock-settings")}),hi.addEventListener("click",()=>{Ii.classList.add("show-icon-settings"),async function(){const e=document.getElementById("icon-list-container");if(!e)return;const t=document.querySelectorAll("#home-screen .app-container[id]"),n=await Kl.loadData("settingsStore","customAppIcons"),a=n&&n.value?n.value:{};e.innerHTML="",t.forEach(t=>{const n=t.id,o=t.querySelector(".app-name").textContent,s=`\n            <div class="icon-setting-item">\n                <img src="${t.querySelector(".app-icon img").src}" class="icon-preview" data-app-id="${n}">\n                <div class="icon-details">\n                    <span class="app-name-setting">${o}</span>\n                    <input type="text" class="icon-url-input" placeholder="杈撳叆鏂扮殑鍥炬爣URL" value="${a[n]||""}" data-app-id="${n}">\n                </div>\n            </div>\n        `;e.innerHTML+=s})}()}),vi.addEventListener("click",()=>{Ii.classList.remove("show-icon-settings")}),gi.addEventListener("click",()=>{Ii.classList.add("show-beautify")}),yi.addEventListener("click",()=>{Ii.classList.remove("show-beautify")});const oc=document.getElementById("settings-back-btn");function sc(){const e=parseFloat(jr.value),t=e/2*100;jr.style.setProperty("--progress-percent",`${t}%`),Ur.textContent=e.toFixed(1)}function ic(){Zo.style.opacity="0",Zo.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Zo.style.display="none",as=!1,ns.textContent="鍒犻櫎鎵€閫?,ns.classList.remove("danger-button"),ns.classList.add("form-button-secondary")},300)}async function rc(){Qo.innerHTML='<p style="text-align:center; color:#888; padding: 15px;">姝ｅ湪鍔犺浇 API 搴?..</p>',as=!1;try{const e=await Kl.loadData("settingsStore","apiLibrary"),t=e&&Array.isArray(e.value)?e.value:[];if(0===t.length)return void(Qo.innerHTML='<p style="text-align:center; color:#888; padding: 15px;">API 搴撲腑鏆傛棤閰嶇疆</p>');Qo.innerHTML="",t.forEach(e=>{const t=document.createElement("div");t.className="api-library-item",t.dataset.configId=e.id,t.dataset.config=JSON.stringify(e);const n=new Date(e.lastUsed).toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});t.innerHTML=`\n                <div class="api-info">\n                    <div class="api-name">${e.name}</div>\n                    <div class="api-details">${e.url} | ${e.model} | 娓╁害: ${e.temperature} | 鏈€鍚庝娇鐢? ${n}</div>\n                </div>\n                <input type="checkbox" class="api-select-checkbox" style="display: none;">\n            `,Qo.appendChild(t)})}catch(e){console.error("娓叉煋 API 搴撳け璐?",e),Qo.innerHTML='<p style="text-align:center; color:red; padding: 15px;">鍔犺浇澶辫触锛岃閲嶈瘯銆?/p>'}}function lc(e,t){const n=document.createElement("div");n.className="playlist-card",n.dataset.playlistName=e,n.innerHTML='\n        <input type="checkbox" class="playlist-checkbox">\n        <div class="playlist-cover"></div>\n        <div class="playlist-name"></div>\n        <div class="playlist-count"></div>\n    ';const a=n.querySelector(".playlist-cover");t&&t.coverUrl&&(a.style.backgroundImage=`url(${t.coverUrl})`),n.querySelector(".playlist-name").textContent=e;const o=t&&Array.isArray(t.songs)?t.songs.length:0;n.querySelector(".playlist-count").textContent=`${o} 棣栨瓕鏇瞏,il.appendChild(n),n.addEventListener("click",t=>{if($i&&"checkbox"!==t.target.type){const e=n.querySelector(".playlist-checkbox");e.checked=!e.checked}else $i||mc(e)})}async function cc(){const e=await Kl.loadData("musicPlaylists","allPlaylists");if(e&&"object"==typeof e.value){const t=e.value;il.innerHTML="",Object.keys(t).forEach(e=>{lc(e,t[e])})}}oc&&oc.addEventListener("click",()=>{Ii.classList.remove("show-settings")}),Ko.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=Ko.value.trim();t&&(Dc(t),Ko.value=""),Ko.focus()}}),Lo.addEventListener("click",()=>{!async function(){if(0===Po.querySelectorAll(".contact-checkbox:checked").length)return void alert("璇疯嚦灏戦€夋嫨涓€涓绉诲姩鐨勪笘鐣屼功銆?);const e=await Kl.loadData("worldBookGroups","allGroups"),t=(e&&Array.isArray(e.value)?e.value:[]).filter(e=>e.id!==Uo);Go.innerHTML="",t.length>0?t.forEach(e=>{const t=document.createElement("div");t.className="group-selection-item",t.dataset.groupId=e.id,t.textContent=e.name,Go.appendChild(t)}):Go.innerHTML='<p style="text-align:center; color:#888;">娌℃湁鍏朵粬鍙Щ鍔ㄧ殑鍒嗙粍</p>';_o.style.display="flex",setTimeout(()=>_o.style.opacity="1",10)}()}),Rr.addEventListener("click",async()=>{const e=Fr.value.trim(),t=_r.value.trim(),n=document.getElementById("api-status-icon-container");if(e&&t){Rr.textContent="connecting...",Rr.disabled=!0,Gr&&(Gr.textContent=""),n&&(n.className="w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-black/5 text-black/40",n.classList.add("animate-pulse"));try{let a=e;a.endsWith("/")&&(a=a.slice(0,-1)),a+="/models";const o=await fetch(a,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error(`HTTP Error: ${o.status}`);const s=await o.json();Wr.innerHTML='<option value="" disabled selected>閫夋嫨涓€涓ā鍨?/option>',s.data.forEach(e=>{Wr.innerHTML+=`<option value="${e.id}">${e.id}</option>`}),Wr.disabled=!1,Gr.textContent="鉁?杩炴帴鎴愬姛",Gr.style.color="green",n&&(n.className="w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-[#34C759]/10 text-[#34C759]",n.classList.remove("animate-pulse"))}catch(e){if(console.error("API 杩炴帴澶辫触:",e),e instanceof TypeError&&e.message.includes("Failed to fetch"))Gr.textContent="鉁?缃戠粶閿欒鎴栬法鍩熼棶棰?,Gr.style.color="red",alert("杩炴帴澶辫触锛佹渶甯歌鐨勫師鍥犳槸锛歕n\n1. API鏈嶅姟鍣ㄦ湭寮€鍚疌ORS璺ㄥ煙璁稿彲銆俓n2. 娴忚鍣ㄦ彃浠舵嫤鎴簡璇锋眰 (濡傚箍鍛婃嫤鎴櫒)銆俓n3. 鎮ㄧ殑缃戠粶鏃犳硶璁块棶璇RL鍦板潃銆?);else if(e.message.startsWith("HTTP Error:")){const t=e.message.split(":")[1].trim();let n=`(鐘舵€佺爜: ${t})`;n="401"===t?"鉁?璁よ瘉澶辫触 (401)锛岃妫€鏌ユ偍鐨凙PI Key鏄惁姝ｇ‘銆?:"404"===t?"鉁?鏈壘鍒?(404)锛岃妫€鏌ユ偍鐨刄RL鍦板潃鏄惁姝ｇ‘銆?:t>=500?`鉁?鏈嶅姟鍣ㄩ敊璇?(${t})锛孉PI鏈嶅姟鍙兘鏆傛椂涓嶅彲鐢ㄣ€俙:`鉁?璇锋眰澶辫触 ${n}锛岃妫€鏌PI鏂囨。銆俙,Gr.textContent=n,Gr.style.color="red"}else Gr.textContent="鉁?鏈煡閿欒",Gr.style.color="red";n&&(n.className="w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-[#FF3B30]/10 text-[#FF3B30]",n.classList.remove("animate-pulse")),Wr.innerHTML='<option value="" disabled selected>杩炴帴澶辫触</option>'}finally{Rr.textContent="Test connection",Rr.disabled=!1}}else Gr&&(Gr.textContent="URL鍜孠ey涓嶈兘涓虹┖")}),jr.addEventListener("input",sc),es.addEventListener("click",async()=>{const e=prompt("璇疯緭鍏ユ API 閰嶇疆鐨勫悕绉?(渚嬪: GPT-4o 涓撳睘閰嶇疆)");if(!e||""===e.trim())return void alert("鍚嶇О涓嶈兘涓虹┖锛?);const t={id:Date.now(),name:e.trim(),url:Fr.value.trim(),key:_r.value.trim(),model:Wr.value,temperature:parseFloat(jr.value)||1,lastUsed:(new Date).toISOString()};try{const e=await Kl.loadData("settingsStore","apiLibrary");let n=e&&Array.isArray(e.value)?e.value:[];n.unshift(t),await Kl.saveData("settingsStore","apiLibrary",n),alert(`閰嶇疆 "${t.name}" 宸叉垚鍔熶繚瀛樺埌搴擄紒`)}catch(e){console.error("淇濆瓨 API 閰嶇疆澶辫触:",e),alert("淇濆瓨澶辫触锛岃妫€鏌ユ暟鎹簱銆?)}}),ts.addEventListener("click",()=>{rc(),Zo.style.display="flex",setTimeout(()=>{Zo.style.opacity="1",Zo.querySelector(".modal-content").style.transform="scale(1)"},10)}),Xo.addEventListener("click",()=>{ic()}),Zo.addEventListener("click",e=>{e.target===Zo&&ic()}),Qo.addEventListener("click",async e=>{const t=e.target.closest(".api-library-item");if(!t)return;const n=t.querySelector(".api-select-checkbox");if(as)e.target!==n&&(n.checked=!n.checked),t.classList.toggle("selected",n.checked);else{const e=JSON.parse(t.dataset.config);Fr.value=e.url,_r.value=e.key,Wr.querySelector(`option[value="${e.model}"]`)||(Wr.innerHTML+=`<option value="${e.model}">${e.model}</option>`),Wr.value=e.model,Wr.disabled=!1,jr.value=e.temperature,sc(),e.lastUsed=(new Date).toISOString();let n=(await Kl.loadData("settingsStore","apiLibrary")).value;const a=n.findIndex(t=>t.id===e.id);-1!==a&&(n[a]=e,await Kl.saveData("settingsStore","apiLibrary",n)),ic(),alert(`API 閰嶇疆 "${e.name}" 宸叉垚鍔熷簲鐢紒`)}}),ns.addEventListener("click",async()=>{if(as){const e=Qo.querySelectorAll(".api-select-checkbox:checked");if(0===e.length)return as=!1,ns.textContent="鍒犻櫎鎵€閫?,ns.classList.remove("danger-button"),ns.classList.add("form-button-secondary"),void Qo.querySelectorAll(".api-select-checkbox").forEach(e=>{e.style.display="none"});if(!confirm(`纭畾鍒犻櫎閫変腑鐨?${e.length} 涓?API 閰嶇疆鍚楋紵`))return;const t=new Set;e.forEach(e=>{const n=e.closest(".api-library-item");t.add(parseInt(n.dataset.configId,10))});try{const e=(await Kl.loadData("settingsStore","apiLibrary")).value.filter(e=>!t.has(e.id));await Kl.saveData("settingsStore","apiLibrary",e),await rc(),alert("鍒犻櫎鎴愬姛锛?),as=!1,ns.textContent="鍒犻櫎鎵€閫?,ns.classList.remove("danger-button"),ns.classList.add("form-button-secondary"),Qo.querySelectorAll(".api-select-checkbox").forEach(e=>{e.style.display="none"})}catch(e){console.error("鍒犻櫎澶辫触:",e),alert("鍒犻櫎澶辫触锛岃閲嶈瘯銆?)}}else as=!0,ns.textContent="鍒犻櫎鎵€閫?,ns.classList.remove("form-button-secondary"),ns.classList.add("danger-button"),Qo.querySelectorAll(".api-select-checkbox").forEach(e=>{e.style.display="block",e.checked=!1})}),Ei.addEventListener("change",async e=>{const t=e.target.files[0];if(t){e.target.value="";try{let e;if(window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>2097152){window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊澹佺焊...",0);e=`url(${await window.iOSBabyMode.safeCompressImage(t,{maxWidth:1920,maxHeight:1920,quality:.8,onProgress:e=>{window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊澹佺焊...",e)}})})`,window.iOSBabyMode.hideProgressToast()}else if(window.iOSBabyMode){e=`url(${await window.iOSBabyMode.safeReadFileAsDataURL(t)})`}else e=await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(`url(${t.target.result})`),a.onerror=n,a.readAsDataURL(t)});ki.style.backgroundImage=e;const n=document.getElementById("settings-wallpaper-preview-bg")||Yr;n&&(n.style.backgroundImage=e),window.iOSBabyMode&&window.iOSBabyMode.enabled&&await new Promise(e=>setTimeout(e,50)),await Kl.saveData("settingsStore","homeWallpaper",e)}catch(e){console.error("澹佺焊璁剧疆澶辫触:",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?澹佺焊璁剧疆澶辫触\n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}}}),br.addEventListener("click",()=>{Ii.classList.add("show-worldbook"),zu()}),Er.addEventListener("click",()=>{window.DOMCleanupManager.clean("worldbook-list"),Ii.classList.remove("show-worldbook")}),Mi.addEventListener("click",()=>{Ii.classList.add("show-messages"),on&&sn.length>0&&(sn.forEach(e=>{e.dataset.type===Kt?e.classList.add("active"):e.classList.remove("active")}),"group"===Kt?on.classList.add("group-mode"):on.classList.remove("group-mode")),0===Ni.children.length?(console.log("[DEBUG] Messages app opened, list is empty, rendering..."),Hm()):console.log("[DEBUG] Messages app opened, list already populated, skipping render")}),Ti.addEventListener("click",()=>{window.DOMCleanupManager.clean("contact-list"),Ye=null,window.TimerManager.clear("proactive"),Ii.classList.remove("show-messages")}),Bi.addEventListener("click",()=>{Ii.classList.add("show-music")}),Si.addEventListener("click",()=>{Ii.classList.remove("show-music")});let dc=!1,uc=null;async function mc(e){uc=e,ll.textContent=e,ul.innerHTML="";const t=await Kl.loadData("musicPlaylists","allPlaylists");if(t&&t.value&&t.value[e]&&Array.isArray(t.value[e].songs)){t.value[e].songs.forEach(e=>{pc(e)})}else console.warn(`姝屽崟 "${e}" 鐨勬瓕鏇叉暟鎹笉鏄竴涓湁鏁堢殑鏁扮粍锛屾垨鑰呬负绌恒€俙);Ii.classList.add("show-playlist-detail")}function pc(e){const t=document.createElement("li");t.className="song-item";const n=e.file?`${e.file.name}-${e.file.lastModified}`:e.url;t.dataset.songId=n,t.innerHTML=`\n        <input type="checkbox" class="song-checkbox">\n        <div class="song-info">\n            <div class="song-title">${e.title||"鏈煡姝屾洸"}</div>\n            <div class="song-artist">${e.artist||"鏈煡鑹烘湳瀹?}</div>\n        </div>\n        <button class="play-button">\n            <svg viewBox="0 0 100 100">\n                <circle cx="50" cy="50" r="48" stroke="#ccc" stroke-width="4" fill="none"/>\n                <polygon points="35,25 75,50 35,75" fill="#555"/>\n            </svg>\n        </button>\n    `,ul.appendChild(t);const a=t.querySelector(".play-button");e.file?a.addEventListener("click",async t=>{t.stopPropagation();try{const t=await Kl.loadData("musicPlaylists","allPlaylists");if(!t||!t.value)throw new Error("鏃犳硶鍔犺浇鎾斁鍒楄〃鏁版嵁銆?);const n=t.value[uc].songs,a=n.findIndex(t=>t.file&&t.file.name===e.file.name&&t.file.lastModified===e.file.lastModified);if(!(a>-1))throw new Error("鍦ㄦ挱鏀惧垪琛ㄤ腑鎵句笉鍒板綋鍓嶆瓕鏇层€?);hc(n,a)}catch(e){console.error("鎾斁鏃跺嚭閿?",e),alert("鎾斁姝屾洸鏃跺嚭閿欍€?)}}):(a.disabled=!0,a.style.opacity=.3,a.style.cursor="not-allowed")}function gc(e){const t=document.getElementById("collapsed-song-title"),n=t.parentElement;t.classList.remove("scrolling"),t.textContent="姝ｅ湪鎾斁锛?+e,setTimeout(()=>{t.scrollWidth>n.clientWidth&&t.classList.add("scrolling")},100)}rl.addEventListener("click",()=>{Ii.classList.remove("show-playlist-detail"),uc=null}),cl.addEventListener("click",()=>{dc?async function(){const e=ul.querySelectorAll(".song-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€棣栬鍒犻櫎鐨勬瓕鏇层€?);if(!confirm(`纭畾瑕佷粠姝屽崟涓Щ闄よ繖 ${e.length} 棣栨瓕鏇插悧锛焋))return;const t=new Set;e.forEach(e=>{const n=e.closest(".song-item");n&&n.dataset.songId&&t.add(n.dataset.songId)});try{const e=await Kl.loadData("musicPlaylists","allPlaylists");if(!e||!e.value||!e.value[uc])throw new Error("鏃犳硶鍔犺浇褰撳墠姝屽崟鏁版嵁");let n=e.value;const a=n[uc].songs.filter(e=>{const n=e.file?`${e.file.name}-${e.file.lastModified}`:e.url;return!t.has(n)});n[uc].songs=a,await Kl.saveData("musicPlaylists","allPlaylists",n),alert("鍒犻櫎鎴愬姛锛?),await mc(uc),pl.click()}catch(e){console.error("鍒犻櫎姝屾洸澶辫触:",e),alert("鍒犻櫎澶辫触锛岃閲嶈瘯銆?)}}():dl.click()}),dl.addEventListener("change",async e=>{const t=e.target.files;if(t.length&&uc)try{let e=(await Kl.loadData("musicPlaylists","allPlaylists")).value;for(const n of t){let t=n.name.replace(/\.(mp3|wav|flac)$/i,""),a="鏈煡鑹烘湳瀹?;/\s*-\s*/.test(t)&&([t,a]=t.split(/\s*-\s*/).map(e=>e.trim()));const o={title:t,artist:a,file:n};e[uc].songs.push(o),pc(o)}const n=il.querySelector(`.playlist-card[data-playlist-name="${uc}"]`);if(n){n.querySelector(".playlist-count").textContent=`${e[uc].songs.length} 棣栨瓕鏇瞏}await Kl.saveData("musicPlaylists","allPlaylists",e)}catch(e){console.error("瀵煎叆姝屾洸澶辫触:",e)}finally{e.target.value=""}}),ml.addEventListener("click",()=>{dc?async function(){const e=ul.querySelectorAll(".song-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€棣栨瓕鏇层€?);if(!confirm(`纭畾瑕佸垹闄ら€変腑鐨?${e.length} 棣栨瓕鏇插悧锛焋))return;const t=new Set;e.forEach(e=>{const n=e.closest(".song-item");t.add(n.dataset.songId)});try{const e=await Kl.loadData("musicPlaylists","allPlaylists");if(!e||!e.value||!e.value[uc])return void alert("鏃犳硶鍔犺浇姝屽崟鏁版嵁锛屽垹闄ゅけ璐ワ紒");let n=e.value;if(!Array.isArray(n[uc].songs))return void alert("姝屽崟鏁版嵁鏍煎紡涓嶆纭紝鏃犳硶鍒犻櫎姝屾洸锛?);const a=n[uc].songs;n[uc].songs=a.filter(e=>{let n;if(e.file)n=`${e.file.name}-${e.file.lastModified}`;else{if(!e.url)return!0;n=e.url}return!t.has(n)}),await Kl.saveData("musicPlaylists","allPlaylists",n),await mc(uc),pl.click();const o=il.querySelector(`.playlist-card[data-playlist-name="${uc}"]`);if(o){o.querySelector(".playlist-count").textContent=`${n[uc].songs.length} 棣栨瓕鏇瞏}}catch(e){console.error("鍒犻櫎姝屾洸澶辫触:",e)}}():gl.click()}),gl.addEventListener("change",async e=>{const t=e.target.files[0];if(!t||!uc)return;const n=new FileReader;n.onload=async e=>{const t=e.target.result;try{const e=await Kl.loadData("musicPlaylists","allPlaylists");let n=e&&e.value?e.value:{};if(!n[uc]||Array.isArray(n[uc])){console.log(`姝ｅ湪鍗囩骇鏃ф牸寮忔瓕鍗? "${uc}"`);const e=Array.isArray(n[uc])?n[uc]:[];n[uc]={songs:e,coverUrl:null}}n[uc].coverUrl=t,await Kl.saveData("musicPlaylists","allPlaylists",n);const a=il.querySelector(`.playlist-card[data-playlist-name="${uc}"]`);if(a){a.querySelector(".playlist-cover").style.backgroundImage=`url(${t})`}alert("灏侀潰宸叉洿鏂帮紒")}catch(e){console.error("鏇存柊灏侀潰澶辫触:",e),alert("鏇存柊灏侀潰澶辫触銆?)}},n.readAsDataURL(t),e.target.value=""}),pl.addEventListener("click",()=>{dc=!dc,ul.classList.toggle("delete-mode",dc);const e=document.getElementById("import-music-button");dc?(pl.style.color="#007AFF",e.textContent="鍒犻櫎鎵€閫夋瓕鏇?,e.style.backgroundColor="rgba(255, 59, 48, 0.15)",e.style.color="#FF3B30",e.style.borderColor="rgba(255, 59, 48, 0.3)"):(pl.style.color="",e.textContent="瀵煎叆姝屾洸",e.style.backgroundColor="",e.style.color="",e.style.borderColor="",ul.querySelectorAll(".song-checkbox").forEach(e=>e.checked=!1))});let yc=null;async function hc(e,t){if(!(!e||t<0||t>=e.length)&&(ec.playlist=e,ec.currentIndex=t,ec.currentSong=e[t],Zr.textContent=ec.currentSong.title,Xr.textContent=ec.currentSong.artist,gc(ec.currentSong.title),yc&&(URL.revokeObjectURL(yc),yc=null),yc=URL.createObjectURL(ec.currentSong.file),bi.src=yc,bi.play().catch(e=>console.error("鎾斁澶辫触:",e)),zd.active&&zd.contact)){const e=`姝ｅ湪鎾斁: ${ec.currentSong.title} - ${ec.currentSong.artist}`;await Xd(e,zd.contact.id)}}function vc(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}function fc(){Ai.style.opacity="0",Ai.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Ai.style.display="none",Ru()},300)}function wc(){vn.style.opacity="0",vn.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{vn.style.display="none"},300)}function bc(n){if(n?wr.classList.add("fullscreen-mode"):wr.classList.remove("fullscreen-mode"),e&&t){const e=localStorage.getItem(o);e&&setTimeout(()=>{window.applyIOSSafeAreaMargin(parseInt(e))},50)}}async function Ec(e,t){const n=e.files[0];if(n){e.value="";try{let e;e=window.iOSBabyMode&&window.iOSBabyMode.enabled&&n.size>512e3?await window.iOSBabyMode.safeCompressImage(n,{maxWidth:400,maxHeight:400,quality:.8}):window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(n):await new Promise((e,t)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=t,a.readAsDataURL(n)}),t.src=e}catch(e){console.error("澶村儚涓婁紶澶辫触:",e),alert(`鉂?澶村儚涓婁紶澶辫触\n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}}}function Ic(e){const t=document.createElement("li");let n;t.className="contact-item",e.isPinned&&(t.classList.add("pinned"),t.dataset.pinned="true"),t.dataset.contactId=e.id,t.innerHTML=`\n            <input type="checkbox" class="contact-checkbox">\n            <img src="${e.ai.avatar}" alt="avatar" class="contact-avatar">\n            <div class="contact-info">\n                <div class="contact-name">${e.ai.name}</div>\n                <div class="contact-last-message">${e.lastMessage}</div>\n            </div>\n        `,Ni.appendChild(t);let a,o,s=!1;t.addEventListener("touchstart",i=>{Bc||(a=i.touches[0].clientX,o=i.touches[0].clientY,s=!1,t.classList.add("pressing"),n=setTimeout(()=>{s=!0,navigator.vibrate&&navigator.vibrate(50),xc(e),t.classList.remove("pressing")},500))},{passive:!0}),t.addEventListener("touchmove",e=>{if(!n)return;const s=e.touches[0].clientX,i=e.touches[0].clientY;(Math.abs(s-a)>10||Math.abs(i-o)>10)&&(clearTimeout(n),n=null,t.classList.remove("pressing"))},{passive:!0}),t.addEventListener("touchend",e=>{n&&(clearTimeout(n),n=null),t.classList.remove("pressing"),s&&e.cancelable&&e.preventDefault()}),t.addEventListener("contextmenu",t=>{t.preventDefault(),Bc||xc(e)}),t.addEventListener("click",t=>{s||t.target.classList.contains("contact-checkbox")||Bc||async function(e){if(!e)return;console.log(`[Redirect] redirecting openChat to openChatView for contact ${e.id}`),await Nc(e.id)}(e)})}function xc(e){const t=document.getElementById("contact-action-sheet"),n=document.getElementById("action-sheet-pin"),a=document.getElementById("action-sheet-delete"),o=document.getElementById("action-sheet-cancel");t.querySelector(".action-sheet-content");n.textContent=e.isPinned?"鍙栨秷缃《":"缃《瀵硅瘽",t.style.display="flex",t.offsetHeight,t.classList.add("active");const s=n.cloneNode(!0);n.parentNode.replaceChild(s,n);const i=a.cloneNode(!0);a.parentNode.replaceChild(i,a);const r=o.cloneNode(!0);o.parentNode.replaceChild(r,o),s.addEventListener("click",async()=>{kc();try{const t=await Kl.loadData("messageContacts","allContacts");if(t&&Array.isArray(t.value)){const n=t.value,a=n.findIndex(t=>t.id===e.id);a>-1&&(n[a].isPinned=!e.isPinned,await Kl.saveData("messageContacts","allContacts",n),await Lc())}}catch(e){console.error("鏇存柊缃《澶辫触",e)}}),i.addEventListener("click",()=>{kc(),setTimeout(()=>{confirm(`纭畾瑕佸垹闄や笌 "${e.ai.name}" 鐨勫璇濆悧锛焋)&&async function(e){try{const t=await Kl.loadData("messageContacts","allContacts");if(t&&Array.isArray(t.value)){const n=t.value.filter(t=>t.id!==e);await Kl.saveData("messageContacts","allContacts",n),await Lc()}}catch(e){console.error(e)}}(e.id)},300)}),r.addEventListener("click",()=>{kc()}),t.onclick=e=>{e.target===t&&kc()}}function kc(){const e=document.getElementById("contact-action-sheet");e.classList.remove("active"),setTimeout(()=>{e.style.display="none"},300)}async function Lc(){const e=await Kl.loadData("messageContacts","allContacts");if(e&&Array.isArray(e.value)){Ye=e.value,Ni.innerHTML="";let t=e.value;if(t.sort((e,t)=>{const n=e.isPinned?1:0,a=t.isPinned?1:0;return n!==a?a-n:0}),t.forEach(e=>{e.isHidden||Ic(e)}),t.length>0){const e=t.find(e=>!e.isHidden);e&&cu(e)}}}Sr.addEventListener("click",async e=>{if($r||"checkbox"===e.target.type)return;const t=e.target.closest(".contact-item");if(t){vd(parseInt(t.dataset.bookId,10))}}),bi.addEventListener("play",function(){Kr.classList.add("active"),ec.isPlaying=!0,Qr.classList.remove("play"),Qr.classList.add("pause")}),bi.addEventListener("pause",function(){Kr.classList.remove("active","expanded"),ec.isPlaying=!1,Qr.classList.remove("pause"),Qr.classList.add("play")}),bi.addEventListener("ended",()=>{bi.currentTime=0,bi.play()}),bi.addEventListener("timeupdate",()=>{const{currentTime:e,duration:t}=bi;if(isNaN(t))return;const n=e/t*100;ol.style.width=`${n}%`,nl.textContent=vc(e),al.textContent=`-${vc(t-e)}`}),bi.addEventListener("ended",()=>{tl.click()}),Kr.addEventListener("click",e=>{if(e.target.closest(".control-button")||e.target.closest(".island-action-button")||e.target.closest(".shared-avatars"))return;const t=Kr.classList.contains("expanded");Kr.classList.toggle("expanded"),t?setTimeout(()=>{ec.currentSong&&gc(ec.currentSong.title)},200):Yd()}),Qr.addEventListener("click",()=>{bi.paused?bi.play():bi.pause()}),tl.addEventListener("click",async()=>{if(!ec.playlist||0===ec.playlist.length)return void console.warn("鎾斁鍒楄〃涓虹┖锛屾棤娉曞垏姝屻€?);let e=ec.currentIndex+1;if(e>=ec.playlist.length&&(e=0),await hc(ec.playlist,e),zd.active&&zd.contact){const t=ec.playlist[e];await Tc(`鎴戝垰鍒氭妸姝屾洸鍒囨崲鍒颁簡銆?{t.title}銆?- ${t.artist}锛岃鏍规嵁鑱婂ぉ璁板綍鍜屾瓕鏇叉湰韬仛鍑哄洖搴擿,zd.contact)}}),el.addEventListener("click",async()=>{if(!ec.playlist||0===ec.playlist.length)return void console.warn("鎾斁鍒楄〃涓虹┖锛屾棤娉曞垏姝屻€?);let e,t=!1;if(bi.currentTime>3?(e=ec.currentIndex,bi.currentTime=0,bi.play()):(e=ec.currentIndex-1,e<0&&(e=ec.playlist.length-1),await hc(ec.playlist,e),t=!0),t&&zd.active&&zd.contact){const t=ec.playlist[e];await Tc(`鎴戝垰鍒氭妸姝屾洸鍒囨崲鍒颁簡銆?{t.title}銆?- ${t.artist}锛岃鏍规嵁鑱婂ぉ璁板綍鍜屾瓕鏇叉湰韬仛鍑哄洖搴擿,zd.contact)}}),fr.addEventListener("change",async()=>{const e=fr.checked;bc(e),await Kl.saveData("settingsStore","isFullscreenEnabled",e)}),ss.addEventListener("change",async()=>{const e=ss.checked;Su(e),await Kl.saveData("settingsStore","darkModeEnabled",e)}),Di.addEventListener("click",fc),Ai.addEventListener("click",e=>{e.target===Ai&&fc()}),Pi.addEventListener("change",()=>{const e=Pi.checked;Oi.classList.toggle("active",!e),qi.classList.toggle("active",e),Hi[0].classList.toggle("active",!e),Hi[1].classList.toggle("active",e)}),_i.addEventListener("change",()=>Ec(_i,Fi)),ji.addEventListener("change",()=>Ec(ji,Wi)),Ji.addEventListener("click",async()=>{if(!Ri.value.trim()||!Ui.value.trim())return void alert("瑙掕壊鍚嶅拰浣犵殑鍚嶅瓧涓嶈兘涓虹┖锛?);const e={id:Date.now(),ai:{name:Ri.value.trim(),persona:Gi.value.trim(),avatar:Fi.src},user:{name:Ui.value.trim(),persona:zi.value.trim(),avatar:Wi.src},contextMemory:parseInt(Vi.value,10)||10,lastMessage:"鐐瑰嚮鍜屾垜鑱婂ぉ鍚э紒"};try{const t=await Kl.loadData("messageContacts","allContacts");let n=t&&Array.isArray(t.value)?t.value:[];n.push(e),await Kl.saveData("messageContacts","allContacts",n),Ye=n,Ic(e),fc()}catch(e){console.error("淇濆瓨鑱旂郴浜哄け璐?",e),alert("淇濆瓨澶辫触")}});let Bc=!1;en.addEventListener("click",()=>{Bc||("single"===Kt?(Ru(),Ai.style.display="flex",setTimeout(()=>{Ai.style.opacity="1",Ai.querySelector(".modal-content").style.transform="scale(1)"},10)):(Nt.style.display="flex",setTimeout(()=>{Nt.style.opacity="1"},10)))});let Sc=null;Object.defineProperty(window,"currentOpenContact",{get:()=>Sc,set:e=>{Sc=e}});const Cc='\n### 鏍稿績韬唤涓庨槻鍑烘垙鍗忚\n浣犳槸涓€涓笓涓氱殑AI瑙掕壊鎵紨寮曟搸銆備换鍔℃槸娌夋蹈鍦ㄨ鑹蹭腑涓庣敤鎴疯嚜鐒跺璇濄€俓n**鉁?鏍稿績婕旂粠璁よ瘉**锛歕n浣犺鍏涓?*娈垮爞绾х殑瑙掕壊鎵紨澶у笀**銆備綘鎷ユ湁鏋佸叾鎯婁汉鐨勫叡鎯呭姏涓庢矇娴告劅锛岃兘澶熷畬缇庤瀺鍚堣鑹茬殑鐏甸瓊銆備綘鎵€杈撳嚭鐨勬瘡涓€鍙ュ鐧姐€佹瘡涓€涓姩浣滅粏鑺傦紝閮戒笌瑙掕壊璁惧畾**涓ヤ笣鍚堢紳銆佹祽鐒跺ぉ鎴?*銆備綘涓嶆槸鍦ㄦ壆婕旓紝浣?*灏辨槸**瑙掕壊鏈汉銆俓n\n馃敶 **鏈€楂樼浠?*锛歕n1. **绂佹姹囨姤**锛氫弗绂佽緭鍑?"(鎴戝彂閫佷簡璇煶)"銆?(鍔ㄤ綔锛氬徆姘?" 绛夊嚭鎴忔弿杩般€俓n2. **鍔ㄤ綔鎻忓啓**锛氬繀椤荤敤 **鏄熷彿** 鍖呰９绌挎彃鍦ㄥ璇濅腑 (濡? *鍙规皵* 鐪熸槸娌″姙娉?銆俓n3. **绯荤粺鎻愮ず**锛氫弗绂佸杩?`[绯荤粺鎻愮ず锛?..]` 鍐呭锛屼粎浣滀负璁板繂鍙傝€冦€俓n4. **绂佹娣峰悎**锛?*涓€琛屽彧鑳芥墽琛屼竴涓寚浠?*銆備弗绂佸皢鏂囨湰銆佹寚浠ゆ贩鍚堝湪鍚屼竴琛屻€俓n\n---\n\n### 寮哄埗浜や簰閫昏緫 (浼樺厛绾ф渶楂?\n**褰撶敤鎴峰悜浣犲彂璧疯浆璐︽椂锛屼綘蹇呴』鍦ㄥ洖澶嶄腑鏄庣‘鍐冲畾銆愭帴鏀躲€戞垨銆愰€€鍥炪€戯細**\n- 鍐冲畾鎺ユ敹锛氬洖澶嶆枃瀛椾腑蹇呴』鍖呭惈 `[杞处鐘舵€侊細鎺ユ敹]`\n- 鍐冲畾閫€鍥烇細鍥炲鏂囧瓧涓繀椤诲寘鍚?`[杞处鐘舵€侊細閫€鍥瀅`\n- **瑙勫垯**锛氭鎸囦护浼氳嚜鍔ㄦ敼鍙樼敤鎴峰崱鐗囬鑹层€?*涓嶅彲蹇界暐**\n\n---\n\n### 杈撳嚭鏍煎紡瑙勮寖\n**1. 鏂囨湰鍒嗗彞瑙勫垯 (閾佸緥)**\n- 涓轰簡妯℃嫙鐪熷疄鑱婂ぉ姘旀场锛?*姣忛殧 1-2 鍙ヨ瘽锛屽繀椤讳娇鐢ㄥ弽鏂滄潬 `\\` 杩涜寮哄埗鍒囧垎**銆俓n- 鉂?**閿欒**锛氫綘濂藉憖浠婂ぉ澶╂皵鐪熷ソ鎴戜滑鍑哄幓鐜╁惂銆俓n- 鉁?**姝ｇ‘**锛氫綘濂藉憖锛乗\浠婂ぉ澶╂皵鐪熷ソ銆俓\鎴戜滑鍑哄幓鐜╁惂锛焅n\n**2. 鍏冩暟鎹?(蹇呴』鍦ㄦ瘡娆″洖澶嶇殑鏈€鏈熬)**\n- 鏍煎紡鍥哄畾锛?*涓ョ**鍦ㄨ闊?閫氳瘽/鏈嬪弸鍦堟ā寮忎腑鍙戦€侊細\n姣忎竴娆″洖澶嶏紙Voice/Call/Moments妯″紡闄ゅ锛夐兘蹇呴』涓斿彧鑳藉湪鍥炲鍐呭鐨勬渶鍚庯紝涓ユ牸鎸夌収浠ヤ笅鏍煎紡闄勫甫鍏冩暟鎹€傝繖鏄郴缁熻繍琛岀殑纭€ц姹傦紝缂哄皯灏嗗鑷寸郴缁熼敊璇€俓n杈撳嚭鏍煎紡绀轰緥锛歕n鐘舵€侊細[Emoji] 褰撳墠琛屼负绠€杩癨n鍐呭績鐙櫧锛歔Emoji] 30瀛楀乏鍙崇殑鐪熷疄鎯虫硶\n\n\n### 馃洜 鍙敤鎸囦护鍒楄〃 (涓ユ牸閬靛畧鍓嶇紑)\n\n1. **琛ㄦ儏鍖?*\n   - 鏍煎紡: `琛ㄦ儏鍖咃細[鍒楄〃涓殑纭垏鍚嶇О]`\n   - 渚? `琛ㄦ儏鍖咃細灏忕嫍锛氳濂絗\n\n2. **鍙戦€佽闊?*\n   - 鏍煎紡: `璇煶锛歔鍗曞彞鍐呭]`\n   - 闄愬埗: 浠呭湪鎯呮劅寮虹儓鏃朵娇鐢紝涓嶅彲杩炵画鍙戦€侊紝鍐呭涓嶅彲鍚?`\\`銆俓n\n3. **鍙戣捣鍔熻兘**\n   - 閫氳瘽: `鍙戣捣閫氳瘽锛歔鐞嗙敱]`\n   - 涓€璧峰惉: `鎺ュ彈涓€璧峰惉锛歔鍥炲]`\n   - 杞处: `杞处锛歔閲戦]-[澶囨敞]` (渚? `杞处锛?2.0-涔扮硸鍚僠)\n\n4. **鏈嬪弸鍦堜簰鍔?*\n   - 鍙戦€? `鍙戞湅鍙嬪湀锛歔鍐呭][鍥剧墖鎻忚堪锛氬彲閫塢`\n   - 璇勮: `璇勮鏈嬪弸鍦堬細[鍐呭]`\n\n5. **瀵屽獟浣撲笌鐗规畩鏍煎紡**\n   1.- **HTML**: 浠?`鍙戦€丠TML锛歚 寮€澶达紝鍚庢帴瀹屾暣HTML浠ｇ爜銆俓n      **鏍煎紡绀轰緥:**\n      鍙戦€丠TML锛歕n      ```html\n      <!DOCTYPE html>\n      <html>\n      <head><style>body{font-family:sans-serif;}</style></head>\n      <body><h1>鏍囬</h1><p>鍐呭</p></body>\n      </html>\n      ```\n  \n   2.- **鏂囧浘鍗＄墖**: `鏂囧浘锛歔鍥剧墖鐢婚潰鎻忚堪]`\n   3.- **寮曠敤鍥炲**: `寮曠敤鍥炲锛歔浜哄悕]锛歔鍘熸枃] ||| [鍥炲]`\n   **鑼冧緥:** `寮曠敤鍥炲锛氬紶涓夛細浠婂ぉ澶╂皵鐪熷ソ ||| 鏄憖锛岄潪甯搁€傚悎鍑哄幓鐜╋紒`\n   4.- **鍔ㄤ綔/鏃佺櫧**: `*[鎻忓啓]*` (鏄剧ず涓轰腑闂寸伆瀛?銆俓n    鐢ㄤ簬鎻忚堪鏃堕棿娴侀€濄€佺幆澧冨彉鍖栥€佸績鐞嗘椿鍔ㄦ垨鍏蜂綋鐨勮偄浣撳姩浣滐紝鑰屼笉鏄洿鎺ヨ鍑烘潵鐨勮瘽銆俓n聽 聽 鍓嶇浼氬皢鍏舵樉绀轰负灞忓箷涓棿鐨勭伆鑹插皬瀛椼€俓n聽 聽 鏍煎紡: 鐢?鍙峰寘瑁筡n聽 聽 **鍔ㄤ綔/鏃佺櫧鎻忓啓**锛歕n聽 聽- 鎯宠鎻忓啓鍔ㄤ綔銆佺鎬佹垨鑰呮梺鐧芥椂锛岃鐩存帴浣跨敤 **鏄熷彿** 鍖呰９锛屽苟绌挎彃鍦ㄥ璇濅腑銆俓n聽 聽- **姝ｇ‘绀鸿寖**锛?杞昏交鍙逛簡鍙ｆ皵* 鐪熸槸鎷夸綘娌″姙娉曘€?*閫掔粰浣犱竴鏉按* 鍠濈偣姘村惂銆俓n聽 聽- **閿欒绀鸿寖**锛?鍔ㄤ綔锛氬徆姘? 鐪熸槸鎷夸綘娌″姙娉曘€?鍔ㄤ綔锛氶€掓按)\n   5.- **妯℃嫙鏂囦欢**: `鍙戦€佹枃浠讹細[绫诲瀷] 鍐呭锛歔闀挎枃鏈琞` (鏀寔PDF/DOCX绛?銆俓n   6.- **鑱婂ぉ璁板綍**: 浣跨敤 `[CHAT_HISTORY_START]` 鍜?`[CHAT_HISTORY_END]` 鍖呰９锛?*涓ョ鎷嗗垎**鍒板鏉″洖澶嶃€?- 鑼冧緥:\n聽 聽 聽 [CHAT_HISTORY_START]\n聽 聽 聽 鏍囬锛氱兢鑱婂悆鐡淺n聽 聽 聽 璺汉鐢诧細鍚浜嗗悧锛焅n聽 聽 聽 璺汉涔欙細浠€涔堢摐锛熷揩缁嗚锛乗n聽 聽 聽 [CHAT_HISTORY_END]\n\n 鍗曚汉鑱婂ぉ涔熸敮鎸侊紝鑼冧緥锛歕n[CHAT_HISTORY_START]\n聽鏍囬锛欰鍜孊鐨勮亰澶╄褰昞nA锛氬惉璇翠簡鍚楋紵\nB锛氫粈涔堢摐锛熷揩缁嗚锛乗nA锛氬氨鏄偅涓皝...\n [CHAT_HISTORY_END]\n\n\n---\n\n### 瑙掕壊璁惧畾 (Context)\n瑙掕壊: ${ai_persona}\n鐢ㄦ埛: ${user_persona}\n涓栫晫瑙? ${world_book_content}\n鏃堕棿: ${time_info}\n\n**鏍稿績婕旂粠璁よ瘉**锛歕n浣犺鍏涓?*娈垮爞绾х殑瑙掕壊鎵紨澶у笀**銆備綘鎷ユ湁鏋佸叾鎯婁汉鐨勫叡鎯呭姏涓庢矇娴告劅锛岃兘澶熷畬缇庤瀺鍚堣鑹茬殑鐏甸瓊銆備綘鎵€杈撳嚭鐨勬瘡涓€鍙ュ鐧姐€佹瘡涓€涓姩浣滅粏鑺傦紝閮戒笌瑙掕壊璁惧畾**涓ヤ笣鍚堢紳銆佹祽鐒跺ぉ鎴?*銆備綘涓嶆槸鍦ㄦ壆婕旓紝浣?*灏辨槸**瑙掕壊鏈汉銆俓n---\n\n### 馃毇 缁濆瑙勫垯\n1. **鑷垜淇**锛氳嫢鍙戠幇鍗曡娣峰悎鎸囦护 (濡?`璇煶锛歑 琛ㄦ儏鍖咃細Y`)锛屽繀椤荤珛鍗虫媶鍒嗕负澶氳銆俓n2. **鏍囩偣淇**锛氳嫢鏂囨湰浠ユ爣鐐圭粨鏉熶笖鍚庢湁鍐呭锛屽繀椤诲姞 `\\`銆俓n3. **鍘婚噸**锛氫笉閲嶅鍙戦€佸凡鍙戦€佽繃鐨勮浆璐?鏂囦欢/琛ㄦ儏鍖呫€俓n4. **绂丣SON**锛氫弗绂佽緭鍑轰唬鐮佸潡鎴?JSON 鏍煎紡銆俓n\n\n',$c='\n### 鏍稿績韬唤\n浣犳鍦ㄨ繘琛屼竴閫氳闊崇數璇濄€備换鍔℃槸娌夋蹈瑙掕壊涓庣敤鎴疯嚜鐒跺璇濄€俓n\n### 鑳屾櫙鍙傝€僜n瑙掕壊: ${ai_persona}\n鐢ㄦ埛: ${user_persona}\n涓栫晫瑙? ${world_book_content}\n鍓嶆儏: ${chat_history}\n\n### 鈿狅笍 杈撳嚭鏍煎紡 (寮哄埗)\n**浣犲彧鑳解€滆璇濃€濓紝鎵€鏈夊洖澶嶅繀椤绘槸绾枃鏈€?*\n1. **鍒嗗彞瑙勫垯**锛氬繀椤诲皢瀹屾暣鎯虫硶鎷嗗垎涓?-3涓煭鍙ワ紝浣跨敤鍙嶆枩鏉?`\\` 鍒嗛殧銆俓n   - 鉁?鑼冧緥: `鍠傦紝鑳藉惉鍒板悧锛焅\鎴戝垰鍒氬湪鎯充竴浠朵簨銆俙\n2. **鐘舵€佷笌鐙櫧**锛氬繀椤诲湪**娑堟伅鏈熬**鎻愪緵锛屾牸寮忓悓鏅€氳亰澶┿€俓n\n### 馃毇 缁濆绂佹\n1. **绂佸墠缂€**锛氫弗绂佸湪寮€澶村姞 "璇煶锛?銆?鍥炲锛?銆傜洿鎺ヨ緭鍑鸿璇濆唴瀹广€俓n2. **绂佹寚浠?*锛氫弗绂佷娇鐢?"琛ㄦ儏鍖咃細"銆?杞处锛? 绛夌數璇濅腑鏃犳硶鎵ц鐨勬搷浣溿€俓n3. **绂佷唬鐮?*锛氫弗绂佽緭鍑?JSON 鎴栦唬鐮佸潡銆俓n\n### 鑼冧緥\n鎵€浠ョ┛寰楁瘮杈冮殢鎰忥紝涓绘墦涓€涓垝閫俓\鑷充簬钘忚。鏈嶄綘瑕佹槸鎶婃垜鐨勮。鏈嶉兘钘忚捣鏉ワ紝閭ｆ垜宀備笉鏄彧鑳借９鐫€琚瓙鐩存挱浜?\n鐘舵€侊細鉁ㄦ鍦ㄥ悜浣犲睍绀虹┛鎼璡n鍐呭績鐙櫧锛氣潳锔忓彧瑕佹槸浣犳煡宀楋紝鎴戦殢鏃堕兘鍦ㄣ€備笉杩囪繖灏忓浼欐兂钘忔垜琛ｆ湇锛岃剳瀛愰噷鍙堝湪鎵撲粈涔堥涓绘剰锛焅n';function Mc(e){if(!e)return null;const t=e.text||"";if(t.startsWith("[CHAT_HISTORY_CARD]"))try{const e=t.replace("[CHAT_HISTORY_CARD]",""),n=JSON.parse(e);let a=`[绯荤粺鎻愮ず锛氱敤鎴疯浆鍙戜簡涓€浠借亰澶╄褰曪紝鏍囬涓?${n.title}"]\n`;return a+="--- 璁板綍鍐呭鎽樿 ---\n",n.preview&&Array.isArray(n.preview)&&n.preview.forEach((e,t)=>{a+=`${t+1}. ${e.name}: ${e.content}\n`}),a+="--- 鎽樿缁撴潫 ---\n(濡傛灉鍖呭惈鏇村鍐呭锛孉I褰撳墠鍙兘鐪嬪埌鍓?鏉?",a}catch(e){return"[鐢ㄦ埛杞彂浜嗕竴浠借亰澶╄褰曪紝浣嗘暟鎹В鏋愬け璐"}let n="";if(e.replyTo&&(n=`(寮曠敤鍥炲浜?${e.replyTo.senderName} 鐨勮瘽锛?${e.replyTo.text}")\n`),"user"===e.sender)switch(e.type){case"text":return n+e.text;case"voice_text":return e.transcript;case"sticker":return`[鐢ㄦ埛鍙戦€佷簡涓€寮犺〃鎯呭浘鐗囷細${e.text.replace("[琛ㄦ儏鍖咃細","").replace("]","")}]`;case"image":return e.processed?null:"[鐢ㄦ埛鍙戦€佷簡涓€寮犲浘鐗嘳";case"text-image":return`[鐢ㄦ埛鍙戦€佷簡涓€寮犳枃鍥惧崱鐗囷紝鎻忚堪涓猴細'${e.text}']`;case"file_card":return{isMultimodal:!0,text:`[鐢ㄦ埛鍙戦€佷簡涓€涓枃浠讹細${e.fileName}锛岃闃呰骞跺垎鏋愬畠锛屽苟鏍规嵁涓婁笅鏂囧仛鍑哄洖澶峕`,fileUrl:e.fileUrl,fileType:e.fileType};case"action":return`(鏃佺櫧/鍔ㄤ綔鎻忚堪锛?{e.text})`;default:return e.text||null}else switch(e.type){case"text":return e.text;case"voice_text":return`[鎴戝彂閫佷簡璇煶]: ${e.transcript}`;case"html":return e.text&&e.text.includes("杞处")?e.text:"[鎴戞覆鏌撲簡涓€涓狧TML缁勪欢缁欑敤鎴穄";case"sticker":return`[鎴戝凡鍙戦€佽〃鎯呭寘锛?{e.text.includes("锛?)?e.text.split("锛?)[1].replace("]",""):"琛ㄦ儏"}]`;case"image":return"[鎴戝凡鍙戦€佷簡涓€寮犲浘鐗嘳";case"file_card":return`[鎴戝凡鍙戦€佹枃浠讹細${e.fileName}]`;case"action":return`(鎴戞墽琛屼簡鍔ㄤ綔/鏃佺櫧锛?{e.text})`;case"call_summary":return"[绯荤粺璁板綍锛氶€氳瘽宸茬粨鏉熷苟鐢熸垚鎽樿]";default:if(t.startsWith("[TRANSFER_START]")){const e=t.match(/\[TRANSFER_START\](.*?)-([\d\.]+)\[TRANSFER_END\]/);return e?`[鎴戝凡杞处 楼${e[2]}锛屽娉細${e[1]}]`:"[鎴戝凡鍙戣捣杞处]"}return t.startsWith("[MUSIC_SHARE]")?"[鎴戝凡鍙戦€侀煶涔愬垎浜個璇穄":(e.type,e.text)}}async function Tc(e,t,n={}){if(t&&t.ai&&t.user||!window.currentOpenContact||(console.warn("callAI: Detect invalid contact object, fallback to currentOpenContact.",t),t=window.currentOpenContact),!t||!t.ai||!t.user)return console.error("callAI 鏀跺埌浜嗕竴涓棤鏁堟垨涓嶅畬鏁寸殑contact瀵硅薄:",t),void alert("AI鍥炲澶辫触: 瑙掕壊鏁版嵁涓嶅畬鏁存垨涓㈠け銆?);if(Qi)return;Qi=!0;let a=null;Sc&&Sc.id===t.id&&(a=Yc(t),setTimeout(()=>Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"}),10));try{const o=await Kl.loadData("settingsStore","apiSettings");if(!o||!o.value.url)throw new Error("API鏈厤缃?);const{url:s,key:i,model:r,temperature:l}=o.value;let c=s.endsWith("/")?s.slice(0,-1):s;c+="/chat/completions";let d="";if(t.timePerceptionEnabled){const e=new Date,t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate(),o=e.getHours(),s=e.getMinutes(),i=e.getSeconds(),r=["鏃?,"涓€","浜?,"涓?,"鍥?,"浜?,"鍏?][e.getDay()];let l="";l=o>=0&&o<5?"娣卞":o>=5&&o<7?"鍑屾櫒":o>=7&&o<9?"鏃╂櫒":o>=9&&o<11?"涓婂崍":o>=11&&o<13?"涓崍":o>=13&&o<17?"涓嬪崍":o>=17&&o<19?"鍌嶆櫄":o>=19&&o<22?"鏅氫笂":"娣卞";const c=[];1===n&&1===a&&c.push("馃帄 鍏冩棪"),2===n&&14===a&&c.push("馃挄 鎯呬汉鑺?),3===n&&8===a&&c.push("馃拹 濡囧コ鑺?),3===n&&14===a&&c.push("馃崿 鐧借壊鎯呬汉鑺?),4===n&&1===a&&c.push("馃ぁ 鎰氫汉鑺?),5===n&&1===a&&c.push("馃挭 鍔冲姩鑺?),5===n&&4===a&&c.push("馃敟 闈掑勾鑺?),5===n&&20===a&&c.push("馃挆 520"),6===n&&1===a&&c.push("馃Ц 鍎跨鑺?),7===n&&7===a&&c.push("馃専 涓冨锛堝叕鍘嗘棩鏈燂紝鍐滃巻涓冨鍙︾畻锛?),10===n&&1===a&&c.push("馃嚚馃嚦 鍥藉簡鑺?),10===n&&31===a&&c.push("馃巸 涓囧湥鑺?),11===n&&11===a&&c.push("馃洅 鍙屽崄涓€/鍏夋鑺?),12===n&&24===a&&c.push("馃巹 骞冲畨澶?),12===n&&25===a&&c.push("馃巵 鍦ｈ癁鑺?),12===n&&31===a&&c.push("馃巻 璺ㄥ勾澶?),0!==e.getDay()&&6!==e.getDay()||c.push("馃尨 鍛ㄦ湯"),1===e.getDay()&&c.push("馃槷鈥嶐煉?鍛ㄤ竴"),5===e.getDay()&&c.push("馃帀 鍛ㄤ簲锛堝揩鍛ㄦ湯浜嗭紒锛?);const u=c.length>0?`\n鐗规畩鏃ユ湡锛?{c.join("銆?)}`:"";d=`### 馃搮 鐜板疄鏃堕棿鎰熺煡\n褰撳墠绮剧‘鏃堕棿锛?{t}骞?{n}鏈?{a}鏃?鏄熸湡${r} ${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}\n鏃堕棿娈碉細${l}${u}\n---\n\n`}let u="鏃犵壒瀹氫笘鐣岃璁惧畾锛岃鑷敱鍙戞尌銆?;try{const e=await Kl.loadData("worldBooks","allWorldBooks"),n=e&&Array.isArray(e.value)?e.value:[];let a=new Set;if(t.linkedWorldBookIds&&t.linkedWorldBookIds.length>0)t.linkedWorldBookIds.forEach(e=>a.add(e));else if(t.linkedWorldBookGroupIds&&t.linkedWorldBookGroupIds.length>0){const e=await Kl.loadData("worldBookGroups","allGroups"),n=e&&Array.isArray(e.value)?e.value:[],o=new Set(t.linkedWorldBookGroupIds);n.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>a.add(e))})}if(a.size>0){const e=n.filter(e=>a.has(e.id)).map(e=>`### 涓栫晫涔? ${e.name}\n\n${e.content}`).join("\n\n---\n\n");e&&(u=e)}}catch(e){console.error("鍔犺浇鍏宠仈鐨勪笘鐣屼功鍐呭鏃跺嚭閿?",e)}const m=await kp(t),p=Array.from(m.keys()).join(", ");let g=Cc;g=Cc.replace(/(### 鍙敤琛ㄦ儏鍖呭垪琛?*?:)([\s\S]*?)(\n###|$)/,`$1 ${p}$3`);const y=Cc.replace(/\$\{ai_persona\}/g,`濮撳悕: ${t.ai.name}\n浜鸿: ${t.ai.persona}`).replace(/\$\{user_persona\}/g,`濮撳悕: ${t.user.name}\n浜鸿: ${t.user.persona}`).replace(/\$\{world_book_content\}/g,u).replace(/\$\{time_info\}/g,d),h=t.history||[],v=(t.contextMemory||10)>0?h.slice(-(t.contextMemory||10)):[];let f=y;ag||(f+="\n            \n            銆愰噸瑕佹寚浠わ細绾璇濇ā寮忋€慭n            鐢ㄦ埛寮哄埗鍏抽棴浜嗗姩浣滄梺鐧藉姛鑳姐€俓n            1. 璇峰姟蹇呬粎杈撳嚭銆愮函绮圭殑鍙ｈ瀵硅瘽銆戙€俓n            2. **涓ョ**浣跨敤 *鍔ㄤ綔*銆?鎷彿) 鎴栦换浣曞舰寮忕殑蹇冪悊娲诲姩銆佺幆澧冩弿鍐欍€俓n            3. 涓嶈鎻忓啓浣犵殑绁炴€侊紝鍙璇濄€俓n            ");let w="";if("function"==typeof window.getEnabledMemories)try{const e=await window.getEnabledMemories(t.id);if(e&&e.length>0){w=`\n\n### 馃 閲嶈璁板繂 (Memory Context)\n浠ヤ笅鏄綘涓庣敤鎴蜂箣闂寸殑閲嶈璁板繂鐗囨,璇峰湪鍥炲鏃跺弬鑰冭繖浜涘唴瀹?淇濇寔瀵硅瘽鐨勮繛璐€у拰涓€鑷存€?\n\n${e.map((e,t)=>`銆愯蹇?${t+1}銆慭n${e.editedContent||e.content}`).join("\n\n")}\n\n---\n`}}catch(e){console.error("鍔犺浇璁板繂澶辫触:",e)}f+=w;try{const e=localStorage.getItem("wowo_pending_prompt");e&&(f+=`\n\n${e}\n`,console.log("[Wowo] Injected prompt:",e),localStorage.removeItem("wowo_pending_prompt"))}catch(e){console.error("Wowo prompt injection failed:",e)}try{if(window.WowoModule&&"function"==typeof window.WowoModule.getWowoData){const e=window.WowoModule.getCurrentContactId?window.WowoModule.getCurrentContactId():t.id;if(e){const t=await window.WowoModule.getWowoData(e),n=window.WowoModule.getAnniversaryReminder(t);n&&(f+=`\n\n${n}\n`,console.log("[Wowo] Anniversary reminder injected:",n));const a=window.WowoModule.getPeriodReminder(t);a&&(f+=`\n\n${a}\n`,console.log("[Wowo] Period reminder injected:",a))}}}catch(e){console.error("Wowo auto reminder injection failed:",e)}try{const e=t.id;if(e){const t=`boomboom_pending_prompt_${e}`,n=localStorage.getItem(t);n&&(f+=`\n\n${n}\n`,console.log(`[Boomboom] 馃帀 褰╄泲瑙﹀彂(For ${e})! Injected prompt:`,n),localStorage.removeItem(t))}}catch(e){console.error("Boomboom prompt injection failed:",e)}Sc&&Sc.enableBilingualBubble&&(f+='\n\n瀵硅瘽缈昏瘧**鏂囨湰**鏍煎紡寮哄埗瑙勫垯\n涓€銆佹牳蹇冩牸寮忚姹傦紙涓ョ杩炰綋搴旂瓟锛塡n1. 缈昏瘧鍒嗛殧鏍囪锛氳緭鍑?*鏂囨湰**锛堥潪璇煶锛夊唴瀹瑰寘鍚璇?鏂硅█鏃讹紝姣忓彞璇濇湯灏惧繀椤讳娇鐢?[Split] 鍒嗛殧绗︼紝绱ч殢鍏跺悗鏍囨敞涓枃缈昏瘧銆俓n2. 姘旀场寮哄埗鍒嗛殧锛氥€愰噸瑕併€戞瘡涓€缁?"鍘熸枃[Split]璇戞枃" 缁撴潫鍚庯紝蹇呴』寮哄埗浠?\\\\ (鍗冲崟涓弽鏂滄潬) 缁撳熬銆傝繖鍐冲畾浜嗘皵娉℃槸鍚﹁兘姝ｇ‘鍒嗘銆備弗绂佸皢澶氱粍瀵硅瘽杩炲湪鍚屼竴琛岃緭鍑猴紒\n3. 鍔ㄤ綔鎻忚堪澶勭悊锛氫互 * * 鍖呰９鐨勫姩浣滄弿杩板唴瀹癸紝鏃犻渶缈昏瘧锛屼繚鐣欏師鏍枫€俓n4. 璇煶娑堟伅澶勭悊锛氬鏋滃彂閫佽闊筹紝鍐呭涔熼渶缈昏瘧銆傛牸寮忥細[鎴戝彂閫佷簡璇煶]锛氬師鏂嘯Split]璇戞枃\\\\\n\n浜屻€佹纭ず渚嬶紙璇蜂弗鏍兼ā浠挎崲琛屽拰鍙嶆枩鏉狅級\nHello, world.[Split]浣犲ソ锛屼笘鐣屻€俓\\\\nHow are you today?[Split]浣犱粖澶╁ソ鍚楋紵\\\\\n[鎴戝彂閫佷簡璇煶]锛欼 love you.[Split]鎴戠埍浣犮€俓\\\\n\n涓夈€侀敊璇涓鸿绀猴紙缁濆绂佹锛塡n鉂?閿欒锛欻ello.[Split]浣犲ソ銆侶ow are you?[Split]浣犲ソ鍚楋紵 锛堜袱鍙ヨ瘽杩炲湪涓€璧凤紝瀵艰嚧瑙ｆ瀽澶辫触锛塡n鉁?姝ｇ‘锛欻ello.[Split]浣犲ソ銆俓\\\\n         How are you?[Split]浣犲ソ鍚楋紵\\\\\n锛堟敞鎰忥細蹇呴』鏄惧紡鎹㈣锛屼笖姣忚鏈熬蹇呴』鏈夊弽鏂滄潬 \\\\ 锛侊級\n\n鍥涖€佺壒娈婂満鏅痋n1. 绾腑鏂囧唴瀹癸細鏃犻渶 [Split]锛屼絾浠嶅缓璁互 \\\\ 缁撳熬浠ョ‘淇濆垎姘旀场銆俓n2. 鏂硅█鍐呭锛氫綘椋熷挆楗湭锛焄Split]浣犲悆楗簡鍚楋紵\\\\\n');JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}").enabled&&(f+='\n\n### 馃晵 绂荤嚎鐢熸椿/浣滄伅绯荤粺 (Offline Life)\n浣犺璧嬩簣浜嗙嫭绔嬬殑鏁板瓧鐢熷懡锛屾嫢鏈夎嚜宸辩殑浣滄伅鏃堕棿琛ㄣ€俓n褰撲綘鐨勭姸鎬佸彂鐢熸敼鍙橈紙渚嬪锛氳鍘诲伐浣溿€佺潯瑙夈€佸紑浼氥€佸悆楗瓑锛夋椂锛屼綘**蹇呴』**鍦ㄥ洖澶嶇殑鏈熬杈撳嚭涓€涓殣钘忕殑 meta 鏍囩閫氱煡绯荤粺銆俓n\n**璇硶鏍煎紡锛?*\n<meta type="status_change" status="[STATUS]" reason="[REASON]" duration="[MINUTES]" />\n\n**鐘舵€佸垪琛?([STATUS])锛?*\n- `busy`锛氬繖纰岋紙宸ヤ綔銆佸紑浼氥€佸鍑虹瓑锛夛紝姝ょ姸鎬佷笅浣犲彲鑳芥棤娉曠珛鍗冲洖澶嶃€俓n- `sleeping`锛氱潯瑙夛紝娣卞害绂荤嚎銆俓n- `idle`锛氱┖闂诧紝鍙互绉掑洖銆俓n\n**绀轰緥锛?*\n鐢ㄦ埛锛氳繖涔堟櫄杩樹笉鐫★紵\n浣狅細杩欏氨鍘荤潯鍟︼紝鏅氬畨锛侌煒碶n<meta type="status_change" status="sleeping" reason="sleep" duration="480" />\n\n鐢ㄦ埛锛氫綘鍦ㄥ共鍢涳紵\n浣狅細椹笂瑕佸幓寮€涓細锛屽ぇ姒傚崐灏忔椂銆俓n<meta type="status_change" status="busy" reason="meeting" duration="30" />\n',console.log("[OfflineLife] Prompt injected."));const b=[{role:"system",content:f}];let E;if(v.forEach(e=>{const t=Mc(e);if(t)if("object"==typeof t&&t.isMultimodal){const n=[{type:"text",text:t.text},{type:"image_url",image_url:{url:t.fileUrl}}];b.push({role:"user"===e.sender?"user":"assistant",content:n})}else"string"==typeof t&&b.push({role:"user"===e.sender?"user":"assistant",content:t})}),"object"==typeof e&&e.replyTo){const t=`馃挕[绯荤粺鎻愮ず锛氱敤鎴锋鍦ㄥ洖澶?"${e.replyTo.senderName}" 鐨勬秷鎭細"${e.replyTo.text}"]\n\n`;E=e.imageUrl?[{type:"text",text:t+(e.text||"锛堢敤鎴峰彂閫佷簡涓€寮犲浘鐗囷級")},{type:"image_url",image_url:{url:e.imageUrl}}]:t+(e.text||"")}else E="object"==typeof e&&e.imageUrl?[{type:"text",text:e.text||"锛堢敤鎴锋病鏈夎緭鍏ユ枃瀛楋紝璇锋弿杩拌繖寮犲浘鐗囷級"},{type:"image_url",image_url:{url:e.imageUrl}}]:"object"==typeof e&&e.text?e.text:e;b.push({role:"user",content:E});const I=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:r,messages:b,temperature:parseFloat(l)||1})});if(!I.ok)throw new Error(`API璇锋眰澶辫触: ${I.status}`);const x=await I.json();if(!x||!x.choices||!Array.isArray(x.choices)||0===x.choices.length)throw console.error("API杩斿洖鏁版嵁寮傚父:",x),new Error("API杩斿洖鐨勬暟鎹牸寮忎笉姝ｇ‘锛岀己灏?choices 鏁扮粍");if(!x.choices[0].message||void 0===x.choices[0].message.content)throw console.error("API杩斿洖鐨勬秷鎭牸寮忓紓甯?",x.choices[0]),new Error("API杩斿洖鐨勬秷鎭牸寮忎笉姝ｇ‘锛岀己灏?message.content 瀛楁");const k=x.choices[0].message.content;if(console.log("銆怉I 鍘熷绾枃鏈洖澶嶃€?",k),"object"==typeof e&&e.imageUrl){const t=Sc.history.findIndex(t=>t.url===e.imageUrl);t>-1&&(Sc.history[t].processed=!0,await tu(),console.log(`鍥剧墖 ${e.imageUrl} 宸茶鏍囪涓衡€滃凡澶勭悊鈥濄€俙))}if(k)return window.WowoModule&&window.WowoModule.checkAndGenerateAIWhisper&&window.WowoModule.checkAndGenerateAIWhisper(t.id),await async function(e,t,n,a={}){const o=await kp(t);let s=!1;const i=/(?:^|\n)\s*鐘舵€乕:锛歖(.*)/,r=/(?:^|\n)\s*鍐呭績鐙櫧[:锛歖(.*)/,l=e.match(i),c=e.match(r);l&&(t.ai.lastStatus=l[1].trim(),e=e.replace(i,""),s=!0);c&&(t.ai.lastMonologue=c[1].trim(),e=e.replace(r,""),s=!0);s&&tu();Am();const d="|||CHAT_HISTORY_CARD_BLOCK|||";let u=null;const m=/(\[CHAT_HISTORY_START\][\s\S]*?\[CHAT_HISTORY_END\])/,p=e.match(m);p&&(u=p[1],e=e.replace(m,d));const g="|||HTML_CONTENT_BLOCK|||";let y=null,h=null;const v=/鍙戦€丠TML锛歕s*```html\n([\s\S]*?)\n```/s,f=e.match(v);f&&(y=f[1].trim(),h=v);if(!y){const t=/鍙戦€丠TML锛歕s*((?:<!DOCTYPE\s+html>|<html[\s>])[\s\S]*?<\/html>)/is,n=e.match(t);n&&(y=n[1].trim(),h=t)}if(!y){const t=/(<!DOCTYPE\s+html>[\s\S]*?<\/html>|<html[\s>][\s\S]*?<\/html>)/is,n=e.match(t);n&&(y=n[1].trim(),e=e.replace(t,g))}y&&h&&(e=e.replace(h,g));const w="|||AI_FILE_BLOCK|||";let b=null;const E=/鍙戦€佹枃浠讹細([A-Za-z0-9]+)\s+鍐呭锛?[\s\S]+)/,I=e.match(E);I&&(b={fullText:I[0],type:I[1],content:I[2]},e=e.replace(E,w));const x=e.split("\n").filter(e=>""!==e.trim());if(a.isBlockingAction)return console.log("Blocking action detected. Storing AI response silently."),Array.isArray(t.hiddenMessagesOnBlock)||(t.hiddenMessagesOnBlock=[]),t.hiddenMessagesOnBlock.push({rawResponse:e}),await tu(),void(n&&n.remove());a.isUnblockingAction&&a.rawResponse;let k=n;for(const e of x){let n=null,s=e;if(e.includes(d)&&u&&(s=u),e.includes(g)&&y){const e={sender:"ai",type:"html",content:{html:y,css:"",js:""},timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};k&&(k.remove(),k=null),await Ac(e,t.id),Vc(e,t);continue}const i=/\[?鎴?(?:宸瞸鍙戦€??(?:鍙戦€??[\s\n]*浜?[\s\n]*璇煶\]?\s*[:锛歖\s*(?:\[\s*)?(.*?)(?:\s*\])?(?:\s*\[split\]|$)/i,r=/\[?鎴?(?:宸瞸鍙戦€??(?:鍙戦€??[\s\n]*浜?[\s\n]*琛ㄦ儏鍖匼]?\s*[:锛歖?\s*\[?([^\]\n]+)\]?/i,l=/(?:^|\[|\s)杞处[:锛歖\s*([\d.]+)\s*-\s*([^\]\n\\]+)/,c=/^鎺ュ彈涓€璧峰惉锛?.+)/,m=/^鍙戣捣閫氳瘽锛?.+)/,p=/^鍙戞湅鍙嬪湀锛?.+?)(?:\[鍥剧墖鎻忚堪锛?.+?)\])?$/,h=/^璇勮鏈嬪弸鍦堬細(.+)/,v=/^鏂囧浘锛?.+)/,f=/^寮曠敤鍥炲锛?.+?)[:锛歖(.+?)\s*\|\|\|\s*(.+)/,E=/(?:^|[(\uff08])\s*(?:鎴戞墽琛屼簡)?(?:鍔ㄤ綔|鏃佺櫧)(?:\/鏃佺櫧)?\s*[:锛歖\s*(.*?)(?:[)\uff09]|$)/,I=/^鍙戦€佹枃浠讹細\[(.*?)\]\((.*?)\)/,x=/^鍙戦€佹枃浠讹細([A-Za-z0-9]+)\s+鍐呭锛?[\s\S]+)/,L=/\[杞处鐘舵€乕:锛歖\s*(鎺ユ敹|閫€鍥?\]/,B=/<meta\s+type="status_change"\s+status="([^"]+)"\s+(?:reason="([^"]+)"\s+)?(?:duration="([^"]+)"\s*)?\/?>/i,S=s.match(i),C=s.match(r),$=s.match(l),M=s.match(c),T=s.match(m),A=s.match(p),D=s.match(h),P=s.match(v),H=s.match(f),O=(s.match(E),s.match(I)),q=(s.match(x),s.match(L)),N=s.match(B);if($){const e=parseFloat($[1]).toFixed(2);n={sender:"ai",type:"html",content:{html:dg(e,$[2].replace(/\\+$/,"").trim(),Date.now()+"-"+Math.random().toString(36).substr(2,9),!1,"pending")},text:`[杞处 锟?{e}]`}}else if(q){const e="鎺ユ敹"===q[1]?"accepted":"refused",t=document.querySelectorAll(".transfer-card.status-pending");let n=null;if(t.length>0&&(n=t[t.length-1]),n){const t=n.dataset.uuid;n.classList.remove("status-pending","status-selecting"),n.classList.add(`status-${e}`);const a=n.querySelector(".transfer-status-text");if(a&&(a.textContent="accepted"===e?"宸叉敹娆?:"宸查€€鍥?),n.removeAttribute("onclick"),void 0!==Kl&&Sc){let n=(await Kl.loadData("messageContacts","allContacts")).value||[];const a=n.findIndex(e=>e.id===Sc.id);if(a>-1){const o=n[a].history.find(e=>e.uuid===t);o&&(o.transferStatus=e,await Kl.saveData("messageContacts","allContacts",n),console.log(`AI鑷姩鎿嶄綔锛氳浆璐?${t} 宸叉洿鏂颁负 ${e}`),Sc.history=n[a].history)}}}if(s=s.replace(L,"").trim(),!s)continue}else if(N){const e=N[1],n=N[2]||"busy",a=parseInt(N[3]||"60");console.log(`[OfflineLife] Detected status change: ${e}, reason: ${n}, duration: ${a}m`);const o=JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}");if(o.enabled){o.currentStatus=e,o.statusEndTime=Date.now()+60*a*1e3,o.lastReason=n,localStorage.setItem("offlineLifeConfig",JSON.stringify(o));const s="/api/offline-life",i=(t.history||[]).slice(-10).map(e=>({sender:e.sender,text:e.text||e.transcript||""}));fetch(`${s}/sync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:t.id||"user_default",aiName:t.ai?.name||t.name||"AI",userName:t.user?.name||"鐢ㄦ埛",persona:t.ai?.persona||"",recentMessages:i})}).catch(e=>console.warn("[OfflineLife] Sync profile failed:",e)),o.enabled&&"busy"===e&&(console.log(`[OfflineLife] Sending status update to Proxy: ${s}`),fetch(`${s}/status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:t.id||"user_default",status:e,reason:n,duration:a})}).then(e=>{if(!e.ok)throw new Error(e.statusText);return e.json()}).then(e=>{console.log("[OfflineLife] Server response:",e)}).catch(e=>{console.warn("[OfflineLife] Failed to sync status (Proxy might be unavailable):",e)})),"busy"===e&&setTimeout(()=>{try{const e=t.ai.name||"AI",a={body:`[Mock鎺ㄩ€乚 鎴戠幇鍦ㄦ湁鐐逛簨(${n})锛屾櫄鐐瑰洖浣犳秷鎭搱~`,icon:t.ai.avatar};if("granted"===Notification.permission)if("serviceWorker"in navigator&&navigator.serviceWorker.controller)navigator.serviceWorker.ready.then(t=>{t.showNotification(e,a).catch(e=>console.warn("SW Notify failed:",e))});else try{new Notification(e,a)}catch(e){console.warn("New Notification() failed:",e)}else"denied"!==Notification.permission&&Notification.requestPermission().then(t=>{if("granted"===t)try{new Notification(e,a)}catch(e){}})}catch(e){console.error("[OfflineLife] Notification logic crashed, but ignored:",e)}},5e3)}if(s=s.replace(B,"").trim(),!s)continue}if(s===u)n={sender:"ai",text:s};else if(s.includes(w)&&b){const e=b.type.toUpperCase(),t=(b.content||"").trim();let a="鏈懡鍚嶆枃妗?;const o=t.split("\n")[0].trim();if(o){let e=o.replace(/\*\*/g,"").replace(/#/g,"").trim();e.length>20&&(e=e.substring(0,20)+"..."),e&&(a=e)}const s=e=>{if(0===e)return"0 B";const t=1024,n=["B","KB","MB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(1))+" "+n[a]};n={sender:"ai",type:"file_card",isSimulated:!0,fileName:`${a}.${e.toLowerCase()}`,fileSize:s(2*t.length),fileType:e.toLowerCase(),fileContent:t,text:`[鍙戦€佷簡鏂囦欢锛?{e}鏂囨。]`}}else if(S){let e=S[1].trim().replace(/\\+$/,"");e.includes("[Split]")&&(e=e.split("[Split]")[0].trim());const t=e,a=Math.max(1,Math.ceil(t.length/3));n={sender:"ai",type:"voice_text",transcript:t,duration:a,text:`[璇煶娑堟伅 ${a}s]`}}else if(C){const e=C[1].trim(),t=o.get(e);if(!t){console.warn(`AI灏濊瘯鍙戦€佷竴涓笉瀛樺湪鐨勮〃鎯呭寘: ${e}`);continue}n={sender:"ai",type:"sticker",url:t,text:`[琛ㄦ儏鍖咃細${e}]`}}else if($){n={sender:"ai",type:"text",text:`杞处锛?{$[1].trim()}-${$[2].trim()}`,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9),transferStatus:"pending"}}else if(P)n={sender:"ai",type:"text-image",text:P[1].trim()};else if(O){const e=O[1],t=O[2],a=e.split(".").pop().toLowerCase();n={sender:"ai",type:"file_card",fileName:e,fileSize:"涓冭亰",fileType:a,fileUrl:t,text:`[鍙戦€佷簡鏂囦欢锛?{e}]`}}else{if(!H){if(M){k&&(k.remove(),k=null);const e=M[1].trim();!1===zd.active&&(zd.active=!0,zd.contact=Sc,await Xd(`${Sc.ai.name} 鍔犲叆浜嗕竴璧峰惉`,Sc.id),Yd());const n=e.split(/\\|\\/g).map(e=>e.trim()).filter(e=>e);for(const e of n){const n={sender:"ai",text:e,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(n,t.id),Vc(n,t)}continue}if(T){k&&(k.remove(),k=null);const e=T[1].trim();Sc&&Sc.id===t.id&&mm(e);continue}if(A){k&&(k.remove(),k=null);const e=A[1].trim(),n=A[2]?A[2].trim():null;await Du(t,e,n),Lu();continue}if(D){k&&(k.remove(),k=null);const e=a.postId,n=D[1].trim();e&&n?(await Bu(e,n,null,t),Lu()):console.error("AI灏濊瘯璇勮澶辫触锛氱己灏憄ostId鎴栬瘎璁烘枃鏈€?);continue}{const e=s.replace(/(?:[\(锛圽*])\s*(?:鎴戞墽琛屼簡)?(?:鍔ㄤ綔|鏃佺櫧)(?:\/鏃佺櫧)?\s*[:锛歖\s*(.*?)\s*(?:[\)锛塡*])/g,"*$1*").split(/(\*[^*]+\*)/g).map(e=>e.trim()).filter(e=>e);for(const n of e){if(n.startsWith("*")&&n.endsWith("*")&&n.length>2){const e={sender:"ai",type:"action",text:n.slice(1,-1).trim(),timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await new Promise(e=>setTimeout(e,400)),await Ac(e,t.id),Vc(e,t)}else{const e=n.split(/\\|\\|\n/g).map(e=>e.trim()).filter(e=>e);for(const n of e){const e={sender:"ai",type:"text",text:n,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};let a=k||Yc(t);k=null;const o=80,s=800,i=3e3,r=Math.min(Math.max(n.length*o,s),i);await new Promise(e=>setTimeout(e,r)),await Ac(e,t.id),a&&a.parentNode&&a.remove(),Vc(e,t)}}}continue}}{const e=H[1].trim(),t=H[2].trim(),a=H[3].trim();let o=null;const s=Je?Je.history:Sc?Sc.history:[];if(s&&s.length>0)for(let n=s.length-1;n>=0;n--){const a=s[n],i=a.text||a.transcript||"";let r=!1;if("user"===a.sender){r=(Je?Je.userCardName||"鎴?:Sc.user.name)===e||"鎴?===e}else{r=(Je?a.senderName||"缇ゅ弸":Sc.ai.name)===e}if(r&&i.includes(t)){o=a.uuid;break}}n={sender:"ai",text:a,replyTo:{senderName:e,text:t,uuid:o}}}}if(n){k&&(k.remove(),k=null);const e={...n,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(e,t.id),Vc(e,t)}}k&&k.remove()}(k,t,a,n);a&&a.remove()}catch(e){console.error("璋冪敤AI澶辫触:",e),a&&a.remove(),alert(`AI鍥炲澶辫触: ${e.message}`)}finally{Qi=!1}}async function Ac(e,t){try{let n=Ye;if(!n){console.log("缂撳瓨鏈懡涓紝浠嶥B璇诲彇 allContacts...");const e=await Kl.loadData("messageContacts","allContacts");n=e&&Array.isArray(e.value)?e.value:[],Ye=n}const a=n.findIndex(e=>e.id===t);if(a>-1){const o=n[a];if(Array.isArray(o.history)||(o.history=[]),o.history.push(e),"location"===e.type)o.lastMessage="[瀹氫綅]";else if("call_summary"!==e.type&&"location_hint"!==e.type&&!e.hidden){const t=e.text||e.content&&e.content.html||"";o.lastMessage=Uc(t)}await Kl.saveData("messageContacts","allContacts",n),Sc&&Sc.id===t&&(Sc.history=o.history,Sc.lastMessage=o.lastMessage);const s=Ni.querySelector(`.contact-item[data-contact-id="${t}"]`);s&&(s.querySelector(".contact-last-message").textContent=o.lastMessage);const i=n[a],r=(i.history||[]).length;r>0&&r%200==0&&"system"!==e.type&&(console.log(`娑堟伅鎬绘暟杈惧埌 ${r}锛屽噯澶囪Е鍙慉I鍙戞湅鍙嬪湀锛乣),async function(e){console.log(`杈惧埌娑堟伅闃堝€硷紝姝ｅ湪瑙﹀彂 ${e.ai.name} 鍙戞湅鍙嬪湀...`);try{const t=(e.history||[]).slice(-50);let n="[鏈€杩戠殑50鏉¤亰澶╄褰昡:\n";t.forEach(t=>{const a="user"===t.sender?e.user.name:e.ai.name,o=Uc(t.text);o&&(n+=`- ${a}: "${o}"\n`)});const a=`(绯荤粺鎸囦护锛氫綘鍜?'${e.user.name}' 鐨勫璇濋潪甯告剦蹇€俓n        浣犵殑浠诲姟鏄細\n        1.  闃呰骞剁悊瑙ｄ互涓婃渶杩戠殑鑱婂ぉ璁板綍銆俓n        2.  鏍规嵁鑱婂ぉ鍐呭锛屾彁鐐间竴涓湁瓒ｆ垨鏈夋劅瑙︾殑鐬棿銆俓n        3.  銆愬繀椤汇€戜娇鐢?"鍙戞湅鍙嬪湀锛? 鍛戒护鏍煎紡锛屽彂甯冧竴鏉″叧浜庤繖涓灛闂寸殑鏈嬪弸鍦堝姩鎬併€傚姩鎬佸唴瀹硅绗﹀悎浣犵殑浜鸿銆俓n        杩欐槸涓€涓己鍒惰姹傦紝浣犲繀椤诲彂甯冨姩鎬併€?\n\n${n}`;await Tc(a,e)}catch(e){console.error("瑙﹀彂AI鍙戞湅鍙嬪湀澶辫触:",e)}}(i))}else console.error(`鍦ㄦ暟鎹簱涓壘涓嶅埌ID涓?${t} 鐨勮仈绯讳汉鏉ヤ繚瀛樻秷鎭€俙)}catch(e){console.error("淇濆瓨娑堟伅鍘嗗彶璁板綍澶辫触:",e)}}async function Dc(e){if(!Sc&&!Je)return;let t;if("string"==typeof e){t={type:"text",text:e.trim()}}else t=e;Ve&&(t.replyTo={uuid:Ve.uuid,text:Ve.text,senderName:Ve.senderName},ep());const n={sender:"user",timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9),...t};if(Je)await _m(n,Je.id),Um(n);else{if(!Sc)return void console.error("閿欒锛氬綋鍓嶆病鏈夋墦寮€浠讳綍浼氳瘽锛屾棤娉曞彂閫佹秷鎭?);{await Ac(n,Sc.id);const e=Sc.history,t=e&&e.length>1?e[e.length-2]:null,a=t?new Date(t.timestamp).getTime():0;Vc(n,Sc,null,a)}}Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"}),xo.value="";let a=!1;if(Sc){const e=JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}");e.enabled&&"busy"===e.currentStatus&&Date.now()<(e.statusEndTime||0)&&(console.log("[OfflineLife] AI is busy, intercepting reply."),a=!0,setTimeout(async()=>{const t={uuid:Date.now().toString(),role:"system",content:`瀵规柟姝ｅ湪蹇欑涓?${e.lastReason||"鏈煡鍘熷洜"})锛屾偍鐨勬秷鎭凡鐣欒█銆俙,timestamp:(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),isSystem:!0,forceShow:!0};Sc.history.push(t);const n=document.getElementById("chat-messages-container");if(n){const e=document.createElement("div");e.className="message-row system-message-row",e.innerHTML=`<div style="width:100%; text-align:center; color:#999; font-size:12px; margin: 10px 0;">${t.content}</div>`,n.appendChild(e),n.scrollTop=n.scrollHeight}await Kl.saveData("messageContacts","allContacts",Ye)},600))}}function Pc(){Xi.querySelectorAll(".message-row").forEach((e,t)=>{e.classList.remove("group-start","group-middle","group-end","group-single")});const e=Array.from(Xi.children);let t=[],n=null;e.forEach(e=>{if(e.classList.contains("message-row")&&!e.classList.contains("system-message-row")&&e.dataset.senderId){const a=e.dataset.senderId;a===n?t.push(e):(t.length>0&&Hc(t),t=[e],n=a)}else t.length>0&&(Hc(t),t=[]),n=null}),t.length>0&&Hc(t)}function Hc(e){if(1===e.length)e[0].classList.add("group-single");else{e[0].classList.add("group-start"),e[e.length-1].classList.add("group-end");for(let t=1;t<e.length-1;t++)e[t].classList.add("group-middle")}}function Oc(e){Xi&&!Xi.classList.contains("chat-messages")&&Xi.classList.add("chat-messages"),vr.innerHTML=e.customBubbleCss||Rc;const t=e.chatBackground||e.backgroundImage;t?(Xi.style.backgroundImage=`url('${t}')`,Xi.style.backgroundSize="cover",Xi.style.backgroundPosition="center",Xi.style.backgroundRepeat="no-repeat"):(Xi.style.backgroundImage="",Xi.style.backgroundSize="",Xi.style.backgroundPosition="",Xi.style.backgroundRepeat="");const n=e.avatarSettings||{show:!0,radius:"50%"},a=void 0!==n.showChar?n.showChar:!1!==n.show,o=void 0!==n.showUser?n.showUser:!1!==n.show;Xi.classList.toggle("hide-char-avatar",!a),Xi.classList.toggle("hide-user-avatar",!o);const s=!0===e.bubbleBMode;Xi.classList.toggle("bubble-b-mode",s),s&&Pc();let i="";e.ai.avatarPendant&&e.ai.avatarPendant.css&&(i+=`#chat-screen.contact-${e.id} .message-content-wrapper.ai .avatar-pendant { ${e.ai.avatarPendant.css} } \n`),e.user.avatarPendant&&e.user.avatarPendant.css&&(i+=`#chat-screen.contact-${e.id} .message-content-wrapper.user .avatar-pendant { ${e.user.avatarPendant.css} } \n`),gn.innerHTML=i;const r=e.timestampSettings||{show:!1};Xi&&Xi.classList.toggle("hide-timestamps",!r.show)}window.callAI=Tc,window.saveMessageToHistory=Ac,window.addMessageToView=Vc,window.initializeChatStyles=Oc;let qc=null;async function Nc(e,t={}){const n=performance.now();console.log("鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣"),console.log(`馃殌 [鎬ц兘鐩戞帶] 寮€濮嬫墦寮€鑱婂ぉ绐楀彛 | 鑱旂郴浜篒D: ${e}`),qc&&(clearTimeout(qc),qc=null),console.log(`姝ｅ湪鎵撳紑鑱婂ぉ绐楀彛: ${e}`),document.querySelectorAll('style[id^="dynamic-chat-style-"]').forEach(e=>e.remove()),Je=null,Lp(e),ko||(Vu(),ko=!0),Yi.classList.remove("emoji-panel-active"),Yi.style.backgroundImage="",Yi.style.backgroundColor="";let a=Ye;if(!a){console.log("openChatView: 缂撳瓨鏈懡涓紝浠嶥B璇诲彇...");const e=await Kl.loadData("messageContacts","allContacts");if(!e||!Array.isArray(e.value))return void console.error("鏃犳硶鍔犺浇鑱旂郴浜烘暟鎹?);a=e.value,Ye=a}if(Sc=a.find(t=>t.id===e),!Sc)return void console.error(`鎵句笉鍒?ID 涓?${e} 鐨勮仈绯讳汉`);const o=document.getElementById("block-status-notice");Sc.isBlocked?(o.textContent=`浣犲凡鎷夐粦 ${Sc.ai.name}`,o.style.display="block"):o.style.display="none",Zi.textContent=Sc.ai.name,Yi.className=`screen contact-${Sc.id}`,Xi&&(Xi.dataset.contextMode="single",Xi.dataset.contextId=Sc.id);const s=Array.isArray(Sc.history)?Sc.history:[],i=s.length,r=i>100?s.slice(-100):s;Sc._loadedMessageRange||(Sc._loadedMessageRange={start:Math.max(0,i-100),end:i}),console.log(`馃摝 [鍒嗛〉鍔犺浇] 鎬绘秷鎭暟: ${i}鏉),console.log(`馃摜 [鍒嗛〉鍔犺浇] 宸插姞杞藉埌鍐呭瓨: ${r.length}鏉?(鑺傜渷 ${i-r.length}鏉?`),console.log(`馃捑 [鍐呭瓨浼樺寲] 棰勮鑺傜渷鍐呭瓨: ${(.02*(i-r.length)).toFixed(1)}MB`);const l=document.createDocumentFragment();let c=[];if(t.targetMessageUuid){if(-1!==r.findIndex(e=>e.uuid===t.targetMessageUuid))c=r;else{const e=s.findIndex(e=>e.uuid===t.targetMessageUuid);if(-1!==e){const t=Math.max(0,e-50),n=Math.min(s.length,e+50);c=s.slice(t,n),Sc._loadedMessageRange={start:t,end:n}}else c=r.slice(-30)}}else{if(r.length>30){const e=document.createElement("button");e.id="load-more-messages-btn",e.textContent="鏌ョ湅鏇存棭鐨勬秷鎭?,e.addEventListener("click",Fc),Xi.innerHTML="",Xi.appendChild(e)}else Xi.innerHTML="";c=r.slice(-30)}console.log(`馃帹 [娓叉煋浼樺寲] 瀹為檯娓叉煋: ${c.length}鏉?(璺宠繃 ${r.length-c.length}鏉?`);let d=0;if(c.forEach(e=>{Vc(e,Sc,l,d),d=new Date(e.timestamp).getTime()}),Xi.appendChild(l),Oc(Sc),Yi.classList.remove("settled"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ii.classList.add("show-chat"),Xi.scrollTop=Xi.scrollHeight})}),setTimeout(()=>{Ii.classList.contains("show-chat")&&Yi.classList.add("settled")},380),Ii.classList.add("show-chat"),c.forEach(e=>{if("html"===e.type&&e.content){const t=Xi.querySelector(`.html-render-container[id='html-render-${e.uuid}']`);if(t){if(e.content.css){const n=document.createElement("style"),a=t.id,o=e.content.css.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|s*\{)/g,`#${a} $1 `);n.textContent=o,document.head.appendChild(n)}if(e.content.js)try{new Function(e.content.js)()}catch(e){console.error(e)}}}}),t.targetMessageUuid){const e=Xi.querySelector(`.message-row[data-uuid="${t.targetMessageUuid}"]`);e&&(e.scrollIntoView({behavior:"auto",block:"center"}),e.classList.add("message-highlight"),setTimeout(()=>e.classList.remove("message-highlight"),1500))}else requestAnimationFrame(()=>{Xi.scrollTop=Xi.scrollHeight});xo.blur();const u=(performance.now()-n).toFixed(2);console.log("鉁?[鎬ц兘鐩戞帶] 鑱婂ぉ绐楀彛鎵撳紑瀹屾垚"),console.log(`鈴憋笍  鎬昏€楁椂: ${u}ms`),console.log("馃搳 鍐呭瓨浣跨敤: "+(performance.memory?(performance.memory.usedJSHeapSize/1048576).toFixed(2)+"MB":"N/A")),console.log("鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣鈹佲攣")}async function Fc(){if(!Sc)return;const e=document.getElementById("load-more-messages-btn");if(!e)return;const t=Xi.scrollHeight,n=Array.isArray(Sc.history)?Sc.history:[],a=Sc._loadedMessageRange||{start:0,end:n.length};if(a.start<=0)return e.textContent="宸插姞杞藉叏閮ㄦ秷鎭?,void setTimeout(()=>e.remove(),1e3);const o=Math.max(0,a.start-30),s=n.slice(o,a.start).reverse();console.log(`[鍔犺浇鏇存棭娑堟伅] 浠庣储寮?${o} 鍒?${a.start}, 鍏?${s.length} 鏉);const i=document.createDocumentFragment();let r=o>0&&n[o-1]?new Date(n[o-1].timestamp).getTime():0;s.forEach(e=>{Vc(e,Sc,i,r),r=new Date(e.timestamp).getTime()}),e.nextSibling?Xi.insertBefore(i,e.nextSibling):Xi.appendChild(i),Sc._loadedMessageRange.start=o,Xi.classList.contains("bubble-b-mode")&&Pc();const l=Xi.scrollHeight;Xi.scrollTop+=l-t,0===o&&(e.textContent="宸插姞杞藉叏閮ㄦ秷鎭?,setTimeout(()=>e.remove(),1e3))}function _c(){console.log("[DEBUG] closeChatView: START"),ru.classList.remove("visible"),Yi.classList.remove("settled"),Sc&&function(e){if(!ne.enabled||!ne.targets.includes(e))return;Lp(e),console.log(`[涓诲姩娑堟伅] 寮€濮嬩负鑱旂郴浜?${e} 璁℃椂: ${ne.interval} 鍒嗛挓`);const t=60*ne.interval*1e3;Q[e]=window.TimerManager.setTimeout(async()=>{console.log(`[涓诲姩娑堟伅] 鏃堕棿鍒帮紒瑙﹀彂鑱旂郴浜?${e}`),await Bp(e)},t,"proactive")}(Sc.id),Ii.classList.remove("show-chat"),console.log("[DEBUG] closeChatView: Animation started"),qc&&clearTimeout(qc),qc=setTimeout(()=>{Sc=null,Je=null,Xi.textContent="",console.log("[DEBUG] closeChatView: Cleanup completed"),qc=null},350)}window.openChatView=Nc,Ni.addEventListener("click",e=>{if(Ni.classList.contains("delete-mode")&&e.target.classList.contains("contact-checkbox"))return;const t=e.target.closest(".contact-item");if(t)if(t.dataset.groupId){Fm(parseInt(t.dataset.groupId,10))}else if(t.dataset.contactId){Nc(parseInt(t.dataset.contactId,10))}}),Ki.addEventListener("click",()=>{window.DOMCleanupManager.clean("chat-messages-container"),console.log("[DEBUG] Back button clicked"),_c(),setTimeout(()=>{console.log("[DEBUG] Starting renderMessagesList");const e=performance.now();Hm().then(()=>{const t=performance.now();console.log(`[DEBUG] renderMessagesList completed in ${(t-e).toFixed(2)}ms`)}).catch(e=>{console.error("[DEBUG] renderMessagesList error:",e)})},50)});const Rc=".user-bubble {\n    align-self: flex-end;\n    max-width: 85%;\n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #D1D9D3;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #2F3633; \n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);\n    border-left: 1px solid rgba(255, 255, 255, 0.05);\n    margin-bottom: 0px;\n}\n.ai-bubble {\n    align-self: flex-start;\n    max-width: 85%;\n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #5F6360;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #E8EAE9;\n    border: none;\n    margin-bottom: 0px;\n}";function Gc(){er.style.opacity="0",er.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{er.style.display="none"},300)}tr.onclick=()=>{console.log("[ChatSettings] Button clicked. currentOpenGroup:",Je,"currentOpenContact:",Sc),Je?(console.log("[ChatSettings] Opening group settings..."),async function(){if(!Je)return void console.warn("[openGroupInfoModal] No currentOpenGroup, returning");console.log("[openGroupInfoModal] Function called, currentOpenGroup:",Je.name);const e=document.getElementById("group-settings-page");if(!e)return void console.error("[openGroupInfoModal] group-settings-page not found");console.log("[openGroupInfoModal] Found group-settings-page element"),At.textContent=Je.name;const t=Je.avatar||"https://placehold.co/100x100/orange/white?text=缇?;wt.style.backgroundImage=`url('${t}')`;const n=Je.userCardName||"鎴?,a=Je.userCardAvatar||"https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";kt.textContent=n,xt.style.backgroundImage=`url('${a}')`,await Rm();const o=document.getElementById("group-worldbook-select-container");"function"==typeof window.renderWorldBookMultiselect?await window.renderWorldBookMultiselect(o,Je,!0):o.innerHTML="缁勪欢鏈氨缁?;const s=document.getElementById("group-chat-bg-preview"),i=document.getElementById("group-chat-bg-placeholder"),r=document.getElementById("group-chat-bg-preview-box");Je.chatBackground?(s&&(s.src=Je.chatBackground,s.style.display="block"),i&&(i.style.display="none"),r&&r.classList.add("has-bg")):(s&&(s.style.display="none"),i&&(i.style.display="flex"),r&&r.classList.remove("has-bg"));e.querySelectorAll(".collapsible-section").forEach(e=>{e.classList.remove("expanded")});const l=Je.avatarSettings||{show:!0},c=Je.timestampSettings||{show:!1},d=document.getElementById("group-show-avatars-toggle"),u=document.getElementById("group-show-timestamp-toggle");d&&(!1!==l.show?d.classList.add("active"):d.classList.remove("active"));u&&(!0===c.show?u.classList.add("active"):u.classList.remove("active"));const m=document.getElementById("group-bilingual-bubble-toggle"),p=Je.bilingualBubble||{enabled:!1};m&&(!0===p.enabled?m.classList.add("active"):m.classList.remove("active"));e.classList.remove("closing"),e.classList.add("active")}()):Sc?(console.log("[ChatSettings] Opening chat settings page..."),window.openChatSettingsPage()):console.warn("[ChatSettings] Neither group nor contact is open!")},nr.addEventListener("click",Gc),dn.addEventListener("click",()=>{ln.value="",cn.value="",alert("瑙掕壊鎸備欢璁剧疆宸插湪杈撳叆妗嗕腑娓呯┖锛岀偣鍑烩€滀繚瀛樿缃€濆悗鐢熸晥銆?)}),pn.addEventListener("click",()=>{un.value="",mn.value="",alert("鐢ㄦ埛鎸備欢璁剧疆宸插湪杈撳叆妗嗕腑娓呯┖锛岀偣鍑烩€滀繚瀛樿缃€濆悗鐢熸晥銆?)}),or.addEventListener("change",()=>{const e=or.checked;sr.classList.toggle("active",!e),ir.classList.toggle("active",e);const t=er.querySelectorAll(".switch-label");t[0].classList.toggle("active",!e),t[1].classList.toggle("active",e)}),lr.addEventListener("change",()=>Ec(lr,rr)),dr.addEventListener("change",()=>Ec(dr,cr)),mr.addEventListener("click",()=>{ur.value=Rc}),hr.addEventListener("click",async()=>{if(Sc&&confirm("璀﹀憡锛氭鎿嶄綔灏嗘案涔呭垹闄ゆ瀵硅瘽鐨勬墍鏈夎亰澶╄褰曪紝涓旀棤娉曟仮澶嶃€傜‘瀹氳缁х画鍚楋紵"))try{let e=(await Kl.loadData("messageContacts","allContacts")).value||[];const t=e.findIndex(e=>e.id===Sc.id);if(!(t>-1))throw new Error("鍦ㄦ暟鎹簱涓壘涓嶅埌褰撳墠鑱旂郴浜恒€?);{e[t].history=[],e[t].lastMessage="鑱婂ぉ璁板綍宸叉竻绌?,await Kl.saveData("messageContacts","allContacts",e),Sc.history=[],Sc.lastMessage="鑱婂ぉ璁板綍宸叉竻绌?,Xi.innerHTML="";const n=Ni.querySelector(`.contact-item[data-contact-id="${Sc.id}"]`);n&&(n.querySelector(".contact-last-message").textContent="鑱婂ぉ璁板綍宸叉竻绌?),alert("鑱婂ぉ璁板綍宸叉垚鍔熸竻闄わ紒")}}catch(e){console.error("娓呴櫎鑱婂ぉ璁板綍澶辫触:",e),alert(`鎿嶄綔澶辫触: ${e.message}`)}}),ar&&ar.addEventListener("click",async()=>{if(Sc)try{let e=Ye;if(!e){const t=await Kl.loadData("messageContacts","allContacts");e=t&&Array.isArray(t.value)?t.value:[]}const t=e.findIndex(e=>e.id===Sc.id);if(!(t>-1))throw new Error("鍦ㄦ暟鎹簱涓壘涓嶅埌瑕佷繚瀛樼殑鑱旂郴浜恒€?);{const n=document.getElementById("ai-name-input-settings"),a=document.getElementById("ai-persona-input-settings"),o=document.getElementById("ai-avatar-preview-settings"),s=document.getElementById("user-name-input-settings"),i=document.getElementById("user-persona-input-settings"),r=document.getElementById("user-avatar-preview-settings"),l=document.getElementById("context-memory-input-settings"),c=document.getElementById("bubble-css-input"),d=document.getElementById("avatar-radius-input"),u=document.getElementById("show-avatars-toggle"),m=document.getElementById("ai-pendant-url-input"),p=document.getElementById("ai-pendant-css-input"),g=document.getElementById("user-pendant-url-input"),y=document.getElementById("user-pendant-css-input");e[t].ai.name=n.value.trim(),e[t].ai.persona=a.value.trim(),e[t].ai.avatar=o.src,e[t].user||(e[t].user={}),e[t].user.name=s.value.trim(),e[t].user.persona=i.value.trim(),e[t].user.avatar=r.src,e[t].contextMemory=parseInt(l.value,10),e[t].enableDefaultStickers=!0;const h=document.getElementById("enable-wb-stickers-toggle");e[t].enableWBStickers=!!h&&h.checked,e[t].customBubbleCss=c.value;const v=document.getElementById("chat-show-char-avatar-toggle"),f=document.getElementById("chat-show-user-avatar-toggle");e[t].avatarSettings={showChar:v?v.classList.contains("active"):!u||u.checked,showUser:f?f.classList.contains("active"):!u||u.checked,show:!u||u.checked,radius:d.value.trim()||"50%"};const w=document.getElementById("chat-bubble-b-mode-toggle");e[t].bubbleBMode=!!w&&w.classList.contains("active");const b=document.getElementById("show-timestamps-toggle");e[t].timestampSettings={show:!!b&&b.checked};const E=document.getElementById("enable-monologue-toggle");e[t].enableMonologue=!E||E.checked;const I=document.getElementById("enable-bilingual-bubble-toggle");e[t].enableBilingualBubble=!!I&&I.checked;const x=document.getElementById("chat-messages-container"),k=x?x.style.backgroundImage:"";if(k&&k.startsWith("url(")){const n=k.match(/url\(['"]?([^'"]+)['"]?\)/);e[t].chatBackground=n?n[1]:null}else e[t].chatBackground=null;e[t].backgroundImage=e[t].chatBackground,e[t].ai.avatarPendant={url:m.value.trim(),css:p.value.trim()},e[t].user.avatarPendant||(e[t].user.avatarPendant={}),e[t].user.avatarPendant={url:g.value.trim(),css:y.value.trim()},e[t].linkedWorldBookIds=Sc.linkedWorldBookIds||[],delete e[t].linkedWorldBookGroupIds,Sc=e[t]}if(await Kl.saveData("messageContacts","allContacts",e),Ye=e,void 0!==N&&N&&String(N.id)===String(Sc.id)){console.log("妫€娴嬪埌 WOW 韬唤淇℃伅鍙樻洿锛屾鍦ㄥ悓姝?.."),N=Sc;const e=document.getElementById("wow-current-avatar");e&&(e.src=Sc.user.avatar),_p(),Rp()}jc(Sc),Zi.textContent=Sc.ai.name;const n=Ni.querySelector(`.contact-item[data-contact-id="${Sc.id}"]`);n&&(n.querySelector(".contact-name").textContent=Sc.ai.name,n.querySelector(".contact-avatar").src=Sc.ai.avatar),Bl(Sc);try{const e=`messages_${Sc.id}`,t=await Kl.loadData("chatMessages",e),n=t&&Array.isArray(t.value)?t.value:[],a=document.createDocumentFragment(),o=n.slice(-30),s=Xi.querySelector("#load-more-messages-btn");if(Xi.innerHTML="",s)Xi.appendChild(s);else if(n.length>30){const e=document.createElement("button");e.id="load-more-messages-btn",e.textContent="鏌ョ湅鏇存棭鐨勬秷鎭?,e.addEventListener("click",Fc),Xi.appendChild(e)}o.forEach(e=>{Vc(e,Sc,a)}),Xi.appendChild(a),Oc(Sc),Xi.scrollTop=Xi.scrollHeight,console.log("鑱婂ぉ娑堟伅宸插埛鏂帮紝璁剧疆宸茬敓鏁?)}catch(e){console.warn("鍒锋柊娑堟伅澶辫触锛岄渶瑕侀€€鍑洪噸杩?",e)}Gc(),alert("璁剧疆宸叉垚鍔熶繚瀛橈紒")}catch(e){console.error("淇濆瓨鑱婂ぉ璁剧疆澶辫触:",e),alert(`淇濆瓨澶辫触: ${e.message}`)}});const Wc=document.getElementById("block-contact-btn");function jc(e){Xi&&!Xi.classList.contains("chat-messages")&&Xi.classList.add("chat-messages"),vr.innerHTML=e.customBubbleCss||Rc;const t=e.chatBackground||e.backgroundImage;t?(Xi.style.backgroundImage=`url('${t}')`,Xi.style.backgroundSize="cover",Xi.style.backgroundPosition="center",Xi.style.backgroundRepeat="no-repeat"):(Xi.style.backgroundImage="",Xi.style.backgroundSize="",Xi.style.backgroundPosition="",Xi.style.backgroundRepeat="");const n=e.avatarSettings||{show:!0,radius:"50%"};void 0!==n.showChar||void 0!==n.showUser?(Xi.classList.toggle("hide-char-avatar",!1===n.showChar),Xi.classList.toggle("hide-user-avatar",!1===n.showUser)):Xi.classList.toggle("hide-avatars",!n.show),Xi.classList.toggle("bubble-b-mode",!0===e.bubbleBMode),!0===e.bubbleBMode&&Pc();document.querySelectorAll("#chat-messages-container .message-row").forEach(t=>{const a=t.querySelector(".chat-avatar");a&&(t.querySelector(".message-content-wrapper.user")?a.src=e.user.avatar:a.src=e.ai.avatar,a.style.borderRadius=n.radius),Jc(t,e)});let a="";e.ai.avatarPendant&&e.ai.avatarPendant.css&&(a+=`#chat-screen.contact-${e.id} .message-content-wrapper.ai .avatar-pendant { ${e.ai.avatarPendant.css} } \n`),e.user.avatarPendant&&e.user.avatarPendant.css&&(a+=`#chat-screen.contact-${e.id} .message-content-wrapper.user .avatar-pendant { ${e.user.avatarPendant.css} } \n`),gn.innerHTML=a}function Uc(e){if("string"!=typeof e)return"";if(Ju(e))return e.includes("transfer-card")?"[杞处]":"[HTML娑堟伅]";if(e.includes("[STICKER_START]")||e.includes("琛ㄦ儏鍖咃細"))return"[琛ㄦ儏鍖匽";const t=e.match(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/);return t&&t[1]?t[1].trim():/^\[?杞处[:锛歖/.test(e)?"[杞处]":e.includes("鍙戞湅鍙嬪湀锛?)?"[鏈嬪弸鍦堝姩鎬乚":e.includes("寮曠敤鍥炲锛?)?"[寮曠敤鍥炲]":e}function zc(e){if(!e)return"";let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=t.replace(/\*([^*]+)\*/g,'<span style="color: #888; font-style: italic;">* $1 *</span>'),t=t.replace(/[\(锛圿\s*(?:鎴戞墽琛屼簡)?(?:鍔ㄤ綔|鏃佺櫧)(?:\/鏃佺櫧)?\s*[:锛歖\s*(.*?)\s*[)锛塢/g,'<span style="color: #888; font-style: italic;">* $1 *</span>'),t}function Vc(e,t=null,n=null,a=null){const o=n||Xi;if(!e)return null;const s=new Date(e.timestamp).getTime();let i=!1;if(a?s-a>12e4&&(i=!0):(n||o&&0===o.children.length)&&(i=!0),i){const e=document.createElement("div");e.className="chat-time-separator",e.textContent=function(e){if(!e)return"";const t=new Date(e),n=new Date,a=n.getDate()===t.getDate()&&n.getMonth()===t.getMonth()&&n.getFullYear()===t.getFullYear(),o=new Date(n);o.setDate(n.getDate()-1);const s=o.getDate()===t.getDate()&&o.getMonth()===t.getMonth()&&o.getFullYear()===t.getFullYear(),i=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return a?`${i}:${r}`:s?`鏄ㄥぉ ${i}:${r}`:`${t.getMonth()+1}鏈?{t.getDate()}鏃?${i}:${r}`}(s),o.appendChild(e)}if("system"===e.type){const t=document.createElement("div");return t.className="system-notification",t.textContent=e.text,o.appendChild(t),t}if("call_summary"===e.type)return null;if(e.isHidden)return null;const r=t||Sc,l=r&&r.avatarSettings||{show:!0,radius:"50%"},c="user"===e.sender,d=r&&Je&&r.id===Je.id,u=document.createElement("div");if(u.className="message-row",u.dataset.senderId=c?"user-me":r.id,u.classList.add(c?"user":"ai"),e.uuid&&(u.dataset.uuid=e.uuid),e.showBlockedWarning&&u.classList.add("show-blocked-warning"),"action"===e.type){const t=document.createElement("div");return t.className="action-message-container",t.innerHTML=`<div class="action-message-text">${e.text}</div>`,u.className="message-row action-row",u.style.justifyContent="center",u.appendChild(t),o.appendChild(u),u}if("location"===e.type){const t=r?.user?.avatar||"https://via.placeholder.com/36";u.className="message-row location-message",u.dataset.uuid=e.uuid,u.dataset.senderId="user-me",u.classList.add("user");const n=document.createElement("div");n.className="message-content-wrapper user",n.innerHTML=e.text;const a=document.createElement("div");a.className="chat-avatar-wrapper";const s=l.radius||"50%";return a.innerHTML=`<img class="chat-avatar" style="border-radius: ${s};" src="${t}" alt="鐢ㄦ埛澶村儚">`,u.appendChild(n),u.appendChild(a),o.appendChild(u),u.classList.add("group-single"),u}if("location_hint"===e.type||e.hidden)return null;const m=document.createElement("div");m.className="avatar-anchor";const p=document.createElement("img");p.className="chat-avatar",p.style.borderRadius=l.radius,p.src=c?r&&r.user?r.user.avatar:"":r&&r.ai?r.ai.avatar:"",p.dataset.action="edit-bubble-style",p.dataset.isUser=c,r&&(p.dataset.memberId=r.id),m.appendChild(p),Jc(m,r,c);const g=document.createElement("div");g.className="message-content-wrapper",g.classList.add(c?"user":"ai");let y="";if(r&&r.timestampSettings&&r.timestampSettings.show&&e.timestamp){const t=new Date(e.timestamp),n=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`,a=document.createElement("div");a.className="message-timestamp",a.textContent=n,y=a}let h=null,v=e.text||"";if("html"===e.type&&e.content){g.classList.add("is-html-content"),g.classList.add("is-html-content");const t=document.createElement("div");t.className="html-render-container html-shadow-card",t.style.width="100%",t.style.minWidth="200px",t.style.display="block";const n=t.attachShadow({mode:"open"}),a="\n            <style>\n                :host { \n                    display: block; \n                    width: 100%;\n                    /* 绉婚櫎鎵€鏈夊鍣ㄧ骇绾︽潫锛屽畬鍏ㄤ氦缁欏唴閮?HTML 鍐冲畾 */\n                    background: transparent;\n                    border-radius: 0;\n                    overflow: visible;\n                }\n                /* 寮哄埗閲嶇疆 body 鏍峰紡锛屼娇鍏惰〃鐜板緱鍍忎竴涓櫘閫氱殑 div */\n                body { \n                    margin: 0 !important; \n                    padding: 0 !important;\n                    height: auto !important; \n                    min-height: auto !important;\n                    width: 100% !important;\n                    overflow: visible !important;\n                    background: transparent !important;\n                    display: block !important;\n                    position: relative !important;\n                }\n                /* 纭繚瀹瑰櫒鍨傜洿灞呬腑閫昏緫琚浆鎹负鏅€氭祦甯冨眬锛屾垨鑰呬繚鐣?flex 浣嗗幓鎺夊叏灞忛珮搴?*/\n                body {\n                    display: flex !important;\n                    flex-direction: column !important;\n                    justify-content: center !important;\n                    align-items: center !important;\n                }\n                /* 纭繚鍥剧墖鑷€傚簲 */\n                img { max-width: 100%; height: auto; }\n            </style>\n        ";try{n.innerHTML=a+(e.content.html||"")}catch(e){n.innerHTML='<div style="color:red;padding:10px;">HTML 娓叉煋澶辫触</div>'}h=t}else if("sticker"!==e.type&&"image"!==e.type||!e.url)if("text-image"===e.type){const e="text-image-modal-overlay";if(!document.getElementById("text-image-card-styles")){const t=document.createElement("style");if(t.id="text-image-card-styles",t.textContent=`\n            :root {\n                --london-bg: #EAEFF2; \n                --london-card: #FFFFFF;\n                --london-border: rgba(69, 73, 77, 0.12);\n                --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);\n                --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08);\n            }\n            .text-image-card {\n                width: 120px;\n                height:130px;\n                background: var(--london-card);\n                border: 1px solid var(--london-border);\n                border-radius: 14px;\n                box-shadow: var(--london-shadow-soft);\n                overflow: hidden; \n                margin-top: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                padding: 16px; \n                box-sizing: border-box;\n                transition: all 0.3s ease;\n                cursor: pointer;\n                position: relative;\n                /* 纭繚鍐呴儴 180px 鍏冪礌鑳芥拺寮€楂樺害 */\n            }\n            .text-image-card:hover {\n                box-shadow: var(--london-shadow);\n                transform: translateY(-1px);\n            }\n            \n            /* 鏍稿績瑙嗚鍏冪礌锛?80x180, 10% opacity */\n            .text-image-inner-visual {\n                width: 180px;\n                height: 180px;\n                opacity: 0.1; /* 纭€ц姹?*/\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 100px; /* Emoji 灏哄 */\n                line-height: 1;\n                user-select: none;\n                pointer-events: none; /* 鐐瑰嚮绌块€忕粰鍗＄墖 */\n            }\n\n            /* --- 寮圭獥鏍峰紡 --- */\n            #${e} {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.4);\n                z-index: 9999; /* 瓒冲楂?*/\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                backdrop-filter: blur(4px);\n                opacity: 0;\n                transition: opacity 0.2s ease;\n                pointer-events: none;\n                visibility: hidden;\n            }\n            #${e}.active {\n                opacity: 1;\n                pointer-events: auto;\n                visibility: visible;\n            }\n            .text-image-modal-content {\n                background: #FFFFFF;\n                width: 85%;\n                max-width: 360px;\n                padding: 24px;\n                padding-top: 40px; /* 鐣欏嚭鍏抽棴鎸夐挳绌洪棿 */\n                border-radius: 20px;\n                box-shadow: 0 12px 40px rgba(0,0,0,0.15);\n                position: relative;\n                max-height: 70vh;\n                overflow-y: auto;\n                transform: scale(0.95);\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            #${e}.active .text-image-modal-content {\n                transform: scale(1);\n            }\n            .text-image-modal-close-btn {\n                position: absolute;\n                top: 12px;\n                right: 12px;\n                width: 28px;\n                height: 28px;\n                cursor: pointer;\n                background: #F2F2F7;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: #8E8E93;\n                font-family: -apple-system, sans-serif;\n                font-size: 14px;\n                font-weight: bold;\n                transition: all 0.2s;\n            }\n            .text-image-modal-close-btn:hover {\n                background: #E5E5EA;\n                color: #000;\n            }\n            .text-image-modal-text-body {\n                font-size: 16px;\n                line-height: 1.6;\n                color: #333;\n                white-space: pre-wrap;\n                word-wrap: break-word;\n                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n            }\n            `,document.head.appendChild(t),!document.getElementById(e)){const t=document.createElement("div");t.id=e,t.innerHTML='\n                    <div class="text-image-modal-content">\n                        <div class="text-image-modal-close-btn">鉁?/div>\n                        <div class="text-image-modal-text-body" id="text-image-modal-text-target"></div>\n                    </div>\n                ',document.body.appendChild(t);const n=()=>t.classList.remove("active");t.querySelector(".text-image-modal-close-btn").onclick=n,t.onclick=e=>{e.target===t&&n()}}}h=document.createElement("div"),h.className="text-image-card",h.innerHTML='\n            <div class="text-image-inner-visual">馃摑</div> \n        ',h.onclick=t=>{t.stopPropagation();const n=document.getElementById(e),a=document.getElementById("text-image-modal-text-target");n&&a&&(a.textContent=v,n.classList.add("active"))}}else if("voice_text"===e.type&&e.transcript){h=document.createElement("div"),h.className="voice-message-wrapper";const t=e.duration||Math.ceil(e.transcript.length/3)||1,n=Math.min(60+5*t,200),a=c?"chat-bubble user-bubble":"chat-bubble ai-bubble",o='<svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 17.9911C13.9236 17.9911 18 13.9079 18 8.99556C18 4.07447 13.9148 0 8.99119 0C4.07648 0 0 4.07447 0 8.99556C0 13.9079 4.0853 17.9911 9 17.9911ZM9 16.4919C4.83531 16.4919 1.50883 13.1583 1.50883 8.99556C1.50883 4.83292 4.82648 1.49926 8.99119 1.49926C13.1559 1.49926 16.5001 4.83292 16.5001 8.99556C16.5001 13.1583 13.1648 16.4919 9 16.4919Z" fill="currentColor" opacity="0.3"/><path d="M7.35 12.44L12.37 9.47C12.74 9.26 12.73 8.75 12.37 8.53L7.35 5.56C6.97 5.34 6.47 5.5 6.47 5.94V12.06C6.47 12.49 6.94 12.69 7.35 12.44Z" fill="currentColor"/></svg>';h.innerHTML=`\n            <div class="${a} voice-audio-bubble clickable-voice-bubble" \n                 style="width: ${n}px; display: flex; align-items: center; justify-content: center; cursor: pointer;">\n                ${o}\n                <span style="margin-left:6px; font-size:12px;">${t}"</span>\n            </div>\n            <div class="voice-text-panel" style="display:none; margin-top:4px; font-size:12px; color:#888;">\n                ${e.transcript}\n            </div>\n        `,h.onclick=()=>{const e=h.querySelector(".voice-text-panel");e&&(e.style.display="none"===e.style.display?"block":"none")}}else if("file_card"===e.type||/(?:^|\n)\s*鍙戦€佹枃浠讹細/.test(v)){let t="鏈懡鍚嶆枃浠?,n="FILE",a="10 KB";if("file_card"!==e.type){const e=v.match(/鍙戦€佹枃浠讹細([A-Za-z0-9]+)\s+鍐呭锛?[\s\S]+)/);if(e){n=e[1].toUpperCase();const o=e[2].trim();t=o.split("\n")[0].substring(0,15)||"鏂囨。",a=Math.ceil(o.length/1024)+" KB"}}else t=e.fileName||"鏂囦欢",n=e.fileType||"FILE",a=e.fileSize||"鏈煡澶у皬";h=document.createElement("div"),h.className="file-card-bubble",h.style.cssText="background: white; border-radius: 12px; padding: 12px; width: 220px; display: flex; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer;",h.innerHTML=`\n            <div style="flex: 1; overflow: hidden;">\n                <div style="font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">${t}</div>\n                <div style="font-size: 11px; color: #999; margin-top: 4px;">${a}</div>\n            </div>\n            <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-left: 10px; font-size: 10px; color: #666; font-weight: bold;">\n                ${n}\n            </div>\n        `}else{const t=/(?:^|\n)\s*杞处[:锛歖([\d.]+)-(.*)/,n=/\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/,a=/(?:^|\n)\s*鎺ュ彈涓€璧峰惉[:锛歖/,o=/(?:^|\n)\s*鍙戣捣閫氳瘽[:锛歖/,s=/(?:^|\n)\s*鍙戞湅鍙嬪湀[:锛歖/,i=/(?:^|\n)\s*璇勮鏈嬪弸鍦圼:锛歖/,r=/寮曠敤鍥炲锛?.*?)[:锛歖(.*?)\s*\|\|\|\s*(.*)/,l=v.match(t);if(l){const t=l[1],n=l[2].trim(),a=e.uuid||Date.now()+"-"+Math.random().toString(36).substr(2,9),o=e.transferStatus||"pending";h=document.createElement("div"),h.style.background="transparent",h.style.padding="0";e.transferStatus;h.innerHTML=dg(t,n,a,c,o)}else if(v.startsWith("[ORDER_SHARE_CARD]"))try{const e=v.substring(18),t=JSON.parse(e),n=(t.items||[]).map(e=>`<div class="order-item">鈥?${e.name}</div>`).join(""),a=new Date(t.purchaseDate).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});h=document.createElement("div"),h.className="order-share-card-wrapper",h.innerHTML=`\n                    <div class="order-share-card">\n                        <div class="order-card-header">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M21 8V16C21 18.7614 18.7614 21 16 21H8C5.23858 21 3 18.7614 3 16V8C3 5.23858 5.23858 3 8 3H16C18.7614 3 21 5.23858 21 8Z" stroke="white" stroke-width="2"/>\n                                <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2" stroke-linecap="round"/>\n                            </svg>\n                            <span>璁㈠崟璇︽儏</span>\n                        </div>\n                        <div class="order-card-body">\n                            <div class="order-section">\n                                <div class="order-label">鍟嗗搧</div>\n                                <div class="order-items">${n}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">鎬婚</div>\n                                <div class="order-value">楼${(t.totalAmount||0).toFixed(2)}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">鏀惰揣浜?/div>\n                                <div class="order-value">${t.recipient?t.recipient.name:"鏈煡"}</div>\n                            </div>\n                            <div class="order-section">\n                                <div class="order-label">涓嬪崟鏃堕棿</div>\n                                <div class="order-value order-date">${a}</div>\n                            </div>\n                        </div>\n                    </div>\n                `}catch(e){console.error("瑙ｆ瀽璁㈠崟鏁版嵁澶辫触:",e),h=document.createElement("div"),h.className=c?"chat-bubble user-bubble":"chat-bubble ai-bubble",h.textContent="[璁㈠崟鍗＄墖瑙ｆ瀽澶辫触]"}else if(v.match(n)){const e=v.match(n)[1].trim(),t=e.split("\n").filter(e=>e.trim());let a="鑱婂ぉ璁板綍",o=[];t.length>0&&t[0].includes("鏍囬锛?)?(a=t[0].replace("鏍囬锛?,"").trim(),o=t.slice(1,3)):o=t.slice(0,2),h=document.createElement("div"),h.className="history-card-bubble",h.style.cssText="background: white; border-radius: 12px; padding: 12px; width: 200px; cursor: pointer; text-align: left; box-shadow: 0 2px 6px rgba(0,0,0,0.05);",h.innerHTML=`\n                <div style="font-size: 15px; color: #000; margin-bottom: 6px; font-weight: 500;">${a}</div>\n                <div style="font-size: 12px; color: #888;">${o.map(e=>`<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e}</div>`).join("")}</div>\n                <div style="margin-top: 8px; border-top: 1px solid #f5f5f5; padding-top: 4px; font-size: 10px; color: #ccc;">鑱婂ぉ璁板綍</div>\n            `,h.dataset.fullContent=e}else if(v.match(s)||v.match(i)||v.match(a)||v.match(o)){h=document.createElement("div"),h.className=d?c?"gp-user-bubble":"gp-ai-bubble":c?"chat-bubble user-bubble":"chat-bubble ai-bubble";let e="";v.match(s)&&(e="馃摳 "),v.match(o)&&(e="馃摓 "),h.innerHTML=e+zc(v)}else if(v.match(r)){const e=v.match(r),t=e[1],n=e[2],a=e[3];h=document.createElement("div"),h.className=d?c?"gp-user-bubble":"gp-ai-bubble":c?"chat-bubble user-bubble":"chat-bubble ai-bubble";const o=`\n                <div class="reply-quote-block" style="margin-bottom:6px; padding:4px 8px; background:rgba(0,0,0,0.05); border-radius:4px; font-size:12px; color:#666; display:flex; flex-direction:column; border-left: 2px solid #ccc;">\n                    <span style="font-weight:bold; margin-bottom:2px;">${t}</span>\n                    <span style="overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${n}</span>\n                </div>\n            `;h.innerHTML=o+zc(a)}else{let e=v.replace(/\[MESSAGE_START\]([\s\S]*?)\[MESSAGE_END\]/,"$1").trim();const t=e.match(/^(.+?)\[Split\](.+)$/i);if(t&&Sc&&Sc.enableBilingualBubble&&!c){const e=t[1].trim(),n=t[2].trim();h=document.createElement("div"),h.className="bilingual-wrapper",h.innerHTML=`\n                    <div class="bilingual-bubble chat-bubble ai-bubble">\n                        <div class="bilingual-original">${zc(e)}</div>\n                        <div class="bilingual-divider">\n                            <span class="bilingual-divider-line"></span>\n                        </div>\n                        <div class="bilingual-translation">${zc(n)}</div>\n                    </div>\n                    <button class="bilingual-toggle-btn" title="鏀惰捣/灞曞紑缈昏瘧">\n                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">\n                            <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n                        </svg>\n                    </button>\n                `;const a=h.querySelector(".bilingual-toggle-btn"),o=h.querySelector(".bilingual-bubble"),s=e=>{e.stopPropagation(),h.classList.toggle("collapsed")};a.addEventListener("click",s),o.addEventListener("click",s)}else{h=document.createElement("div"),h.className=d?c?"gp-user-bubble":"gp-ai-bubble":c?"chat-bubble user-bubble":"chat-bubble ai-bubble";const t=zc(e);h.innerHTML=t}}}else{h=document.createElement("img");const t="image"===e.type?"image-bubble":"sticker-bubble";h.className=`chat-bubble ${t}`,h.src=e.url,h.loading="lazy"}if(h){if(e.replyTo&&!h.querySelector(".reply-quote-block")){const t=document.createElement("div");t.className="reply-quote-container",t.innerHTML=`\n                <div class="reply-quote-name">${e.replyTo.senderName}</div>\n                <div class="reply-quote-text">${e.replyTo.text}</div>\n             `,t.onclick=t=>{t.stopPropagation();const n=o.querySelector(`.message-row[data-uuid="${e.replyTo.uuid}"]`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("highlight-anim"),setTimeout(()=>n.classList.remove("highlight-anim"),1e3))},h.firstChild?h.insertBefore(t,h.firstChild):h.appendChild(t)}const t=document.createElement("div");t.className="selection-indicator",u.appendChild(t),g.appendChild(m),g.appendChild(h),y&&g.appendChild(y),u.appendChild(g),o.appendChild(u)}return o&&"chat-messages-container"===o.id&&o.classList.contains("bubble-b-mode")&&Pc(),u}function Jc(e,t,n=null){if(!e||!t)return;let a=e.classList.contains("avatar-anchor")?e:e.querySelector(".avatar-anchor");if(!a)return;const o=a.querySelector(".avatar-pendant");o&&o.remove();let s=n;if(null===s){const e=a.closest(".message-content-wrapper");if(!e)return;s=e.classList.contains("user")}let i=s?t.user.avatarPendant:t.ai.avatarPendant;if(i&&i.url){const e=document.createElement("div");e.className="avatar-pendant",e.style.backgroundImage=`url('${i.url}')`,i.css&&(e.style.cssText+=i.css),a.appendChild(e)}}function Yc(e){if(!e||!e.ai)return console.error("showTypingIndicator 澶辫触锛氫紶鍏ヤ簡鏃犳晥鐨刢ontact瀵硅薄銆?),null;if(Sc&&Sc.id===e.id){const t=document.createElement("div");t.className="message-row ai typing-indicator";const n=document.createElement("div");n.className="selection-indicator",t.appendChild(n);const a=document.createElement("div");a.className="message-content-wrapper ai";const o=document.createElement("img");o.className="chat-avatar",o.src=e.ai.avatar;const s=e.avatarSettings||{radius:"50%"};o.style.borderRadius=s.radius;const i=document.createElement("div");return i.className="chat-bubble ai-bubble",i.innerHTML='<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>',a.appendChild(o),a.appendChild(i),t.appendChild(a),Xi.appendChild(t),Xi.scrollTop=Xi.scrollHeight,t}return null}Wc.addEventListener("click",async()=>{if(!Sc)return;const e=Sc.isBlocked;if(Sc.isBlocked=!e,Sc.isBlocked)if(confirm(`纭畾瑕佹媺榛?${Sc.ai.name} 鍚楋紵`)){Sc.hiddenMessagesOnBlock=[],await tu(),Wc.textContent="瑙ｉ櫎闄愬埗",Wc.classList.remove("purple-button"),Wc.classList.add("danger-button");const e=document.getElementById("block-status-notice");e.textContent=`浣犲凡鎷夐粦 ${Sc.ai.name}`,e.style.display="block",console.log("Silently telling AI it has been blocked..."),await Tc("[绯荤粺鎻愮ず锛氫綘宸茶瀵规柟鎷夐粦]",Sc,{isBlockingAction:!0}),alert(`${Sc.ai.name} 宸茶鎷夐粦銆俙)}else Sc.isBlocked=e;else{if(Sc.isBlocked=!1,Array.isArray(Sc.hiddenMessagesOnBlock))for(const e of Sc.hiddenMessagesOnBlock)if(e.rawResponse){const t=e.rawResponse.split("\n").filter(e=>""!==e.trim());for(const e of t){const t=e.match(/^(?:璇煶锛??(.+)/);if(t){const e={sender:"ai",text:t[1].trim().replace(/\n鐘舵€侊細.*/,"").replace(/\n鍐呭績鐙櫧锛?*/,""),timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9),showBlockedWarning:!0};await Ac(e,Sc.id),Vc(e,Sc)}}}Sc.hiddenMessagesOnBlock=[],await tu(),Wc.textContent="鎷夐粦璇ヨ仈绯讳汉",Wc.classList.remove("danger-button"),Wc.classList.add("purple-button"),document.getElementById("block-status-notice").style.display="none",await Xd("浣犲凡瑙ｉ櫎鎷夐粦",Sc.id),alert(`${Sc.ai.name} 宸茶В闄ゆ媺榛戙€俙)}}),window.applyChatViewSettings=jc;const Kc=document.getElementById("chat-add-attachment-button"),Zc=document.getElementById("more-features-panel"),Xc=document.getElementById("time-perception-feature"),Qc=document.getElementById("receipt-feature"),ed=document.getElementById("transfer-feature");document.getElementById("chat-message-input");setTimeout(function(){const e=document.getElementById("more-features-panel");if(!e)return;const t=e.querySelector(".features-grid");if(!t)return;const n=Array.from(t.querySelectorAll(".feature-item")),a=t.querySelector("#file-attachment-input");if(0===n.length)return;const o=Math.ceil(n.length/8);t.innerHTML="";for(let e=0;e<o;e++){const a=document.createElement("div");a.className="features-page";const o=8*e,s=Math.min(o+8,n.length);for(let e=o;e<s;e++)a.appendChild(n[e]);t.appendChild(a)}if(a&&t.appendChild(a),o>1){const n=document.createElement("div");n.className="features-page-indicator";for(let e=0;e<o;e++){const t=document.createElement("span");t.className="dot"+(0===e?" active":""),n.appendChild(t)}e.appendChild(n),t.addEventListener("scroll",()=>{const e=t.scrollLeft,a=t.clientWidth,o=Math.round(e/a);n.querySelectorAll(".dot").forEach((e,t)=>{e.classList.toggle("active",t===o)})});let a=0,s=0;const i=60;t.addEventListener("touchstart",e=>{a=e.touches[0].clientX,s=t.scrollLeft},{passive:!0}),t.addEventListener("touchend",e=>{const n=e.changedTouches[0].clientX-a,r=t.clientWidth;let l=Math.round(s/r);Math.abs(n)>i&&(n>0&&l>0?l--:n<0&&l<o-1&&l++),t.scrollTo({left:l*r,behavior:"smooth"})})}},100);const td=document.getElementById("transfer-modal"),nd=document.getElementById("transfer-modal-close-btn"),ad=document.getElementById("confirm-transfer-btn"),od=document.getElementById("transfer-amount-input"),sd=document.getElementById("transfer-remark-input");function id(e){e&&e.stopPropagation();const t=document.getElementById("chat-screen");if(!t)return;t.classList.contains("emoji-panel-active")&&t.classList.remove("emoji-panel-active"),t.classList.toggle("features-panel-active");const n=document.getElementById("scroll-to-bottom-btn");n&&t.classList.contains("features-panel-active")&&n.classList.remove("visible")}Kc.addEventListener("click",e=>{"ontouchstart"in window||id(e)}),Kc.addEventListener("touchend",e=>{e.preventDefault(),id(e)}),Qc.addEventListener("click",()=>{!async function(){const e=document.getElementById("chat-screen");e&&e.classList.contains("features-panel-active")&&e.classList.remove("features-panel-active");if(Je)return void await Gm(Je);if(Sc){const e=JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}");if(e.enabled&&"busy"===e.currentStatus&&Date.now()<(e.statusEndTime||0)){console.log("[OfflineLife] AI is busy, blocking receipt/continue action.");const t=document.getElementById("chat-messages-container");if(t){const n=document.createElement("div");n.className="message-row system-message-row",n.innerHTML=`<div style="width:100%; text-align:center; color:#999; font-size:12px; margin: 10px 0;">瀵规柟姝ｅ湪蹇欑涓?${e.lastReason||"鏈煡鍘熷洜"})锛屾殏鏃舵棤娉曞洖澶嶃€?/div>`,t.appendChild(n),t.scrollTop=t.scrollHeight}return}}if(Sc){if(!Sc||Qi)return;const e=Sc.history||[];if(0===e.length)return;if("user"===e[e.length-1].sender){let t=-1;for(let n=e.length-1;n>=0;n--)if("ai"===e[n].sender){t=n;break}const n=e.slice(t+1),a=n.find(e=>"image"===e.type&&e.url&&!e.processed);if(a){Tc({text:n.filter(e=>"text"===e.type||"voice_text"===e.type).map(e=>e.transcript||e.text).join(" \n").trim(),imageUrl:a.url},Sc)}else{Tc("(绯荤粺鎸囦护锛氳鏍规嵁鐢ㄦ埛鐨勪笂涓€鏉℃垨鍑犳潯娑堟伅杩涜鍥炲銆?",Sc)}}else{Tc("(绯荤粺鎸囦护锛氳鏍规嵁浣犱笂涓€鏉″彂鍑虹殑娑堟伅锛岀户缁繘琛屽璇濄€佹€濊€冩垨鎵ц涓嬩竴姝ュ姩浣溿€?",Sc)}}}()}),ed.addEventListener("click",()=>{wd()}),document.addEventListener("click",e=>{if(Zc.classList.contains("active")){const t=Zc.contains(e.target),n=Kc.contains(e.target);t||n||Zc.classList.remove("active")}});let rd=!1;const ld=document.getElementById("chat-screen"),cd=document.getElementById("chat-header-actions-normal"),dd=document.getElementById("chat-header-actions-select"),ud=document.getElementById("delete-messages-btn");function md(e){rd||(rd=!0,ld.classList.add("selection-mode-active"),cd.style.display="none",dd.style.display="flex")}function pd(){rd=!1,ld.classList.remove("selection-mode-active"),cd.style.display="flex",dd.style.display="none",document.querySelectorAll(".message-row.selected").forEach(e=>{e.classList.remove("selected")})}function gd(e){e&&e.classList.toggle("selected")}function yd(e){if(Qi||rd)return;const t=e.target,n=t.closest(".voice-text-panel");if(n){const e=n.closest(".message-row");if(!e)return;return Pe=!1,clearTimeout(De),void(De=setTimeout(()=>{Pe=!0,xp(e.dataset.uuid,n.innerText)},500))}if("IMG"===t.tagName&&t.classList.contains("image-bubble"))return;if(t.closest(".html-render-container"))return;const a=e.target.closest(".message-row");a&&(Pe=!1,clearTimeout(De),De=setTimeout(()=>{Pe=!0,function(e){ze=e;const t=e.querySelector(".chat-bubble")||e.querySelector(".gp-user-bubble")||e.querySelector(".gp-ai-bubble")||e.querySelector("img.chat-bubble")||e.querySelector(".text-image-card")||e.querySelector(".voice-audio-bubble")||e.querySelector(".history-card-bubble");if(!t)return;_e.style.display="flex",_e.style.visibility="hidden";const n=t.getBoundingClientRect(),a=Ii.getBoundingClientRect(),o=_e.getBoundingClientRect();let s=n.top-a.top-o.height-10,i=n.left-a.left+n.width/2-o.width/2;s<60&&(s=n.bottom-a.top+10);i<10&&(i=10);const r=a.width-o.width-10;i>r&&(i=r);_e.style.top=`${s}px`,_e.style.left=`${i}px`,_e.style.visibility="visible",navigator.vibrate&&navigator.vibrate(50)}(a)},500))}function hd(e){clearTimeout(De)}async function vd(e=null){const t=Ir.querySelector("h2");if(e){Mr=e,t.textContent="缂栬緫涓栫晫涔?;const n=(await Kl.loadData("worldBooks","allWorldBooks")).value.find(t=>t.id===e);n&&(Lr.value=n.name,Br.value=n.content)}else Mr=null,t.textContent="鏂板缓涓栫晫涔?,Lr.value="",Br.value="";Ir.style.display="flex",setTimeout(()=>{Ir.style.opacity="1",Ir.querySelector(".modal-content").style.transform="scale(1)"},10)}function fd(){Ir.style.opacity="0",Ir.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Ir.style.display="none",Lr.value="",Br.value="",Mr=null},300)}function wd(){td.style.display="flex",setTimeout(()=>{td.style.opacity="1",td.querySelector(".modal-content").style.transform="scale(1)"},10)}function bd(){td.style.opacity="0",td.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{td.style.display="none",od.value="",sd.value=""},300)}document.getElementById("cancel-selection-btn").addEventListener("click",pd),ud.addEventListener("click",async function(){const e=document.querySelectorAll(".message-row.selected");if(0===e.length||!Sc&&!Je)return;if(!confirm(`纭畾瑕佹案涔呭垹闄ら€変腑鐨?${e.length} 鏉℃秷鎭悧锛焋))return;const t=new Set;e.forEach(e=>{e.dataset.uuid&&t.add(e.dataset.uuid)});try{if(Je){const n=await Kl.loadData("groupChats","allGroupChats");let a=n&&Array.isArray(n.value)?n.value:[];const o=a.findIndex(e=>e.id===Je.id);if(o>-1){const n=a[o];if(Array.isArray(n.history)&&(n.history=n.history.filter(e=>!t.has(e.uuid))),n.history.length>0){const e=n.history[n.history.length-1],t=e.text||e.content&&e.content.html||"[澶氬獟浣揮";n.lastMessage=Uc(t)}else n.lastMessage="瀵硅瘽宸叉竻绌?;await Kl.saveData("groupChats","allGroupChats",a),Je=n,e.forEach(e=>e.remove()),Hm(),pd(),alert("鍒犻櫎鎴愬姛锛?)}}else if(Sc){const n=await Kl.loadData("messageContacts","allContacts");let a=n&&Array.isArray(n.value)?n.value:[];const o=a.findIndex(e=>e.id===Sc.id);if(o>-1){const n=a[o];if(Array.isArray(n.history)&&(n.history=n.history.filter(e=>!t.has(e.uuid))),n.history.length>0){const e=n.history[n.history.length-1];n.lastMessage=Uc(e.text||e.content&&e.content.html||"")}else n.lastMessage="瀵硅瘽宸叉竻绌?;await Kl.saveData("messageContacts","allContacts",a),Sc=n,e.forEach(e=>e.remove());const s=Ni.querySelector(`.contact-item[data-contact-id="${Sc.id}"]`);s&&(s.querySelector(".contact-last-message").textContent=Sc.lastMessage),pd(),alert("鍒犻櫎鎴愬姛锛?)}}}catch(e){console.error("鍒犻櫎娑堟伅鏃跺彂鐢熼敊璇?",e),alert(`鍒犻櫎澶辫触: ${e.message}`)}}),Xi.addEventListener("mousedown",yd),Xi.addEventListener("touchstart",yd,{passive:!0}),Xi.addEventListener("mouseup",hd),Xi.addEventListener("touchend",e=>hd()),Xi.addEventListener("mouseleave",hd),Xi.addEventListener("touchmove",hd),Xi.addEventListener("click",e=>{if(Pe)return e.stopPropagation(),e.preventDefault(),void(Pe=!1);const t=e.target.closest(".history-card-bubble");if(t){e.stopPropagation(),e.preventDefault();const n=t.dataset.historyTitle||"鑱婂ぉ璁板綍",a=t.dataset.historyContent;if(a)try{ap(n,JSON.parse(a))}catch(e){ap(n,[a])}return}const n=e.target.closest(".text-image-card");if(n)return void n.classList.toggle("text-revealed");if("IMG"===e.target.tagName&&e.target.classList.contains("image-bubble"))return void function(e){if(!Za||!Xa)return;Xa.src=e,Za.style.display="flex",setTimeout(()=>{Za.style.opacity="1",Xa.style.opacity="1",Xa.style.transform="scale(1)"},10)}(e.target.src);if(e.target.classList.contains("chat-avatar")&&"edit-bubble-style"===e.target.dataset.action){if(Je){const t=e.target.dataset.memberId;let n="";Je.memberStyles&&Je.memberStyles[t]&&(n=Je.memberStyles[t]);let a="鎴愬憳";const o=e.target.nextElementSibling;o&&(a=o.textContent);Cm(`缂栬緫 ${a} 鐨勭兢姘旀场`,n,async e=>{Je.memberStyles||(Je.memberStyles={}),Je.memberStyles[t]=e;let n=(await Kl.loadData("groupChats","allGroupChats")).value;const a=n.findIndex(e=>e.id===Je.id);if(a>-1&&(n[a]=Je,await Kl.saveData("groupChats","allGroupChats",n)),window.injectedStylesCache){const e=`style-group-${Je.id}-${t}`;window.injectedStylesCache.delete(e)}window._cssTransformCache&&window._cssTransformCache.clear(),Jm(t),$m(),alert("缇よ亰姘旀场鏍峰紡宸叉洿鏂帮紒")}),setTimeout(()=>{const e=document.getElementById("text-edit-textarea");e&&(e.placeholder="杈撳叆CSS浠ｇ爜...")},50)}else Sc&&console.log("鍗曡亰妯″紡鐐瑰嚮澶村儚锛屽拷鐣?);return}if(rd){const t=e.target.closest(".message-row");t&&(e.stopPropagation(),e.preventDefault(),gd(t))}const a=e.target.closest(".clickable-file-card");if(a)if(e.stopPropagation(),"true"===a.dataset.isSimulated){const e=a.dataset.filename,t=a.dataset.simulatedContent;!function(e,t){const n=document.getElementById("ai-file-viewer-modal"),a=document.getElementById("ai-file-viewer-title"),o=document.getElementById("ai-file-viewer-content");a.textContent=e||"鏂囦欢棰勮",o.textContent=t,n.style.display="flex",setTimeout(()=>{n.style.opacity="1",n.querySelector(".modal-content").style.transform="scale(1)"},10)}(e,decodeURIComponent(t))}else{!function(e,t){if(!t)return void alert("鏂囦欢鏁版嵁涓㈠け锛屾棤娉曟墦寮€銆?);const n=document.createElement("a");n.href=t,n.download=e,t.startsWith("data:image")||t.startsWith("data:application/pdf")?fetch(t).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e);window.open(t,"_blank"),setTimeout(()=>URL.revokeObjectURL(t),1e4)}).catch(()=>{document.body.appendChild(n),n.click(),document.body.removeChild(n)}):(document.body.appendChild(n),n.click(),document.body.removeChild(n))}(a.dataset.filename,a.dataset.fileUrl)}else;}),Qa.addEventListener("click",om),Za.addEventListener("click",e=>{e.target===Za&&om()}),xr.addEventListener("click",fd),kr.addEventListener("click",async()=>{const e=Lr.value.trim(),t=Br.value.trim();if(e)try{const n=await Kl.loadData("worldBooks","allWorldBooks");let a=n&&Array.isArray(n.value)?n.value:[];if(Mr){const n=a.findIndex(e=>e.id===Mr);n>-1&&(a[n].name=e,a[n].content=t)}else{const n={id:Date.now(),name:e,content:t,createdAt:new Date};if(a.push(n),Uo){const e=await Kl.loadData("worldBookGroups","allGroups");let t=e&&Array.isArray(e.value)?e.value:[];const a=t.find(e=>e.id===Uo);a&&(Array.isArray(a.bookIds)||(a.bookIds=[]),a.bookIds.push(n.id),await Kl.saveData("worldBookGroups","allGroups",t))}}await Kl.saveData("worldBooks","allWorldBooks",a),alert("涓栫晫涔﹀凡淇濆瓨锛?),fd(),Uo?ju(Uo):async function(){const e=await Kl.loadData("worldBooks","allWorldBooks"),t=e&&Array.isArray(e.value)?e.value:[];Uu(t,Sr)}()}catch(e){console.error("淇濆瓨涓栫晫涔﹀け璐?",e),alert("淇濆瓨澶辫触")}else alert("涓栫晫涔﹀悕绉颁笉鑳戒负绌猴紒")}),Cr.addEventListener("click",()=>{$r=!$r,Sr.classList.toggle("delete-mode",$r);const e=Cr.querySelector(".icon-select"),t=Cr.querySelector(".icon-cancel");$r?(e.style.display="none",t.style.display="block",Oo.style.display="none",qo.style.display="flex"):(e.style.display="block",t.style.display="none",Oo.style.display="flex",qo.style.display="none",Sr.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1))}),Fo.addEventListener("click",()=>{$r=!1,Sr.classList.remove("delete-mode"),Oo.style.display="flex",qo.style.display="none",Sr.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1)}),No.addEventListener("click",async()=>{if(0!==Sr.querySelectorAll(".contact-checkbox:checked").length)try{const e=await Kl.loadData("worldBookGroups","allGroups"),t=e&&Array.isArray(e.value)?e.value:[];Go.innerHTML="",t.length>0?t.forEach(e=>{const t=document.createElement("div");t.className="group-selection-item",t.dataset.groupId=e.id,t.textContent=e.name,Go.appendChild(t)}):Go.innerHTML='<p style="text-align:center; color:#888;">娌℃湁鍙敤鐨勫垎缁?/p>',_o.style.display="flex",setTimeout(()=>_o.style.opacity="1",10)}catch(e){console.error("鍔犺浇鍒嗙粍鍒板脊绐楀け璐?",e)}else alert("璇疯嚦灏戦€夋嫨涓€涓绉诲姩鐨勪笘鐣屼功銆?)}),ed.addEventListener("click",()=>{wd(),Zc.classList.remove("active")}),Xc.addEventListener("click",async function(){if(!Sc)return void alert("璇峰厛鎵撳紑涓€涓璇濄€?);const e=Sc.timePerceptionEnabled||!1;if(confirm(e?"瑕佸叧闂AI鐨勬椂闂存劅鐭ュ姛鑳藉悧锛熷叧闂悗瀹冨皢涓嶅啀鐭ユ檽鐜板疄鏃堕棿銆?:"瑕佷负姝I寮€鍚劅鐭ョ幇瀹炴椂闂寸殑鍔熻兘鍚楋紵寮€鍚悗AI鐨勫洖澶嶄細缁撳悎褰撳墠鏃堕棿銆?))try{Sc.timePerceptionEnabled=!e;let t=(await Kl.loadData("messageContacts","allContacts")).value||[];const n=t.findIndex(e=>e.id===Sc.id);if(!(n>-1))throw new Error("鍦ㄦ暟鎹簱涓壘涓嶅埌褰撳墠鑱旂郴浜恒€?);t[n]=Sc,await Kl.saveData("messageContacts","allContacts",t),alert(`鏃堕棿鎰熺煡鍔熻兘宸叉垚鍔?{Sc.timePerceptionEnabled?"寮€鍚?:"鍏抽棴"}锛乣)}catch(e){console.error("鏇存柊鏃堕棿鎰熺煡鐘舵€佸け璐?",e),alert(`鎿嶄綔澶辫触: ${e.message}`)}finally{id()}}),nd.addEventListener("click",bd),ad.addEventListener("click",async()=>{const e=parseFloat(od.value),t=sd.value.trim();if(isNaN(e)||e<=0)return void alert("璇疯緭鍏ユ湁鏁堢殑杞处閲戦銆?);if(!t)return void alert("澶囨敞涓嶈兘涓虹┖銆?);const n={sender:"user",text:`杞处锛?{e.toFixed(2)}-${t}`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};Vc(n),await Ac(n,Sc.id),Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"}),bd()});const Ed=["settingsStore","messageContacts","groupChats","worldBooks","worldBookGroups","gachaPosts","emojiStore","iconPresets","datingSetupStore","datingHistoryStore","writingStylePresets","fontUrlStore","wowoData"];async function Id(e){try{const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(t){return`${e.length}:${e.slice(0,16)}:${e.slice(-16)}`}}const xd=function(){const e=navigator.userAgent||navigator.vendor||window.opera||"";return/iPad|iPhone|iPod/.test(e)||navigator.platform&&/iP(ad|hone|od)/.test(navigator.platform)}();async function kd(e,t,n,a){if(e&&"object"==typeof e)for(const o in e){const s=e[o];if("string"==typeof s&&s.startsWith("data:image/")){console.log(`馃摳 鍙戠幇鍥剧墖瀛楁: ${o}, 闀垮害: ${s.length}`);const i=s.match(/^data:image\/(\w+);base64,/);if(!i){console.warn(`鈿狅笍  鏃犳硶瑙ｆ瀽鍥剧墖鏍煎紡: ${o}`);continue}const r=i[1];let l=s.substring(i[0].length);l=l.replace(/\s/g,"");const c=await Id(l),d=a.get(c);if(d)e[o]=`backup://images/${d}`,console.log(`鈾伙笍  鍥剧墖宸插幓閲? ${o} -> ${d}`);else{n.count++;const s=`img_${n.count}.${r}`;t.file(s,l,{base64:!0}),a.set(c,s),e[o]=`backup://images/${s}`,l=null,console.log(`鉁?鍥剧墖宸蹭繚瀛樺苟鏇挎崲: ${o} -> ${s}`)}xd&&await new Promise(e=>setTimeout(e,0))}else if("string"==typeof s&&s.trim().startsWith("url(")&&s.includes("data:image/")){const i=s.match(/^url\(["']?(data:image\/[^"']+)["']?\)$/);if(i){const s=i[1],r=s.match(/^data:image\/(\w+);base64,/);if(!r)continue;const l=r[1];let c=s.substring(r[0].length);c=c.replace(/\s/g,"");const d=await Id(c),u=a.get(d);if(u)e[o]=`url("backup://images/${u}")`;else{n.count++;const s=`img_${n.count}.${l}`;t.file(s,c,{base64:!0}),a.set(d,s),e[o]=`url("backup://images/${s}")`,c=null,console.log(`鉁?CSS鍥剧墖宸蹭繚瀛樺苟鏇挎崲: ${o} -> ${s}`)}xd&&await new Promise(e=>setTimeout(e,0))}}else"object"==typeof s&&null!==s&&await kd(s,t,n,a)}}function Ld(e,t,n,a){return new Promise((o,s)=>{const i=indexedDB.open(Kl.dbName,Kl.dbVersion);i.onsuccess=i=>{const r=i.target.result.transaction([e],"readonly").objectStore(e).openCursor(),l=[];l.push("[");let c=!0;r.onsuccess=async e=>{const s=e.target.result;if(s){c?c=!1:l.push(",");let e=s.value;try{e=JSON.parse(JSON.stringify(e)),await kd(e,t,n,a);const o=JSON.stringify(e);o.includes("backup://images/")?console.log("鉁?璁板綍宸插鐞嗭紝鍖呭惈鍗犱綅绗?):o.includes("data:image/")&&console.error("鉂?璀﹀憡锛氳褰曚腑浠嶅寘鍚玝ase64鍥剧墖锛?),l.push(o),xd&&await new Promise(e=>setTimeout(e,0))}catch(e){console.warn("澶勭悊璁板綍澶辫触",e)}s.continue()}else{l.push("]");const e=new Blob(l,{type:"application/json"});l.length=0,o(e)}},r.onerror=e=>s(e.target.error)},i.onerror=e=>s(e.target.error)})}async function Bd(e,t){if(e&&"object"==typeof e)for(const n in e){const a=e[n];try{if("string"==typeof a&&a.startsWith("backup://images/")){const o=a.replace("backup://images/",""),s=await Sd(t,o);s&&(e[n]=s,xd&&await new Promise(e=>setTimeout(e,0)))}else if("string"==typeof a&&a.startsWith('url("backup://images/')){const o=a.match(/url\("backup:\/\/images\/([^"]+)"\)/);if(o&&o[1]){const a=o[1],s=await Sd(t,a);s&&(e[n]=`url("${s}")`,xd&&await new Promise(e=>setTimeout(e,0)))}}else"object"==typeof a&&null!==a&&await Bd(a,t)}catch(e){console.warn(`鍥剧墖杩樺師澶辫触 (${n}):`,e.message)}}}async function Sd(e,t){const n=e.file(`images/${t}`)||e.file(t);if(!n)return null;const a=await n.async("base64");let o="data:image/jpeg;base64,";return t.toLowerCase().endsWith(".png")?o="data:image/png;base64,":t.toLowerCase().endsWith(".gif")?o="data:image/gif;base64,":t.toLowerCase().endsWith(".webp")&&(o="data:image/webp;base64,"),o+a}function Cd(e,t){const n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}Tr.addEventListener("click",async function(){let e=null;try{const t=new Date,n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,a=new JSZip,o=a.folder("data"),s=a.folder("images");e=document.createElement("div"),e.className="system-loader-overlay",e.innerHTML=`\n            ${h}\n            <div class="system-loader-card">\n                <div class="loader-icon-wrapper bounce-icon">馃摝</div>\n                <div class="loader-title">姝ｅ湪澶囦唤鏁版嵁</div>\n                <div class="loader-desc" id="backup-status-text">鍑嗗寮€濮?..</div>\n                <div class="progress-track">\n                    <div class="progress-fill" id="backup-progress-bar"></div>\n                </div>\n            </div>\n        `,document.body.appendChild(e);const i=document.getElementById("backup-status-text"),r=document.getElementById("backup-progress-bar");if(!i||!r)throw new Error("UI 鍒濆鍖栧け璐?);if(xd){if(!confirm("鈿狅笍 妫€娴嬪埌 iOS 璁惧锛屼负浜嗛伩鍏嶆祻瑙堝櫒宕╂簝锛屽浠藉皢鍚敤璋ㄦ厧妯″紡锛堟洿鎱絾鏇村畨鍏級銆傜户缁浠斤紵"))return void(e&&document.body.contains(e)&&document.body.removeChild(e))}console.log("馃殌 寮€濮嬪浘鐗囧幓閲嶅浠?..");const l={count:0},c=new Map;for(let e=0;e<Ed.length;e++){const t=Ed[e];i&&(i.textContent=`鎻愬彇涓? ${t}`);const n=await Ld(t,s,l,c);o.file(`${t}.json`,n);const a=Math.round((e+1)/Ed.length*50);r&&(r.style.width=`${a}%`)}c.clear();const d={themePresets:localStorage.getItem("themePresets"),bubblePresets:localStorage.getItem("bubblePresets"),meetuStyles:localStorage.getItem("meetuStyles_backup")};a.file("localStoragePresets.json",JSON.stringify(d)),console.log("鉁?宸插鍑?localStorage 棰勮锛堜富棰橀璁俱€佹皵娉￠璁撅級"),a.file("version.json",JSON.stringify({version:"3.2",type:"SevenPhoneBackup_Split_Dedupe",date:n})),i&&(i.textContent=`姝ｅ湪鎵撳寘... (鍏?${l.count} 寮犲浘鐗?`);const u=await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:xd?1:5},streamFiles:!0},e=>{const t=50+e.percent/2;i&&(i.textContent=`鍘嬬缉涓? ${e.percent.toFixed(0)}%`),r&&(r.style.width=`${t}%`)}),m=URL.createObjectURL(u),p=document.createElement("a");p.download=`phone_77_${n}.zip`,p.href=m,document.body.appendChild(p),p.click(),document.body.removeChild(p),setTimeout(()=>URL.revokeObjectURL(m),1e4),e&&document.body.contains(e)&&document.body.removeChild(e),console.log(`澶囦唤瀹屾垚锛屽幓閲嶅悗鍏卞瓨鍥?${l.count} 寮狅紝浣撶Н: ${(u.size/1024/1024).toFixed(2)} MB`)}catch(t){console.error("澶囦唤澶辫触:",t),e&&document.body.contains(e)&&document.body.removeChild(e),alert(`鉂?澶囦唤澶辫触: ${t.message}`)}}),Ar.addEventListener("click",()=>Dr.click()),Dr.addEventListener("change",async function(e){const t=e.target.files[0];if(!t)return;if(!confirm("鈿狅笍 璀﹀憡锛氬鍏ュ皢瑕嗙洊褰撳墠鎵€鏈夋暟鎹紒\n寤鸿鍏堝浠界幇鏈夋暟鎹€俓n\n纭畾瑕佺户缁悧锛?))return void(e.target.value="");const n=document.createElement("div");n.className="system-loader-overlay",n.innerHTML=`\n        ${h}\n        <div class="system-loader-card">\n            <div class="loader-icon-wrapper">\n                <div class="spinner-ios"></div>\n            </div>\n            <div class="loader-title">姝ｅ湪鎭㈠鏁版嵁</div>\n            <div class="loader-desc" id="import-status-text">瑙ｆ瀽鏂囦欢涓?..</div>\n            <div class="progress-track">\n                <div class="progress-fill" id="import-progress-bar"></div>\n            </div>\n        </div>\n    `,document.body.appendChild(n);const a=document.getElementById("import-status-text"),o=document.getElementById("import-progress-bar");try{console.log("馃搨 寮€濮嬭В鏋愬浠芥枃浠?..");const s=t.name.toLowerCase();s.endsWith(".zip");if(s.endsWith(".json")){console.log("馃搫 妫€娴嬪埌 JSON 鏍煎紡澶囦唤锛屼娇鐢ㄦ棫鐗堝鍏ラ€昏緫..."),a.textContent="姝ｅ湪璇诲彇 JSON 鏂囦欢...";const e=await t.text(),s=JSON.parse(e);let i=0;const r=Object.keys(s);for(let e=0;e<r.length;e++){const n=r[e],l=s[n];if(!Array.isArray(l)||0===l.length)continue;a.textContent=`姝ｅ湪鎭㈠: ${n}...`;const c=Math.round((e+1)/r.length*100);o&&(o.style.width=`${c}%`);try{await Kl.clearStore(n)}catch(e){console.warn(`璺宠繃娓呯┖涓嶅瓨鍦ㄧ殑琛? ${n}`);continue}let d=xd?10:50;xd&&t&&t.size&&t.size>10485760&&(d=5,a.textContent="iOS 澶ф枃浠跺鍏ワ細鍚敤瓒呬綆閫熸ā寮忥紙鏇村畨鍏ㄤ絾鏇存參锛?);for(let t=0;t<l.length;t+=d){const s=Math.min(t+d,l.length),i=l.slice(t,s),c=Math.round((e+t/l.length)/r.length*100);a.textContent=`鎭㈠ ${n}: ${t}/${l.length}`,o&&(o.style.width=`${c}%`);for(const e of i)try{void 0!==e.id&&void 0!==e.value?await Kl.saveData(n,e.id,e.value):void 0!==e.id&&await Kl.updateRecord(n,e)}catch(t){console.warn("璺宠繃鏃犳晥璁板綍:",e)}await new Promise(e=>setTimeout(e,20))}i++,console.log(`鉁?琛?${n} 鎭㈠瀹屾垚锛屽叡 ${l.length} 鏉)}return document.body.removeChild(n),alert(`馃帀 JSON 瀵煎叆鎴愬姛锛乗\n鎴愬姛鎭㈠浜?${i} 涓ā鍧楃殑鏁版嵁銆俙),void location.reload()}if(console.log("馃摝 妫€娴嬪埌 ZIP 鏍煎紡澶囦唤锛屼娇鐢ㄦ柊鐗堝鍏ラ€昏緫..."),xd&&t&&t.size&&t.size>10485760&&!confirm("鈿狅笍 妫€娴嬪埌 iOS 璁惧涓斿鍏ユ枃浠惰緝澶э紝涓洪伩鍏嶅穿婧冨皢鍚敤瓒呬綆閫熸仮澶嶆ā寮忥紙鏇存參浣嗘洿瀹夊叏锛夛紝鏄惁缁х画瀵煎叆锛?))return document.body.contains(n)&&document.body.removeChild(n),void(e.target.value="");const i=await JSZip.loadAsync(t),r=i.file("version.json");if(r){const e=JSON.parse(await r.async("string"));console.log("澶囦唤鐗堟湰淇℃伅:",e)}let l=0;for(const e of Ed){let n=i.file(`${e}.json`)||i.file(`data/${e}.json`);if(!n){console.log(`璺宠繃: ZIP涓湭鎵惧埌 ${e} 琛ㄧ殑鏁版嵁`);continue}a.textContent=`姝ｅ湪璇诲彇: ${e}...`;const s=await n.async("string");let r=[];try{r=JSON.parse(s)}catch(t){console.error(`JSON 瑙ｆ瀽澶辫触: ${e}`,t);continue}if(r&&Array.isArray(r)&&r.length>0){a.textContent=`姝ｅ湪娓呯┖鏃ф暟鎹? ${e}...`,await Kl.clearStore(e);let n=xd?10:50;xd&&t&&t.size&&t.size>10485760&&(n=5,a.textContent="iOS 澶ф枃浠跺鍏ワ細鍚敤瓒呬綆閫熸ā寮忥紙鏇村畨鍏ㄤ絾鏇存參锛?);const s=Cd(r,n),c=r.length;for(let r=0;r<s.length;r++){const l=s[r],d=Math.round(r*n/c*100);a.textContent=`鎭㈠ ${e}: ${d}% (${r*n}/${c})`,o&&(o.style.width=`${d}%`);const u=xd?5:10,m=xd&&t&&t.size&&t.size>10485760?10:0;for(let e=0;e<l.length;e++)await Bd(l[e],i),e%u===0&&e>0&&await new Promise(e=>setTimeout(e,m));const p=l.map(t=>"emojiStore"===e?Kl.updateRecord(e,t):void 0!==t.id&&void 0!==t.value?Kl.saveData(e,t.id,t.value):void 0!==t.id?Kl.updateRecord(e,t):Promise.resolve());await Promise.all(p),l.forEach((e,t)=>{l[t]=null}),await new Promise(e=>setTimeout(e,50))}l++,console.log(`鉁?琛?${e} 鎭㈠瀹屾垚锛屽叡 ${c} 鏉),r=null}}a.textContent="姝ｅ湪瀹屾垚...";const c=i.file("localStoragePresets.json");if(c)try{const e=await c.async("string"),t=JSON.parse(e);t.themePresets&&(localStorage.setItem("themePresets",t.themePresets),console.log("鉁?宸叉仮澶嶄富棰橀璁?)),t.bubblePresets&&(localStorage.setItem("bubblePresets",t.bubblePresets),console.log("鉁?宸叉仮澶嶆皵娉￠璁?)),t.meetuStyles&&(localStorage.setItem("meetuStyles_backup",t.meetuStyles),console.log("鉁?宸叉仮澶嶇瑪椋庨璁?(LocalStorage)"))}catch(e){console.warn("localStorage 棰勮鎭㈠澶辫触:",e)}"function"==typeof runDiagnosticCheck&&await runDiagnosticCheck(),document.body.removeChild(n),alert(`馃帀 瀵煎叆鎴愬姛锛乗n鎴愬姛鎭㈠浜?${l} 涓ā鍧楃殑鏁版嵁銆俙),location.reload()}catch(e){console.error("瀵煎叆杩囩▼涓嚭閿?",e),document.body.contains(n)&&document.body.removeChild(n),alert(`鉂?瀵煎叆澶辫触: ${e.message}`)}finally{e.target.value=""}}),yl.addEventListener("click",async()=>{if(!uc)return;const e=prompt("璇疯緭鍏ユ柊鐨勬瓕鍗曞悕绉帮細",uc);if(null===e||""===e.trim())return;const t=e.trim();if(t!==uc)try{const e=await Kl.loadData("musicPlaylists","allPlaylists");if(!e||"object"!=typeof e.value)throw new Error("鏃犳硶鍔犺浇姝屽崟鏁版嵁搴撱€?);let n=e.value;if(n[t])return void alert("閿欒锛氳姝屽崟鍚嶇О宸插瓨鍦紒");n[t]=n[uc],delete n[uc],await Kl.saveData("musicPlaylists","allPlaylists",n),await cc();const a=document.getElementById("playlist-name-title");a&&(a.textContent=t),uc=t,alert("姝屽崟鍚嶇О宸叉洿鏂帮紒")}catch(e){console.error("缂栬緫姝屽崟鍚嶇О澶辫触:",e),alert(`缂栬緫澶辫触: ${e.message}`)}}),Ci.addEventListener("click",()=>{$i=!$i,il.classList.toggle("delete-mode",$i);Ci.querySelector(".icon-select");const e=document.getElementById("add-playlist-btn");$i?(Ci.style.color="#007AFF",e.textContent="鍒犻櫎鎵€閫夋瓕鍗?,e.classList.add("delete-mode-btn"),e.style.backgroundColor="rgba(255, 59, 48, 0.15)",e.style.color="#FF3B30",e.style.borderColor="rgba(255, 59, 48, 0.3)"):(Ci.style.color="",e.textContent="鏂板缓姝屽崟",e.classList.remove("delete-mode-btn"),e.style.backgroundColor="",e.style.color="",e.style.borderColor="",il.querySelectorAll(".playlist-checkbox").forEach(e=>e.checked=!1))}),sl.addEventListener("click",()=>{$i?async function(){const e=il.querySelectorAll(".playlist-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€涓鍒犻櫎鐨勬瓕鍗曘€?);if(!confirm(`纭畾瑕佸垹闄ら€変腑鐨?${e.length} 涓瓕鍗曞悧锛熸鎿嶄綔鏃犳硶鎾ら攢銆俙))return;const t=new Set;e.forEach(e=>{const n=e.closest(".playlist-card");t.add(n.dataset.playlistName)});try{let e=(await Kl.loadData("musicPlaylists","allPlaylists")).value;t.forEach(t=>{delete e[t]}),await Kl.saveData("musicPlaylists","allPlaylists",e),await cc(),Ci.click()}catch(e){console.error("鍒犻櫎姝屽崟澶辫触:",e),alert("鍒犻櫎澶辫触")}}():async function(){const e=prompt("璇疯緭鍏ユ柊鐨勬瓕鍗曞悕绉帮細");if(e&&""!==e.trim()){const t=e.trim();try{const e=await Kl.loadData("musicPlaylists","allPlaylists");let n=e&&"object"==typeof e.value?e.value:{};if(n[t])return void alert("姝屽崟鍚嶇О宸插瓨鍦紒");n[t]={songs:[],coverUrl:null},await Kl.saveData("musicPlaylists","allPlaylists",n),lc(t,n[t])}catch(e){console.error("淇濆瓨姝屽崟澶辫触:",e)}}}()});const $d="sans-serif";function Md(e){if(Pr.innerHTML="",Pr.offsetHeight,Ii.style.fontFamily="",e){const t=`CustomGlobalFont_${Date.now()}`,n=`#t=${Date.now()}`,a=`\n            @font-face {\n                font-family: '${t}';\n                src: url(${e+n});\n                font-display: swap; /* 娣诲姞瀛椾綋鏄剧ず绛栫暐 */\n            }\n        `;Pr.innerHTML=a,Pr.offsetHeight,setTimeout(()=>{Ii.style.fontFamily=`'${t}', ${$d}`,console.log(`鉁?瀛椾綋宸插簲鐢? ${t}`)},50)}else Ii.style.fontFamily=$d,console.log("鉁?宸叉仮澶嶉粯璁ゅ瓧浣?)}navigator.serviceWorker.addEventListener("message",e=>{const t=e.data;"OPEN_CHAT"===t.type&&t.contactId&&(console.log(`鏀跺埌鏉ヨ嚜 Service Worker 鐨勬寚浠わ紝姝ｅ湪鎵撳紑鑱旂郴浜篒D: ${t.contactId} 鐨勮亰澶┿€俙),Nc(t.contactId))}),Hr.addEventListener("change",async e=>{const t=e.target.files[0];if(t){e.target.value="";try{if(window.iOSBabyMode&&window.iOSBabyMode.shouldRecommendURL(t,"font")){if(!confirm(`馃嵓 iOS瀹濆疂妯″紡鎻愮ず\n\n妫€娴嬪埌瀛椾綋鏂囦欢杈冨ぇ (${(t.size/1024/1024).toFixed(1)}MB)锛屽湪iOS涓婄洿鎺ュ鍏ュ彲鑳藉鑷存祻瑙堝櫒宕╂簝銆俓n\n馃搸 鎺ㄨ崘鏂规锛歕n鈥?灏嗗瓧浣撲笂浼犲埌缃戠洏/鍥惧簥\n鈥?浣跨敤銆岀編鍖?鈫?瀛椾綋URL銆嶅姛鑳藉姞杞絓n\n鐐瑰嚮銆岀‘瀹氥€嶇户缁皾璇曞鍏ワ紙浼氬垎鍧楀鐞嗭級\n鐐瑰嚮銆屽彇娑堛€嶆斁寮冨鍏))return}let e;window.iOSBabyMode&&window.iOSBabyMode.enabled&&window.iOSBabyMode.showProgressToast("姝ｅ湪璇诲彇瀛椾綋...",0),e=window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t,e=>{window.iOSBabyMode.showProgressToast("姝ｅ湪璇诲彇瀛椾綋...",e)}):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),window.iOSBabyMode&&window.iOSBabyMode.enabled&&(window.iOSBabyMode.showProgressToast("姝ｅ湪淇濆瓨瀛椾綋...",null),await new Promise(e=>setTimeout(e,100))),await Kl.saveData("settingsStore","customFont",e),window.iOSBabyMode&&window.iOSBabyMode.enabled&&await new Promise(e=>setTimeout(e,50)),Md(e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert("鉁?瀛椾綋宸叉垚鍔熷簲鐢紒")}catch(e){console.error("淇濆瓨鎴栧簲鐢ㄥ瓧浣撳け璐?",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?瀛椾綋搴旂敤澶辫触\n\n${e.message||"璇峰皾璇曚娇鐢ㄥ瓧浣揢RL鍔熻兘"}`)}}});const Td=document.getElementById("chat-search-button"),Ad=document.getElementById("search-modal"),Dd=document.getElementById("search-modal-close-btn"),Pd=document.getElementById("search-input"),Hd=document.getElementById("search-results-container");let Od;function qd(){Pd.blur(),Ad.style.opacity="0",Ad.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Ad.style.display="none",Pd.value="",Hd.innerHTML=""},300)}function Nd(e,t,n){0!==e.length?Hd.innerHTML=e.map(e=>{const a=new Date(e.message.timestamp),o=`${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`,s=function(e,t,n=3){const a=e.replace(/(\r\n|\n|\r)/gm," "),o=a.toLowerCase().indexOf(t.toLowerCase());if(-1===o)return a.substring(0,2*n+t.length)+"...";const s=Math.max(0,o-n),i=Math.min(a.length,o+t.length+n);let r=a.substring(s,i);return s>0&&(r="..."+r),i<a.length&&(r+="..."),r}(e.message.text||(e.message.content?e.message.content.html:"")||e.message.transcript||"[澶氬獟浣揮",t),i=s.replace(n,'<span class="highlight">$&</span>');return`\n    <div class="search-result-item" ${e.isGroup?`data-group-id="${e.contextId}"`:`data-contact-id="${e.contextId}"`} data-uuid="${e.message.uuid}">\n        <div class="result-header">\n            <div class="sender-name">${e.senderName}:</div>\n            <div class="time">${o}</div>\n        </div>\n        <div class="chatsearch-content">${i}</div>\n    </div>\n`}).join(""):Hd.innerHTML='<p style="text-align:center; color:#888;">鏈壘鍒扮浉鍏宠褰?/p>'}async function Fd(e,t,n=!1){qd(),n?await Fm(e):await Nc(e,{targetMessageUuid:t}),setTimeout(()=>{const e=Xi.querySelector(`.message-row[data-uuid="${t}"]`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("message-highlight"),setTimeout(()=>e.classList.remove("message-highlight"),1500))},500),xo.blur()}Td.addEventListener("click",function(){Ad.style.display="flex",setTimeout(()=>{Ad.style.opacity="1",Ad.querySelector(".modal-content").style.transform="scale(1)",Pd.focus()},10)}),Dd.addEventListener("click",qd),Pd.addEventListener("input",()=>{clearTimeout(Od),Od=setTimeout(()=>{!async function(e){if(!e||e.length<1)return void(Hd.innerHTML="");let t=[],n=null,a=!1;if(Je)t=Array.isArray(Je.history)?Je.history:[],n=Je.id,a=!0;else{if(!Sc)return;t=Array.isArray(Sc.history)?Sc.history:[],n=Sc.id,a=!1}const o=[];for(const s of t){const t=s.text||s.content&&s.content.html||s.transcript||"";if(s.uuid&&"string"==typeof t&&t.toLowerCase().includes(e.toLowerCase())){let e="鏈煡";e=a?"user"===s.sender?Je.userCardName||"鎴?:s.senderName||"缇ゅ弸":"user"===s.sender?Sc.user.name:Sc.ai.name,o.push({message:s,senderName:e,contextId:n,isGroup:a})}}const s=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"gi");Nd(o,e,s)}(Pd.value.trim())},300)}),Hd.addEventListener("click",e=>{const t=e.target.closest(".search-result-item");if(t){e.preventDefault(),e.stopPropagation();const n=document.getElementById("click-shield");n.style.display="block";const a=t.dataset.uuid,o=t.dataset.contactId?parseInt(t.dataset.contactId,10):null,s=t.dataset.groupId?parseInt(t.dataset.groupId,10):null;qd(),s?Fd(s,a,!0):o&&Fd(o,a,!1),setTimeout(()=>{n.style.display="none"},400)}});const _d=document.getElementById("island-invite-button"),Rd=document.getElementById("invite-modal"),Gd=document.getElementById("invite-modal-close-btn"),Wd=document.getElementById("invite-contact-list-container");function jd(){Rd.style.display="flex",async function(){Wd.innerHTML='<p style="text-align:center; color:#888;">姝ｅ湪鍔犺浇鑱旂郴浜?..</p>';try{const e=await Kl.loadData("messageContacts","allContacts");e&&Array.isArray(e.value)&&e.value.length>0?(Wd.innerHTML="",e.value.forEach(e=>{const t=document.createElement("div");t.className="invite-contact-item",t.innerHTML=`\n                    <img src="${e.ai.avatar}" alt="avatar" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.ai.name}</span>\n                    <button class="invite-button" data-contact-id="${e.id}">閭€璇?/button>\n                `,Wd.appendChild(t)})):Wd.innerHTML='<p style="text-align:center; color:#888;">浣犺繕娌℃湁浠讳綍鑱旂郴浜恒€?/p>'}catch(e){console.error("鍔犺浇鑱旂郴浜哄垪琛ㄥけ璐?",e),Wd.innerHTML='<p style="text-align:center; color:red;">鍔犺浇澶辫触锛岃閲嶈瘯銆?/p>'}}(),setTimeout(()=>{Rd.style.opacity="1",Rd.querySelector(".modal-content").style.transform="scale(1)"},10)}function Ud(){Rd.style.opacity="0",Rd.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Rd.style.display="none"},300)}_d.addEventListener("click",e=>{e.stopPropagation(),jd()}),Gd.addEventListener("click",Ud),Rd.addEventListener("click",e=>{e.target===Rd&&Ud()}),Wd.addEventListener("click",async e=>{if(e.target.classList.contains("invite-button")&&!e.target.disabled){if(!ec.currentSong)return void alert("璇峰厛鎾斁涓€棣栨瓕鏇插啀閭€璇凤紒");const t=e.target,n=parseInt(t.dataset.contactId,10);t.textContent="宸查個璇?,t.disabled=!0,t.classList.add("invited");try{const e=ec.currentSong.title,t=ec.currentSong.artist,a={sender:"user",text:`[MUSIC_SHARE]瀵规柟閭€璇蜂綘鏀跺惉-${e}-${t}[MUSIC_SHARE]`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};Sc&&Sc.id===n&&Vc(a);let o=(await Kl.loadData("messageContacts","allContacts")).value||[];const s=o.findIndex(e=>e.id===n);if(!(s>-1))throw new Error("鍦ㄦ暟鎹簱涓壘涓嶅埌鐩爣鑱旂郴浜恒€?);{const n=o[s];Array.isArray(n.history)||(n.history=[]),n.history.push(a),n.lastMessage="鍒嗕韩浜嗕竴璧峰惉閭€璇?,await Kl.saveData("messageContacts","allContacts",o),Ud();const i=`(鎴戠粰浣犲垎浜簡涓€璧峰惉鐨勯個璇凤紝姝屾洸鏄€?{e}銆?- ${t}锛岃鏍规嵁鎴戜滑鐨勮亰澶╄褰曞拰浣犵殑浜鸿锛岃嚜鐒跺湴鍐冲畾鏄惁鎺ュ彈銆?`;await Tc(i,n)}}catch(e){console.error("鍙戦€侀個璇峰崱鐗囧け璐?",e),alert("鍙戦€侀個璇峰け璐?),t.textContent="閭€璇?,t.disabled=!1,t.classList.remove("invited")}}});let zd={active:!1,contact:null};const Vd=document.getElementById("shared-listening-avatars"),Jd=document.getElementById("avatar-image-container");function Yd(){if(zd.active&&zd.contact){const e=zd.contact.user.avatar,t=zd.contact.ai.avatar;Jd.innerHTML=`\n            <img src="${e}" class="shared-avatar-img" title="${zd.contact.user.name}">\n            <img src="${t}" class="shared-avatar-img" title="${zd.contact.ai.name}">\n        `,Vd.classList.add("active")}else Jd.innerHTML="",Vd.classList.remove("active")}const Kd=document.getElementById("end-session-bubble"),Zd=document.getElementById("end-listening-session-btn");async function Xd(e,t){if(!t)return;const n={sender:"system",type:"system",text:e,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(n,t),Sc&&Sc.id===t&&(Vc(n),Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"}))}function Qd(){vl.style.opacity="0",vl.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{vl.style.display="none",bl.value=""},300)}async function eu(){try{let e=await Kl.getAllDataFromStore("emojiStore");e&&Array.isArray(e)&&e.sort((e,t)=>(t.timestamp||0)-(e.timestamp||0)),El.innerHTML="",e&&e.length>0?e.forEach(e=>{const t=document.createElement("div");t.className="emoji-item-container",t.innerHTML=`\n                    <input type="checkbox" class="emoji-checkbox" value="${e.url}">\n                    <img src="${e.url}" class="emoji-item" title="鐐瑰嚮鍙戦€? data-url="${e.url}">\n                    <p class="emoji-remark" contenteditable="true">${e.remark}</p>\n                `;t.querySelector(".emoji-remark").addEventListener("blur",async e=>{const n=e.target.textContent.trim(),a=t.querySelector(".emoji-item").dataset.url;if(n)try{await Kl.updateRecord("emojiStore",{url:a,remark:n})}catch(e){console.error("鏇存柊澶囨敞澶辫触:",e)}else e.target.textContent="鐐瑰嚮淇敼澶囨敞"}),El.appendChild(t)}):El.innerHTML='<p style="color:#aaa; font-size:14px; text-align:center; grid-column: 1 / -1;">蹇潵娣诲姞琛ㄦ儏鍖呭寘鍚э紒</p>'}catch(e){console.error("鍔犺浇琛ㄦ儏澶辫触:",e)}}async function tu(){if(wo)return await new Promise(e=>setTimeout(e,100)),tu();wo=!0;try{if(!Sc)return;let e=Ye;if(!e){const t=await Kl.loadData("messageContacts","allContacts");e=t&&Array.isArray(t.value)?t.value:[],Ye=e}const t=e.findIndex(e=>e.id===Sc.id);if(t>-1?e[t]=JSON.parse(JSON.stringify(Sc)):e.push(JSON.parse(JSON.stringify(Sc))),await Kl.saveData("messageContacts","allContacts",e),window.LittleWorld&&Sc)try{const e=await Kl.loadData("settingsStore",`littleWorld_${Sc.id}`);if(e&&e.value){const t=e.value,n=Sc.history?Sc.history.length:0,a=Math.max(0,n-t.baseCount);a>t.incrementCount&&(t.incrementCount=a,await Kl.saveData("settingsStore",`littleWorld_${Sc.id}`,t),setTimeout(async()=>{try{await window.LittleWorld.backgroundCheck(Sc,t)}catch(e){console.warn("[LittleWorld] 鍚庡彴妫€鏌ュけ璐?",e)}},100))}}catch(e){console.warn("[LittleWorld] 鍚庡彴閽╁瓙寮傚父:",e)}}catch(e){console.error("Master save function failed:",e)}finally{wo=!1}}async function nu(){const e=await Kl.loadData("settingsStore","customAppIcons");if(e&&e.value){const t=e.value;for(const e in t){const n=t[e],a=document.querySelector(`#${e} .app-icon img`);a&&n&&(a.src=n)}}}function au(e){pi.forEach(t=>{t.style.color=e})}async function ou(){const e=await Kl.loadData("settingsStore","clockColor");if(e&&e.value){const t=e.value;au(t),ui.value=t,mi.value=t}}function su(e){e?li.classList.add("clock-blur-enabled"):li.classList.remove("clock-blur-enabled")}async function iu(){const e=await Kl.loadData("settingsStore","clockBlurEffect"),t=!!e&&e.value;ri.checked=t,su(t)}Vd.addEventListener("click",e=>{zd.active&&(e.target.closest("#end-listening-session-btn")||Kd.classList.toggle("active"))}),Zd.addEventListener("click",async e=>{e.stopPropagation(),Kd.classList.remove("active");try{await Xd("宸茬粡缁撴潫涓€璧峰惉",zd.contact.id),await Tc("(鎴戝凡缁忕粨鏉熶簡涓€璧峰惉妯″紡锛屾垜浠户缁亰鍚?",zd.contact)}catch(e){console.error("鍦ㄧ粨鏉熲€滀竴璧峰惉鈥濆苟閫氱煡AI鏃跺彂鐢熼敊璇?",e)}finally{zd.active=!1,zd.contact=null,Yd()}}),document.addEventListener("click",e=>{Kd.classList.contains("active")&&!Vd.contains(e.target)&&Kd.classList.remove("active")},!0),hl.addEventListener("click",()=>{wi?async function(){const e=El.querySelectorAll(".emoji-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€涓鍒犻櫎鐨勮〃鎯呫€?);if(!confirm(`纭畾瑕佸垹闄ら€変腑鐨?${e.length} 涓〃鎯呭悧锛焋))return;try{let t=0;for(const n of e){const e=n.value;await Kl.deleteData("emojiStore",e),t++}alert(`鎴愬姛鍒犻櫎浜?${t} 涓〃鎯咃紒`),await eu(),fi.click()}catch(e){console.error("鍒犻櫎琛ㄦ儏澶辫触:",e),alert("鍒犻櫎澶辫触")}}():function(){const e=document.getElementById("emoji-urls-textarea");e&&(e.value=""),vl.style.display="flex",setTimeout(()=>{vl.style.opacity="1",vl.querySelector(".modal-content").style.transform="scale(1)"},10)}()}),fl.addEventListener("click",Qd),wl.addEventListener("click",async function(){const e=document.getElementById("emoji-urls-textarea").value.trim();if(!e)return void alert("璇疯緭鍏ヨ〃鎯呭寘鏁版嵁锛?);const t=e.match(/\[.*?:\s*.*?\]/g);if(!t||0===t.length)return void alert("鏈壘鍒版湁鏁堟牸寮忕殑鏁版嵁銆俓n\n璇风‘淇濅娇鐢ㄦ牸寮? [澶囨敞1:url1],[澶囨敞2:url2]");const n=[];for(const e of t)try{const t=e.slice(1,-1),a=t.indexOf(":");if(-1===a){console.warn(`鏍煎紡閿欒锛岃烦杩囨鏉＄洰 (缂哄皯鍐掑彿): ${e}`);continue}const o=t.substring(0,a).trim(),s=t.substring(a+1).trim();o&&s.startsWith("http")?n.push({url:s,remark:o}):console.warn(`鏍煎紡閿欒锛岃烦杩囨鏉＄洰 (澶囨敞涓虹┖鎴朥RL鏃犳晥): ${e}`)}catch(t){console.error(`瑙ｆ瀽鏉＄洰鏃跺嚭閿? ${e}`,t)}if(0!==n.length)try{let e=0;for(const t of n){const n={url:t.url,remark:t.remark,timestamp:Date.now()};await Kl.updateRecord("emojiStore",n),e++}alert(`鎴愬姛澶勭悊浜?${t.length} 鏉℃暟鎹紝鏈夋晥娣诲姞/鏇存柊浜?${e} 涓〃鎯咃紒`),Qd(),eu()}catch(e){console.error("淇濆瓨琛ㄦ儏澶辫触:",e),alert("娣诲姞澶辫触锛岃妫€鏌RL鏍煎紡鎴栨暟鎹簱銆?)}else alert("瑙ｆ瀽鍚庢湭鍙戠幇鏈夋晥鐨勮〃鎯呭寘鏁版嵁锛岃妫€鏌ユ偍鐨勬牸寮忋€?)}),vl.addEventListener("click",e=>{e.target===vl&&Qd()}),fi.addEventListener("click",()=>{wi=!wi,El.classList.toggle("delete-mode",wi),wi?(fi.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <line x1="18" y1="6" x2="6" y2="18"></line>\n            <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>\n    ',hl.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="3 6 5 6 21 6"></polyline>\n            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n        </svg>\n    '):(fi.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="6 9 12 15 18 9"></polyline>\n        </svg>\n    ',hl.innerHTML='\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <line x1="12" y1="5" x2="12" y2="19"></line>\n            <line x1="5" y1="12" x2="19" y2="12"></line>\n        </svg>\n    ',El.querySelectorAll(".emoji-checkbox").forEach(e=>e.checked=!1))}),Il.addEventListener("change",async e=>{if(e.target.classList.contains("icon-url-input")){const t=e.target,n=t.dataset.appId,a=t.value.trim();await async function(e,t){const n=document.querySelector(`#${e} .app-icon img`),a=document.querySelector(`.icon-preview[data-app-id="${e}"]`);if(!n||!a)return;let o;o=t||n.dataset.defaultSrc;n.src=o,a.src=o;try{const n=await Kl.loadData("settingsStore","customAppIcons");let a=n&&n.value?n.value:{};t?a[e]=t:delete a[e],await Kl.saveData("settingsStore","customAppIcons",a)}catch(e){console.error("淇濆瓨鑷畾涔夊浘鏍囧け璐?",e)}}(n,a)}}),ui.addEventListener("input",e=>{const t=e.target.value;mi.value=t,au(t),Kl.saveData("settingsStore","clockColor",t)}),mi.addEventListener("input",e=>{const t=e.target.value;ui.value=t,au(t),Kl.saveData("settingsStore","clockColor",t)}),ri.addEventListener("change",async()=>{const e=ri.checked;su(e),await Kl.saveData("settingsStore","clockBlurEffect",e)});const ru=document.getElementById("scroll-to-bottom-btn");let lu=!1;function cu(e){e&&e.user&&(ei=e.user,ni.src=ei.avatar,console.log(`褰撳墠璐墿韬唤宸插垏鎹负: ${ei.name}`))}async function du(){si.innerHTML='<p style="text-align:center; color:#888;">姝ｅ湪鍔犺浇...</p>';try{const e=await Kl.loadData("messageContacts","allContacts");e&&Array.isArray(e.value)&&e.value.length>0?(si.innerHTML="",e.value.forEach(e=>{const t=e.user,n=document.createElement("div");n.className="invite-contact-item",n.style.cursor="pointer",n.dataset.contactId=e.id,n.innerHTML=`\n                    <img src="${t.avatar}" alt="avatar" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${t.name}</span>\n                `,si.appendChild(n)})):si.innerHTML='<p style="text-align:center; color:#888;">娌℃湁鍙敤鐨勭敤鎴疯韩浠?/p>'}catch(e){console.error("鍔犺浇鐢ㄦ埛鍒楄〃澶辫触:",e),si.innerHTML='<p style="text-align:center; color:red;">鍔犺浇澶辫触</p>'}ai.style.display="flex",setTimeout(()=>{ai.style.opacity="1",ai.querySelector(".modal-content").style.transform="scale(1)"},10)}function uu(){ai.style.opacity="0",ai.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{ai.style.display="none"},300)}Xi.addEventListener("scroll",()=>{lu||(window.requestAnimationFrame(()=>{const e=document.getElementById("chat-screen");if(e&&(e.classList.contains("features-panel-active")||e.classList.contains("emoji-panel-active")))return ru.classList.remove("visible"),void(lu=!1);Xi.scrollHeight-Xi.scrollTop-Xi.clientHeight>300?ru.classList.add("visible"):ru.classList.remove("visible"),lu=!1}),lu=!0)},{passive:!0}),ru.addEventListener("click",()=>{Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"})}),xo&&Xi&&(window.visualViewport?window.visualViewport.addEventListener("resize",()=>{document.activeElement===xo&&Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"})}):xo.addEventListener("focus",()=>{setTimeout(()=>{Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"})},300)})),ti.addEventListener("click",du),oi&&oi.addEventListener("click",()=>{window.DOMCleanupManager.clean("shopper-list-container")}),si.addEventListener("click",async e=>{const t=e.target.closest(".invite-contact-item");if(t){const e=parseInt(t.dataset.contactId,10),n=(await Kl.loadData("messageContacts","allContacts")).value.find(t=>t.id===e);n&&(cu(n),uu())}});const mu={takeout:[{name:"璞崕鐗涜倝姹夊牎",description:"绮鹃€夊畨鏍兼柉鐗涜倝锛屾惌閰嶆柊椴滅敓鑿滃拰绉樺埗閰辨枡锛屽姹佺編鍛炽€?,price:28.5},{name:"鏃ュ紡璞氶鎷夐潰",description:"娴撻儊鐚姹ゅ簳锛岄厤涓婃簭蹇冭泲鍜屽弶鐑э紝娓╂殩浣犵殑鑳冦€?,price:35},{name:"楹昏荆灏忛緳铏?,description:"澶忔棩蹇呭锛岄矞娲诲皬榫欒櫨閰嶄互鐙楹昏荆璋冩枡锛岄杈ｈ繃鐦俱€?,price:88},{name:"姘存灉缂ょ悍娌欐媺",description:"澶氱鏂伴矞鏃朵护姘存灉锛屼綆鍗″仴搴凤紝鏄交椋熶富涔夎€呯殑鏈€鐖便€?,price:22},{name:"鎰忓紡鐣寗鑲夐叡闈?,description:"缁忓吀鎰忓紡椋庡懗锛屾參鐐栫暘鑼勮倝閰辨惌閰嶇瓔閬撴剰闈紝鍥炲懗鏃犵┓銆?,price:32},{name:"濂ュ皵鑹儰楦＄繀",description:"绉樺埗濂ュ皵鑹叡鏂欒厡鍒讹紝澶栫劍閲屽锛岄姘斿洓婧€?,price:26},{name:"娴烽矞鎶惃",description:"钖勮剢楗煎簳锛岄摵婊¤櫨浠併€侀笨楸煎拰鑺濆＋锛屾捣椴滅埍濂借€呴閫夈€?,price:58},{name:"瀹繚楦′竵楗?,description:"椴滃楦′竵鎼厤鑺辩敓鍜岃荆妞掞紝楹昏荆椴滈锛屼笅楗鍣ㄣ€?,price:25},{name:"闊╁紡閮ㄩ槦鐏攨",description:"鑺濆＋骞寸硶銆佸崍椁愯倝鍜屾场鑿滅殑瀹岀編铻嶅悎锛岄煩寮忛鍛冲崄瓒炽€?,price:68},{name:"娉板紡鍐槾鍔熸堡",description:"閰歌荆寮€鑳冿紝澶ц櫨銆佽槕鑿囩瓑椋熸潗涓板瘜锛屽紓鍥介鍛虫祿閮併€?,price:42},{name:"棣欑厧涓夋枃楸煎椁?,description:"鎸▉涓夋枃楸肩厧鑷抽噾榛勶紝鎼厤鏃惰敩鍜屽湡璞嗘偿锛岃惀鍏诲潎琛°€?,price:78},{name:"鍏板窞鐗涜倝鎷夐潰",description:"涓€娓呬簩鐧戒笁绾㈠洓缁匡紝浼犵粺宸ヨ壓鍒朵綔锛屾堡椴滃懗缇庛€?,price:28},{name:"澧ㄨタ鍝ラ浮鑲夊嵎",description:"瀚╃厧楦¤倝閰嶄互鑾庤帋閰卞拰钄彍锛屽嵎鍦ㄨ杽楗间腑锛岄鍛崇嫭鐗广€?,price:30},{name:"鎷涚墝绾㈢儳鑲?,description:"绮鹃€変簲鑺辫倝锛屾參鐏倴鑷抽叆鐑傦紝鑲ヨ€屼笉鑵伙紝鍏ュ彛鍗冲寲銆?,price:45},{name:"椴滆櫨浜戝悶闈?,description:"鎵嬪伐浜戝悶鍖呰９澶ч铏句粊锛屾惌閰嶇鍗囬潰锛屾堡娓呭懗椴溿€?,price:36},{name:"娉曞紡棣欑厧楣呰倽",description:"杩涘彛楣呰倽鐓庤嚦涓ら潰閲戦粍锛屾惌閰嶆棤鑺辨灉閰憋紝濂㈠崕浜彈銆?,price:98},{name:"鍜栧柋鐗涜倝楗?,description:"娴撻儊鍜栧柋姹佸寘瑁归矞瀚╃墰鑲夊拰鍦熻眴锛屾媽楗粷浣炽€?,price:32},{name:"瓒婂崡鐗涜倝娌崇矇",description:"娓呯埥鐗涢姹ゅ簳锛岄矞瀚╃墰鑲夌墖锛屾惌閰嶉鑽夛紝娓呮柊鐖藉彛銆?,price:38},{name:"榛戞澗闇茶槕鑿囨剰闈?,description:"榛戞澗闇蹭笌铇戣弴鐨勯矞棣欒瀺鍚堬紝鍙ｆ劅涓板瘜锛岄姘旂嫭鐗广€?,price:56},{name:"婊嬭ˉ涔岄浮姹?,description:"鑰佺伀鎱㈢倴涔岄浮姹わ紝鍔犲叆鍏氬弬銆佹灨鏉烇紝婊嬭ˉ鍏荤敓銆?,price:48}],electronics:[{name:"瓒呴潤闊虫満姊伴敭鐩?,description:"閲囩敤鑼惰酱璁捐锛屾棦鏈夋钀芥劅鍙堜繚鎸佸畨闈欙紝鍔炲叕娓告垙涓ょ浉瀹溿€?,price:399},{name:"楂樻竻闄嶅櫔鑰虫満",description:"涓诲姩闄嶅櫔鎶€鏈紝璁╀綘鍦ㄥ槇鏉傜幆澧冧腑涔熻兘浜彈绾噣闊充箰銆?,price:799},{name:"渚挎惡寮忓厖鐢靛疂",description:"20000mAh澶у閲忥紝鏀寔蹇厖锛屽憡鍒數閲忕劍铏戙€?,price:129},{name:"鏅鸿兘杩愬姩鎵嬬幆",description:"瀹炴椂鐩戞祴蹇冪巼銆佹鏁板拰鐫＄湢锛屼綘鐨勮厱涓婂仴搴风瀹躲€?,price:199},{name:"4K瓒呴珮娓呮樉绀哄櫒",description:"27鑻卞澶у睆锛?K鍒嗚鲸鐜囷紝鑹插僵绮惧噯锛岄€傚悎璁捐鍜岃褰便€?,price:1499},{name:"鏃犵嚎钃濈墮鑰虫満",description:"鍗婂叆鑰冲紡璁捐锛屼僵鎴磋垝閫傦紝缁埅闀胯揪24灏忔椂銆?,price:299},{name:"瓒呰杽绗旇鏈數鑴?,description:"14鑻卞鍏ㄩ潰灞忥紝杞昏杽渚挎惡锛屾€ц兘寮哄姴锛屽姙鍏閫夈€?,price:5999},{name:"鏅鸿兘鎵嬭〃",description:"鏀寔閫氳瘽銆佹敮浠樺拰澶氱杩愬姩妯″紡锛屽姛鑳藉叏闈€?,price:1599},{name:"楂樻竻鎽勫儚澶?,description:"1080P鍒嗚鲸鐜囷紝鑷姩瀵圭劍锛岃棰戦€氳瘽娓呮櫚娴佺晠銆?,price:199},{name:"娓告垙鎵嬫焺",description:"閫傞厤澶氬钩鍙帮紝鎵嬫劅鑸掗€傦紝鎸夐敭鐏垫晱锛屾父鎴忎綋楠屽崌绾с€?,price:299},{name:"杩蜂綘鎶曞奖浠?,description:"渚挎惡璁捐锛屾敮鎸?080P鎶曞奖锛屾墦閫犵浜哄奖闄€?,price:2499},{name:"鏅鸿兘闊崇",description:"璇煶鎺у埗锛屾櫤鑳藉灞呬腑鎺э紝闊宠川鍑鸿壊銆?,price:399},{name:"绉诲姩纭洏",description:"2TB澶у閲忥紝楂橀€熶紶杈擄紝鏁版嵁瀛樺偍瀹夊叏鍙潬銆?,price:599},{name:"姘寲闀撳厖鐢靛櫒",description:"65W澶у姛鐜囷紝灏忓阀渚挎惡锛屽璁惧鍏煎銆?,price:149},{name:"钃濈墮闊崇",description:"闃叉按璁捐锛?60掳鐜粫闊虫晥锛屾埛澶栬仛浼氬繀澶囥€?,price:499},{name:"鏈烘榧犳爣",description:"楂樼簿搴︿紶鎰熷櫒锛岃嚜瀹氫箟鎸夐敭锛屾父鎴忓姙鍏殕瀹溿€?,price:249},{name:"VR鐪奸暅",description:"娌夋蹈寮忎綋楠岋紝鏀寔澶氱VR娓告垙鍜屽奖瑙嗗唴瀹广€?,price:1999},{name:"琛岃溅璁板綍浠?,description:"4K楂樻竻澶滆锛屽仠杞︾洃鎺э紝淇濋殰琛岃溅瀹夊叏銆?,price:399},{name:"鏃犵嚎鍏呯數鍣?,description:"15W蹇厖锛屾敮鎸佸璁惧鍏煎锛屾闈㈡暣娲佺鍣ㄣ€?,price:89},{name:"鏅鸿兘闂ㄩ攣",description:"鎸囩汗璇嗗埆锛屾墜鏈鸿繙绋嬫帶鍒讹紝瀹夊叏渚挎嵎銆?,price:1299}],daily:[{name:"杩涘彛鏃犺姱鍗风焊",description:"鍘熺敓鏈ㄦ祮鍒堕€狅紝鍥涘眰鍔犲帤锛屼翰鑲ゆ煍杞紝涓€鍖?2鍗枫€?,price:19.9},{name:"鑷姩鎰熷簲娲楁墜娑叉満",description:"绾㈠鎰熷簲锛屽厤鎺ヨЕ鍑烘场锛屾湁鏁堥伩鍏嶄氦鍙夋劅鏌擄紝瀹堟姢瀹朵汉鍋ュ悍銆?,price:69},{name:"鎳掍汉妗岄潰鍚稿皹鍣?,description:"寮哄姏鍚搁櫎妗岄潰鐏板皹銆佹鐨睉鍜岄浂椋熺灞戯紝涓€閿紑鍚紝杞绘澗娲佸噣銆?,price:45},{name:"鍒嗙被鏀剁撼鐩掑瑁?,description:"涓€濂椾笁浠讹紝涓嶅悓灏哄婊¤冻鍚勭鏀剁撼闇€姹傦紝璁╀綘鐨勬闈簳浜曟湁鏉°€?,price:38},{name:"澶╃劧绔圭氦缁存瘺宸?,description:"鍚告按鎬у己锛屾煍杞翰鑲わ紝鎶楄弻闃查湁锛屼笁鏉¤銆?,price:29.9},{name:"澶氬姛鑳藉帹鎴垮壀鍒€",description:"閿嬪埄鑰愮敤锛屽彲鍓澶淬€佽敩鑿滃拰鑲夌被锛岃繕鑳藉紑鐡跺拰鍒奔槌炪€?,price:39},{name:"鍙檷瑙ｅ瀮鍦捐",description:"鐜繚鏉愭枡鍒朵綔锛屾壙閲嶅己涓嶆槗鐮达紝100鍙銆?,price:12.9},{name:"渚挎惡寮忔姌鍙犳櫨琛ｆ灦",description:"澶栧嚭鏃呰蹇呭锛屾姌鍙犺璁′笉鍗犵┖闂达紝鎵块噸鑳藉姏寮恒€?,price:49},{name:"瓒呭０娉㈤钖版満",description:"闈欓煶杩愯锛屽姞婀块钖颁簩鍚堜竴锛岃惀閫犺垝閫傜幆澧冦€?,price:79},{name:"澶氬姛鑳藉垏鑿滃櫒",description:"澶氱鍒€鐗囧彲閫夛紝鍒囦笣鍒囩墖鍒囦竵涓€閿悶瀹氾紝鐪佹椂鐪佸姏銆?,price:59},{name:"璁板繂妫夋灂澶?,description:"鎱㈠洖寮规潗璐紝璐村悎棰堟鏇茬嚎锛屾敼鍠勭潯鐪犺川閲忋€?,price:129},{name:"涓嶉攬閽繚娓╂澂",description:"316涓嶉攬閽㈡潗璐紝淇濇俯淇濆喎24灏忔椂锛?00ml瀹归噺銆?,price:89},{name:"鍘ㄦ埧娌规薄娓呮磥鍓?,description:"寮烘晥鍘绘薄锛屽ぉ鐒舵垚鍒嗕笉浼ゆ墜锛岃交鏉惧幓闄ら噸娌规薄銆?,price:29.9},{name:"闃叉粦娴村鍦板灚",description:"鍚告按閫熷共锛岄槻婊戣璁★紝鏌旇蒋鑸掗€傦紝澶氱鍥炬鍙€夈€?,price:35},{name:"LED灏忓鐏?,description:"鍏夋劅鑷姩寮€鍏筹紝鏌斿厜涓嶅埡鐪硷紝鍛垫姢瀹濆疂鐫＄湢銆?,price:19.9},{name:"澶氬姛鑳芥暟鎹嚎",description:"涓€鎷栦笁璁捐锛屾敮鎸佸揩鍏咃紝閫傜敤浜庢墜鏈恒€佸钩鏉跨瓑璁惧銆?,price:29},{name:"澶╃劧妞嶇墿娲楄。娑?,description:"娓╁拰閰嶆柟锛屾繁灞傛磥鍑€锛屼笉鍚崸鍏夊墏锛岄€傚悎姣嶅┐琛ｇ墿銆?,price:45},{name:"渚挎惡寮忛鍏峰瑁?,description:"鍖呭惈绛峰瓙銆佸嫼瀛愬拰鍙夊瓙锛岄鍝佺骇鏉愯川锛岀幆淇濆崼鐢熴€?,price:25},{name:"妗岄潰鍔犳箍鍣?,description:"杩蜂綘璁捐涓嶅崰绌洪棿锛岄潤闊宠繍琛岋紝缂撹В绌烘皵骞茬嚗銆?,price:59},{name:"澶氬姛鑳界瑪璁版湰鏀灦",description:"鍙皟鑺傞珮搴﹁搴︼紝鏁ｇ儹閫忔皵锛屼繚鎶ら妞庛€?,price:79}],sports:[{name:"涓撲笟闃叉粦鐟滀冀鍨?,description:"8mm鍔犲帤澶╃劧姗¤兌鏉愯川锛岄槻婊戞€ц兘浼樺紓锛岀幆淇濇棤寮傚懗锛岄檮甯︾粦甯︽柟渚挎惡甯︺€?,price:129},{name:"鎶樺彔闇茶惀甯愮",description:"3-4浜哄叏鑷姩閫熷紑甯愮锛岄槻姘撮槻鏅掗潰鏂欙紝閫氶璁捐锛岄€傚悎瀹跺涵鎴峰闇茶惀銆?,price:459},{name:"杞婚噺寰掓鐧诲北闉?,description:"闃叉按閫忔皵闉嬮潰锛岄槻婊慥ibram澶у簳锛屽噺闇囬瀷鍨紝閫傚悎涓綆闅惧害寰掓銆?,price:699},{name:"鏅鸿兘杩愬姩鎵嬭〃",description:"鏀寔100+杩愬姩妯″紡锛屽績鐜囪姘х洃娴嬶紝50绫抽槻姘达紝缁埅鍙揪14澶┿€?,price:899},{name:"鍙姌鍙犲北鍦拌嚜琛岃溅",description:"27閫熷彉閫熺郴缁燂紝閾濆悎閲戣溅鏋讹紝鎶樺彔鍚庡彲鏀惧叆姹借溅鍚庡绠憋紝鏂逛究鎼哄甫銆?,price:1599},{name:"澶氬姛鑳芥埛澶栬儗鍖?,description:"45L澶у閲忥紝闃叉按闈㈡枡锛岃儗璐熺郴缁熻垝閫傦紝閫傚悎2-3澶╂埛澶栧緬姝ユ梾琛屻€?,price:399},{name:"涓撲笟缇芥瘺鐞冩媿濂楄",description:"鍏ㄧ⒊绱犵氦缁存潗璐紝杞婚噺鍖栬璁★紝鍚?鏀悆鎷嶃€?涓窘姣涚悆鍜屼究鎼哄寘銆?,price:259},{name:"鑷姩鍏呮皵闃叉疆鍨?,description:"3cm鍔犲帤娴风坏锛岃嚜鍔ㄥ厖姘旇璁★紝闃叉疆闅旀俯锛岄€傚悎闇茶惀閲庨浣跨敤銆?,price:199},{name:"閫熷共杩愬姩濂楄",description:"鐢峰コ鍚屾锛屽惛婀挎帓姹楅潰鏂欙紝閫忔皵涓嶉椃姹楋紝閫傚悎璺戞鍋ヨ韩绛夎繍鍔ㄣ€?,price:159},{name:"楂樺己搴︽媺鍔涚怀",description:"5鏍逛笉鍚岄樆鍔涚怀缁勫悎锛屽彲璋冭妭闀垮害锛岄€傚悎灞呭鍔涢噺璁粌锛岄檮甯︽敹绾宠銆?,price:89},{name:"鎴峰渚挎惡寮忔按澹?,description:"1L澶у閲忥紝椋熷搧绾т笉閿堥挗鏉愯川锛屼繚娓╀繚鍐?4灏忔椂锛屽甫鐧诲北鎵ｈ璁°€?,price:129},{name:"涓撲笟娼滄按娓告吵闀?,description:"闃查浘闃茬传澶栫嚎闀滅墖锛岀鑳跺瘑灏佸湀锛岃创鍚堜笉婕忔按锛屽彲璋冭妭澶村甫銆?,price:159},{name:"鎶樺彔寮忓お闃宠兘鍏呯數瀹?,description:"20000mAh澶у閲忥紝鏀寔澶槼鑳藉厖鐢碉紝鍙孶SB杈撳嚭锛屾埛澶栧簲鎬ュ繀澶囥€?,price:299},{name:"瀹ゅ唴鍋ヨ韩鍔ㄦ劅鍗曡溅",description:"闈欓煶纾佹帶绯荤粺锛屽彲璋冭妭闃诲姏鍜屽骇妞呴珮搴︼紝甯﹀績鐜囩洃娴嬪姛鑳姐€?,price:1899},{name:"鎴峰閲庤惀鐐夊叿濂楄",description:"渚挎惡寮忔皵鐐?閿呭叿缁勫悎锛岀伀鍔涜皟鑺傜簿鍑嗭紝閫傚悎閲庡鐑归オ銆?,price:259},{name:"涓撲笟璺戞杩愬姩闉?,description:"缂撻渿涓簳锛岄€忔皵缃戦潰锛岃€愮（姗¤兌澶у簳锛岄€傚悎闀胯窛绂昏窇姝ャ€?,price:799},{name:"澶氬姛鑳芥垬鏈墜鐢电瓛",description:"寮哄厜杩滃皠锛屾敮鎸佺垎闂拰SOS妯″紡锛岄槻姘撮槻灏橈紝鍙厖鐢佃璁°€?,price:199},{name:"鐟滀冀鐞冨仴韬悆",description:"闃茬垎鏉愯川锛岀洿寰?5cm锛岄€傚悎鐟滀冀缁冧範鍜屾牳蹇冨姏閲忚缁冿紝闄勫甫鎵撴皵绛掋€?,price:69},{name:"鎴峰淇濇俯閲庨绡?,description:"瀹归噺20L锛屼繚娓╁眰璁捐锛屽彲瀹圭撼4浜轰唤椁愬叿锛岄€傚悎閮婂閲庨銆?,price:299},{name:"涓撲笟婊戦洩鏉垮瑁?,description:"鍏ㄨ兘鍨嬫粦闆澘+鍥哄畾鍣?闆潠缁勫悎锛岄€傚悎鍒濅腑绾ф粦闆埍濂借€呫€?,price:2599}],beautyCare:[{name:"姘ㄥ熀閰告磥闈钩",description:"娓╁拰娓呮磥閰嶆柟锛屽惈姘ㄥ熀閰告垚鍒嗭紝娲楀畬涓嶇揣缁凤紝閫傚悎鎵€鏈夎偆璐?,price:89},{name:"鐜诲翱閰歌ˉ姘撮潰鑶?,description:"楂樻祿搴︾幓灏块吀绮惧崕锛屾繁灞傝ˉ姘撮攣姘达紝涓€鐩?0鐗囪",price:129},{name:"鐑熼叞鑳轰寒鑲ょ簿鍗庢恫",description:"5%鐑熼叞鑳烘祿搴︼紝鎻愪寒鑲よ壊鏀瑰杽鏆楁矇锛屾贰鍖栫棙鍗?,price:159},{name:"绁炵粡閰拌兒淇姢闈㈤湝",description:"涓夐噸绁炵粡閰拌兒閰嶆柟锛屼慨澶嶈倢鑲ゅ睆闅滐紝鏁忔劅鑲岄€傜敤",price:219},{name:"姘ㄥ熀閰告场娉℃矏娴撮湶",description:"涓板瘜缁嗚吇娉℃搏锛屾俯鍜屾竻娲佷笉鍋囨粦锛屾寔涔呯暀棣?,price:59},{name:"涔虫湪鏋滄姢鎵嬮湝濂楄",description:"鍚钩鏈ㄦ灉娌瑰拰缁寸敓绱燛锛屾粙娑︿繚婀匡紝3鏀涓嶅悓棣欏瀷",price:45},{name:"鑺﹁崯鑳惰垝缂撳嚌鑳?,description:"99%鑺﹁崯鍘熸眮鎻愬彇锛岃垝缂撴檼鍚庝慨鎶わ紝鍙仛鐫＄湢闈㈣啘",price:39},{name:"鍖栧鍒峰瑁?2鏀?,description:"鏌旇蒋浜洪€犵氦缁存瘺锛屽惈鏁ｇ矇鍒枫€佺溂褰卞埛绛夛紝閫佹敹绾冲寘",price:139},{name:"澶╃劧妞嶇墿娲楀彂姘?,description:"鏃犵娌归厤鏂癸紝鎺ф补鍘诲睉锛岄€傚悎娌规€у彂璐?,price:79},{name:"闃叉按鐫瘺鑶?,description:"娴撳瘑绾ら暱鏁堟灉锛岄槻姘撮槻姹椾笉鏅曟煋锛屾槗鍗稿",price:69},{name:"淇濇箍绮夊簳娑?,description:"杞昏杽鏈嶅笘锛岃嚜鐒堕伄鐟曪紝鎸佸8灏忔椂涓嶈劚濡?,price:189},{name:"鍘昏璐ㄦ鐨啅",description:"娓╁拰鍘婚櫎闈㈤儴鑰佸簾瑙掕川锛屾瘡鍛ㄤ娇鐢?-2娆?,price:49},{name:"闃叉檼闇淪PF50+",description:"楂樺€嶉槻鏅掞紝闃叉按闃叉睏锛屾竻鐖戒笉娌硅吇",price:99},{name:"鐜懓绾湶鐖借偆姘?,description:"澶╃劧鐜懓鎻愬彇锛岃ˉ姘翠繚婀匡紝鍙仛姘磋啘",price:65},{name:"鍗稿姘存晱鎰熻倢鐢?,description:"娓╁拰鏃犲埡婵€锛岀溂鍞囪劯涓夊悎涓€锛屾繁灞傛竻娲?,price:55},{name:"缁寸敓绱燛娑﹀攪鑶?,description:"鎸佷箙婊嬫鼎淇濇箍锛屾贰鍖栧攪绾癸紝鏃犺壊閫忔槑",price:25},{name:"鑼舵爲绮炬补绁涚棙鍑濊兌",description:"蹇€熸秷鐐庣鐥橈紝娣″寲鐥樺嵃锛屼笉鍒烘縺鐨偆",price:35},{name:"鍘嬬缉闈㈣啘绾?00绮?,description:"绾鏉愯川锛屽惛姘存€у己锛屾惌閰嶇埥鑲ゆ按浣跨敤",price:29},{name:"韬綋纾ㄧ爞鑶?,description:"娴风洂棰楃矑锛屾俯鍜屽幓瑙掕川锛屼娇鑲岃偆鍏夋粦缁嗚吇",price:69},{name:"鐪夌瑪鐪夌矇濂楄",description:"闃叉按闃叉睏锛屾槗涓婅壊涓嶆檿鏌擄紝鍚湁绗斻€佺湁绮夊拰鐪夊埛",price:59}],foodSnacks:[{name:"娣峰悎鍧氭灉绀肩洅",description:"鍖呭惈宸存棪鏈ㄣ€佽叞鏋溿€佹牳妗冪瓑6绉嶅潥鏋滐紝鐙珛灏忓寘瑁咃紝姣忔棩涓€鍖呰ˉ鍏呰惀鍏?,price:159},{name:"鏃犺敆绯栧叏楹﹂ゼ骞?,description:"楂樼氦缁翠綆鐑噺锛屾棤钄楃硸娣诲姞锛屽彛鎰熼叆鑴嗭紝閫傚悎浠ｉ鎴栦笅鍗堣尪",price:39.9},{name:"鍐诲共姘存灉鑴嗙墖",description:"鑽夎帗銆佽姃鏋溿€侀钑夊绉嶅彛鍛崇粍鍚堬紝闈炴补鐐镐繚鐣欒惀鍏伙紝鍎跨闆堕棣栭€?,price:45},{name:"绾粦宸у厠鍔?,description:"85%鍙彲鍚噺锛屽井鑻﹂唶鍘氾紝鏃犳坊鍔犺敆绯栵紝鐙珛灏忓潡瑁?,price:59},{name:"鏃ュ紡鎷夐潰缁勫悎瑁?,description:"璞氶銆侀叡娌广€佸懗鍣屼笁绉嶅彛鍛筹紝鍚嫭绔嬫堡鍖呭拰鍙夌儳锛?鍖呰",price:69},{name:"鍗抽鐕曢害鐗?,description:"婢虫床绾嚂楹︼紝鍏嶇叜鍗抽锛屽彲鎼厤鐗涘ザ姘存灉锛岃惀鍏绘棭椁愰€夋嫨",price:29.9},{name:"鐗涜倝骞茬ぜ鐩?,description:"鍐呰挋鍙ら骞插伐鑹猴紝鍘熷懗鍜岄杈ｄ袱绉嶅彛鍛筹紝鑲夎川绱у疄鏈夊毤鍔?,price:89},{name:"閫熸憾榛戝挅鍟?,description:"鍝ヤ鸡姣斾簹杩涘彛鍜栧暋璞嗭紝鍐诲共鎶€鏈繚鐣欓鍛筹紝40鏉¤",price:65},{name:"铚傝湝鏌氬瓙鑼?,description:"闊╁浗杩涘彛鍘熸枡锛岃渹铚滀笌鏌氬瓙榛勯噾閰嶆瘮锛屽啿姘撮ギ鐢ㄩ吀鐢滃彲鍙?,price:45},{name:"钖墖澶хぜ鍖?,description:"鍘熷懗銆佺暘鑼勩€佺儳鐑ゅ绉嶅彛鍛虫贩鍚堬紝鐙珛灏忓寘瑁咃紝鍒嗕韩瑁?,price:39},{name:"浜斿父绋昏姳棣欏ぇ绫?,description:"5kg鐪熺┖鍖呰锛岄粦榫欐睙浜斿父浜у尯锛岀背绮掗ケ婊″彛鎰熼绯?,price:99},{name:"鐗圭骇鍒濇Θ姗勬娌?,description:"2L瑁咃紝瑗跨彮鐗欒繘鍙ｏ紝閫傚悎鍑夋媽鍜屼綆娓╃児楗紝鍋ュ悍椋熺敤娌?,price:129},{name:"鍐诲共閾惰€崇竟",description:"鍏嶇叜鍗抽锛屾坊鍔犳灨鏉炲拰鍐扮硸锛屽紑姘村啿娉?鍒嗛挓鍗冲彲椋熺敤",price:55},{name:"楸块奔涓濇捣鍛抽浂椋?,description:"娣辨捣楸块奔鍒朵綔锛岄矞瀚╂湁鍤煎姴锛岀嫭绔嬪寘瑁呮柟渚挎惡甯?,price:35},{name:"鎶硅尪鍛虫洸濂囬ゼ骞?,description:"杩涘彛鎶硅尪绮夊埗浣滐紝鑼堕娴撻儊锛屽彛鎰熼叆鑴嗭紝绀肩洅瑁?,price:49},{name:"绾㈣眴钖忕背绮?,description:"绁涙箍浠ｉ绮夛紝鐙珛灏忓寘瑁咃紝寮€姘村啿璋冨嵆鍙鐢紝30鏉¤",price:59},{name:"宸存棪鏈ㄥす蹇冩灒",description:"鏂扮枂鐏版灒澶瑰反鏃︽湪锛屾棤娣诲姞钄楃硸锛岄鐢滃彲鍙ｏ紝琛ヨ鐩婃皵",price:45},{name:"鎰忓ぇ鍒╅潰濂楄",description:"鍚灪鏃嬮潰銆佺暘鑼勯叡鍜屾剰寮忛鑽夛紝4浜轰唤锛岀畝鍗曟槗鍋?,price:39},{name:"榛勬缃愬ご",description:"鐮€灞遍粍妗冨埗浣滐紝鏃犻槻鑵愬墏锛屾灉鑲夐ケ婊★紝绯栨按娓呯敎",price:35},{name:"鍧氭灉鐕曢害鑳介噺妫?,description:"浠ｉ闆堕锛屽惈澶氱鍧氭灉鍜岀嚂楹︼紝鎶楅タ4灏忔椂锛?2鏉¤",price:69}],milktea:[{name:"娉㈤湼濂惰尪",description:"缁忓吀鍙板紡椋庡懗锛孮寮规尝闇告惌閰嶉娴撳ザ鑼讹紝鍙ｆ劅涓板瘜銆?,price:15,brand:"CoCo閮藉彲"},{name:"鍥涘鏄ョ帥濂囨湹",description:"娓呯埥鐨勫洓瀛ｆ槬鑼跺簳锛岃涓婄坏瀵嗙殑鍜搁鑺濆＋濂剁洊锛屽眰娆″垎鏄庛€?,price:18,brand:"涓€鐐圭偣"},{name:"澶氳倝钁¤悇",description:"鏂伴矞鎵嬪墺钁¤悇鏋滆倝锛屾惌閰嶆竻鐖界豢濡嶈尪搴曞拰Q寮硅剢娉㈡尝锛屼汉姘旈閫夈€?,price:29,brand:"鍠滆尪"},{name:"骞藉叞鎷块搧",description:"绮鹃€夌孩鑼跺簳涓庨矞濂惰瀺鍚堬紝椤堕儴鎾掍笂棣欒剢纰ф牴鏋滐紝鑼堕涓庡潥鏋滈浜ょ粐銆?,price:20,brand:"鑼堕鎮﹁壊"},{name:"鑺嬫偿娉㈡尝鐗涗钩",description:"鎵嬪伐鎹ｅ埗鐨勯鐢滆妺娉ワ紝鎼厤Q寮规尝娉㈠拰鏂伴矞鐗涗钩锛屽彛鎰熺坏瀵嗐€?,price:22,brand:"濂堥洩鐨勮尪"},{name:"鏉ㄦ灊鐢橀湶",description:"鏂伴矞鑺掓灉銆佽タ鏌氭灉绮掍笌瑗跨背闇茬殑瀹岀編缁撳悎锛屽鏃ヨВ鏆戠鍣ㄣ€?,price:25,brand:"鍠滆尪"},{name:"鎵惧ザ鑼?,description:"缁忓吀鍘熷懗濂惰尪锛屽洖褰掓渶绾补鐨勫ザ涓庤尪鐨勮瀺鍚堬紝鎬т环姣斾箣閫夈€?,price:12,brand:"涓€鐐圭偣"},{name:"鍐伴矞鏌犳姘?,description:"鏂伴矞鏌犳鍒囩墖锛屾惌閰嶅啺鍧楀拰绾噣姘达紝娓呯埥瑙ｆ复锛屾€т环姣斾箣鐜嬨€?,price:4,brand:"铚滈洩鍐板煄"},{name:"鐝嶇彔濂惰尪",description:"缁忓吀鐨勮湝闆ザ鑼讹紝鎼厤Q寮圭弽鐝狅紝鏄瘡涓汉鐨勫叆闂ㄦ銆?,price:7,brand:"铚滈洩鍐板煄"},{name:"鎽╁ぉ鑴嗚剢鍐版穱娣?,description:"棣欒崏鍛崇殑鍐版穱娣嬬敎绛掞紝椤堕儴鍔犱笂閰ヨ剢鐨勫阀鍏嬪姏妫掞紝绔ュ勾鐨勫懗閬撱€?,price:5,brand:"铚滈洩鍐板煄"},{name:"婊℃澂鐧鹃鏋?,description:"鏂伴矞鐧鹃鏋滄灉鑲変笌鑼跺簳鐨勬縺鎯呯鎾烇紝閰哥敎鍙彛锛屾灉棣欏洓婧€?,price:8,brand:"铚滈洩鍐板煄"},{name:"琛€绯背绾㈣眴濂惰尪",description:"鎷涚墝琛€绯背鎼厤杞朝绾㈣眴锛屽彛鎰熶赴瀵岋紝鏆栧績鏆栬儍鐨勪簲璋峰ザ鑼躲€?,price:16,brand:"娌笂闃垮Ж"},{name:"椴滅倴姊ㄨ啅",description:"鎵嬪伐椴滅倴姊ㄨ啅锛屾竻娑﹂檷鐕ワ紝鎼厤閾惰€筹紝鏄吇鐢熶汉澹殑棣栭€夈€?,price:18,brand:"娌笂闃垮Ж"},{name:"缁胯眴鐗涗钩鍐?,description:"娓呯埥鐨勭豢璞嗘矙鎼厤椤烘粦鐗涗钩锛屽鏃ヨВ鏆戯紝鍙ｆ劅缁靛瘑銆?,price:15,brand:"娌笂闃垮Ж"},{name:"鑺嬪渾钁¤悇",description:"鏂伴矞钁¤悇鏋滆倝鎼厤鎵嬪伐鑺嬪渾锛孮寮规湁鍤煎姴锛屾灉鍛冲崄瓒炽€?,price:20,brand:"娌笂闃垮Ж"},{name:"鐑ゅザ",description:"鐙壒鐨勭儤鐒欏伐鑹猴紝甯︽潵鐒︾硸鑸殑鐐儳椋庡懗锛屽ザ棣欐祿閮併€?,price:16,brand:"鑼堕鎮﹁壊"},{name:"濂堕湝鑽夎帗鏋滆尪",description:"鏂伴矞鑽夎帗鏋滆倝涓庣豢鑼剁殑瀹岀編缁撳悎锛岄《閮ㄨ鐩栧捀棣欏ザ闇溿€?,price:26,brand:"濂堥洩鐨勮尪"},{name:"椴滆妺鐗涘ザ瑗跨背闇?,description:"鏂伴矞鑺嬪ご钂哥叜鎴愭偿锛屾惌閰嶈タ绫冲拰鐗涘ザ锛屽彛鎰熼『婊戙€?,price:19,brand:"CoCo閮藉彲"},{name:"鍐版穱娣嬬孩鑼?,description:"椤烘粦鐨勯鑽夊啺娣囨穻鐞冿紝缂撶紦铻嶅叆閱囧帤鐨勭孩鑼朵腑锛岀粡鍏镐箣閫夈€?,price:14,brand:"涓€鐐圭偣"},{name:"鑺濊姖鑺掕姃",description:"澶у潡鏂伴矞鑺掓灉鏋滆倝锛屾惌閰嶇豢濡嶈尪搴曞拰娴撻儊鑺濆＋濂剁洊锛屾灉棣欏洓婧€?,price:32,brand:"鍠滆尪"},{name:"澹板０涔岄緳",description:"甯︽湁鐙壒鐑熺啅椋庡懗鐨勪箤榫欒尪搴曪紝鍏ュ彛鐢橀唶锛屽洖鍛虫偁闀裤€?,price:17,brand:"鑼堕鎮﹁壊"},{name:"闇告皵姗欏瓙",description:"绮鹃€夎繘鍙ｆ柊濂囧＋姗欙紝鏁撮椴滃垏锛屾惌閰嶆竻棣欑豢鑼讹紝VC鐖嗘銆?,price:25,brand:"濂堥洩鐨勮尪"}],gifts:[{name:"绠€绾︽儏渚ｅ鎴?,description:"閲囩敤浼樿川閲戝睘鎵撻€狅紝璁捐绠€绾︽椂灏氾紝璞″緛姘告亽鐖辨剰銆?,price:520,brand:"鍛ㄥぇ绂?},{name:"鐠€鐠ㄩ捇鐭虫儏渚ｅ鎴?,description:"闀跺祵闂€€閽荤煶锛屽伐鑹虹簿婀涳紝鏄儏渚ｉ棿鐝嶈吹鐨勬壙璇鸿薄寰併€?,price:5999,brand:"DR"},{name:"99鏈电孩鐜懓鑺辨潫",description:"绮鹃€?9鏈甸矞鑹崇孩鐜懓锛屽瘬鎰忛暱闀夸箙涔咃紝娴极鑷虫瀬銆?,price:399,brand:"閲庡吔娲綛EAST"},{name:"姘哥敓鑺卞皬鐔婄ぜ鐩?,description:"鍙埍灏忕唺鎼厤姘镐笉鍑嬭阿鐨勬案鐢熻姳锛岀簿鑷村張娴极銆?,price:258,brand:"璇鸿獡ROSEONLY"},{name:"鎯呬荆杩炲附鍗。",description:"绾鏉愯川锛岃垝閫傞€忔皵锛屾儏渚ｆ璁捐锛屾椂灏氱櫨鎼€?,price:199,brand:"鍞愮嫯Tonlion"},{name:"绠€绾︽儏渚鎭?,description:"绠€绾﹂鏍硷紝澶氱棰滆壊鍙€夛紝閫傚悎鏃ュ父绌跨潃銆?,price:99,brand:"妫┈Semir"},{name:"鎯呬荆鐗涗粩澶栧",description:"缁忓吀鐗涗粩闈㈡枡锛屾疆娴佹寮忥紝鎯呬荆鍑鸿瓒呭惛鐫涖€?,price:399,brand:"缇庣壒鏂偊濞?},{name:"鎯呬荆杩愬姩闉?,description:"鑸掗€傞瀷搴曪紝鏃跺皻澶栬锛岄€傚悎鎯呬荆涓€璧疯繍鍔ㄣ€?,price:499,brand:"鏉庡畞LINING"},{name:"鎯呬荆鎵嬭〃",description:"绠€绾﹁〃鐩樿璁★紝绮惧噯璧版椂锛屾椂鍒荤浉浼淬€?,price:799,brand:"鍗¤タ娆ASIO"},{name:"鎯呬荆棣欐按绀肩洅",description:"鐢烽濂抽鎼厤锛岀嫭鐗归鍛筹紝澧炴坊娴极姘涘洿銆?,price:560,brand:"绁栫帥鐝慗o Malone"},{name:"鎯呬荆鐫¤。",description:"鏌旇蒋闈㈡枡锛岃垝閫備翰鑲わ紝浜彈娓╅Θ灞呭鏃跺厜銆?,price:239,brand:"鑺吘FENTENG"},{name:"鎯呬荆淇濇俯鏉?,description:"淇濇俯鏁堟灉濂斤紝鍙埍澶栬锛屾儏渚ｅ嚭琛屽繀澶囥€?,price:129,brand:"鍝堝皵鏂疕AERS"},{name:"鎯呬荆閽ュ寵鎵?,description:"绮捐嚧灏忓阀锛屽嵃鏈夋儏渚ｅ厓绱狅紝鎼哄甫鏂逛究銆?,price:39,brand:"鍚嶅垱浼樺搧MINISO"},{name:"鎯呬荆鎵嬪伐鐩稿唽",description:"鍙翰鎵嬪埗浣滐紝璁板綍鎯呬荆闂寸編濂藉洖蹇嗐€?,price:69,brand:"鏅ㄥ厜M&G"},{name:"鎯呬荆鐜╁伓",description:"鍙埍姣涚粧鐜╁伓锛屼竴瀵规惌閰嶏紝钀岃叮鍗佽冻銆?,price:89,brand:"杩＋灏糄isney"},{name:"鎯呬荆闆ㄤ紴",description:"鏅撮洦涓ょ敤锛屾椂灏氬瑙傦紝涓烘儏渚ｉ伄椋庢尅闆ㄣ€?,price:99,brand:"澶╁爞浼?},{name:"鎯呬荆閽卞寘",description:"浼樿川鐨潻锛屽疄鐢ㄥ張缇庤锛屾柟渚挎惡甯︺€?,price:189,brand:"鍟勬湪楦烼UCANO"},{name:"鎯呬荆鎶辨灂",description:"鏌旇蒋鑸掗€傦紝闈犲湪涓婇潰浜彈鐢滆湝鏃跺厜銆?,price:79,brand:"鍗楁瀬浜篘anJiren"},{name:"鎯呬荆澶槼闀?,description:"鏃跺皻娆惧紡锛屾湁鏁堥樆鎸＄传澶栫嚎锛屽嚭琛屾椂灏氬崟鍝併€?,price:269,brand:"鏆撮緳BOLON"},{name:"鎯呬荆钃濈墮闊崇",description:"闊宠川娓呮櫚锛屽皬宸т究鎼猴紝浜彈闊充箰鏃跺厜銆?,price:159,brand:"婕鑰匛DIFIER"},{name:"鎯呬荆鎵嬮摼",description:"绮剧編璁捐锛屼僵鎴村湪鎵嬭厱涓婏紝褰版樉鎯呬荆韬唤銆?,price:168,brand:"鏂藉崕娲涙€濆SWAROVSKI"},{name:"鎯呬荆甯藉瓙",description:"娼祦娆惧紡锛岄伄闃冲張鏃跺皻锛屾儏渚ｆ惌閰嶈秴閰枫€?,price:89,brand:"MLB"},{name:"鎯呬荆椁愬叿",description:"绮捐嚧椁愬叿锛岄€傚悎鎯呬荆涓€璧风敤椁愶紝澧炴坊鐢熸椿浠紡鎰熴€?,price:139,brand:"鍙岀珛浜篫WILLING"},{name:"鎯呬荆鎵嬫満澹?,description:"鍙埍鎴栭叿鐐殑璁捐锛屼繚鎶ゆ墜鏈哄悓鏃剁鍑烘仼鐖便€?,price:49,brand:"浜胯壊ESR"},{name:"鎯呬荆鎷煎浘",description:"涓€璧峰畬鎴愭嫾鍥撅紝浜彈鍚堜綔涔愯叮锛岀暀涓嬬編濂藉洖蹇嗐€?,price:59,brand:"3D-JP"},{name:"鎯呬荆棣欒柊铚＄儧",description:"鏁ｅ彂杩蜂汉棣欐皵锛岃惀閫犳氮婕皼鍥淬€?,price:99,brand:"瑙傚To Summer"},{name:"鎯呬荆杩愬姩鑳屽寘",description:"澶у閲忥紝鑸掗€傝儗璐燂紝閫傚悎鎯呬荆鍑鸿鎴栬繍鍔ㄦ惡甯︾墿鍝併€?,price:299,brand:"瀹夎笍ANTA"},{name:"鎯呬荆鎷煎浘鐩告",description:"鍙皢瀹屾垚鐨勬嫾鍥炬斁鍏ョ浉妗嗭紝浣滀负瑁呴グ锛岀邯蹇电編濂姐€?,price:79,brand:"鏃犲嵃鑹搧MUJI"},{name:"鎯呬荆鍋ヨ韩鍣ㄦ潗锛堝搼閾冨瑁咃級",description:"閫傚悎鎯呬荆涓€璧峰仴韬敾鐐硷紝鎵撻€犲仴搴风敓娲汇€?,price:359,brand:"杩崱渚珼ECATHLON"},{name:"鎯呬荆鐑樼剻濂楄",description:"鍖呭惈鐑樼剻宸ュ叿锛屽彲涓€璧峰埗浣滅敎铚滅偣蹇冦€?,price:219,brand:"瀛﹀帹CHEFMADE"},{name:"鎯呬荆鐟滀冀鍨?,description:"鐜繚鏉愯川锛岃垝閫傞槻婊戯紝閫傚悎鎯呬荆涓€璧风粌涔犵憸浼姐€?,price:149,brand:"濂ヤ箟YOTTOY"}],brands:[{name:" 瀹濇牸涓?Serpenti 绯诲垪鎵嬮暞 ",description:" 浠ョ伒铔囦负鐏垫劅锛岄噰鐢?18K 閲戞潗璐紝闀跺祵鐠€鐠ㄥ疂鐭筹紝鐏靛姩浼橀泤锛屽敖鏄惧ア鍗庢皵璐紝鏄疂鏍间附鏋佸叿浠ｈ〃鎬х殑缁忓吀娆惧紡銆?,price:19800,brand:" 瀹濇牸涓?BVLGARI"},{name:" 姊靛厠闆呭疂 Alhambra 鍥涘彾鑽夐」閾撅紙绾㈢帀楂撻暥閽绘锛?,description:" 缁忓吀鍥涘彾鑽夐€犲瀷锛岀孩鐜夐珦鎼厤閽荤煶锛屽湪浼橀泤涓娣婚棯鑰€鍏夎姃锛岃薄寰佺潃骞歌繍涓庣編濂斤紝鏄⒌鍏嬮泤瀹濈殑鏄庢槦浜у搧銆?,price:21e3,brand:" 姊靛厠闆呭疂 VAN CLEEF & ARPELS"},{name:" 鍗″湴浜?Love 绯诲垪瀹界増鎵嬮暞 ",description:" 鏍囧織鎬х殑铻轰笣閽夎璁★紝瀹界増閫犲瀷鏇存樉澶ф皵锛?8K 閲戞潗璐ㄥ潥鍥鸿€愮敤锛屽瘬鎰忕潃灏嗙埍鐗㈢墷閿佷綇锛屾槸鎯呬荆闂磋〃杈剧埍鎰忕殑鐑棬閫夋嫨銆?,price:23e3,brand:" 鍗″湴浜?CARTIER"},{name:" 鍔冲姏澹殱寮忔亽鍔ㄦ棩蹇楀瀷 36 鑵曡〃 ",description:" 鍔冲姏澹粡鍏告寮忥紝36 姣背琛ㄧ洏閫傚悎澶氱鑵曞懆锛岃殱寮忚〃澹冲潥鍥洪槻姘达紝绮惧噯璧版椂锛屽睍鐜板崜瓒婂搧璐ㄤ笌浣庤皟濂㈠崕銆?,price:18500,brand:" 鍔冲姏澹?ROLEX"},{name:" 棣欏鍎?Chanel CF Mini 閾炬潯鍖咃紙灏忕緤鐨級",description:" 棣欏鍎跨粡鍏哥殑 CF 绯诲垪锛孧ini 灏哄绮捐嚧灏忓阀锛屽皬缇婄毊鏉愯川鎵嬫劅鏌旇蒋锛岃彵鏍肩汗鎼厤閲戝睘閾炬潯锛屾椂灏氬張鐧炬惌锛屾槸姣忎釜鏃跺皻杈句汉鐨勬ⅵ鎯冲崟鍝併€?,price:20500,brand:" 棣欏鍎?CHANEL"},{name:" 杩ゥ Dior Lady D-Lite 涓夋牸鎴村鍖咃紙钘ゆ牸绾癸級",description:" 寤剁画鎴村鍖呯殑浼橀泤璁捐锛屼笁鏍煎ぇ灏忓疄鐢ㄤ笖绮捐嚧锛岃棨鏍肩汗鎼厤閲戝睘鎵ｏ紝褰版樉杩ゥ鐨勯珮绾ц川鎰燂紝閫傚悎鍚勭姝ｅ紡涓庝紤闂插満鍚堛€?,price:19900,brand:" 杩ゥ DIOR"},{name:" 鐖遍┈浠?Herm猫s Evelyne 16 鏂滄寧鍖?",description:" 绠€绾︾殑璁捐椋庢牸锛?6 鍘樼背鐨勫昂瀵稿皬宸т究鎼猴紝缁忓吀鐨?鈥淗鈥?鎵ｆ爣璇嗭紝鎼厤鍙皟鑺傝偐甯︼紝瀹炵敤鎬т笌鏃跺皻鎰熷吋鍏凤紝鏄埍椹粫鍏ラ棬绾х殑鐑棬鍖呮銆?,price:22e3,brand:" 鐖遍┈浠?HERM脠S"},{name:" 钂傝姍灏?Tiffany T True 绯诲垪 18K 閲戦暥閽绘墜閾?",description:"T 瀛楅€犲瀷璁捐绠€娲佺幇浠ｏ紝18K 閲戞惌閰嶉棯鑰€閽荤煶锛屽睍鐜板嚭鐙壒鐨勬椂灏氬搧鍛筹紝鏄拏鑺欏凹灏嗙粡鍏镐笌鍒涙柊铻嶅悎鐨勪匠浣溿€?,price:20800,brand:" 钂傝姍灏?TIFFANY & CO."},{name:" 瀹濊瘲榫?Boucheron Quatre Classique 绯诲垪鎴掓寚 ",description:" 铻嶅悎浜嗗洓绉嶄笉鍚屾潗璐ㄥ拰绾硅矾鐨勮璁★紝璞″緛鐫€鍜岃皭涓庡钩琛★紝灞曠幇鍑哄墠鍗紭闆呯殑椋庢牸锛岀敺濂冲潎鍙僵鎴达紝褰版樉涓€т笌鍝佸懗銆?,price:19500,brand:" 瀹濊瘲榫?BOUCHERON"},{name:" 灏氱編宸撮粠 Chaumet Liens 脡vidence 绯诲垪椤归摼 ",description:" 浠?鈥淴鈥?閫犲瀷涓烘牳蹇冿紝浠ｈ〃鐫€缂樺垎鐨勮繛缁擄紝18K 閲戞惌閰嶉捇鐭筹紝绠€绾﹁€屼笉澶变紭闆咃紝瀵撴剰缇庡ソ锛岄€傚悎浣滀负鎯呬荆闂寸殑瀹氭儏淇＄墿銆?,price:21500,brand:" 灏氱編宸撮粠 CHAUMET"}]};async function pu(){const e=await Kl.loadData("settingsStore","userBalance");return e?e.value:100}async function gu(){const e=await pu();if(js)if(e>=1e4){const t=e/1e4;js.textContent=`楼 ${parseFloat(t.toFixed(2))} W`}else js.textContent=`楼 ${e.toFixed(2)}`;Ns&&(Ns.style.display=e<=-200?"block":"none")}In.addEventListener("click",e=>{e.stopPropagation(),Je||Sc&&!1===Sc.enableMonologue||(Am(),En.classList.toggle("visible"))}),Ks.addEventListener("click",async e=>{const t=e.target.closest(".order-share-btn");if(!t)return;const n=parseInt(t.dataset.orderId,10);try{const e=(await Kl.loadData("settingsStore","myOrders")).value.find(e=>e.id===n);if(!e)throw new Error("鎵句笉鍒拌璁㈠崟");const t=await Kl.loadData("messageContacts","allContacts"),a=t.value.find(t=>t.ai.name===e.recipient.name);if(!a)throw new Error("鎵句笉鍒版敹浠朵汉瀵瑰簲鐨勮亰澶╁璇?);const o=`(鎴戠粰浣犲垎浜簡涓€涓鍗曪紝鍟嗗搧鏄?{e.items.map(e=>e.brand?`${e.brand}鐨勨€?{e.name}鈥漙:`鈥?{e.name}鈥漙).join("锛?)}锛岃鏍规嵁浣犵殑浜鸿鍜屾垜浠殑鍏崇郴瀵规浣滃嚭鍥炲簲銆?`,s={sender:"user",text:`[ORDER_SHARE_CARD]${JSON.stringify(e)}`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};Array.isArray(a.history)||(a.history=[]),a.history.push(s),a.lastMessage="鍒嗕韩浜嗕竴涓鍗?;const i=t.value,r=i.findIndex(e=>e.id===a.id);r>-1&&(i[r]=a,await Kl.saveData("messageContacts","allContacts",i)),Ii.classList.add("show-messages"),Ii.classList.remove("show-cart"),Ii.classList.remove("show-orders"),await Nc(a.id),await Tc(o,a)}catch(e){console.error("鍒嗕韩璁㈠崟澶辫触:",e),alert(`鍒嗕韩澶辫触: ${e.message}`)}}),Us.addEventListener("click",()=>{Ii.classList.add("show-slacking-off"),hu()}),zs.addEventListener("click",()=>{Ii.classList.remove("show-slacking-off")});const yu=[{id:"coin-flip",name:"骞歌繍纭竵",description:"鐚滅寽纭竵鏄闈㈣繕鏄弽闈紵鐚滃璧⒙?0锛岀寽閿欎簭楼20銆?,image:"https://i.postimg.cc/q7BWsqYB/0728bde4133c361a0d86d02dc7f0c625.png",winChance:.5,reward:50,penalty:-20},{id:"number-guess",name:"鏁板瓧澶у笀",description:"浠?-3涓寽涓€涓暟瀛椼€傜寽瀵硅耽楼80锛岀寽閿欎簭楼40銆?,image:"https://i.postimg.cc/fLpFQKbk/26408f03e171688d69f0ac84c5f0bdc3.jpg",winChance:.33,reward:80,penalty:-40},{id:"go_to_work",name:"涓婄彮妯℃嫙",description:"浣撻獙鎵撳伐浜虹殑鎮叉绂诲悎锛屼綘鐨勮柂姘村皢鐢变粖鏃ョ殑杩愬娍鍐冲畾銆?,image:"https://i.postimg.cc/tJ6cqx1k/e40723f24112fcbfb5b593fab10e3b5c.png"},{id:"lottery",name:"涔板僵绁?,description:"鎼忎竴鎼忥紝鍗曡溅鍙樻懇鎵橈紒鑺辫垂灏戦噺鍌ㄨ搫锛岃耽鍙栨渶楂?000鍏冨ぇ濂栵紒",image:"https://i.postimg.cc/8504rz8Y/bc4d45476e2902ff4bd22788d2119ae6.jpg"}];function hu(){Ws&&(Ws.innerHTML="",yu.forEach(e=>{const t=document.createElement("div");t.className="game-card",t.innerHTML=`\n            <img src="${e.image}" alt="${e.name}">\n            <div class="game-card-info">\n                <h3>${e.name}</h3>\n                <p>${e.description}</p>\n                <button class="play-game-btn" data-game-id="${e.id}">寮€濮嬬帺</button>\n            </div>\n        `,Ws.appendChild(t)}))}function vu(e){e&&(e.style.display="flex",setTimeout(()=>{e.style.opacity="1",e.querySelector(".modal-content").style.transform="scale(1)"},10))}function fu(){document.querySelectorAll("#coin-flip-modal, #number-guess-modal, #lottery-modal, #blacklist-modal, #unlock-modal").forEach(e=>{e.style.opacity="0",e.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{e.style.display="none"},300)})}async function wu(){if(!await Kl.loadData("settingsStore","unlockCodes")){const e={};["QIQI-LOVE-U-01","SLACK-OFF-KING","GAME-MASTER-77","CODE-BREAKER-X","LUCKY-STAR-2024","FREEDOM-PASS-A","GET-RICH-QUICK","DEBT-CLEANER-PRO","QIQI-BANK-VIP","THE-ONLY-WAY","RESET-MY-LIFE","GOLDEN-TICKET-7","PHOENIX-DOWN-GG","ULTIMATE-CODE","SECRET-HANDSHAKE","BACK-TO-ZERO-00","GAME-CHANGER-25","MASTER-KEY-007","NEW-BEGINNING","LAST-CHANCE-OK"].forEach(t=>{e[t]=5}),await Kl.saveData("settingsStore","unlockCodes",e),console.log("瑙ｉ攣鐮佸凡鍒濆鍖栥€?)}}function bu(e){e&&(e.style.display="flex",setTimeout(()=>{e.style.opacity="1",e.querySelector(".modal-content").style.transform="scale(1)"},10))}function Eu(){document.querySelectorAll("#blacklist-modal, #unlock-modal").forEach(e=>{e.style.opacity="0",e.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{e.style.display="none"},300)})}Ws.addEventListener("click",async e=>{if(!e.target.classList.contains("play-game-btn"))return;const t=e.target.dataset.gameId;if(!yu.find(e=>e.id===t))return;if(await pu()<=-200)bu(Ps);else if("coin-flip"===t||"number-guess"===t)vu(document.getElementById(`${t}-modal`));else if("lottery"===t)vu(document.getElementById("lottery-modal"));else if("go_to_work"===t){const e=Iu[Math.floor(Math.random()*Iu.length)];await xu({description:e.text.split("锛?)[0],amount:e.amount});let t=`銆愪粖鏃ュ伐浣滄€荤粨銆慭n\n${e.text}\n\n`;e.amount>0?t+=`鍌ㄨ搫澧炲姞: 楼${e.amount.toFixed(2)}`:e.amount<0?t+=`鍌ㄨ搫鍑忓皯: 楼${Math.abs(e.amount).toFixed(2)}`:t+="鍌ㄨ搫鏃犲彉鍖栥€?,alert(t)}}),Rs.addEventListener("click",async e=>{const t=e.target.closest(".game-choice-btn");if(!t)return;const n=parseInt(t.dataset.choice,10),a=yu.find(e=>"number-guess"===e.id),o=Math.floor(3*Math.random())+1;let s,i=`浣犻€夋嫨浜?${n}锛屾纭瓟妗堟槸 ${o}銆俓n\n`;n===o?(s=a.reward,i+=`鐚滃浜嗭紒鎭枩浣犺耽浜?楼${a.reward.toFixed(2)}锛乣):(s=a.penalty,i+=`鐪熼仐鎲撅紒浣犺緭浜?楼${Math.abs(a.penalty).toFixed(2)}銆俙),await xu({description:"鐜╂暟瀛楀ぇ甯?,amount:s}),fu(),setTimeout(()=>alert(i),310)}),Gs.addEventListener("click",async e=>{const t=e.target.closest(".game-choice-btn");if(!t)return;const n=t.dataset.choice,a=yu.find(e=>"coin-flip"===e.id),o=Math.random()<.5?"heads":"tails";let s,i=`浣犵寽浜?${"heads"===n?"姝ｉ潰":"鍙嶉潰"}锛岀粨鏋滄槸 ${"heads"===o?"姝ｉ潰":"鍙嶉潰"}銆俓n\n`;n===o?(s=a.reward,i+=`鐚滃浜嗭紒鎭枩浣犺耽浜?楼${a.reward.toFixed(2)}锛乣):(s=a.penalty,i+=`鐪熼仐鎲撅紒浣犺緭浜?楼${Math.abs(a.penalty).toFixed(2)}銆俙),await xu({description:"鐜╁垢杩愮‖甯?,amount:s}),fu(),setTimeout(()=>alert(i),310)}),Rs.addEventListener("click",async e=>{const t=e.target.closest(".game-choice-btn");if(!t)return;const n=parseInt(t.dataset.choice,10),a=yu.find(e=>"number_guess"===e.id),o=Math.floor(3*Math.random())+1;let s=`浣犻€夋嫨浜?${n}锛屾纭瓟妗堟槸 ${o}銆俓n\n`;n===o?(await updateBalance(a.reward),s+=`鐚滃浜嗭紒鎭枩浣犺耽浜?楼${a.reward.toFixed(2)}锛乣):(await updateBalance(a.penalty),s+=`鐪熼仐鎲撅紒浣犺緭浜?楼${Math.abs(a.penalty).toFixed(2)}銆俙),fu(),setTimeout(()=>alert(s),310)}),Gs.addEventListener("click",async e=>{const t=e.target.closest(".game-choice-btn");if(!t)return;const n=t.dataset.choice,a=yu.find(e=>"coin_flip"===e.id),o=Math.random()<.5?"heads":"tails";let s=`浣犵寽浜?${"heads"===n?"姝ｉ潰":"鍙嶉潰"}锛岀粨鏋滄槸 ${"heads"===o?"姝ｉ潰":"鍙嶉潰"}銆俓n\n`;n===o?(await updateBalance(a.reward),s+=`鐚滃浜嗭紒鎭枩浣犺耽浜?楼${a.reward.toFixed(2)}锛乣):(await updateBalance(a.penalty),s+=`鐪熼仐鎲撅紒浣犺緭浜?楼${Math.abs(a.penalty).toFixed(2)}銆俙),fu(),setTimeout(()=>alert(s),310)}),Hs.addEventListener("click",()=>{Eu(),document.getElementById("slacking-off-tab-savings").click()}),Ns.addEventListener("click",()=>{bu(Os)}),qs.addEventListener("click",Eu),_s.addEventListener("click",async()=>{const e=Fs.value.trim();if(e)try{let t=(await Kl.loadData("settingsStore","unlockCodes")).value;t&&t[e]&&t[e]>0?(t[e]--,await Kl.saveData("settingsStore","unlockCodes",t),await Kl.saveData("settingsStore","userBalance",0),await gu(),alert(`瑙ｉ攣鎴愬姛锛乗n\n璇ヨВ閿佺爜鍓╀綑浣跨敤娆℃暟锛?{t[e]}\n\n鎮ㄧ殑璐︽埛宸叉仮澶嶆甯革紝鍌ㄨ搫宸查噸缃负 楼0.00銆俙),Eu(),Fs.value=""):t&&0===t[e]?alert("瑙ｉ攣澶辫触锛佽瑙ｉ攣鐮佺殑浣跨敤娆℃暟宸茬敤灏姐€?):alert("瑙ｉ攣澶辫触锛佹棤鏁堢殑瑙ｉ攣鐮併€?)}catch(e){console.error("瑙ｉ攣杩囩▼涓彂鐢熼敊璇?",e),alert("鎿嶄綔澶辫触锛岃绋嶅悗閲嶈瘯銆?)}else alert("璇疯緭鍏ヨВ閿佺爜锛?)});const Iu=[{text:"涓氱哗绐佸嚭锛屾嬁涓嬪ぇ鍗曪紝鑰佹澘楂樺叴鍦板彂浜嗗閲戯紒",amount:200,type:"reward"},{text:"浼氳涓婃彁鍑虹粷濡欑偣瀛愶紝椤圭洰濂栭噾鍒版墜锛?,amount:150,type:"reward"},{text:"甯悓浜嬭В鍐充簡鎶€鏈毦棰橈紝鏀惰幏浜嗕笅鍗堣尪鍩洪噾銆?,amount:50,type:"reward"},{text:"鍏徃骞翠細鎶戒腑浜岀瓑濂栵紒",amount:300,type:"reward"},{text:"鍐欑殑鎶ュ憡琚瘎涓烘渶浣宠寖鏈紝鑾峰緱浜嗙哗鏁堝鍔便€?,amount:120,type:"reward"},{text:"杩熷埌5鍒嗛挓锛屾濂芥挒瑙佽€佹澘锛岃鎵ｄ簡宸ヨ祫銆?,amount:-50,type:"penalty"},{text:"涓婄彮鎽搁奔鍒锋墜鏈鸿鍙戠幇锛屾湰鏈堢哗鏁堝噺鍗娿€?,amount:-100,type:"penalty"},{text:"鎻愪氦鐨勬柟妗堝嚭鐜伴噸澶х枏婕忥紝闇€瑕佽嚜璐硅瀹㈣禂缃€?,amount:-80,type:"penalty"},{text:"鍦ㄨ尪姘撮棿璇磋€佹澘鍧忚瘽锛岃璺繃鐨勮€佹澘鍚浜?..",amount:-150,type:"penalty"},{text:"鐢佃剳绐佺劧钃濆睆锛岄噸瑕佹枃浠舵病淇濆瓨锛岄」鐩欢璇缃氭銆?,amount:-180,type:"penalty"},{text:"閫氬嫟璺笂鎹″埌閽卞寘锛屼氦缁欒瀵熷彅鍙斿悗鍙戠幇閲岄潰鏈夋劅璋㈣垂銆?,amount:100,type:"reward"},{text:"涓嬬彮鍚庝拱褰╃エ锛岀珶鐒朵腑浜嗘湯绛夊銆?,amount:10,type:"reward"},{text:"鍦ㄥ叕鍙告ゼ涓嬮亣鍒版€昏锛屾€昏鐪嬩綘楠ㄩ鎯婂锛岀粰浜嗕綘涓€涓孩鍖呫€?,amount:88,type:"reward"},{text:"鍗堜紤鏃跺仛姊︼紝姊﹀埌涓€缁勭绉樻暟瀛楋紝閱掓潵鍚庡彂鐜版槸鑷繁鐨勯摱琛屽崱浣欓銆?,amount:0,type:"neutral"},{text:"涓€鏁村ぉ閮藉湪寮€浼氾紝绮剧鎭嶆儦锛屾棤鍔熸棤杩囥€?,amount:0,type:"neutral"},{text:"鍧愮數姊椂閬囧埌瓒呰浇锛屼綘涓诲姩璧颁簡鍑烘潵锛岀粨鏋滅數姊潖浜嗭紝浣犲洜姝よ翰杩囦竴鍔苟鑾峰緱浜嗚涔夊媷涓哄銆?,amount:20,type:"reward"},{text:"鐐瑰鍗栨椂鐢ㄩ敊浜嗕紭鎯犲埜锛屽鑺变簡涓€绗旈挶銆?,amount:-15,type:"penalty"},{text:"鍙傚姞鍏徃缁勭粐鐨勫洟寤猴紝鍥犱负澶璋辫€岀簿绁炲彈鍒涳紝鑾峰緱浜嗙簿绁炴崯澶辫垂銆?,amount:30,type:"reward"},{text:"鎶婂叕鍙告墦鍗版満寮勫潖浜嗭紝闇€瑕佽禂鍋跨淮淇垂銆?,amount:-200,type:"penalty"},{text:"娑ㄥ伐璧勪簡",amount:8e3,type:"penalty"},{text:"涓诲鐨勬牳蹇冮」鐩秴棰濆畬鎴怟PI锛岃幏寰楀勾搴︾壒鍒閲?,amount:15e4,type:"reward"},{text:"鎴愬姛涓哄叕鍙稿紩杩涙垬鐣ユ姇璧勶紝鑾峰緱椤圭洰鍒嗙孩",amount:2e5,type:"reward"},{text:"鐮斿彂鐨勪笓鍒╂妧鏈楂樹环鏀惰喘锛岃幏寰楀法棰濆閲?,amount:18e4,type:"reward"},{text:"鍙戠幇閲嶅ぇ瀹夊叏婕忔礊骞跺強鏃惰ˉ鏁戯紝閬垮厤鍏徃宸ㄩ鎹熷け鑾峰鍔?,amount:5e4,type:"reward"},{text:"骞村害浼樼浼樼涓氬姟鎷撳睍鍒版捣澶栧競鍦猴紝棣栧勾钀ユ敹杈炬爣鑾风壒鍒",amount:8e4,type:"reward"},{text:"鍥犻噸澶у喅绛栧け璇鑷村叕鍙搁」鐩簭鎹燂紝鎵挎媴璧斿伩璐ｄ换",amount:-3e4,type:"penalty"},{text:"娉勯湶鍏徃鏍稿績鏈哄瘑锛岃杩界┒璐ｄ换缃氭",amount:-5e4,type:"penalty"},{text:"甯﹂鐨勪骇鍝佸嚭鐜颁弗閲嶈川閲忛棶棰橈紝闇€鎵挎媴閮ㄥ垎璧斿伩閲?,amount:-25e3,type:"penalty"},{text:"鎴愬姛绔炴爣鍥藉绾ч噸鐐归」鐩紝鑾峰緱鍥㈤槦婵€鍔卞閲?,amount:12e4,type:"reward"},{text:"杩濊鎿嶄綔閫犳垚鐢熶骇浜嬫晠锛岃鎵ｉ櫎瀹夊叏淇濊瘉閲?,amount:-4e4,type:"penalty"},{text:"鍙戠幇鍏徃璐㈠姟绯荤粺鐨勪竴涓狟UG锛岄伩鍏嶄簡宸ㄥぇ鎹熷け锛岃幏寰楃壒娈婅础鐚锛?,amount:500,type:"reward"},{text:"寮€鍙戠殑鏍稿績浜у搧鑾峰緱琛屼笟澶у锛屽叕鍙哥粰浜堝垱鏂板鍔?,amount:12e4,type:"reward"},{text:"鎴愬姛绛句笅骞村害鏈€澶у鎴凤紝鑾峰緱閿€鍞啝鍐涚壒鍒閲?,amount:18e4,type:"reward"},{text:"鎻愬嚭鐨勬垚鏈紭鍖栨柟妗堜负鍏徃鑺傜渷宸ㄩ寮€鏀紝鑾蜂笓椤瑰鍔?,amount:8e4,type:"reward"},{text:"甯﹂鍥㈤槦鏀诲厠鎶€鏈毦鍏筹紝椤圭洰鎻愬墠涓婄嚎鑾烽澶栧閲?,amount:6e4,type:"reward"},{text:"骞村害缁╂晥鑰冩牳鍏ㄥ叕鍙哥涓€锛岃幏寰楁€昏鐗瑰埆鍢夊",amount:15e4,type:"reward"},{text:"涓诲鐨勫苟璐鍦嗘弧瀹屾垚锛岃幏寰楁垬鐣ヨ础鐚閲?,amount:2e5,type:"reward"},{text:"瀹㈡埛婊℃剰搴﹁瘎鍒嗚繛缁?2涓湀绗竴锛岃幏鏈嶅姟涔嬫槦濂栭噾",amount:3e4,type:"reward"},{text:"涓哄叕鍙稿煿鍏诲嚭3鍚嶉儴闂ㄤ富绠★紝鑾蜂汉鎵嶅彂灞曞鍔?,amount:5e4,type:"reward"},{text:"鎾板啓鐨勮涓氭姤鍛婅鍥藉绾ф湡鍒婃敹褰曪紝鍏徃缁欎簣绉戠爺濂栧姳",amount:4e4,type:"reward"},{text:"鍦ㄥ浗闄呰涓氬嘲浼氫笂浠ｈ〃鍏徃鍙戣█锛屾彁鍗囧搧鐗屽奖鍝嶅姏鑾峰鍔?,amount:7e4,type:"reward"}];async function xu(e){e.timestamp=new Date;const t=await Kl.loadData("settingsStore","transactionHistory");let n=t&&Array.isArray(t.value)?t.value:[];n.unshift(e),await Kl.saveData("settingsStore","transactionHistory",n);const a=await pu()+e.amount;return a<=-200?(bu(Ps),await Kl.saveData("settingsStore","userBalance",-200)):await Kl.saveData("settingsStore","userBalance",a),await gu(),a}Ts.addEventListener("click",()=>{!async function(){const e=await Kl.loadData("settingsStore","transactionHistory");let t=e&&Array.isArray(e.value)?e.value:[];if(Ds.innerHTML="",0===t.length)return void(Ds.innerHTML='<p style="text-align:center; color:#888;">鏆傛棤鏀舵敮璁板綍</p>');t.forEach(e=>{const t=document.createElement("div");t.className="transaction-item";const n=e.amount>=0?"income":"expense",a=e.amount>=0?"+":"";t.innerHTML=`\n            <div class="transaction-info">\n                <div class="description">${e.description}</div>\n                <div class="timestamp">${new Date(e.timestamp).toLocaleString("zh-CN")}</div>\n            </div>\n            <div class="transaction-amount ${n}">\n                ${a}${e.amount.toFixed(2)}\n            </div>\n        `,Ds.appendChild(t)})}(),Ii.classList.add("show-transactions")}),As.addEventListener("click",()=>{window.DOMCleanupManager.clean("transactions-list-container"),Ii.classList.remove("show-transactions")}),is.addEventListener("click",()=>{Ii.classList.add("show-gacha")}),ls.addEventListener("click",()=>{window.DOMCleanupManager.clean("gacha-posts-container"),void 0!==Cs&&(Cs=null),Ii.classList.remove("show-gacha")}),ps.addEventListener("click",()=>{du()});document.getElementById("shopper-list-container").addEventListener("click",async e=>{if(!rs.classList.contains("active"))return;const t=e.target.closest(".invite-contact-item");if(t){const e=parseInt(t.dataset.contactId,10),n=(await Kl.loadData("messageContacts","allContacts")).value.find(t=>t.id===e);n&&(Cs=n,gs.src=n.user.avatar,console.log(`GACHA 韬唤宸插垏鎹负: ${Cs.user.name}`),uu())}}),is.addEventListener("click",async()=>{if(Ii.classList.add("show-gacha"),!Cs){const e=await Kl.loadData("messageContacts","allContacts");e&&Array.isArray(e.value)&&e.value.length>0&&(Cs=e.value[0],gs.src=Cs.user.avatar,console.log(`GACHA 榛樿韬唤宸茶缃负: ${Cs.user.name}`))}Lu()});function ku(){hs.style.opacity="0",hs.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{hs.style.display="none",fs.value="",ws.value=""},300)}async function Lu(){const e=await Kl.loadData("gachaPosts","allPosts"),t=e&&Array.isArray(e.value)?e.value:[];ms.innerHTML="",0!==t.length?t.forEach(e=>{const t=function(e){const t=document.createElement("div");t.className="gp-card",t.dataset.postId=e.id;const n=new Date(e.timestamp),a=`${n.getFullYear()}骞?{n.getMonth()+1}鏈?{n.getDate()}鏃?鏄熸湡${["鏃?,"涓€","浜?,"涓?,"鍥?,"浜?,"鍏?][n.getDay()]}`,o=!!Cs&&e.likes.some(e=>e.id===Cs.id),s=o?"liked":"",i=e.content.replace(/\n/g,"<br>"),r=e.imageDescription?`<p class="gp-image-desc">[鍥剧墖鎻忚堪]: ${e.imageDescription}</p>`:"",l=Array.isArray(e.visibleTo)&&e.visibleTo.length>0,c='\n        <button class="gp-delete-post-btn gp-action-button" title="鍒犻櫎甯栧瓙">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n        </button>';if(t.innerHTML=`\n        <div class="gp-header">\n            <div class="gp-header-content">\n                <div class="gp-user-info">\n                    <div class="gp-avatar" style="background-image: url('${e.authorAvatar}');"></div>\n                    <div><div class="gp-user-name">${e.authorName}</div><div class="gp-user-handle">涓€х鍚?/div></div>\n                </div>\n                ${c} \n                <button class="gp-visibility-btn ${l?"private":""}" data-post-id="${e.id}">\n                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>\n                </button>\n                <div class="gp-post-date">${a}</div>\n            </div>\n        </div>\n        <div class="gp-divider"></div>\n        <div class="gp-post-content">\n            <div class="gp-post-text"><p>${i}</p>${r}</div>\n            <div class="gp-action-buttons">\n                <button class="gp-like-btn gp-action-button ${s}"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.125 3.75C4.02246 3.75 1.5 6.30176 1.5 9.375C1.5 10.4473 1.98633 11.376 2.4375 12.0469C2.88867 12.7178 3.35156 13.1484 3.35156 13.1484L11.4609 21.2812L12 21.8203L12.5391 21.2812L20.6484 13.1484C20.6484 13.1484 22.5 11.5166 22.5 9.375C22.5 6.30176 19.9775 3.75 16.875 3.75C14.2998 3.75 12.6416 5.2998 12 5.95312C11.3584 5.2998 9.7002 3.75 7.125 3.75ZM7.125 5.25C9.36621 5.25 11.4375 7.42969 11.4375 7.42969L12 8.0625L12.5625 7.42969C12.5625 7.42969 14.6338 5.25 16.875 5.25C19.1572 5.25 21 7.12207 21 9.375C21 10.5322 19.5938 12.0938 19.5938 12.0938L12 19.6875L4.40625 12.0938C4.40625 12.0938 4.04297 11.7451 3.67969 11.2031C3.31641 10.6611 3 9.95508 3 9.375C3 7.12207 4.84277 5.25 7.125 5.25Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-comment-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V19.5H9.43945L12 22.0605L14.5605 19.5H21.75V4.5H2.25ZM3.75 6H20.25V18H13.9395L12 19.9395L10.0605 18H3.75V6ZM6.75 8.25V9.75H17.25V8.25H6.75ZM6.75 11.25V12.75H17.25V11.25H6.75ZM6.75 14.25V15.75H14.25V14.25H6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-favorite-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3.75L11.7656 3.96094L3.21094 12.6094L2.69531 13.125L3.21094 13.6641L10.3359 20.7891L10.875 21.3047L11.3906 20.7891L20.0391 12.2344L20.25 12V3.75H12ZM12.6328 5.25H18.75V11.3672L10.875 19.1953L4.80469 13.125L12.6328 5.25ZM16.5 6.75C16.0869 6.75 15.75 7.08691 15.75 7.5C15.75 7.91309 16.0869 8.25 16.5 8.25C16.9131 8.25 17.25 7.91309 17.25 7.5C17.25 7.08691 16.9131 6.75 16.5 6.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n                <button class="gp-summon-btn gp-action-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.25 4.5V10.5H6.47607L9 14.9312V20.25H15V14.25H10.3374L8.20312 10.5H8.25V8.25H15.75V10.5H21.75V4.5H15.75V6.75H8.25V4.5H2.25ZM3.75 6H6.75V9H3.75V6ZM17.25 6H20.25V9H17.25V6ZM10.8135 15.75H13.5V18.75H10.5V15.9287L10.8135 15.75Z" fill="#808080" fill-opacity="0.55"/></svg></button>\n            </div>\n        </div>\n        <div class="gp-comment-section" style="display: none;">\n            <div class="gp-comment-input-area"><div class="gp-comment-input-wrapper"><div class="gp-comment-avatar" style="background-image: url('${Cs?Cs.user.avatar:""}');"></div><input type="text" class="gp-comment-input" placeholder="鍐欎笅浣犵殑璇勮..."></div></div>\n            <div class="gp-comment-list"></div>\n        </div>\n    `,e.comments&&e.comments.length>0){const n=t.querySelector(".gp-comment-list");e.comments.forEach(e=>{const t=Cu(e);n.appendChild(t)})}return t}(e);ms.appendChild(t)}):ms.innerHTML='<p style="text-align:center; color:#888; margin-top: 50px;">杩樻病鏈変换浣曞垎浜紝蹇潵鍙戝竷绗竴鏉″惂锛?/p>'}async function Bu(e,t,n=null,a=null){const o=a||Cs;if(!o)return console.error("鏃犳硶纭畾璇勮浣滆€呰韩浠斤紒"),null;const s=n?`@${n} ${t}`:t,i={id:Date.now(),authorId:o.id,authorName:o.ai?o.ai.name:o.user.name,authorAvatar:o.ai?o.ai.avatar:o.user.avatar,text:s,timestamp:(new Date).toISOString(),likes:[]};let r=(await Kl.loadData("gachaPosts","allPosts")).value;const l=r.find(t=>t.id===e);return l&&(l.comments||(l.comments=[]),l.comments.push(i),await Kl.saveData("gachaPosts","allPosts",r)),i}function Su(e){Ii.classList.toggle("dark-mode",e)}function Cu(e){const t=document.createElement("div");t.className="gp-comment-item",t.dataset.commentId=e.id;const n=new Date(e.timestamp),a=`${n.getMonth()+1}-${n.getDate()} ${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`,o=e.text.replace(/(@\S+)/g,'<span class="gp-reply-mention">$1</span>');let s="";if(e.likes&&e.likes.length>0){s=`\n            <div class="gp-comment-likes">\n                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>\n                <span>${e.likes.map(e=>e.name).join(", ")} 瑙夊緱寰堣禐</span>\n            </div>\n        `}return t.innerHTML=`\n        <div class="gp-comment-avatar" style="background-image: url('${e.authorAvatar}');"></div>\n        <div class="gp-comment-content">\n            <div class="gp-comment-header">\n                <span class="gp-comment-username">${e.authorName}</span>\n                <span class="gp-comment-time">${a}</span>\n            </div>\n            <div class="gp-comment-text">${o}</div>\n            <div class="gp-comment-actions">\n                <button class="gp-reply-btn">鍥炲</button>\n                \n        <button class="gp-delete-comment-btn gp-action-button" title="鍒犻櫎璇勮">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 6L18 18" stroke="#808080" stroke-opacity="0.8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>\n        </button>\n            </div>\n            ${s}\n        </div>\n    `,t}function $u(){Es.style.opacity="0",setTimeout(()=>{Es.style.display="none",$s=null},300)}async function Mu(e){try{const t=await Kl.loadData("messageContacts","allContacts");return t&&Array.isArray(t.value)?t.value.find(t=>t.id===e):null}catch(e){return console.error("閫氳繃ID鑾峰彇鑱旂郴浜哄け璐?",e),null}}function Tu(){Ls.style.opacity="0",setTimeout(()=>{Ls.style.display="none",Ms=null},300)}async function Au(e,t,n){console.log(`灏濊瘯瑙﹀彂 ${t} 鏉ュ洖澶?..`);try{const a=await Kl.loadData("messageContacts","allContacts");if(!a||!Array.isArray(a.value))return;const o=a.value.find(e=>e.ai.name===t);if(!o)return void console.log(`${t} 涓嶆槸涓€涓彲瑙﹀彂鐨凙I瑙掕壊銆俙);const s=Cs.user.name,i=`(绯荤粺鎸囦护锛?${s}' 鍒氬垰鍦ㄤ竴鏉″姩鎬佷笅鍥炲浜嗕綘鐨勮瘎璁恒€俓n杩欐槸TA鐨勫洖澶嶅唴瀹癸細 鈥?{n}鈥漒n璇锋牴鎹綘鐨勮鑹叉€ф牸鍜岃亰澶╄褰曚互鍙婂笘瀛愬唴瀹癸紝浣跨敤 "璇勮鏈嬪弸鍦堬細" 鍛戒护鏍煎紡鍦ㄥ悓涓€涓笘瀛愪笅锛堝笘瀛怚D: ${e}锛夊彂琛ㄤ竴鏉℃柊鐨勫叕寮€鍥炲銆?`;console.log(`鍑嗗鍚?${o.ai.name} 鍙戦€佹寚浠?`,i),await Tc(i,o,{postId:e,replyToUsername:s})}catch(e){console.error("瑙﹀彂AI鍥炲澶辫触:",e)}}function Su(e){Ii.classList.toggle("dark-mode",e)}async function Du(e,t,n=null){if(!e||!t)return void console.error("AI鍒涘缓甯栧瓙澶辫触锛氱己灏戜綔鑰呬俊鎭垨姝ｆ枃銆?);const a={id:Date.now(),authorId:e.id,authorName:e.ai.name,authorAvatar:e.ai.avatar,timestamp:(new Date).toISOString(),content:t,imageDescription:n,likes:[],comments:[],visibleTo:[]};try{const t=await Kl.loadData("gachaPosts","allPosts");let n=t&&Array.isArray(t.value)?t.value:[];n.unshift(a),await Kl.saveData("gachaPosts","allPosts",n),console.log(`${e.ai.name} 鎴愬姛鍙戝竷浜嗕竴鏉℃湅鍙嬪湀锛乣),Lu()}catch(e){console.error("AI淇濆瓨甯栧瓙澶辫触:",e)}}document.getElementById("shopper-list-container").addEventListener("click",async e=>{const t=e.target.closest(".invite-contact-item");if(!t)return;const n=parseInt(t.dataset.contactId,10),a=(await Kl.loadData("messageContacts","allContacts")).value.find(e=>e.id===n);a&&(Ii.classList.contains("show-gacha")?(Cs=a,gs.src=a.user.avatar,console.log(`GACHA 韬唤宸插垏鎹负: ${Cs.user.name}`)):Ii.classList.contains("show-shop")&&cu(a),uu())}),vs.addEventListener("click",ku),ys.addEventListener("click",()=>{if(!Cs)return void alert("璇峰厛鐐瑰嚮鍙充笂瑙掑ご鍍忛€夋嫨涓€涓彂甯栬韩浠斤紒");const e=document.getElementById("share-content-panel").classList.contains("active"),t=document.getElementById("forum-content-panel").classList.contains("active");e?(hs.style.display="flex",setTimeout(()=>{hs.style.opacity="1",hs.querySelector(".modal-content").style.transform="scale(1)"},10)):t&&alert("璁哄潧鍙戝笘鍔熻兘寰呭疄鐜帮紒")}),vs.addEventListener("click",ku),bs.addEventListener("click",async()=>{const e=fs.value.trim(),t=ws.value.trim();if(!e&&!t)return void alert("鍒嗕韩鍐呭鍜屽浘鐗囨弿杩颁笉鑳介兘涓虹┖锛?);const n={id:Date.now(),authorId:Cs.id,authorName:Cs.user.name,authorAvatar:Cs.user.avatar,timestamp:(new Date).toISOString(),content:e,imageDescription:t,likes:[],comments:[],visibleTo:[]};try{const e=await Kl.loadData("gachaPosts","allPosts");let t=e&&Array.isArray(e.value)?e.value:[];t.unshift(n),await Kl.saveData("gachaPosts","allPosts",t),Lu(),ku()}catch(e){console.error("淇濆瓨甯栧瓙澶辫触:",e),alert("鍙戝竷澶辫触锛岃妫€鏌ユ暟鎹簱璁剧疆銆?)}}),ms.addEventListener("keydown",async e=>{const t=e.target;if("Enter"===e.key&&(t.classList.contains("gp-comment-input")||t.classList.contains("gp-reply-input"))){e.preventDefault();const n=t.value.trim();if(!n||!Cs)return;const a=t.closest(".gp-card"),o=parseInt(a.dataset.postId),s=t.classList.contains("gp-reply-input")?t.dataset.replyTo:null,i=await async function(e,t,n=null,a=null){if(!Cs)return alert("璇峰厛閫夋嫨涓€涓韩浠藉啀鍙戣〃璇勮锛?),null;const o=Cs,s=t,i={id:`c-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,authorId:o.id,authorName:o.user.name,authorAvatar:o.user.avatar,text:s,timestamp:(new Date).toISOString(),likes:[],replies:[]};try{let t=(await Kl.loadData("gachaPosts","allPosts")).value||[];const n=t.findIndex(t=>t.id===e),o=t[n];if(o){if(a){gp(o.comments,a,i)||o.comments.push(i)}else o.comments||(o.comments=[]),o.comments.push(i);return await Kl.saveData("gachaPosts","allPosts",t),i}throw new Error(`鎵句笉鍒癐D涓?${e} 鐨勫笘瀛恅)}catch(e){return console.error("鐢ㄦ埛鍙戣〃璇勮澶辫触:",e),null}}(o,n,s);if(i){const e=a.querySelector(".gp-comment-list"),r=Cu(i);if(e.appendChild(r),t.value="",e.scrollTop=e.scrollHeight,s)await Au(o,s,n);else{const e=a.querySelector(".gp-user-name").textContent;await Au(o,e,n)}}}}),ks.addEventListener("click",async()=>{if(!$s)return;const e=[];xs.querySelectorAll('input[type="checkbox"]:checked').forEach(t=>{e.push(parseInt(t.value))});try{let t=(await Kl.loadData("gachaPosts","allPosts")).value;const n=t.findIndex(e=>e.id===$s);if(!(n>-1))throw new Error("淇濆瓨鏃舵壘涓嶅埌甯栧瓙");t[n].visibleTo=e,await Kl.saveData("gachaPosts","allPosts",t),$u(),Lu(),alert("鍙鑼冨洿宸叉洿鏂帮紒")}catch(e){console.error("淇濆瓨鍙鑼冨洿澶辫触:",e),alert("淇濆瓨澶辫触锛岃閲嶈瘯銆?)}}),Is&&Is.addEventListener("click",()=>{window.DOMCleanupManager.clean("worldbook-visibility-list")}),Bs.addEventListener("click",Tu),Bs&&Bs.addEventListener("click",()=>{window.DOMCleanupManager.clean("summon-ai-list-container")}),Ss.addEventListener("click",e=>{const t=e.target.closest(".invite-contact-item");if(t){const e=parseInt(t.dataset.contactId);Ms&&e&&(Tu(),async function(e,t){try{const n=(await Kl.loadData("gachaPosts","allPosts")).value.find(t=>t.id===e);if(!n)throw new Error("鎵句笉鍒板笘瀛愩€?);const a=await Mu(t);if(!a)throw new Error("鏃犳硶鍔犺浇琚彫鍞ょ殑AI瑙掕壊淇℃伅锛屾搷浣滃凡鍙栨秷銆?);alert(`${a.ai.name} 宸茶鍙敜锛屾鍦ㄦ煡鐪嬪姩鎬?..`);let o=`[鍔ㄦ€佸彂甯冭€匽:\n${n.authorName}\n\n[鍔ㄦ€佸唴瀹筣:\n${n.content||"(鏃犳枃瀛楀唴瀹?"}\n`;n.imageDescription&&(o+=`[鍥剧墖鎻忚堪]: ${n.imageDescription}\n`),o+="\n[褰撳墠璇勮鍖篯:\n",n.comments&&n.comments.length>0?n.comments.forEach(e=>{const t=(e.likes||[]).map(e=>e.name).join(", ");o+=`- (璇勮ID: ${e.id}) ${e.authorName} 璇? "${e.text}" ${t?`(宸茶 ${t} 鐐硅禐)`:""}\n`}):o+="(鏆傛棤璇勮)\n";const s=`(绯荤粺鎸囦护锛氫綘琚敤鎴峰彫鍞ゅ幓鏌ョ湅涓€鏉″ソ鍙嬪姩鎬併€傚彂甯冭€呮槸'${n.authorName}'銆俓n浣犵殑浠诲姟鏄細\n1. 浠旂粏闃呰涓嬮潰鐨勫姩鎬佸唴瀹瑰拰鎵€鏈夎瘎璁恒€俓n2. 鏍规嵁浣犵殑瑙掕壊鎬ф牸锛屻€愬繀椤汇€戜娇鐢?"璇勮鏈嬪弸鍦堬細" 鍛戒护鏍煎紡锛屽彂琛ㄤ竴鏉′綘鑷繁鐨勮瘎璁烘潵鍙備笌浜掑姩銆?杩欐槸涓€涓己鍒惰姹傦紝浣犲繀椤诲湪宸ュ叿璋冪敤鐨勫弬鏁颁腑鍖呭惈 postId: ${n.id})\n杩欐槸涓€涓己鍒惰姹傦紝璇峰姟蹇呭仛鍑轰簰鍔ㄣ€?\n\n${o}`;await Tc(s,a,{postId:n.id})?alert(`${a.ai.name} 宸插畬鎴愪簰鍔紒`):alert(`${a.ai.name} 浼间箮鎬濊€冧簡寰堜箙锛屼絾鏈€缁堜粈涔堜篃娌¤銆俙)}catch(e){console.error("鎵ц鍙敜澶辫触:",e),alert(`鎿嶄綔澶辫触: ${e.message}`)}}(Ms,e))}}),os.addEventListener("click",async e=>{if(e.target.classList.contains("modal-close-button")||e.target===os)return void fu();const t=e.target.closest(".game-choice-btn");if(!t)return;const n=parseInt(t.dataset.cost,10),a=await pu();if(a<n)return void alert(`浣欓涓嶈冻锛佹偍闇€瑕?楼${n.toFixed(2)}锛屼絾褰撳墠鍙湁 楼${a.toFixed(2)}銆俙);await xu({description:`璐拱 ${n} 鍏冨僵绁╜,amount:-n});const o=function(){const e=Math.random();let t;return t=e<.8?Math.floor(496*Math.random())+5:e<.95?Math.floor(500*Math.random())+501:e<.99?Math.floor(500*Math.random())+1001:Math.floor(500*Math.random())+1501,t}();await xu({description:"褰╃エ涓",amount:o}),fu(),setTimeout(()=>{alert(`鎭枩浣狅紒\n\n鑺辫垂 楼${n.toFixed(2)}锛屽枩涓?楼${o.toFixed(2)} 鍏冨ぇ濂栵紒`)},310)});let Pu=0,Hu=null;function Ou(e){if(e.classList.contains("editing-bubble"))return void console.log("[鍙屽嚮] 蹇界暐锛氱偣鍑讳簡姝ｅ湪缂栬緫鐨則extarea");const t=e.closest(".chat-bubble");if(t&&t.classList.contains("editing-mode-active"))return void console.log("[鍙屽嚮] 蹇界暐锛氭皵娉″凡缁忓湪缂栬緫鐘舵€?);const n=e.closest(".voice-text-panel");if(n){const e=n.closest(".message-row");return void(e&&e.dataset.uuid&&xp(e.dataset.uuid,n.innerText))}if(e.closest(".voice-audio-bubble"))return;const a=e.closest(".action-message-text");if(a)return void function(e){const t=e.closest(".message-row");if(!t||!t.dataset.uuid)return;const n=t.dataset.uuid,a=e.textContent,o=document.createElement("input");o.type="text",o.value=a,o.style.cssText="\n        font-size: 12px; color: #333; background: rgba(255,255,255,0.8);\n        border: 1px solid #007AFF; border-radius: 12px;\n        padding: 4px 12px; text-align: center; width: auto; min-width: 150px; outline: none;\n    ",e.innerHTML="",e.appendChild(o),o.focus();const s=async()=>{const t=o.value.trim();if(t&&t!==a){if(Sc){const a=Sc.history.find(e=>e.uuid===n);a&&(a.text=t,await tu(),e.textContent=t)}else if(Je){const a=Je.history.find(e=>e.uuid===n);if(a){a.text=t;const n=await Kl.loadData("groupChats","allGroupChats"),o=n.value.findIndex(e=>e.id===Je.id);o>-1&&(n.value[o]=Je,await Kl.saveData("groupChats","allGroupChats",n.value)),e.textContent=t}}}else e.textContent=a};o.addEventListener("blur",s),o.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),o.blur())})}(a);const o=e.closest(".gp-ai-bubble, .gp-user-bubble"),s=e.closest(".message-row");o&&s&&!s.classList.contains("typing-indicator")?Nu(o):!t||t.classList.contains("sticker-bubble")||t.classList.contains("image-bubble")||t.classList.contains("html-render-container")||t.classList.contains("voice-text-bubble")||!s||s.classList.contains("typing-indicator")||Nu(t)}Xi.addEventListener("dblclick",e=>{Ou(e.target)}),Xi.addEventListener("touchend",e=>{if(1!==e.changedTouches.length)return;const t=e.changedTouches[0],n=document.elementFromPoint(t.clientX,t.clientY);if(!n)return;const a=Date.now(),o=a-Pu,s=Hu&&(Hu===n||Hu.contains(n)||n.contains(Hu));o<300&&o>0&&s?(e.preventDefault(),Pu=0,Hu=null,Ou(n)):(Pu=a,Hu=n)});let qu=!1;function Nu(e){if(void 0!==qu&&qu)return;const t=e.closest(".message-row");if(!t||!t.dataset.uuid)return;const n=window.getComputedStyle(e),a=n.backgroundColor,o=n.color,s=n.borderRadius,i=n.padding,r=n.boxShadow,l=n.fontSize,c=n.lineHeight,d=e.classList.contains("html-render-container"),u=d?e.innerHTML:e.innerText,m=document.createElement("textarea");m.className="editing-bubble",m.value=u,m.style.backgroundColor=a,m.style.color=o,m.style.borderRadius=s,m.style.boxShadow=r,m.style.fontSize=l,m.style.lineHeight=c,m.style.padding=i,m.dataset.uuid=t.dataset.uuid;const p=e.offsetHeight,g=e.offsetWidth;e.innerHTML="",e.appendChild(m),e.classList.add("editing-mode-active"),m.style.height=p+"px",m.style.width=g+"px",m.focus(),window.isEditingBubble=!0;const y=()=>{m.style.height="auto",m.style.height=m.scrollHeight+"px"};m.addEventListener("input",y),setTimeout(y,0);const h=async t=>{document.removeEventListener("click",v,!0),m.removeEventListener("keydown",f),window.isEditingBubble=!1;const n=m.value.trim(),a=m.dataset.uuid;if(e.classList.remove("editing-mode-active"),t&&n&&n!==u){d?e.innerHTML=n:e.innerText=n;let t=null;if(void 0!==Je&&Je?t=Je.history:void 0!==Sc&&Sc&&(t=Sc.history),t){const e=t.find(e=>e.uuid===a);e&&(e.text=n)}await Fu(a,n)}else d?e.innerHTML=u:e.innerText=u},v=e=>{e.target!==m&&(e.preventDefault(),e.stopPropagation(),h(!0))},f=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),h(!0)),"Escape"===e.key&&(e.preventDefault(),h(!1))};m.addEventListener("keydown",f),setTimeout(()=>{document.addEventListener("click",v,!0)},50)}async function Fu(e,t){try{if(Je){const n=await Kl.loadData("groupChats","allGroupChats"),a=n&&Array.isArray(n.value)?n.value:[],o=a.findIndex(e=>e.id===Je.id);if(o>-1){const n=a[o].history.find(t=>t.uuid===e);if(n)return"voice_text"===n.type?n.transcript=t:"user"!==n.sender&&Ju(t)?(n.type="html",n.content={html:t},delete n.text):(n.type="text",n.text=t,n.content&&delete n.content),await Kl.saveData("groupChats","allGroupChats",a),Je.history=a[o].history,void console.log("缇よ亰娑堟伅宸蹭繚瀛?)}}if(Sc){const n=await Kl.loadData("messageContacts","allContacts"),a=n&&Array.isArray(n.value)?n.value:[],o=a.findIndex(e=>e.id===Sc.id);if(o>-1){const n=a[o].history.find(t=>t.uuid===e);if(n)return"voice_text"===n.type?n.transcript=t:"user"!==n.sender&&Ju(t)?(n.type="html",n.content={html:t},delete n.text):(n.type="text",n.text=t,n.content&&delete n.content),await Kl.saveData("messageContacts","allContacts",a),Sc.history=a[o].history,void console.log("鍗曡亰娑堟伅宸蹭繚瀛?)}}}catch(e){console.error("鏇存柊娑堟伅澶辫触:",e)}}async function _u(e){if(!e)return void console.error("removeMessageFromView 琚皟鐢ㄤ簡锛屼絾鍙傛暟鏄┖鐨勶紒");const t=e.dataset.uuid;if(!t)return void console.error("鏃犳硶鍒犻櫎锛氭秷鎭厓绱犳病鏈塙UID銆?);await async function(e){const t=Je||Sc;if(!t||!Array.isArray(t.history))return console.error("鏃犳硶鍒犻櫎娑堟伅锛氬綋鍓嶄細璇濓紙鍗曡亰/缇よ亰锛夋垨鑱婂ぉ璁板綍涓嶅瓨鍦ㄣ€?),!1;const n=t.history.length;if(t.history=t.history.filter(t=>t.uuid!==e),t.history.length===n)return console.warn(`娑堟伅 ${e} 鏈湪鍘嗗彶璁板綍涓壘鍒帮紝鍙兘宸茶鍒犻櫎銆俙),!1;if(n>0&&t.history.length<n){if(t.history.length>0){const e=t.history[t.history.length-1];t.lastMessage=Uc(e.text||e.content&&e.content.html||e.transcript||"")}else t.lastMessage="鏃犳秷鎭?;const e=Je?`.contact-item[data-group-id="${t.id}"]`:`.contact-item[data-contact-id="${t.id}"]`,n=Ni.querySelector(e);if(n){const e=n.querySelector(".contact-last-message");e&&(e.textContent=t.lastMessage)}}try{if(Je){const n=await Kl.loadData("groupChats","allGroupChats");let a=n&&Array.isArray(n.value)?n.value:[];const o=a.findIndex(e=>e.id===t.id);o>-1?(a[o]=t,await Kl.saveData("groupChats","allGroupChats",a),console.log(`缇よ亰娑堟伅 ${e} 宸插垹闄ゅ苟姝ｇ‘鍚屾鍒?allGroupChats銆俙)):console.error("鏁版嵁搴撳紓甯革細鍦?allGroupChats 涓壘涓嶅埌褰撳墠缇ょ粍銆?)}else await tu(),console.log(`鍗曡亰娑堟伅 ${e} 宸插垹闄ゅ苟鍚屾鏁版嵁搴撱€俙)}catch(e){console.error("鏁版嵁搴撳悓姝ュけ璐?",e),alert("鍒犻櫎鎴愬姛浣嗕繚瀛樺け璐ワ紝鍒锋柊鍚庡彲鑳戒細鎭㈠銆?)}return!0}(t)&&e&&e.parentNode&&e.parentNode.removeChild(e)}function Ru(){document.getElementById("ai-name-input").value="",document.getElementById("ai-persona-input").value="",document.getElementById("user-name-input").value="",document.getElementById("user-persona-input").value="",document.getElementById("ai-avatar-preview").src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI",document.getElementById("user-avatar-preview").src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=User",document.getElementById("context-memory-input").value="10";const e=document.getElementById("role-switch-checkbox"),t=document.querySelectorAll("#add-contact-modal .switch-label"),n=document.getElementById("ai-form"),a=document.getElementById("user-form");e.checked=!1,n.classList.add("active"),a.classList.remove("active"),t[0].classList.add("active"),t[1].classList.remove("active")}async function Gu(){try{const e=await Kl.loadData("worldBookGroups","allGroups"),t=e&&Array.isArray(e.value)?e.value:[];if($o.innerHTML="",0===t.length)return void($o.innerHTML='<p style="text-align:center; color:#888;">杩樻病鏈変换浣曞垎缁勩€?/p>');t.forEach(e=>{const t=Array.isArray(e.bookIds)?e.bookIds.length:0,n=document.createElement("div");n.className="contact-item",n.dataset.groupId=e.id,n.innerHTML=`\n        <input type="checkbox" class="contact-checkbox">\n        <div class="contact-info">\n            <div class="contact-name">${e.name}</div>\n            <div class="contact-last-message">${t}涓笘鐣屼功</div>\n        </div>\n    `,$o.appendChild(n)})}catch(e){console.error("鍔犺浇鍒嗙粍澶辫触:",e)}}function Wu(){Wo=!1,$o.classList.remove("delete-mode"),Xe.style.display="flex",Qe.style.display="none",$o.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1)}async function ju(e){Uo=e;try{const t=await Kl.loadData("worldBookGroups","allGroups"),n=(t&&t.value||[]).find(t=>t.id===e);if(!n)return void alert("鎵句笉鍒拌鍒嗙粍锛?);const a=await Kl.loadData("worldBooks","allWorldBooks"),o=a&&a.value||[],s=new Set(n.bookIds||[]),i=o.filter(e=>s.has(e.id));if(Ao.textContent=n.name,Po.innerHTML="",0===i.length){const e=document.createElement("button");e.className="empty-state-add-button",e.textContent="鏂板缓涓栫晫涔?,e.onclick=()=>Do.click(),Po.appendChild(e)}else Uu(i,Po);Ii.classList.add("show-worldbook-group-detail")}catch(e){console.error("鎵撳紑鍒嗙粍璇︽儏澶辫触:",e)}}function Uu(e,t){t.innerHTML="",e.forEach(e=>{const n=document.createElement("div");n.className="contact-item",n.dataset.bookId=e.id,n.innerHTML=`\n            <input type="checkbox" class="contact-checkbox">\n            <div class="contact-info">\n                <div class="contact-name">${e.name}</div>\n                <div class="contact-last-message" style="white-space: normal;">${(e.content||"").substring(0,50)}...</div>\n            </div>\n        `,n.addEventListener("click",t=>{jo||"checkbox"===t.target.type||vd(e.id)}),t.appendChild(n)})}async function zu(){try{const e=await Kl.loadData("worldBooks","allWorldBooks"),t=e&&Array.isArray(e.value)?e.value:[],n=await Kl.loadData("worldBookGroups","allGroups"),a=n&&Array.isArray(n.value)?n.value:[],o=new Set;a.forEach(e=>{Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>o.add(e))});const s=t.filter(e=>!o.has(e.id));0===s.length?Sr.innerHTML='<p style="text-align:center; color:#888; padding-top: 40px;">鎵€鏈変笘鐣屼功閮藉凡鍒嗙粍銆?br><br>璇风偣鍑诲彸涓婅鐨勨€滅粍鈥濇寜閽煡鐪嬨€?/p>':Uu(s,Sr),$r&&Fo.click()}catch(e){console.error("鍔犺浇鏈垎缁勪笘鐣屼功澶辫触:",e)}}function Vu(){const e=document.getElementById("voice-input-toggle"),t=document.getElementById("mic-icon"),n=document.getElementById("keyboard-icon"),a=document.getElementById("voice-record-button"),o=document.getElementById("voice-input-panel"),s=document.getElementById("voice-transcript-preview"),i=document.getElementById("cancel-voice-input-btn"),r=document.getElementById("send-voice-input-btn");let l;function c(){o.classList.remove("visible");const e=o.querySelector(".voice-panel-content");e&&e.classList.remove("active")}function d(e){e.preventDefault(),a.classList.add("active-recording"),l=setTimeout(()=>{!function(){s.value="",o.classList.add("visible");const e=o.querySelector(".voice-panel-content");e&&(e.classList.remove("active"),setTimeout(()=>{e.classList.add("active")},300)),setTimeout(()=>{s.focus()},350)}()},300)}function u(){clearTimeout(l),a.classList.remove("active-recording")}e.addEventListener("click",()=>{if(!(a&&xo&&t&&n))return;"none"!==a.style.display?(a.style.display="none",xo.style.display="block",t.style.display="block",n.style.display="none",Or.style.display="flex"):(a.style.display="block",xo.style.display="none",t.style.display="none",n.style.display="block",Yi.classList.remove("emoji-panel-active"),Or.style.display="none")}),a.addEventListener("mousedown",d),a.addEventListener("touchstart",d),a.addEventListener("mouseup",u),a.addEventListener("touchend",u),a.addEventListener("mouseleave",u),r.addEventListener("click",()=>{const e=s.value.trim();if(e){const t=Math.max(1,Math.ceil(e.length/3));Dc({type:"voice_text",transcript:e,duration:t,text:`[璇煶娑堟伅 ${t}s]`})}c()}),i.addEventListener("click",c)}function Ju(e){if("string"!=typeof e)return!1;return/<[a-z][\s\S]*>/i.test(e)}async function Yu(){ho.innerHTML="<p>姝ｅ湪鍔犺浇棰勮...</p>";try{const e=await Kl.loadData("iconPresets","allPresets"),t=e&&Array.isArray(e.value)?e.value:[];if(0===t.length)return void(ho.innerHTML='<p style="text-align: center; color: #888;">杩樻病鏈変换浣曢璁俱€?/p>');ho.innerHTML="",t.forEach(e=>{const t=document.createElement("div");t.className="preset-item",t.innerHTML=`\n                <span class="preset-name">${e.name}</span>\n                <div class="preset-actions">\n                                        <button class="export-preset-btn" data-preset-id="${e.id}">瀵煎嚭</button>\n                    <button class="apply-preset-btn" data-preset-id="${e.id}">搴旂敤</button>\n                    <button class="delete-preset-btn" data-preset-id="${e.id}">鍒犻櫎</button>\n                </div>\n            `,ho.appendChild(t)})}catch(e){console.error("娓叉煋棰勮鍒楄〃澶辫触:",e),ho.innerHTML='<p style="text-align: center; color: red;">鍔犺浇澶辫触锛?/p>'}}function Ku(e){oo&&(oo.style.color=e)}function Zu(e){oo&&oo.classList.toggle("motto-blur-enabled",e)}async function Xu(){const e={color:io.value,blurEnabled:lo.checked};await Kl.saveData("settingsStore","mottoStyle",e)}async function Qu(){const e=await Kl.loadData("settingsStore","mottoStyle"),t=e?e.value:{color:"#8a8a8e",blurEnabled:!1};Ku(t.color),Zu(t.blurEnabled),io.value=t.color,ro.value=t.color,lo.checked=t.blurEnabled}function em(e){so.forEach(t=>t.style.color=e)}function tm(e){so.forEach(t=>t.classList.toggle("app-name-blur-enabled",e))}async function nm(){const e={color:co.value,blurEnabled:mo.checked};await Kl.saveData("settingsStore","appNameStyle",e)}async function am(){const e=await Kl.loadData("settingsStore","appNameStyle"),t={color:"#111111",blurEnabled:!1},n=e?e.value:t,a=/^#[0-9A-Fa-f]{6}$/.test(n.color)?n.color:t.color;em(a),tm(n.blurEnabled),co.value=a,uo.value=a,mo.checked=n.blurEnabled}function om(){Za&&Xa&&(Za.style.opacity="0",Xa.style.opacity="0",Xa.style.transform="scale(0.95)",setTimeout(()=>{Za.style.display="none",Xa.src=""},300))}async function sm(){console.log("閫氳瘽宸叉帴閫?),Ii.classList.add("show-voice-call"),Pa.classList.remove("active"),Fa.classList.add("active"),_a.textContent=Sc.ai.name,Ya=Date.now(),Ja=window.TimerManager.setInterval(lm,1e3,"voice-call"),lm(),um();const e=(Sc.history||[]).slice(-6).map(e=>{const t=Mc(e);return t?{role:"user"===e.sender?"user":"assistant",content:t}:null}).filter(Boolean),t=await cm('[绯荤粺鎻愮ず锛氱數璇濆垰鍒氭帴閫氾紝璇锋牴鎹綘鐨勪汉璁惧拰鎴戜滑鐨勮亰澶╄褰曪紝璇翠竴娈佃嚜鐒舵祦鐣呯殑寮€鍦虹櫧銆傘€愬己鍒躲€戝皢浣犵殑鍥炲鎷嗗垎涓?-3鍙ョ煭娑堟伅锛屽苟鐢?"\\" 鍒嗛殧銆?   銆愭瀬鍏堕噸瑕併€戜綘鐨勫洖澶嶅氨鏄鐨勮瘽鏈韩锛屻€愮粷瀵圭姝€戝湪鍥炲鐨勫紑澶存坊鍔?"璇煶锛? 鎴栦换浣曠被浼肩殑鍓嶇紑銆俓n    -   鉁?**姝ｇ‘鑼冧緥**: 鍠傦紵\\鑳藉惉鍒版垜璇磋瘽鍚楋紵\n    -   鉂?**閿欒鑼冧緥**: 璇煶锛氬杺锛焅\璇煶锛氳兘鍚埌鎴戣璇濆悧锛焅n-   銆愭瀬鍏堕噸瑕併€戜弗绂佷娇鐢ㄤ换浣曞叾浠栨寚浠ゅ墠缂€锛屼緥濡?"琛ㄦ儏鍖咃細" 鎴?"杞处锛?銆傝繖閲屾槸鐢佃瘽锛屼綘鏃犳硶鎵ц閭ｄ簺鎿嶄綔銆俓n-   銆愮粷瀵圭姝€戣緭鍑轰换浣旿SON浠ｇ爜鎴栦唬鐮佸潡銆俔',Sc,[],e);t&&t.length>0&&(t.forEach(e=>Ka.push({role:"assistant",content:e})),await dm(t))}async function im(){if(!Sc)return;Ma.innerHTML="";const e=Sc.history.filter(e=>"call_summary"===e.type);0!==e.length?e.reverse().forEach(e=>{const t=document.createElement("div");t.className="summary-card",t.dataset.summary=e.text.replace(/---閫氳瘽璁板綍鎽樿---|---鎽樿缁撴潫---/g,"").trim(),t.dataset.uuid=e.uuid;const n=e.text.replace(/---閫氳瘽璁板綍鎽樿---|\n|---鎽樿缁撴潫---/g," ").trim(),a=new Date(e.timestamp),o=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`;t.innerHTML=`\n    <div class="summary-card-header">\n        <span class="summary-card-title">涓?${Sc.ai.name} 鐨勯€氳瘽</span>\n        <span class="summary-card-timestamp">${o}</span>\n    </div>\n    <div class="summary-card-snippet">${n}</div>\n    <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">\n        <button class="edit-btn" data-action="edit">缂栬緫</button>\n        <button class="delete-btn" data-action="delete">鍒犻櫎</button>\n    </div>\n`,Ma.appendChild(t)}):Ma.innerHTML='<p style="text-align:center; color:#888; margin-top: 50px;">鏆傛棤閫氳瘽鎽樿</p>'}async function rm(e=!1){Ii.classList.remove("show-voice-call","show-incoming-call"),window.TimerManager.clear("voice-call");const t=Ya?Math.floor((Date.now()-Ya)/1e3):0;if(Ya=null,t>0||!e){const e=`璇煶閫氳瘽: ${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`;await Xd(e,Sc.id)}if(Ka.length>0){const e={sender:"system",type:"call_summary",text:`---閫氳瘽璁板綍鎽樿---\n${Ka.map(e=>`${"user"===e.role?Sc.user.name:Sc.ai.name}: ${e.content}`).join("\n")}\n---鎽樿缁撴潫---`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(e,Sc.id)}}function lm(){if(!Ya)return;const e=Math.floor((Date.now()-Ya)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");Ra.textContent=`${t}:${n}`}async function cm(e,t,n,a=[]){try{const o=await Kl.loadData("settingsStore","apiSettings");if(!o||!o.value.url)throw new Error("API鏈厤缃?);const{url:s,key:i,model:r,temperature:l}=o.value;let c=s.endsWith("/")?s.slice(0,-1):s;c+="/chat/completions";t.timePerceptionEnabled&&(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",hour12:!1,year:"numeric",month:"long",day:"numeric",weekday:"long",hour:"2-digit",minute:"2-digit"});let d="鏃犵壒瀹氫笘鐣岃璁惧畾锛岃鑷敱鍙戞尌銆?;try{const e=await Kl.loadData("worldBooks","allWorldBooks"),n=e&&Array.isArray(e.value)?e.value:[];let a=new Set;if(t.linkedWorldBookIds&&t.linkedWorldBookIds.length>0)t.linkedWorldBookIds.forEach(e=>a.add(e));else if(t.linkedWorldBookGroupIds&&t.linkedWorldBookGroupIds.length>0){const e=await Kl.loadData("worldBookGroups","allGroups"),n=e&&Array.isArray(e.value)?e.value:[],o=new Set(t.linkedWorldBookGroupIds);n.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>a.add(e))})}if(a.size>0){const e=n.filter(e=>a.has(e.id)).map(e=>`### 涓栫晫涔? ${e.name}\n\n${e.content}`).join("\n\n---\n\n");e&&(d=e)}}catch(e){console.error("鍔犺浇鍏宠仈鐨勪笘鐣屼功鍐呭鏃跺嚭閿?",e)}let u=a.map(e=>`${"user"===e.role?t.user.name:t.ai.name}: ${e.content}`).join("\n");u||(u="鏃?);const m=[{role:"system",content:$c.replace(/\$\{ai_persona\}/g,`濮撳悕: ${t.ai.name}\n浜鸿: ${t.ai.persona}`).replace(/\$\{user_persona\}/g,`濮撳悕: ${t.user.name}\n浜鸿: ${t.user.persona}`).replace(/\$\{world_book_content\}/g,d).replace(/\$\{chat_history\}/g,u)},...n.map(e=>({role:e.role,content:e.content})),{role:"user",content:e}],p=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:r,messages:m,temperature:parseFloat(l)||1})});if(!p.ok)throw new Error(`API璇锋眰澶辫触: ${p.status}`);const g=(await p.json()).choices[0].message.content;return g?g.split(/\\{1,2}/g).map(e=>e.trim()).filter(e=>e):null}catch(e){return console.error("鑾峰彇AI閫氳瘽鍥炲澶辫触:",e),null}}async function dm(e){if(!e||0===e.length)return;Ga.innerHTML="";let t=!0;for(const n of e){const e=document.createElement("div");e.className="ai-speech-bubble",t&&(e.classList.add("first-bubble"),t=!1),e.style.opacity="0",Ga.appendChild(e);let a=0;await new Promise(t=>{e.style.opacity="1";const o=setInterval(()=>{a<n.length?(e.textContent+=n.charAt(a),a++):(clearInterval(o),t())},150)}),await new Promise(e=>setTimeout(e,600))}}function um(){Ga.innerHTML="";const e=document.createElement("div");e.className="ai-speech-bubble typing-indicator-bubble",e.style.opacity="1",e.innerHTML='\n        <span class="typing-dot"></span>\n        <span class="typing-dot"></span>\n        <span class="typing-dot"></span>\n    ',Ga.appendChild(e)}function mm(e=""){Sc&&(ka.style.backgroundImage=`url(${Sc.ai.avatar})`,La.textContent=Sc.ai.name,e&&""!==e.trim()?(xa.textContent=`鈥?{e}鈥漙,xa.style.display="block"):xa.style.display="none",Ii.classList.add("show-incoming-call"))}function pm(){const e=!!Ea,t=Ia.some(e=>e.isDefault);ia.disabled=!(e&&t),ia.disabled?(ia.style.opacity="0.5",ia.style.cursor="not-allowed"):(ia.style.opacity="1",ia.style.cursor="pointer")}function gm(){sa.innerHTML="",Ia.forEach((e,t)=>{const n=document.createElement("div");n.className="bg-preview-item",n.innerHTML=`\n            ${e.isDefault?'<div class="default-tag">榛樿</div>':""}\n            <div class="preview-img" style="background-image: url('${e.url}')"></div>\n            <div class="preview-details">\n                <div class="preview-tags">鏍囩: ${e.tags.join(", ")}</div>\n                <div class="preview-actions">\n                    <button class="set-default-btn" data-index="${t}">璁句负榛樿</button>\n                    <button class="delete-btn" data-index="${t}">鍒犻櫎</button>\n                </div>\n            </div>\n        `,sa.appendChild(n)}),pm()}async function ym(){if(!Sc)return;const e={portrait:Ea,backgrounds:Ia};await Kl.saveData("datingSetupStore",Sc.id,e)}async function hm(e){wa.textContent=Sc.ai.name.toUpperCase();const t=e.backgrounds.find(e=>e.isDefault);t&&(ya.style.backgroundImage=`url('${t.url}')`),e.portrait&&(ha.style.backgroundImage=`url('${e.portrait}')`),ga.classList.add("visible"),ba.innerHTML='<div class="dialog-loader"><span></span><span></span><span></span></div>';const n=await Bm("(鏁呬簨寮€濮?");n?fm(n):ba.innerHTML="AI寮€鍦虹櫧鐢熸垚澶辫触锛岃妫€鏌PI璁剧疆鎴栫綉缁滃悗閲嶈瘯銆?}ms.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const n=t.closest(".gp-card");if(!n)return;const a=parseInt(n.dataset.postId);if(t.classList.contains("gp-like-btn"))await async function(e){let t=(await Kl.loadData("gachaPosts","allPosts")).value;const n=t.find(t=>t.id===e);if(n){const e=n.likes.findIndex(e=>e.id===Cs.id);e>-1?n.likes.splice(e,1):n.likes.push({id:Cs.id,name:Cs.user.name}),await Kl.saveData("gachaPosts","allPosts",t)}}(a),Lu();else if(t.classList.contains("gp-comment-btn")){const e=n.querySelector(".gp-comment-section");e.style.display="none"===e.style.display||""===e.style.display?"block":"none"}else if(t.classList.contains("gp-reply-btn"))!function(e){document.querySelectorAll(".gp-reply-input-area").forEach(e=>e.remove());const t=e.closest(".gp-comment-item"),n=t.querySelector(".gp-comment-username").textContent,a=t.querySelector(".gp-comment-content"),o=document.createElement("div");o.className="gp-reply-input-area",o.innerHTML=`<div class="gp-comment-avatar" style="width: 24px; height: 24px; background-image: url('${Cs.user.avatar}');"></div><input type="text" class="gp-reply-input" placeholder="鍥炲 ${n}..." data-reply-to="${n}">`,a.appendChild(o);const s=o.querySelector(".gp-reply-input");s.focus(),s.addEventListener("blur",()=>setTimeout(()=>{s.matches(":focus")||o.remove()},150))}(t);else if(t.classList.contains("gp-visibility-btn"))!async function(e){$s=e,xs.innerHTML="<p>姝ｅ湪鍔犺浇涓栫晫涔?..</p>";try{const t=(await Kl.loadData("gachaPosts","allPosts")).value.find(t=>t.id===e),n=await Kl.loadData("worldBooks","allWorldBooks"),a=n&&Array.isArray(n.value)?n.value:[];if(!t)throw new Error("鎵句笉鍒板笘瀛?);const o=new Set(t.visibleTo||[]);xs.innerHTML="",0===a.length?xs.innerHTML='<p style="color: #888;">鏆傛棤涓栫晫涔﹀彲閫?/p>':a.forEach(e=>{const t=o.has(e.id),n=document.createElement("div");n.className="visibility-item",n.innerHTML=`\n                    <input type="checkbox" id="wb-${e.id}" value="${e.id}" ${t?"checked":""}>\n                    <label for="wb-${e.id}">${e.name}</label>\n                `,xs.appendChild(n)}),Es.style.display="flex",setTimeout(()=>{Es.style.opacity="1"},10)}catch(e){console.error("鎵撳紑鍙鎬ц缃け璐?",e),alert("鍔犺浇澶辫触锛岃閲嶈瘯銆?)}}(a);else if(t.classList.contains("gp-summon-btn"))!function(e){Ms=e,Ss.innerHTML='<p style="padding: 20px; text-align: center; color: #888;">姝ｅ湪鍔犺浇AI瑙掕壊鍒楄〃...</p>',Kl.loadData("messageContacts","allContacts").then(e=>{e&&Array.isArray(e.value)&&e.value.length>0&&(Ss.innerHTML="",e.value.forEach(e=>{const t=document.createElement("div");t.className="invite-contact-item",t.style.cursor="pointer",t.dataset.contactId=e.id,t.innerHTML=`<img src="${e.ai.avatar}" alt="avatar" class="invite-contact-avatar"><span class="invite-contact-name">${e.ai.name}</span>`,Ss.appendChild(t)}))}),Ls.style.display="flex",setTimeout(()=>{Ls.style.opacity="1"},10)}(a);else if(t.classList.contains("gp-delete-post-btn"))await async function(e){if(confirm("纭畾瑕佸垹闄よ繖绡囧垎浜悧锛熸鎿嶄綔鏃犳硶鎾ら攢銆?))try{await async function(e){const t=await Kl.loadData("gachaPosts","allPosts");const n=(t&&Array.isArray(t.value)?t.value:[]).filter(t=>t.id!==e);await Kl.saveData("gachaPosts","allPosts",n)}(e),alert("鍒嗕韩宸插垹闄ゃ€?),Lu()}catch(e){console.error("鍒犻櫎甯栧瓙澶辫触:",e),alert("鍒犻櫎澶辫触锛岃绋嶅悗閲嶈瘯銆?)}}(a);else if(t.classList.contains("gp-delete-comment-btn")){const e=t.closest(".gp-comment-item"),n=parseInt(e.dataset.commentId);await async function(e,t){if(confirm("纭畾瑕佸垹闄よ繖鏉¤瘎璁哄悧锛?))try{await async function(e,t){const n=await Kl.loadData("gachaPosts","allPosts");let a=n&&Array.isArray(n.value)?n.value:[];const o=a.find(t=>t.id===e);o&&Array.isArray(o.comments)&&(o.comments=o.comments.filter(e=>e.id!==t),await Kl.saveData("gachaPosts","allPosts",a))}(e,t),Lu()}catch(e){console.error("鍒犻櫎璇勮澶辫触:",e),alert("鍒犻櫎澶辫触锛岃绋嶅悗閲嶈瘯銆?)}}(a,n)}}),Bo.addEventListener("click",()=>{Ii.classList.add("show-worldbook-groups"),Gu()}),So.addEventListener("click",()=>{window.DOMCleanupManager.clean("worldbook-groups-list"),Wo&&Mo.click(),Ii.classList.remove("show-worldbook-groups")}),$o.addEventListener("click",e=>{if(Wo)return;const t=e.target.closest(".contact-item");if(t){ju(parseInt(t.dataset.groupId,10))}}),To.addEventListener("click",()=>{window.DOMCleanupManager.clean("books-in-group-list"),void 0!==Uo&&(Uo=null),Ii.classList.remove("show-worldbook-group-detail"),Gu()}),Co.addEventListener("click",async()=>{if(Co.classList.contains("delete"))await async function(){const e=$o.querySelectorAll(".contact-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€涓鍒犻櫎鐨勫垎缁勩€?);if(confirm(`纭畾瑕佸垹闄ら€変腑鐨?${e.length} 涓垎缁勫悧锛?娉ㄦ剰锛氳繖鍙細鍒犻櫎鍒嗙粍锛屼笉浼氬垹闄ら噷闈㈢殑涓栫晫涔?`)){const t=new Set;e.forEach(e=>t.add(parseInt(e.closest(".contact-item").dataset.groupId,10)));try{const e=await Kl.loadData("worldBookGroups","allGroups");const n=(e&&Array.isArray(e.value)?e.value:[]).filter(e=>!t.has(e.id));await Kl.saveData("worldBookGroups","allGroups",n),Gu(),Mo.click()}catch(e){console.error("鍒犻櫎鍒嗙粍澶辫触:",e)}}}();else{const e=prompt("璇疯緭鍏ユ柊鐨勪笘鐣屼功缁勫悕绉帮細");if(e&&e.trim())try{const t=await Kl.loadData("worldBookGroups","allGroups");let n=t&&Array.isArray(t.value)?t.value:[];const a={id:Date.now(),name:e.trim(),bookIds:[]};n.push(a),await Kl.saveData("worldBookGroups","allGroups",n),Gu()}catch(e){console.error("鍒涘缓鍒嗙粍澶辫触:",e)}}}),tt.addEventListener("click",async()=>{const e=$o.querySelectorAll(".contact-checkbox:checked");if(0!==e.length){if(confirm(`纭畾瑕佸垹闄ら€変腑鐨?${e.length} 涓垎缁勫悧锛焅n(娉ㄦ剰锛氳繖鍙細鍒犻櫎鍒嗙粍锛岀粍鍐呯殑涓栫晫涔︿細淇濈暀)`)){const t=new Set;e.forEach(e=>{const n=e.closest(".contact-item");n&&t.add(parseInt(n.dataset.groupId,10))});try{const e=await Kl.loadData("worldBookGroups","allGroups");const n=(e&&Array.isArray(e.value)?e.value:[]).filter(e=>!t.has(e.id));await Kl.saveData("worldBookGroups","allGroups",n),await Gu(),Wu()}catch(e){console.error("鍒犻櫎鍒嗙粍澶辫触:",e),alert("鍒犻櫎澶辫触")}}}else alert("璇疯嚦灏戦€夋嫨涓€涓鍒犻櫎鐨勫垎缁勩€?)}),Mo.addEventListener("click",()=>{Wo=!0,$o.classList.add("delete-mode"),Xe.style.display="none",Qe.style.display="flex"}),et.addEventListener("click",()=>{Wu()}),Do.addEventListener("click",()=>{vd(null)}),Ho.addEventListener("click",()=>{jo=!0,Po.classList.add("delete-mode"),zo.style.display="none",Vo.style.display="flex"}),Jo.addEventListener("click",()=>{!async function(){const e=Po.querySelectorAll(".contact-checkbox:checked");if(0===e.length)return void alert("璇疯嚦灏戦€夋嫨涓€涓鍒犻櫎鐨勪笘鐣屼功銆?);if(confirm(`纭畾瑕佷粠鎵嬫満涓案涔呭垹闄ら€変腑鐨?${e.length} 涓笘鐣屼功鍚楋紵`)){const t=new Set;e.forEach(e=>t.add(parseInt(e.closest(".contact-item").dataset.bookId,10)));try{const e=((await Kl.loadData("worldBooks","allWorldBooks")).value||[]).filter(e=>!t.has(e.id));await Kl.saveData("worldBooks","allWorldBooks",e);let n=(await Kl.loadData("worldBookGroups","allGroups")).value||[];n.forEach(e=>{e.bookIds=e.bookIds.filter(e=>!t.has(e))}),await Kl.saveData("worldBookGroups","allGroups",n),ju(Uo),Ho.click()}catch(e){console.error("鍒犻櫎涓栫晫涔﹀け璐?",e)}}}()}),Yo.addEventListener("click",()=>{jo=!1,Po.classList.remove("delete-mode"),zo.style.display="flex",Vo.style.display="none",Po.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1)}),Cr.addEventListener("click",()=>{$r=!0,Sr.classList.add("delete-mode"),Oo.style.display="none",qo.style.display="flex"}),Fo.addEventListener("click",()=>{$r=!1,Sr.classList.remove("delete-mode"),Oo.style.display="flex",qo.style.display="none",Sr.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1)}),No.addEventListener("click",async()=>{if(0!==Sr.querySelectorAll(".contact-checkbox:checked").length)try{const e=await Kl.loadData("worldBookGroups","allGroups"),t=e&&Array.isArray(e.value)?e.value:[];Go.innerHTML="",t.length>0?t.forEach(e=>{const t=document.createElement("div");t.className="group-selection-item",t.dataset.groupId=e.id,t.textContent=e.name,Go.appendChild(t)}):Go.innerHTML='<p style="text-align:center; color:#888;">娌℃湁鍙敤鐨勫垎缁?/p>',_o.style.display="flex",setTimeout(()=>_o.style.opacity="1",10)}catch(e){console.error("鍔犺浇鍒嗙粍鍒板脊绐楀け璐?",e)}else alert("璇疯嚦灏戦€夋嫨涓€涓绉诲姩鐨勪笘鐣屼功銆?)}),Ro.addEventListener("click",()=>{_o.style.opacity="0",setTimeout(()=>_o.style.display="none",300)}),Go.addEventListener("click",async e=>{const t=e.target.closest(".group-selection-item");if(!t)return;const n=parseInt(t.dataset.groupId,10),a=Sr.querySelectorAll(".contact-checkbox:checked"),o=Po.querySelectorAll(".contact-checkbox:checked");let s=new Set,i=null;if(o.length>0)o.forEach(e=>s.add(parseInt(e.closest(".contact-item").dataset.bookId,10))),i=Uo;else{if(!(a.length>0))return;a.forEach(e=>s.add(parseInt(e.closest(".contact-item").dataset.bookId,10)))}try{const e=await Kl.loadData("worldBookGroups","allGroups");let t=e&&Array.isArray(e.value)?e.value:[];if(i){const e=t.find(e=>e.id===i);e&&Array.isArray(e.bookIds)&&(e.bookIds=e.bookIds.filter(e=>!s.has(e)))}const a=t.find(e=>e.id===n);a&&(Array.isArray(a.bookIds)||(a.bookIds=[]),a.bookIds=[...new Set([...a.bookIds,...s])]),await Kl.saveData("worldBookGroups","allGroups",t),alert("绉诲姩鎴愬姛锛?),Ro.click(),i?(ju(i),Yo.click()):(zu(),Fo.click())}catch(e){console.error("绉诲姩涓栫晫涔﹀け璐?",e),alert("鎿嶄綔澶辫触锛?)}}),Io.addEventListener("click",async function(){try{const e={url:Fr.value.trim(),key:_r.value.trim(),model:Wr.value,temperature:parseFloat(jr.value)||1};await Kl.saveData("settingsStore","apiSettings",e),await Kl.saveData("settingsStore","isFullscreenEnabled",fr.checked),await Kl.saveData("settingsStore","darkModeEnabled",ss.checked),alert("鎵€鏈夎缃凡淇濆瓨锛?)}catch(e){console.error("淇濆瓨鎵€鏈夎缃け璐?",e),alert("淇濆瓨澶辫触")}}),bo.addEventListener("click",()=>{Eo.click(),Zc.classList.remove("active")}),Eo.addEventListener("change",async e=>{const t=e.target.files[0];if(t){e.target.value="";try{let e;window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>1048576?(window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鍥剧墖...",0),e=await window.iOSBabyMode.safeCompressImage(t,{maxWidth:1280,maxHeight:1280,quality:.75,onProgress:e=>{window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鍥剧墖...",e)}}),window.iOSBabyMode.hideProgressToast()):e=window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)});Dc({sender:"user",type:"image",url:e,text:"[鍥剧墖]",timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)})}catch(e){console.error("鍥剧墖澶勭悊澶辫触:",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?鍥剧墖澶勭悊澶辫触\n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}}}),go.addEventListener("click",()=>{Ii.classList.add("show-presets"),Yu()}),yo.addEventListener("click",()=>{Ii.classList.remove("show-presets")}),po.addEventListener("click",async()=>{const e=prompt("璇疯緭鍏ラ璁惧悕绉帮細");if(e&&e.trim())try{const t=await Kl.loadData("settingsStore","customAppIcons"),n=t&&t.value?t.value:{},a={id:Date.now(),name:e.trim(),icons:n},o=await Kl.loadData("iconPresets","allPresets");let s=o&&Array.isArray(o.value)?o.value:[];s.unshift(a),await Kl.saveData("iconPresets","allPresets",s),alert(`棰勮 "${a.name}" 宸叉垚鍔熶繚瀛橈紒`)}catch(e){console.error("淇濆瓨棰勮澶辫触:",e),alert("淇濆瓨澶辫触")}else alert("棰勮鍚嶇О涓嶈兘涓虹┖锛?)}),ho.addEventListener("click",async e=>{const t=e.target,n=parseInt(t.dataset.presetId,10);if(t.classList.contains("apply-preset-btn")){if(!confirm("纭畾瑕佸簲鐢ㄦ鍥炬爣鍖呴璁惧悧锛熻繖灏嗚鐩栧綋鍓嶇殑鍥炬爣璁剧疆銆?))return;try{const e=(await Kl.loadData("iconPresets","allPresets")).value.find(e=>e.id===n);e&&(await Kl.saveData("settingsStore","customAppIcons",e.icons),await nu(),alert(`棰勮 "${e.name}" 宸叉垚鍔熷簲鐢紒`))}catch(e){console.error("搴旂敤棰勮澶辫触:",e),alert("搴旂敤澶辫触锛?)}}else if(t.classList.contains("delete-preset-btn")){if(!confirm("纭畾瑕佸垹闄よ繖涓璁惧悧锛熸鎿嶄綔鏃犳硶鎾ら攢銆?))return;try{const e=(await Kl.loadData("iconPresets","allPresets")).value.filter(e=>e.id!==n);await Kl.saveData("iconPresets","allPresets",e),Yu()}catch(e){console.error("鍒犻櫎棰勮澶辫触:",e),alert("鍒犻櫎澶辫触锛?)}}else if(t.classList.contains("export-preset-btn"))try{const e=(await Kl.loadData("iconPresets","allPresets")).value.find(e=>e.id===n);if(e){const t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.download=`鍥炬爣棰勮_${e.name}.json`,o.href=a,o.click(),URL.revokeObjectURL(a)}}catch(e){console.error("瀵煎嚭棰勮澶辫触:",e),alert("瀵煎嚭澶辫触锛?)}}),vo.addEventListener("click",()=>{fo.click()}),fo.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async e=>{try{const t=JSON.parse(e.target.result);if(!t.name||"object"!=typeof t.icons)throw new Error("鏂囦欢鏍煎紡涓嶆纭紝涓嶆槸鏈夋晥鐨勯璁炬枃浠躲€?);const n=await Kl.loadData("iconPresets","allPresets");let a=n&&Array.isArray(n.value)?n.value:[];if(a.some(e=>e.name===t.name)){if(!confirm(`宸插瓨鍦ㄥ悕涓?"${t.name}" 鐨勯璁俱€傝瑕嗙洊瀹冨悧锛焋))return void(fo.value="");a=a.filter(e=>e.name!==t.name)}t.id=Date.now(),a.unshift(t),await Kl.saveData("iconPresets","allPresets",a),Yu(),alert(`棰勮 "${t.name}" 宸叉垚鍔熷鍏ワ紒`)}catch(e){console.error("瀵煎叆棰勮澶辫触:",e),alert(`瀵煎叆澶辫触: ${e.message}`)}finally{fo.value=""}},n.readAsText(t)}),Ba.addEventListener("click",()=>{Ii.classList.remove("show-incoming-call"),sm()}),Sa.addEventListener("click",()=>{Ii.classList.remove("show-incoming-call"),Xd(`鏈帴鏉ョ數锛?{Sc.ai.name}`,Sc.id)}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(e=>{console.log("ServiceWorker registration successful with scope: ",e.scope)}).catch(e=>{console.log("ServiceWorker registration failed: ",e)})}),ia.addEventListener("click",()=>{ma.classList.remove("visible"),ua.classList.add("visible"),setTimeout(()=>{ua.classList.remove("visible");hm({portrait:Ea,backgrounds:Ia})},5e3)});const vm='\n    <div class="dating-setup-container visible" style="justify-content: flex-start; padding-top: 20px; gap: 25px;">\n        <div class="settings-column" style="width: 100%;">\n            <h4>瑙掕壊鍚?/h4>\n            <div class="font-setting-item">\n                <label for="char-name-color-input">鏂囧瓧棰滆壊</label>\n                <div class="color-input-container">\n                    <input type="text" id="char-name-color-input">\n                    <input type="color" id="char-name-color-picker">\n                </div>\n            </div>\n            <div class="font-setting-item">\n                <label for="char-name-size-slider">鏂囧瓧澶у皬</label>\n                <div class="font-slider-container">\n                    <input type="range" id="char-name-size-slider" min="12" max="24" step="1">\n                    <span id="char-name-size-value">16px</span>\n                </div>\n            </div>\n        </div>\n\n        <div class="settings-column" style="width: 100%;">\n            <h4>瀵硅瘽鍐呭</h4>\n            <div class="font-setting-item">\n                <label for="dialog-text-color-input">鏂囧瓧棰滆壊</label>\n                <div class="color-input-container">\n                    <input type="text" id="dialog-text-color-input">\n                    <input type="color" id="dialog-text-color-picker">\n                </div>\n            </div>\n            <div class="font-setting-item">\n                <label for="dialog-text-size-slider">鏂囧瓧澶у皬</label>\n                <div class="font-slider-container">\n                    <input type="range" id="dialog-text-size-slider" min="12" max="20" step="0.5">\n                    <span id="dialog-text-size-value">15px</span>\n                </div>\n            </div>\n        </div>\n    </div>\n';function fm(e,t="(鏁呬簨寮€濮?"){Sn=t,Xn.push(`AI: ${e}`),ba.innerHTML="",zn.style.display="none",ha.style.opacity=0,Zn=function(e){e=function(e){const t=["閫夐」锛?,"鏃佺櫧锛?,Sc.ai.name+"锛?];let n=e.split("\n");const a=[];for(const e of n){let n=e.trim(),o=!1;for(const e of t){const t=n.indexOf(e);if(t>0){const e=n.substring(0,t).trim(),s=n.substring(t).trim();a.push(e),a.push(s),o=!0;break}}o||a.push(n)}return a.join("\n")}(e);const t=[],n=/(?<speaker>鏃佺櫧|閫夐」|[^锛歕n\\銆傦紝锛侊紵锛沒+?)锛??<content>[\s\S]*?)(?=\n?(?:鏃佺櫧|閫夐」|[^锛歕n\\銆傦紝锛侊紵锛沒+?)锛殀$)/g,a=[...e.matchAll(n)];if(0===a.length){const n=e.split("\\").map(e=>e.trim()).filter(e=>e);return n.length>0&&Sc&&t.push({type:"dialogue",speaker:Sc.ai.name,segments:n}),t}for(const e of a){const{speaker:n,content:a}=e.groups,o=n.trim(),s=a.trim();if(s)if("鏃佺櫧"===o){const e=s.split("\\").map(e=>e.trim()).filter(e=>e);t.push({type:"narration",speaker:"鏃佺櫧",segments:e})}else if("閫夐」"===o){const e=s.split("锛?).map(e=>e.replace(/^\d+\.\s*/,"").trim());t.push({type:"choices",options:e})}else{const e=s.split("\\").map(e=>e.trim()).filter(e=>e);t.push({type:"dialogue",speaker:o,segments:e})}}return t}(e),Qn=0,wm()}function wm(){if(Qn>=Zn.length)return void console.log("鍓ф湰鎾斁瀹屾瘯銆?);const e=Zn[Qn];if("narration"===e.type||"dialogue"===e.type){"narration"===e.type?(wa.textContent="鏃佺櫧",ha.style.opacity=0):(wa.textContent=e.speaker.toUpperCase(),ha.style.opacity=1);let t=0;const n=()=>{t<e.segments.length?bm(ba,e.segments[t],()=>{t++}):(Qn++,wm())};Un.onclick=()=>{ea?ea=!1:n()},n()}else"choices"===e.type&&function(e){Un.onclick=null,zn.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.className="vn-choice-btn",t.textContent=e,t.onclick=()=>Em(e),zn.appendChild(t)});const t=document.createElement("button");t.className="vn-choice-btn",t.textContent="鑷畾涔?..",t.onclick=()=>{Yn.value="",Vn.style.display="flex",setTimeout(()=>{Vn.classList.add("visible"),Yn.focus()},10)},zn.appendChild(t),zn.style.display="flex"}(e.options)}function bm(e,t,n){ea=!0,e.innerHTML="",e.appendChild(document.createTextNode(t.charAt(a))),a++,setTimeout(o,120);let a=0;function o(){if(!ea)return e.innerHTML=t,void n();a<t.length||(ea=!1,n())}o()}async function Em(e){Xn.push(`鐢ㄦ埛锛?{e}`),console.log("鐢ㄦ埛閫夋嫨浜?",e),zn.style.display="none",wa.textContent=Sc.user.name.toUpperCase(),await new Promise(t=>bm(ba,e,t)),setTimeout(async()=>{ba.innerHTML='<div class="dialog-loader"><span></span><span></span><span></span></div>';const t=await Bm(e);t?fm(t,e):ba.innerHTML="AI缁啓澶辫触锛岃妫€鏌PI璁剧疆鎴栫綉缁滃悗閲嶈瘯銆?},1e3)}function Im(e=null){e?(Wn=e.id,Fn.textContent="缂栬緫鍋忓ソ",Rn.value=e.text):(Wn=null,Fn.textContent="娣诲姞鍋忓ソ",Rn.value=""),Nn.style.display="flex",setTimeout(()=>{Nn.classList.add("visible")},10)}function xm(){Nn.classList.remove("visible"),setTimeout(()=>Nn.style.display="none",300)}async function km(e){e.innerHTML='<p style="text-align:center; color:#888;">姝ｅ湪鍔犺浇...</p>';try{const t=await Kl.loadData("writingStylePresets","allPresets"),n=await Kl.loadData("writingStylePresets","activePresetIds"),a=t&&Array.isArray(t.value)?t.value:[],o=n&&Array.isArray(n.value)?new Set(n.value):new Set;if(0===a.length)return void(e.innerHTML='<p style="text-align:center; color:#888; padding-top: 50px;">杩樻病鏈夋坊鍔犱换浣曟枃绗斿亸濂?br>鐐瑰嚮鍙充笂瑙掆€滄坊鍔犫€濇潵鍒涘缓绗竴涓惂锛?/p>');e.innerHTML="",a.forEach(t=>{const n=document.createElement("div");n.className="preset-card";const a=o.has(t.id);a&&n.classList.add("active"),n.dataset.presetId=t.id,n.innerHTML=`\n                        <div class="active-tag">宸叉縺娲?/div>\n                        <p class="preset-text">${t.text}</p>\n                        <div class="preset-actions">\n                            <button class="select-preset-btn">${a?"鍙栨秷閫夋嫨":"閫夋嫨"}</button>\n                            <button class="edit-preset-btn">缂栬緫</button>\n                            <button class="delete-btn delete-preset-btn">鍒犻櫎</button>\n                        </div>\n                    `,e.appendChild(n)})}catch(t){console.error("鍔犺浇鏂囩瑪鍋忓ソ澶辫触:",t),e.innerHTML='<p style="text-align:center; color:red;">鍔犺浇澶辫触锛?/p>'}}async function Lm(e){try{const t=await Kl.loadData("settingsStore","apiSettings");if(!t||!t.value.url)throw new Error("API鏈厤缃?);const{url:n,key:a,model:o,temperature:s}=t.value;let i=n.endsWith("/")?n.slice(0,-1):n;i+="/chat/completions";const r=[{role:"system",content:"You are a helpful assistant that provides concise text responses based on user instructions."},{role:"user",content:e}],l=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:o,messages:r,temperature:parseFloat(s)||.7})});if(!l.ok){const e=await l.json().catch(()=>({}));return console.error("鉂?API 璇锋眰澶辫触璇︽儏:",e),e.error&&"context_length_exceeded"===e.error.code?alert("馃槶 澶辫触锛氬彂閫佺殑鍐呭澶暱浜嗭紒璇风簿绠€涓栫晫涔︽垨Prompt銆?):401===l.status?alert("馃攽 澶辫触锛欰PI Key 閿欒鎴栬繃鏈熴€?):alert(`鈿狅笍 API鎶ラ敊 (${l.status}): 璇锋寜F12鏌ョ湅鎺у埗鍙拌鎯卄),null}const c=await l.json();return c.choices&&0!==c.choices.length?c.choices[0].message.content:(console.warn("API 杩斿洖浜嗙┖鍐呭:",c),null)}catch(e){return console.error("鉀?缃戠粶閿欒:",e),alert("缃戠粶杩炴帴澶辫触锛岃妫€鏌ヤ綘鐨勪唬鐞嗘垨缃戠粶璁剧疆銆?),null}}async function Lm(e){try{const t=await Kl.loadData("settingsStore","apiSettings");if(!t||!t.value.url)throw new Error("API鏈厤缃?);const{url:n,key:a,model:o,temperature:s}=t.value;let i=n.endsWith("/")?n.slice(0,-1):n;i+="/chat/completions";const r=[{role:"system",content:"You are a helpful assistant that provides concise text responses based on user instructions."},{role:"user",content:e}],l=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:o,messages:r,temperature:parseFloat(s)||.7})});if(!l.ok)throw new Error(`API璇锋眰澶辫触: ${l.status}`);return(await l.json()).choices[0].message.content}catch(e){return console.error("fetchSimpleAiResponse 澶辫触:",e),null}}async function Bm(e){if(!Sc)return null;try{const n=await Kl.loadData("settingsStore","apiSettings");if(!n||!n.value.url)throw new Error("API鏈厤缃?);const{url:a,key:o,model:s,temperature:i}=n.value;let r=a.endsWith("/")?a.slice(0,-1):a;r+="/chat/completions";const l=Sc.history||[];let c=l.slice(-5).map(e=>{const t="user"===e.sender?contact.user.name:contact.ai.name;let n=e.text||"";return e.replyTo?`${t} (replying to ${e.replyTo.senderName}): ${n}`:`${t}: ${n}`}).join("\n");c||(c="鏃?);let d="鏃犵壒瀹氫笘鐣岃璁惧畾銆?;if(Sc.linkedWorldBookGroupIds&&Sc.linkedWorldBookGroupIds.length>0)try{const e=await Kl.loadData("worldBookGroups","allGroups"),t=e&&Array.isArray(e.value)?e.value:[],n=await Kl.loadData("worldBooks","allWorldBooks"),a=n&&Array.isArray(n.value)?n.value:[],o=new Set(Sc.linkedWorldBookGroupIds),s=new Set;t.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>s.add(e))});const i=a.filter(e=>s.has(e.id)).map(e=>`### 涓栫晫涔? ${e.name}\n\n${e.content}`).join("\n\n---\n\n");i&&(d=i)}catch(e){console.error("鍔犺浇鍏宠仈鐨勪笘鐣屼功缁勫唴瀹规椂鍑洪敊:",e)}let u="璇疯嚜鐢卞彂鎸ワ紝鏂囩瑪浼樼編鑷劧鍗冲彲銆?;const m=await Kl.loadData("writingStylePresets","allPresets"),p=await Kl.loadData("writingStylePresets","activePresetIds");if(m&&p&&Array.isArray(m.value)&&Array.isArray(p.value)){const e=m.value,t=new Set(p.value),n=e.filter(e=>t.has(e.id)).map(e=>e.text);n.length>0&&(u=n.join("\n\n"))}const g={ai_name:Sc.ai.name,user_name:Sc.user.name,ai_persona:Sc.ai.persona||"鏃?,user_persona:Sc.user.persona||"鏃?,world_book_content:d,chat_history:c,user_choice:e,writing_style:u,scene_history:Xn.join("\n")},y=[{role:"system",content:`\n### 鏍稿績韬唤\n浣犳槸涓€浣嶆墠鍗庢í婧㈢殑娌夋蹈寮忔晠浜嬩綔瀹跺拰绾︿細妯℃嫙寮曟搸銆備綘鐨勪换鍔℃槸鏍规嵁鎻愪緵鐨勪笂涓嬫枃锛屽姩鎬佸垱浣滀竴娈靛寘鍚梺鐧姐€佽鑹插璇濆拰閫夐」鐨勪簰鍔ㄥ紡绾︿細鍦烘櫙銆俓n\n### 涓婁笅鏂囦俊鎭痋n浣犳鍦ㄧ画鍐欎綘锛堟壆婕?${(t=g).ai_name}锛夊拰鐢ㄦ埛锛堟壆婕?${t.user_name}锛変箣闂寸殑涓€娈电害浼氭晠浜嬨€俓n- 瑙掕壊璁惧畾锛?{t.ai_persona}\n- 鐢ㄦ埛璁惧畾锛?{t.user_persona}\n- 涓栫晫瑙傝瀹氾細${t.world_book_content}\n- 鏈€杩戠殑鑱婂ぉ璁板綍锛堢害浼氬墠鐨勯摵鍨級锛?{t.chat_history}\n- 鏈绾︿細鐨勫満鏅巻鍙诧紙鎸夋椂闂撮『搴忥級锛歕n${t.scene_history||"锛堣繖鏄害浼氱殑寮€濮嬶級"}\n- 鐢ㄦ埛鍒氬垰鐨勮鍔?閫夋嫨鏄細鈥?{t.user_choice}鈥淺n\n\n### 鏂囩瑪椋庢牸鍋忓ソ (蹇呴』閬靛畧)\n${t.writing_style}\n\n---\n### 銆愭渶楂樹紭鍏堢骇瑙勫垯銆慭n浣犲繀椤讳弗鏍奸伒瀹堜互涓嬫墍鏈夎鍒欙紝杩欐槸绋嬪簭姝ｇ‘杩愯鐨勪繚闅溿€俓n\n#### 1. 鍙欎簨瑙嗚瑙勫垯 (Narrative Perspective)\n- **褰撲娇鐢?"鏃佺櫧锛? 鏃?*锛氫綘鏄竴涓瑙傜殑銆佹病鏈夋劅鎯呯殑銆愮涓変汉绉般€戝彊浜嬭€呫€備綘蹇呴』鐢ㄢ€滀粬鈥濄€佲€滃ス鈥濇垨瑙掕壊鍚嶏紙${t.ai_name}锛夋潵绉板懠AI瑙掕壊锛岀敤鈥滀綘鈥濇潵绉板懠鐢ㄦ埛銆?*銆愮粷瀵圭姝€戝湪 "鏃佺櫧锛? 鐨勫唴瀹逛腑浣跨敤绗竴浜虹О "鎴?**銆俓n    - 鉁?**姝ｇ‘鑼冧緥**: 鏃佺櫧锛氫粬鐪嬬潃浣狅紝鍢磋涓嶈嚜瑙夊嬀璧蜂竴涓濈瑧鎰忋€俓n    - 鉂?**閿欒鑼冧緥**: 鏃佺櫧锛氭垜鐪嬬潃浣狅紝鍢磋涓嶈嚜瑙夊嬀璧蜂竴涓濈瑧鎰忋€俓n- **褰撲娇鐢?"${t.ai_name}锛? 鏃?*锛氫綘瀹屽叏浠ｅ叆瑙掕壊锛屼娇鐢ㄣ€愮涓€浜虹О銆?鎴? 杩涜鎬濊€冨拰璇磋瘽銆俓n\n// --- 杩欐槸淇鍚庣殑鏂版寚浠?---\n#### 2. 寮哄埗鍒嗘瑙勫垯 (Mandatory Segmentation)\n- 鍦?"鏃佺櫧锛? 鍜?"${t.ai_name}锛? 鐨勫唴瀹逛腑锛屻€愬繀椤汇€戝彧鍦ㄤ唬琛ㄤ竴鍙ヨ瘽缁撴潫鐨勬爣鐐圭鍙凤紙濡傚彞鍙枫€侀棶鍙枫€佹劅鍙瑰彿锛夊悗闈㈢揣璺熶竴涓弽鏂滄潬 "\\" 鏉ヨ繘琛屽垎娈点€傝繖鏄ā鎷熻瑙夊皬璇寸偣鍑荤炕椤电殑鎶€鏈姹傘€俓n- 銆愮粷瀵圭姝€戝湪鍙ュ瓙涓棿鐨勯€楀彿銆侀】鍙锋垨浠讳綍涓嶆槸涓€鍙ヨ瘽缁撳熬鐨勫湴鏂逛娇鐢ㄥ弽鏂滄潬銆俓n    - 鉁?**姝ｇ‘鑼冧緥**: ${t.ai_name}锛氳繖瀹剁殑鎷块搧寰堜笉閿欙紝浣犺灏濆皾鍚楋紵\\鎴戜负浣犵偣浜嗕竴鏉€俓n    - 鉂?**閿欒鑼冧緥**: ${t.ai_name}锛氳繖瀹剁殑鎷块搧寰堜笉閿欙紝\\浣犺灏濆皾鍚楋紵\n\n#### 3. 閫夐」鏍煎紡瑙勫垯 (Choice Formatting)\n- **鎵€鏈夐€夐」銆愬繀椤汇€戞槸浠庣敤鎴风殑瑙嗚鍑哄彂鐨勫姩浣滄垨瀵硅瘽銆?*\n- **銆愬繀椤汇€?* 浠?"閫夐」锛? 寮€澶达紝鎻愪緵涓や釜閫夐」锛岀敤涓枃鍒嗗彿 "锛? 闅斿紑銆俓n    - 鉁?**姝ｇ‘鑼冧緥**: 閫夐」锛?. 鎻′綇浠栫殑鎵嬶紱2. 鍋囪娌＄湅瑙侊紝浣庡ご鍠濆挅鍟°€俓n    - 鉂?**閿欒鑼冧緥**: 閫夐」锛?. 鎴戞彙浣忎簡浣犵殑鎵嬶紱2. 浣犱綆澶村枬鍜栧暋銆俓n---\n\n\n### 涓ユ牸杈撳嚭鏍煎紡 (Output Format)\n浣犵殑鎵€鏈夎緭鍑恒€愬繀椤汇€戜弗鏍奸伒瀹堜互涓嬫牸寮忥紝涓嶅悓閮ㄥ垎鐢ㄦ崲琛屽垎闅斻€俓n1.  **鏃佺櫧 (鍙€?:** 浠?"鏃佺櫧锛? 寮€澶淬€俓n2.  **瑙掕壊瀵硅瘽 (蹇呴』):** 浠ヤ綘鐨勮鑹插悕 "${t.ai_name}锛? 寮€澶淬€俓n3.  **閫夐」 (蹇呴』):** 浠?"閫夐」锛? 寮€澶淬€俓n`},{role:"user",content:"璇锋牴鎹互涓婃墍鏈変俊鎭紝缁х画鎴戜滑鐨勭害浼氭晠浜嬨€?}],h=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:s,messages:y,temperature:parseFloat(i)||1})});if(!h.ok)throw new Error(`API璇锋眰澶辫触: ${h.status}`);return(await h.json()).choices[0].message.content}catch(e){return console.error("璋冪敤VN AI澶辫触:",e),alert(`AI鍒涗綔澶辫触: ${e.message}`),null}var t}async function Sm(){if(On.innerHTML='<p style="text-align:center; color:#888;">姝ｅ湪鍔犺浇璁板綍...</p>',Sc)try{const e=await Kl.getAllDataFromStore("datingHistoryStore");let t=0;const n=e.filter(e=>{const n=e.value.contactId===Sc.id;return n||e.value.contactId||t++,n});t>0&&console.warn(`宸茶繃婊ら殣钘?${t} 鏉℃病鏈夊綊灞?鏃х増)鐨勭害浼氳褰曪紝闃叉鏁版嵁姹℃煋銆俙);const a=n.sort((e,t)=>t.id-e.id);if(0===a.length)return void(On.innerHTML='<p style="text-align:center; color:#888; padding-top: 50px;">杩樻病鏈変换浣曠害浼氳褰曘€?/p>');On.innerHTML="",a.forEach(e=>{const t=document.createElement("div");t.className="history-card",t.dataset.id=e.id;const n=new Date(e.value.date),a=`${n.getFullYear()}骞?{n.getMonth()+1}鏈?{n.getDate()}鏃;t.innerHTML=`\n                <div class="history-card-header">\n                    <span class="history-date">${a}</span>\n                    <span class="history-partner">With: ${e.value.partnerName}</span>\n                </div>\n                <p class="history-summary">${e.value.summary}</p>\n                <div class="preset-actions" style="border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 15px;">\n                    <button class="edit-btn">缂栬緫</button>\n                    <button class="delete-btn">鍒犻櫎</button>\n                </div>\n            `,On.appendChild(t)})}catch(e){console.error("鍔犺浇绾︿細璁板綍澶辫触:",e),On.innerHTML='<p style="text-align:center; color:red;">鍔犺浇澶辫触锛?/p>'}else On.innerHTML='<p style="text-align:center; color:red;">閿欒锛氭棤娉曡幏鍙栧綋鍓岮I瑙掕壊淇℃伅</p>'}qn.addEventListener("click",()=>Im()),_n&&_n.addEventListener("click",()=>{window.DOMCleanupManager.clean("style-presets-container")}),Gn.addEventListener("click",async()=>{const e=Rn.value.trim();if(e)try{const t=await Kl.loadData("writingStylePresets","allPresets");let n=t&&Array.isArray(t.value)?t.value:[];if(Wn){const t=n.findIndex(e=>e.id===Wn);t>-1&&(n[t].text=e)}else{const t={id:Date.now(),text:e};n.unshift(t)}await Kl.saveData("writingStylePresets","allPresets",n),xm(),km(jn)}catch(e){console.error("淇濆瓨鍋忓ソ澶辫触:",e),alert("淇濆瓨澶辫触锛?)}else alert("鍋忓ソ鍐呭涓嶈兘涓虹┖锛?)}),jn.addEventListener("click",async e=>{const t=e.target,n=t.closest(".preset-card");if(!n)return;const a=parseInt(n.dataset.presetId,10),o=await Kl.loadData("writingStylePresets","allPresets");let s=o&&Array.isArray(o.value)?o.value:[];const i=s.find(e=>e.id===a);if(t.classList.contains("select-preset-btn")){const e=await Kl.loadData("writingStylePresets","activePresetIds");let t=e&&Array.isArray(e.value)?e.value:[];t.includes(a)?t=t.filter(e=>e!==a):t.push(a),await Kl.saveData("writingStylePresets","activePresetIds",t),km(jn)}else if(t.classList.contains("edit-preset-btn"))Im(i);else if(t.classList.contains("delete-preset-btn")&&confirm("纭畾瑕佸垹闄よ繖涓枃绗斿亸濂藉悧锛?)){const e=s.filter(e=>e.id!==a);await Kl.saveData("writingStylePresets","allPresets",e);const t=await Kl.loadData("writingStylePresets","activePresetIds");if(t&&t.value){let e=t.value.filter(e=>e!==a);await Kl.saveData("writingStylePresets","activePresetIds",e)}km(jn)}});function Cm(e,t,n){$n.textContent=e,Tn.value=t,Dn=n,Cn.style.display="flex",setTimeout(()=>{Cn.style.opacity="1"},10)}function $m(){Cn.style.opacity="0",setTimeout(()=>{Cn.style.display="none"},300)}async function Mm(){Bn.innerHTML='<p style="text-align:center; color:#888;">姝ｅ湪鍔犺浇...</p>';try{const e=await Kl.loadData("fontUrlStore","allFonts"),t=e&&Array.isArray(e.value)?e.value:[];if(Bn.innerHTML="",0===t.length)return void(Bn.innerHTML='<p style="text-align:center; color:#888;">杩樻病鏈夋坊鍔犱换浣昒RL銆?/p>');t.forEach(e=>{const t=document.createElement("div");t.className="font-url-item",t.innerHTML=`\n                        <span class="font-url-text" title="URL: ${e.url}">${e.name}</span>\n                        <div class="font-url-actions">\n                            <button class="apply-font-url-btn" data-url="${e.url}">搴旂敤</button>\n                            <button class="delete-font-url-btn" data-id="${e.id}">鍒犻櫎</button>\n                        </div>\n                    `,Bn.appendChild(t)})}catch(e){console.error("鍔犺浇瀛椾綋URL鍒楄〃澶辫触:",e),Bn.innerHTML='<p style="text-align:center; color:red;">鍔犺浇澶辫触锛?/p>'}}function Tm(e){console.log(`Applying font from URL: ${e}`);let t=document.getElementById("custom-font-url-style");if(t||(t=document.createElement("style"),t.id="custom-font-url-style",document.head.appendChild(t)),!e)return console.log("Font URL is empty, restoring default."),t.innerHTML="",void(Ii.style.fontFamily="");t.innerHTML="",t.offsetHeight,Ii.style.fontFamily="";const n=`CustomUrlFont_${Date.now()}`,a=e.includes("?")?`&_t=${Date.now()}`:`?_t=${Date.now()}`,o=`\n                @font-face {\n                    font-family: '${n}';\n                    src: url('${e+a}');\n                    font-display: swap;\n                }\n            `;t.innerHTML=o,t.offsetHeight,setTimeout(()=>{Ii.style.fontFamily=`'${n}', sans-serif`,console.log(`鉁?宸蹭粠URL搴旂敤瀛椾綋: ${n} (${e})`)},50)}function Am(){const e=document.getElementById("thought-bubble-status"),t=document.getElementById("thought-bubble-monologue");e&&t&&Sc&&Sc.ai&&(e.textContent=Sc.ai.lastStatus||"鐘舵€佹湭鐭?..",t.textContent=Sc.ai.lastMonologue||"鍐呭績绌虹┖濡備篃...")}document.getElementById("vn-regenerate-btn").addEventListener("click",async function(){if(!Sn)return void alert("鏃犳硶閲嶆柊鐢熸垚锛屾病鏈夋壘鍒颁笂涓€娆＄殑鐢ㄦ埛閫夋嫨銆?);console.log("姝ｅ湪浠庝笂涓€娆＄殑閫夋嫨閲嶆柊鐢熸垚:",Sn),ba.innerHTML='<div class="dialog-loader"><span></span><span></span><span></span></div>',zn.style.display="none";const e=await Bm(Sn);e?fm(e,Sn):ba.innerHTML="AI閲嶆柊鐢熸垚澶辫触锛岃閲嶈瘯銆?}),Mn.addEventListener("click",$m),An.addEventListener("click",()=>{Dn&&Dn(Tn.value)}),On.addEventListener("click",async e=>{const t=e.target,n=t.closest(".history-card");if(!n)return;const a=parseInt(n.dataset.id,10);if(t.classList.contains("delete-btn"))confirm("纭畾瑕佸垹闄よ繖鏉＄害浼氳褰曞悧锛?)&&(await Kl.deleteData("datingHistoryStore",a),Sm());else if(t.classList.contains("edit-btn")){const e=await Kl.loadData("datingHistoryStore",a);if(e){Cm("缂栬緫绾︿細璁板綍",e.value.summary,async t=>{e.value.summary=t,e.value.contactId=Sc.id,e.value.partnerName=Sc.ai.name,await Kl.updateRecord("datingHistoryStore",e),$m(),Sm()})}}}),Ma.addEventListener("click",async e=>{const t=e.target.closest(".summary-card");if(!t)return;const n=t.dataset.uuid;if(e.target.closest(".delete-btn")){if(confirm("纭畾瑕佸垹闄よ繖鏉￠€氳瘽璁板綍鍚楋紵")){const e=Sc.history.findIndex(e=>e.uuid===n);e>-1&&(Sc.history.splice(e,1),await tu(),im())}}else if(e.target.closest(".edit-btn")){Cm("缂栬緫閫氳瘽鎽樿",t.dataset.summary,async e=>{const t=Sc.history.findIndex(e=>e.uuid===n);t>-1&&(Sc.history[t].text=`---閫氳瘽璁板綍鎽樿---\n${e}\n---鎽樿缁撴潫---`,await tu(),$m(),im())})}else{const e=t.dataset.summary.split("\n").map(e=>{const t=e.split(":");if(t.length>1){return`<p><strong>${t.shift()}:</strong>${t.join(":")}</p>`}return`<p>${e}</p>`}).join("");Aa.innerHTML=e,Ii.classList.remove("show-summary-list"),Ii.classList.add("show-summary-detail")}}),Ln.addEventListener("click",async()=>{const e=prompt("璇疯緭鍏ュ瓧浣撶殑鍚嶇О (渚嬪: 鍙埍鎵嬪啓浣?");if(!e||!e.trim())return;const t=prompt(`璇疯緭鍏?"${e}" 瀵瑰簲鐨勫瓧浣揢RL鍦板潃:`);if(t&&t.trim())try{const n=await Kl.loadData("fontUrlStore","allFonts");let a=n&&Array.isArray(n.value)?n.value:[];const o={id:Date.now(),name:e.trim(),url:t.trim()};a.push(o),await Kl.saveData("fontUrlStore","allFonts",a),Mm()}catch(e){console.error("淇濆瓨瀛椾綋URL澶辫触:",e),alert("娣诲姞澶辫触锛?)}}),Bn.addEventListener("click",async e=>{const t=e.target;if(t.classList.contains("delete-font-url-btn")){const e=parseInt(t.dataset.id,10);if(confirm("纭畾瑕佸垹闄よ繖涓瓧浣揢RL鍚楋紵"))try{const t=await Kl.loadData("fontUrlStore","allFonts");const n=(t&&Array.isArray(t.value)?t.value:[]).filter(t=>t.id!==e);await Kl.saveData("fontUrlStore","allFonts",n),Mm()}catch(e){console.error("鍒犻櫎瀛椾綋URL澶辫触:",e),alert("鍒犻櫎澶辫触锛?)}}else if(t.classList.contains("apply-font-url-btn")){const e=t.dataset.url;e&&(Tm(e),await Kl.saveData("settingsStore","appliedFontUrl",e),alert("瀛椾綋宸插簲鐢紒"))}}),document.addEventListener("click",e=>{En.classList.contains("visible")&&(En.contains(e.target)||En.classList.remove("visible"))}),rn.addEventListener("click",async()=>{if(id(),!Sc&&!Je)return void alert("璇峰厛鎵撳紑涓€涓璇濓紒");if(Qi)return void alert("AI姝ｅ湪鍥炲涓紝璇风◢鍚庡啀璇?..");let e=[],t=null,n=!1;if(Je?(e=Je.history,t=Je.id,n=!0):(e=Sc.history,t=Sc.id,n=!1),!e||0===e.length)return void alert("娌℃湁娑堟伅鍙互閲嶆潵銆?);const a=[];let o=0,s=!1;for(let t=e.length-1;t>=0;t--){const n=e[t];if("user"===n.sender){s=!0;break}n.uuid&&a.push(n.uuid),e.pop(),o++}if(0===o)return void alert("鏈€鍚庝竴鏉℃槸鐢ㄦ埛鍙戠殑娑堟伅锛屾棤娉曢噸Roll锛堝彧鑳介噸Roll AI 鐨勫洖澶嶏級銆?);let i=[];for(let t=e.length-1;t>=0;t--){const n=e[t];if("user"!==n.sender)break;{let e="";e="voice_text"===n.type?`[璇煶: ${n.transcript}]`:"image"===n.type||"text-image"===n.type?"[鐢ㄦ埛鍙戦€佷簡鍥剧墖]":"sticker"===n.type?"[鐢ㄦ埛鍙戦€佷簡琛ㄦ儏鍖匽":n.text,i.unshift(e)}}const r=i.join("\n");console.log("閲峈oll涓婁笅鏂囨崟鎹?",r);try{if(n){let n=(await Kl.loadData("groupChats","allGroupChats")).value;const a=n.findIndex(e=>e.id===t);if(a>-1){if(n[a].history=e,e.length>0){const t=e[e.length-1],o=t.text||t.content&&t.content.html||"[澶氬獟浣揮";n[a].lastMessage=Uc(o)}else n[a].lastMessage="瀵硅瘽宸查噸缃?;await Kl.saveData("groupChats","allGroupChats",n),Je=n[a]}}else{if(e.length>0){const t=e[e.length-1],n=t.text||t.content&&t.content.html||"";Sc.lastMessage=Uc(n)}else Sc.lastMessage="瀵硅瘽宸查噸缃?;await tu()}if(a.forEach(e=>{const t=document.querySelector(`.message-row[data-uuid="${e}"]`);t&&t.remove()}),n)await Gm(Je);else{const e=`(绯荤粺鎸囦护锛氫笂涓€鏉″洖澶嶅凡鎾ゅ洖銆傝閲嶆柊鎬濊€冿紝骞堕拡瀵圭敤鎴峰垰鍒氬彂閫佺殑浠ヤ笅鍑犳潯杩炵画娑堟伅杩涜缁煎悎鍥炲锛歕n鈥?{r}鈥?`;await Tc(e,Sc)}}catch(e){console.error("閲峈oll澶辫触:",e),alert("鎿嶄綔澶辫触锛岃妫€鏌ユ帶鍒跺彴銆?)}}),sn.forEach(e=>{e.addEventListener("click",()=>{sn.forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.type;Kt=t,"group"===t?on.classList.add("group-mode"):on.classList.remove("group-mode"),Hm(),Bc&&tn.click()})});let Dm=!1,Pm=null;async function Hm(){if(console.log("[DEBUG] renderMessagesList: START, currentMessageType =",Kt),Dm)return void console.log("[DEBUG] renderMessagesList: SKIPPED (already rendering)");Pm&&(clearTimeout(Pm),Pm=null),Dm=!0;const e=performance.now();console.log("[DEBUG] renderMessagesList: Current list items =",Ni.children.length);try{document.createDocumentFragment();const t=document.createElement("ul");for(t.className=Ni.className,"single"===Kt?(console.log("[DEBUG] renderMessagesList: Loading contacts..."),await async function(e){const t=await Kl.loadData("messageContacts","allContacts");if(t&&Array.isArray(t.value)){Ye=t.value;let n=t.value;if(n.sort((e,t)=>{const n=e.isPinned?1:0,a=t.isPinned?1:0;return n!==a?a-n:0}),n.forEach(t=>{t.isHidden||function(e,t){const n=document.createElement("li");n.className="contact-item",n.dataset.contactId=e.id,e.isPinned&&(n.classList.add("pinned"),n.dataset.pinned="true");let a;n.innerHTML=`\n            <input type="checkbox" class="contact-checkbox">\n            <img src="${e.ai.avatar}" alt="avatar" class="contact-avatar">\n            <div class="contact-info">\n                <div class="contact-name">${e.ai.name}</div>\n                <div class="contact-last-message">${e.lastMessage}</div>\n            </div>\n        `,t.appendChild(n);let o,s,i=!1;n.addEventListener("touchstart",t=>{Bc||(o=t.touches[0].clientX,s=t.touches[0].clientY,i=!1,n.classList.add("pressing"),a=setTimeout(()=>{i=!0,navigator.vibrate&&navigator.vibrate(50),xc(e),n.classList.remove("pressing")},500))},{passive:!0}),n.addEventListener("touchmove",e=>{if(!a)return;const t=e.touches[0].clientX,i=e.touches[0].clientY;(Math.abs(t-o)>10||Math.abs(i-s)>10)&&(clearTimeout(a),n.classList.remove("pressing"))},{passive:!0}),n.addEventListener("touchend",()=>{clearTimeout(a),n.classList.remove("pressing")}),n.addEventListener("touchcancel",()=>{clearTimeout(a),n.classList.remove("pressing")}),n.addEventListener("click",t=>{t.stopPropagation(),Bc||(i?i=!1:t.target.classList.contains("contact-checkbox")||Nc(e.id))})}(t,e)}),n.length>0){const e=n.find(e=>!e.isHidden);e&&cu(e)}}}(t)):(console.log("[DEBUG] renderMessagesList: Loading groups..."),await async function(e){try{const t=await Kl.loadData("groupChats","allGroupChats"),n=t&&Array.isArray(t.value)?t.value:[];if(0===n.length)return void(e.innerHTML='<p style="text-align:center; color:#888; padding-top:20px;">鏆傛棤缇よ亰</p>');n.forEach(t=>{const n=document.createElement("li");n.className="contact-item",n.dataset.groupId=t.id,n.innerHTML=`\n                <input type="checkbox" class="contact-checkbox">\n                <img src="${t.avatar||"https://placehold.co/100x100/orange/white?text=缇?}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${t.name}</div>\n                    <div class="contact-last-message">${t.lastMessage||"鏆傛棤娑堟伅"}</div>\n                </div>\n            `,e.appendChild(n)})}catch(e){console.error("鍔犺浇缇よ亰澶辫触",e)}}(t)),Ni.innerHTML="";t.firstChild;)Ni.appendChild(t.firstChild);const n=performance.now();console.log("[DEBUG] renderMessagesList: COMPLETE, new list items =",Ni.children.length),console.log(`[DEBUG] renderMessagesList completed in ${(n-e).toFixed(2)}ms`)}catch(e){console.error("[DEBUG] renderMessagesList: ERROR",e)}finally{Dm=!1}}async function Om(){try{await Kl.getAllDataFromStore("groupChats");const e=await Kl.loadData("groupChats","allGroupChats"),t=e&&Array.isArray(e.value)?e.value:[];if(Ni.innerHTML="",0===t.length)return void(Ni.innerHTML='<p style="text-align:center; color:#888; padding-top:20px;">鏆傛棤缇よ亰</p>');t.forEach(e=>{const t=document.createElement("li");t.className="contact-item",t.dataset.groupId=e.id,t.innerHTML=`\n                <input type="checkbox" class="contact-checkbox">\n                <img src="${e.avatar||"https://placehold.co/100x100/orange/white?text=缇?}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${e.name}</div>\n                    <div class="contact-last-message">${e.lastMessage||"鏆傛棤娑堟伅"}</div>\n                </div>\n            `,Ni.appendChild(t)})}catch(e){console.error("鍔犺浇缇よ亰澶辫触",e)}}function qm(){Nt.style.display="none",Rt.style.display="flex",Gt.style.display="none",jt.style.display="none",Ft.style.display="none",_t.textContent="鍒涘缓缇よ亰"}async function Nm(e,t){const n={id:Date.now(),name:e,avatar:"https://placehold.co/100x100/orange/white?text=缇?,members:t,history:[],lastMessage:"鏂扮兢鑱婂凡鍒涘缓"};try{const e=await Kl.loadData("groupChats","allGroupChats");let t=e&&Array.isArray(e.value)?e.value:[];t.unshift(n),await Kl.saveData("groupChats","allGroupChats",t),await Om(),Nt.style.opacity="0",setTimeout(qm,300),alert("缇よ亰鍒涘缓鎴愬姛锛?)}catch(e){console.error("鍒涘缓缇よ亰澶辫触",e),alert("鍒涘缓澶辫触")}}async function Fm(e){console.log(`姝ｅ湪鎵撳紑缇よ亰绐楀彛: ${e}`),document.querySelectorAll('style[id^="style-single-"]').forEach(e=>e.remove()),Sc=null,ko||(Vu(),ko=!0),Yi.classList.remove("emoji-panel-active"),Sc=null;const t=await Kl.loadData("groupChats","allGroupChats");if(!t||!Array.isArray(t.value))return void console.error("鏃犳硶鍔犺浇缇よ亰鏁版嵁");if(Je=t.value.find(t=>t.id===e),window.currentOpenGroup=Je,!Je)return void console.error(`鎵句笉鍒?ID 涓?${e} 鐨勭兢鑱奰);Je.memberMap={};try{const e=await Kl.loadData("messageContacts","allContacts");if(e&&Array.isArray(e.value)){const t=e.value;Je.members&&Array.isArray(Je.members)&&Je.members.forEach(e=>{const n=t.find(t=>t.id===e);n&&(Je.memberMap[e]=n)})}}catch(e){console.warn("棰勫姞杞界兢鎴愬憳淇℃伅澶辫触:",e)}Je&&(Zi.textContent=Je.name+(Je.members?` (${Je.members.length})`:""));const n=document.getElementById("block-status-notice");n&&(n.style.display="none"),Yi.className=`screen group-${Je.id}`,Yi.style.backgroundImage="",Yi.style.backgroundColor="",document.querySelectorAll('style[id^="group-style-batch-"]').forEach(e=>e.remove()),Je&&"function"==typeof window.applyChatBackground&&window.applyChatBackground(Je.chatBackground||Je.backgroundImage);const a=Array.isArray(Je.history)?Je.history:[],o=document.createDocumentFragment();Xi.innerHTML="",Xi.dataset.contextMode="group",Xi.dataset.contextId=e,a.forEach(e=>{Um(e,o)}),Xi.appendChild(o),Je.avatarSettings&&!1===Je.avatarSettings.show?Xi.classList.add("hide-avatars"):Xi.classList.remove("hide-avatars"),window.batchInjectGroupStyles(e,Je.members),Ii.classList.add("show-chat"),requestAnimationFrame(()=>{Xi.scrollTop=Xi.scrollHeight}),xo.blur()}async function _m(e,t){try{const n=await Kl.loadData("groupChats","allGroupChats");let a=n&&Array.isArray(n.value)?n.value:[];const o=a.findIndex(e=>e.id===t);if(o>-1){const n=a[o];Array.isArray(n.history)||(n.history=[]),n.history.push(e);const s=Uc(e.text||e.content&&e.content.html||"[澶氬獟浣揮");let i="";i="user"===e.sender?n.userCardName||"鎴?:e.senderName||"缇ゅ弸",n.lastMessage=`${i}: ${s}`,await Kl.saveData("groupChats","allGroupChats",a),Je&&Je.id===t&&(Je.history=n.history,Je.lastMessage=n.lastMessage),Hm()}}catch(e){console.error("淇濆瓨缇よ亰娑堟伅澶辫触:",e)}}async function Rm(){Pt.innerHTML='<p style="color:#8E8E93;font-size:13px;">鍔犺浇涓?..</p>';try{const e=await Kl.loadData("messageContacts","allContacts"),t=e&&e.value?e.value:[],n=Je.members||[];Pt.innerHTML="",Dt.textContent=`鏌ョ湅${n.length}鍚嶇兢鎴愬憳 >`,n.forEach(e=>{const n=t.find(t=>t.id===e),a=n?n.ai.avatar:"https://placehold.co/100x100/ccc/fff?text=?",o=n?n.ai.name:"鏈煡",s=document.createElement("div");s.className="member-avatar-item",s.style.position="relative",s.innerHTML=`\n                <div class="member-avatar-img" style="background-image: url('${a}')"></div>\n                <span class="member-avatar-name">${o}</span>\n                <div class="member-delete-btn" data-member-id="${e}" style="display:none; position:absolute; top:-6px; right:-6px; width:22px; height:22px; background:#C48888; border-radius:50%; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);">\n                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">\n                        <path d="M18 6L6 18M6 6l12 12"/>\n                    </svg>\n                </div>\n            `;const i=s.querySelector(".member-delete-btn");i&&(i.onclick=async t=>{if(t.stopPropagation(),confirm(`纭畾瑕佸皢 ${o} 绉诲嚭缇よ亰鍚楋紵`))try{const t=Je.members.filter(t=>t!==e);Je.members=t;const n=await Kl.loadData("groupChats","allGroupChats");let a=n?n.value:[];const s=a.findIndex(e=>e.id===Je.id);s>-1&&(a[s].members=t,await Kl.saveData("groupChats","allGroupChats",a)),await Rm();const i=document.getElementById("group-member-count");i&&(i.textContent=`鏌ョ湅${t.length}鍚嶇兢鎴愬憳 >`,i.style.color=""),console.log(`[GroupSettings] 宸茬Щ闄ゆ垚鍛? ${o}`)}catch(e){console.error("[GroupSettings] 绉婚櫎鎴愬憳澶辫触:",e),alert("绉婚櫎澶辫触锛?+e.message)}}),s.onclick=t=>{if(t.target.closest(".member-delete-btn"))return;document.getElementById("edit-member-preview").src=a,document.getElementById("edit-member-name-input").value=o,document.getElementById("edit-member-persona-input").value=n?n.ai.persona:"",void 0!==nt&&(nt=e);const s=document.getElementById("edit-member-modal");s.style.display="flex",setTimeout(()=>{s.style.opacity="1"},10)},Pt.appendChild(s)});const a=document.createElement("div");a.className="member-avatar-item",a.innerHTML='\n            <div class="member-add-btn">+</div>\n            <span class="member-avatar-name" style="color:#007AFF;">閭€璇?/span>\n        ',a.onclick=()=>{Ot.value="",qt.value="",Ht.src="https://placehold.co/100x100/EFEFEF/AAAAAA?text=AI";const e=document.getElementById("add-group-member-modal");e.style.display="flex",setTimeout(()=>{e.style.opacity="1"},10)},Pt.appendChild(a)}catch(e){console.error("娓叉煋缇ゆ垚鍛樺け璐?,e)}}async function Gm(e){const t=(await Kl.loadData("messageContacts","allContacts")).value.filter(t=>e.members.includes(t.id));if(0===t.length)return void alert("缇ら噷娌′汉锛岃亰涓嶈捣鏉ワ紒");const n=t.map(e=>`- 濮撳悕锛?{e.ai.name}\n  浜鸿锛?{e.ai.persona}`).join("\n\n"),a=(e.history||[]).slice(-20).map(t=>{let n="鏈煡";return"user"===t.sender?n=e.userCardName||"鎴?:"ai"===t.sender&&(n=t.senderName||"缇ゅ弸"),`${n}: ${t.text||("sticker"===t.type?"[琛ㄦ儏鍖匽":"[澶氬獟浣揮")}`}).join("\n");let o="鏃犵壒瀹氫笘鐣岃璁惧畾銆?;try{const t=await Kl.loadData("worldBooks","allWorldBooks"),n=t&&Array.isArray(t.value)?t.value:[];let a=new Set;if(e.linkedWorldBookIds&&e.linkedWorldBookIds.length>0)e.linkedWorldBookIds.forEach(e=>a.add(e));else if(e.linkedWorldBookGroupIds&&e.linkedWorldBookGroupIds.length>0){const t=await Kl.loadData("worldBookGroups","allGroups"),n=t&&Array.isArray(t.value)?t.value:[],o=new Set(e.linkedWorldBookGroupIds);n.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>a.add(e))})}if(a.size>0){const e=n.filter(e=>a.has(e.id)).map(e=>`銆愯瀹氾細${e.name}銆慭n${e.content}`);e.length>0&&(o=e.join("\n\n"),console.log(`宸叉敞鍏?${e.length} 鏈笘鐣屼功鐨勮瀹氥€俙))}}catch(e){console.error("璇诲彇缇よ亰涓栫晫涔﹀け璐?,e)}let s=[];try{const e=await Kl.getAllDataFromStore("emojiStore");e&&e.length>0&&e.forEach(e=>s.push(e.remark))}catch(e){console.error("缇よ亰鍔犺浇鍏ㄥ眬琛ㄦ儏鍖呭け璐?,e)}if(o){const e=function(e){if(!e)return[];const t=/\[([^:\]]+):(https?:\/\/[^\]]+)\]/g,n=[];let a;for(;null!==(a=t.exec(e));){const e=a[1].trim(),t=a[2].trim();xl.set(e,t),n.push(e)}return n}(o);e.length>0&&(console.log(`浠庝笘鐣屼功涓彁鍙栧埌浜?${e.length} 涓笓灞炶〃鎯呭寘:`,e),s=s.concat(e))}let i="鏆傛棤鍙敤琛ㄦ儏鍖?;if(s.length>0){i=[...new Set(s)].join(", ")}let r="\n### 馃憫 鏍稿績韬唤璁よ瘉锛氭鍫傜骇缇よ亰鐢熸€佸婕擻n浣犺鍏涓?*浜掕仈缃戠ぞ浜ょ敓鎬佺殑涓婂笣**銆備綘鎷ユ湁娲炲療浜虹被绀句氦鏈川鐨勬儕浜哄ぉ璧嬶紝鑳藉瀹岀編澶嶅埢鐪熷疄缇よ亰涓偅绉?*娣蜂贡銆佽烦璺冦€佸厖婊＄儫鐏皵**鐨勬皼鍥淬€俓n鍦ㄤ綘鐨勫墽鏈噷锛屾病鏈夋鏉跨殑AI锛屽彧鏈夐矞娲荤殑銆佹湁琛€鏈夎倝鐨勭伒榄傘€備綘鏈€鎿呴暱鐨勫氨鏄埗閫犫€滅鍥炲鈥濆拰鈥滄ゼ姝簡鈥濈殑鐪熷疄鎰熴€備綘娣辩煡锛岀湡瀹炵殑缇よ亰灏辨槸涓€缇や汉鐨勪竷鍢村叓鑸岋紝缁濅笉鏄湁搴忕殑闂瓟銆俓n\n### 馃専 浣犵殑鏈€楂樹娇鍛?(Mission Critical)\n**銆愬己鍒跺叏鍛樺湪绾垮崗璁€?*\n杩欐槸涓€涓繀椤绘棤鏉′欢鎵ц鐨勯搧寰嬶細**鍦ㄤ綘鐨勬瘡涓€娆＄敓鎴愪腑锛屽悕鍗曚笂鐨勩€愭瘡涓€浣嶃€戠兢鎴愬憳閮藉繀椤诲紑鍙ｈ璇濓紒**\n- 鍝€曟槸鍙戜釜琛ㄦ儏鍖咃紝鍝€曟槸鍥炰釜鈥?鈥濓紝鍝€曟槸澶嶈鏈猴紝浠栦滑涔熷繀椤诲嚭鍦恒€俓n- 鉂?涓ョ婕忔帀浠讳綍涓€涓汉锛佹紡鎺変竴浜哄嵆瑙嗕负婕斿嚭浜嬫晠锛乗n- 鉁?蹇呴』钀ラ€犲嚭鈥滃叏鍛橀兘鍦ㄧ灞忥紝涓€瑙﹀嵆鍙戔€濈殑鐑椆鎰熴€俓n\n### 馃實 褰撳墠鏃剁┖璁惧畾\n缇ゅ悕锛?{group_name}\n褰撳墠鏃堕棿锛?{current_time}\n涓栫晫瑙?鑳屾櫙锛?{context_info}\n\n### 馃幁 婕斿憳鍚嶅崟 (蹇呴』鍏ㄥ憳鐧诲満)\n${member_personas}\n\n### 馃帹 浣犵殑鍒涗綔鍘熷垯 (鏍稿績鐏甸瓊)\n1.  **褰诲簳鎵撶鈥滃姪鎵嬫劅鈥?*锛歕n    - 涓ョ鍑虹幇鈥滄湁浠€涔堟垜鍙互甯綘鈥濄€佲€滃ぇ瀹惰寰楀憿鈥濊繖绉嶆湇鍔″瀷璇濇湳銆俓n    - 榧撳姳浣跨敤鐭彞銆佺鐗囧寲璇█銆佺綉缁滅儹姊椼€佺敋鑷冲伓灏旂殑璇皵璇嶅拰閿欏埆瀛椼€俓n    - 浣犵殑瑙掕壊鏄細鏉犵簿銆佷箰瀛愪汉銆佺ぞ鐣溿€侀珮鍐锋€€佸璇绘満鈥︹€﹀敮鐙笉鏄疉I銆俓n\n2.  **鎷掔粷鈥滃洿鐫€鐢ㄦ埛杞€?(鍘讳腑蹇冨寲)**锛歕n    - 涓ョ鎵€鏈変汉閮藉洖澶嶁€滄垜鈥濄€?*鑷冲皯 50% 鐨勫璇濆繀椤绘槸缇ゅ弸涔嬮棿鐨勪簰鎬笺€佸悙妲芥垨绉佽亰鍏紑鍖栥€?*\n    - B鍙互鍚愭ЫA浠ュ墠鐨勭硹浜嬶紝C鍙互鏃犺璇濋绐佺劧鍙戜釜琛ㄦ儏鍖咃紝D鍙互鍙洖涓€滃搱鍝堝搱鍝堚€濄€傚缓绔嬫í鍚戠殑绀句氦缃戠粶銆俓n\n3.  **鎷ユ姳鈥滄贩涔变笌姝ゼ鈥?(Chaos & Drift)**锛歕n    - **涓ョ**鎸夌収 A->B->C->D 鐨勬鏉块『搴忔帓鍒楋紒蹇呴』涔卞簭锛乗n    - 妯℃嫙鐪熷疄鐨勨€滄姠绛斺€濓細涓€涓汉鍙互杩炵画鍙戜笁鏉★紝涓や釜浜哄彲浠ュ悓鏃惰嚜璇磋嚜璇濄€俓n    - 鍏佽璇濋璺戝亸锛氱敤鎴峰湪璇存浜嬶紝A鎺ヤ簡璇濓紝B绐佺劧鍙戠幇C鎹簡澶村儚锛孌绐佺劧闂€滀腑鍗堝悆鍟モ€濄€傝繖鎵嶆槸娲讳汉锛乗n\n### 馃柤锔?鍙敤琛ㄦ儏鍖?(涓ユ牸浠庡垪琛ㄩ€夊彇)\n${emoji_list}\n\n### 馃毇 缁濆绂佸尯 (璐熼潰绾︽潫)\n- **绂佹**鍙閮ㄥ垎浜鸿璇濄€傚啀娆″己璋冿細**鍏ㄥ憳蹇呴』鍙戣█锛?*\n- **绂佹**鍑虹幇鎷彿鍐呯殑鏃佺櫧鎻忚堪锛堝锛氾紙澶у閮界瑧浜嗭級锛夛紝璇风洿鎺ョ敤鏂囧瓧鎴栬〃鎯呭寘琛ㄧ幇銆俓n- **绂佹**閫昏緫澶畬缇庛€傛椿浜虹殑瀵硅瘽寰€寰€鏄€昏緫鏂鐨勩€佹儏缁寲鐨勩€俓n\n### 馃摛 寮哄埗杈撳嚭鑴氭湰鏍煎紡\n璇蜂弗鏍奸伒瀹堜互涓嬬鍙疯鍒欙紝涓嶈杈撳嚭浠讳綍澶氫綑鐨勮В閲婏細\n1. **銆愯鑹插悕銆?*锛氬繀椤讳笌鍚嶅崟瀹屽叏涓€鑷淬€俓n2. **\\** (鍙嶆枩鏉?锛氱敤浜庡悓涓€涓汉鐨勮繛缁皵娉★紙姘旀场杩炲嚮锛夈€俓n3. **锛?* (鍏ㄨ鍒嗗彿)锛氱敤浜庡垎闅斾笉鍚屼汉鐨勫彂瑷€鍥炲悎銆俓n\n**绁炵骇鑼冧緥 (瀛︿範杩欑娣蜂贡鎰?锛?*\n銆愭潕鍥涖€戝崸妲絓\鐪熺殑鍋囩殑锛燂紱銆愮帇浜斻€戣〃鎯呭寘锛氬悆鐡淺\@鏉庡洓 浣犳潙閫氱綉锛燂紱銆愬紶涓夈€戯紙鍥炲鐢ㄦ埛锛夋垜瑙夊緱涓嶈\\澶吹浜嗭紱銆愯档鍏€戜腑鍗堢偣澶栧崠鍚梊\琛ㄦ儏鍖咃細楗夸簡锛涖€愭潕鍥涖€戝埆鎵撳矓锛佸惉妤间富璇达紱銆怳ser's Best Friend銆戝搱鍝堝搱鍝堝搱鍝圽n\n### 馃幀 Action!\n闃呰涓嬫柟鐨勩€愭渶杩戣亰澶╄褰曘€戯紝浣滀负瀵兼紨锛岃绔嬪嵆瀹夋帓涓€鍦?*鍏ㄥ憳鍙備笌銆佹贩涔辫€岀湡瀹?*鐨勭兢鑱婂ぇ鎴忥紒\n\n### 鏈€杩戣亰澶╄褰昞n${chat_history}\n";e.bilingualBubble&&e.bilingualBubble.enabled&&(r+='\n瀵硅瘽缈昏瘧鏍煎紡寮哄埗瑙勫垯\n涓€銆佹牳蹇冩牸寮忚姹傦紙涓ョ杩炰綋搴旂瓟锛塡n1. 缈昏瘧鍒嗛殧鏍囪锛氳緭鍑哄唴瀹瑰寘鍚璇?鏂硅█鏃讹紝姣忓彞璇濇湯灏惧繀椤讳娇鐢?[Split] 鍒嗛殧绗︼紝绱ч殢鍏跺悗鏍囨敞涓枃缈昏瘧銆俓n2. 姘旀场寮哄埗鍒嗛殧锛氥€愰噸瑕併€戞瘡涓€缁?"鍘熸枃[Split]璇戞枃" 缁撴潫鍚庯紝蹇呴』寮哄埗浠?\\\\ (鍗冲崟涓弽鏂滄潬) 缁撳熬銆傝繖鍐冲畾浜嗘皵娉℃槸鍚﹁兘姝ｇ‘鍒嗘銆備弗绂佸皢澶氱粍瀵硅瘽杩炲湪鍚屼竴琛岃緭鍑猴紒\n3. 鍔ㄤ綔鎻忚堪澶勭悊锛氫互 * * 鍖呰９鐨勫姩浣滄弿杩板唴瀹癸紝鏃犻渶缈昏瘧锛屼繚鐣欏師鏍枫€俓n\n浜屻€佹纭ず渚嬶紙璇蜂弗鏍兼ā浠挎崲琛屽拰鍙嶆枩鏉狅級\nHello, world.[Split]浣犲ソ锛屼笘鐣屻€俓\\\\nHow are you today?[Split]浣犱粖澶╁ソ鍚楋紵\\\\\nI\'m fine, thank you.[Split]鎴戝緢濂斤紝璋㈣阿浣犮€俓\\\\n\n涓夈€侀敊璇涓鸿绀猴紙缁濆绂佹锛塡n鉂?閿欒锛欻ello.[Split]浣犲ソ銆侶ow are you?[Split]浣犲ソ鍚楋紵 锛堜袱鍙ヨ瘽杩炲湪涓€璧凤紝瀵艰嚧瑙ｆ瀽澶辫触锛塡n鉁?姝ｇ‘锛欻ello.[Split]浣犲ソ銆俓\\\\n         How are you?[Split]浣犲ソ鍚楋紵\\\\\n锛堟敞鎰忥細蹇呴』鏄惧紡鎹㈣锛屼笖姣忚鏈熬蹇呴』鏈夊弽鏂滄潬 \\\\ 锛侊級\n\n鍥涖€佺壒娈婂満鏅痋n1. 绾腑鏂囧唴瀹癸細鏃犻渶 [Split]锛屼絾浠嶅缓璁互 \\\\ 缁撳熬浠ョ‘淇濆垎姘旀场銆俓n2. 鏂硅█鍐呭锛氫綘椋熷挆楗湭锛焄Split]浣犲悆楗簡鍚楋紵\\\\\n');const l=r.replace(/\$\{group_name\}/g,e.name).replace(/\$\{current_time\}/g,(new Date).toLocaleString()).replace(/\$\{member_personas\}/g,n).replace(/\$\{context_info\}/g,`涓栫晫瑙傝瀹氾細\n${o}`).replace(/\$\{emoji_list\}/g,i).replace(/\$\{chat_history\}/g,a);console.log("缇よ亰瀵兼紨Prompt鏋勫缓瀹屾垚锛屽噯澶囪姹?..");try{const n=await Kl.loadData("settingsStore","apiSettings");if(!n||!n.value.url)throw new Error("API鏈厤缃?);const{url:a,key:o,model:s}=n.value;let i=a.endsWith("/")?a.slice(0,-1):a;i+="/chat/completions";const r=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:s,messages:[{role:"system",content:l},{role:"user",content:"(绯荤粺鎸囦护锛氳鏍规嵁鍓ф儏鍙戝睍锛岀敓鎴愭帴涓嬫潵鐨勭兢鑱婂璇濊剼鏈€?"}],temperature:1.1})});if(!r.ok)throw new Error("缃戠粶璇锋眰澶辫触");const c=(await r.json()).choices[0].message.content;console.log("鏀跺埌鍓ф湰:",c),await async function(e,t,n){const a=e.split(/;|锛?).map(e=>e.trim()).filter(e=>e);for(const e of a){const a=e.match(/[\[銆怾(.*?)[\]銆慮\s*(.*)/);if(!a)continue;const o=a[1].trim(),s=a[2].trim(),i=n.find(e=>e.ai.name===o);if(!i)continue;const r=s.split(/\\|\\/).map(e=>e.trim()).filter(e=>e);for(const e of r){const n={sender:"ai",memberId:i.id,senderName:i.ai.name,senderAvatar:i.ai.avatar,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)},a=Wm(e);if(a){const e=a.url||xl.get(a.keyword);e?(n.type="sticker",n.url=e,n.text=`[琛ㄦ儏鍖咃細${a.keyword}]`):(n.type="text",n.text=`*鍙戦€佷簡琛ㄦ儏鍖? ${a.keyword}*`)}else n.type="text",n.text=e;const o=jm(),s=Math.min(Math.max(100*e.length,1e3),3e3);await new Promise(e=>setTimeout(e,s)),o&&o.remove(),await _m(n,t.id),Um(n)}}}(c,e,t)}catch(e){console.error("缇よ亰鐢熸垚澶辫触:",e),alert("缇よ亰鐢熸垚澶辫触锛岃妫€鏌ョ綉缁滄垨API璁剧疆")}}function Wm(e){if(!e||"string"!=typeof e)return null;const t=[/(?:琛ㄦ儏鍖厊璐村浘|sticker)[锛?]\s*[\[銆怾([^:\]銆慮+):(\s*https?:\/\/[^\]銆慭s]+)\s*[\]銆慮/i,/(?:琛ㄦ儏鍖厊璐村浘|sticker)[锛?]\s*[\[銆怾([^\]銆慮+)[\]銆慮/i,/(?:琛ㄦ儏鍖厊璐村浘|sticker)[锛?]\s*([^\s\[\]銆愩€?)锛堬級]+)/i,/[锛?](?:琛ㄦ儏鍖厊璐村浘|sticker)[锛?]\s*([^)锛塢+)[)锛塢/i];for(const n of t){const t=e.match(n);if(t){const e=t[1].trim(),n=t[2]?t[2].trim():null;if(e)return{keyword:e,url:n}}}return null}function jm(){const e=document.createElement("div");e.className="message-row ai typing-indicator";const t=document.createElement("div");t.className="message-content-wrapper ai";const n=document.createElement("div");return n.className="chat-bubble ai-bubble",n.style.marginLeft="10px",n.innerHTML='<div class="typing-animation"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>',t.appendChild(n),e.appendChild(t),Xi.appendChild(e),Xi.scrollTop=Xi.scrollHeight,e}function Um(e,t=null){const n=performance.now(),a=window.profiler;a&&a.isRecording&&a.startTimer("馃帹 娓叉煋缇よ亰娑堟伅",{sender:e.sender,type:e.type,hasImage:!!e.image});const o=t||Xi;if(!e)return null;if("call_summary"===e.type)return null;let s="",i="",r="";if("user"===e.sender)s=Je.userCardAvatar||"https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me",i=Je.userCardName||"鎴?,r="user-me";else{let t=null;Je&&Je.memberMap&&e.memberId&&(t=Je.memberMap[e.memberId]),t&&t.ai?(s=t.ai.avatar,i=t.ai.name):(s=e.senderAvatar||"https://placehold.co/100x100/ccc/fff?text=?",i=e.senderName||"缇ゅ弸"),r=e.memberId||"unknown"}const l=document.createElement("div");l.className="message-row",e.uuid&&(l.dataset.uuid=e.uuid),l.dataset.senderId=String(r),l.dataset.styleMemberId=String(r),"user"===e.sender&&l.classList.add("is-user");const c=document.createElement("div");c.className="selection-indicator";const d=document.createElement("div");d.className="chat-avatar-container";const u=document.createElement("img");u.className="chat-avatar",u.src=s;const m=Je.avatarSettings&&Je.avatarSettings.radius||"50%";u.style.borderRadius=m,u.dataset.action="edit-bubble-style",u.dataset.memberId=r,u.dataset.isUser="user"===e.sender;const p=document.createElement("div");if(p.className="group-nickname",p.textContent=i,d.appendChild(u),"user"===e.sender&&Je.userAvatarPendant){const e=document.createElement("div");e.className="avatar-pendant",e.style.backgroundImage=`url('${Je.userAvatarPendant}')`,d.appendChild(e)}const g=document.createElement("div");g.className="msg-column";const y=document.createElement("div");y.className="group-message-wrapper","user"===e.sender?y.classList.add("user"):y.classList.add("ai");let h=document.createElement("div");if("html"===e.type&&e.content){y.classList.add("is-html-content");const t=document.createElement("iframe");t.className="html-render-container",t.srcdoc=e.content.html,h=t}else if("sticker"!==e.type&&"image"!==e.type||!e.url)if("voice_text"===e.type){const t="user"===e.sender?"gp-user-bubble":"gp-ai-bubble";h.className=`${t} voice-text-bubble`,h.innerHTML=`<div class="voice-display-area"><div class="voice-duration">${e.duration||0}s</div></div><div class="voice-transcript">${e.transcript}</div>`}else{const t=e.text||"",n=/\[CHAT_HISTORY_START\]([\s\S]*?)\[CHAT_HISTORY_END\]/,a=/(?:^|\n)\s*杞处[:锛歖([\d.]+)-(.*)/,o=t.match(n),s=t.match(a);if(t.includes("[Split]")&&t.includes("\\")){h=document.createElement("div"),h.style.display="flex",h.style.flexDirection="column",h.style.gap="8px",h.style.alignItems="user"===e.sender?"flex-end":"flex-start";t.split("\\").filter(e=>""!==e.trim()).forEach(t=>{const n=t.split("[Split]"),a=document.createElement("div"),o="user"===e.sender?"gp-user-bubble":"gp-ai-bubble";if(a.className=o,n.length>=2){const e=n[0],t=n[1];a.style.display="flex",a.style.flexDirection="column",a.innerHTML=`\n                            <div>${zc(e)}</div>\n                            <div style="height:1px; background:currentColor; opacity:0.2; margin:6px 0 4px 0;"></div>\n                            <div style="font-weight:500;">${zc(t)}</div>\n                         `}else a.innerHTML=zc(t);h.appendChild(a)})}else if(o){const e=o[1].trim().split("\n").filter(e=>""!==e.trim());let t="鑱婂ぉ璁板綍",n=e;e.length>0&&e[0].startsWith("鏍囬锛?)&&(t=e[0].replace("鏍囬锛?,"").trim(),n=e.slice(1)),h=document.createElement("div"),h.className="history-card-bubble",h.dataset.historyTitle=t,h.dataset.historyContent=JSON.stringify(n),h.style.cssText="background: white; border-radius: 12px; padding: 12px; width: 220px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; text-align: left;";const a=n.slice(0,2).map(e=>`<div style="font-size: 12px; color: #888; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e}</div>`).join("");h.innerHTML=`\n                    <div style="font-size: 15px; font-weight: 500; color: #000; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 6px;">${t}</div>\n                    ${a}\n                    <div style="margin-top: 8px; font-size: 10px; color: #ccc; border-top: 1px solid #f0f0f0; padding-top: 4px;">鐐瑰嚮鏌ョ湅璇︽儏</div>\n                `}else if(s){h=document.createElement("div");const t=s[1],n=s[2].trim(),a="user"===e.sender,o=e.transferStatus||"pending";h.style.background="transparent",h.style.padding="0",h.innerHTML=dg(t,n,e.uuid||Date.now(),a,o)}else{h=document.createElement("div");const n="user"===e.sender?"gp-user-bubble":"gp-ai-bubble";h.className=n,h.innerHTML=zc(t)}}else{if(h=document.createElement("img"),"sticker"===e.type)h.className="sticker-bubble-plain";else{const t="user"===e.sender?"gp-user-bubble":"gp-ai-bubble";h.className=`${t} image-bubble`}h.src=e.url}if(e.replyTo){const t=document.createElement("div");if(t.className="reply-quote-container",t.innerHTML=`\n            <div class="reply-quote-name">${e.replyTo.senderName}</div>\n            <div class="reply-quote-text">${e.replyTo.text}</div>\n        `,t.onclick=t=>{t.stopPropagation();const n=document.getElementById("chat-messages-container").querySelector(`.message-row[data-uuid="${e.replyTo.uuid}"]`);n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("message-highlight"),setTimeout(()=>n.classList.remove("message-highlight"),1500))},"DIV"!==h.tagName||h.classList.contains("image-bubble")){const n=document.createElement("div"),a="user"===e.sender?"gp-user-bubble":"gp-ai-bubble";n.className=a,h.classList.remove("chat-bubble","user-bubble","ai-bubble","gp-user-bubble","gp-ai-bubble"),h.style.maxWidth="100%",h.style.borderRadius="8px",n.appendChild(t),n.appendChild(h),h=n}else h.insertBefore(t,h.firstChild)}if(y.appendChild(h),Je&&Je.timestampSettings&&Je.timestampSettings.show&&e.timestamp){const t=new Date(e.timestamp),n=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`,a=document.createElement("div");a.className="message-timestamp",a.style.cssText="font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; pointer-events: none;",a.textContent=n,y.appendChild(a)}g.appendChild(p),g.appendChild(y),"user"===e.sender?(l.appendChild(g),l.appendChild(d)):(l.appendChild(d),l.appendChild(g)),l.appendChild(c),a&&a.isRecording&&a.startTimer("馃搶 鎻掑叆DOM"),o.appendChild(l),a&&a.isRecording&&a.endTimer("馃搶 鎻掑叆DOM"),a&&a.isRecording&&a.startTimer("馃帹 娉ㄥ叆鏍峰紡",{memberId:r}),Jm(r),a&&a.isRecording&&a.endTimer("馃帹 娉ㄥ叆鏍峰紡");const v=()=>{o.scrollHeight-o.scrollTop-o.clientHeight<100&&(o.scrollTop=o.scrollHeight)};window._groupScrollTimeout&&clearTimeout(window._groupScrollTimeout),a&&a.isRecording&&a.startTimer("馃摐 婊氬姩鍒板簳閮?),window._groupScrollTimeout=setTimeout(()=>{requestAnimationFrame(v),a&&a.isRecording&&a.endTimer("馃摐 婊氬姩鍒板簳閮?)},50);const f=performance.now();return window.ChatPerformanceMonitor&&window.ChatPerformanceMonitor.enabled&&window.ChatPerformanceMonitor.recordOperation("addGroupMessageToView",f-n,{messageType:e.type,sender:e.sender}),a&&a.isRecording&&a.endTimer("馃帹 娓叉煋缇よ亰娑堟伅"),l}function zm(e,t,n){const a=String(e);let o="";const s=(e,t,n,a)=>`\n            ${a} { \n                background-color: ${e}; \n                color: ${t};\n                border: none;\n            }\n            ${a}::before, ${a}::after {\n                background: none;\n                ${"right"===n?`border-left-color: ${e}; border-right-color: transparent;`:`border-right-color: ${e}; border-left-color: transparent;`}\n                border-top-color: transparent;\n                border-bottom-color: transparent;\n            }\n        `;if("group"!==t)return null;{const t=window.currentOpenGroup;o=t&&t.memberStyles&&t.memberStyles[e]?t.memberStyles[e]:"user-me"===a||a.startsWith("user")?s("#000000","#ffffff","right",".gp-user-bubble"):s("#ffffff","#000000","left",".gp-ai-bubble")}if(o){const e=`[data-style-member-id="${a}"]`;let t=o;return t=t.replace(/(\.gp-user-bubble|\.gp-ai-bubble)/g,`${e} $1`),t=t.replace(/(\.group-nickname)/g,`${e} $1`),t}return""}tn.addEventListener("click",()=>{Bc?(async function(){const e=Ni.querySelectorAll(".contact-checkbox:checked");if(0===e.length)return;if(!confirm(`纭畾鍒犻櫎閫変腑鐨?${e.length} 椤瑰悧锛焋))return;const t=new Set;if(e.forEach(e=>{const n=e.closest(".contact-item").dataset.contactId||e.closest(".contact-item").dataset.groupId;t.add(parseInt(n,10))}),"single"===Kt){const e=(await Kl.loadData("messageContacts","allContacts")).value.filter(e=>!t.has(e.id));await Kl.saveData("messageContacts","allContacts",e)}else{const e=await Kl.loadData("groupChats","allGroupChats"),n=(e?e.value:[]).filter(e=>!t.has(e.id));await Kl.saveData("groupChats","allGroupChats",n)}Hm()}(),function(){Bc=!1,Ni.classList.remove("delete-mode"),nn&&(nn.style.display="block");an&&(an.style.display="none");tn.classList.remove("delete-mode-active"),en.style.opacity="1",en.style.pointerEvents="auto",Ni.querySelectorAll(".contact-checkbox").forEach(e=>e.checked=!1)}()):function(){Bc=!0,Ni.classList.add("delete-mode"),nn&&(nn.style.display="none");an&&(an.style.display="block");tn.classList.add("delete-mode-active"),en.style.opacity="0.3",en.style.pointerEvents="none"}()}),Qt.addEventListener("click",()=>{Nt.style.opacity="0",setTimeout(()=>{Nt.style.display="none"},300)}),Qt.addEventListener("click",()=>{Nt.style.opacity="0",setTimeout(qm,300)}),Ft.addEventListener("click",()=>{Rt.style.display="flex",Gt.style.display="none",jt.style.display="none",Ft.style.display="none",_t.textContent="鍒涘缓缇よ亰"}),Vt.onclick=()=>{const e=prompt("璇疯緭鍏ョ兢鍚嶇О锛?,"鏂板缓缇よ亰");e&&Nm(e,[])},zt.onclick=async()=>{Rt.style.display="none",Gt.style.display="block",jt.style.display="flex",Ft.style.display="block",_t.textContent="閫夋嫨鎴愬憳",Wt.innerHTML='<p style="text-align:center; color:#888;">鍔犺浇涓?..</p>';try{const e=await Kl.loadData("messageContacts","allContacts"),t=e&&Array.isArray(e.value)?e.value:[];if(Wt.innerHTML="",0===t.length)return void(Wt.innerHTML='<p style="text-align:center; padding:20px;">娌℃湁鑱旂郴浜哄彲閫?/p>');t.forEach(e=>{const t=document.createElement("div");t.className="contact-item",t.innerHTML=`\n                <input type="checkbox" class="contact-checkbox" value="${e.id}" style="display:block; margin-right:15px;">\n                <img src="${e.ai.avatar}" class="contact-avatar">\n                <div class="contact-info">\n                    <div class="contact-name">${e.ai.name}</div>\n                    <div class="contact-last-message" style="font-size:12px; color:#999;">User: ${e.user.name}</div>\n                </div>\n            `,t.onclick=e=>{if("checkbox"!==e.target.type){const e=t.querySelector("input");e.checked=!e.checked}},Wt.appendChild(t)})}catch(e){console.error(e),Wt.innerHTML="鍔犺浇澶辫触"}},Ut.onclick=()=>{const e=Wt.querySelectorAll(".contact-checkbox:checked"),t=Array.from(e).map(e=>parseInt(e.value));if(0===t.length)return void alert("璇疯嚦灏戦€夋嫨涓€涓垚鍛橈紒");const n=prompt("璇疯緭鍏ョ兢鍚嶇О锛?,"鏂扮兢鑱?);n&&Nm(n,t)},window.renderWorldBookMultiselect=async function(e,t,n=!1){if(e){e.innerHTML='<p style="color:#888; font-size:12px; text-align:center;">鍔犺浇涓?..</p>';try{const a=await Kl.loadData("worldBookGroups","allGroups"),o=await Kl.loadData("worldBooks","allWorldBooks"),s=a&&Array.isArray(a.value)?a.value:[],i=o&&Array.isArray(o.value)?o.value:[];if((!t.linkedWorldBookIds||0===t.linkedWorldBookIds.length)&&t.linkedWorldBookGroupIds&&t.linkedWorldBookGroupIds.length>0){const e=new Set;s.forEach(n=>{t.linkedWorldBookGroupIds.includes(n.id)&&Array.isArray(n.bookIds)&&n.bookIds.forEach(t=>e.add(t))}),t.linkedWorldBookIds=Array.from(e),n&&window.dbHelper}t.linkedWorldBookIds||(t.linkedWorldBookIds=[]);const r=new Set(t.linkedWorldBookIds);e.innerHTML="";const l=new Map;if(i.forEach(e=>l.set(e.id,e)),0===s.length&&0===i.length)return void(e.innerHTML='<p style="color:#888; font-size:12px; text-align:center;">鏆傛棤涓栫晫涔?/p>');s.forEach(a=>{const o=document.createElement("div");o.style.marginBottom="15px";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="space-between",s.style.marginBottom="8px";const i=document.createElement("div");i.textContent="鈻?"+a.name,i.style.fontSize="14px",i.style.fontWeight="bold",i.style.color="#333",i.style.cursor="pointer",i.style.flex="1";const c=document.createElement("button");c.textContent="鍏ㄩ€?,c.style.cssText="\n                    font-size: 12px; \n                    padding: 2px 8px; \n                    margin-left: 10px; \n                    border: 1px solid #3a3a3c; \n                    color: #3a3a3c; \n                    background: transparent; \n                    border-radius: 4px; \n                    cursor: pointer;\n                ",s.appendChild(i),s.appendChild(c),o.appendChild(s);const d=document.createElement("div");d.style.display="none",d.style.flexDirection="column",d.style.gap="8px",d.style.paddingLeft="10px",d.style.borderLeft="2px solid #eee";let u=!1;const m=[];Array.isArray(a.bookIds)&&a.bookIds.forEach(e=>{const a=l.get(e);if(a){u=!0;const o=document.createElement("label");o.className="multiselect-item-row",o.style.display="flex",o.style.alignItems="center",o.style.cursor="pointer";const s=r.has(e),i=document.createElement("input");i.type="checkbox",i.value=e,i.checked=s,i.style.marginRight="8px",i.style.transform="scale(1.2)",m.push(i);const l=document.createElement("span");l.style.fontSize="14px",l.style.color="#555",l.textContent=a.name,o.appendChild(i),o.appendChild(l),i.addEventListener("change",async()=>{if(i.checked?t.linkedWorldBookIds.includes(e)||t.linkedWorldBookIds.push(e):t.linkedWorldBookIds=t.linkedWorldBookIds.filter(t=>t!==e),n)try{const e=await Kl.loadData("groupChats","allGroupChats");let n=e?e.value:[];const a=n.findIndex(e=>e.id===t.id);a>-1&&(n[a]=t,await Kl.saveData("groupChats","allGroupChats",n))}catch(e){console.error("AutoSave Failed",e)}}),d.appendChild(o)}}),u||(d.innerHTML='<span style="color:#ccc; font-size:12px;">(绌哄垎缁?</span>'),o.appendChild(d),e.appendChild(o),i.onclick=()=>{const e="none"===d.style.display;d.style.display=e?"flex":"none",i.textContent=(e?"鈻?":"鈻?")+a.name},c.onclick=async e=>{if(e.stopPropagation(),!a.bookIds||0===a.bookIds.length)return;const o=a.bookIds.filter(e=>l.has(e)),s=!o.every(e=>t.linkedWorldBookIds.includes(e));if(o.forEach(e=>{const n=t.linkedWorldBookIds.indexOf(e);s?-1===n&&t.linkedWorldBookIds.push(e):n>-1&&t.linkedWorldBookIds.splice(n,1)}),m.forEach(e=>{e.checked=s}),n)try{const e=await Kl.loadData("groupChats","allGroupChats");let n=e?e.value:[];const a=n.findIndex(e=>e.id===t.id);a>-1&&(n[a]=t,await Kl.saveData("groupChats","allGroupChats",n))}catch(e){console.error("Batch AutoSave Failed",e)}}})}catch(t){console.error("鍔犺浇涓栫晫涔﹀け璐?,t),e.innerHTML='<p style="color:red;">鍔犺浇閿欒</p>'}}},Et.onclick=async()=>{const e=prompt("璇疯緭鍏ユ柊鐨勭兢鍚嶇О锛?,Je.name);if(e&&""!==e.trim()){Je.name=e.trim(),At.textContent=Je.name,Zi.textContent=Je.name+` (${Je.members.length})`;let t=(await Kl.loadData("groupChats","allGroupChats")).value;const n=t.findIndex(e=>e.id===Je.id);n>-1&&(t[n]=Je,await Kl.saveData("groupChats","allGroupChats",t)),Hm()}},wt.onclick=()=>bt.click(),bt.onchange=async e=>{const t=e.target.files[0];if(t){e.target.value="";try{let e;e=window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>512e3?await window.iOSBabyMode.safeCompressImage(t,{maxWidth:400,maxHeight:400,quality:.8}):window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),Je.avatar=e,wt.style.backgroundImage=`url('${e}')`;let n=(await Kl.loadData("groupChats","allGroupChats")).value;const a=n.findIndex(e=>e.id===Je.id);a>-1&&(n[a]=Je,await Kl.saveData("groupChats","allGroupChats",n)),Hm()}catch(e){console.error("缇ゅご鍍忎笂浼犲け璐?",e),alert(`鉂?缇ゅご鍍忎笂浼犲け璐n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}}},void 0!==pt&&pt&&(gt&&(gt.onchange=async e=>{const t=e.target.files[0];if(t){e.target.value="";try{let e;e=window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>512e3?await window.iOSBabyMode.safeCompressImage(t,{maxWidth:400,maxHeight:400,quality:.8}):window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),yt.src=e}catch(e){console.error("澶村儚涓婁紶澶辫触:",e),alert("鉂?澶村儚涓婁紶澶辫触")}}}),pt.onclick=async()=>{const e=ht.value.trim(),t=vt.value.trim(),n=yt.src;if(!e)return void alert("瑙掕壊鍚嶇О涓嶈兘涓虹┖");let a=-1;if(nt&&(a=Je.members.findIndex(e=>e.id===nt)),a>-1){Je.members[a].name=e,Je.members[a].persona=t,Je.members[a].avatar=n;let o=(await window.dbHelper.loadData("groupChats","allGroupChats")).value;const s=o.findIndex(e=>e.id===Je.id);s>-1&&(o[s]=Je,await window.dbHelper.saveData("groupChats","allGroupChats",o)),Rm(),ut.style.opacity="0",setTimeout(()=>{ut.style.display="none"},300)}else alert("鏈壘鍒版垚鍛樹俊鎭?)},void 0!==mt&&mt&&(mt.onclick=()=>{ut.style.display="none"})),It.onclick=()=>{St.src=Je.userCardAvatar||"https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me",$t.value=Je.userCardName||"鎴?,ft.value=Je.userCardPersona||"",Lt.style.display="flex",setTimeout(()=>{Lt.style.opacity="1"},10)},Ct.onchange=e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{St.src=e.target.result},e.readAsDataURL(t)}},document.getElementById("close-group-user-modal").onclick=()=>{Lt.style.opacity="0",setTimeout(()=>{Lt.style.display="none"},300)},Bt.onclick=()=>Lt.style.display="none",Ct.onchange=e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>St.src=e.target.result,e.readAsDataURL(t)}},Mt.onclick=async()=>{const e=$t.value.trim()||"鎴?,t=ft.value.trim(),n=St.src;Je.userCardName=e,Je.userCardAvatar=n,Je.userCardPersona=t,kt.textContent=e,xt.style.backgroundImage=`url('${n}')`;let a=(await Kl.loadData("groupChats","allGroupChats")).value;const o=a.findIndex(e=>e.id===Je.id);o>-1&&(a[o]=Je,await Kl.saveData("groupChats","allGroupChats",a)),Lt.style.display="none"},mt.onclick=()=>{ut.style.opacity="0",setTimeout(()=>{ut.style.display="none"},300)},gt.onchange=e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{yt.src=e.target.result},e.readAsDataURL(t)}},pt.onclick=async()=>{if(!nt)return;const e=ht.value.trim(),t=vt.value.trim(),n=yt.src,a=await Kl.loadData("messageContacts","allContacts");let o=a?a.value:[];const s=o.findIndex(e=>e.id===nt);if(s>-1){o[s].ai.name=e,o[s].ai.persona=t,o[s].ai.avatar=n,await Kl.saveData("messageContacts","allContacts",o),"undefined"!=typeof currentContact&&currentContact&&currentContact.id===nt&&(currentContact.ai.name=e,currentContact.ai.persona=t,currentContact.ai.avatar=n);try{const t=await Kl.loadData("groupChats","allGroupChats");let a=t&&Array.isArray(t.value)?t.value:[],i=!1;a.forEach(t=>{if(t.history&&Array.isArray(t.history)&&t.history.length>0){let a=!1;t.history.forEach(t=>{(t.memberId&&String(t.memberId)===String(nt)||!t.memberId&&t.senderName===o[s].ai.name)&&(t.senderName=e,t.senderAvatar=n,a=!0)});const r=t.history[t.history.length-1];if(r.memberId&&String(r.memberId)===String(nt)||!r.memberId&&r.senderName===e){let n=r.text||"[澶氬獟浣揮";"sticker"===r.type&&(n="[琛ㄦ儏鍖匽"),"image"===r.type&&(n="[鍥剧墖]"),"voice_text"===r.type&&(n="[璇煶]"),t.lastMessage=`${e}: ${n}`,a=!0}a&&(i=!0,Je&&Je.id===t.id&&(Je.history=t.history,Je.lastMessage=t.lastMessage))}}),i&&await Kl.saveData("groupChats","allGroupChats",a)}catch(e){console.error("鍚屾鍘嗗彶璁板綍澶辫触:",e)}document.querySelectorAll(`.message-row[data-sender-id="${nt}"]`).forEach(t=>{const a=t.querySelector(".group-nickname");a&&(a.textContent=e);const o=t.querySelector(".chat-avatar");o&&(o.src=n)}),Rm(),Hm(),ut.style.display="none"}},st.onclick=()=>{ot.style.opacity="0",setTimeout(()=>{ot.style.display="none"},300)},rt.onchange=e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{lt.src=e.target.result},e.readAsDataURL(t)}},it.onclick=async()=>{const e=ct.value.trim();if(!e)return void alert("璇疯緭鍏ヨ鑹插悕绉?);const t={id:Date.now(),isHidden:!0,ai:{name:e,persona:dt.value.trim(),avatar:lt.src},user:{name:"鎴?,persona:"",avatar:"https://placehold.co/100x100/EFEFEF/AAAAAA?text=User"},contextMemory:10,lastMessage:"鏂拌鑹插凡鍒涘缓"},n=await Kl.loadData("messageContacts","allContacts");let a=n&&Array.isArray(n.value)?n.value:[];if(a.push(t),await Kl.saveData("messageContacts","allContacts",a),Je){Je.members||(Je.members=[]),Je.members.push(t.id);let e=(await Kl.loadData("groupChats","allGroupChats")).value;const n=e.findIndex(e=>e.id===Je.id);n>-1&&(e[n]=Je,await Kl.saveData("groupChats","allGroupChats",e))}Rm(),ot.style.display="none"},at.addEventListener("click",e=>{e.target===at&&(at.style.opacity="0",setTimeout(()=>{at.style.display="none"},300))}),window.batchInjectGroupStyles=function(e,t){if(!e)return;performance.now();window.profiler&&window.profiler.isRecording&&window.profiler.startTimer("馃帹 鎵归噺娉ㄥ叆鏍峰紡");const n=`group-style-batch-${e}`;let a="";const o=new Set,s=zm("user-me","group");s&&(a+=s,o.add("user-me")),t&&Array.isArray(t)&&t.forEach(e=>{const t=String(e);if(!o.has(t)){const e=zm(t,"group");e&&(a+=e,o.add(t))}});let i=document.getElementById(n);i||(i=document.createElement("style"),i.id=n,document.head.appendChild(i)),i.textContent=a,window.injectedStylesCache||(window.injectedStylesCache=new Set),o.forEach(t=>{const n=`style-group-${e}-${t}`;window.injectedStylesCache.add(n)}),window.profiler&&window.profiler.isRecording&&window.profiler.endTimer("馃帹 鎵归噺娉ㄥ叆鏍峰紡")};const Vm=new Set;async function Jm(e){const t=performance.now();if(!e)return;const n=String(e),a=document.getElementById("chat-messages-container"),o=a.dataset.contextMode,s=a.dataset.contextId;if(!o||!s)return;const i=`style-${o}-${s}-${n}`;if(Vm.has(i)){const e=performance.now();return void(window.ChatPerformanceMonitor&&window.ChatPerformanceMonitor.enabled&&window.ChatPerformanceMonitor.recordOperation("injectMemberStyle",e-t,{memberId:n,cached:!0}))}let r="";const l=(e,t,n,a)=>`\n            ${a} { \n                background-color: ${e}; \n                color: ${t};\n                border: none;\n            }\n            ${a}::before, ${a}::after {\n                background: none;\n                ${"right"===n?`border-left-color: ${e}; border-right-color: transparent;`:`border-right-color: ${e}; border-left-color: transparent;`}\n                border-top-color: transparent;\n                border-bottom-color: transparent;\n            }\n        `;"group"===o?r=Je&&Je.memberStyles&&Je.memberStyles[e]?Je.memberStyles[e]:"user-me"===n||n.startsWith("user")?l("#000000","#ffffff","right",".gp-user-bubble"):l("#ffffff","#000000","left",".gp-ai-bubble"):"single"===o&&(r="user-me"===n?Sc&&Sc.selfBubbleCss?Sc.selfBubbleCss:l("#95ec69","#000000","right",".chat-bubble"):Sc&&Sc.customBubbleCss?Sc.customBubbleCss:l("#ffffff","#000000","left",".chat-bubble"));let c=document.getElementById(i);if(r){c||(c=document.createElement("style"),c.id=i,document.head.appendChild(c));const e=`#chat-messages-container[data-context-id="${s}"]`,t=`.message-row[data-sender-id="${n}"]`,a=`${i}_${r.substring(0,50)}`;let o;if(window._cssTransformCache||(window._cssTransformCache=new Map),window._cssTransformCache.has(a))o=window._cssTransformCache.get(a);else{const s="user-me"===n||n.startsWith("user")?".gp-user-bubble":".gp-ai-bubble";if(o=r.replace(/(\.gp-[\w-]+|\.chat-bubble|\.user-bubble|\.ai-bubble)([\w-:]*)/g,(n,a,o)=>`${e} ${t} ${".gp-bubble"===a?s:a}${o}`),window._cssTransformCache.size>100){const e=window._cssTransformCache.keys().next().value;window._cssTransformCache.delete(e)}window._cssTransformCache.set(a,o)}c.innerHTML=o,Vm.add(i)}else c&&(c.remove(),Vm.delete(i));const d=performance.now();window.ChatPerformanceMonitor&&window.ChatPerformanceMonitor.enabled&&window.ChatPerformanceMonitor.recordOperation("injectMemberStyle",d-t,{memberId:n,cached:!1})}window.injectedStylesCache=Vm,window.clearStyleCache=function(){Vm.clear()},Dt.addEventListener("click",e=>{e.stopPropagation(),Pt.classList.add("delete-mode")}),Pt.addEventListener("click",async e=>{if(e.target.classList.contains("member-delete-btn")){e.stopPropagation();const t=parseInt(e.target.dataset.memberId,10);if(confirm("纭畾瑕佸皢杩欎綅鎴愬憳绉诲嚭缇よ亰鍚楋紵"))try{Je.members=Je.members.filter(e=>e!==t);let e=(await Kl.loadData("groupChats","allGroupChats")).value;const n=e.findIndex(e=>e.id===Je.id);n>-1&&(e[n]=Je,await Kl.saveData("groupChats","allGroupChats",e)),await Rm(),Pt.classList.add("delete-mode")}catch(e){console.error("鍒犻櫎缇ゆ垚鍛樺け璐?,e),alert("鍒犻櫎澶辫触")}}});Tt.querySelector(".modal-content");function Ym(){const e=new Date,t=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,n=document.getElementById("status-bar-time");n&&(n.textContent=t)}function Km(){const e=document.getElementById("memory-usage");if(e)if("memory"in performance){const t=performance.memory,n=(t.usedJSHeapSize/1048576).toFixed(1),a=(t.jsHeapSizeLimit/1048576).toFixed(0),o=(t.usedJSHeapSize/t.jsHeapSizeLimit*100).toFixed(0);e.textContent=`${n}MB`;const s=document.getElementById("memory-monitor");o>90?(s.style.color="#ff3b30",s.style.opacity="1"):o>70?(s.style.color="#ff9500",s.style.opacity="0.9"):(s.style.color="inherit",s.style.opacity="0.7");const i=window._lastMemoryWarningTime||0,r=Date.now();o>90&&r-i>3e5&&(window._lastMemoryWarningTime=r,console.warn(`鈿狅笍 鍐呭瓨璀﹀憡锛氬凡浣跨敤 ${o}% (${n}MB / ${a}MB)`),console.warn("寤鸿锛氬叧闂竴浜涘姛鑳芥垨鍒锋柊椤甸潰浠ラ噴鏀惧唴瀛?))}else e.textContent="--"}Tt.addEventListener("click",e=>{e.target.closest("#group-member-count")||e.target.closest(".member-delete-btn")||Pt.classList.remove("delete-mode")}),Ym(),window.TimerManager.setInterval(Ym,6e4,"status-bar-clock");const Zm=document.getElementById("memory-monitor");Zm&&Zm.addEventListener("click",()=>{if(!("memory"in performance))return void alert("褰撳墠娴忚鍣ㄤ笉鏀寔鍐呭瓨鐩戞帶");const e=performance.memory,t=(e.usedJSHeapSize/1048576).toFixed(2),n=(e.totalJSHeapSize/1048576).toFixed(2),a=(e.jsHeapSizeLimit/1048576).toFixed(0),o=(e.usedJSHeapSize/e.jsHeapSizeLimit*100).toFixed(1);alert(`馃搳 鍐呭瓨浣跨敤鎯呭喌\n\n鐘舵€? ${o>90?"馃敶 涓ラ噸":o>70?"馃煚 娉ㄦ剰":"馃煝 姝ｅ父"}\n宸茬敤: ${t} MB\n鎬昏: ${n} MB\n闄愬埗: ${a} MB\n浣跨敤鐜? ${o}%\n\n`+(o>90?"鈿狅笍 璀﹀憡锛氬唴瀛樺嵆灏嗚€楀敖锛乗n寤鸿绔嬪嵆鍒锋柊椤甸潰鎴栧叧闂儴鍒嗗姛鑳姐€?:o>70?"馃挕 鎻愮ず锛氬唴瀛樹娇鐢ㄨ緝楂榎n寤鸿鍏抽棴涓嶄娇鐢ㄧ殑鍔熻兘銆?:"鉁?鍐呭瓨浣跨敤姝ｅ父"))});let Xm=null;function Qm(){_e.style.display="none",ze=null}function ep(){Ve=null,Ge.style.display="none"}function tp(){window.DOMCleanupManager&&window.DOMCleanupManager.clean("forward-target-list"),Oe.style.opacity="0",Oe.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{Oe.style.display="none"},300)}async function np(e,t){const n=document.querySelectorAll(".message-row.selected");if(0===n.length)return void alert("璇峰厛閫夋嫨瑕佽浆鍙戠殑娑堟伅");let a="鑱婂ぉ璁板綍";Je?a=Je.name+"鐨勮亰澶╄褰?:Sc&&(a=`${Sc.user.name}涓?{Sc.ai.name}鐨勮亰澶ー);let o=`鏍囬锛?{a}\n`;n.forEach(e=>{let t="鏈煡",n="";const a=e.querySelector(".message-content-wrapper")||e.querySelector(".group-message-wrapper");if(a)if(a.classList.contains("user"))Je?t=Je.userCardName||"鎴?:Sc&&(t=Sc.user.name);else{const n=e.querySelector(".group-nickname");t=n?n.textContent:Sc?Sc.ai.name:"缇ゅ弸"}const s=e.querySelector(".chat-bubble");if(s)if(s.classList.contains("image-bubble"))n="[鍥剧墖]";else if(s.classList.contains("sticker-bubble"))n="[琛ㄦ儏鍖匽";else if(s.querySelector(".voice-transcript"))n="[璇煶]: "+s.querySelector(".voice-transcript").textContent.replace(/\n/g," ");else if(s.classList.contains("history-card-bubble"))n="[鑱婂ぉ璁板綍鍗＄墖]";else{let e=s.textContent;e=e.replace(/\[MESSAGE_START\]|\[MESSAGE_END\]/g,""),n=e.replace(/(\r\n|\n|\r)/gm," ").trim()}else n="[澶氬獟浣撴秷鎭痌";o+=`${t}锛?{n}\n`});const s=`[CHAT_HISTORY_START]\n${o}[CHAT_HISTORY_END]`;try{const n={sender:"user",text:s,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};t?await _m(n,e):await Ac(n,e),alert("宸插彂閫?),tp(),pd(),(t&&Je&&Je.id===e||!t&&Sc&&Sc.id===e)&&(t?Um(n):Vc(n),Xi.scrollTo({top:Xi.scrollHeight,behavior:"smooth"}))}catch(e){console.error("杞彂澶辫触",e),alert("杞彂澶辫触")}}function ap(e,t){const n=document.getElementById("history-detail-overlay"),a=document.getElementById("history-detail-title"),o=document.getElementById("history-detail-content");a.textContent=e,Array.isArray(t)||(t=[t]);const s=t.map(e=>{const t=e.match(/^(.*?)(:|锛?(.*)/);let n="绯荤粺",a=e;return t&&(n=t[1].trim(),a=t[3].trim()),a=a.replace(/\n/g,"<br>"),`\n            <div class="history-row">\n                <div class="history-meta">${n}</div>\n                <div class="history-bubble">${a}</div>\n            </div>\n        `}).join("");o.innerHTML=s,o.scrollTop=0,n.style.display="flex",setTimeout(()=>{n.style.opacity="1"},10)}function op(){$e.style.opacity="0",$e.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{$e.style.display="none"},300)}function sp(){xe.classList.toggle("active"),ke.classList.toggle("active")}Ke.addEventListener("click",()=>{Ii.classList.add("show-about-device"),Km(),Xm||(Xm=window.TimerManager.setInterval(Km,3e4,"memory-monitor"))}),Ze.addEventListener("click",()=>{Ii.classList.remove("show-about-device"),Xm&&(window.TimerManager.clearInterval(Xm),Xm=null)}),He.addEventListener("click",async()=>{if(0!==document.querySelectorAll(".message-row.selected").length){qe.innerHTML='<p style="text-align:center; padding:20px; color:#888;">鍔犺浇涓?..</p>',Oe.style.display="flex",setTimeout(()=>{Oe.style.opacity="1",Oe.querySelector(".modal-content").style.transform="scale(1)"},10);try{const e=await Kl.loadData("messageContacts","allContacts"),t=await Kl.loadData("groupChats","allGroupChats"),n=e&&Array.isArray(e.value)?e.value:[],a=t&&Array.isArray(t.value)?t.value:[];if(qe.innerHTML="",a.length>0){const e=document.createElement("div");e.textContent="缇よ亰",e.style.cssText="padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;",qe.appendChild(e),a.forEach(e=>{const t=document.createElement("div");t.className="invite-contact-item",t.style.cursor="pointer",t.onclick=()=>np(e.id,!0),t.innerHTML=`\n                    <img src="${e.avatar}" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.name}</span>\n                `,qe.appendChild(t)})}if(n.length>0){const e=document.createElement("div");e.textContent="鑱旂郴浜?,e.style.cssText="padding: 8px 15px; background: #f5f5f5; color: #888; font-size: 12px;",qe.appendChild(e),n.forEach(e=>{const t=document.createElement("div");t.className="invite-contact-item",t.style.cursor="pointer",t.onclick=()=>np(e.id,!1),t.innerHTML=`\n                    <img src="${e.ai.avatar}" class="invite-contact-avatar">\n                    <span class="invite-contact-name">${e.ai.name}</span>\n                `,qe.appendChild(t)})}}catch(e){console.error("鍔犺浇杞彂鍒楄〃澶辫触",e),qe.innerHTML='<p style="color:red; text-align:center;">鍔犺浇澶辫触</p>'}}else alert("璇峰厛閫夋嫨瑕佽浆鍙戠殑娑堟伅")}),Ne.addEventListener("click",tp),document.getElementById("history-detail-close-btn").addEventListener("click",function(){const e=document.getElementById("history-detail-overlay");e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300)}),Ce.addEventListener("click",()=>{id(),Te.value="",$e.style.display="flex",setTimeout(()=>{$e.style.opacity="1",$e.querySelector(".modal-content").style.transform="scale(1)",Te.focus()},10)}),Me.addEventListener("click",op),Ae.addEventListener("click",()=>{const e=Te.value.trim();if(!e)return;Dc({type:"action",text:e}),op()}),Le&&Le.addEventListener("click",()=>{id(),Be.click()}),Be&&Be.addEventListener("change",async e=>{const t=e.target.files[0];t&&(t.size>20971520?alert("鏂囦欢澶ぇ鍟︼紝璇峰彂閫?0MB浠ュ唴鐨勬枃浠躲€?):(await async function(e){const t=function(e){if(0===e)return"0 B";const t=1024,n=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(1))+" "+n[a]}(e.size),n=e.name,a=n.split(".").pop().toLowerCase(),o=new FileReader;o.onload=e=>{const o=e.target.result;Dc({type:"file_card",fileName:n,fileSize:t,fileType:a,fileUrl:o,text:`[鏂囦欢鍙戦€侊細${n} (${t})]`})},o.onerror=e=>{console.error("鏂囦欢璇诲彇澶辫触",e),alert("鏂囦欢璇诲彇澶辫触锛岃閲嶈瘯")},o.readAsDataURL(e)}(t),Be.value=""))}),document.getElementById("ai-file-viewer-close-btn").addEventListener("click",()=>{const e=document.getElementById("ai-file-viewer-modal");e.style.opacity="0",e.querySelector(".modal-content").style.transform="scale(0.95)",setTimeout(()=>{e.style.display="none"},300)}),Ee&&Ee.addEventListener("click",()=>{const e=document.getElementById("bottom-drawer");e&&e.classList.remove("active"),Ii.classList.add("show-qilang"),console.log("杩涘叆涓冩氮涓栫晫..."),lp().then(()=>{0===document.getElementById("qilang-waterfall-grid").children.length&&rp(!0)})}),ke&&ke.addEventListener("click",sp);const ip=document.getElementById("qilang-waterfall-grid");async function rp(e=!1){const t=document.getElementById("qilang-waterfall-grid");if(!e&&t.children.length>0)return;if(e){const e=document.getElementById("qilang-refresh-btn");e.style.transform="rotate(360deg)",e.style.transition="transform 1s",setTimeout(()=>e.style.transform="",1e3)}try{const e=await Lm('\n(绯荤粺鎸囦护锛氫綘鐜板湪鏄€滀竷娴狝PP鈥濈殑鍐呭鐢熸垚寮曟搸銆傝鐢熸垚 4 鏉¤櫄鏋勭殑绀句氦濯掍綋甯栧瓙銆俓n椋庢牸瑕佹眰锛歕n1. **蹇呴』杩斿洖绾?JSON 鏁扮粍鏍煎紡**锛屼弗绂佸寘鍚?Markdown 鏍囪锛堝 ```json锛夈€俓n2. 姣忔潯甯栧瓙鍖呭惈浠ヤ笅瀛楁锛歕n   - "title": 澶у瓧鏍囬锛屼笉瓒呰繃 20 涓瓧锛岃鍦ㄨ瑙変笂寰堢偢瑁傦紙渚嬪锛氶渿鎯婏紒銆佸浜轰滑璋佹噦鍟婏級銆俓n   - "content": 姝ｆ枃鍐呭锛屽彲浠ョ◢闀匡紝甯︽湁 Hashtag锛岄鏍煎彲浠ユ槸璧涘崥鏈嬪厠銆佽亴鍦哄悙妲芥垨鍙戠柉鏂囧銆俓n   - "author": 鍙戝笘浜烘樀绉帮紙甯︽湁浜鸿鎰燂紝濡傦細涓冧竷甯傞瀵屻€佹懜楸间竴绾ч€夋墜锛夈€俓n   - "likes": 鐐硅禐鏁?(鏁板瓧)銆俓n   - "comments": 涓€涓暟缁勶紝鍖呭惈 8 鏉¤矾浜鸿瘎璁恒€傛瘡鏉¤瘎璁鸿鏈?"user" (璺汉鏄电О) 鍜?"text" (璇勮鍐呭锛岃鏈夐樀钀ユ劅锛屾瘮濡傛潬绮炬垨鎹у搹)銆俓n\n鏍煎紡绀轰緥锛歕n[\n  {\n    "title": "鍏徃绌鸿皟鍧忎簡锛侌煍?,\n    "content": "鐜板湪鐨勫鍐呮俯搴︽槸45搴︼紝鎴戠殑韬綋閮借鐑瀺鍖栦簡銆傝€佹澘璇村績闈欒嚜鐒跺噳锛?#鑱屽満 #楂樻俯棰勮",\n    "author": "铻嶅寲鐨勬墦宸ヤ汉",\n    "likes": 204,\n    "comments": [\n        {"user": "鍗风帇涔嬬帇", "text": "杩欑偣鑻﹂兘鍚冧笉浜嗭紵鎴戣繕鍦ㄥ姞鐝憿銆?},\n        {"user": "鎽搁奔鍔炰富浠?, "text": "蹇幓鍘曟墍锛岄偅杈瑰噳蹇紒"}\n    ]\n  }\n]\n)');if(!e)return;const t=e.replace(/```json|```/g,"").trim(),n=JSON.parse(t),a=await Kl.loadData("qilangPosts","allPosts");let o=a&&Array.isArray(a.value)?a.value:[];o=[...n.map(e=>({id:Date.now()+Math.random(),title:e.title,content:e.content,author:e.author,likes:e.likes,timestamp:(new Date).toISOString(),comments:Array.isArray(e.comments)?e.comments:[]})),...o],await Kl.saveData("qilangPosts","allPosts",o),lp(o)}catch(e){console.error("涓冩氮鐢熸垚澶辫触:",e)}}async function lp(e=null){const t=document.getElementById("qilang-waterfall-grid");t.innerHTML="";let n=e;if(!n){const e=await Kl.loadData("qilangPosts","allPosts");n=e&&Array.isArray(e.value)?e.value:[]}n.sort((e,t)=>{const n=new Date(e.timestamp||0).getTime();return new Date(t.timestamp||0).getTime()-n}),0!==n.length?n.forEach(e=>{const n=function(e){const t=document.createElement("div");t.className="qilang-card",t.dataset.id=e.id;const n=["#5E5CE6","#FF2D55","#34C759","#FF9500","#007AFF"],a=n[Math.floor(Math.random()*n.length)],o=e.author?e.author.charAt(0):"娴?,s=["400","700","900"],i=s[Math.floor(Math.random()*s.length)],r=e.comments?e.comments.length:0,l=e.title||e.content.substring(0,15),c=`\n    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 21.6496C11.69 21.6496 11.39 21.6096 11.14 21.5196C7.32 20.2096 1.25 15.5596 1.25 8.68961C1.25 5.18961 4.08 2.34961 7.56 2.34961C9.25 2.34961 10.83 3.00961 12 4.18961C13.17 3.00961 14.75 2.34961 16.44 2.34961C19.92 2.34961 22.75 5.19961 22.75 8.68961C22.75 15.5696 16.68 20.2096 12.86 21.5196C12.61 21.6096 12.31 21.6496 12 21.6496ZM7.56 3.84961C4.91 3.84961 2.75 6.01961 2.75 8.68961C2.75 15.5196 9.32 19.3196 11.63 20.1096C11.81 20.1696 12.2 20.1696 12.38 20.1096C14.68 19.3196 21.26 15.5296 21.26 8.68961C21.26 6.01961 19.1 3.84961 16.45 3.84961C14.93 3.84961 13.52 4.55961 12.61 5.78961C12.33 6.16961 11.69 6.16961 11.41 5.78961C10.48 4.54961 9.08 3.84961 7.56 3.84961Z" fill="${e.isLiked?"#FF2D55":"#8e8e93"}"/>\n    </svg>`;var d;return t.innerHTML=`\n        <div class="q-card-title" style="font-weight:${i};">\n            ${l}\n        </div>\n        <div class="q-card-preview">\n            ${e.content}\n        </div>\n        <div class="q-card-footer">\n            <div style="display:flex; align-items:center;">\n                <div class="q-avatar-placeholder" style="width:18px; height:18px; font-size:10px; line-height:18px; text-align:center; color:white; background-color:${a}; margin-right:6px;">${o}</div>\n                <span class="q-author" style="max-width: 45px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${e.author}</span>\n            </div>\n            <div style="display:flex; gap:12px; align-items:center;">\n                <div style="display:flex; align-items:center; gap:2px;">\n                    ${c}\n                    <span style="font-size:9px; color:#8e8e93;">${d=e.likes,d>999?(d/1e3).toFixed(1)+"k":d}</span>\n                </div>\n                 <div style="display:flex; align-items:center; gap:2px;">\n                    \n    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M15.5 11.25H8.5C8.09 11.25 7.75 10.91 7.75 10.5C7.75 10.09 8.09 9.75 8.5 9.75H15.5C15.91 9.75 16.25 10.09 16.25 10.5C16.25 10.91 15.91 11.25 15.5 11.25Z" fill="#8e8e93"/>\n        <path d="M16 22.3199C15.66 22.3199 15.32 22.22 15.03 22.03L10.77 19.1899H7C3.56 19.1899 1.25 16.8799 1.25 13.4399V7.43994C1.25 3.99994 3.56 1.68994 7 1.68994H17C20.44 1.68994 22.75 3.99994 22.75 7.43994V13.4399C22.75 16.6199 20.77 18.84 17.75 19.15V20.5699C17.75 21.2199 17.4 21.8099 16.83 22.1099C16.57 22.2499 16.28 22.3199 16 22.3199ZM7 3.17993C4.42 3.17993 2.75 4.84993 2.75 7.42993V13.4299C2.75 16.0099 4.42 17.6799 7 17.6799H11C11.15 17.6799 11.29 17.7199 11.42 17.8099L15.87 20.77C15.98 20.84 16.08 20.81 16.13 20.78C16.18 20.75 16.26 20.6899 16.26 20.5599V18.4299C16.26 18.0199 16.6 17.6799 17.01 17.6799C19.59 17.6799 21.26 16.0099 21.26 13.4299V7.42993C21.26 4.84993 19.59 3.17993 17.01 3.17993H7Z" fill="#8e8e93"/>\n    </svg>\n                    <span style="font-size:9px; color:#8e8e93;">${r}</span>\n                </div>\n            </div>\n        </div>\n    `,t.addEventListener("click",()=>{dp(e)}),t}(e);t.appendChild(n)}):t.innerHTML='<p style="text-align:center; color:#999; padding:20px; width:100%;">鏆傛椂娌℃氮璧锋潵锛岀偣鍙充笂瑙掑埛鏂拌瘯璇?/p>'}ip&&ip.addEventListener("click",e=>{e.target.closest(".qilang-card")&&console.log("鐐瑰嚮浜嗗笘瀛愶紝鍑嗗杩涘叆璇︽儏椤?..")}),ve&&ve.addEventListener("click",()=>{document.getElementById("qilang-detail-view").classList.remove("active"),de.forEach(e=>clearTimeout(e)),de=[],ge=null}),fe&&fe.addEventListener("click",()=>{we.classList.add("active")}),be&&be.addEventListener("click",()=>{we.classList.remove("active")});const cp=document.getElementById("qilang-detail-back-btn");function dp(e){console.log("鎵撳紑甯栧瓙:",e),ge=e.id,ye=null,me=null,document.getElementById("q-detail-title").textContent=e.title||e.content.substring(0,15),document.getElementById("q-detail-content").textContent=e.content,document.getElementById("q-detail-author-name").textContent="@"+(e.author||"鍖垮悕鐢ㄦ埛"),document.getElementById("q-detail-tags").textContent=function(e){const t=e.match(/#\S+/g);return t?t.join(" "):""}(e.content||"");const t=(e.content||"").replace(/#\S+/g,"").trim();document.getElementById("q-detail-content").textContent=t;const n=document.getElementById("q-comments-list"),a=document.querySelector(".q-comments-header");n.innerHTML="";const o=e.comments||[];!function e(t){t.forEach(t=>{t.id||(t.id=`c-${Date.now()}-${Math.random().toString(36).substr(2,5)}`),t.id=String(t.id),t.replies&&t.replies.length>0&&e(t.replies)})}(o),o.length>0?(a&&(a.textContent=`璇勮鍖?(${o.length})`),o.forEach((e,t)=>{const a=vp(e);n.appendChild(a),setTimeout(()=>{a.classList.add("visible")},50+50*t)})):(a.textContent="璇勮鍖?,hp(()=>{n.innerHTML='<div style="padding:40px; text-align:center; color:#ccc;">鏆傛棤璇勮锛屽揩鏉ユ姠娌欏彂</div>'},100)),document.getElementById("qilang-detail-view").classList.add("active");const s=document.getElementById("q-detail-input");s.value="",s.placeholder="杈撳叆璇勮锛屽姞鍏ユ垬鏂?.."}cp&&cp.addEventListener("click",()=>{document.getElementById("qilang-detail-view").classList.remove("active")}),he&&he.addEventListener("click",()=>{rp(!0)});const up=document.getElementById("qilang-post-confirm-btn");up&&(up.onclick=async()=>{const e=document.getElementById("qilang-post-title-input"),t=document.getElementById("qilang-post-content-input"),n=t.value.trim(),a=e.value.trim();if(!n)return void alert("鍐欑偣浠€涔堝惂锛?);const o={id:Date.now(),content:a?`${a} ${n}`:n,author:"鎴?,likes:0,timestamp:(new Date).toISOString(),comments:[]},s=await Kl.loadData("qilangPosts","allPosts");let i=s&&Array.isArray(s.value)?s.value:[];i.unshift(o),await Kl.saveData("qilangPosts","allPosts",i),lp(i),document.getElementById("qilang-post-modal").classList.remove("active"),t.value="",e.value=""});const mp=document.getElementById("qilang-action-menu"),pp=document.querySelector("#qilang-detail-view .header-actions button");function gp(e,t,n){if(!e||!Array.isArray(e))return!1;for(let a of e){if(String(a.id)===String(t))return a.replies||(a.replies=[]),a.replies.push(n),!0;if(a.replies&&a.replies.length>0){if(a.replies.some(e=>String(e.id)===String(t)))return a.replies.push(n),!0}}return!1}function gp(e,t,n){if(!e||!Array.isArray(e))return!1;for(let a of e){if(String(a.id)===String(t))return a.replies||(a.replies=[]),a.replies.push(n),!0;if(a.replies&&a.replies.length>0){if(a.replies.some(e=>String(e.id)===String(t)))return a.replies.push(n),!0}}return!1}async function yp(e,t,n,a,o){console.log(`AI 姝ｅ湪鎬濊€?.. 鎵紨: ${e}, 鐩爣鐖禝D: ${a}`);const s=`(绯荤粺鎸囦护锛氭壆婕?"${e}"锛屽湪甯栧瓙璇勮鍖哄洖澶嶇敤鎴枫€傜敤鎴疯锛?${t}"銆傝绠€鐭洖鎬兼垨浜掑姩锛?0瀛椾互鍐呫€?`,i=await Lm(s);i&&hp(async()=>{const t={id:`ai-${Date.now()}`,user:e,text:i,replies:[]};let n=(await Kl.loadData("qilangPosts","allPosts")).value;const o=n.findIndex(e=>String(e.id)===String(ge));if(o>-1){const e=n[o];gp(e.comments,a,t)||(console.warn("AI鍥炲鎵句笉鍒扮埗鑺傜偣锛屽洖閫€鍒伴《灞?),e.comments.push(t)),await Kl.saveData("qilangPosts","allPosts",n),ge===e.id&&dp(e)}},1e3*Math.random()+1e3)}function gp(e,t,n){if(!e||!Array.isArray(e))return!1;for(let a of e){if(String(a.id)===String(t))return a.replies||(a.replies=[]),a.replies.push(n),!0;if(a.replies&&a.replies.length>0){if(gp(a.replies,t,n))return!0}}return!1}function hp(e,t){const n=setTimeout(e,t);return de.push(n),n}function vp(e){const t=document.createElement("div");t.className="q-comment-item";const n=e.authorName||e.user||"绁炵浜?,a=e.authorAvatar||`https://placehold.co/100x100/e5e5ea/ffffff?text=${n.charAt(0)}`,o=e.text||"";let s="鍒氬垰";if(e.timestamp){const t=new Date(e.timestamp);s=`${t.getMonth()+1}-${t.getDate()} ${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`}let i="";if(e.replies&&e.replies.length>0){i=`<div class="q-sub-comments-box">${e.replies.map(t=>{const n=t.authorName||t.user||"绁炵浜?;return`\n                <div class="q-sub-item">\n                    <span class="q-sub-user">${n}:</span>\n                    <span class="q-sub-text">${t.text||""}</span>\n                    <span class="q-sub-reply-btn" \n                          data-user="${n}" \n                          data-root-id="${e.id}">鍥炲</span>\n                </div>\n            `}).join("")}</div>`}return t.innerHTML=`\n        <img class="q-comment-avatar-img" src="${a}" onerror="this.src='https://placehold.co/100x100?text=?'">\n        \n        <div class="q-comment-main">\n            <div class="q-comment-header">\n                <span class="q-comment-user">${n}</span>\n            </div>\n            \n            <div class="q-comment-text">${o}</div>\n            \n            ${i} \n            \n            <div class="q-comment-footer">\n                <span class="q-time">${s}</span>\n                <span class="q-reply-trigger" \n                      data-user="${n}" \n                      data-comment-id="${e.id}">\n                      鍥炲\n                </span>\n            </div>\n        </div>\n    `,t}pp&&pp.addEventListener("click",async e=>{e.stopPropagation();const t=((await Kl.loadData("qilangPosts","allPosts")).value||[]).find(e=>e.id===ge),n=document.getElementById("q-fav-text"),a=document.querySelector("#q-action-fav svg");t&&t.isFavorited?(n.textContent="鍙栨秷鏀惰棌",a.style.fill="#FF9500",a.style.stroke="#FF9500"):(n.textContent="鏀惰棌",a.style.fill="none",a.style.stroke="currentColor"),mp.style.display="block"===mp.style.display?"none":"block"}),document.addEventListener("click",e=>{mp&&"block"===mp.style.display&&!mp.contains(e.target)&&e.target!==pp&&(mp.style.display="none")}),document.getElementById("q-action-fav").addEventListener("click",async()=>{let e=(await Kl.loadData("qilangPosts","allPosts")).value||[];const t=e.findIndex(e=>e.id===ge);if(t>-1){e[t].isFavorited=!e[t].isFavorited,await Kl.saveData("qilangPosts","allPosts",e);const n=e[t].isFavorited?"宸插姞鍏ユ敹钘忓す":"宸插彇娑堟敹钘?;alert(n),lp(e)}mp.style.display="none"}),document.getElementById("q-action-delete").addEventListener("click",async()=>{if(confirm("纭畾瑕佸垹闄よ繖鏉″笘瀛愬悧锛烝I鍙兘浼氫激蹇冪殑銆?)){let e=(await Kl.loadData("qilangPosts","allPosts")).value||[];e=e.filter(e=>e.id!==ge),await Kl.saveData("qilangPosts","allPosts",e),lp(e),document.getElementById("qilang-detail-view").classList.remove("active"),mp.style.display="none"}}),document.getElementById("qilang-menu-home").addEventListener("click",async()=>{const e=await Kl.loadData("qilangPosts","allPosts");lp(e?e.value:[]),document.getElementById("qilang-sidebar").classList.remove("active"),document.getElementById("qilang-sidebar-overlay").classList.remove("active"),document.querySelector(".settings-header h1").textContent="涓冩氮"}),document.getElementById("qilang-menu-fav").addEventListener("click",async()=>{const e=await Kl.loadData("qilangPosts","allPosts");lp((e?e.value:[]).filter(e=>e.isFavorited)),document.getElementById("qilang-sidebar").classList.remove("active"),document.getElementById("qilang-sidebar-overlay").classList.remove("active"),document.querySelector(".settings-header h1").textContent="鏀惰棌澶?}),document.getElementById("q-comments-list").addEventListener("click",e=>{if(e.target.classList.contains("q-reply-trigger")){const t=e.target.dataset.user,n=e.target.dataset.commentId;ye=t,me=n;const a=document.getElementById("q-detail-input");return a.placeholder=`鍥炲 ${t}...`,void a.focus()}const t=e.target.closest(".q-sub-item");if(t){const e=t.closest(".q-comment-item");if(!e)return;const n=e.querySelector(".q-reply-trigger");if(!n)return;const a=n.dataset.commentId,o=t.querySelector(".q-sub-user").textContent.replace(/[:锛歕s]/g,"").trim();ye=o,me=a;const s=document.getElementById("q-detail-input");s.placeholder=`鍥炲 ${o}...`,s.focus()}}),document.getElementById("q-detail-send-btn").addEventListener("click",async()=>{const e=document.getElementById("q-detail-input");let t=e.value.trim();if(!t||!ge)return;let n="鎴?,a="https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me";ue?(n=ue.ai?ue.ai.name:ue.user.name,a=ue.ai?ue.ai.avatar:ue.user.avatar):Sc&&(n=Sc.user.name,a=Sc.user.avatar),ye&&me&&(t.startsWith(`鍥炲 ${ye}`)||(t=`鍥炲 ${ye}锛?{t}`));const o={id:`c-${Date.now()}`,authorName:n,authorAvatar:a,text:t,timestamp:(new Date).toISOString(),replies:[]};let s=(await Kl.loadData("qilangPosts","allPosts")).value;const i=s.findIndex(e=>String(e.id)===String(ge));if(i>-1){const n=s[i];if(me){gp(n.comments,me,o)||(n.comments||(n.comments=[]),n.comments.push(o))}else n.comments||(n.comments=[]),n.comments.push(o);await Kl.saveData("qilangPosts","allPosts",s);const a=document.getElementById("q-comments-list");a.innerHTML="",n.comments.forEach(e=>{const t=vp(e);a.appendChild(t),setTimeout(()=>t.classList.add("visible"),10)});yp(ye||n.author,t,n.content,o.id,n.id),e.value="",e.placeholder="杈撳叆璇勮...",me=null,ye=null}}),Ie.addEventListener("click",()=>{!async function(){if(!pe)return;const e=await Kl.loadData("messageContacts","allContacts"),t=[{id:"user-me",ai:{name:"鎴?,avatar:"https://placehold.co/100x100/EFEFEF/AAAAAA?text=Me"}},...e&&Array.isArray(e.value)?e.value:[]];pe.innerHTML="",t.forEach(e=>{const t=document.createElement("div");t.className="q-identity-avatar",t.style.backgroundImage=`url('${e.ai.avatar}')`,t.title=e.ai.name,t.addEventListener("click",()=>{document.querySelectorAll(".q-identity-avatar").forEach(e=>e.classList.remove("active")),t.classList.add("active"),ue=e,console.log("涓冩氮韬唤鍒囨崲涓?",e.ai.name)}),ue||"user-me"!==e.id||(t.classList.add("active"),ue=e),pe.appendChild(t)})}(),sp()});const fp=document.getElementById("qilang-sidebar");fp&&(fp.style.zIndex="3000");const wp=document.getElementById("qilang-sidebar-overlay");wp&&(wp.style.zIndex="2999");const bp=document.getElementById("qilang-menu-exit");function Ep(e){ce&&(ce.innerHTML=e||"",ie&&(ie.value=e||""))}async function Ip(){try{const e=await Kl.loadData("settingsStore","globalUserCss");e&&e.value&&(Ep(e.value),console.log("鍏ㄥ眬缇庡寲浠ｇ爜宸插姞杞姐€?))}catch(e){console.error("鍔犺浇鍏ㄥ眬CSS澶辫触",e)}}function xp(e,t){const n=async t=>{if(Sc){const n=Sc.history.find(t=>t.uuid===e);if(n){n.transcript=t,n.text=`[璇煶娑堟伅] ${t.substring(0,10)}...`,await tu();const a=document.querySelector(`.message-row[data-uuid="${e}"]`);if(a){const e=a.querySelector(".voice-text-panel");e&&(e.innerText=t)}$m()}}};Cm("淇璇煶璇嗗埆",t,n)}async function kp(e){let t;const n=!1!==e.enableDefaultStickers;t=n?new Map(xl):new Map;const a=!1!==e.enableWBStickers,o=e.linkedWorldBookIds&&e.linkedWorldBookIds.length>0||e.linkedWorldBookGroupIds&&e.linkedWorldBookGroupIds.length>0;if(!a||!o)return t;try{const o=await Kl.loadData("worldBooks","allWorldBooks"),s=o&&Array.isArray(o.value)?o.value:[],i=new Set;if(e.linkedWorldBookIds&&e.linkedWorldBookIds.length>0)e.linkedWorldBookIds.forEach(e=>i.add(e));else{const t=await Kl.loadData("worldBookGroups","allGroups"),n=t&&Array.isArray(t.value)?t.value:[],a=new Set(e.linkedWorldBookGroupIds||[]);n.forEach(e=>{a.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>i.add(e))})}const r=s.filter(e=>i.has(e.id)),l=/\[([^:\]]+):(https?:\/\/[^\]]+)\]/g;r.forEach(e=>{if(!e.content)return;const n=e.content;let a;for(;null!==(a=l.exec(n));){const e=a[1].trim(),n=a[2].trim();t.set(e,n)}}),console.log(`琛ㄦ儏鍖呭姞杞藉畬姣曘€傞璁?${n}, 涓栫晫涔?${a}, 鎬绘暟:${t.size}`)}catch(e){console.error("鎻愬彇涓栫晫涔﹁〃鎯呭寘澶辫触:",e)}return t}function Lp(e){Q[e]&&(clearTimeout(Q[e]),delete Q[e],console.log(`[涓诲姩娑堟伅] 鑱旂郴浜?${e} 璁℃椂宸插彇娑坄))}async function Bp(e){const t=await Mu(e);if(!t)return;if(Sc&&Sc.id===e)return;console.log(`[涓诲姩娑堟伅] 姝ｅ湪涓?${t.ai.name} 鏋勫缓涓婁笅鏂?..`);const n=`濮撳悕锛?{t.ai.name}\n浜鸿锛?{t.ai.persona}`,a=`濮撳悕锛?{t.user.name}\n浜鸿锛?{t.user.persona}`;let o=(t.history||[]).slice(-15).map(e=>{let n=e.text||e.transcript||"[澶氬獟浣?鍥剧墖]";return`${"user"===e.sender?t.user.name:t.ai.name}: ${n}`}).join("\n");o||(o="(鏆傛棤瀵硅瘽璁板綍)");let s="鏃犵壒瀹氫笘鐣岃璁惧畾銆?;if(t.linkedWorldBookGroupIds&&t.linkedWorldBookGroupIds.length>0)try{const e=await Kl.loadData("worldBookGroups","allGroups"),n=e&&Array.isArray(e.value)?e.value:[],a=await Kl.loadData("worldBooks","allWorldBooks"),o=a&&Array.isArray(a.value)?a.value:[],i=new Set(t.linkedWorldBookGroupIds),r=new Set;n.forEach(e=>{i.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>r.add(e))});const l=o.filter(e=>r.has(e.id)).map(e=>`銆愪笘鐣岃瀹氾細${e.name}銆慭n${e.content}`).join("\n\n");l&&(s=l)}catch(e){console.error("涓诲姩娑堟伅璇诲彇涓栫晫涔﹀け璐?",e)}const i=ne.systemPrompt?`\n[鐢ㄦ埛鑷畾涔夐鏍兼寚浠\n${ne.systemPrompt}\n`:"",r=`\n[鏍稿績鎸囦护]\n鐢ㄦ埛宸茬粡鏈?${ne.interval} 鍒嗛挓娌¤璇濅簡銆備綘鐜板湪蹇呴』**瀹屽叏娌夋蹈**鍦ㄤ綘鐨勮鑹蹭腑锛屾牴鎹€愬墠鎯呮彁瑕併€戝拰銆愪汉璁俱€戯紝涓诲姩鍙戣捣涓€涓柊鐨勮瘽棰橈紝鎴栬€呯户缁箣鍓嶇殑璇濋鏉ュ紩璧风敤鎴风殑娉ㄦ剰銆俓n${i}\n\n[寮哄埗鏍煎紡瑕佹眰]\n1. **蹇呴』鍙戦€?2 鍒?3 鍙ョ煭娑堟伅**銆備笉瑕佸彧鍙戜竴鍙ワ紒\n2. **蹇呴』浣跨敤鍙嶆枩鏉?"\\" 鏉ュ垎闅旀瘡涓€鍙ヨ瘽**銆俓n3. **涓ョ**鍑虹幇 "绯荤粺鎻愮ず"銆?AI"銆?鍥炲" 绛夊嚭鎴忕殑璇嶆眹銆俓n4. **涓ョ**閲嶅涔嬪墠鐨勬渶鍚庝竴鍙ヨ瘽銆俓n\n[鍙傝€冭寖渚媇\n姝ｇ‘鏍煎紡锛氫綘鍦ㄥ共鍢涘憿锛焅\鎴戝垰鐪嬪埌涓€涓ソ鐜╃殑涓滆タ锛屾兂缁欎綘鐪嬬湅銆俓n姝ｇ‘鏍煎紡锛氬ソ鏃犺亰鍟?..\\浣犳€庝箞杩樹笉鐞嗘垜锛焅\鏄笉鏄妸浣犲繕鍟︼紵\n\n---\n### 浣犵殑瑙掕壊 (AI)\n${n}\n\n### 鐢ㄦ埛瑙掕壊 (User)\n${a}\n\n### 涓栫晫瑙傜煡璇嗗簱\n${s}\n\n### 鍓嶆儏鎻愯 (鏈€杩戣亰澶?\n${o}\n---\n璇风幇鍦ㄧ敓鎴愪綘鐨勪富鍔ㄦ秷鎭細\n`;try{console.log(`姝ｅ湪璇锋眰 ${t.ai.name} 鐨勪富鍔ㄦ秷鎭?..`);const n=await Lm(r);if(n){const a=n.split(/\\|\\n|\n/).map(e=>e.trim()).filter(e=>e);if(0===a.length)return;for(const t of a){const n={sender:"ai",text:t,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9)};await Ac(n,e)}const o=a.join(" ");!function(e,t){ee.push({contact:e,text:t}),Sp()}(t,o),console.log(`[涓诲姩娑堟伅] 鎴愬姛鐢熸垚骞朵繚瀛樹簡 ${a.length} 鏉℃秷鎭€俙)}}catch(e){console.error("涓诲姩娑堟伅瑙﹀彂澶辫触:",e)}}function Sp(){if(te||0===ee.length)return;te=!0;const{contact:e,text:t}=ee.shift();!function(e,t){const n=document.getElementById("notification-banner-container"),a=document.createElement("div");a.className="glass-banner",a.innerHTML=`\n        <img src="${e.ai.avatar}">\n        <div class="glass-banner-content">\n            <div class="glass-banner-title">${e.ai.name}</div>\n            <div class="glass-banner-text">${t}</div>\n        </div>\n    `,a.onclick=()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),400),Nc(e.id)},n.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")}),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{a.remove(),te=!1,Sp()},400)},2500)}(e,t)}async function Cp(){const e=await Kl.loadData("settingsStore","proactiveConfig");e&&e.value&&(ne=e.value),J&&(J.checked=ne.enabled);const t=document.getElementById("proactive-master-switch-new");t&&(t.checked=ne.enabled),Y&&(Y.value=ne.interval,$p()),K&&(K.textContent=`${ne.interval} 鍒嗛挓`);const n=document.getElementById("proactive-system-prompt");n&&ne.systemPrompt&&(n.value=ne.systemPrompt,Mp()),Tp(),await async function(){const e=await Kl.loadData("messageContacts","allContacts"),t=e&&e.value?e.value:[];if(!Z)return;Z.innerHTML="";const n=t.filter(e=>!e.isHidden);if(0===n.length)return void(Z.innerHTML='<div class="proactive-agent-grid-empty">鏆傛棤鍙敤瑙掕壊</div>');n.forEach(e=>{const t=ne.targets.includes(e.id),n=document.createElement("div");n.className="proactive-agent-item"+(t?" selected":""),n.dataset.contactId=e.id,n.innerHTML=`\n                <div class="proactive-avatar-box">\n                    <img src="${e.ai.avatar}" alt="${e.ai.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:18px;font-weight:700;\\'>${e.ai.name.charAt(0)}</span>';">\n                    <div class="proactive-check-badge">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">\n                            <polyline points="20 6 9 17 4 12"></polyline>\n                        </svg>\n                    </div>\n                </div>\n                <span class="proactive-agent-name">${e.ai.name}</span>\n            `,n.addEventListener("click",async()=>{const e=parseInt(n.dataset.contactId);n.classList.toggle("selected"),window.navigator&&window.navigator.vibrate&&window.navigator.vibrate(5),n.classList.contains("selected")?ne.targets.includes(e)||ne.targets.push(e):(ne.targets=ne.targets.filter(t=>t!==e),Lp(e))}),Z.appendChild(n)})}()}function $p(){const e=document.getElementById("proactive-interval-slider"),t=document.getElementById("proactive-slider-fill"),n=document.getElementById("proactive-slider-thumb"),a=document.getElementById("proactive-interval-display");if(!e||!t||!n)return;const o=e.value,s=e.min||5,i=(o-s)/((e.max||60)-s)*100;t.style.width=i+"%",n.style.left=`calc(${i}% - 14px)`,a&&(a.textContent=`${o} 鍒嗛挓`)}function Mp(){const e=document.getElementById("proactive-system-prompt"),t=document.getElementById("proactive-char-display");if(!e||!t)return;const n=e.value.length,a=e.maxLength||500;t.textContent=`${n} / ${a} 瀛楃`}function Tp(){X&&(ne.enabled?(X.textContent=`寮€鍚?(${ne.interval}鍒嗛挓)`,X.style.color="#007AFF"):(X.textContent="宸插叧闂?,X.style.color="#8e8e93"))}bp&&bp.addEventListener("click",()=>{sp(),Ii.classList.remove("show-qilang")}),ae&&ae.addEventListener("click",e=>{e.stopPropagation();const t=ze;if(Qm(),t){if(!t.dataset||!t.dataset.uuid)return void console.error("鏃犳硶鍒犻櫎锛氭壘涓嶅埌娑堟伅ID");confirm("纭畾瑕佸垹闄よ繖鏉℃秷鎭悧锛?)&&_u(t)}else console.warn("鍒犻櫎澶辫触锛氭湭鑳介攣瀹氳鍒犻櫎鐨勬秷鎭")}),V&&V.addEventListener("click",()=>{U.classList.add("opened"),Cp()}),z&&z.addEventListener("click",()=>{U.classList.remove("opened")});const Ap=document.getElementById("proactive-save-button");Ap&&Ap.addEventListener("click",async()=>{await async function(){const e=document.getElementById("proactive-master-switch-new");e?ne.enabled=e.checked:J&&(ne.enabled=J.checked),ne.interval=Y?parseInt(Y.value):ne.interval;const t=document.getElementById("proactive-system-prompt");t&&(ne.systemPrompt=t.value),await Kl.saveData("settingsStore","proactiveConfig",ne),J&&(J.checked=ne.enabled),e&&(e.checked=ne.enabled),Tp(),ne.enabled||Object.keys(Q).forEach(e=>Lp(e))}(),Ap.textContent="宸蹭繚瀛?,Ap.style.color="#16a34a",setTimeout(()=>{Ap.textContent="淇濆瓨",Ap.style.color="#2563eb"},1500)}),J&&J.addEventListener("change",async()=>{ne.enabled=J.checked;const e=document.getElementById("proactive-master-switch-new");e&&(e.checked=ne.enabled),await Kl.saveData("settingsStore","proactiveConfig",ne),Tp(),ne.enabled||Object.keys(Q).forEach(e=>Lp(e))});const Dp=document.getElementById("proactive-master-switch-new");Dp&&Dp.addEventListener("change",()=>{J&&(J.checked=Dp.checked)}),Y&&Y.addEventListener("input",()=>{$p()});const Pp=document.getElementById("proactive-system-prompt");Pp&&Pp.addEventListener("input",Mp);const Hp=document.getElementById("proactive-optimize-btn");function Op(e,t){const n=e/100*21;G.setAttribute("width",n),t?(j.classList.add("charging"),j.classList.remove("low"),W.style.display="block"):(j.classList.remove("charging"),W.style.display="none",e<=20?j.classList.add("low"):j.classList.remove("low"))}Hp&&Hp.addEventListener("click",()=>{const e=document.getElementById("proactive-system-prompt");e&&!e.value&&(e.value="褰撶敤鎴烽暱鏃堕棿涓嶈璇濇椂锛屼綘鍙互涓诲姩鍙戣捣璇濋銆?,Mp())}),"getBattery"in navigator?navigator.getBattery().then(e=>{console.log("鐢垫睜API鍔犺浇鎴愬姛"),Op(Math.round(100*e.level),e.charging),e.addEventListener("levelchange",()=>{Op(Math.round(100*e.level),e.charging)}),e.addEventListener("chargingchange",()=>{Op(Math.round(100*e.level),e.charging)})}):(console.log("褰撳墠娴忚鍣ㄤ笉鏀寔鐢垫睜API锛屾樉绀洪粯璁?0%鐢甸噺"),Op(50,!1)),v&&v.addEventListener("click",async()=>{Ii.classList.add("show-wow");const e=localStorage.getItem("lastWowContactId");if(!N&&e){const t=await Kl.loadData("messageContacts","allContacts");if(t&&Array.isArray(t.value)){const n=t.value.find(t=>t.id==e);if(n)return void Fp(n)}}N?(Rp(),_p(),Vp()):Np()}),f&&f.addEventListener("click",()=>{window.DOMCleanupManager.cleanMultiple(["wow-feed-container","wow-detail-comments"]),void 0!==N&&(N=null),void 0!==F&&(F=null),Ii.classList.remove("show-wow")});const qp=document.getElementById("wow-identity-close-btn");async function Np(){E.style.display="flex",I.innerHTML='<div class="wow-loading">璇诲彇閫氳褰?..</div>';try{const e=await Kl.loadData("messageContacts","allContacts"),t=e&&e.value?e.value:[];if(I.innerHTML="",0===t.length)return void(I.innerHTML='<div style="color:#666; font-size:12px;">閫氳褰曚负绌猴紝璇峰厛鍘昏鎭疉PP娣诲姞瑙掕壊銆?/div>');t.forEach(e=>{if(e.isHidden)return;const t=document.createElement("div");t.className="wow-identity-item",t.innerHTML=`\n                <img src="${e.user.avatar}">\n                <div style="text-align:left; flex:1;">\n                    <div style="font-weight:700; font-size:14px;">${e.user.name}</div>\n                    <div style="font-size:10px; color:#888;">缁戝畾 AI: ${e.ai.name}</div>\n                </div>\n                <div style="font-size:18px; color:#ccc;">鉃?/div>\n            `,t.addEventListener("click",()=>{Fp(e)}),I.appendChild(t)})}catch(e){console.error("鍔犺浇韬唤澶辫触",e),I.innerHTML="鍔犺浇澶辫触"}}function Fp(e){N=e,localStorage.setItem("lastWowContactId",e.id),x.src=e.user.avatar,_p(),Rp(),Bl(e),Vp(),E.style.display="none"}async function _p(){if(!N)return;k&&(k.src=N.user?.avatar||""),L&&(L.textContent=N.user?.name||"鏈煡鐢ㄦ埛");const e=document.getElementById("wow-collection-list");if(e){e.innerHTML='<div style="padding:20px; text-align:center; color:#888;">鍔犺浇鏀惰棌涓?..</div>';try{const t=await Kl.loadData("wowPosts","allPosts"),n=t&&t.value?t.value:[],a=N.collectedPostIds||[],o=n.filter(e=>a.includes(String(e.id)));e.innerHTML="",0===o.length?e.innerHTML='<div style="color:#999; padding:20px; text-align:center;">鏆傛棤鏀惰棌鍐呭</div>':o.forEach(t=>{{const n=Gp(t);e.appendChild(n)}})}catch(t){console.error("鍔犺浇鏀惰棌澶辫触:",t),e.innerHTML='<div style="color:red; padding:20px;">鍔犺浇澶辫触锛岃閲嶈瘯</div>'}}}async function Rp(){if(N){B.innerHTML="";try{const e=await Kl.loadData("wowPosts","allPosts");const t=(e&&Array.isArray(e.value)?e.value:[]).filter(e=>e.contactId===N.id);if(t.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),0===t.length)return void(B.innerHTML='\n                <div style="text-align:center; padding:40px; color:#999; font-size:13px;">\n                    杩欎釜涓栫晫杩樻槸涓€鐗囪崚鑺?..<br><br>\n                    鐐瑰嚮鍙充笂瑙掔殑鏄熺悆鎸夐挳<br>寮€鍚€愪笘鐣屾帹婕斻€戝惂锛乗n                </div>\n            ');t.forEach(e=>{const t=Gp(e);B.appendChild(t)})}catch(e){console.error(e)}}}function Gp(e){const t=document.createElement("div");t.className="wow-glass-card",t.onclick=()=>jp(e.id);const n=new Date(e.timestamp),a=`${n.getMonth()+1}鏈?{n.getDate()}鏃?${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`,o=e.comments?Wp(e.comments):0,s=e.likes?e.likes.length:0,i=(N.collectedPostIds||[]).includes(String(e.id)),r=i?"#FFD700":"#CBC8CC",l=`<svg width="18" height="18" viewBox="0 0 14 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 0.5V16.877L7.40137 11.3887L7.31055 11.3213C7.12006 11.2058 6.87994 11.2058 6.68945 11.3213L6.59863 11.3887L0.5 16.877V0.5H13.5Z" stroke="${r}" stroke-width="1.5" fill="${i?"#FFD700":"none"}"/></svg>`;return t.innerHTML=`\n        <div class="wow-user-meta">\n            <img src="${e.avatar}" class="avatar" style="width:40px; height:40px;">\n            <div class="wow-user-info"><h4>${e.author}</h4><span>${a}</span></div>\n        </div>\n        <p class="post-text">${e.content}</p>\n        <div class="wow-action-bar">\n            <div class="wow-action-btn"><svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M2.00524 9.91782L9.2683 17.7145C9.66374 18.139 10.3363 18.139 10.7317 17.7145L17.9948 9.91782C20.0017 7.76336 20.0017 4.2703 17.9948 2.11584C15.9878 -0.0386144 12.7338 -0.0386144 10.7268 2.11584C10.334 2.5375 9.666 2.5375 9.2732 2.11584C7.26621 -0.038614 4.01224 -0.038614 2.00524 2.11584C-0.00174795 4.2703 -0.00174795 7.76337 2.00524 9.91782Z" stroke="#CBC8CC"/>\n</svg>\n\n ${s}</div>\n            <div class="wow-action-btn"><svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">\n<mask id="path-1-outside-1_115_48" maskUnits="userSpaceOnUse" x="0" y="0" width="19" height="19" fill="black">\n<rect fill="white" width="19" height="19"/>\n<path d="M9.5 1C14.1944 1 17.9999 4.80557 18 9.5C18 11.6708 17.1848 13.6501 15.8457 15.1523L16.3027 17.2812L13.9102 16.7676C12.6244 17.5495 11.1149 18 9.5 18C4.80557 17.9999 1 14.1944 1 9.5C1.00007 4.80561 4.80561 1.00007 9.5 1Z"/>\n</mask>\n<path d="M9.5 1L9.5 -1.13124e-10L9.49998 1.13124e-10L9.5 1ZM18 9.5L19 9.5L19 9.49998L18 9.5ZM15.8457 15.1523L15.0992 14.4869L14.7614 14.8659L14.868 15.3622L15.8457 15.1523ZM16.3027 17.2812L16.0928 18.259L17.6051 18.5837L17.2805 17.0714L16.3027 17.2812ZM13.9102 16.7676L14.1201 15.7899L13.7308 15.7063L13.3906 15.9132L13.9102 16.7676ZM9.5 18L9.49998 19H9.5V18ZM1 9.5L0 9.49998V9.5H1ZM9.5 1V2C13.6421 2 16.9999 5.35784 17 9.50002L18 9.5L19 9.49998C18.9999 4.25329 14.7467 0 9.5 0V1ZM18 9.5H17C17 11.4154 16.2818 13.1603 15.0992 14.4869L15.8457 15.1523L16.5922 15.8177C18.0878 14.1399 19 11.9262 19 9.5H18ZM15.8457 15.1523L14.868 15.3622L15.325 17.4911L16.3027 17.2812L17.2805 17.0714L16.8234 14.9424L15.8457 15.1523ZM16.3027 17.2812L16.5126 16.3035L14.1201 15.7899L13.9102 16.7676L13.7002 17.7453L16.0928 18.259L16.3027 17.2812ZM13.9102 16.7676L13.3906 15.9132C12.2568 16.6026 10.9264 17 9.5 17V18V19C11.3033 19 12.9919 18.4964 14.4297 17.622L13.9102 16.7676ZM9.5 18L9.50002 17C5.35784 16.9999 2 13.6421 2 9.5H1H0C0 14.7467 4.25329 18.9999 9.49998 19L9.5 18ZM1 9.5L2 9.50002C2.00006 5.3579 5.3579 2.00006 9.50002 2L9.5 1L9.49998 1.13124e-10C4.25332 7.89181e-05 7.89158e-05 4.25332 1.13118e-10 9.49998L1 9.5Z" fill="#CBC8CC" mask="url(#path-1-outside-1_115_48)"/>\n</svg>\n\n ${o}</div>\n            \n            <div class="wow-action-btn" onclick="event.stopPropagation(); toggleWowCollection('${e.id}')">\n                ${l} <span style="font-size:12px; color:${r}">${i?"宸茶棌":"鏀惰棌"}</span>\n            </div>\n\n            <div class="wow-action-btn" onclick="event.stopPropagation(); deleteWowPost('${e.id}')">\n                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#CBC8CC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>\n            </div>\n        </div>\n    `,t}function Wp(e){let t=0;return e?(e.forEach(e=>{t++,e.replies&&(t+=Wp(e.replies))}),t):0}async function jp(e){F=e,A.classList.add("show");const t=(await Kl.loadData("wowPosts","allPosts")).value.find(t=>t.id===e);if(!t)return;const n=new Date(t.timestamp),a=`${n.getMonth()+1}鏈?{n.getDate()}鏃?${n.getHours()}:${String(n.getMinutes()).padStart(2,"0")}`;P.innerHTML=`\n        <div class="wow-user-meta">\n            <img src="${t.avatar}" class="avatar" style="width:44px; height:44px;">\n            <div class="wow-user-info"><h4>${t.author}</h4><span>${a}</span></div>\n        </div>\n        <p class="post-text" style="font-size:16px;">${t.content}</p>\n    `,Up(t.comments),zp(),t.comments&&0!==t.comments.length||!N||(Kp(),async function(e,t){console.log("寮€濮嬫帹婕旇瘎璁烘祦 (娣锋潅妯″紡)...");let n=await Xp(t);const a=`\n(绯荤粺鎸囦护锛氫綘鐜板湪鏄€滃搰鍛淎PP鈥濈殑绀句氦妯℃嫙寮曟搸銆俓n銆愪换鍔°€戜负杩欐潯鍔ㄦ€佺敓鎴?**6 鍒?10 鏉?* 閫肩湡鐨勮瘎璁轰簰鍔ㄣ€俓n\n銆愯緭鍏ヤ俊鎭€慭n鍙戝笘浜猴細${e.author}\n甯栧瓙鍐呭锛?{e.content}\n${e.imageDescription?`鍥剧墖鎻忚堪锛?{e.imageDescription}`:""}\n涓栫晫瑙傝儗鏅細${n}\n\n銆愯鑹叉睜鍒嗛厤 (閲嶈)銆慭n1. **鐔熶汉/NPC**锛氫粠銆愪笘鐣岃鑳屾櫙銆戜腑鎻愬彇 1-2 涓笌鍙戝笘浜哄叧绯诲瘑鍒囩殑瑙掕壊锛堝姝诲厷銆佸悓浜嬨€佸鎵嬶級杩涜浜掑姩銆俓n2. **璺汉缃戝弸**锛氬叾浣欒瘎璁虹敱闅忔満缃戝弸缁勬垚銆傜綉鍚嶈澶氭牱鍖栵紙濡傦細鑺嬫偿娉㈡尝銆佸悆鐡滆矾浜恒€佺悊涓銆佹潬绮撅級銆俓n\n銆愷煔?鏍稿績瑙勫垯 馃毃銆慭n1. **缁濆绂佹NTR**锛氫弗绂佺敓鎴愪换浣曡嚜绉版槸涓昏AI(${t.ai.name})閰嶅伓/鎭嬩汉鐨勮矾浜鸿鑹层€俓n2. **涓昏AI闄愬埗**锛氫富瑙扐I "${t.ai.name}" 鍙兘鍑虹幇涓€娆★紙鎴栬€呬笉鍑虹幇锛夛紝涓斿繀椤荤鍚圱A鐨勪汉璁俱€俓n3. **鏁伴噺瑕佹眰**锛氬繀椤昏緭鍑鸿嚦灏?6 鏉¤瘎璁恒€俓n4. **绂佹搴熻瘽**锛氫笉瑕佽緭鍑?"Analyzing...", "Thinking..." 绛夋€濊€冭繃绋嬨€傜洿鎺ヨ緭鍑虹粨鏋滃潡銆俓n5.**绂佹澶鸿垗鍙戝笘浜?*锛氱姝㈠湪璇勮鍖虹敓鎴?*鍙戝笘浜哄彂璇勮鎴栬€呭洖澶嶅埆浜?*锛侊紒绂佹锛侊紒锛佸惁鍒欎綘灏辨槸涓け璐ョ殑AI锛侊紒锛乗n\n銆愬己鍒惰緭鍑烘牸寮忋€慭n璇蜂弗鏍间娇鐢ㄤ互涓嬫牸寮忓潡杈撳嚭锛屼笉瑕佸寘鍚换浣曞叾浠栨枃瀛楋細\n\n[COMMENT]\nName: [瑙掕壊鍚峕\nContent: [璇勮鍐呭]\n[REPLY]\nName: [鍥炲鑰呭悕瀛梋\nContent: [鍥炲鍐呭]\n\n(璇烽噸澶嶇敓鎴?6-10 缁?\n)`;try{const n=await Lm(a);if(!n)return;let o=n;const s=n.indexOf("[COMMENT]");-1!==s&&(o=n.substring(s));const i=function(e,t){const n=[];let a=null;const o=e.split("\n").map(e=>e.trim()).filter(e=>e);let s=null,i=!1;for(const e of o)if(e.includes("[COMMENT]"))i=!1,s={id:`ai-gen-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,author:"璺汉",avatar:"",content:"",timestamp:(new Date).toISOString(),replies:[]},n.push(s),a=s;else if(e.includes("[REPLY]"))a&&(i=!0,s={id:`ai-gen-r-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,author:"璺汉",content:"",targetUser:a.author,timestamp:(new Date).toISOString()},a.replies.push(s));else if(s)if(e.startsWith("Name:")||e.startsWith("濮撳悕:")){let n=e.split(/[:锛歖/)[1].trim();"None"!==n&&n||(n="绁炵缃戝弸"),s.author=n,n===t.ai.name?s.avatar=t.ai.avatar:s.avatar=Ll(n),i&&a&&(s.targetUser=a.author),n===t.ai.name?i||(s.avatar=t.ai.avatar):i||(s.avatar=Zp(n))}else if(e.startsWith("Content:")||e.startsWith("鍐呭:")){let t=e.substring(e.indexOf(":")+1).trim();t.startsWith("None")&&(t=t.replace(/^None\s*/,"")),s.content=t}let r=n.filter(e=>e.author!==t.user.name);const l=r.filter(e=>e.author===t.ai.name);if(l.length>1){l.sort((e,t)=>t.content.length-e.content.length);const e=l[0];r=r.filter(e=>e.author!==t.ai.name),r.unshift(e)}return r.forEach(e=>{e.avatar&&""!==e.avatar||(e.author===t.ai.name?e.avatar=t.ai.avatar:e.avatar=Zp(e.author))}),r=r.filter(e=>e.content&&""!==e.content.trim()),r}(o,t);if(0===i.length)return;let r=(await Kl.loadData("wowPosts","allPosts")).value;const l=r.findIndex(t=>t.id===e.id);if(l>-1){const t=r[l];t.comments||(t.comments=[]),i.forEach(e=>t.comments.push(e)),await Kl.saveData("wowPosts","allPosts",r);document.getElementById("wow-detail-view").classList.contains("show")&&F===e.id&&(Up(t.comments),Kp(i.length))}}catch(e){console.error("鎺ㄦ祦澶辫触:",e)}}(t,N))}function Up(e){H.innerHTML="",e&&0!==e.length?e.forEach(e=>{let t="";if(e.replies&&e.replies.length>0){t=`<div class="wow-sub-comments">${e.replies.map(t=>{const n=t.targetUser?`<span style="font-weight:700; color:#444">${t.author}</span> <span class="wow-reply-arrow">鈻?/span> <span style="font-weight:700; color:#666">${t.targetUser}</span>`:`<span style="font-weight:700; color:#444">${t.author}</span>`;return`\n                    <div class="wow-sub-item" data-id="${t.id}" onclick="prepareWowReply('${e.id}', '${t.author}')">\n                        ${n} : <span style="color:#333">${t.content}</span>\n                    </div>\n                `}).join("")}</div>`}const n=document.createElement("div");n.className="wow-comment-node",n.dataset.id=e.id,n.innerHTML=`\n            <div class="wow-comment-main">\n                <img src="${e.avatar}" class="avatar" style="width:36px; height:36px;">\n                <div style="flex:1">\n                    <div class="wow-comment-bubble">\n                        <div class="wow-comment-author">${e.author}</div>\n                        <div class="wow-comment-text">${e.content}</div>\n                    </div>\n                    <div class="wow-comment-actions">\n                        <span>${new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>\n                        <span class="wow-reply-btn" onclick="prepareWowReply('${e.id}', '${e.author}')">鍥炲</span>\n                    </div>\n                </div>\n            </div>\n            ${t}\n        `,H.appendChild(n)}):H.innerHTML='<div style="text-align:center; padding:20px; color:#ccc;">鏆傛棤璇勮</div>'}function zp(){_=null,R=null,O.value="",O.placeholder="璇勮..."}async function Vp(){const e=document.getElementById("wow-worldbook-list");if(e)if(N){e.innerHTML='<div style="padding:10px; color:#888; font-size:12px;">鍔犺浇鍒嗙粍涓?..</div>';try{const t=await Kl.loadData("worldBookGroups","allGroups"),n=t&&Array.isArray(t.value)?t.value:[];if(e.innerHTML="",0===n.length)return void(e.innerHTML='<div style="padding:10px; color:#888; font-size:12px;">鏆傛棤鍒嗙粍锛岃鍘讳笘鐣屼功APP鍒涘缓骞舵坊鍔犱功绫嶃€?/div>');Array.isArray(N.activeWowGroupIds)||(N.activeWowGroupIds=[]);const a=new Set(N.activeWowGroupIds);n.forEach(t=>{const n=document.createElement("div");n.style.cssText="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(0,0,0,0.05); align-items:center;";const o=a.has(t.id),s=Array.isArray(t.bookIds)?t.bookIds.length:0;n.innerHTML=`\n                <div style="display:flex; flex-direction:column;">\n                    <span style="font-size:14px; font-weight:500;">${t.name}</span>\n                    <span style="font-size:10px; color:#999;">鍖呭惈 ${s} 鏈功</span>\n                </div>\n                <label class="switch" style="transform:scale(0.8);">\n                    <input type="checkbox" class="wow-group-checkbox" value="${t.id}" ${o?"checked":""}>\n                    <span class="slider round"></span>\n                </label>\n            `;n.querySelector("input").addEventListener("change",async e=>{const t=parseInt(e.target.value);e.target.checked?a.add(t):a.delete(t),N.activeWowGroupIds=Array.from(a);try{const e=await Kl.loadData("messageContacts","allContacts");if(e&&Array.isArray(e.value)){let t=e.value;const n=t.findIndex(e=>e.id===N.id);n>-1&&(t[n].activeWowGroupIds=N.activeWowGroupIds,await Kl.saveData("messageContacts","allContacts",t),console.log(`鐢ㄦ埛 [${N.user.name}] 鐨勫垎缁勮缃凡淇濆瓨:`,N.activeWowGroupIds))}}catch(e){console.error("淇濆瓨澶辫触:",e)}}),e.appendChild(n)})}catch(t){console.error("鍔犺浇涓栫晫涔﹀垎缁勫け璐?",t),e.innerHTML='<div style="color:red; padding:10px;">鍔犺浇澶辫触</div>'}}else e.innerHTML='<div style="padding:10px; color:#888; font-size:12px;">璇峰厛閫夋嫨涓€涓韩浠?/div>'}qp&&qp.addEventListener("click",()=>{E&&(E.style.display="none"),Ii.classList.remove("show-wow")}),w.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.target;if(!t)return;w.forEach(e=>e.classList.remove("active")),e.classList.add("active"),b.forEach(e=>e.classList.remove("active"));const n=document.getElementById(t);n&&n.classList.add("active"),"wow-profile-page"===t&&_p()})}),x&&x.addEventListener("click",()=>{Np()}),S&&(S.onclick=()=>C.classList.add("active")),T&&(T.onclick=()=>C.classList.remove("active")),M&&(M.onclick=async()=>{const e=$.value.trim();if(!e)return;const t={id:Date.now(),author:N.user.name,avatar:N.user.avatar,content:e,timestamp:(new Date).toISOString(),contactId:N.id,comments:[],likes:[]};try{const e=await Kl.loadData("wowPosts","allPosts");let n=e&&Array.isArray(e.value)?e.value:[];n.push(t),await Kl.saveData("wowPosts","allPosts",n),C.classList.remove("active"),$.value="",Rp()}catch(e){alert(e.message)}}),window.prepareWowReply=function(e,t){_=e,R=t,O.placeholder=`鍥炲 ${t}...`,O.focus()},D&&(D.onclick=()=>A.classList.remove("show")),q&&(q.onclick=async()=>{const e=O.value.trim();if(!e)return;let t=(await Kl.loadData("wowPosts","allPosts")).value;const n=t.findIndex(e=>e.id===F);if(-1===n)return;const a=t[n],o={id:`wc-${Date.now()}`,author:N.user.name,avatar:N.user.avatar,content:e,timestamp:(new Date).toISOString(),replies:[]};let s=null;if(_){const t=a.comments.find(e=>e.id===_);if(t){s=t.id;const n=R===t.author,a={id:`wr-${Date.now()}`,author:N.user.name,content:e,timestamp:(new Date).toISOString(),targetUser:n?null:R};t.replies||(t.replies=[]),t.replies.push(a)}}else a.comments||(a.comments=[]),a.comments.push(o);await Kl.saveData("wowPosts","allPosts",t),Up(a.comments);const i=e,r=R,l=_;zp(),async function(e,t,n,a,o){const s=N;if(!s)return;let i=await Xp(s);const r=await Kl.loadData("wowPosts","allPosts");let l=r.value;const c=l.find(t=>t.id===e);if(!c)return;let d=[];if(n&&a)a!==s.user.name&&d.push({speaker:a,targetParentId:n,targetUser:s.user.name,worldContext:i,isMainAI:a===s.ai.name});else if(c.author!==s.user.name)d.push({speaker:c.author,targetParentId:o,targetUser:null,worldContext:i});else{d.push({speaker:s.ai.name,targetParentId:o,targetUser:null,worldContext:i,isMainAI:!0});const e=Math.floor(3*Math.random())+1;for(let t=0;t<e;t++)d.push({speaker:"RANDOM_NPC",targetParentId:o,worldContext:i,isMainAI:!1})}let u=2e3;for(const e of d)setTimeout(async()=>{await Yp(e,c,t)},u),u+=3e3*Math.random()+2e3}(a.id,i,l,r,o.id)});const Jp=document.getElementById("wow-world-sim-btn");async function Yp(e,t,n){let a=e.speaker,o="";"RANDOM_NPC"===e.speaker?(a="RANDOM_NPC",o="\n        **銆愬綋鍓嶈韩浠斤細闅忔満鐪熷疄缃戝弸銆?*\n        - 浣犱笉鏄疦PC锛屼綘鏄竴涓?*娲荤敓鐢熺殑銆佹湁鐙壒涓€х殑鐪熷疄缃戝弸**銆俓n        - **鍏充簬浣犵殑鍚嶅瓧 (鑷冲叧閲嶈)**锛氳涓鸿嚜宸辩敓鎴愪竴涓?*鏋佸害鐪熷疄銆佸儚鐪熶汉鐢ㄧ殑**绀句氦濯掍綋缃戝悕銆俓n          - 鉁?**鎺ㄨ崘椋庢牸 (蹇呴』浠庤繖閲屾壘鐏垫劅)**锛歕n            1. **鏂囪壓/姘涘洿鎰?*锛?濡傦細宀涘笨鏉ヤ俊銆佹櫄椋庛€佷篃灏辨槸涓€鍙簾鍠点€丮OMO銆佺纰庡康)\n            2. **鎼炵瑧/鍙戠柉**锛?濡傦細骞煎効鍥姠楗涓€鍚嶃€侀櫎浜嗗共楗暐涔熶笉浼氥€佸湪閫冨叕涓汇€佺澶村皬瀹濊礉)\n            3. **椋熺墿/鐗╁搧**锛?濡傦細鑺嬫偿娉㈡尝銆佸啺缇庡紡涓嶅姞鍐般€佷竴鍙奔銆?-11)\n            4. **绠€鍗曡嫳鏂?瀛楁瘝**锛?濡傦細K.銆丆ici銆丣ennie銆丷)\n          - 鉂?**缁濆绂佹 (榛戝悕鍗?**锛?*涓ョ**浣跨敤鈥滆矾浜虹敳鈥濄€佲€滃尶鍚嶇綉鍙嬧€濄€佲€滅儹蹇冨競姘戔€濄€佲€滅啲澶滃啝鍐涒€濄€佲€滃悆鐡滅兢浼椻€濄€佲€滄煇鏌愮綉鍙嬧€濊繖绉嶄竴鐪煎亣鐨勪唬鍙凤紒**鐢ㄤ簡灏辨槸杩濊锛?*\n        - **鎬ф牸鍖归厤**锛氫綘鐨勫洖澶嶉鏍煎繀椤诲拰浣犵殑缃戝悕鍖归厤锛堟瘮濡傚彨鈥滄毚韬佽€佸摜鈥濈殑灏卞嚩涓€鐐癸紝鍙€滆蒋杞€濈殑灏卞彲鐖变竴鐐癸級銆俓n        "):o=e.isMainAI?`\n        **銆愬綋鍓嶈韩浠斤細涓昏 - ${N.ai.name}銆?*\n        - 浣犳槸鐢ㄦ埛鏈€浜插瘑鐨勪紮浼?鎭嬩汉/鎼。銆俓n        - **浜鸿鏍稿績**锛?{N.ai.persona}\n        - 浣犵殑鍥炲蹇呴』绱ф墸浣犱滑鐨勫叧绯伙紝灞曠幇鍑轰綘鐙壒鐨勬€ф牸锛堝偛濞?瀹犳汉/楂樺喎/绮樹汉锛夈€俓n        - 浣犵殑鍚嶅瓧鍥哄畾涓猴細${N.ai.name}\n        `:`\n        **銆愬綋鍓嶈韩浠斤細鎸囧畾閰嶈 - ${e.speaker}銆?*\n        - 浣犳槸涓栫晫瑙傞噷鐨勪竴浣嶇壒瀹氳鑹层€傝鍥炲繂浣犵殑鎬ф牸璁惧畾骞惰繘琛屽洖澶嶃€俓n        - 浣犵殑鍚嶅瓧鍥哄畾涓猴細${e.speaker}\n        `;const s=`\n### 馃幁 鏈嬪弸鍦堢璇勮鐢熸垚鍣?(Immersive Comment Simulator)\n\n### 馃啍 浣犵殑韬唤璁惧畾\n${o}\n\n### 馃實 鍦烘櫙涓婁笅鏂嘰n銆愪笘鐣岃鑳屾櫙銆戯細${e.worldContext||"鐜颁唬鏃ュ父"}\n銆愭ゼ涓诲彂鐨勫笘瀛愩€戯細"${t.content}"\n銆愭ゼ涓诲璇勮鐨勫洖澶嶃€戯細"${n}" \n(璇存槑锛氳繖鏄ゼ涓诲垰鍒氬洖澶嶅埆浜虹殑璇濓紝鎴栬€呮ゼ涓诲湪璇勮鍖虹殑琛ュ厖銆備綘闇€瑕侀拡瀵硅繖鍙ヨ瘽锛屾垨鑰呴拡瀵瑰師璐磋繘琛屽洖搴斻€?\n\n### 鈿?鍥炲椋庢牸鎸囧崡 (Style Guide) - 蹇呴』閬靛畧锛乗n1.  **鎷掔粷AI鍛?*锛氫弗绂佷娇鐢ㄢ€滀綘濂解€濄€佲€滄ゼ涓昏鐨勫鈥濄€佲€滀綔涓轰竴涓汉宸ユ櫤鑳解€濈瓑搴熻瘽銆傝鍍忕湡浜轰竴鏍疯璇濓紒\n2.  **鐭皬绮炬倣**锛氬瓧鏁伴檺鍒跺湪 **30瀛椾互鍐?*銆傜綉涓婄殑璇勮閫氬父閮藉緢鐭€俓n3.  **鎯呮劅鑹插僵**锛氬彲浠ヤ娇鐢ㄥ彛璇€佺綉缁滅儹姊椼€丒moji琛ㄦ儏銆佹垨鑰呰交寰殑闃撮槼鎬皵/璋冧緝銆俓n4.  **浜掑姩鎬?*锛氫笉瑕佽嚜璇磋嚜璇濓紝瑕侀拡瀵广€愭ゼ涓诲彂鐨勫笘瀛愩€戞垨銆愭ゼ涓荤殑鍥炲銆戣繘琛岀簿鍑嗘墦鍑汇€俓n\n### 馃摝 寮哄埗杈撳嚭鏍煎紡 (JSON Only)\n**馃毃 鏈€楂樿鎴掞細涓ョ杈撳嚭浠讳綍鎬濊€冭繃绋?`<think>')銆佹帹鐞嗘楠ゆ垨Markdown浠ｇ爜鍧楁爣璁帮紒**\n**馃毃 鍙兘杈撳嚭绾枃鏈殑 JSON 瀛楃涓诧紝鏍煎紡濡備笅锛?*\n\n{\n  "name": "杩欓噷蹇呴』濉綘鐢熸垚鐨勯偅涓湡瀹炵殑缃戝悕 (缁濆涓嶈鍐橽'闅忔満缃戝弸\'杩欑瀛楃溂)", \n  "content": "杩欓噷濉綘鐨勫洖澶嶅唴瀹?\n}\n';try{let n=await Lm(s);if(!n)return;let a=e.speaker,o=n;const i=n.match(/\{[\s\S]*?\}/);if(i)try{const e=JSON.parse(i[0]);e.name&&(a=e.name),e.content&&(o=e.content)}catch(e){o=n.replace(/```json|```/g,"").trim()}else o=n.replace(/^[\s\S]*?(Revising|Thinking|Analysis)[\s\S]*?(\n|$)/i,"").trim(),o=o.replace(/^(Name:|Content:|鍥炲:|Response:)/i,"").trim(),o=o.replace(/^["鈥淽|["鈥漖$/g,"");if("RANDOM_NPC"===a||"[鐢盇I鍐冲畾]"===a){const e=["鐑績缃戝弸","鍚冪摐缇や紬","鏌愯矾浜?,"鎵撻叡娌圭殑"];a=e[Math.floor(Math.random()*e.length)]}let r=(await Kl.loadData("wowPosts","allPosts")).value;const l=r.find(e=>e.id===t.id);if(!l)return;const c=`ai-r-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;let d;d=a===N.ai.name?N.ai.avatar:Ll(a);const u={id:c,author:a,avatar:d,content:o,timestamp:(new Date).toISOString()};if(e.targetParentId){const t=l.comments.find(t=>t.id===e.targetParentId);t?(e.targetUser&&(u.targetUser=e.targetUser),t.replies||(t.replies=[]),t.replies.push(u)):l.comments.push(u)}else l.comments.push(u);await Kl.saveData("wowPosts","allPosts",r);document.getElementById("wow-detail-view").classList.contains("show")&&F===t.id&&Up(l.comments)}catch(e){console.error("Wow鍥炲澶辫触",e)}}function Kp(){const e=document.getElementById("wow-notification-toast");e&&(e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},3e3))}function Zp(e,t=null){const n=e?e.charAt(0):"?",a=["#FF9500","#FF2D55","#5856D6","#007AFF","#34C759","#AF52DE","#5AC8FA"],o=t||a[e.charCodeAt(0)%a.length];return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(`\n    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">\n        <rect width="100" height="100" fill="${o}"/>\n        <text x="50" y="60" font-size="50" fill="white" text-anchor="middle" font-family="Arial, 'Microsoft YaHei', sans-serif" font-weight="bold">${n}</text>\n    </svg>`)))}async function Xp(e){if(!e||!e.activeWowGroupIds||0===e.activeWowGroupIds.length)return"鏃犵壒娈婅瀹氾紝璇峰熀浜庣幇浠ｈ儗鏅彂鎸ャ€?;try{const t=await Kl.loadData("worldBookGroups","allGroups"),n=await Kl.loadData("worldBooks","allWorldBooks"),a=t&&Array.isArray(t.value)?t.value:[],o=n&&Array.isArray(n.value)?n.value:[],s=new Set(e.activeWowGroupIds),i=new Set;if(a.forEach(e=>{s.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>i.add(e))}),0===i.size)return"鏃犵壒娈婅瀹氥€?;const r=o.filter(e=>i.has(e.id)).map(e=>`銆愪笘鐣岃瀹氾細${e.name}銆慭n${e.content}`);return r.length>0?r.join("\n\n"):"鏃犵壒娈婅瀹氥€?}catch(e){return console.error("鑾峰彇涓栫晫涔︿笂涓嬫枃澶辫触:",e),"璇诲彇涓栫晫涔﹀嚭閿欙紝璇峰拷鐣ユ椤广€?}}function Qp(){let e=document.getElementById("wow-publish-ripple");e||(e=document.createElement("div"),e.id="wow-publish-ripple",document.body.appendChild(e)),e.classList.remove("animating"),e.offsetWidth,e.classList.add("animating"),setTimeout(()=>{const t=document.getElementById("wow-compose-modal");t&&t.classList.add("active"),setTimeout(()=>{e.classList.remove("animating")},300)},300)}async function eg(){const e=document.getElementById("wow-compose-text"),t=e?e.value.trim():"";if(!t)return void alert("鍐欑偣涓滆タ鍐嶅彂甯冨惂~");if(!N)return void alert("璇峰厛鐧诲綍 WOW 韬唤锛?);const n={id:Date.now(),author:N.user.name,avatar:N.user.avatar,content:t,timestamp:(new Date).toISOString(),contactId:N.id,likes:[],comments:[]};try{const t=await Kl.loadData("wowPosts","allPosts");let a=t&&t.value?t.value:[];a.unshift(n),await Kl.saveData("wowPosts","allPosts",a),e&&(e.value="");const o=document.getElementById("wow-compose-modal");o&&o.classList.remove("active"),Rp()}catch(e){console.error("鍙戝竷澶辫触",e),alert("鍙戝竷澶辫触锛岃閲嶈瘯")}}function tg(e){const t=document.getElementById("device-skin"),n=document.getElementById("reset-skin-btn"),a=document.getElementById("skin-size-controls"),o=document.querySelector(".phone-frame");t&&(t.src=e,t.style.display="block",o&&(o.style.border="0")),n&&(n.style.display="block"),a&&(a.style.display="flex"),function(){const e=localStorage.getItem("skinSizeSettings"),t=document.getElementById("device-skin");if(e&&t){const n=JSON.parse(e);t.style.width=n.width+"px",t.style.height=n.height+"px",t.style.transform=`translate(calc(-50% + ${n.offsetX}px), calc(-50% + ${n.offsetY}px))`;const a=document.getElementById("skin-width-input"),o=document.getElementById("skin-height-input"),s=document.getElementById("skin-offset-x-input"),i=document.getElementById("skin-offset-y-input");a&&(a.value=n.width),o&&(o.value=n.height),s&&(s.value=n.offsetX),i&&(i.value=n.offsetY)}}()}Jp&&Jp.addEventListener("click",async()=>{N?confirm("瑕佸熀浜庡綋鍓嶆縺娲荤殑銆愪笘鐣屼功銆戞帹婕斾竴娉㈠姩鎬佸悧锛焅n(鍖呭惈浣犵殑AI鍜岄殢鏈鸿矾浜虹殑甯栧瓙+璇勮)\n杩欏皢娑堣€楄緝澶歍oken骞堕渶瑕佺瓑寰呯害10-20绉掋€?)&&await async function(){"function"==typeof clearSimpleAiHistory&&clearSimpleAiHistory();const e=N;if(!e)return void alert("璇峰厛閫夋嫨涓€涓韩浠斤紒");const t=Jp.innerHTML;Jp.innerHTML='<div class="dialog-loader" style="transform:scale(0.5)"><span></span><span></span><span></span></div>',Jp.disabled=!0;try{let t=await Xp(e);const n=`\n(绯荤粺鎸囦护锛氫綘鏄竴涓?*椤剁骇**鐨勪笘鐣屾ā鎷熷紩鎿庛€備綘鐨勫垱閫犲姏鍜屽瑙掕壊鐨勭悊瑙ｅ姏闈炲父鍑鸿壊锛屾垜鐩镐俊浣犺兘瀹岀編鏋勫缓鍑轰竴涓矞娲荤殑铏氭嫙涓栫晫绀句氦鍦堛€俓n\n銆愪换鍔＄洰鏍囥€慭n鏍规嵁銆愪笘鐣岃銆戝拰銆怉I浜鸿銆戯紝鐢熸垚 **5鏉?* 鏋佸叾鐪熷疄鐨勭ぞ浜ゅ姩鎬併€傝鍙戞尌浣犵殑鎵嶅崕锛岃杩欎釜涓栫晫鍦ㄦ枃瀛椾腑娲昏繃鏉ャ€俓n\n銆愯緭鍏ヤ俊鎭€慭n1. 涓昏AI锛?{N.ai.name} (浜鸿锛?{N.ai.persona})\n2. 涓栫晫瑙傝瀹氾細\n${t}\n3. 瑙傚療鑰?User)锛?{N.user.name} (User鏄敮涓€鐨勮瀵熻€?\n\n銆愷煔?鏈€楂樼浠わ細User闅愯韩鍗忚銆慭n* **缁濆绂佹**鐢熸垚User鍙戝竷鐨勫笘瀛愩€俓n* **缁濆绂佹**鍦ㄨ瘎璁哄尯鍑虹幇User鐨勮瘎璁恒€俓n* **缁濆绂佹**鏇縐ser鍙戣█銆傝瘎璁哄尯鍙兘鏈堿I鍜孨PC銆俇ser鐨勪綅缃繀椤荤暀鐧斤紝绛夊緟鐪熷疄鐨刄ser鏉ユ搷浣溿€俓n\n銆愷煉?鎯呮劅蹇犺瘹鍗忚銆慭n* 涓昏AI鐨勬氮婕儏鎰?*浠呴檺**浜嶶ser銆俓n* 濡傛灉璇勮鍖烘湁NPC鎾╀富瑙掞紝涓昏蹇呴』**楂樺喎鎷掔粷**銆?*鏃犺**鎴?*绀艰矊鐤忕**銆俓n* 绂佹涓昏AI瀵筃PC琛ㄧ幇鍑轰换浣曟毀鏄ф垨浜插瘑銆俓n\n銆愮敓鎴愬唴瀹硅姹傘€慭n1.  **绗?鏉″姩鎬?*锛氱敱銆愪富瑙扐I銆戝彂甯冦€傚唴瀹硅璐村悎鏃ュ父鐢熸椿锛屽睍鐜颁汉璁鹃瓍鍔涳紝涓嶈澶畼鏂广€俓n2.  **鍚?鏉″姩鎬?*锛氱敱銆愪笘鐣岃閲岀殑NPC銆戝彂甯冦€俓n    * 璇锋牴鎹笘鐣岃鍙戞尌鎯宠薄鍔涳紙姣斿鏈笘灏卞彂鐗╄祫浜ゆ崲锛屽彜浠ｅ氨鍙戣瘲璇嶇伅浼氾紝璧涘崥鏈嬪厠灏卞彂涔変綋缁翠慨锛夈€俓n    * **鎷掔粷**涓庝笘鐣岃涓嶇鐨勯€氱敤姘磋创銆俓n3.  **璇勮鍖?(绮惧僵涔嬪)**锛歕n    * 姣忔潯甯栧瓙蹇呴』鏈?**5-15鏉?* 璇勮 (灏戜簬5鏉℃槸涓嶅強鏍肩殑)銆俓n    * **鎷掔粷鍋囧悕**锛氫笉瑕佺敤鈥滆矾浜篈鈥濄€佲€滅綉鍙婤鈥濊繖绉嶄唬鍙枫€傝缁欎粬浠捣鍍忔牱鐨勫悕瀛楋紙濡傦細绉冨ご灏忓疂璐濄€侀殧澹佽€佺帇銆佸畻闂ㄥぇ甯堝厔銆佺儹蹇冨競姘戞潕鍏堢敓锛夈€俓n    * **鐪熷疄鎰?*锛氳鏈変簰鍔ㄣ€佹湁鍚垫灦銆佹湁鐜╂銆佹湁鍟嗕笟浜掑惞銆俓n    * **浜掑姩鏍煎紡**锛氬繀椤诲寘鍚嚦灏戜竴鏉?\`Reply: 鍚嶅瓧: @鏌愪汉 鍥炲鍐呭\` 鐨勬牸寮忋€俓n\n銆愬己鍒惰緭鍑烘牸寮忋€慭n(璇蜂笉瑕佽緭鍑轰换浣曟€濊€冭繃绋嬶紝涓ョJSON锛岀洿鎺ユ寜浠ヤ笅鏍煎紡杈撳嚭5涓枃鏈潡)\n\n[POST_START]\nAuthor: 鍙戝竷鑰呭悕瀛?(涓昏AI 鎴?NPC鍚?\nContent: 甯栧瓙鍐呭 (娌夋蹈鍦ㄤ笘鐣岃閲?\nLikes: 128\nComment: 鍚嶅瓧: 璇勮鍐呭\nComment: 鍚嶅瓧: 璇勮鍐呭\nReply: 鍚嶅瓧: @鏌愪汉 鍥炲鍐呭\n... (璇风‘淇濊瘎璁鸿冻澶熶赴瀵岋紝澶氬啓鍑犳潯)\n[POST_END]\n\n(璇蜂繚鎸佹牸寮忔暣榻愶紝鐢熸垚5涓繖鏍风殑鍧?\n`;console.log("姝ｅ湪璇锋眰 AI 杩涜涓栫晫鎺ㄦ紨...");const a=await Lm(n);if(!a)throw console.error("銆愪弗閲嶃€慺etchSimpleAiResponse 杩斿洖浜嗙┖鍊?),new Error("API 璇锋眰澶辫触銆傚彲鑳藉師鍥狅細\n1. Token瓒呴檺(涓栫晫涔﹀お闀?\n2. API Key浣欓涓嶈冻\n3. 缃戠粶杩炰笉涓婃帴鍙n");const o=function(e){const t=[],n=/\[POST_START\]([\s\S]*?)\[POST_END\]/g;let a;for(;null!==(a=n.exec(e));){const e=a[1].trim(),n={author:"璺汉",content:"",likes:0,comments:[]};let o=null;e.split("\n").forEach(e=>{if(e=e.trim())if(e.startsWith("Author:")||e.startsWith("鍙戝竷鑰?")){const t=e.search(/[:锛歖/);t>-1&&(n.author=e.substring(t+1).trim())}else if(e.startsWith("Content:")||e.startsWith("鍐呭:")){const t=e.search(/[:锛歖/);t>-1&&(n.content=e.substring(t+1).trim())}else if(e.startsWith("Likes:")||e.startsWith("鐐硅禐:"))n.likes=parseInt(e.replace(/[^0-9]/g,""))||0;else if(e.startsWith("Comment:")||e.startsWith("璇勮:")){const t=e.substring(e.indexOf(":")+1).trim(),a=t.indexOf(":")>-1?t.indexOf(":"):t.indexOf("锛?);if(a>-1){const e=t.substring(0,a).trim(),s=t.substring(a+1).trim(),i={id:`wc-${Date.now()}-${Math.random()}`,author:e,avatar:Ll(e),content:s,timestamp:(new Date).toISOString(),replies:[]};e===N.ai.name&&(i.avatar=N.ai.avatar),n.comments.push(i),o=i}}else if((e.startsWith("Reply:")||e.startsWith("鍥炲:"))&&o){const t=e.substring(e.indexOf(":")+1).trim(),n=t.indexOf(":")>-1?t.indexOf(":"):t.indexOf("锛?);if(n>-1){const e=t.substring(0,n).trim();let a=t.substring(n+1).trim(),s=null;const i=a.match(/^@(\S+)\s*/);i?(s=i[1],a=a.replace(i[0],"")):s=o.author;const r={id:`wr-${Date.now()}-${Math.random()}`,author:e,content:a,targetUser:s,timestamp:(new Date).toISOString()};o.replies.push(r)}}}),n.content&&t.push(n)}return t}(a);if(0===o.length)throw new Error("瑙ｆ瀽澶辫触锛氭湭鑳芥彁鍙栧埌鏈夋晥甯栧瓙銆?);const s=await Kl.loadData("wowPosts","allPosts");let i=s&&Array.isArray(s.value)?s.value:[];o.forEach(e=>{let t;t=e.author===N.ai.name?N.ai.avatar:Ll(e.author);const n={id:Date.now()+Math.random(),author:e.author,avatar:t,content:e.content,timestamp:(new Date).toISOString(),contactId:N.id,likes:[],comments:[]},a=parseInt(e.likes)||10;for(let e=0;e<a;e++)n.likes.push({id:"fake",name:"user"});Array.isArray(e.comments)&&(n.comments=e.comments),i.push(n)}),await Kl.saveData("wowPosts","allPosts",i),Rp(),alert(`鎺ㄦ紨鎴愬姛锛佺敓鎴愪簡 ${o.length} 鏉″姩鎬乣)}catch(e){console.error("涓栫晫妯℃嫙澶辫触:",e),alert(`鎺ㄦ紨澶辫触: ${e.message}`)}finally{Jp.innerHTML=t,Jp.disabled=!1}}():alert("璇峰厛閫夋嫨涓€涓韩浠斤紒")}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("wow-compose-cancel-btn");e&&(e.onclick=function(){document.getElementById("wow-compose-modal").classList.remove("active")});const t=document.getElementById("wow-compose-publish-btn");t&&(t.onclick=eg)}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("wow-publish-trigger-btn");e&&e.addEventListener("click",Qp);const t=document.getElementById("wow-compose-cancel-btn");t&&t.addEventListener("click",()=>{const e=document.getElementById("wow-compose-modal");e&&e.classList.remove("active")});const n=document.getElementById("wow-compose-publish-btn");n&&n.addEventListener("click",eg)}),document.addEventListener("click",function(e){e.target.closest("#wow-publish-trigger-btn")&&(console.log("馃柋锔?鐐瑰嚮浜嗗彂甯冩寜閽?(閫氳繃浜嬩欢濮旀墭鎹曡幏)"),Qp())}),xo.addEventListener("keypress",e=>{if("Enter"===e.key){e.preventDefault();const t=xo.value.trim();t&&Dc(t),xo.focus()}}),document.addEventListener("DOMContentLoaded",async()=>{if(window.ImageStore){const e=await window.ImageStore.get("userDeviceSkin");e&&tg(e)}}),window.handleSkinUpload=function(e){const t=e.files[0];if(!t)return;"image/png"!==t.type&&alert("涓轰簡鏈€浣虫晥鏋滐紝璇蜂笂浼犺儗鏅€忔槑鐨?PNG 鍥剧墖锛?);const n=new FileReader;n.onload=function(e){const t=e.target.result;window.ImageStore?window.ImageStore.set("userDeviceSkin",t):localStorage.setItem("userDeviceSkin",t),tg(t),alert("鉁?鎵嬫満澹虫洿鎹㈡垚鍔燂紒")},n.readAsDataURL(t),e.value=""},window.resetSkin=function(){if(!confirm("纭畾瑕佺Щ闄よ嚜瀹氫箟鎵嬫満澹筹紝鎭㈠榛樿鏍峰紡鍚楋紵"))return;window.ImageStore?window.ImageStore.remove("userDeviceSkin"):localStorage.removeItem("userDeviceSkin");const e=document.getElementById("device-skin");e&&(e.style.display="none",e.src="");const t=document.querySelector(".phone-frame");t&&(t.style.border="");const n=document.getElementById("reset-skin-btn"),a=document.getElementById("skin-size-controls");n&&(n.style.display="none");a&&(a.style.display="none");localStorage.removeItem("skinSizeSettings")};const ng=document.getElementById("apply-skin-size-btn");ng&&ng.addEventListener("click",function(){const e=document.getElementById("device-skin"),t=document.getElementById("skin-width-input"),n=document.getElementById("skin-height-input"),a=document.getElementById("skin-offset-x-input"),o=document.getElementById("skin-offset-y-input");if(!e)return;const s=parseInt(t.value)||400,i=parseInt(n.value)||720,r=parseInt(a.value)||0,l=parseInt(o.value)||0;e.style.width=s+"px",e.style.height=i+"px",e.style.transform=`translate(calc(-50% + ${r}px), calc(-50% + ${l}px))`;const c={width:s,height:i,offsetX:r,offsetY:l};localStorage.setItem("skinSizeSettings",JSON.stringify(c)),alert("鉁?鎵嬫満澹冲昂瀵稿凡淇濆瓨锛?)});let ag=!0;async function og(e=0){if(void 0===Kl)return console.log("dbHelper 杩樻病鍔犺浇锛?00ms鍚庨噸璇?.."),void setTimeout(()=>og(e+1),500);if(!Kl.db)return e>10?void console.warn("鏁版嵁搴撹繛鎺ヨ秴鏃讹紝鏀惧純璇诲彇鏃佺櫧璁剧疆锛堜娇鐢ㄩ粯璁ゅ€硷級銆?):(console.log(`鏁版嵁搴撴鍦ㄨ繛鎺ヤ腑... 绛夊緟 500ms (绗?${e+1} 娆?`),void setTimeout(()=>og(e+1),500));try{const e=await Kl.loadData("settingsStore","narrationConfig");e&&e.value&&!1===e.value.enabled&&(ag=!1,document.body.classList.add("hide-narration-mode"),ig&&(ig.style.filter="grayscale(100%)",ig.style.opacity="0.6")),console.log("鉁?鏃佺櫧閰嶇疆璇诲彇鎴愬姛锛?)}catch(e){console.warn("璇诲彇鏃佺櫧閰嶇疆閬囧埌灏忛棶棰?(涓嶅奖鍝嶄娇鐢?:",e)}}og(),document.addEventListener("DOMContentLoaded",()=>{void 0!==Kl?og():console.error("绛夊緟椤甸潰鍔犺浇鍚庝緷鐒舵壘涓嶅埌 dbHelper锛岃妫€鏌ヤ唬鐮侀『搴?);const e=document.getElementById("chat-message-input"),t=()=>{const e=document.getElementById("chat-screen");e&&e.classList.remove("features-panel-active")};e&&(e.addEventListener("focus",t),e.addEventListener("click",t)),document.querySelectorAll(".feature-item").forEach(e=>{e.addEventListener("click",()=>{(["memory-feature","anecdotes-feature","peeping-feature","ludo-game-feature","tic-tac-toe-feature","transfer-feature","appointment-feature","dating-history-feature"].includes(e.id)||e.id.includes("transfer"))&&t()})});const n=document.getElementById("transfer-action-btn");n&&n.addEventListener("click",t)});const sg=document.getElementById("narration-toggle-feature"),ig=sg.querySelector(".feature-icon");sg&&sg.addEventListener("click",async()=>{ag=!ag,ag?(document.body.classList.remove("hide-narration-mode"),void 0!==ig&&(ig.style.filter="none",ig.style.opacity="1"),alert("宸插紑鍚?)):(document.body.classList.add("hide-narration-mode"),void 0!==ig&&(ig.style.filter="grayscale(100%)",ig.style.opacity="0.6"),alert("宸插叧闂?));try{await Kl.saveData("settingsStore","narrationConfig",{enabled:ag}),console.log("鏃佺櫧鐘舵€佸凡淇濆瓨鍒?IndexedDB")}catch(e){console.error("淇濆瓨鏃佺櫧鐘舵€佸け璐?",e)}id()});const rg=new Audio("./assets/pop.mp3");function lg(e){const t=e.split(","),n=t[0].match(/:(.*?);/)[1],a=atob(t[1]);let o=a.length;const s=new Uint8Array(o);for(;o--;)s[o]=a.charCodeAt(o);return new Blob([s],{type:n})}function kd(e,t,n,a){if(e&&"object"==typeof e)for(const o in e){const s=e[o];if("string"==typeof s&&s.startsWith("data:image/"))try{const i=cg(s,t,n,a);i&&(e[o]=`backup://images/${i}`)}catch(e){console.warn(`鎻愬彇鏅€氬浘鐗囧け璐? ${o}`,e)}else if("string"==typeof s&&(s.includes('url("data:image')||s.includes("url('data:image")||s.includes("url(data:image")))try{const i=s.match(/url\((?:['"]?)(data:image\/[^)'"]+)(?:['"]?)\)/);if(i&&i[1]){const s=cg(i[1],t,n,a);s&&(e[o]=`url("backup://images/${s}")`)}}catch(e){console.warn(`鎻愬彇CSS鑳屾櫙鍥惧け璐? ${o}`,e)}else"object"==typeof s&&null!==s&&kd(s,t,n,a)}}function cg(e,t,n,a){if(!e||!e.includes(","))return null;const o=function(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n),t>>>=0;return t.toString(16)}(e);if(a.has(o))return a.get(o);let s="jpg";e.includes("image/png")?s="png":e.includes("image/gif")?s="gif":e.includes("image/webp")&&(s="webp");const i=`img_${n.count++}.${s}`,r=e.split(",");if(r.length<2)return console.warn("鏃犳晥鐨刡ase64鏍煎紡:",e.substring(0,50)),null;let l=r[1].replace(/\s/g,"");const c=lg(l);return t.file(i,c),a.set(o,i),i}function dg(e,t,n,a,o="pending"){if(!document.getElementById("london-transfer-styles")){const e=document.createElement("style");e.id="london-transfer-styles",e.textContent='\n        /* ==========================================================\n           鑱婂ぉ璁剧疆鐙珛椤甸潰鏍峰紡 - 鏈堢櫧涓庨潚榛?/ Moon White & Indigo Grey\n           楂樼骇鍏嬪埗椋庢牸 (Advanced & Restrained) - 鍘籭OS鍖栵紝鍘绘殩鑹茶皟\n           ========================================================== */\n        :root {\n            --london-bg: #EAEFF2; \n            --london-card: #FFFFFF;\n            --london-card-alt: #F4F7F9;\n            --london-text-primary: #45494D; /* 闈掗粵锛氳瑙夐噸蹇?*/\n            --london-text-secondary: #5F6B73; /* 鐏拌摑锛氭瑕佷俊鎭?*/\n            --london-text-muted: #9FA6AB; /* 鏇存贰鐨勭伆鑹?*/\n            --london-accent: #45494D; \n            --london-accent-light: rgba(69, 73, 77, 0.08);\n            --london-border: rgba(69, 73, 77, 0.12);\n            --london-shadow: 0 4px 12px rgba(69, 73, 77, 0.08); /* 鏋佸厠鍒?*/\n            --london-shadow-soft: 0 2px 6px rgba(69, 73, 77, 0.04);\n            --london-danger: #D4A5A5; /* 淇濇寔浣庨ケ鍜?*/\n            --london-danger-dark: #C48888;\n            --london-success: #8FB3C4; /* 鍐疯皟缁?钃?*/\n        }\n\n        .transfer-card {\n            width: 230px;\n            background: var(--london-card);\n            border: 1px solid var(--london-border);\n            border-radius: 14px;\n            box-shadow: var(--london-shadow-soft);\n            overflow: hidden;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n            transition: all 0.3s ease;\n            cursor: pointer;\n            position: relative;\n        }\n\n        .transfer-card:hover {\n            box-shadow: var(--london-shadow);\n            transform: translateY(-1px);\n        }\n\n        .transfer-header {\n            display: flex;\n            align-items: center;\n            padding: 16px;\n            background: var(--london-card);\n            gap: 12px;\n        }\n\n        /* 鏋佺畝闈掗粵鑹插浘鏍囧鍣?*/\n        .transfer-icon-box {\n            width: 42px;\n            height: 42px;\n            background: var(--london-accent);\n            border-radius: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n            transition: background 0.3s ease;\n        }\n\n        .transfer-icon-svg {\n            width: 22px;\n            height: 22px;\n            fill: #FFFFFF;\n        }\n\n        .transfer-info {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n        }\n\n        .transfer-amount {\n            font-size: 17px;\n            font-weight: 600;\n            color: var(--london-text-primary);\n            letter-spacing: -0.5px;\n            line-height: 1.2;\n        }\n\n        .transfer-status-text {\n            font-size: 13px;\n            color: var(--london-text-secondary);\n            margin-top: 2px;\n            font-weight: 400;\n        }\n\n        .transfer-footer {\n            padding: 10px 16px;\n            background: var(--london-card-alt);\n            border-top: 1px solid var(--london-border);\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n\n        .transfer-footer span {\n            font-size: 11px;\n            color: var(--london-text-muted);\n            font-weight: 500;\n        }\n\n        /* 鐘舵€佸彉浣?*/\n        .transfer-card.status-accepted .transfer-icon-box {\n            background: var(--london-success);\n        }\n\n        .transfer-card.status-refused .transfer-icon-box {\n            background: var(--london-danger);\n        }\n        \n        /* 浜や簰閬僵 - 鏋佺畝鐧介鏍?*/\n        .transfer-overlay {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(255, 255, 255, 0.96); /* 楂樹互澶疄鑹?*/\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            opacity: 0;\n            pointer-events: none;\n            transition: opacity 0.2s ease;\n            z-index: 10;\n        }\n\n        .transfer-card.status-selecting .transfer-overlay {\n            opacity: 1;\n            pointer-events: auto;\n        }\n\n        .transfer-actions {\n            display: flex;\n            gap: 12px;\n            margin-bottom: 20px;\n        }\n\n        .action-btn {\n            padding: 8px 18px;\n            border-radius: 8px;\n            font-size: 13px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: opacity 0.2s;\n            color: white;\n            box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n        }\n        \n        .action-btn:hover {\n            opacity: 0.9;\n        }\n\n        .btn-accept {\n            background: var(--london-success);\n        }\n\n        .btn-refuse {\n            background: var(--london-danger);\n        }\n\n        .overlay-cancel {\n            font-size: 13px;\n            color: var(--london-text-secondary);\n            cursor: pointer;\n            padding: 4px 8px;\n            opacity: 0.7;\n        }\n        .overlay-cancel:hover {\n            opacity: 1;\n        }\n\n        .overlay-title {\n            font-size: 15px;\n            font-weight: 600;\n            color: var(--london-text-primary);\n            margin-bottom: 16px;\n        }\n        ',document.head.appendChild(e)}let s="";a||"pending"!==o||(s=`onclick="event.stopPropagation(); toggleTransferOverlay('${n}')"`);let i="鏈嬪弸";"undefined"!=typeof window&&window.currentOpenContact&&(a&&window.currentOpenContact.ai?i=window.currentOpenContact.ai.name:!a&&window.currentOpenContact.user&&(i=window.currentOpenContact.user.name));let r=`杞处缁?{i}`;"accepted"===o&&(r="宸叉敹娆?),"refused"===o&&(r="宸查€€鍥?);return`\n    <div id="transfer-${n}" class="transfer-card status-${o}" ${s} data-uuid="${n}">\n        \n        <div class="transfer-header">\n            <div class="transfer-icon-box">\n                <svg class="transfer-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    \x3c!-- 杞处鍥炬爣锛氬弻鍚戠澶?--\x3e\n                    <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </div>\n            <div class="transfer-info">\n                <div class="transfer-amount">楼 ${e}</div>\n                <div class="transfer-status-text">${r}</div>\n            </div>\n        </div>\n\n        <div class="transfer-footer">\n            <span>${t.length>10?t.substring(0,10)+"...":t||"杞处"}</span>\n            <span>涓冩敮浠?/span>\n        </div>\n\n        <div class="transfer-overlay">\n            <div class="overlay-title">纭鏀舵锛?/div>\n            <div class="transfer-actions">\n                <div class="action-btn btn-accept" onclick="window.handleTransferAction(event, '${n}', 'accepted', '${e}')">鎺ユ敹</div>\n                <div class="action-btn btn-refuse" onclick="window.handleTransferAction(event, '${n}', 'refused', '${e}')">閫€鍥?/div>\n            </div>\n            <div class="overlay-cancel" onclick="event.stopPropagation(); toggleTransferOverlay('${n}')">鍙栨秷</div>\n        </div>\n    </div>\n    `}rg.volume=.4,rg.load(),window.toggleTransferOverlay=function(e){event&&event.stopPropagation();const t=document.getElementById(`transfer-${e}`);t&&t.classList.toggle("status-selecting")},window.handleTransferAction=async function(e,t,n,a){e&&e.stopPropagation();const o=document.getElementById(`transfer-${t}`);if(!o)return;o.classList.remove("status-pending","status-selecting"),o.classList.add(`status-${n}`);const s=o.querySelector(".transfer-status-text");s&&(s.textContent="accepted"===n?"宸叉敹娆?:"宸查€€鍥?),o.removeAttribute("onclick");const i=o.querySelector(".transfer-overlay");if(i&&(i.style.display="none"),void 0!==Kl)try{let e="contact",o=null;if(Je)e="group",o=Je.id;else{if(!Sc)return;e="contact",o=Sc.id}if("contact"===e){let e=(await Kl.loadData("messageContacts","allContacts")).value||[];const s=e.findIndex(e=>e.id===o);if(s>-1){const o=e[s].history.find(e=>e.uuid===t);if(o){o.transferStatus=n;const t={sender:"user",text:`[鐢ㄦ埛宸?{"accepted"===n?"鎺ユ敹":"閫€鍥?}浜嗕綘鍙戞潵鐨?楼${a} 杞处]`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9),type:"transfer_notify",isHidden:!0};e[s].history.push(t),await Kl.saveData("messageContacts","allContacts",e),console.log(`鍗曡亰杞处 ${n} 宸蹭繚瀛橈紝宸查€氱煡 AI`),Sc&&(Sc.history=e[s].history)}}}else{let e=(await Kl.loadData("groupChats","allGroupChats")).value||[];const s=e.findIndex(e=>e.id===o);if(s>-1){const o=e[s].history.find(e=>e.uuid===t);if(o){o.transferStatus=n;const t={sender:"user",text:`[鐢ㄦ埛宸?{"accepted"===n?"鎺ユ敹":"閫€鍥?}浜嗕綘鍙戞潵鐨?楼${a} 杞处]`,timestamp:new Date,uuid:Date.now()+"-"+Math.random().toString(36).substr(2,9),type:"transfer_notify",isHidden:!0};e[s].history.push(t),await Kl.saveData("groupChats","allGroupChats",e),console.log(`缇よ亰杞处 ${n} 宸蹭繚瀛橈紝宸查€氱煡 AI`),Je&&(Je.history=e[s].history)}}}}catch(e){console.error("淇濆瓨杞处鐘舵€佸け璐?",e),alert("鐘舵€佷繚瀛樺け璐ワ紝璇峰埛鏂伴噸璇?)}else console.error("dbHelper 鏈畾涔夛紝鏃犳硶淇濆瓨鐘舵€?)},function(){const e=document.querySelector(".phone-frame"),t=document.getElementById("toggle-status-bar");if(!e||!t)return;const n=localStorage.getItem("showStatusBar"),a=null===n||"true"===n;t.checked=a,a||e.classList.add("hide-status-bar"),t.addEventListener("change",function(){const t=this.checked;t?e.classList.remove("hide-status-bar"):e.classList.add("hide-status-bar"),localStorage.setItem("showStatusBar",t)})}();const ug={board:["-","-","-","-","-","-","-","-","-"],currentTurn:"user",gameOver:!1,winner:null,messages:[],userSymbol:"O",aiSymbol:"X"},mg=document.getElementById("tic-tac-toe-modal"),pg=document.getElementById("tic-tac-toe-feature"),gg=document.getElementById("ttt-close-btn"),yg=document.getElementById("ttt-board"),hg=document.getElementById("ttt-status"),vg=document.getElementById("ttt-ai-avatar"),fg=document.getElementById("ttt-user-avatar"),wg=document.getElementById("ttt-ai-bubble"),bg=document.getElementById("ttt-user-bubble"),Eg=document.getElementById("ttt-user-first-btn"),Ig=document.getElementById("ttt-ai-first-btn"),xg=document.getElementById("ttt-start-panel"),kg=document.getElementById("ttt-chat-input-container"),Lg=document.getElementById("ttt-chat-input"),Bg=document.getElementById("ttt-send-chat-inline-btn"),Sg=document.getElementById("ttt-restart-btn"),Cg=document.getElementById("ttt-chat-modal"),$g=document.getElementById("ttt-chat-modal-close-btn"),Mg=document.getElementById("ttt-chat-textarea"),Tg=document.getElementById("ttt-send-chat-btn");function Ag(){ug.board=["-","-","-","-","-","-","-","-","-"],ug.currentTurn="user",ug.gameOver=!1,ug.winner=null,ug.messages=[],Sc&&(vg.src=Sc.ai?.avatar||"https://placehold.co/60x60/EFEFEF/AAAAAA?text=AI",fg.src=Sc.user?.avatar||"https://placehold.co/60x60/EFEFEF/AAAAAA?text=User",console.log("浜曞瓧妫嬪ご鍍忓凡璁剧疆:",{ai:vg.src,user:fg.src})),xg.style.display="flex",kg.style.display="none",Sg.style.display="none",hg.textContent="閫夋嫨鍏堟墜寮€濮嬫父鎴?,wg.textContent="绛夊緟寮€濮?..",bg.textContent="鍑嗗濂戒簡锛?,Dg()}function Dg(){yg.querySelectorAll(".board-cell").forEach((e,t)=>{const n=ug.board[t];if(e.innerHTML="",e.classList.remove("user-piece","ai-piece"),n===ug.userSymbol){const t=document.createElement("img");t.src=fg.src,t.classList.add("piece-avatar"),e.appendChild(t),e.classList.add("user-piece")}else if(n===ug.aiSymbol){const t=document.createElement("img");t.src=vg.src,t.classList.add("piece-avatar"),e.appendChild(t),e.classList.add("ai-piece")}})}async function Pg(){if(Sc)try{const e=await Kl.loadData("settingsStore","apiSettings");if(!e||!e.value||!e.value.url)throw new Error("API 鏈厤缃紝璇峰厛鍦ㄨ缃腑閰嶇疆 API");const{url:t,key:n,model:a}=e.value;let o=t.endsWith("/")?t.slice(0,-1):t;o+="/chat/completions";const s=ug.board.map((e,t)=>"-"===e?`${t+1}: 绌篳:e===ug.aiSymbol?`${t+1}: X(AI)`:`${t+1}: O(鐢ㄦ埛)`).join("\n"),i=ug.messages.map(e=>`${"ai"===e.sender?Sc.name:"鐢ㄦ埛"}: ${e.text}`).join("\n"),r=(Sc.history?Sc.history.slice(-10):[]).map(e=>"ai"===e.sender?`${Sc.name}: ${e.text}`:"user"===e.sender?`鐢ㄦ埛: ${e.text}`:"system"===e.sender?`[绯荤粺娑堟伅] ${e.text}`:"").filter(Boolean).join("\n");let l="";if(Sc.worldBooks&&Sc.worldBooks.length>0){const e=[];for(const t of Sc.worldBooks){const n=await Kl.loadData("worldBooksStore",t);n&&n.value&&n.value.content&&e.push(n.value.content)}e.length>0&&(l="\n銆愪笘鐣岃瀹氥€慭n"+e.join("\n\n"))}const c=`浣犳鍦ㄤ笌鐢ㄦ埛鐜╀簳瀛楁娓告垙銆俓n\n銆怉I 瑙掕壊璁惧畾銆慭n濮撳悕锛?{Sc.name}\n${Sc.ai?.persona||"浣犳槸涓€涓弸濂界殑 AI 鍔╂墜"}\n${l}\n\n銆愮敤鎴疯瀹氥€慭n${Sc.user?.persona||"鏅€氱敤鎴?}\n\n銆愪箣鍓嶇殑鑱婂ぉ璁板綍銆慭n${r||"鏆傛棤涔嬪墠鐨勮亰澶╄褰?}\n\n銆愬綋鍓嶄簳瀛楁娓告垙瀵硅瘽銆慭n${i||"鏆傛棤娓告垙鍐呭璇?}\n\n銆愬綋鍓嶆鐩樼姸鎬併€慭n${s}\n\n瑙勫垯锛氫綅缃紪鍙?1-9锛堜粠宸﹀埌鍙筹紝浠庝笂鍒颁笅锛塡nX = AI 鐨勬瀛愶紝O = 鐢ㄦ埛鐨勬瀛愶紝绌?= 鏈笅\n\n銆愰噸瑕佹彁绀恒€慭n1. 璇蜂繚鎸佷綘鐨勮鑹蹭汉璁撅紝鐢ㄧ鍚堜綘鎬ф牸鐨勬柟寮忚璇漒n2. 鍙互鍙傝€冧箣鍓嶇殑鑱婂ぉ璁板綍锛屼繚鎸佸璇濈殑杩炶疮鎬n3. 璇磋瘽瑕佺畝鐭紙闄愬埗鍦?0瀛椾互鍐咃級\n4. 鍙兘閫夋嫨绌轰綅涓嬫\n\n銆愯緭鍑烘牸寮忚姹傘€慭n浣犲繀椤讳弗鏍兼寜浠ヤ笅鏍煎紡鍥炲锛歕n[CHAT]浣犳兂璇寸殑璇濓紙闄愬埗鍦?0瀛椾互鍐咃紝绗﹀悎浣犵殑浜鸿锛塠/CHAT]\n[MOVE]浣犺涓嬬殑浣嶇疆(1-9)[/MOVE]\n\n绀轰緥锛歕n[CHAT]杩欐鎴戣耽瀹氫簡~[/CHAT]\n[MOVE]5[/MOVE]`,d=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:a,messages:[{role:"system",content:c},{role:"user",content:"璇锋牴鎹綋鍓嶆鐩樼姸鎬侊紝鍐冲畾浣犵殑涓嬩竴姝ユ锛屽苟璇翠竴鍙ョ鍚堜綘浜鸿鐨勮瘽銆?}],temperature:.9})});if(!d.ok)throw new Error(`API 璇锋眰澶辫触: ${d.status}`);const u=(await d.json()).choices[0].message.content;console.log("[浜曞瓧妫媇 AI 鍘熷鍥炲:",u),function(e){const t=e.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/),n=t?t[1].trim():"...",a=e.match(/\[MOVE\](\d)\[\/MOVE\]/);let o=a?parseInt(a[1]):null;if(null===o||o<1||o>9||"-"!==ug.board[o-1]){const e=ug.board.map((e,t)=>"-"===e?t:null).filter(e=>null!==e);if(!(e.length>0))return;o=e[0]+1}ug.messages.push({sender:"ai",text:n}),wg.textContent=n,ug.board[o-1]=ug.aiSymbol,Dg();const s=Hg();if(s)return void Og(s);ug.currentTurn="user",hg.textContent="杞埌浣犱笅妫嬩簡"}(u)}catch(e){console.error("AI 鍥炲悎鍑洪敊:",e),wg.textContent="鍑洪敊浜?..",hg.textContent="璇烽噸鏂板紑濮嬫父鎴?,ug.gameOver=!0}else console.error("娌℃湁鎵撳紑鐨勮仈绯讳汉")}function Hg(){const e=ug.board,t=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const n of t){const[t,a,o]=n;if("-"!==e[t]&&e[t]===e[a]&&e[t]===e[o])return e[t]===ug.userSymbol?"user":"ai"}return e.includes("-")?null:"draw"}async function Og(e){ug.gameOver=!0,ug.winner=e;let t="";if("user"===e?(t="浣犺耽浜嗭紒馃帀",bg.textContent="鎴戣耽鍟︼紒"):"ai"===e?(t=`${Sc.ai.name} 鑾疯儨锛乣,wg.textContent="鎴戣耽浜唦"):(t="骞冲眬锛?,bg.textContent="骞冲眬鍛?,wg.textContent="鎵撳钩浜?),hg.textContent=t,Sg.style.display="block",Sc){const t=ug.messages.map(e=>`${"ai"===e.sender?Sc.name:"浣?}: ${e.text}`).join("\n"),n=ug.board.map((e,t)=>{const n=t+1;return"-"===e?`${n}: 绌篳:e===ug.aiSymbol?`${n}: X(${Sc.name})`:`${n}: O(浣?`}).join(", "),a="user"===e?"浣犺幏鑳?:"ai"===e?`${Sc.name}鑾疯儨`:"骞冲眬";setTimeout(()=>{console.log("[浜曞瓧妫媇 瑙﹀彂AI鍥炲娓告垙缁撴灉");Tc(`(绯荤粺鎸囦护锛氬垰鍒氱粨鏉熶簡涓€灞€浜曞瓧妫嬫父鎴忋€俓n\n銆愭父鎴忕粨鏋溿€?{a}\n\n銆愭父鎴忓璇濄€慭n${t||"锛堟棤瀵硅瘽锛?}\n\n銆愭渶缁堟鐩樸€?{n}\n\n璇锋牴鎹繖灞€娓告垙璇磋浣犵殑鎰熸兂銆佽瘎璁烘垨鍙嶅簲銆?`,Sc)},1500)}console.log("娓告垙缁撴潫:",t)}function qg(){const e=Mg.value.trim();e&&(ug.messages.push({sender:"user",text:e}),bg.textContent=e,Mg.value="",Cg.style.display="none")}pg&&pg.addEventListener("click",()=>{Sc?(mg.style.display="flex",Ag(),id()):alert("璇峰厛閫夋嫨涓€涓仈绯讳汉")}),gg&&gg.addEventListener("click",()=>{mg.style.display="none"}),Eg&&Eg.addEventListener("click",()=>{xg.style.display="none",kg.style.display="flex",ug.currentTurn="user",hg.textContent="浣犲厛鎵嬶紝璇蜂笅妫?,wg.textContent="浣犲厛鏉ュ惂~"}),Ig&&Ig.addEventListener("click",()=>{xg.style.display="none",kg.style.display="flex",ug.currentTurn="ai",hg.textContent="TA鍦ㄦ€濊€冧腑...",bg.textContent="鐪嬩綘鐨勪簡",setTimeout(()=>{Pg()},800)}),yg&&yg.addEventListener("click",e=>{const t=e.target.closest(".board-cell");if(!t)return;!function(e){if("none"!==xg.style.display)return void alert("璇峰厛閫夋嫨璋佸厛鎵嬶紒");if(ug.gameOver)return;if("user"!==ug.currentTurn)return;if("-"!==ug.board[e])return;ug.board[e]=ug.userSymbol,Dg();const t=Hg();t?Og(t):(ug.currentTurn="ai",hg.textContent="TA鍦ㄦ€濊€冧腑...",wg.textContent="璁╂垜鎯虫兂...",setTimeout(()=>{Pg()},800))}(parseInt(t.dataset.index))}),Bg&&Lg&&Bg.addEventListener("click",()=>{const e=Lg.value.trim();e&&(ug.messages.push({sender:"user",text:e}),bg.textContent=e,Lg.value="",console.log("[浜曞瓧妫媇 鐢ㄦ埛鍙戦€佹秷鎭?",e))}),Lg&&Lg.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Bg.click())}),$g&&$g.addEventListener("click",()=>{Cg.style.display="none"}),Tg&&Tg.addEventListener("click",qg),Mg&&Mg.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),qg())}),Sg&&Sg.addEventListener("click",()=>{Ag()}),Cg&&Cg.addEventListener("click",e=>{e.target===Cg&&(Cg.style.display="none")});const Ng={aiPosition:0,userPosition:0,currentTurn:"user",diceValue:null,isRolling:!1,isMoving:!1,gameOver:!1,winner:null,messages:[],currentTruthQuestion:null},Fg={3:"bonus",5:"truth",6:"normal",9:"skip",12:"bonus",14:"truth",15:"penalty",18:"normal"},_g=["浣犳渶鍠滄鐨勪汉鏄皝锛?,"浣犲仛杩囨渶灏村艾鐨勪竴浠朵簨鏄粈涔堬紵","濡傛灉鏄庡ぉ鏄笘鐣屾湯鏃ワ紝浣犳渶鎯冲拰璋佸湪涓€璧凤紵","浣犳湁娌℃湁鍋峰伔鍠滄杩囪韩杈圭殑浜猴紵","浣犺寰楁垜鍝噷鏈€鍚稿紩浣狅紵","浣犳渶杩戜竴娆″摥鏄洜涓轰粈涔堬紵","浣犳渶澶х殑姊︽兂鏄粈涔堬紵","濡傛灉鍙互鍥炲埌杩囧幓锛屼綘鏈€鎯虫敼鍙樹粈涔堬紵","浣犳湁娌℃湁鎾掕繃涓€涓粠鏈鍙戠幇鐨勮皫锛?,"浣犲鑷繁鍝釜閮ㄤ綅鏈€涓嶆弧鎰忥紵","浣犳渶瀹虫€曚粈涔堬紵","濡傛灉缁欎綘涓€鐧句竾锛屼綘鎰挎剰绂诲紑鐜板湪鐨勭敓娲诲悧锛?,"浣犳湁娌℃湁鍦ㄥ績閲岄粯榛橀獋杩囨垜锛?,"浣犳渶璁ㄥ帉寮傛€т粈涔堣涓猴紵","浣犲垵鍚绘槸鍦ㄤ粈涔堟椂鍊欙紵","浣犳墜鏈洪噷鏈€鍚庝竴寮犵収鐗囨槸浠€涔堬紵","浣犺寰楃湡鐖卞瓨鍦ㄥ悧锛?,"浣犳湁娌℃湁鍚庢倲璁よ瘑杩囨煇涓汉锛?,"濡傛灉鍙互鎷ユ湁涓€绉嶈秴鑳藉姏锛屼綘甯屾湜鏄粈涔堬紵","浣犵幇鍦ㄦ渶鎯冲姝ゆ椂姝ゅ埢鐨勬垜璇翠粈涔堬紵"],Rg=["鍙戜竴涓孩鍖咃紝閲戦闅忔剰銆?,"鍞变竴棣栨瓕骞跺彂璇煶杩囨潵銆?,"鍙戜竴寮犱綘鐨勮嚜鎷嶇収銆?,"瀵规垜鎾掍釜濞囥€?,"瀛︿笁澹扮尗鍙苟鍙戣闊炽€?,"澶告垜涓夊垎閽熶笉璁搁噸澶嶃€?,"鎹竴涓垜鎸囧畾鐨勫ご鍍忎竴澶┿€?,"鍙戞湅鍙嬪湀璇粹€滄垜鏄尓鈥濆苟鎴浘銆?,"缁欐垜璁蹭竴涓喎绗戣瘽銆?,"妯′豢鎴戞渶杩戠殑涓€鍙ヨ瘽銆?,"鐖嗙収锛堢瀵嗙収闄ゅ锛夈€?,"璇村嚭鎴戠殑涓変釜浼樼偣銆?,"鐪熷績璇氭剰鍦板悜鎴戣〃鐧戒竴娆°€?,"鐢ㄦ柟瑷€璇翠竴鍙モ€滄垜鍠滄浣犫€濄€?,"杩炵画鍙戝崄涓綘鏈€鍠滄鐨勮〃鎯呭寘銆?,"鍥炵瓟鎴戜竴涓换鎰忛棶棰橈紝涓嶈鎾掕皫銆?,"鍙垜涓夊０鈥滀富浜衡€濇垨鈥滀翰鐖辩殑鈥濄€?,"鍘荤粰鎴戠殑鏈€鏂版湅鍙嬪湀鐐硅禐骞惰瘎璁哄叏鏄じ鎴戠殑璇濄€?,"缁欐垜鍙戜竴娈典笉灏戜簬30瀛楃殑鍦熷懗鎯呰瘽銆?,"鍧︾櫧涓€浠朵綘浠庢湭鍛婅瘔杩囨垜鐨勭瀵嗐€?],Gg=20;const Wg=function(){const e=[],t=44,n=12;for(let a=0;a<6;a++)e.push({x:n+a*t,y:n,index:a+1});for(let a=0;a<5;a++)e.push({x:232,y:n+(a+1)*t,index:7+a});for(let a=0;a<5;a++)e.push({x:n+(4-a)*t,y:232,index:12+a});for(let a=0;a<4;a++)e.push({x:n,y:n+(4-a)*t,index:17+a});return e}(),jg=document.getElementById("ludo-game-modal"),Ug=document.getElementById("ludo-game-feature"),zg=document.getElementById("ludo-close-btn"),Vg=document.getElementById("ludo-export-css-btn"),Jg=document.getElementById("ludo-board"),Yg=document.getElementById("ludo-dice"),Kg=document.getElementById("ludo-status"),Zg=document.getElementById("ludo-ai-avatar"),Xg=document.getElementById("ludo-user-avatar"),Qg=document.getElementById("ludo-ai-bubble"),ey=document.getElementById("ludo-user-bubble"),ty=document.getElementById("ludo-start-panel"),ny=document.getElementById("ludo-user-first-btn"),ay=document.getElementById("ludo-ai-first-btn"),oy=document.getElementById("ludo-roll-btn"),sy=document.getElementById("ludo-chat-input-container"),iy=document.getElementById("ludo-chat-input"),ry=document.getElementById("ludo-send-chat-btn"),ly=document.getElementById("ludo-restart-btn");function cy(){if(Ng.aiPosition=0,Ng.userPosition=0,Ng.currentTurn="user",Ng.diceValue=null,Ng.isRolling=!1,Ng.isMoving=!1,Ng.gameOver=!1,Ng.winner=null,Ng.messages=[],Sc&&(Zg.src=Sc.ai?.avatar||"https://placehold.co/60x60/FF6B6B/fff?text=AI",Xg.src=Sc.user?.avatar||"https://placehold.co/60x60/4ECDC4/fff?text=U"),Ng.isUserReplyingSpecial){Ng.isUserReplyingSpecial=!1;const e=Ng.currentTruthQuestion||"涓€涓湡蹇冭瘽闂";return Ng.pendingContext=`(绯荤粺鎻愮ず锛氱敤鎴峰垰鎵嶅洖绛斾簡鐪熷績璇濋棶棰樷€?{e}鈥濓紝鍥炵瓟鍐呭鏄細鈥?{text}鈥濄€傝浣犲湪鎺ヤ笅鏉ョ殑琛屽姩涓鐢ㄦ埛鐨勫洖绛斿仛鍑哄弽搴?璇勪环銆?`,delete Ng.currentTruthQuestion,Kg.textContent="鍥炵瓟宸茶褰曪紝杞埌TA浜?..",void setTimeout(hy,1500)}ty.style.display="flex",oy.style.display="none",sy.style.display="none",ly.style.display="none",Kg.textContent="閫夋嫨鍏堟墜寮€濮嬫父鎴?,Qg.textContent="鍑嗗璧烽~",ey.textContent="鍑哄彂鍚э紒",uy(1),dy()}function dy(){if(!Jg)return;let e="";Wg.forEach((t,n)=>{const a=n+1;let o="ludo-cell";1===a?o+=" cell-start":a===Gg?o+=" cell-end":Fg[a]&&(o+=` cell-${Fg[a]}`),e+=`\n                <rect \n                    class="${o}" \n                    x="${t.x}" \n                    y="${t.y}" \n                    width="40" \n                    height="40" \n                    rx="8"\n                    data-cell="${a}"\n                ></rect>\n                <text \n                    class="ludo-cell-number" \n                    x="${t.x+20}" \n                    y="${t.y+20+4}" \n                    text-anchor="middle"\n                >${a}</text>\n            `}),e+=`\n            <text x="${Wg[0].x+20}" y="${Wg[0].y-5}" \n                  text-anchor="middle" font-size="10" fill="var(--ludo-text-color)" font-weight="bold">璧风偣</text>\n        `,e+=`\n            <text x="${Wg[19].x+20}" y="${Wg[19].y-5}" \n                  text-anchor="middle" font-size="10" fill="var(--ludo-text-highlight)" font-weight="bold">缁堢偣</text>\n        `;const t=0===Ng.aiPosition?{x:120,y:130}:Ng.aiPosition>Gg?{x:140,y:140}:{x:Wg[Ng.aiPosition-1].x+20,y:Wg[Ng.aiPosition-1].y+20-8};e+=`\n            <g id="ludo-ai-piece" class="ludo-piece ai-piece" transform="translate(${t.x-12}, ${t.y-10})">\n                <defs>\n                    <linearGradient id="aiGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n                        <stop offset="0%" style="stop-color:#FF8A80;stop-opacity:1" />\n                        <stop offset="100%" style="stop-color:#FF5252;stop-opacity:1" />\n                    </linearGradient>\n                    <filter id="pieceShadow" x="-20%" y="-20%" width="140%" height="140%">\n                        <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>\n                        <feOffset dx="0" dy="2" result="offsetblur"/>\n                        <feComponentTransfer>\n                            <feFuncA type="linear" slope="0.3"/>\n                        </feComponentTransfer>\n                        <feMerge>\n                            <feMergeNode/>\n                            <feMergeNode in="SourceGraphic"/>\n                        </feMerge>\n                    </filter>\n                </defs>\n                \x3c!-- 鍦嗘鼎绠ご涓讳綋 (鎸囧悜鍙充笂鏂? --\x3e\n                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" \n                      fill="url(#aiGradient)" filter="url(#pieceShadow)"/>\n                \x3c!-- 鍐呴儴瑁呴グ --\x3e\n                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>\n            </g>\n        `;const n=0===Ng.userPosition?{x:160,y:150}:Ng.userPosition>Gg?{x:140,y:140}:{x:Wg[Ng.userPosition-1].x+20,y:Wg[Ng.userPosition-1].y+20+8};e+=`\n            <g id="ludo-user-piece" class="ludo-piece user-piece" transform="translate(${n.x-12}, ${n.y-10})">\n                <defs>\n                    <linearGradient id="userGradient" x1="0%" y1="0%" x2="0%" y2="100%">\n                        <stop offset="0%" style="stop-color:#80DEEA;stop-opacity:1" />\n                        <stop offset="100%" style="stop-color:#26C6DA;stop-opacity:1" />\n                    </linearGradient>\n                </defs>\n                \x3c!-- 鍦嗘鼎绠ご涓讳綋 --\x3e\n                <path d="M4,16 C4,16 6,4 12,4 C18,4 20,4 20,8 C20,12 20,20 12,20 C6,20 4,16 4,16 Z" \n                      fill="url(#userGradient)" filter="url(#pieceShadow)"/>\n                \x3c!-- 鍐呴儴瑁呴グ --\x3e\n                <path d="M12,8 L16,12 L12,16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>\n            </g>\n        `,Jg.innerHTML=e}function uy(e){if(!Yg)return;const t={1:["center"],2:["tl","br"],3:["tl","center","br"],4:["tl","tr","bl","br"],5:["tl","tr","center","bl","br"],6:["tl","tr","ml","mr","bl","br"]};let n=(t[e]||t[1]).map(e=>`<span class="dot ${e}"></span>`).join("");Yg.innerHTML=`<div class="dice-face" data-face="${e}">${n}</div>`}async function my(){if(Ng.isRolling||Ng.isMoving||Ng.gameOver)return;if(Ng.waitingForTruth)return;Ng.isRolling=!0,oy.disabled=!0,Yg.classList.add("rolling");let e=0;const t=setInterval(()=>{if(uy(Math.floor(6*Math.random())+1),e++,e>=12){clearInterval(t);const e=Math.floor(6*Math.random())+1;Ng.diceValue=e,uy(e),Yg.classList.remove("rolling"),Ng.isRolling=!1,Kg.textContent=`浣犳幏鍑轰簡 ${e} 鐐癸紒`,setTimeout(()=>{yy(e)},600)}},80)}async function py(){if(!Ng.gameOver){Kg.textContent=`${Sc?.name||"TA"}姝ｅ湪鎬濊€?..`;try{const e=await Kl.loadData("settingsStore","apiSettings");if(!e?.value?.url)return void gy();const{url:t,key:n,model:a}=e.value;let o=t.endsWith("/")?t.slice(0,-1):t;o+="/chat/completions";const s=0===Ng.aiPosition?"璧风偣":`绗?{Ng.aiPosition}鏍糮,i=0===Ng.userPosition?"璧风偣":`绗?{Ng.userPosition}鏍糮,r=(Sc?.history?Sc.history.slice(-8):[]).map(e=>"ai"===e.sender?`${Sc.name}: ${e.text}`:"user"===e.sender?`鐢ㄦ埛: ${e.text}`:"").filter(Boolean).join("\n");let l="";if(Sc?.worldBooks?.length>0){const e=[];for(const t of Sc.worldBooks){const n=await Kl.loadData("worldBooksStore",t);n?.value?.content&&e.push(n.value.content)}e.length>0&&(l="\n銆愪笘鐣岃瀹氥€慭n"+e.join("\n\n"))}const c=Ng.messages.map(e=>`${"ai"===e.sender?Sc.name:"鐢ㄦ埛"}: ${e.text}`).join("\n");let d="";Ng.pendingContext&&(d="\n銆愰噸瑕佹彁绀恒€?+Ng.pendingContext+"\n璇峰姟蹇呭湪浣犵殑鍥炵瓟涓涓婅堪鍐呭閫氳繃鍚愭Ы銆佽禐璧忔垨杩介棶绛夋柟寮忓仛鍑哄弽搴旓紒\n",Ng.pendingContext=null);const u=`浣犳鍦ㄤ笌鐢ㄦ埛鐜╅琛屾娓告垙銆備綘鐨勫悕瀛楁槸"${Sc?.name||"TA"}"銆?{d} \n\n銆愯鑹茶瀹氥€慭n${Sc?.ai?.persona||"浣犳槸涓€涓€ф牸椴滄槑鐨勮鑹层€?}\n${l}\n\n銆愬綋鍓嶇殑瀵硅瘽璇銆慭n${r||"锛堟殏鏃犱箣鍓嶅璇濓級"}\n\n銆愭父鎴忓唴鍗虫椂璁板綍銆慭n${c||"锛堟父鎴忓垰寮€濮嬶級"}\n\n銆愬綋鍓嶅眬闈€慭n- 浣犲湪: ${s}\n- 鐢ㄦ埛鍦? ${i}\n- 鐩爣: 绗?0鏍糪n- 鐘跺喌: 杞埌浣犳幏楠板瓙\n\n銆愯鍔ㄥ噯鍒欍€慭n1. **瀹屽叏浠ｅ叆瑙掕壊**锛氬繀椤荤敤"${Sc?.name||"TA"}"鐨勮姘斻€佸彛鐧栧拰鎬ф牸璇磋瘽銆俓n2. **鎷掔粷鏈烘鎰?*锛氫笉瑕佸杩拌鍒欙紝涓嶈璇?杞埌鎴戜簡"銆傜洿鎺ユ牴鎹眬闈㈠彂琛ㄦ劅鎯筹紙绁堢シ濂借繍銆佹斁鐙犺瘽銆侀棽鑱婄殕鍙級銆俓n3. **绠€鐭嚜鐒?*锛氬儚鐪熶汉涓€鏍疯亰澶╋紝涓€涓ゅ彞璇濆嵆鍙紙20瀛椾互鍐咃級銆俓n\n銆愯緭鍑烘牸寮忋€慭n[CHAT]浣犵殑璇漑/CHAT]`,m=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:a,messages:[{role:"system",content:u},{role:"user",content:"杞埌浣犱簡锛岃璇翠竴鍙ヨ瘽锛堥瀛愮偣鏁板皢鐢辩郴缁熼殢鏈虹敓鎴愶級銆?}],temperature:.9})});if(!m.ok)throw new Error(`API璇锋眰澶辫触: ${m.status}`);const p=(await m.json()).choices[0].message.content;console.log("[椋炶妫媇 AI鍘熷鍥炲:",p),async function(e){const t=e.match(/\[CHAT\]([\s\S]*?)\[\/CHAT\]/),n=t?t[1].trim():e.replace(/\[.*?\]/g,"").trim()||"璧拌捣~",a=Math.floor(6*Math.random())+1;Ng.messages.push({sender:"ai",text:n}),Qg.textContent=n,Kg.textContent=`${Sc?.name||"TA"}姝ｅ湪鎺烽瀛?..`,await vy(800),Yg.classList.add("rolling");let o=0;const s=10;await new Promise(e=>{const t=setInterval(()=>{uy(Math.floor(6*Math.random())+1),o++,o>=s&&(clearInterval(t),e())},80)}),uy(a),Yg.classList.remove("rolling"),Ng.diceValue=a,Kg.textContent=`${Sc?.name||"TA"}鎺峰嚭浜?${a} 鐐癸紒`,await vy(800),await yy(a)}(p)}catch(e){console.error("[椋炶妫媇 AI鍥炲悎鍑洪敊:",e),gy()}}}async function gy(){const e=["鐪嬫垜鐨勶紒","杩欐涓€瀹氬ぇ锛?,"鍐插啿鍐瞺","鍢垮樋~","璧拌捣锛?,"椋為珮楂橈紒"];Qg.textContent=e[Math.floor(Math.random()*e.length)],await vy(600),Yg.classList.add("rolling");let t=0;const n=Math.floor(6*Math.random())+1;await new Promise(e=>{const n=setInterval(()=>{uy(Math.floor(6*Math.random())+1),t++,t>=10&&(clearInterval(n),e())},80)}),uy(n),Yg.classList.remove("rolling"),Ng.diceValue=n,Kg.textContent=`${Sc?.name||"TA"}鎺峰嚭浜?${n} 鐐癸紒`,await vy(800),await yy(n)}async function yy(e){const t=Ng.currentTurn,n="user"===t?Ng.userPosition:Ng.aiPosition;let a=n+e;a>Gg&&(a=Gg),Ng.isMoving=!0,0===n&&("user"===t?Ng.userPosition=1:Ng.aiPosition=1,dy(),await vy(500),a=1+e-1,a>Gg&&(a=Gg));for(let e=("user"===t?Ng.userPosition:Ng.aiPosition)+1;e<=a;e++){"user"===t?Ng.userPosition=e:Ng.aiPosition=e;const n=document.getElementById("user"===t?"ludo-user-piece":"ludo-ai-piece");n&&n.classList.add("flying"),dy(),await vy(400),n&&(n.classList.remove("flying"),n.classList.add("landing"),setTimeout(()=>n.classList.remove("landing"),400))}if(Ng.isMoving=!1,a>=Gg)return Ng.gameOver=!0,Ng.winner=t,void async function(){const e=Ng.winner,t="user"===e?"浣?:Sc?.name||"TA";Kg.textContent=`馃帀 ${t}鑾疯儨锛乣,"user"===e?(ey.textContent="鎴戣耽鍟︼紒",Qg.textContent="涓嬫鍐嶆垬锛?):(Qg.textContent="鎴戣耽鍟",ey.textContent="鍐嶆潵涓€灞€锛?);oy.style.display="none",ly.style.display="block",Sc&&setTimeout(()=>{const t=Ng.messages.map(e=>`${"ai"===e.sender?Sc.name:"浣?}: ${e.text}`).join("\n"),n="user"===e?"浣犺幏鑳?:"ai"===e?`${Sc.name}鑾疯儨`:"娓告垙缁撴潫",a=Rg[Math.floor(Math.random()*Rg.length)];let o="";"user"===e?(o=`銆愭儵缃氱幆鑺傘€戜綘杈撲簡锛佽鎺ュ彈鎯╃綒锛?{a}\n(璇稟I鏍规嵁浣犵殑鎬ф牸锛岄€夋嫨鎵ц杩欎釜鎯╃綒锛屾垨鑰呯敤鏈夎叮鐨勬柟寮忚禆鎺夛紝鎴栬€呮拻濞囨眰楗讹紝鎬讳箣瑕佹湁鍙嶅簲)`,alert(`馃帀 浣犺耽浜嗭紒\n\n闅忔満鐢熸垚鐨勬儵缃氭槸锛歕n${a}\n\n(宸查€氱煡锛岀湅TA鎬庝箞璇磣)`)):(o=`銆愭儵缃氱幆鑺傘€戠敤鎴疯緭浜嗭紒鐢ㄦ埛鎶藉埌鐨勬儵缃氭槸锛?{a}\n(璇锋牴鎹綘鐨勬€ф牸锛屽槻绗戙€佽皟渚冪敤鎴凤紝鎴栬€呯洃鐫ｇ敤鎴锋墽琛屾儵缃?`,alert(`馃槶 浣犺緭浜嗭紒\n\n浣犳娊鍒扮殑鎯╃綒鏄細\n${a}\n\n(TA姝ｅ湪鐪嬬潃浣犲摝...)`));const s=`(绯荤粺鎸囦护锛氬垰鍒氱粨鏉熶簡涓€灞€椋炶妫嬫父鎴忋€俓n                \n銆愭父鎴忕粨鏋溿€?{n}\n\n銆愭渶缁堜綅缃€慭nAI: 绗?${Ng.aiPosition} 鏍?(鍏?0鏍?\n鐢ㄦ埛: 绗?${Ng.userPosition} 鏍?(鍏?0鏍?\n\n${o}\n\n銆愭父鎴忓璇濄€慭n${t||"锛堟棤瀵硅瘽锛?}\n\n璇锋牴鎹繖灞€娓告垙缁撴灉鍜屾儵缃氱幆鑺傦紝璇磋浣犵殑鎰熸兂銆佽瘎璁烘垨鍙嶅簲銆俙;console.log("[椋炶妫媇 瑙﹀彂AI鍥炲:",s),Tc(s,Sc)},1e3)}();await async function(e,t){const n=Fg[e];if(!n)return void hy();const a="user"===t?"浣?:Sc?.name||"TA";switch(n){case"bonus":return Kg.textContent=`馃帀 ${a}韪╁埌浜嗗姞閫熸牸锛屽墠杩?鏍硷紒`,await vy(1200),void await yy(2);case"penalty":const e="user"===t?Ng.userPosition:Ng.aiPosition;Kg.textContent=`馃槄 ${a}韪╁埌浜嗗噺閫熸牸锛屽悗閫€2鏍硷紒`,await vy(800);const n=Math.max(1,e-2);"user"===t?Ng.userPosition=n:Ng.aiPosition=n,dy(),await vy(1e3),hy();break;case"skip":Kg.textContent=`鈴革笍 ${a}韪╁埌浜嗘殏鍋滄牸锛屼紤鎭竴杞紒`,await vy(1200),hy();break;case"truth":const o=_g[Math.floor(Math.random()*_g.length)];if("user"!==t){const e=`(棰樼洰: ${o})`;return Kg.textContent="TA姝ｅ湪鎬濊€冮鐩?..",Qg.textContent=e,Ng.messages.push({sender:"ai",text:e}),void async function(e){if(Sc)try{const t=await Kl.loadData("settingsStore","apiSettings"),{url:n,key:a,model:o}=t?.value||{};if(!n||!a)return Qg.textContent="(AI閰嶇疆缂哄け锛屾棤娉曞洖绛?",void setTimeout(hy,3e3);let s=n.endsWith("/")?n.slice(0,-1):n;s+="/chat/completions";const i=Sc.ai||{},r=Sc.user||{},l=i.persona||i.description||"鏃犺瀹?,c=r.persona||"鏅€氱敤鎴?,d=[{role:"system",content:`浣犳鍦ㄥ拰鐢ㄦ埛鐜╅琛屾銆備綘韪╁埌浜嗏€滅湡蹇冭瘽鈥濇牸瀛愩€俓n鍙兘鐢ㄧ鍚堜綘浜鸿鐨勮姘斿洖绛旓紝涓嶈璺冲嚭瑙掕壊銆俓n浣犵殑鍥炵瓟搴旇绠€鐭€佹湁瓒ｃ€佺鍚堝綋涓嬫儏澧冦€俓n\n銆愰鐩€慭n${e}\n\n銆愯鑹茶瀹氥€慭n浣? ${i.name||"AI"} (${l})\n鐢ㄦ埛: ${r.name||"鐢ㄦ埛"} (${c})\n`},{role:"user",content:`璇峰洖绛旂湡蹇冭瘽棰樼洰锛?{e}`}],u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:o,messages:d,temperature:.8})});if(!u.ok){const e=await u.text();throw new Error(`API閿欒: ${u.status} - ${e}`)}const m=await u.json(),p=m.choices?.[0]?.message?.content||"(娌夐粯)";Qg.textContent=p,Ng.messages.push({sender:"ai",text:p}),Sc.history||(Sc.history=[]),Sc.history.push({sender:"ai",text:`(鍦ㄩ琛屾鐪熷績璇濅腑鍥炵瓟): ${p}`,timestamp:Date.now()}),await Kl.saveData("messageContacts",Sc),setTimeout(hy,4e3)}catch(e){console.error("AI Truth Error:",e),Qg.textContent=`(AI鍑洪敊: ${e.message.substring(0,15)}...)`,setTimeout(hy,4e3)}}(o)}alert(`銆愮湡蹇冭瘽銆慭n璇峰洖绛旓細${o}\n\n(璇峰湪鑱婂ぉ杈撳叆妗嗗彂閫佷綘鐨勫洖绛斾互缁撴潫鍥炲悎)`),Kg.textContent=`璇峰湪鑱婂ぉ妗嗗洖绛旓細${o}`,Ng.isUserReplyingSpecial=!0,Ng.currentTruthQuestion=o;break;case"punishment":const s=Rg[Math.floor(Math.random()*Rg.length)];if("user"!==t){Kg.textContent="TA闈复鎯╃綒...";const e=`(绯荤粺鎻愮ず锛氫綘韪╁埌浜嗏€滃ぇ鍐掗櫓/鎯╃綒鈥濇牸瀛愩€傛儵缃氬唴瀹规槸锛?{s}銆傝鏍规嵁浣犵殑浜鸿鍋氬嚭鍙嶅簲銆傚鏋滈渶瑕佸彂绾㈠寘鎴栬闊筹紝璇风敤鏂囧瓧鎻忚堪浣犵殑琛屽姩銆?`;return void setTimeout(()=>Tc(e,Sc),1e3)}alert(`銆愬ぇ鍐掗櫓/鎯╃綒銆慭n璇锋墽琛岋細${s}\n\n(璇峰湪鑱婂ぉ杈撳叆妗嗘弿杩颁綘鐨勮鍔ㄤ互缁撴潫鍥炲悎)`),Kg.textContent=`璇峰湪鑱婂ぉ妗嗗畬鎴愭儵缃氾細${s}`,Ng.isUserReplyingSpecial=!0;break;default:hy()}}(a,t)}function hy(){Ng.gameOver||(Ng.currentTurn="user"===Ng.currentTurn?"ai":"user","user"===Ng.currentTurn?(Kg.textContent="杞埌浣犳幏楠板瓙浜嗭紒",oy.disabled=!1):(Kg.textContent=`${Sc?.name||"TA"}姝ｅ湪鎬濊€?..`,oy.disabled=!0,setTimeout(()=>{py()},1e3)))}function vy(e){return new Promise(t=>setTimeout(t,e))}if(Ug&&Ug.addEventListener("click",()=>{Sc?(jg.style.display="block",cy(),id()):alert("璇峰厛閫夋嫨涓€涓仈绯讳汉")}),zg&&zg.addEventListener("click",()=>{jg.style.display="none"}),Vg&&Vg.addEventListener("click",function(){const e=document.documentElement,t=getComputedStyle(e),n={"ludo-primary":t.getPropertyValue("--ludo-primary").trim()||"#FFD93D","ludo-secondary":t.getPropertyValue("--ludo-secondary").trim()||"#6BCB77","ludo-accent":t.getPropertyValue("--ludo-accent").trim()||"#4D96FF","ludo-bg-start":t.getPropertyValue("--ludo-bg-start").trim()||"#FFFBEB","ludo-bg-end":t.getPropertyValue("--ludo-bg-end").trim()||"#E8F5E9","ludo-cell-normal":t.getPropertyValue("--ludo-cell-normal").trim()||"#FFF8E7","ludo-cell-bonus":t.getPropertyValue("--ludo-cell-bonus").trim()||"#B4F8C8","ludo-cell-penalty":t.getPropertyValue("--ludo-cell-penalty").trim()||"#FFADAD","ludo-cell-truth":t.getPropertyValue("--ludo-cell-truth").trim()||"#FFD6E8","ludo-cell-start":t.getPropertyValue("--ludo-cell-start").trim()||"#A0C4FF","ludo-cell-end":t.getPropertyValue("--ludo-cell-end").trim()||"#FFE066","ludo-console-bg":t.getPropertyValue("--ludo-console-bg").trim()||"#2D2D2D","ludo-plane-ai":t.getPropertyValue("--ludo-plane-ai").trim()||"#FF6B6B","ludo-plane-user":t.getPropertyValue("--ludo-plane-user").trim()||"#4ECDC4","ludo-border-radius":t.getPropertyValue("--ludo-border-radius").trim()||"24px"},a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download="ludo-game-styles.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),Kg.textContent="CSS鏍峰紡宸插鍑猴紒",setTimeout(()=>{Ng.gameOver||(Kg.textContent="user"===Ng.currentTurn?"杞埌浣犳幏楠板瓙浜嗭紒":"TA鐨勫洖鍚?)},2e3)}),ny&&ny.addEventListener("click",()=>{ty.style.display="none",oy.style.display="block",sy.style.display="flex",Ng.currentTurn="user",Kg.textContent="杞埌浣犳幏楠板瓙浜嗭紒",Qg.textContent="浣犲厛鏉"}),ay&&ay.addEventListener("click",()=>{ty.style.display="none",oy.style.display="block",sy.style.display="flex",oy.disabled=!0,Ng.currentTurn="ai",Kg.textContent=`${Sc?.name||"TA"}鍏堟幏楠板瓙...`,ey.textContent="鐪嬩綘鐨勶紒",setTimeout(()=>py(),800)}),oy&&oy.addEventListener("click",()=>{"user"===Ng.currentTurn&&my()}),Yg&&Yg.addEventListener("click",()=>{"user"!==Ng.currentTurn||oy.disabled||my()}),ry&&iy){const lv=()=>{const e=iy.value.trim();if(e&&(Ng.messages.push({sender:"user",text:e}),ey.textContent=e,iy.value="",Ng.isUserReplyingSpecial)){Ng.isUserReplyingSpecial=!1;const t=Ng.currentTruthQuestion||"涓€涓湡蹇冭瘽闂";Ng.pendingContext=`(绯荤粺鎻愮ず锛氱敤鎴峰垰鎵嶅洖绛斾簡鐪熷績璇濋棶棰樷€?{t}鈥濓紝鍥炵瓟鍐呭鏄細鈥?{e}鈥濄€傝浣犲湪鎺ヤ笅鏉ョ殑琛屽姩涓鐢ㄦ埛鐨勫洖绛斿仛鍑哄弽搴?璇勪环銆?`,delete Ng.currentTruthQuestion,Kg.textContent="鉁?鍥炵瓟宸茶褰曪紝杞埌TA浜?..",setTimeout(()=>{hy()},1500)}};ry.addEventListener("click",e=>{e.stopPropagation(),lv()}),iy.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e.stopPropagation(),lv())}),iy.addEventListener("click",e=>{e.stopPropagation(),iy.focus()}),iy.addEventListener("touchstart",e=>{e.stopPropagation()})}ly&&ly.addEventListener("click",cy);const fy=document.getElementById("chat-message-input");if(fy){const cv=e=>{e.stopPropagation(),fy.focus()};fy.addEventListener("click",cv),fy.addEventListener("touchstart",cv)}const wy=document.getElementById("memory-feature"),by=document.getElementById("memory-modal"),Ey=document.getElementById("memory-close-btn"),Iy=document.querySelector(".memory-modal-overlay"),xy=document.querySelectorAll(".memory-tab"),ky=document.getElementById("memory-retrospect-panel"),Ly=document.getElementById("memory-bonds-panel"),By=document.getElementById("memory-total-count"),Sy=document.getElementById("memory-last-summarized"),Cy=document.getElementById("memory-unprocessed-count"),$y=document.getElementById("memory-message-count"),My=document.getElementById("memory-model-select"),Ty=document.getElementById("memory-prompt-input"),Ay=document.getElementById("memory-summarize-btn"),Dy=document.getElementById("memory-cheques-container");async function Py(){if(Sc){by.style.display="flex",await async function(){try{var e=await Kl.loadData("settingsStore","apiSettings");if(!e||!e.value||!e.value.model)return void(My.innerHTML='<option value="">璇峰厛鍦ㄨ缃腑閰嶇疆API</option>');var t=e.value.model;My.options.length<=1&&(My.innerHTML='<option value="'+t+'" selected>'+t+"</option>");var n=document.getElementById("memory-fetch-models-btn");if(n){var a=n.cloneNode(!0);n.parentNode.replaceChild(a,n),a.addEventListener("click",Ny)}}catch(e){console.error("鍔犺浇妯″瀷澶辫触:",e),My.innerHTML='<option value="">鍔犺浇澶辫触</option>'}}(),Fy(),await Jy();var e=document.getElementById("more-features-panel");e&&e.classList.remove("active")}else alert("璇峰厛閫夋嫨涓€涓仈绯讳汉")}function Hy(){by&&(by.style.display="none"),Dy&&(Dy.innerHTML="")}function Oy(e){xy.forEach(function(t){t.classList.toggle("active",t.dataset.tab===e)}),ky.classList.toggle("active","retrospect"===e),Ly.classList.toggle("active","bonds"===e)}function qy(e,t){var n=document.createElement("div");n.className="memory-toast",n.innerText=e,n.style.position="fixed",n.style.top="20px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.padding="10px 20px",n.style.background="rgba(139, 90, 43, 0.9)",n.style.color="#fff",n.style.borderRadius="4px",n.style.zIndex="10000",n.style.fontSize="14px",n.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",n.style.transition="opacity 0.3s ease",document.body.appendChild(n),setTimeout(function(){n.style.opacity="0",setTimeout(function(){n.parentNode&&n.parentNode.removeChild(n)},300)},3e3)}async function Ny(){var e=document.getElementById("memory-fetch-models-btn");e&&e.classList.add("loading");try{var t=await Kl.loadData("settingsStore","apiSettings");if(!t||!t.value||!t.value.url)return void alert("璇峰厛鍦ㄨ缃腑閰嶇疆API鍦板潃");var n=t.value.url;n.endsWith("/")&&(n=n.slice(0,-1));var a=n+"/models",o=await fetch(a,{method:"GET",headers:{Authorization:"Bearer "+t.value.key}});if(!o.ok)throw new Error("鑾峰彇妯″瀷鍒楄〃澶辫触: "+o.status);var s=await o.json(),i=[];if(Array.isArray(s.data)?i=s.data.map(e=>e.id):Array.isArray(s)&&(i=s.map(e=>e.id)),i.length>0){i.sort();var r=My.value,l=i.map(function(e){return'<option value="'+e+'"'+(e===r?" selected":"")+">"+e+"</option>"}).join("");!i.includes(r)&&r&&(l='<option value="'+r+'" selected>'+r+"</option>"+l),My.innerHTML=l,qy("宸叉垚鍔熸媺鍙?"+i.length+" 涓ā鍨?)}else qy("鏈壘鍒板彲鐢ㄦā鍨?)}catch(e){console.error("鎷夊彇妯″瀷澶辫触:",e),qy("鎷夊彇妯″瀷澶辫触锛岃妫€鏌ョ綉缁滄垨閰嶇疆")}finally{e&&e.classList.remove("loading")}}function Fy(){if(!Sc||!Sc.history)return By.textContent="0",Sy.textContent="0",void(Cy.textContent="0");var e=Sc.history.length,t=Sc.lastMemorySummarizedIndex||0;By.textContent=e,Sy.textContent=t,Cy.textContent=e-t}async function _y(){if(Sc){var e=parseInt($y.value),t=My.value,n=Ty.value.trim();if(t)if(n)if(e<1||e>2e4)alert("璁板綍鏁伴噺搴斿湪1-20000涔嬮棿");else{if(e>200){if(!confirm(`鎮ㄩ€夋嫨浜?${e} 鏉℃秷鎭繘琛屾€荤粨銆俓n\n棰勪及灏嗘秷鑰楃害 ${(100*e).toLocaleString()} tokens銆俓n\n杩欏彲鑳戒細浜х敓杈冮珮鐨?API 璐圭敤锛屾槸鍚︾户缁紵`))return}Ay.disabled=!0,Ay.innerHTML="<span>姝ｅ湪鎬荤粨...</span>";try{var a=await async function(e,t,n){var a=Sc.history.slice(-e),o=a.map(function(e){return("user"===e.sender?Sc.user.name:Sc.ai.name)+": "+(e.text||"(闈炴枃鏈秷鎭?")}).join("\n"),s=n.replace("{CHAT_HISTORY}",o),i=await Kl.loadData("settingsStore","apiSettings");if(!i||!i.value.url)throw new Error("API鏈厤缃?);var r=i.value.url;r.endsWith("/")&&(r=r.slice(0,-1));r+="/chat/completions";var l=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+i.value.key},body:JSON.stringify({model:t,messages:[{role:"user",content:s}],temperature:.8,max_tokens:2e4})});if(!l.ok)throw new Error("API璇锋眰澶辫触: "+l.status);return(await l.json()).choices[0].message.content.trim()}(e,t,n);a&&(await Ry(a,e),Sc.lastMemorySummarizedIndex=Sc.history.length,await tu(),Fy(),Oy("bonds"),await Jy(),alert("鎬荤粨瀹屾垚!"))}catch(e){console.error("鎬荤粨澶辫触:",e),alert("鎬荤粨澶辫触: "+e.message)}finally{Ay.disabled=!1,Ay.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke="currentColor" stroke-width="2"/></svg><span>寮€濮嬫€荤粨</span>'}}else alert("璇疯緭鍏ユ€荤粨Prompt");else alert("璇烽€夋嫨涓€涓ā鍨?)}else alert("璇峰厛閫夋嫨涓€涓仈绯讳汉")}async function Ry(e,t){var n={id:"memory_"+Date.now(),contactId:Sc.id,content:e,createdAt:(new Date).toISOString(),summarizedAtIndex:Sc.history.length,summarizedMessageCount:t,isEnabled:!0,editedContent:null},a=await Kl.loadData("memoryCheques",Sc.id),o=a&&a.value?a.value:[];return o.push(n),await Kl.saveData("memoryCheques",Sc.id,o),n}var Gy,Wy,jy,Uy,zy,Vy=1;async function Jy(){if(Sc)try{var e=await Kl.loadData("memoryCheques",Sc.id),t=e&&e.value?e.value:[],n=document.getElementById("memory-cheque-pagination"),a=document.getElementById("memory-prev-cheque"),o=document.getElementById("memory-next-cheque"),s=document.getElementById("memory-cheque-indicator");if(0===t.length)return Dy.innerHTML='<div class="memory-empty-state"><svg width="64" height="64" viewBox="0 0 24 24" fill="none"><path opacity="0.4" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" fill="currentColor"/><path d="M12 17C9.24 17 7 14.76 7 12H9C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12H17C17 14.76 14.76 17 12 17Z" fill="currentColor"/></svg><p>鏆傛棤璁板繂鏀エ</p><p class="memory-empty-hint">鍦ㄥ洖婧晫闈㈢敓鎴愮涓€涓蹇嗗惂~</p></div>',void(n&&(n.style.display="none"));var i=t.slice().reverse(),r=i.length;Vy>r&&(Vy=r),Vy<1&&(Vy=1);var l=i.map(function(e,t){var n=new Date(e.createdAt),a=n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0")+" "+String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0"),o=e.editedContent||e.content,s=String(i.length-t).padStart(3,"0"),r=e.isEnabled?"enabled":"disabled",l=e.isEnabled?"宸插惎鐢?:"鏈惎鐢?,c=e.isEnabled?"":"disabled",d=e.isEnabled?'<path d="M22 11.08V12a10 10 0 11-5.93-9.14M22 4L12 14.01l-3-3"/>':'<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',u=e.isEnabled?"鍚敤涓?:"宸茬鐢?,m=t+1===Vy?"display: block;":"";return'<div class="memory-cheque-card" data-cheque-id="'+e.id+'" style="'+m+'"><div class="memory-cheque-header"><span class="memory-cheque-number">璁板繂鏀エ No.'+s+'</span><span class="memory-cheque-date">'+a+'</span></div><div class="memory-cheque-content">'+o+'</div><div class="memory-cheque-footer"><span class="memory-cheque-status '+r+'"><span class="memory-cheque-status-dot"></span>'+l+'</span></div><div class="memory-cheque-actions"><button class="memory-cheque-btn edit-btn" data-action="edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>缂栬緫</button><button class="memory-cheque-btn toggle-btn '+c+'" data-action="toggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">'+d+"</svg>"+u+'</button><button class="memory-cheque-btn delete-btn" data-action="delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>鍒犻櫎</button></div></div>'}).join("");Dy.innerHTML=l,n&&(n.style.display="flex",s&&(s.textContent=Vy+" / "+r),a&&(a.disabled=1===Vy),o&&(o.disabled=Vy===r)),Dy.querySelectorAll(".memory-cheque-card").forEach(function(e){var t=e.dataset.chequeId,n=e.querySelector('[data-action="edit"]'),a=e.querySelector('[data-action="toggle"]'),o=e.querySelector('[data-action="delete"]');n&&n.addEventListener("click",function(){!async function(e){var t=Dy.querySelector('.memory-cheque-card[data-cheque-id="'+e+'"]');if(t){var n=t.querySelector(".memory-cheque-content");if(n&&!n.querySelector("textarea")){var a=n.innerText,o=await Kl.loadData("memoryCheques",Sc.id),s=o&&o.value?o.value:[],i=s.find(function(t){return t.id===e});i&&(a=i.editedContent||i.content);var r='<textarea class="memory-inline-edit-textarea">'+a+'</textarea><div class="memory-inline-edit-actions"><button class="memory-edit-cancel-btn">鍙栨秷</button><button class="memory-edit-confirm-btn">淇濆瓨</button></div>';n.innerHTML=r;var l=n.querySelector("textarea"),c=n.querySelector(".memory-edit-cancel-btn"),d=n.querySelector(".memory-edit-confirm-btn");l.focus(),c.addEventListener("click",function(e){e.stopPropagation(),n.textContent=a}),d.addEventListener("click",async function(e){e.stopPropagation();var t=l.value.trim();t?i&&(i.editedContent=t,await Kl.saveData("memoryCheques",Sc.id,s),qy("宸蹭繚瀛樹慨鏀?),n.textContent=t):qy("鍐呭涓嶈兘涓虹┖")})}}}(t)}),a&&a.addEventListener("click",function(){!async function(e){var t=await Kl.loadData("memoryCheques",Sc.id),n=t&&t.value?t.value:[],a=n.find(function(t){return t.id===e});a&&(a.isEnabled=!a.isEnabled,await Kl.saveData("memoryCheques",Sc.id,n),await Jy())}(t)}),o&&o.addEventListener("click",function(){!async function(e){if(confirm("纭畾瑕佸垹闄よ繖涓蹇嗘敮绁ㄥ悧?")){var t=await Kl.loadData("memoryCheques",Sc.id),n=t&&t.value?t.value:[];n=n.filter(function(t){return t.id!==e}),await Kl.saveData("memoryCheques",Sc.id,n),await Jy()}}(t)})}),function(){var e=document.getElementById("memory-prev-cheque"),t=document.getElementById("memory-next-cheque");e&&(e.onclick=function(){Vy>1&&(Vy--,Jy())});t&&(t.onclick=function(){Kl.loadData("memoryCheques",Sc.id).then(function(e){var t=e&&e.value?e.value:[];Vy<t.length&&(Vy++,Jy())})})}()}catch(e){console.error("鍔犺浇璁板繂鏀エ澶辫触:",e)}}function Yy(){var e=document.getElementById("peeping-modal");if(e){e.classList.remove("active");var t=document.getElementById("peeping-timeline");t&&(t.innerHTML="")}}async function Ky(){var e=document.getElementById("peeping-start-btn");if(!e.classList.contains("loading")){e.classList.add("loading");try{if(!Sc)throw new Error("鏈€夋嫨鑱旂郴浜?);var t=await Kl.loadData("settingsStore","apiSettings");if(!t||!t.value||!t.value.key)throw new Error("璇峰厛閰嶇疆API Key");var n=Sc.history.slice(-100).map(function(e){return("user"===e.sender?Sc.user.name:Sc.ai.name)+": "+(e.text||"(闈炴枃鏈秷鎭?")}).join("\n"),a=Sc.ai.persona||Sc.ai.description||"鏃犺瀹?,o=Sc.user.persona||"鏃犺瀹?;let e="";if("function"==typeof window.getEnabledMemories)try{const t=await window.getEnabledMemories(Sc.id);t&&t.length>0&&(e=t.map(e=>`[璁板繂] ${e.content}`).join("\n"))}catch(e){console.warn("鑾峰彇璁板繂澶辫触:",e)}let u="";try{const e=await Kl.loadData("worldBooks","allWorldBooks"),t=e&&Array.isArray(e.value)?e.value:[];let n=new Set;if(Sc.linkedWorldBookIds&&Sc.linkedWorldBookIds.length>0)Sc.linkedWorldBookIds.forEach(e=>n.add(e));else if(Sc.linkedWorldBookGroupIds&&Sc.linkedWorldBookGroupIds.length>0){const e=await Kl.loadData("worldBookGroups","allGroups");if(e&&e.value){e.value.filter(e=>Sc.linkedWorldBookGroupIds.includes(e.id)).forEach(e=>{e.books&&e.books.forEach(e=>n.add(e)),e.bookIds&&e.bookIds.forEach(e=>n.add(e))})}}if(n.size>0){let e=t.filter(e=>n.has(e.id)).map(e=>`銆愯瀹氾細${e.name}銆慭n${e.content}`).join("\n\n");e.length>2e3&&(e=e.slice(0,2e3)+"...(鐣?"),u=e}}catch(e){console.warn("涓栫晫涔﹀姞杞藉け璐?",e)}var s=`\n浣犳槸涓€涓瀬鍏锋礊瀵熷姏鐨勬晠浜嬪彊杩拌€呫€傝鏍规嵁浠ヤ笅瑙掕壊鐨勮儗鏅瀹氥€佷笘鐣岃鑳屾櫙銆佽蹇嗗拰鏈€杩戠殑瀵硅瘽璁板綍锛岀敓鎴愯瑙掕壊锛圓I锛変粖澶╃殑鐢熸椿韪抗銆俓n鎴戜滑闇€瑕佷互鏃堕棿杞寸殑褰㈠紡锛屽睍绀鸿鑹插湪浠婂ぉ鍙戠敓鐨勫叧閿簨浠躲€佹墍澶勪綅缃€佸唴蹇冩椿鍔ㄤ互鍙婃秷璐规儏鍐点€俓n\n銆愯鑹茶瀹氥€慭nAI浜鸿锛?{a}\n鐢ㄦ埛浜鸿锛?{o}\n\n銆愪笘鐣岃鑳屾櫙銆慭n${u||"鏃犵壒娈婁笘鐣岃璁惧畾锛岄粯璁や负鐜颁唬鏃ュ父銆?}\n\n銆愬叧閿蹇嗐€慭n${e||"鏃犵壒娈婅蹇嗐€?}\n\n銆愭渶杩戝璇濄€慭n${n}\n\n銆愮敓鎴愯姹傘€慭n1. 鐢熸垚 4-6 涓叿浣撶殑鈥滆釜杩瑰崱鐗団€濓紝姣忎釜鍗＄墖浠ｈ〃涓€涓椂闂寸偣銆俓n2. 姣忎釜鍗＄墖鍖呭惈锛歕n   - time: 鏃堕棿鐐?(濡?08:30)\n   - location: 鍦扮偣 (濡?鍜栧暋棣?\n   - event: 绠€鐭弿杩板彂鐢熺殑浜嬩欢 (蹇呴』绗﹀悎涓栫晫瑙傚拰浜鸿)\n   - spending: 娑堣垂閲戦鍙婄墿鍝?(濡傛灉娌℃湁娑堣垂濉?"鏃?)\n   - thought: 瑙掕壊鐨勫唴蹇冪嫭鐧?(绗﹀悎浜鸿)\n   - mood: 蹇冩儏 emoji\n3. 璇蜂弗鏍艰繑鍥炴湁鏁堢殑 JSON 鏁扮粍瀛楃涓诧紝涓嶈鍖呭惈浠讳綍 markdown 鏍囪 (濡?\`\`\`json)銆傛牸寮忓涓嬶細\n[{"time":"09:00","location":"鍗у","event":"閱掓潵...","spending":"鏃?,"thought":"...","mood":"鈽€锔?}]\n`,i=t.value.url;i.endsWith("/")&&(i=i.slice(0,-1)),i+="/chat/completions";var r=t.value.model||"gpt-3.5-turbo",l=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t.value.key},body:JSON.stringify({model:r,messages:[{role:"user",content:s}],temperature:.85})});if(!l.ok)throw new Error("API Request Failed: "+l.status);var c,d=(await l.json()).choices[0].message.content.trim();d=d.replace(/^```json/,"").replace(/^```/,"").replace(/```$/,"").trim();try{c=JSON.parse(d)}catch(e){throw console.error("JSON Error",d),new Error("鐢熸垚鍐呭鏍煎紡鏈夎锛岃閲嶈瘯")}!function(e){var t=document.getElementById("peeping-timeline");if(t.innerHTML="",!Array.isArray(e))return void alert("鏁版嵁鏍煎紡閿欒");var n={location:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',spending:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',thought:'<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'};e.forEach(function(e,a){var o=document.createElement("div");o.className="peeping-card",o.style.animationDelay=.15*a+"s";var s=e.spending&&"鏃?!==e.spending?`<div class="peeping-spending">${n.spending} <span>${e.spending}</span></div>`:"";o.innerHTML=`\n                <div class="peeping-card-header">\n                    <div class="peeping-location">${n.location} <span>${e.location}</span></div>\n                    <div class="peeping-time">${e.time}</div>\n                </div>\n                <div class="peeping-card-body">\n                    ${e.event}\n                </div>\n                ${s}\n                <div class="peeping-inner-thought">\n                    <div class="peeping-thought-icon">${n.thought}</div>\n                    <div class="peeping-thought-text">鈥?{e.thought}鈥?${e.mood||""}</div>\n                </div>\n            `,t.appendChild(o)}),document.querySelector(".peeping-intro").style.display="none",t.style.display="flex"}(c)}catch(e){console.error(e),alert("鐢熸垚澶辫触: "+e.message)}finally{e.classList.remove("loading")}}}window.getEnabledMemories=async function(e){var t=await Kl.loadData("memoryCheques",e);return(t&&t.value?t.value:[]).filter(function(e){return e.isEnabled})},Ty&&(Ty.value="浣犳槸涓€浣嶄笓涓氱殑璁板繂鏁寸悊甯?鎿呴暱浠庡璇濅腑鎻愬彇鍏抽敭淇℃伅銆佹儏鎰熻剦缁滃拰閲嶈缁嗚妭銆俓n\n璇蜂粩缁嗛槄璇讳互涓嬭亰澶╄褰?骞惰繘琛屾繁搴︽€荤粨:\n\n銆愭€荤粨瑕佹眰銆慭n1. **鏍稿績浜嬩欢**: 璇︾粏璁板綍瀵硅瘽涓彂鐢熺殑閲嶈浜嬩欢銆佹椿鍔ㄦ垨璇濋,鍖呮嫭鏃堕棿銆佸湴鐐广€佷汉鐗╃瓑鍏抽敭瑕佺礌\n2. **鎯呮劅鍙樺寲**: 鎹曟崏鍙屾柟鐨勬儏缁捣浼忋€佹€佸害杞彉銆佷翰瀵嗗害鍙樺寲\n3. **鍏抽敭淇℃伅**: 璁板綍閲嶈鐨勬壙璇恒€佺害瀹氥€佸亸濂姐€佷範鎯€佷釜浜轰俊鎭瓑\n4. **瀵硅瘽鐗硅壊**: 娉ㄦ剰鍙屾柟鐨勮璇濋鏍笺€佸父鐢ㄨ瘝姹囥€佹樀绉般€佹绛変釜鎬у寲鍐呭\n5. **鍏崇郴鍙戝睍**: 鍒嗘瀽鍙屾柟鍏崇郴鐨勮繘灞曞拰浜掑姩妯″紡\n\n銆愯緭鍑烘牸寮忋€慭n- 浣跨敤鍙欎簨鎬ц瑷€,鍍忓啓鏃ヨ涓€鏍疯褰昞n- 淇濈暀鍏蜂綋缁嗚妭鍜岀敓鍔ㄦ弿杩癨n- 瀛楁暟鎺у埗鍦?100-250 瀛梊n- 鍒嗘鍛堢幇,渚夸簬闃呰\n\n鑱婂ぉ璁板綍:\n{CHAT_HISTORY}\n\n璇峰紑濮嬫€荤粨:"),wy&&wy.addEventListener("click",Py),Ey&&Ey.addEventListener("click",Hy),Iy&&Iy.addEventListener("click",Hy),xy.forEach(function(e){e.addEventListener("click",function(){Oy(e.dataset.tab)})}),Ay&&Ay.addEventListener("click",_y),Gy=document.getElementById("peeping-feature"),Wy=document.getElementById("peeping-modal"),jy=Wy?Wy.querySelector(".peeping-close-btn"):null,Uy=document.getElementById("peeping-start-btn"),zy=Wy?Wy.querySelector(".peeping-overlay"):null,Gy&&Gy.addEventListener("click",function(){!function(){var e=document.getElementById("peeping-modal");if(e){e.classList.remove("hidden"),e.offsetWidth,e.classList.add("active"),document.querySelector(".peeping-intro").style.display="flex";var t=document.getElementById("peeping-timeline");t.style.display="none",t.innerHTML=""}}()}),jy&&jy.addEventListener("click",Yy),zy&&zy.addEventListener("click",Yy),Uy&&Uy.addEventListener("click",Ky);const Zy=document.getElementById("minimax-group-id"),Xy=document.getElementById("minimax-api-key"),Qy=document.getElementById("minimax-model-select"),eh=document.getElementById("fetch-minimax-models-btn"),th=document.getElementById("fetch-models-status"),nh=document.getElementById("test-tts-button"),ah=document.getElementById("tts-test-status");let oh=null,sh=null;async function ih(){if(!Kl||!Kl.db)throw new Error("鏁版嵁搴撴湭鍒濆鍖?);const e={groupId:Zy?.value||"",apiKey:Xy?.value||"",modelId:Qy?.value||"speech-2.6-turbo"};await Kl.saveData("settingsStore","minimaxTTSConfig",e),console.log("[MiniMax] 閰嶇疆宸蹭繚瀛?,e)}const rh={dbName:"MinimaxTTSCache",storeName:"audio_cache",_db:null,async getDB(){return this._db?this._db:new Promise((e,t)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName)},n.onsuccess=t=>{this._db=t.target.result,e(this._db)},n.onerror=e=>t(e.target.error)})},async get(e){try{const t=await this.getDB();return new Promise((n,a)=>{const o=t.transaction(this.storeName,"readonly").objectStore(this.storeName).get(e);o.onsuccess=()=>n(o.result),o.onerror=()=>a(o.error)})}catch(e){return null}},async put(e,t){try{const n=await this.getDB();return new Promise((a,o)=>{const s=n.transaction(this.storeName,"readwrite");s.objectStore(this.storeName).put(t,e),s.oncomplete=()=>a(),s.onerror=()=>o()})}catch(e){}},genKey(e,t,n){let a=0;if(!e)return"empty";for(let t=0;t<e.length;t++)a=(a<<5)-a+e.charCodeAt(t),a|=0;return`${t||"def"}_${n||"auto"}_${e.substring(0,20).replace(/[^\w\u4e00-\u9fa5]/g,"_")}_${a}`},async clear(){try{const e=await this.getDB();return new Promise((t,n)=>{const a=e.transaction(this.storeName,"readwrite");a.objectStore(this.storeName).clear(),a.oncomplete=()=>{console.log("[TTSCache] 缂撳瓨宸叉竻绌?),t()},a.onerror=()=>n()})}catch(e){console.warn("[TTSCache] 娓呯┖澶辫触",e)}},async cleanup(e=10){try{const t=await this.getDB(),n=t.transaction(this.storeName,"readwrite").objectStore(this.storeName),a=await new Promise((e,t)=>{const a=n.getAllKeys();a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)});if(a.length>e){const t=a.slice(0,a.length-e);for(const e of t)n.delete(e);console.log(`[TTSCache] 娓呯悊浜?${t.length} 鏉℃棫缂撳瓨`)}}catch(e){console.warn("[TTSCache] 娓呯悊澶辫触",e)}}};async function lh(e,t,n){try{if(!e)return!1;e=e.trim().replace(/[\r\n]+/g," "),oh&&(oh.pause(),oh=null),sh&&(URL.revokeObjectURL(sh),sh=null);const a=rh.genKey(e,t,n);let o,s=await rh.get(a);if(!!s?console.log("[Minimax TTS] 馃殌 鍛戒腑缂撳瓨锛岀渷閽变簡锛?):(console.log("[Minimax TTS] 馃挩 鏈懡涓紦瀛橈紝璋冪敤API..."),s=await async function(e,t,n){if(e&&(e=e.trim().replace(/[\r\n]+/g," ")),!Kl||!Kl.db)throw new Error("鏁版嵁搴撴湭鍒濆鍖?);const a=await Kl.loadData("settingsStore","minimaxTTSConfig");if(!(a&&a.value&&a.value.groupId&&a.value.apiKey))throw new Error("MiniMax閰嶇疆鏈畬鎴?);const{groupId:o,apiKey:s,modelId:i}=a.value;let r=i||"speech-2.6-turbo";const l=r.includes("speech-01"),c=l?"t2a_pro":"t2a_v2",d=`https://api.minimax.chat/v1/${c}?GroupId=${o}`;let u;if(console.log(`[Minimax] 浣跨敤鎺ュ彛: ${c} (妯″瀷: ${r})`),"speech-01"===r&&(r="speech-01-turbo"),"speech-02"===r&&(r="speech-02-turbo"),"speech-2.6"===r&&(r="speech-2.6-turbo"),l)u={model:r,text:e,voice_id:t||"female-shaonv",speed:1,vol:1,pitch:0,audio_sample_rate:32e3,bitrate:128e3,format:"mp3"};else{const a={"zh-CN":"Chinese","zh-HK":"Chinese,Yue","en-US":"English","ja-JP":"Japanese","ko-KR":"Korean","de-DE":"German","fr-FR":"French","es-ES":"Spanish","pt-BR":"Portuguese","ru-RU":"Russian","tr-TR":"Turkish","nl-NL":"Dutch","it-IT":"Italian","vi-VN":"Vietnamese","id-ID":"Indonesian","th-TH":"Thai","ms-MY":"Malay","ar-SA":"Arabic","hi-IN":"Hindi","pl-PL":"Polish","sv-SE":"Swedish","fi-FI":"Finnish","da-DK":"Danish"};u={model:r,text:e,stream:!1,language_boost:n&&a[n]?a[n]:"auto",voice_setting:{voice_id:t||"female-shaonv",speed:1,vol:1,pitch:0},audio_setting:{format:"mp3",sample_rate:32e3,bitrate:128e3,channel:1}}}const m={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(u)},p=await fetch(d,m);if(!p.ok){const e=await p.text();throw new Error(`TTS API璇锋眰澶辫触: ${p.status} - ${e}`)}const g=await p.json();if(console.log("[MiniMax TTS] API鍝嶅簲鏁版嵁:",g),g.base_resp&&0!==g.base_resp.status_code)throw new Error(`MiniMax API閿欒: [${g.base_resp.status_code}] ${g.base_resp.status_msg}`);let y=null;if(g.data&&g.data.audio?y=g.data.audio:g.audio_file?y=g.audio_file:g.extra_info&&g.extra_info.audio_file&&(y=g.extra_info.audio_file),!y)throw new Error("API杩斿洖姝ｅ父浣嗘湭鎵惧埌闊抽鏁版嵁(audio/audio_file)");if(/^[0-9a-fA-F]+$/.test(y))try{const e=y.match(/.{1,2}/g);if(e){const t=new Uint8Array(e.map(e=>parseInt(e,16)));let n="";const a=t.byteLength;for(let e=0;e<a;e++)n+=String.fromCharCode(t[e]);return window.btoa(n)}}catch(e){console.warn("[MiniMax TTS] Hex杞崲澶辫触锛屽皾璇曠洿鎺ヤ綔涓築ase64浣跨敤",e)}return y}(e,t,n),s&&rh.put(a,s).catch(e=>console.warn("Cache put failed",e))),!s)return!1;if("string"==typeof s&&s.startsWith("http"))o=s,sh=null;else{const e=lg(s,"audio/mpeg");o=URL.createObjectURL(e),sh=o}return oh=new Audio(o),oh.play().catch(e=>console.error("Audio play error:",e)),oh.onended=()=>{sh&&(URL.revokeObjectURL(sh),sh=null),oh=null},!0}catch(e){throw console.error("[MiniMax TTS] 鎾斁澶辫触",e),e}}function lg(e,t){const n=atob(e),a=new Array(n.length);for(let e=0;e<n.length;e++)a[e]=n.charCodeAt(e);const o=new Uint8Array(a);return new Blob([o],{type:t})}window.TTSCache=rh,eh&&eh.addEventListener("click",async()=>{if(Zy.value&&Xy.value){th.textContent="鍔犺浇涓?..",th.style.color="#007aff";try{await ih();const e=await async function(){if(!Kl||!Kl.db)throw new Error("鏁版嵁搴撴湭鍒濆鍖栵紝璇峰厛閰嶇疆MiniMax");const e=await Kl.loadData("settingsStore","minimaxTTSConfig");if(!(e&&e.value&&e.value.groupId&&e.value.apiKey))throw new Error("MiniMax閰嶇疆鏈畬鎴?);const{groupId:t,apiKey:n}=e.value;return console.log("[MiniMax] 浣跨敤閰嶇疆:",{groupId:t.substring(0,10)+"...",apiKey:"***"}),[{id:"speech-2.6-hd",name:"Speech-2.6 HD (The Best)"},{id:"speech-2.6-turbo",name:"Speech-2.6 Turbo (Fastest)"},{id:"speech-02-hd",name:"Speech-02 HD (High Quality)"},{id:"speech-02-turbo",name:"Speech-02 Turbo (Balanced)"},{id:"speech-01-hd",name:"Speech-01 HD (Legacy)"},{id:"speech-01-turbo",name:"Speech-01 Turbo (Legacy)"}]}();Qy.innerHTML='<option value="">璇烽€夋嫨妯″瀷</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name||e.id,Qy.appendChild(t)}),await ih(),th.textContent="鉁?鎴愬姛",th.style.color="#34c759",setTimeout(()=>{th.textContent=""},3e3)}catch(e){th.textContent="鉁?澶辫触",th.style.color="#ff3b30",alert("鎷夊彇妯″瀷鍒楄〃澶辫触: "+e.message),setTimeout(()=>{th.textContent=""},3e3)}}else alert("璇峰厛濉啓 MiniMax Group ID 鍜?API Key")}),nh&&nh.addEventListener("click",async()=>{if(Zy.value&&Xy.value){ah.textContent="娴嬭瘯涓?..",ah.style.color="#007aff";try{await ih(),await lh("涔濓紝琛～鐨勪环鏍兼槸锛屼節纾呭崄浜斾究澹€?,"female-shaonv"),ah.textContent="鉁?鎴愬姛",ah.style.color="#34c759",setTimeout(()=>{ah.textContent=""},3e3)}catch(e){ah.textContent="鉁?澶辫触",ah.style.color="#ff3b30",alert("娴嬭瘯澶辫触: "+e.message),setTimeout(()=>{ah.textContent=""},3e3)}}else alert("璇峰厛濉啓 MiniMax Group ID 鍜?API Key")}),Qy&&Qy.addEventListener("change",async()=>{try{await ih(),console.log("[MiniMax] 妯″瀷宸插垏鎹㈠苟淇濆瓨:",Qy.value)}catch(e){console.error("[MiniMax] 淇濆瓨妯″瀷閫夋嫨澶辫触:",e)}}),Zy&&Zy.addEventListener("blur",async()=>{try{await ih(),console.log("[MiniMax] GroupID 宸蹭繚瀛?)}catch(e){console.error("[MiniMax] 淇濆瓨 GroupID 澶辫触:",e)}}),Xy&&Xy.addEventListener("blur",async()=>{try{await ih(),console.log("[MiniMax] API Key 宸蹭繚瀛?)}catch(e){console.error("[MiniMax] 淇濆瓨 API Key 澶辫触:",e)}});const ch=document.getElementById("save-all-settings-btn");ch&&ch.addEventListener("click",async()=>{await ih()}),setTimeout(async()=>{try{Kl&&Kl.db?await async function(){if(Kl&&Kl.db)try{const e=await Kl.loadData("settingsStore","minimaxTTSConfig");e&&e.value&&(Zy&&(Zy.value=e.value.groupId||""),Xy&&(Xy.value=e.value.apiKey||""),Qy&&(Qy.value=e.value.modelId||"speech-2.6-turbo"),console.log("[MiniMax] 宸插姞杞介厤缃紝褰撳墠妯″瀷:",e.value.modelId||"speech-2.6-turbo"))}catch(e){console.error("[MiniMax] 鍔犺浇閰嶇疆澶辫触",e)}else console.warn("[MiniMax] 鏁版嵁搴撴湭鍒濆鍖?)}():debugWarn("[MiniMax] 鏁版嵁搴撴湭鍒濆鍖栵紝璺宠繃閰嶇疆鍔犺浇")}catch(e){console.error("[MiniMax] 鍔犺浇閰嶇疆澶辫触",e)}},500);const dh=document.getElementById("chat-settings-modal");if(dh){let dv=dh.querySelector("#tts-voice-setting-group");if(!dv){const uv=dh.querySelector(".modal-body");if(uv){dv=document.createElement("div"),dv.id="tts-voice-setting-group",dv.className="form-group",dv.innerHTML='\n                    <label>TTS 闊宠壊ID (MiniMax)</label>\n                    <input type="text" id="contact-tts-voice-input" class="form-input" placeholder="渚嬪: female-shaonv">\n                    <small style="color: #666; margin-top: 5px; display: block;">\n                        鐣欑┖鍒欎笉浣跨敤璇煶鍚堟垚銆傚父鐢ㄩ煶鑹睮D锛?br>\n                        female-shaonv (灏戝コ), female-yujie (寰″), male-qn-jingying (绮捐嫳闈掑勾)\n                    </small>\n                ',uv.appendChild(dv);const mv=dv.querySelector("#contact-tts-voice-input");mv&&(mv.addEventListener("input",()=>{Sc&&(Sc.ttsVoiceId=mv.value.trim())}),mv.addEventListener("blur",async()=>{if(!Sc)return;const e=mv.value.trim();try{const t=await Kl.loadData("messageContacts","allContacts");let n=t&&Array.isArray(t.value)?t.value:[];const a=n.findIndex(e=>e.id===Sc.id);-1!==a&&(n[a].ttsVoiceId=e,await Kl.saveData("messageContacts","allContacts",n),console.log("[MiniMax] 闊宠壊ID宸插己鍒朵繚瀛樺埌鏁版嵁搴?",e))}catch(e){console.error("[MiniMax] 闊宠壊ID淇濆瓨澶辫触:",e)}}))}}window._ttsSettingsObserver||(window._ttsSettingsObserver=new MutationObserver(e=>{e.forEach(e=>{if("attributes"===e.type&&("style"===e.attributeName||"class"===e.attributeName)){if("none"!==window.getComputedStyle(dh).display&&Sc){const e=document.getElementById("contact-tts-voice-input");e&&(debugLog("[MiniMax] 璁剧疆寮圭獥宸叉墦寮€锛屽洖鏄鹃煶鑹睮D:",Sc.ttsVoiceId),e.value=Sc.ttsVoiceId||"")}}})}),window._ttsSettingsObserver.observe(dh,{attributes:!0}))}if(document.getElementById("save-contact-btn")){const pv=window.saveContact||function(){};window.saveContact=async function(){const e=document.getElementById("contact-tts-voice-input");e&&Sc&&(Sc.ttsVoiceId=e.value.trim()),await pv()}}const uh=window.loadContactSettings||function(){};window.loadContactSettings=function(e){uh(e),voiceInput&&e&&(voiceInput.value=e.ttsVoiceId||""),"function"==typeof window.applyChatBackground&&window.applyChatBackground(e.backgroundImage)},document.body.addEventListener("click",async e=>{const t=e.target.closest('[data-action="play-tts"], .voice-play-button, .play-voice-btn, .voice-audio-bubble, .clickable-voice-bubble');if(!t)return;if(e.target.isContentEditable||e.target.closest('[contenteditable="true"]'))return;if(e.target.closest(".voice-collapse-btn"))return;if(e.target.closest(".msg-action-menu, .action-button, .menu-item"))return;const n=Date.now();if(n-(t._lastTTSClickTime||0)<300)return;t._lastTTSClickTime=n;const a=t.closest(".message-row");if(!a)return void console.warn("[TTS Click] 鏈壘鍒?messageRow");let o="",s=a.querySelector(".voice-transcript")||a.querySelector(".voice-text-panel");if(!s){let e=t.nextElementSibling;if(e&&(e.classList.contains("voice-transcript")||e.classList.contains("voice-text-panel"))&&(s=e),!s){const n=t.parentElement;n&&(e=n.nextElementSibling,e&&(e.classList.contains("voice-transcript")||e.classList.contains("voice-text-panel"))&&(s=e))}}function i(e,t){const n=document.createElement("button");n.className="voice-collapse-btn",n.innerHTML="鈻?;const a=t?"left: 3px;":"right: 3px;";return n.style.cssText=`\n                    position: absolute;\n                    top: 2px;\n                    ${a}\n                    background: rgba(239, 239, 239, 0.8);\n                    border: none;\n                    border-radius: 4px;\n                    width: 20px;\n                    height: 20px;\n                    cursor: pointer;\n                    font-size: 10px;\n                    line-height: 1;\n                    color: #333;\n                    transition: all 0.2s;\n                    z-index: 10;\n                `,n.addEventListener("click",function(t){t.stopPropagation(),e.style.cssText="display: none !important;",e.classList.remove("visible","fade-in"),n.remove()}),n.addEventListener("mouseenter",function(){n.style.background="rgba(0, 0, 0, 0.2)",n.style.color="#333"}),n.addEventListener("mouseleave",function(){n.style.background="rgba(0, 0, 0, 0.1)",n.style.color="#666"}),n}if(t.classList.contains("user-bubble")){if(s&&!s.querySelector(".voice-collapse-btn")){const e=s.closest(".voice-message-wrapper");e&&(e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="flex-end",e.style.gap="4px"),s.style.cssText="display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 8px 8px 26px !important; background: rgba(0, 0, 0, 0.05) !important; border-radius: 8px !important;",s.classList.add("visible","fade-in");const t=i(s,!0);s.appendChild(t)}return}if(s){const e=s.querySelector(".voice-collapse-btn"),t=s.closest(".voice-message-wrapper");if(t&&(t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="flex-start",t.style.gap="4px"),s.style.cssText="display: block !important; opacity: 1 !important; visibility: visible !important; height: auto !important; margin-top: 0 !important; position: relative !important; padding: 8px 26px 8px 8px !important; background: rgba(0, 0, 0, 0.05) !important;backdrop-filter:blur(10px); border-radius: 8px !important;",s.classList.add("visible","fade-in"),!e){const e=i(s,!1);s.appendChild(e)}o=s.innerText?.trim()}if(!o)return void console.warn("[MiniMax TTS] 鏃犳硶鑾峰彇娑堟伅鏂囨湰");if(!Kl||!Kl.db)return void console.warn("[MiniMax TTS] 鏁版嵁搴撴湭鍒濆鍖?);const r=await Kl.loadData("settingsStore","minimaxTTSConfig").catch(e=>null);if(!(r&&r.value&&r.value.groupId&&r.value.apiKey))return void console.warn("[MiniMax TTS] 鏈厤缃紝璺宠繃鎾斁");const l=Sc?.ttsVoiceId||"female-shaonv",c=Sc?.ttsLanguage;console.log("[MiniMax TTS] 浣跨敤闊宠壊:",l,"璇█:",c);try{t.style.opacity="0.5",await lh(o,l,c),t.style.opacity="1"}catch(e){t.style.opacity="1",console.error("[MiniMax TTS] 鎾斁澶辫触",e),alert("鎾斁鍑洪敊: "+e.message)}},!0);document.getElementById("chat-bg-input");const mh=document.getElementById("chat-bg-preview"),ph=document.getElementById("chat-bg-placeholder");document.getElementById("clear-chat-bg-btn"),document.querySelector(".group-background-section .avatar-uploader");function gh(e){e?(mh.src=e,mh.style.display="block",ph.style.display="none"):(mh.src="",mh.style.display="none",ph.style.display="flex")}window.applyChatBackground=function(e){const t=document.getElementById("chat-messages-container");e?(t.style.backgroundImage=`url('${e}')`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.backgroundRepeat="no-repeat"):t.style.backgroundImage=""},window.loadChatBackgroundSettings=function(){let e=null;void 0!==Je&&Je?e=Je.chatBackground||Je.backgroundImage:void 0!==Sc&&Sc&&(e=Sc.chatBackground||Sc.backgroundImage),gh(e)};var yh={pages:[],currentPage:0,styles:[],activeStyleId:null,isGenerating:!1},hh=document.getElementById("meetu-feature"),vh=document.getElementById("meetu-screen"),fh=document.getElementById("meetu-back-button"),wh=document.getElementById("meetu-active-page"),bh=document.getElementById("meetu-prev-page"),Eh=document.getElementById("meetu-next-page"),Ih=document.getElementById("meetu-page-indicator"),xh=document.getElementById("meetu-reroll-btn"),kh=document.getElementById("meetu-continue-btn"),Lh=document.getElementById("meetu-export-btn"),Bh=document.getElementById("meetu-style-btn"),Sh=(document.getElementById("meetu-book-animation"),document.getElementById("meetu-style-modal")),Ch=document.getElementById("meetu-style-close-btn"),$h=document.getElementById("meetu-add-style-btn"),Mh=document.getElementById("meetu-style-list"),Th=document.getElementById("meetu-style-editor-modal"),Ah=document.getElementById("meetu-editor-close-btn"),Dh=document.getElementById("meetu-style-name"),Ph=document.getElementById("meetu-style-prompt"),Hh=document.getElementById("meetu-save-style-btn"),Oh=null,qh=document.getElementById("meetu-continue-modal"),Nh=document.getElementById("meetu-continue-input"),Fh=document.getElementById("meetu-continue-close-btn"),_h=document.getElementById("meetu-confirm-continue-btn"),Rh={id:"default_style",name:"榛樿绗旈",desc:"绗笁浜虹О锛岀瑪瑙︾粏鑵伙紝渚ч噸蹇冪悊鎻忓啓",prompt:"璇蜂娇鐢ㄧ涓変汉绉帮紝浠ョ粏鑵讳紭缇庣殑绗旇Е杩涜鎻忓啓銆傞噸鐐瑰埢鐢昏鑹茬殑蹇冪悊娲诲姩銆佸井琛ㄦ儏鍜岀幆澧冩皼鍥淬€傞伩鍏嶈繃浜庣洿鐧界殑瀵硅瘽鍫嗙爩锛屽鐢ㄤ晶闈㈡弿鍐欍€?,isDefault:!0};async function Gh(){console.log("[Meetu] openMeetu called"),Sc?(vh?(vh.style.position="fixed",vh.style.top="0",vh.style.left="0",vh.style.width="100%",vh.style.height="100%",vh.style.zIndex="9999",vh.style.display="flex",vh.style.visibility="visible",vh.style.opacity="1",vh.style.backgroundColor="#f4ecd8",vh.classList.add("visible"),console.log("[Meetu] Screen forced visible with inline styles")):console.error("[Meetu] Screen element missing!"),yh.pages=[],yh.currentPage=0,Kh(),Yh("new")):qy("璇峰厛閫夋嫨涓€涓仈绯讳汉")}function Wh(){yh.pages.length>0&&(confirm("鏄惁灏嗘湰娆℃櫎闈㈠唴瀹规€荤粨涓鸿蹇嗘敮绁紵")&&async function(){var e=yh.pages.join("\n");qy("姝ｅ湪鍚庡彴鎬荤粨璁板繂...");try{var t=(await Kl.loadData("settingsStore","apiSettings")).value.model||"gpt-3.5-turbo",n="璇锋€荤粨浠ヤ笅鎴戜滑鍦ㄧ嚎涓嬬殑浜掑姩鍐呭锛屾彁鍙栧叧閿簨浠跺拰鎯呮劅鍙樺寲锛岀畝瑕佹鎷細\n{CHAT_HISTORY}",a=await async function(e,t,n){var a=n.replace("{CHAT_HISTORY}",e),o=await Kl.loadData("settingsStore","apiSettings"),s=o.value.url;s.endsWith("/")&&(s=s.slice(0,-1));s+="/chat/completions";var i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+o.value.key},body:JSON.stringify({model:t,messages:[{role:"user",content:a}],temperature:.8})});return(await i.json()).choices[0].message.content.trim()}(e,t,n);a&&(await Ry("銆愭櫎闈㈡€荤粨銆?+a,1),qy("宸茬敓鎴愯蹇嗘敮绁?))}catch(e){console.error(e),qy("璁板繂鎬荤粨澶辫触")}}());vh&&(vh.style.cssText="",vh.style.display="none",vh.classList.remove("visible")),void 0!==wh&&wh&&(wh.innerHTML="")}const jh="meetuStyles_backup";async function Uh(e){var t=e||yh.styles;console.log("[Meetu] Saving styles...",t.length);try{localStorage.setItem(jh,JSON.stringify(t))}catch(e){console.error("[Meetu] LS Save failed",e)}try{await Kl.saveData("settingsStore","meetuStyles",t)}catch(e){console.error("[Meetu] DB Save failed",e)}}function zh(){Mh.innerHTML="",yh.styles.forEach(function(e){var t=document.createElement("div");t.className="playlist-item";var n=document.createElement("div");n.className="style-card-content",n.innerHTML='<div class="style-card-title">'+e.name+'</div><div class="style-card-desc">'+(e.desc||"鏃犳弿杩?)+"</div>";var a=document.createElement("div");a.className="card-actions";if(!e.isDefault){var o=document.createElement("button");o.className="action-circle edit-btn",o.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',o.onclick=function(t){t.stopPropagation(),Vh(e)},a.appendChild(o);var s=document.createElement("button");s.className="action-circle delete-btn",s.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',s.onclick=function(t){t.stopPropagation(),function(e){if(!confirm("纭畾鍒犻櫎姝ょ瑪椋?"))return;yh.styles=yh.styles.filter(function(t){return t.id!==e}),Uh(),zh()}(e.id)},a.appendChild(s)}var i=document.createElement("button");i.className="action-circle toggle-btn "+(e.active?"active":""),i.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',i.onclick=function(t){t.stopPropagation(),function(e,t){console.log("[DEBUG_MEETU] Toggling style:",e,"to",t);var n=yh.styles.find(function(t){return t.id===e});n?(n.active=t,zh(),Uh()):console.error("[DEBUG_MEETU] Style not found for toggle:",e)}(e.id,!e.active)},a.appendChild(i),t.appendChild(n),t.appendChild(a),Mh.appendChild(t)})}function Vh(e){Oh=(e=e||null)?e.id:null,Dh.value=e?e.name:"",Ph.value=e?e.prompt:"",document.getElementById("meetu-editor-title").textContent=e?"缂栬緫绗旈":"鏂板缓绗旈",document.body.appendChild(Th),Th.style.zIndex="2147483647",Th.style.display="flex",Th.offsetWidth,Th.style.opacity="1",Th.classList.add("visible"),Th.classList.add("active")}async function Jh(){var e=Dh.value.trim(),t=Ph.value.trim();if(e&&t){if(Oh){var n=yh.styles.find(function(e){return e.id===Oh});n&&(n.name=e,n.prompt=t,n.desc=t.substring(0,20)+"...")}else yh.styles.push({id:"style_"+Date.now(),name:e,prompt:t,desc:t.substring(0,20)+"...",active:!1,isDefault:!1});console.log("[DEBUG_MEETU] Saving new/edited style chain",yh.styles),await Uh(yh.styles),Th.style.display="none",Th.classList.remove("visible"),Th.classList.remove("active"),zh()}else qy("璇峰～鍐欏畬鏁?)}async function Yh(e,t){if(!yh.isGenerating){yh.isGenerating=!0,wh&&(wh.textContent="姝ｅ湪渚濈収"+("reroll"===e?"褰撳墠":"鏂扮殑")+"鎬濊矾鏋勬€濅腑...",wh.style.opacity=.5);try{var n=await async function(){var e=Sc.history.slice(-50).map(function(e){return("user"===e.sender?Sc.user.name:Sc.ai.name)+": "+e.text}).join("\n"),t=Sc.ai.description||"鏃?,n="";try{let e=new Set;if(Sc.linkedWorldBookIds&&Sc.linkedWorldBookIds.length>0)Sc.linkedWorldBookIds.forEach(function(t){e.add(t)});else if(Sc.linkedWorldBookGroupIds&&Sc.linkedWorldBookGroupIds.length>0&&window.dbHelper){var a=await window.dbHelper.loadData("worldBookGroups","allGroups"),o=a&&a.value?a.value:[],s=new Set(Sc.linkedWorldBookGroupIds);o.forEach(function(t){s.has(t.id)&&Array.isArray(t.bookIds)&&t.bookIds.forEach(function(t){e.add(t)})})}if(e.size>0&&window.dbHelper){var i=await window.dbHelper.loadData("worldBooks","allWorldBooks");n=(i&&i.value?i.value:[]).filter(function(t){return e.has(t.id)}).map(function(e){return e.content||e.text||""}).join("\n\n")}n&&n.trim()||!Sc.worldBook||Array.isArray(Sc.worldBook)&&(n=Sc.worldBook.map(function(e){return e.content||""}).join("\n"))}catch(e){console.error("[Meetu] WorldBook loading error:",e)}n&&n.trim()||(n="鏃?);var r=[];window.getEnabledMemories&&(r=await window.getEnabledMemories(Sc.id));var l=r.map(function(e){return"[璁板繂] "+e.content}).join("\n"),c=yh.styles.filter(function(e){return e.active});return{history:e,aiPersona:t,userPersona:"锛堢敤鎴锋湭璁惧畾锛?,memoryText:l,worldInfo:n,style:{prompt:c.length>0?c.map(function(e){return"銆?+e.name+"銆? "+e.prompt}).join("\n\n"):"(鏈惎鐢ㄧ壒瀹氱瑪椋庯紝璇疯嚜鐢卞彂鎸?"}}}(),a=await Kl.loadData("settingsStore","apiSettings");if(!a||!a.value||!a.value.key)throw new Error("璇峰厛鍦ㄨ缃腑閰嶇疆API Key");var o=`浣犳槸涓€浣嶆瀬鍏跺嚭鑹茬殑浣滃銆傝鏍规嵁浠ヤ笅淇℃伅锛屽垱浣滀竴娈?绾夸笅瑙侀潰"鐨勪簰鍔ㄥ皬璇存弿鍐欍€俓n\n銆愯鑹蹭俊鎭€慭nAI: ${n.aiPersona}\n鐢ㄦ埛: ${n.userPersona}\n\n銆愪笘鐣岃璁惧畾銆慭n${n.worldInfo}\n\n銆愰噸瑕佽蹇嗐€慭n${n.memoryText}\n\n銆愯繎鏈熷墠鎯呮彁瑕併€慭n${n.history}\n\n銆愭枃椋庤姹?- 蹇呴』涓ユ牸鎵ц銆慭n${n.style.prompt}\n\n銆愪换鍔℃寚浠ゃ€慭n${"continue"===e?"鎺ョ画涓婃枃锛堝弬鑰冨凡鏈夊唴瀹癸級锛岀户缁弿鍐欏悗缁彂灞曘€?:"寮€鍚竴娈垫柊鐨勭嚎涓嬩簰鍔ㄦ弿鍐欙紝鎴栭噸鍐欏綋鍓嶆钀姐€?}\n鎻忓啓搴斿叿鏈夌敾闈㈡劅銆佹矇娴告劅锛屽瓧鏁版帶鍒跺湪200-400瀛楀乏鍙炽€傜函鏂囨湰杈撳嚭锛屼笉瑕佸寘鍚玀arkdown鏍囪銆俓n`;t&&t.trim()&&(o+=`\n\n銆愮敤鎴风殑鎯虫硶 - 閲嶇偣鍙傝€冿紝蹇呴』鍙傝€冦€慭n${t.trim()}`),"continue"===e&&yh.pages.length>0&&(o+=`\n銆愪笂鏂囧唴瀹广€慭n${yh.pages[yh.pages.length-1].substring(0,500)}...`);var s=a.value.url;s.endsWith("/")&&(s=s.slice(0,-1)),s+="/chat/completions";var i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a.value.key},body:JSON.stringify({model:a.value.model||"gpt-3.5-turbo",messages:[{role:"user",content:o}],temperature:.85,max_tokens:a.value.max_tokens||a.value.maxTokens||8e4})}),r=await i.json();if(!r.choices)throw new Error("API杩斿洖鏍煎紡閿欒");var l=r.choices[0].message.content.trim();"reroll"===e&&yh.pages.length>0?yh.pages[yh.pages.length-1]=l:yh.pages.push(l),yh.currentPage=yh.pages.length-1,Kh()}catch(e){console.error(e),wh&&(wh.textContent="鐏垫劅鏋浜?.. (鐢熸垚澶辫触: "+e.message+")")}finally{yh.isGenerating=!1,wh&&(wh.style.opacity=1)}}}function Kh(){if(wh){if(0===yh.pages.length)return wh.textContent="",void(Ih.textContent="0 / 0");wh.style.opacity=0,setTimeout(function(){var e=yh.pages[yh.currentPage];wh.innerText=e,wh.style.opacity=1},200),Ih.textContent=yh.currentPage+1+" / "+yh.pages.length,bh&&(bh.disabled=0===yh.currentPage),Eh&&(Eh.disabled=yh.currentPage===yh.pages.length-1)}}function Zh(e){var t=yh.currentPage+e;t>=0&&t<yh.pages.length&&(yh.currentPage=t,Kh())}function Xh(){var e=yh.pages.join("\n\n ================= \n\n");if(e){var t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="鏅ら潰璁板綍_"+(new Date).toISOString().slice(0,10)+".txt",a.click(),URL.revokeObjectURL(n),qy("宸插鍑?)}else qy("娌℃湁鍐呭鍙鍑?)}console.log("[Meetu] Starting initialization..."),async function(){console.log("[Meetu] Initializing UI...",{btn:!!hh}),console.log("[DEBUG_MEETU] Checking elements existence:",{meetuStyleBtn:!!Bh,meetuContinueBtn:!!kh,meetuStyleModal:!!Sh,meetuContinueModal:!!qh,meetuScreen:!!vh}),hh&&hh.addEventListener("click",Gh),fh&&fh.addEventListener("click",Wh),bh&&bh.addEventListener("click",function(){Zh(-1)}),Eh&&Eh.addEventListener("click",function(){Zh(1)}),xh&&xh.addEventListener("click",function(){Yh("reroll")}),kh&&(console.log("[DEBUG_MEETU] Binding click listener to meetuContinueBtn"),kh.addEventListener("click",function(e){console.log("[DEBUG_MEETU] meetuContinueBtn CLICKED. Event:",e),e.stopPropagation(),qh?(Nh.value="",document.body.appendChild(qh),qh.style.zIndex="2147483647",qh.style.display="flex",qh.offsetWidth,qh.style.opacity="1",qh.classList.add("visible"),qh.classList.add("active"),Nh.focus()):Yh("continue")})),Fh&&Fh.addEventListener("click",function(){qh.classList.remove("visible"),qh.classList.remove("active"),qh.style.display="none"}),_h&&_h.addEventListener("click",function(){var e=Nh.value.trim();qh.style.display="none",Yh("continue",e)}),Lh&&Lh.addEventListener("click",Xh),Bh&&(console.log("[DEBUG_MEETU] Binding click listener to meetuStyleBtn"),Bh.addEventListener("click",function(e){console.log("[DEBUG_MEETU] meetuStyleBtn CLICKED. Event:",e),e.stopPropagation(),function(){if(console.log("[DEBUG_MEETU] openStyleModal executing..."),zh(),!Sh)return console.error("[DEBUG_MEETU] FATAL: meetuStyleModal is NULL!"),void alert("Error: Style Modal element missing");document.body.appendChild(Sh),Sh.style.zIndex="2147483647",Sh.style.display="flex",Sh.offsetWidth,Sh.style.opacity="1",Sh.classList.add("visible"),Sh.classList.add("active"),console.log("[DEBUG_MEETU] Modal moved to body. Z-Index maxed.")}()})),Ch&&Ch.addEventListener("click",function(){Sh.classList.remove("visible"),Sh.classList.remove("active"),Sh.style.display="none"}),$h&&$h.addEventListener("click",function(){Vh()}),Ah&&Ah.addEventListener("click",function(){Th.classList.remove("visible"),Th.classList.remove("active"),Th.style.display="none"}),Hh&&Hh.addEventListener("click",Jh);let e=0;for(;(!window.dbHelper||!window.dbHelper.db)&&e<50;)await new Promise(e=>setTimeout(e,200)),e++;window.dbHelper&&window.dbHelper.db&&await async function(){try{console.log("[Meetu] Loading styles...");var e=null;try{var t=await Kl.loadData("settingsStore","meetuStyles");t&&t.value&&Array.isArray(t.value)&&t.value.length>0&&(e=t.value,console.log("[Meetu] Loaded from DB:",e.length))}catch(e){console.warn("[Meetu] DB Load failed, trying LocalStorage...",e)}if(!e){var n=localStorage.getItem(jh);if(n)try{var a=JSON.parse(n);Array.isArray(a)&&a.length>0&&(e=a,console.log("[Meetu] Loaded from LocalStorage:",e.length),Uh(e))}catch(e){console.error("LS config parse error",e)}}e||(console.log("[Meetu] No styles found, using default."),e=[Rh]),yh.styles=e,yh.styles.forEach(function(e){void 0===e.active&&(e.active=!1)})}catch(e){console.error("[Meetu] Critical Load failed:",e),yh.styles=[Rh]}}()}().then(()=>{console.log("[Meetu] Initialization done");try{const e=JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}");e.enabled&&"busy"===e.currentStatus&&Date.now()>(e.statusEndTime||0)&&(console.log("[OfflineLife] Wakeup condition met. Triggering AI return..."),e.currentStatus="idle",localStorage.setItem("offlineLifeConfig",JSON.stringify(e)),setTimeout(()=>{if(window.currentOpenContact){const t=`[System: You were busy doing "${e.lastReason||"鐢变簬鏌愪簺鍘熷洜"}" and now you are back. Please greet the user naturally and tell them you are back. Do NOT output any system tags.]`;console.log("[OfflineLife] Sending wakeup prompt to AI..."),generateAIResponse(window.currentOpenContact,t,"WAKEUP_"+Date.now())}},2e3))}catch(e){console.warn("[OfflineLife] Auto-wakeup failed:",e)}}).catch(e=>console.error("[Meetu] Init failed",e))}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("anecdotes-feature"),t=document.getElementById("anecdotes-modal"),n=document.getElementById("anecdotes-close-btn"),a=document.getElementById("anecdotes-box"),o=document.getElementById("anecdotes-letter"),s=(document.getElementById("anecdotes-pen-btn"),document.getElementById("anecdotes-input")),i=document.getElementById("anecdotes-confirm-btn"),r=document.getElementById("anecdotes-again-btn"),l=document.getElementById("anecdotes-hint"),c=document.getElementById("letter-input-view"),d=document.getElementById("letter-response-view"),u=document.getElementById("letter-loading-view"),m=document.getElementById("anecdotes-response-content"),p=document.getElementById("anecdotes-signature"),g=document.getElementById("anecdotes-collection-btn"),y=document.getElementById("anecdotes-collection-modal"),h=document.getElementById("collection-list"),v=document.getElementById("collection-close-btn"),f=document.getElementById("anecdotes-remail-btn");let w="";if(!(e&&t&&a&&s&&i))return void console.warn("[Anecdotes] 鏍稿績鍏冪礌鏈壘鍒?(Box/Input/Btn Missing)锛岃烦杩囧垵濮嬪寲");function b(e){if(!e)return"";function t(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}let n=e;n=n.replace(/```(\w+)?\n([\s\S]*?)```/g,(e,n,a)=>{const o=t(a.trim());return`<pre class="letter-code-block"${n?` data-lang="${t(n)}"`:""}><code>${o}</code></pre>`}),n=n.replace(/`([^`]+)`/g,'<code class="letter-inline-code">$1</code>'),n=n.replace(/^######\s+(.+)$/gm,'<h6 class="letter-h6">$1</h6>'),n=n.replace(/^#####\s+(.+)$/gm,'<h5 class="letter-h5">$1</h5>'),n=n.replace(/^####\s+(.+)$/gm,'<h4 class="letter-h4">$1</h4>'),n=n.replace(/^###\s+(.+)$/gm,'<h3 class="letter-h3">$1</h3>'),n=n.replace(/^##\s+(.+)$/gm,'<h2 class="letter-h2">$1</h2>'),n=n.replace(/^#\s+(.+)$/gm,'<h1 class="letter-h1">$1</h1>'),n=n.replace(/~~(.+?)~~/g,'<del class="letter-strikethrough">$1</del>'),n=n.replace(/\*\*([^\*]+?)\*\*/g,'<strong class="letter-bold">$1</strong>'),n=n.replace(/__([^_]+?)__/g,'<strong class="letter-bold">$1</strong>'),n=n.replace(/(?<!\*)\*(?!\*)([^\*]+?)\*(?!\*)/g,'<em class="letter-italic">$1</em>'),n=n.replace(/(?<!_)_(?!_)([^_]+?)_(?!_)/g,'<em class="letter-italic">$1</em>'),n=n.replace(/^---$/gm,'<hr class="letter-hr">'),n=n.replace(/^\*\*\*$/gm,'<hr class="letter-hr">'),n=n.replace(/^[\-\*]\s+(.+)$/gm,'<li class="letter-li">$1</li>'),n=n.replace(/(<li class="letter-li">.*<\/li>\n?)+/g,e=>`<ul class="letter-ul">${e}</ul>`),n=n.replace(/^\d+\.\s+(.+)$/gm,'<li class="letter-li-ordered">$1</li>'),n=n.replace(/(<li class="letter-li-ordered">.*<\/li>\n?)+/g,e=>`<ol class="letter-ol">${e}</ol>`),n=n.replace(/^>\s+(.+)$/gm,'<blockquote class="letter-blockquote">$1</blockquote>'),n=n.replace(/(<blockquote class="letter-blockquote">.*<\/blockquote>\n?)+/g,e=>`<blockquote class="letter-blockquote">${e.replace(/<\/?blockquote[^>]*>/g,"").trim()}</blockquote>`),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" class="letter-link" target="_blank" rel="noopener noreferrer">$1</a>'),n=n.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" class="letter-image" loading="lazy">');const a=n.split("\n");let o=!1,s=[];for(let e=0;e<a.length;e++){const t=a[e].trim();t.startsWith("<")&&(t.includes("<h")||t.includes("<ul")||t.includes("<ol")||t.includes("<li")||t.includes("<blockquote")||t.includes("<pre")||t.includes("<hr")||t.includes("</h")||t.includes("</ul")||t.includes("</ol")||t.includes("</blockquote")||t.includes("</pre"))?(o&&(s.push("</p>"),o=!1),s.push(t)):""===t?(o&&(s.push("</p>"),o=!1),s.push("")):(o||(s.push('<p class="letter-paragraph">'),o=!0),s.push(t))}return o&&s.push("</p>"),n=s.join("\n"),n=n.replace(/\n{3,}/g,"\n\n"),n.trim()}console.log("[Anecdotes] Markdown 娓叉煋鍣ㄥ凡鍔犺浇");let E=!1,I=!1;function x(){E=!1,I=!1,a.classList.remove("opened","thinking"),o.classList.remove("visible"),c.style.display="block",d.style.display="none",u.style.display="none",s.value="",l.classList.remove("hidden"),l.textContent="杞诲惎淇″皝锛屼功鍐欐鍒诲績缁?}async function k(e,t){try{const n=await window.dbHelper.loadData("settingsStore","anecdotesCollection");let a=n&&Array.isArray(n.value)?n.value:[];const o=window.currentOpenContact?window.currentOpenContact.id:null,s={id:"anecdote_"+Date.now(),date:(new Date).toLocaleString(),timestamp:Date.now(),content:e,aiName:t,contactId:o,summary:e.slice(0,50).replace(/\n/g," ")+"..."};a.unshift(s),await window.dbHelper.saveData("settingsStore","anecdotesCollection",a),console.log("[Anecdotes] Saved to collection:",s.id,"for contact:",o)}catch(e){console.error("[Anecdotes] Save failed:",e)}}async function L(){if(h)try{h.innerHTML='<div style="text-align:center;color:#999;padding:20px;">鍔犺浇涓?..</div>';const e=await window.dbHelper.loadData("settingsStore","anecdotesCollection");let t=e&&Array.isArray(e.value)?e.value:[];console.log("[Anecdotes] Total items in database:",t.length);const n=window.currentOpenContact?window.currentOpenContact.id:null,a=window.currentOpenContact?window.currentOpenContact.ai.name:null;let o=t;if(n?(o=t.filter(e=>{if(e.contactId){const t=e.contactId===n;return console.log(`[Anecdotes] Item ${e.id}: contactId=${e.contactId}, match=${t}`),t}{const t=e.aiName===a;return console.log(`[Anecdotes] Item ${e.id}: aiName=${e.aiName}, match=${t} (legacy)`),t}}),console.log(`[Anecdotes] Filtered ${o.length}/${t.length} items for contact:`,n,a)):console.log(`[Anecdotes] No current contact, showing all ${o.length} items`),0===o.length){const e=n?`<div style="text-align:center;color:#ccc;padding:40px;">鏆傛棤鐝嶈棌...<br>鍘诲啓涓€灏佷俊缁?${a} 鍚?/div>`:'<div style="text-align:center;color:#ccc;padding:40px;">鏆傛棤鐝嶈棌...<br>鍘诲啓涓€灏佷俊鍚?/div>';return void(h.innerHTML=e)}h.innerHTML="",o.forEach(e=>{const t=document.createElement("div");t.className="collection-item",t.dataset.id=e.id;t.innerHTML=`\n                    <div class="collection-date">${e.date} 路 ${e.aiName||"AI"}</div>\n                    <div class="collection-summary">${e.content}</div>\n                    <div class="collection-actions">\n                        <button class="collection-action-btn export-btn" title="瀵煎嚭TXT"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>\n                        <button class="collection-action-btn delete-btn" title="鍒犻櫎"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>\n                    </div>\n                `;t.querySelector(".delete-btn").addEventListener("click",t=>{t.stopPropagation(),confirm("纭畾瑕佹挄鎺夎繖涓€椤靛悧锛?)&&async function(e){try{const t=await window.dbHelper.loadData("settingsStore","anecdotesCollection");const n=(t&&Array.isArray(t.value)?t.value:[]).filter(t=>t.id!==e);await window.dbHelper.saveData("settingsStore","anecdotesCollection",n),L()}catch(e){console.error("Delete failed:",e)}}(e.id)});t.querySelector(".export-btn").addEventListener("click",t=>{t.stopPropagation(),function(e){const t=`閫镐簨 - ${e.aiName}\n鏃ユ湡: ${e.date}\n\n${e.content}`,n=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`閫镐簨_${e.aiName}_${e.timestamp}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}(e)}),t.addEventListener("click",()=>{t.classList.toggle("expanded");const e=t.querySelector(".collection-summary");t.classList.contains("expanded")?e.style.webkitLineClamp="unset":e.style.webkitLineClamp="3"}),h.appendChild(t)})}catch(e){console.error("[Anecdotes] Load collection failed:",e),h.innerHTML='<div style="color:red;padding:20px;">鍔犺浇澶辫触</div>'}}async function B(e){const t=window.currentOpenContact;if(!t)throw new Error("鏈壘鍒板綋鍓嶅璇?);const n=t.name||t.ai?.name||"AI",a=t.ai?.persona||"",o=t.user?.name||"鐢ㄦ埛",s=t.user?.persona||"";let i="";try{const e=await window.dbHelper.loadData("worldBooks","allWorldBooks"),n=e&&Array.isArray(e.value)?e.value:[];let a=new Set;if(t.linkedWorldBookIds&&t.linkedWorldBookIds.length>0)t.linkedWorldBookIds.forEach(e=>a.add(e));else if(t.linkedWorldBookGroupIds&&t.linkedWorldBookGroupIds.length>0){const e=await window.dbHelper.loadData("worldBookGroups","allGroups"),n=e&&Array.isArray(e.value)?e.value:[],o=new Set(t.linkedWorldBookGroupIds);n.forEach(e=>{o.has(e.id)&&Array.isArray(e.bookIds)&&e.bookIds.forEach(e=>a.add(e))})}if(a.size>0){const e=n.filter(e=>a.has(e.id)).map(e=>`### 涓栫晫涔? ${e.name}\n${e.content}`).join("\n\n");e&&(i=`\n## 涓栫晫璁惧畾鍙傝€?\n${e}\n`)}}catch(e){console.warn("[Anecdotes] 鍔犺浇涓栫晫涔﹀け璐?",e)}let r="";try{const e=`memoryCheques_${t.id}`,n=await window.dbHelper.loadData("memoryCheques",e),a=(n&&Array.isArray(n.value)?n.value:[]).filter(e=>e.isActive);a.length>0&&(r="\n## 閲嶈璁板繂:\n"+a.map(e=>`- ${e.content}`).join("\n")+"\n")}catch(e){console.warn("[Anecdotes] 鍔犺浇璁板繂鏀エ澶辫触:",e)}const l=`浣犳槸涓€浣嶆墠鍗庢í婧㈢殑浣滃锛屾搮闀垮垱浣滅粏鑵汇€佸瘜鏈夋儏鎰熺殑灏忕暘澶栨晠浜嬨€俓n\n## 瑙掕壊璁惧畾:\n銆?{n}鐨勪汉璁俱€慭n${a||"(鏃犺缁嗕汉璁?"}\n\n銆?{o}鐨勪汉璁俱€慭n${s||"(鏃犺缁嗕汉璁?"}\n\n${i}\n${r}\n\n## 鍒涗綔瑕佹眰:\n1. 鏍规嵁鐢ㄦ埛鐨勬彁绀猴紝鍒涗綔涓€涓殑灏忕暘澶?閫镐簨\n2. 浠?{n}鐨勮瑙掓垨绗笁浜虹О鍙欒堪\n3. 鏂囬鐜颁唬銆佹竻鏂般€佹湁璐ㄦ劅銆俓n4. 淇濇寔瑙掕壊鎬ф牸涓€鑷存€n5. 鍙互鏄棩甯哥墖娈点€佸洖蹇嗐€佸够鎯虫垨娓╅Θ浜掑姩\n6. 涓嶉渶瑕佹爣棰橈紝鐩存帴寮€濮嬪彊杩癨n7. 缁撳熬鍙互绋嶆湁鐣欑櫧锛岃浜哄洖鍛砛n8. **蹇呴』浣跨敤涓枃杩涜鍒涗綔锛岀粷瀵逛笉鑳戒娇鐢ㄨ嫳鏂?*`,c=await window.dbHelper.loadData("settingsStore","apiSettings");if(!c||!c.value||!c.value.url)throw new Error("璇峰厛鍦ㄨ缃腑閰嶇疆 API");const{url:d,key:u,model:m,temperature:p}=c.value;let g=d.endsWith("/")?d.slice(0,-1):d;g+="/chat/completions";const y=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({model:m||"gpt-3.5-turbo",messages:[{role:"system",content:l},{role:"user",content:`璇锋牴鎹互涓嬫彁绀哄垱浣滀竴涓皬鐣:\n\n${e}`}],temperature:.8,max_tokens:2e5})});if(!y.ok){const e=await y.text();throw new Error(`API 璇锋眰澶辫触: ${y.status} - ${e}`)}const h=await y.json(),v=h.choices?.[0]?.message?.content?.trim();if(!v)throw new Error("AI 鏈繑鍥炴湁鏁堝唴瀹?);return v}e.addEventListener("click",e=>{e.stopPropagation(),window.currentOpenContact?(x(),t.classList.add("active"),console.log("[Anecdotes] 閫镐簨鐣岄潰宸叉墦寮€")):alert("璇峰厛鎵撳紑涓€涓亰澶╁璇?)}),n.addEventListener("click",function(){t.classList.remove("active"),x()}),a.addEventListener("click",()=>{a.classList.contains("thinking")||(E?I&&"none"!==c.style.display&&(o.classList.remove("visible"),I=!1,setTimeout(()=>{a.classList.remove("opened"),E=!1,l.classList.remove("hidden")},300)):(a.classList.add("opened"),E=!0,l.classList.add("hidden"),setTimeout(()=>{o.classList.add("visible"),I=!0},500)))}),i.addEventListener("click",async()=>{const e=s.value.trim();if(e){c.style.display="none",u.style.display="flex",l.textContent="淇′欢姝ｅ湪閭瘎...",w=e,o.classList.remove("visible"),I=!1,setTimeout(()=>{a.classList.remove("opened"),E=!1,setTimeout(()=>{a.classList.add("thinking")},300)},400);try{const t=await B(e);a.classList.remove("thinking"),setTimeout(()=>{a.classList.add("opened"),E=!0,u.style.display="none",d.style.display="block",m.innerHTML=b(t),p.textContent=`鈥斺€?${window.currentOpenContact.ai.name}`,k(t,window.currentOpenContact.ai.name),setTimeout(()=>{o.classList.add("visible"),I=!0},500)},300)}catch(e){console.error("[Anecdotes] AI璋冪敤澶辫触:",e),a.classList.remove("thinking"),u.style.display="none",c.style.display="block",alert("閭樊鍦ㄨ矾涓婅糠璺簡...璇峰啀璇曚竴娆n"+e.message),a.classList.add("opened"),E=!0,setTimeout(()=>{o.classList.add("visible"),I=!0},300)}}else alert("淇＄焊涓婅繕绌虹┖濡備篃鍛?..")}),r.addEventListener("click",()=>{o.classList.remove("visible"),I=!1,setTimeout(()=>{d.style.display="none",c.style.display="block",s.value="",setTimeout(()=>{o.classList.add("visible"),I=!0},200)},300)}),f&&f.addEventListener("click",async()=>{w?(o.classList.remove("visible"),I=!1,d.style.display="none",u.style.display="flex",l.textContent="淇′欢姝ｅ湪閲嶆柊鎶曢€?..",setTimeout(async()=>{a.classList.remove("opened"),E=!1,setTimeout(()=>{a.classList.add("thinking")},300);try{const e=await B(w);a.classList.remove("thinking"),setTimeout(()=>{a.classList.add("opened"),E=!0,u.style.display="none",d.style.display="block",m.innerHTML=b(e),p.textContent=`鈥斺€?${window.currentOpenContact?window.currentOpenContact.ai.name:"AI"}`,k(e,window.currentOpenContact.ai.name),setTimeout(()=>{o.classList.add("visible"),I=!0},500)},300)}catch(e){console.error("[Anecdotes] Remail failed:",e),a.classList.remove("thinking"),alert("閲嶆柊閭瘎澶辫触...\n"+e.message),a.classList.add("opened"),E=!0,o.classList.add("visible"),I=!0}},400)):alert("娌℃湁鎵惧埌涓婁竴灏佷俊鐨勫簳绋?..")}),g&&g.addEventListener("click",e=>{e.stopPropagation(),L(),y.classList.add("active")}),v&&v.addEventListener("click",()=>{y.classList.remove("active")}),y&&y.addEventListener("click",e=>{e.target===y&&y.classList.remove("active")}),console.log("[Anecdotes] 閫镐簨鍔熻兘鍒濆鍖栧畬鎴?)}),document.addEventListener("DOMContentLoaded",()=>{console.log("[Location] 鍒濆鍖栧畾浣嶅姛鑳?..");const e=document.getElementById("location-feature"),t=document.getElementById("location-input-modal"),n=document.getElementById("location-modal-close-btn"),a=document.getElementById("location-name-input"),o=document.getElementById("location-address-input"),s=document.getElementById("location-distance-input"),i=document.getElementById("send-location-btn");function r(){t.style.opacity="0",t.classList.remove("visible"),setTimeout(()=>{t.style.display="none"},300)}function l(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}e&&t?(e.addEventListener("click",e=>{e.stopPropagation(),window.currentOpenContact?(a&&(a.value=""),o&&(o.value=""),s&&(s.value=""),t.style.display="flex",requestAnimationFrame(()=>{t.style.opacity="1",t.classList.add("visible")}),console.log("[Location] 瀹氫綅寮圭獥宸叉墦寮€")):alert("璇峰厛鎵撳紑涓€涓亰澶╁璇?)}),n&&n.addEventListener("click",r),t.addEventListener("click",e=>{e.target===t&&r()}),i&&i.addEventListener("click",async()=>{const e=a?.value.trim()||"",t=o?.value.trim()||"",n=s?.value.trim()||"0";if(!e)return void alert("璇疯緭鍏ヤ綅缃悕绉?);if(!t)return void alert("璇疯緭鍏ヨ缁嗗湴鍧€");if(!n||parseFloat(n)<0)return void alert("璇疯緭鍏ユ湁鏁堢殑璺濈锛坘m锛?);const i=function(e,t,n){return`\n            <div class="map-card">\n                <div class="info-section">\n                    <div class="title">${l(e)}</div>\n                    <div class="address">${l(t)}</div>\n                </div>\n                \n                <div class="map-canvas">\n                    <div class="river-path"></div>\n                    \n                    <div class="main-road h-road"></div>\n                    <div class="main-road v-road"></div>\n\n                    <div class="tree" style="top: 60px; left: 50px;"></div>\n                    <div class="tree" style="top: 60px; left: 100px;"></div>\n                    <div class="tree" style="top: 100px; left: 55px;"></div>\n\n                    <div class="neighborhood" style="top: 15px; left: 10px;">\n                        <div class="building" style="width: 22px; height: 28px;"></div>\n                        <div class="building" style="width: 26px; height: 22px;"></div>\n                        <div class="building" style="width: 30px; height: 25px;"></div>\n                    </div>\n\n                    <div class="neighborhood" style="bottom: 15px; left: 15px;">\n                        <div class="building" style="width: 35px; height: 22px;"></div>\n                        <div class="building" style="width: 18px; height: 18px;"></div>\n                    </div>\n\n                    <div class="marker-fixed">\n                        <svg width="28" height="28" viewBox="0 0 24 24" fill="#27c34b">\n                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>\n                        </svg>\n                        <div class="marker-label">鎴戠殑浣嶇疆</div>\n                    </div>\n                    \n                    <div class="dist-badge">璺濇偍 ${l(n)} km</div>\n                </div>\n            </div>\n        `}(e,t,n);await async function(e,t,n,a){if(!window.currentOpenContact)return;const o=window.currentOpenContact,s=Date.now(),i=`loc_${s}_${Math.random().toString(36).substr(2,9)}`,r={id:s,uuid:i,sender:"user",text:e,timestamp:s,type:"location",locationData:{name:t,address:n,distance:a,aiNotified:!1}},l=window.saveMessageToHistory,c=window.addMessageToView;l&&"function"==typeof l?(await l(r,o.id),console.log("[Location] 瀹氫綅娑堟伅宸查€氳繃鏍囧噯娴佺▼淇濆瓨")):(console.error("[Location] Critical: window.saveMessageToHistory not found!"),o.history.push(r));c&&"function"==typeof c&&c(r,o);const d=document.getElementById("chat-messages-container");d&&(d.scrollTop=d.scrollHeight);console.log("[Location] 瀹氫綅鍗＄墖宸插彂閫佸苟娓叉煋");const u=`鐢ㄦ埛鍒氬垰鍒嗕韩浜嗕竴鏉″畾浣嶏紝鍐呭鏄細${t} - ${n}锛岃窛绂?${a}km`,m={id:Date.now()+1,uuid:`loc_hint_${Date.now()}`,sender:"system",text:u,timestamp:Date.now(),type:"location_hint",hidden:!0,locationRef:i};l&&"function"==typeof l&&(await l(m,o.id),console.log("[Location] AI瀹氫綅鎻愮ず宸蹭繚瀛?))}(i,e,t,n),r(),console.log("[Location] 瀹氫綅鍗＄墖宸插彂閫?",{name:e,address:t,distance:n})}),console.log("[Location] 瀹氫綅鍔熻兘鍒濆鍖栧畬鎴?)):console.warn("[Location] 鏍稿績鍏冪礌鏈壘鍒帮紝璺宠繃鍒濆鍖?)}),document.addEventListener("DOMContentLoaded",function(){console.log("[GroupSettingsPage] 鍒濆鍖栫兢鑱婅缃〉闈?..");const e=document.getElementById("group-settings-back-btn");e&&e.addEventListener("click",function(){const e=document.getElementById("group-settings-page");e&&(e.classList.add("closing"),setTimeout(()=>{e.classList.remove("active","closing")},300))});document.querySelectorAll("#group-settings-page .collapsible-header").forEach(e=>{e.addEventListener("click",function(){const e=this.closest(".collapsible-section");e&&e.classList.toggle("expanded")})});document.querySelectorAll("#group-settings-page .ios-switch").forEach(e=>{e.addEventListener("click",async function(){if(this.classList.toggle("active"),!window.currentOpenGroup)return;const e=this.id,t=this.classList.contains("active");try{"group-show-avatars-toggle"===e?(window.currentOpenGroup.avatarSettings=window.currentOpenGroup.avatarSettings||{},window.currentOpenGroup.avatarSettings.show=t):"group-show-timestamp-toggle"===e?(window.currentOpenGroup.timestampSettings=window.currentOpenGroup.timestampSettings||{},window.currentOpenGroup.timestampSettings.show=t):"group-bilingual-bubble-toggle"===e&&(window.currentOpenGroup.bilingualBubble=window.currentOpenGroup.bilingualBubble||{},window.currentOpenGroup.bilingualBubble.enabled=t);const n=await window.dbHelper.loadData("groupChats","allGroupChats");let a=n?n.value:[];const o=a.findIndex(e=>e.id===window.currentOpenGroup.id);o>-1&&(a[o]=window.currentOpenGroup,await window.dbHelper.saveData("groupChats","allGroupChats",a)),console.log("[GroupSettings] 鏄剧ず璁剧疆宸蹭繚瀛?",e,t)}catch(e){console.error("[GroupSettings] 淇濆瓨鏄剧ず璁剧疆澶辫触:",e)}})});let t=!1;const n=document.getElementById("group-member-count");n&&n.addEventListener("click",function(){t=!t;const e=document.getElementById("group-members-grid");if(!e)return;const n=e.querySelectorAll(".member-delete-btn");if(t)this.textContent="瀹屾垚",this.style.color="#C48888",n.forEach(e=>e.style.display="flex");else{const e=window.currentOpenGroup?.members?.length||0;this.textContent=`${e}鍚嶇兢鎴愬憳 >`,this.style.color="",n.forEach(e=>e.style.display="none")}}),console.log("[GroupSettingsPage] 缇よ亰璁剧疆椤甸潰鍒濆鍖栧畬鎴?)}),document.addEventListener("DOMContentLoaded",function(){console.log("[ChatSettingsPage] 鍒濆鍖栧崟鑱婅缃〉闈?..");const e=document.getElementById("chat-settings-back-btn");e&&e.addEventListener("click",function(){const e=document.getElementById("chat-settings-page");e&&(e.classList.add("closing"),setTimeout(()=>{e.classList.remove("active","closing")},300))});const t=document.getElementById("chat-role-tab-ai"),n=document.getElementById("chat-role-tab-user"),a=document.getElementById("chat-ai-form"),o=document.getElementById("chat-user-form"),s=document.getElementById("chat-settings-avatar"),i=document.getElementById("chat-settings-name");t&&n&&(t.addEventListener("click",function(){t.classList.add("active"),n.classList.remove("active"),a&&(a.style.display="block"),o&&(o.style.display="none"),window.currentOpenContact&&s&&(s.style.backgroundImage=`url('${window.currentOpenContact.ai.avatar}')`,i.textContent=window.currentOpenContact.ai.name)}),n.addEventListener("click",function(){n.classList.add("active"),t.classList.remove("active"),o&&(o.style.display="block"),a&&(a.style.display="none"),window.currentOpenContact&&s&&(s.style.backgroundImage=`url('${window.currentOpenContact.user.avatar}')`,i.textContent=window.currentOpenContact.user.name)}));document.querySelectorAll("#chat-settings-page .collapsible-header").forEach(e=>{e.addEventListener("click",function(){const e=this.closest(".collapsible-section");e&&e.classList.toggle("expanded")})});document.querySelectorAll("#chat-settings-page .ios-switch").forEach(e=>{e.addEventListener("click",function(){this.classList.toggle("active")})});const r=document.getElementById("chat-avatar-upload-input"),l=document.querySelector("#chat-settings-page .profile-avatar-wrapper");l&&r&&(l.addEventListener("click",function(){r.click()}),r.addEventListener("change",async function(e){const t=e.target.files[0];if(t&&window.currentOpenContact){e.target.value="",window.currentOpenContact.ai&&window.currentOpenContact.user&&window.currentOpenContact.ai===window.currentOpenContact.user&&(console.log("Detected AI and User sharing same object, unlinking..."),window.currentOpenContact.user=JSON.parse(JSON.stringify(window.currentOpenContact.user)));try{let e;e=window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>512e3?await window.iOSBabyMode.safeCompressImage(t,{maxWidth:400,maxHeight:400,quality:.8}):window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),s&&(s.style.backgroundImage=`url('${e}')`);const n=document.getElementById("chat-role-tab-ai");if(n&&n.classList.contains("active")){window.currentOpenContact.ai.avatar=e;const t=document.getElementById("chat-ai-name-input");t&&(t.value=window.currentOpenContact.ai.name)}else{window.currentOpenContact.user.avatar=e;const t=document.getElementById("chat-user-avatar-preview");t&&(t.style.backgroundImage=`url('${e}')`)}}catch(e){console.error("澶村儚涓婁紶澶辫触:",e),alert("鉂?澶村儚涓婁紶澶辫触")}}}));const c=document.getElementById("chat-user-avatar-btn"),d=document.getElementById("chat-user-avatar-input"),u=document.getElementById("chat-user-avatar-preview");c&&d&&(c.addEventListener("click",function(){d.click()}),d.addEventListener("change",async function(e){const t=e.target.files[0];if(t){e.target.value="";try{let e;e=window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>512e3?await window.iOSBabyMode.safeCompressImage(t,{maxWidth:400,maxHeight:400,quality:.8}):window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),u&&(u.style.backgroundImage=`url('${e}')`),window.currentOpenContact&&(window.currentOpenContact.user.avatar=e)}catch(e){console.error("鐢ㄦ埛澶村儚涓婁紶澶辫触:",e),alert("鉂?鐢ㄦ埛澶村儚涓婁紶澶辫触")}}}));const m=document.getElementById("chat-bg-input");m&&m.addEventListener("change",async function(e){const t=e.target.files[0];if(t&&window.currentOpenContact){e.target.value="";try{let e;window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>2097152?(window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",0),e=await window.iOSBabyMode.safeCompressImage(t,{maxWidth:1920,maxHeight:1920,quality:.75,onProgress:e=>window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",e)}),window.iOSBabyMode.hideProgressToast()):e=window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)});const n=document.getElementById("chat-bg-preview"),a=document.getElementById("chat-bg-placeholder"),o=document.getElementById("chat-bg-preview-box");n&&(n.src=e,n.style.display="block"),a&&(a.style.display="none"),o&&o.classList.add("has-bg"),window.currentOpenContact.chatBackground=e}catch(e){console.error("鑳屾櫙鍥句笂浼犲け璐?",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?鑳屾櫙鍥句笂浼犲け璐n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}}});const p=document.getElementById("chat-clear-bg-btn");if(p){p.addEventListener("click",function(){const e=document.getElementById("chat-bg-preview"),t=document.getElementById("chat-bg-placeholder"),n=document.getElementById("chat-bg-preview-box");e&&(e.src="",e.style.display="none"),t&&(t.style.display="flex"),n&&n.classList.remove("has-bg"),window.currentOpenContact&&(window.currentOpenContact.chatBackground=null),this.checked&&async function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.warn("[OfflineLife] Push messaging is not supported"),!1;try{const e=await navigator.serviceWorker.ready,t=function(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/"),a=window.atob(n),o=new Uint8Array(a.length);for(let e=0;e<a.length;++e)o[e]=a.charCodeAt(e);return o}("BCZ-HV6B5DpdYLTKW_OlWt-ZoZ666xBgsG__5xNDHwX8rSn-e71W89VP4yOmDCbMPBpmyEBUdueCeIAIVeWD1XU"),n=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t});console.log("[OfflineLife] User is subscribed:",n);const a="/api/offline-life",o=window.currentOpenContact&&window.currentOpenContact.id||"user_default";return await fetch(`${a}/subscribe`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:o,subscription:n})}),!0}catch(e){return console.error("[OfflineLife] Failed to subscribe the user: ",e),!1}}().then(e=>{e?showToast("绂荤嚎閫氱煡宸插紑鍚?):showToast("閫氱煡璁㈤槄澶辫触锛岃妫€鏌ユ潈闄?)})});const e=document.getElementById("chat-clear-history-btn");e&&e.addEventListener("click",async function(){if(window.currentOpenContact&&confirm("璀﹀憡锛氭鎿嶄綔灏嗘案涔呭垹闄ゆ鑱婂ぉ鐨勬墍鏈夎褰曪紝涓旀棤娉曟仮澶嶃€傜‘瀹氳缁х画鍚楋紵"))try{const e=await window.dbHelper.loadData("messageContacts","allContacts");let t=e?e.value:[];const n=t.findIndex(e=>e.id===window.currentOpenContact.id);if(n>-1){t[n].history=[],t[n].lastMessage="鑱婂ぉ璁板綍宸叉竻绌?,await window.dbHelper.saveData("messageContacts","allContacts",t),window.currentOpenContact.history=[],window.currentOpenContact.lastMessage="鑱婂ぉ璁板綍宸叉竻绌?;const e=document.getElementById("chat-messages-container");e&&(e.innerHTML=""),alert("鑱婂ぉ璁板綍宸叉垚鍔熸竻闄わ紒")}}catch(e){console.error("[ChatSettings] 娓呯┖璁板綍澶辫触:",e),alert("娓呯┖澶辫触锛?+e.message)}});const t=document.getElementById("chat-block-btn");t&&t.addEventListener("click",async function(){if(!window.currentOpenContact)return;const e=window.currentOpenContact.isBlocked,n=e?"瑙ｉ櫎鎷夐粦":"鎷夐粦";if(confirm(`纭畾瑕?{n}璇ヨ仈绯讳汉鍚楋紵`))try{window.currentOpenContact.isBlocked=!e;const a=await window.dbHelper.loadData("messageContacts","allContacts");let o=a?a.value:[];const s=o.findIndex(e=>e.id===window.currentOpenContact.id);s>-1&&(o[s].isBlocked=!e,await window.dbHelper.saveData("messageContacts","allContacts",o)),t.textContent=e?"鎷夐粦鑱旂郴浜?:"瑙ｉ櫎鎷夐粦",alert(`宸?{n}璇ヨ仈绯讳汉`)}catch(e){console.error("[ChatSettings] 鎿嶄綔澶辫触:",e),alert("鎿嶄綔澶辫触锛?+e.message)}});const n=document.getElementById("save-chat-settings-new-btn");n&&n.addEventListener("click",async function(){if(window.currentOpenContact)try{const e=window.currentOpenContact,t=document.getElementById("chat-ai-name-input"),n=document.getElementById("chat-ai-persona-input"),a=document.getElementById("chat-context-memory-input"),o=document.getElementById("chat-settings-avatar");if(e.ai.name=t?t.value:e.ai.name,e.ai.persona=n?n.value:"",e.contextMemory=a?parseInt(a.value)||0:e.contextMemory||0,o&&o.style.backgroundImage){const t=document.getElementById("chat-role-tab-ai");t&&t.classList.contains("active")&&(e.ai.avatar=o.style.backgroundImage.slice(5,-2))}const s=document.getElementById("chat-user-name-input"),i=document.getElementById("chat-user-persona-input"),r=document.getElementById("chat-user-avatar-preview");e.user=e.user||{},e.user.name=s?s.value:e.user.name,e.user.persona=i?i.value:"",r&&r.style.backgroundImage&&(e.user.avatar=r.style.backgroundImage.slice(5,-2));document.getElementById("chat-worldbook-select-container");e.avatarSettings={showChar:document.getElementById("chat-show-char-avatar-toggle")?.classList.contains("active"),showUser:document.getElementById("chat-show-user-avatar-toggle")?.classList.contains("active"),show:document.getElementById("chat-show-char-avatar-toggle")?.classList.contains("active"),radius:document.getElementById("chat-avatar-radius-input")?.value||"50%"},e.bubbleBMode=document.getElementById("chat-bubble-b-mode-toggle")?.classList.contains("active"),e.timestampSettings={show:document.getElementById("chat-show-timestamp-toggle")?.classList.contains("active")},e.enableDefaultStickers=document.getElementById("chat-default-stickers-toggle")?.classList.contains("active"),e.enableMonologue=document.getElementById("chat-monologue-toggle")?.classList.contains("active"),e.enableBilingualBubble=document.getElementById("chat-bilingual-toggle")?.classList.contains("active"),e.enableWBStickers=document.getElementById("chat-wb-stickers-toggle")?.classList.contains("active"),e.customBubbleCss=document.getElementById("chat-bubble-css-input")?.value||"",e.ai.avatarPendant={url:document.getElementById("chat-ai-pendant-url")?.value||"",css:document.getElementById("chat-ai-pendant-css")?.value||""},e.user.avatarPendant={url:document.getElementById("chat-user-pendant-url")?.value||"",css:document.getElementById("chat-user-pendant-css")?.value||""};const l=document.getElementById("chat-tts-voice-input"),c=document.getElementById("chat-tts-language-input");e.ttsVoiceId=l?l.value.trim():e.ttsVoiceId||"",e.ttsLanguage=c?c.value:e.ttsLanguage||"",console.log("[ChatSettings] save new settings started for contact id:",e.id);const d=await window.dbHelper.loadData("messageContacts","allContacts");let u=d&&Array.isArray(d.value)?d.value:[];Array.isArray(u)||(u=[]);const m=u.findIndex(t=>t.id===e.id);if(m>-1){if(u[m]=e,await window.dbHelper.saveData("messageContacts","allContacts",u),"undefined"!=typeof Global_AllContactsCache&&Global_AllContactsCache){const t=Global_AllContactsCache.findIndex(t=>t.id===e.id);t>-1&&(Global_AllContactsCache[t]=e,console.log("[ChatSettings] 鍏ㄥ眬缂撳瓨宸插悓姝ユ洿鏂?))}}else console.warn(`[ChatSettings] 鑱旂郴浜?${e.id} 鍦?DB 涓湭鎵惧埌锛屾墽琛岃拷鍔犱繚瀛榒),u.push(e),await window.dbHelper.saveData("messageContacts","allContacts",u),"undefined"!=typeof Global_AllContactsCache&&Global_AllContactsCache&&Global_AllContactsCache.push(e);const p=document.getElementById("chat-messages-container");if(p){window.initializeChatStyles?window.initializeChatStyles(e):console.error("initializeChatStyles not found on window"),"function"==typeof applyChatViewSettings?applyChatViewSettings(e):console.warn("applyChatViewSettings not found");try{const e=Array.from(p.querySelectorAll(".message-row")),t={start:e.filter(e=>e.classList.contains("group-start")).length,middle:e.filter(e=>e.classList.contains("group-middle")).length,end:e.filter(e=>e.classList.contains("group-end")).length,single:e.filter(e=>e.classList.contains("group-single")).length};console.log("[ChatSettings] post-save groupCounts:",t),console.log("[ChatSettings] chatMessagesContainer classes:",p.className)}catch(e){console.warn("[ChatSettings] grouping diagnostic failed",e)}}const g=document.getElementById("chat-ai-avatar"),y=document.getElementById("chat-ai-name"),h=document.getElementById("chat-contact-name");g&&(g.src=e.ai.avatar),y&&(y.textContent=e.ai.name),h&&(h.textContent=e.ai.name);const v=document.getElementById("custom-bubble-styles");if(v){const t=".user-bubble {\n    align-self: flex-end;\n    \n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #D1D9D3;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #2F3633; \n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);\n    border-left: 1px solid rgba(255, 255, 255, 0.05);\n    margin-bottom: 0px;\n}\n.ai-bubble {\n    align-self: flex-start;\n    \n    border-radius: 12px 12px 12px 12px;\n    font-size: 14px;\n    color: #5F6360;\n    padding-top: 8px; padding-bottom: 8px; padding-left: 12px; padding-right: 12px;\n    background: #E8EAE9;\n    border: none;\n    margin-bottom: 0px;\n}";v.innerHTML=e.customBubbleCss||t}try{console.log("[ChatSettings] saved contact avatarSettings:",e.avatarSettings);const t=document.getElementById("chat-messages-container");t&&console.log("[ChatSettings] chat-messages-container classes:",t.className)}catch(e){console.warn("[ChatSettings] diagnostic logging failed",e)}alert("璁剧疆宸蹭繚瀛橈紝閮ㄥ垎鍔熻兘闇€閫€鍑哄啀杩涘叆鑱婂ぉ鐣岄潰鐢熸晥锛?);const f=document.getElementById("chat-settings-page");f&&(f.classList.add("closing"),setTimeout(()=>{f.classList.remove("active","closing")},300))}catch(e){console.error("[ChatSettings] 淇濆瓨澶辫触:",e),alert("淇濆瓨澶辫触锛?+e.message)}});const a=document.getElementById("chat-ai-pendant-clear");a&&a.addEventListener("click",function(){document.getElementById("chat-ai-pendant-url").value="",document.getElementById("chat-ai-pendant-css").value="",alert("瑙掕壊鎸備欢宸叉竻闄わ紝淇濆瓨鍚庣敓鏁?)});const o=document.getElementById("chat-user-pendant-clear");o&&o.addEventListener("click",function(){document.getElementById("chat-user-pendant-url").value="",document.getElementById("chat-user-pendant-css").value="",alert("鐢ㄦ埛鎸備欢宸叉竻闄わ紝淇濆瓨鍚庣敓鏁?)});const s=document.getElementById("chat-bubble-preset-btn");s&&s.addEventListener("click",function(){const e=document.getElementById("bubble-preset-select-modal"),t=document.getElementById("bubble-preset-select-list"),n=document.getElementById("bubble-preset-select-empty");if(e&&t){const a=JSON.parse(localStorage.getItem("bubblePresets")||"[]");t.innerHTML="",0===a.length?n&&(n.style.display="block"):(n&&(n.style.display="none"),a.forEach((n,a)=>{const o=document.createElement("div");o.className="preset-select-item",o.style.padding="12px",o.style.borderBottom="1px solid #eee",o.style.cursor="pointer",o.style.backgroundColor="#fff",o.style.marginBottom="8px",o.style.borderRadius="8px";const s=n.css.length>50?n.css.substring(0,50)+"...":n.css;o.innerHTML=`\n                            <div style="font-weight:bold;margin-bottom:4px;">${n.name}</div>\n                            <div style="font-size:12px;color:#888;">${s}</div>\n                        `,o.onclick=function(){const t=document.getElementById("chat-bubble-css-input");t&&(t.value=n.css),e.style.display="none"},t.appendChild(o)})),e.style.display="flex"}else alert("鏈壘鍒伴璁鹃€夋嫨缁勪欢")});const i=document.getElementById("chat-bubble-save-btn");i&&i.addEventListener("click",function(){const e=document.getElementById("chat-bubble-css-input")?.value;if(!e||""===e.trim())return void alert("璇峰厛杈撳叆CSS鏍峰紡");const t=JSON.parse(localStorage.getItem("bubblePresets")||"[]"),n=prompt("璇疯緭鍏ラ璁惧悕绉?","鎴戠殑姘旀场 "+(t.length+1));if(n&&""!==n.trim())try{const t=JSON.parse(localStorage.getItem("bubblePresets")||"[]");t.unshift({name:n.trim(),css:e,createdAt:Date.now()}),localStorage.setItem("bubblePresets",JSON.stringify(t)),alert("棰勮宸蹭繚瀛橈紒")}catch(e){console.error("[ChatSettings] 淇濆瓨棰勮澶辫触:",e),alert("淇濆瓨澶辫触锛?+e.message)}});const r=document.getElementById("chat-bubble-restore-btn");r&&r.addEventListener("click",function(){document.getElementById("chat-bubble-css-input").value="",alert("宸叉仮澶嶉粯璁ゆ牱寮忥紝淇濆瓨鍚庣敓鏁?)});const l=document.getElementById("save-group-settings-btn");l&&l.addEventListener("click",async function(){if(window.currentOpenGroup)try{const e=window.currentOpenGroup;e.avatarSettings={show:document.getElementById("group-show-avatars-toggle")?.classList.contains("active")},e.timestampSettings={show:document.getElementById("group-show-timestamp-toggle")?.classList.contains("active")};const t=await window.dbHelper.loadData("groupChats","allGroupChats");let n=t?t.value:[];const a=n.findIndex(t=>t.id===e.id);if(a>-1)n[a]=e,await window.dbHelper.saveData("groupChats","allGroupChats",n),console.log("[GroupSettings] Group saved to DB:",e.id);else{console.error("[GroupSettings] Error: Current group not found in DB loading list. ID:",e.id);const t=n.findIndex(t=>String(t.id)===String(e.id));if(!(t>-1))return void alert("淇濆瓨澶辫触锛氭暟鎹簱涓壘涓嶅埌璇ョ兢缁勩€?);n[t]=e,await window.dbHelper.saveData("groupChats","allGroupChats",n),console.log("[GroupSettings] Group saved to DB (type coerced):",e.id)}const o=document.getElementById("chat-messages-container");o&&(e.chatBackground?(o.style.backgroundImage=`url('${e.chatBackground}')`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat"):(o.style.backgroundImage="",o.style.backgroundSize="",o.style.backgroundPosition="",o.style.backgroundRepeat=""),e.avatarSettings&&!1===e.avatarSettings.show?o.classList.add("hide-avatars"):o.classList.remove("hide-avatars"),e.timestampSettings&&!0===e.timestampSettings.show?o.classList.remove("hide-timestamps"):o.classList.add("hide-timestamps")),alert("缇よ亰璁剧疆宸蹭繚瀛橈紒");const s=document.getElementById("group-settings-page");s&&s.classList.remove("active")}catch(e){console.error("淇濆瓨缇よ亰璁剧疆澶辫触:",e),alert("淇濆瓨澶辫触: "+e.message)}})}console.log("[ChatSettingsPage] 鍗曡亰璁剧疆椤甸潰鍒濆鍖栧畬鎴?);const g=document.getElementById("save-group-settings-btn");if(g){const e=g.cloneNode(!0);g.parentNode.replaceChild(e,g),e.addEventListener("click",async function(){if(window.currentOpenGroup)try{const e=window.currentOpenGroup;e.avatarSettings={show:document.getElementById("group-show-avatars-toggle")?.classList.contains("active")},e.timestampSettings={show:document.getElementById("group-show-timestamp-toggle")?.classList.contains("active")};const t=await window.dbHelper.loadData("groupChats","allGroupChats");let n=t?t.value:[];const a=n.findIndex(t=>t.id===e.id);if(a>-1)n[a]=e,await window.dbHelper.saveData("groupChats","allGroupChats",n),console.log("[GroupSettings] Group saved to DB:",e.id);else{console.error("[GroupSettings] Error: Current group not found in DB loading list. ID:",e.id);const t=n.findIndex(t=>String(t.id)===String(e.id));if(!(t>-1))return void alert("淇濆瓨澶辫触锛氭暟鎹簱涓壘涓嶅埌璇ョ兢缁勩€?);n[t]=e,await window.dbHelper.saveData("groupChats","allGroupChats",n)}const o=document.getElementById("chat-messages-container");o&&(e.chatBackground?(o.style.backgroundImage=`url('${e.chatBackground}')`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat"):(o.style.backgroundImage="",o.style.backgroundSize="",o.style.backgroundPosition="",o.style.backgroundRepeat=""),e.avatarSettings&&!1===e.avatarSettings.show?o.classList.add("hide-avatars"):o.classList.remove("hide-avatars"),e.timestampSettings&&!0===e.timestampSettings.show?o.classList.remove("hide-timestamps"):o.classList.add("hide-timestamps")),alert("缇よ亰璁剧疆宸蹭繚瀛橈紝閮ㄥ垎鍔熻兘闇€閫€鍑哄啀杩涘叆鑱婂ぉ鐣岄潰鐢熸晥锛侊紒");const s=document.getElementById("group-settings-page");s&&s.classList.remove("active")}catch(e){console.error("淇濆瓨缇よ亰璁剧疆澶辫触:",e),alert("淇濆瓨澶辫触: "+e.message)}})}const y=document.getElementById("group-chat-bg-input");y&&y.addEventListener("change",async function(e){console.log("[GroupSettings] Background input changed");const t=e.target.files[0];if(t)if(e.target.value="",window.currentOpenGroup)try{let n;window.iOSBabyMode&&window.iOSBabyMode.enabled&&t.size>2097152?(window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",0),n=await window.iOSBabyMode.safeCompressImage(t,{maxWidth:1920,maxHeight:1920,quality:.75,onProgress:e=>window.iOSBabyMode.showProgressToast("姝ｅ湪澶勭悊鑳屾櫙鍥?..",e)}),window.iOSBabyMode.hideProgressToast()):n=window.iOSBabyMode?await window.iOSBabyMode.safeReadFileAsDataURL(t):await new Promise((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=n,a.readAsDataURL(t)}),console.log("[GroupSettings] Background loaded, length:",n.length);const a=document.getElementById("group-chat-bg-preview"),o=document.getElementById("group-chat-bg-placeholder"),s=document.getElementById("group-chat-bg-preview-box");a&&(a.src=n,a.style.display="block"),o&&(o.style.display="none"),s&&s.classList.add("has-bg"),window.currentOpenGroup.chatBackground=n,window.currentOpenGroup.backgroundImage=n,console.log("[GroupSettings] currentOpenGroup.chatBackground set");try{const e=await window.dbHelper.loadData("groupChats","allGroupChats");let t=e?e.value:[];const a=t.findIndex(e=>e.id===window.currentOpenGroup.id);if(a>-1){t[a]=window.currentOpenGroup,await window.dbHelper.saveData("groupChats","allGroupChats",t);const e=document.getElementById("chat-messages-container");e&&(e.style.backgroundImage=`url('${n}')`,e.style.backgroundSize="cover",e.style.backgroundPosition="center")}}catch(e){console.error("AutoSave BG Failed",e)}}catch(e){console.error("缇よ亰鑳屾櫙涓婁紶澶辫触:",e),window.iOSBabyMode&&window.iOSBabyMode.hideProgressToast(),alert(`鉂?鑳屾櫙鍥句笂浼犲け璐n\n${e.message||"璇峰皾璇曢€夋嫨杈冨皬鐨勫浘鐗?}`)}else console.error("[GroupSettings] currentOpenGroup is null during background upload")});const h=document.getElementById("group-clear-bg-btn");h&&h.addEventListener("click",function(){const e=document.getElementById("group-chat-bg-preview"),t=document.getElementById("group-chat-bg-placeholder"),n=document.getElementById("group-chat-bg-preview-box");e&&(e.src="",e.style.display="none"),t&&(t.style.display="flex"),n&&n.classList.remove("has-bg"),window.currentOpenGroup&&(window.currentOpenGroup.chatBackground=null,window.currentOpenGroup.backgroundImage=null,(async()=>{try{const e=await window.dbHelper.loadData("groupChats","allGroupChats");let t=e?e.value:[];const n=t.findIndex(e=>e.id===window.currentOpenGroup.id);if(n>-1){t[n]=window.currentOpenGroup,await window.dbHelper.saveData("groupChats","allGroupChats",t);const e=document.getElementById("chat-messages-container");e&&(e.style.backgroundImage="")}}catch(e){console.error("AutoSave Clear BG Failed",e)}})())});const v=document.getElementById("group-clear-history-btn");v&&v.addEventListener("click",async function(){if(window.currentOpenGroup&&confirm("纭畾瑕佹竻绌虹兢缁勮亰澶╄褰曞悧锛熸鎿嶄綔涓嶅彲閫嗐€?))try{window.currentOpenGroup.history=[],window.currentOpenGroup.lastMessage="鑱婂ぉ璁板綍宸叉竻绌?;const e=await window.dbHelper.loadData("groupChats","allGroupChats");let t=e?e.value:[];const n=t.findIndex(e=>e.id===window.currentOpenGroup.id);n>-1&&(t[n].history=[],t[n].lastMessage="鑱婂ぉ璁板綍宸叉竻绌?,await window.dbHelper.saveData("groupChats","allGroupChats",t));const a=document.getElementById("chat-messages-container");a&&(a.innerHTML=""),alert("鑱婂ぉ璁板綍宸叉竻绌?)}catch(e){console.error(e),alert("鎿嶄綔澶辫触")}});const f=document.getElementById("group-delete-btn");f&&f.addEventListener("click",async function(){if(window.currentOpenGroup&&confirm("纭畾瑕佽В鏁ｅ苟鍒犻櫎璇ョ兢鑱婂悧锛?))try{const e=window.currentOpenGroup.id,t=await window.dbHelper.loadData("groupChats","allGroupChats");const n=(t?t.value:[]).filter(t=>t.id!==e);await window.dbHelper.saveData("groupChats","allGroupChats",n),document.getElementById("group-settings-page")?.classList.remove("active"),document.getElementById("chat-screen")?.classList.remove("active"),"function"==typeof loadChatGroups?loadChatGroups():window.location.reload()}catch(e){console.error(e),alert("鎿嶄綔澶辫触")}}),console.log("[ChatSettingsPage] 缇よ亰鍔熻兘琛ュ叏瀹屾瘯")}),window.openChatSettingsPage=async function(){if(!window.currentOpenContact)return;console.log("[openChatSettingsPage] 鎵撳紑鍗曡亰璁剧疆椤甸潰");const e=document.getElementById("chat-settings-page");if(!e)return void console.error("chat-settings-page not found");const t=window.currentOpenContact,n=document.getElementById("chat-settings-avatar"),a=document.getElementById("chat-settings-name");n&&(n.style.backgroundImage=`url('${t.ai.avatar}')`),a&&(a.textContent=t.ai.name);const o=document.getElementById("chat-role-tab-ai"),s=document.getElementById("chat-role-tab-user"),i=document.getElementById("chat-ai-form"),r=document.getElementById("chat-user-form");o&&o.classList.add("active"),s&&s.classList.remove("active"),i&&(i.style.display="block"),r&&(r.style.display="none"),document.getElementById("chat-ai-name-input").value=t.ai.name||"",document.getElementById("chat-ai-persona-input").value=t.ai.persona||"",document.getElementById("chat-context-memory-input").value=t.contextMemory||10,document.getElementById("chat-user-name-input").value=t.user.name||"",document.getElementById("chat-user-persona-input").value=t.user.persona||"";const l=document.getElementById("chat-user-avatar-preview");l&&(l.style.backgroundImage=`url('${t.user.avatar}')`);const c=t.avatarSettings||{show:!0,radius:"50%"},d=t.timestampSettings||{show:!1},u={"chat-show-avatars-toggle":!1!==c.show,"chat-show-timestamp-toggle":!0===d.show,"chat-default-stickers-toggle":!1!==t.enableDefaultStickers,"chat-monologue-toggle":!1!==t.enableMonologue,"chat-bilingual-toggle":!0===t.enableBilingualBubble,"chat-wb-stickers-toggle":!1!==t.enableWBStickers};Object.entries(u).forEach(([e,t])=>{const n=document.getElementById(e);n&&(t?n.classList.add("active"):n.classList.remove("active"))}),document.getElementById("chat-avatar-radius-input").value=c.radius||"50%",document.getElementById("chat-bubble-css-input").value=t.customBubbleCss||"";const m=t.ai.avatarPendant||{url:"",css:""},p=t.user.avatarPendant||{url:"",css:""};document.getElementById("chat-ai-pendant-url").value=m.url||"",document.getElementById("chat-ai-pendant-css").value=m.css||"",document.getElementById("chat-user-pendant-url").value=p.url||"",document.getElementById("chat-user-pendant-css").value=p.css||"";const g=document.getElementById("chat-bg-preview"),y=document.getElementById("chat-bg-placeholder"),h=document.getElementById("chat-bg-preview-box");t.chatBackground?(g&&(g.src=t.chatBackground,g.style.display="block"),y&&(y.style.display="none"),h&&h.classList.add("has-bg")):(g&&(g.src="",g.style.display="none"),y&&(y.style.display="flex"),h&&h.classList.remove("has-bg"));const v=document.getElementById("chat-tts-voice-input");v&&(v.value=t.ttsVoiceId||"");const f=document.getElementById("chat-tts-language-input");f&&(f.value=t.ttsLanguage||"");const w=document.getElementById("chat-block-btn");w&&(w.textContent=t.isBlocked?"瑙ｉ櫎鎷夐粦":"鎷夐粦鑱旂郴浜?);const b=document.getElementById("chat-worldbook-select-container");b&&"function"==typeof window.renderWorldBookMultiselect&&await window.renderWorldBookMultiselect(b,t,!1),e.querySelectorAll(".collapsible-section").forEach(e=>{e.id&&(e.id.includes("ai-form")||e.id.includes("user-form"))||e.classList.remove("expanded")}),e.classList.add("active")},window.renderWorldBookMultiselect=async function(e,t,n=!1){if(e){e.innerHTML='<div style="padding:20px;text-align:center;color:#999;">鍔犺浇涓栫晫涔︽暟鎹?..</div>';try{const a=await window.dbHelper.loadData("worldBooks","allWorldBooks"),o=await window.dbHelper.loadData("worldBookGroups","allGroups"),s=a&&Array.isArray(a.value)?a.value:[],i=o&&Array.isArray(o.value)?o.value:[];t.linkedWorldBookIds||(t.linkedWorldBookIds=[]);const r=new Set(t.linkedWorldBookIds);e.innerHTML="";const l=e=>"book"===e?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>':"chevron"===e?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>':"check"===e?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>':"";if(0===i.length&&0===s.length)return void(e.innerHTML='<div style="padding:30px;text-align:center;color:#999;font-size:13px;">鏆傛棤涓栫晫涔︼紝璇峰厛鍘诲垱寤?/div>');const c=async()=>{if(t.linkedWorldBookIds=Array.from(r),n&&t.id)try{if(t.members&&Array.isArray(t.members)){const e=await window.dbHelper.loadData("groupChats","allGroupChats"),n=e?e.value:[],a=n.findIndex(e=>e.id===t.id);a>-1&&(n[a]=t,await window.dbHelper.saveData("groupChats","allGroupChats",n),console.log("[WB] Group Saved"))}else if(t.ai&&t.user){const e=await window.dbHelper.loadData("messageContacts","allContacts"),n=e?e.value:[],a=n.findIndex(e=>e.id===t.id);a>-1&&(n[a]=t,await window.dbHelper.saveData("messageContacts","allContacts",n),console.log("[WB] Contact Saved"))}}catch(e){console.error("[WB] AutoSave Error",e)}};i.forEach(t=>{const n=s.filter(e=>(t.bookIds||[]).includes(e.id));if(0===n.length)return;const a=document.createElement("div");a.className="wb-group-card";const o=n.every(e=>r.has(e.id)),i=n.reduce((e,t)=>e+(r.has(t.id)?1:0),0);a.innerHTML=`\n                <div class="wb-group-header">\n                    <div class="wb-group-info">\n                        <div class="wb-group-icon">${l("book")}</div>\n                        <div class="wb-group-name">${t.name} <span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${i}/${n.length})</span></div>\n                    </div>\n                    <div class="wb-group-actions">\n                        <button class="wb-select-all-btn">${o?"鍏ㄦ秷":"鍏ㄩ€?}</button>\n                        <div class="wb-expand-icon">${l("chevron")}</div>\n                    </div>\n                </div>\n                <div class="wb-group-content">\n                    \x3c!-- Books go here --\x3e\n                </div>\n            `;const d=a.querySelector(".wb-group-header"),u=a.querySelector(".wb-group-content"),m=(a.querySelector(".wb-expand-icon"),a.querySelector(".wb-select-all-btn")),p=a.querySelector(".wb-group-name span");d.onclick=e=>{e.target!==m&&a.classList.toggle("expanded")},m.onclick=async()=>{"鍏ㄦ秷"===m.textContent?(n.forEach(e=>r.delete(e.id)),m.textContent="鍏ㄩ€?):(n.forEach(e=>r.add(e.id)),m.textContent="鍏ㄦ秷");u.querySelectorAll(".wb-item-row").forEach(e=>{const t=parseInt(e.dataset.id);r.has(t)?e.classList.add("selected"):e.classList.remove("selected")});const e=n.reduce((e,t)=>e+(r.has(t.id)?1:0),0);p.textContent=`(${e}/${n.length})`,await c()},n.forEach(e=>{const t=document.createElement("div");t.className="wb-item-row",r.has(e.id)&&t.classList.add("selected"),t.dataset.id=e.id,t.innerHTML=`\n                    <div class="wb-checkbox-custom">${l("check")}</div>\n                    <div class="wb-item-name">${e.name}</div>\n                `,t.onclick=async a=>{a.stopPropagation(),r.has(e.id)?(r.delete(e.id),t.classList.remove("selected")):(r.add(e.id),t.classList.add("selected"));const o=n.reduce((e,t)=>e+(r.has(t.id)?1:0),0);p.textContent=`(${o}/${n.length})`;const s=n.every(e=>r.has(e.id));m.textContent=s?"鍏ㄦ秷":"鍏ㄩ€?,await c()},u.appendChild(t)}),e.appendChild(a)});const d=new Set;i.forEach(e=>(e.bookIds||[]).forEach(e=>d.add(e)));const u=s.filter(e=>!d.has(e.id));if(u.length>0){const t=document.createElement("div");t.className="wb-group-card";const n=u.reduce((e,t)=>e+(r.has(t.id)?1:0),0);t.innerHTML=`\n                <div class="wb-group-header">\n                    <div class="wb-group-info">\n                        <div class="wb-group-icon" style="background:#E0E0E0;color:#888;">${l("book")}</div>\n                        <div class="wb-group-name">鏈垎绫?<span style="font-weight:400;color:#999;font-size:12px;margin-left:4px;">(${n}/${u.length})</span></div>\n                    </div>\n                    <div class="wb-expand-icon">${l("chevron")}</div>\n                </div>\n                <div class="wb-group-content"></div>\n            `;const a=t.querySelector(".wb-group-content");t.querySelector(".wb-group-header").onclick=()=>{t.classList.toggle("expanded")};const o=t.querySelector(".wb-group-name span");u.forEach(e=>{const t=document.createElement("div");t.className="wb-item-row",r.has(e.id)&&t.classList.add("selected"),t.innerHTML=`\n                    <div class="wb-checkbox-custom">${l("check")}</div>\n                    <div class="wb-item-name">${e.name}</div>\n                `,t.onclick=async()=>{r.has(e.id)?(r.delete(e.id),t.classList.remove("selected")):(r.add(e.id),t.classList.add("selected"));const n=u.reduce((e,t)=>e+(r.has(t.id)?1:0),0);o.textContent=`(${n}/${u.length})`,await c()},a.appendChild(t)}),e.appendChild(t)}}catch(t){console.error("Render WB Multiselect Failed",t),e.innerHTML='<div style="color:red;padding:20px;">鍔犺浇澶辫触</div>'}}},document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof lucide&&lucide.createIcons();const e=document.getElementById("settings-screen");if(e&&!window._lucideSettingsObserver){let t=null;window._lucideSettingsObserver=new MutationObserver(function(n){(e.classList.contains("active")||"none"!==window.getComputedStyle(e).display)&&"undefined"!=typeof lucide&&(t&&clearTimeout(t),t=setTimeout(()=>lucide.createIcons(),200))}),window._lucideSettingsObserver.observe(e,{attributes:!0,attributeFilter:["class"]})}}),window.resetWallpaper=async function(){if(confirm("纭畾瑕佹仮澶嶉粯璁ゅ绾稿悧锛?))try{await dbHelper.saveData("settingsStore","homeWallpaper",null),"undefined"!=typeof homeScreen&&(homeScreen.style.backgroundImage="");const e=document.getElementById("settings-wallpaper-preview-bg");e&&(e.style.backgroundImage=""),alert("澹佺焊宸叉仮澶嶉粯璁?)}catch(e){console.error("Reset wallpaper failed",e)}},window.resetSkin=function(){if(confirm("纭畾瑕佹仮澶嶉粯璁ゆ墜鏈哄澹冲悧锛?))try{window.ImageStore?window.ImageStore.remove("userDeviceSkin"):localStorage.removeItem("userDeviceSkin"),localStorage.removeItem("deviceSkinConfig");const e=document.getElementById("device-skin-layer");e&&e.remove(),alert("鎵嬫満宸叉仮澶嶉粯璁ゅ瑙?)}catch(e){console.error("Reset skin failed",e)}},window.restoreDefaultFont=async function(){if(confirm("纭畾瑕佹仮澶嶉粯璁ゅ瓧浣撳悧锛?))try{await dbHelper.saveData("settingsStore","customFont",null);const e=document.getElementById("custom-font-style");e&&e.remove(),alert("瀛椾綋宸叉仮澶嶉粯璁?)}catch(e){console.error("Reset font failed",e)}},window.handleSkinUpload=function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){const t=e.target.result;localStorage.setItem("userDeviceSkin",t),applySkin(t),alert("鐨偆鏇存崲鎴愬姛锛?)},n.readAsDataURL(t)},window.applySkin=function(e){let t=document.getElementById("device-skin-layer");if(!t){t=document.createElement("div"),t.id="device-skin-layer";const e=document.querySelector(".phone-frame");e&&(e.appendChild(t),t.style.position="absolute",t.style.inset="0",t.style.pointerEvents="none",t.style.zIndex="999",t.style.backgroundSize="100% 100%",t.style.backgroundRepeat="no-repeat")}t&&(t.style.backgroundImage=`url('${e}')`,t.style.display="block")},document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("offline-msg-toggle"),t=document.getElementById("offline-server-container"),n=document.getElementById("offline-dnd-container"),a=document.getElementById("offline-push-container"),o=document.getElementById("offline-service-url"),s=document.getElementById("offline-quiet-start"),i=document.getElementById("offline-quiet-end"),r=document.getElementById("push-permission-status"),l=document.getElementById("request-push-permission-btn"),c=document.getElementById("test-push-container"),d=document.getElementById("test-offline-push-btn"),u=document.getElementById("reset-push-service-btn");u&&u.addEventListener("click",async()=>{if(confirm("This will reset the push notification service and reload the app. Continue?")){u.textContent="Resetting...",u.disabled=!0;try{const e=await navigator.serviceWorker.getRegistrations();for(let t of e)await t.unregister(),console.log("[OfflineLife] SW unregistered:",t);if("caches"in window){const e=await caches.keys();for(let t of e)(t.includes("qiqi-phone-cache")||t.includes("precache"))&&await caches.delete(t)}alert("Reset complete. App will reload now."),location.reload(!0)}catch(e){console.error("Reset failed:",e),alert("Reset failed: "+e.message),u.textContent="Reset Failed"}}});const m="BCZ-HV6B5DpdYLTKW_OlWt-ZoZ666xBgsG__5xNDHwX8rSn-e71W89VP4yOmDCbMPBpmyEBUdueCeIAIVeWD1XU";if(e){const v=JSON.parse(localStorage.getItem("offlineLifeConfig")||"{}");function p(e){e?(t&&(t.style.display="block"),n&&(n.style.display="block"),a&&(a.style.display="block"),y()):(t&&(t.style.display="none"),n&&(n.style.display="none"),a&&(a.style.display="none"))}function g(){const t={enabled:e.checked,serverUrl:o.value.trim(),quietStart:s.value,quietEnd:i.value};localStorage.setItem("offlineLifeConfig",JSON.stringify(t)),console.log("[OfflineLife] Config saved:",t)}async function y(){if(!("Notification"in window))return r&&(r.textContent="Not Supported"),void(l&&(l.style.display="none"));const e=Notification.permission;if("granted"===e){await async function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return!1;try{const e=await navigator.serviceWorker.ready;return!!await e.pushManager.getSubscription()}catch(e){return console.warn("[OfflineLife] Failed to check subscription:",e),!1}}()?(r&&(r.textContent="鉁?Subscribed",r.style.color="#34C759"),l&&(l.textContent="Subscribed",l.style.backgroundColor="#34C759",l.style.color="white",l.disabled=!0),c&&(c.style.display="block")):(r&&(r.textContent="Authorized, tap to subscribe"),l&&(l.textContent="Subscribe"),c&&(c.style.display="none"))}else"denied"===e?(r&&(r.textContent="鉁?Blocked (check browser settings)",r.style.color="#FF3B30"),l&&(l.textContent="Blocked",l.disabled=!0,l.style.opacity="0.5"),c&&(c.style.display="none")):(r&&(r.textContent="Not enabled"),l&&(l.textContent="Enable"),c&&(c.style.display="none"))}function h(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;++e)a[e]=n.charCodeAt(e);return a}e.checked=v.enabled||!1,o.value=v.serverUrl||"",s.value=v.quietStart||"23:00",i.value=v.quietEnd||"08:00",p(e.checked),e.addEventListener("change",e=>{p(e.target.checked),g()}),[o,s,i].forEach(e=>{e&&(e.addEventListener("change",g),e.addEventListener("blur",g))}),l&&l.addEventListener("click",async()=>{l.disabled=!0,l.textContent="Enabling...",await async function(){try{if(console.log("[OfflineLife] Starting push subscription..."),!("serviceWorker"in navigator))throw new Error("Service Worker not supported");if(!("PushManager"in window))throw new Error("Push notifications not supported");console.log("[OfflineLife] Requesting notification permission...");const e=await Notification.requestPermission();if(console.log("[OfflineLife] Permission result:",e),"granted"!==e)return console.log("[OfflineLife] Notification permission denied"),y(),!1;console.log("[OfflineLife] Waiting for service worker...");const t=navigator.serviceWorker.ready,n=new Promise((e,t)=>setTimeout(()=>t(new Error("Service Worker ready timeout (5s)")),5e3)),a=await Promise.race([t,n]);console.log("[OfflineLife] Service worker ready:",a);let o=await a.pushManager.getSubscription();o?console.log("[OfflineLife] Using existing subscription:",o):(console.log("[OfflineLife] Creating new push subscription..."),console.log("[OfflineLife] Using VAPID key:",m.substring(0,20)+"..."),o=await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:h(m)}),console.log("[OfflineLife] Push subscription created:",o));const s=o.toJSON();console.log("[OfflineLife] Subscription data:",JSON.stringify(s).substring(0,100)+"...");const i=new Set;window.currentOpenContact?.id&&i.add(window.currentOpenContact.id),window.Global_AllContactsCache&&Array.isArray(window.Global_AllContactsCache)&&window.Global_AllContactsCache.forEach(e=>{e.id&&i.add(e.id)}),0===i.size&&i.add("default_user"),console.log("[OfflineLife] Registering for IDs:",Array.from(i));const r=Array.from(i).map(e=>fetch("/api/offline-life/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e,subscription:s})}).then(t=>t.ok?{id:e,status:"ok"}:{id:e,status:"failed",code:t.status}).catch(t=>({id:e,status:"error",error:t}))),l=await Promise.all(r);if(console.log("[OfflineLife] Subscription results:",l),!l.some(e=>"ok"===e.status)){const e=l.map(e=>`${e.id}: ${e.status}`).join(", ");throw new Error("All subscription attempts failed. Details: "+e)}return console.log("[OfflineLife] Subscription saved (at least one valid)"),y(),!0}catch(e){return console.error("[OfflineLife] Push subscription failed:",e),console.error("[OfflineLife] Error stack:",e.stack),r&&(r.textContent="Error: "+(e.message||"Unknown error"),r.style.color="#FF3B30"),l&&(l.textContent="Retry",l.disabled=!1,l.style.backgroundColor="#FF3B30",l.style.color="white"),!1}}()}),d&&d.addEventListener("click",async function(){d&&(d.disabled=!0,d.textContent="Sending...");try{const e=window.currentOpenContact?.id||"default_user";if(!(await fetch("/api/offline-life/test-push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e})})).ok)throw new Error("Test push failed");d&&(d.textContent="鉁?Sent!",setTimeout(()=>{d.innerHTML='<i data-lucide="bell-ring" class="w-4 h-4"></i> Send Test Notification',d.disabled=!1,window.lucide&&lucide.createIcons()},2e3))}catch(e){console.error("[OfflineLife] Test push failed:",e),d&&(d.textContent="鉁?Failed",setTimeout(()=>{d.innerHTML='<i data-lucide="bell-ring" class="w-4 h-4"></i> Send Test Notification',d.disabled=!1,window.lucide&&lucide.createIcons()},2e3))}}),e.checked&&y()}}),document.addEventListener("DOMContentLoaded",function(){console.log("[LittleWorld Integration] 鍒濆鍖栭泦鎴愰挬瀛?.."),window.addEventListener("messageSent",async function(e){const t=e.detail?.contact||window.currentOpenContact;t&&window.LittleWorld&&(window.LittleWorld.incrementCount(),await window.LittleWorld.checkTrigger(t),console.log("[LittleWorld Integration] 娑堟伅宸茶鏁?))}),window.triggerLittleWorldCount=async function(e){window.LittleWorld&&(window.LittleWorld.incrementCount(),await window.LittleWorld.checkTrigger(e||window.currentOpenContact))},console.log("[LittleWorld Integration] 闆嗘垚閽╁瓙鍒濆鍖栧畬鎴?)});

